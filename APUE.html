<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-01-19 Sun 20:31 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="whiothes" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://39.105.199.190/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://39.105.199.190/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://39.105.199.190/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="http://39.105.199.190/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<style>pre.src{background:#343131;color:white;} </style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgcf9d953">Advanced Programming in the Unix Environment <code>[66%]</code></a>
<ul>
<li><a href="#org27aad7d"><span class="done DONE">DONE</span> Chapter 1. UNIX System Overview <code>[12/12]</code></a>
<ul>
<li><a href="#orgd3ef768"><span class="done DONE">DONE</span> 1.1 Introduction</a></li>
<li><a href="#org9c95d85"><span class="done DONE">DONE</span> 1.2 UNIX Architecture</a></li>
<li><a href="#orgd8bf013"><span class="done DONE">DONE</span> 1.3 Logging in</a></li>
<li><a href="#org0f2b409"><span class="done DONE">DONE</span> 1.4 Files and Directories</a></li>
<li><a href="#org0e6a25d"><span class="done DONE">DONE</span> 1.5 Input and Output - File Descriptors</a></li>
<li><a href="#orgca7aab1"><span class="done DONE">DONE</span> 1.6 Programs and Processes</a></li>
<li><a href="#orgc8aaf8f"><span class="done DONE">DONE</span> 1.7 Error Handling</a></li>
<li><a href="#orgeac906b"><span class="done DONE">DONE</span> 1.8 User identification</a></li>
<li><a href="#org4a1249e"><span class="done DONE">DONE</span> 1.9 Signals</a></li>
<li><a href="#orgb4aad53"><span class="done DONE">DONE</span> 1.10 Time Values</a></li>
<li><a href="#org14de799"><span class="done DONE">DONE</span> 1.11 System calls and Library Functions</a></li>
<li><a href="#org8893258"><span class="done DONE">DONE</span> 1.12 Summary</a></li>
</ul>
</li>
<li><a href="#org14c3c1f"><span class="done DONE">DONE</span> Chapter 2. UNIX Standardization and Implementations <code>[10/10]</code></a>
<ul>
<li><a href="#orgd8d0569"><span class="done DONE">DONE</span> 2.1 Introduction</a></li>
<li><a href="#orgd35dbd9"><span class="done DONE">DONE</span> 2.2 UNIX Standardization</a></li>
<li><a href="#orge8c10fa"><span class="done DONE">DONE</span> 2.3 UNIX System Implementations</a></li>
<li><a href="#orgec031f7"><span class="done DONE">DONE</span> 2.4 Relationship of Standards and Implementations</a></li>
<li><a href="#org6f597cf"><span class="done DONE">DONE</span> 2.5 Limits</a></li>
<li><a href="#org55a57ac"><span class="done DONE">DONE</span> 2.6 Options</a></li>
<li><a href="#org3e6f7b2"><span class="done DONE">DONE</span> 2.7 Features Test Macros</a></li>
<li><a href="#orga676255"><span class="done DONE">DONE</span> 2.8 Primitive System Data Types</a></li>
<li><a href="#org1b0f504"><span class="done DONE">DONE</span> 2.9 Differences Between Standards</a></li>
<li><a href="#org6129f97"><span class="done DONE">DONE</span> 2.10 Summary</a></li>
</ul>
</li>
<li><a href="#orgc78aa6e"><span class="done DONE">DONE</span> Chapter 3. File I/O <code>[17/17]</code></a>
<ul>
<li><a href="#org4f393a8"><span class="done DONE">DONE</span> 3.1 Introduction</a></li>
<li><a href="#org2df318f"><span class="done DONE">DONE</span> 3.2 File Descriptors</a></li>
<li><a href="#org9daac86"><span class="done DONE">DONE</span> 3.3 <code>open</code> and <code>openat</code> Functions</a></li>
<li><a href="#orgb3eb2df"><span class="done DONE">DONE</span> 3.4 <code>creat</code> Function</a></li>
<li><a href="#org56a4d48"><span class="done DONE">DONE</span> 3.5 <code>close</code> Function</a></li>
<li><a href="#orge805f69"><span class="done DONE">DONE</span> 3.6 <code>lseek</code> Function</a></li>
<li><a href="#org656a112"><span class="done DONE">DONE</span> 3.7 <code>read</code> Function</a></li>
<li><a href="#org72d89b1"><span class="done DONE">DONE</span> 3.8 <code>write</code> Function</a></li>
<li><a href="#orgdbf68ef"><span class="done DONE">DONE</span> 3.9 I/O Efficiency</a></li>
<li><a href="#org3848f6a"><span class="done DONE">DONE</span> 3.10 File Sharing</a></li>
<li><a href="#org0934e08"><span class="done DONE">DONE</span> 3.11 Atomic Operations</a></li>
<li><a href="#orgee0dc87"><span class="done DONE">DONE</span> 3.12 <code>dup</code> and <code>dup2</code> Functions</a></li>
<li><a href="#orga8fce9a"><span class="done DONE">DONE</span> 3.13 <code>sync</code>, <code>fsync</code> and <code>fdatasync</code> Functions</a></li>
<li><a href="#org7aed7c9"><span class="done DONE">DONE</span> 3.14 <code>fcntl</code> Function</a></li>
<li><a href="#org6849410"><span class="done DONE">DONE</span> 3.15 <code>ioctl</code> Function</a></li>
<li><a href="#orgd536f09"><span class="done DONE">DONE</span> 3.16 <code>/dev/fd</code></a></li>
<li><a href="#org5d3ebed"><span class="done DONE">DONE</span> 3.17 Summary</a></li>
</ul>
</li>
<li><a href="#org1a54e6d"><span class="done DONE">DONE</span> Chapter 4. System Data Files and Information <code>[26/26]</code></a>
<ul>
<li><a href="#org9c8f1b9"><span class="done DONE">DONE</span> 4.1 Introduction</a></li>
<li><a href="#orgad984b9"><span class="done DONE">DONE</span> 4.2 <code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</a></li>
<li><a href="#org8075790"><span class="done DONE">DONE</span> 4.3 File Types</a></li>
<li><a href="#org7c47d09"><span class="done DONE">DONE</span> 4.4 Set-User-ID and Set-Group-ID</a></li>
<li><a href="#org8a0592a"><span class="done DONE">DONE</span> 4.5 File Access Permissions</a></li>
<li><a href="#org88e4db3"><span class="done DONE">DONE</span> 4.6 Ownership of New Files and Directories</a></li>
<li><a href="#org2c7a686"><span class="done DONE">DONE</span> <code>access</code> and <code>faccessat</code> Functions</a></li>
<li><a href="#org7d7be0d"><span class="done DONE">DONE</span> <code>umask</code> Function</a></li>
<li><a href="#org8be32f5"><span class="done DONE">DONE</span> <code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</a></li>
<li><a href="#org5d21abe"><span class="done DONE">DONE</span> Sticky Bit</a></li>
<li><a href="#org37c9daa"><span class="done DONE">DONE</span> <code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</a></li>
<li><a href="#orgcb18ddd"><span class="done DONE">DONE</span> File Size</a></li>
<li><a href="#org7b10626"><span class="done DONE">DONE</span> File Truncation</a></li>
<li><a href="#org814522e"><span class="done DONE">DONE</span> File Systems</a></li>
<li><a href="#orgcb01620"><span class="done DONE">DONE</span> <code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</a></li>
<li><a href="#orge192979"><span class="done DONE">DONE</span> <code>rename</code> and <code>renameat</code> Functions</a></li>
<li><a href="#org29d69ca"><span class="done DONE">DONE</span> Symbolic Links</a></li>
<li><a href="#org65df438"><span class="done DONE">DONE</span> Creating and Reading Symbolic Links</a></li>
<li><a href="#org6c45c4e"><span class="done DONE">DONE</span> File Times</a></li>
<li><a href="#org9656028"><span class="done DONE">DONE</span> <code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</a></li>
<li><a href="#orgee69e66"><span class="done DONE">DONE</span> <code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</a></li>
<li><a href="#org3db2627"><span class="done DONE">DONE</span> Reading Directories</a></li>
<li><a href="#orgb5e8824"><span class="done DONE">DONE</span> <code>chidr</code>, <code>fchdir</code> and <code>getcwd</code> Functions</a></li>
<li><a href="#org1eb84ee"><span class="done DONE">DONE</span> Device Special Files</a></li>
<li><a href="#orga632694"><span class="done DONE">DONE</span> Summary of File Access Permission Bits</a></li>
<li><a href="#org069ba14"><span class="done DONE">DONE</span> Summary</a></li>
</ul>
</li>
<li><a href="#org93be71b"><span class="done DONE">DONE</span> Chapter 5. Standard I/O Library <code>[16/16]</code></a>
<ul>
<li><a href="#orgae5d7a8"><span class="done DONE">DONE</span> 5.1 Introduction</a></li>
<li><a href="#org48666a2"><span class="done DONE">DONE</span> 5.2 Streams and FILE Objects</a></li>
<li><a href="#org6da16e1"><span class="done DONE">DONE</span> 5.3 Standard Input, Standard Output and Standard Error</a></li>
<li><a href="#org9ebfd7e"><span class="done DONE">DONE</span> 5.4 Buffering</a></li>
<li><a href="#orge99ab7a"><span class="done DONE">DONE</span> 5.5 Opening a Stream</a></li>
<li><a href="#org7cbe46a"><span class="done DONE">DONE</span> 5.6 Reading and Writing a Stream</a></li>
<li><a href="#orgdd17171"><span class="done DONE">DONE</span> 5.9 Line-at-a-Time I/O</a></li>
<li><a href="#orgc58a5a7"><span class="done DONE">DONE</span> 5.10 Standard I/O Efficiency</a></li>
<li><a href="#org8e26b13"><span class="done DONE">DONE</span> 5.11 Binary I/O</a></li>
<li><a href="#org781cafc"><span class="done DONE">DONE</span> 5.12 Positioning a Stream</a></li>
<li><a href="#org0c721f9"><span class="done DONE">DONE</span> 5.13 Formated I/O</a></li>
<li><a href="#org3455d20"><span class="done DONE">DONE</span> 5.14 Implementation Details</a></li>
<li><a href="#org8f8b851"><span class="done DONE">DONE</span> 5.15 Temporary Files</a></li>
<li><a href="#orgcb8e55e"><span class="done DONE">DONE</span> 5.16 Memory Streams</a></li>
<li><a href="#org4e081e5"><span class="done DONE">DONE</span> 5.17 Alternatives to Standard I/O</a></li>
<li><a href="#org50d2294"><span class="done DONE">DONE</span> 5.18 Summary</a></li>
</ul>
</li>
<li><a href="#org4fbe11f"><span class="done DONE">DONE</span> Chapter 6. System Data Files and Information <code>[11/11]</code></a>
<ul>
<li><a href="#org055138d"><span class="done DONE">DONE</span> 6.1 introduction</a></li>
<li><a href="#org79b35bb"><span class="done DONE">DONE</span> 6.2 Password File</a></li>
<li><a href="#org11c649c"><span class="done DONE">DONE</span> 6.3 Shadow Passwords</a></li>
<li><a href="#org5d00721"><span class="done DONE">DONE</span> 6.4 Group File</a></li>
<li><a href="#org4212c73"><span class="done DONE">DONE</span> 6.5 Supplementary Group Ids</a></li>
<li><a href="#orgfedf116"><span class="done DONE">DONE</span> 6.6 Implementation Differences</a></li>
<li><a href="#org46cc3ab"><span class="done DONE">DONE</span> 6.7 Other Data Files</a></li>
<li><a href="#org215990d"><span class="done DONE">DONE</span> 6.8 Login Accounting</a></li>
<li><a href="#org9f5fb36"><span class="done DONE">DONE</span> 6.9 System Identification</a></li>
<li><a href="#org6f2bb7d"><span class="done DONE">DONE</span> 6.10 Time and Date Routines</a></li>
<li><a href="#org5f3b49e"><span class="done DONE">DONE</span> 6.11 Summary</a></li>
</ul>
</li>
<li><a href="#org3cb16d8"><span class="done DONE">DONE</span> Chapter 7. Process Environment <code>[11/11]</code></a>
<ul>
<li><a href="#orgb176489"><span class="done DONE">DONE</span> 7.1 Introduction</a></li>
<li><a href="#org2c99639"><span class="done DONE">DONE</span> 7.2 main Function</a></li>
<li><a href="#org2e84266"><span class="done DONE">DONE</span> 7.3 Process Termination</a></li>
<li><a href="#org76c84de"><span class="done DONE">DONE</span> 7.5 Environment List</a></li>
<li><a href="#orgf669cae"><span class="done DONE">DONE</span> 7.6 Memory Layout of a C Program</a></li>
<li><a href="#orga49684d"><span class="done DONE">DONE</span> 7.7 Shared Libraries</a></li>
<li><a href="#orgbb62982"><span class="done DONE">DONE</span> 7.8 Memory Allocation</a></li>
<li><a href="#org27ef0b9"><span class="done DONE">DONE</span> 7.9 Environment Variable</a></li>
<li><a href="#orgbae14a7"><span class="done DONE">DONE</span> 7.10 <code>setjmp</code> and <code>longjmp</code> Functions</a></li>
<li><a href="#orgc845721"><span class="done DONE">DONE</span> <code>getrlimit</code> and <code>setrlimit</code> Functions</a></li>
<li><a href="#org4486891"><span class="done DONE">DONE</span> Summary</a></li>
</ul>
</li>
<li><a href="#orgc36db4e"><span class="done DONE">DONE</span> Chapter 8. Process Control <code>[18/18]</code></a>
<ul>
<li><a href="#org7cf033a"><span class="done DONE">DONE</span> 8.1 Introduction</a></li>
<li><a href="#org752ce8e"><span class="done DONE">DONE</span> 8.2 Process Identifiers</a></li>
<li><a href="#orgf17e3af"><span class="done DONE">DONE</span> 8.3 <code>fork</code> Function</a></li>
<li><a href="#orgb4ffdd3"><span class="done DONE">DONE</span> 8.4 <code>vfork</code> Function</a></li>
<li><a href="#org1d4d04c"><span class="done DONE">DONE</span> 8.5 <code>exit</code> Function</a></li>
<li><a href="#org5450b88"><span class="done DONE">DONE</span> 8.6 <code>wait</code> and <code>waitpid</code> Functions</a></li>
<li><a href="#org8cf537d"><span class="done DONE">DONE</span> 8.7 <code>waitid</code> Function</a></li>
<li><a href="#orgb52642c"><span class="done DONE">DONE</span> 8.8 <code>wait3</code> and <code>wait4</code> Functions</a></li>
<li><a href="#org77b6700"><span class="done DONE">DONE</span> 8.9 Race Conditions</a></li>
<li><a href="#org9d39d87"><span class="done DONE">DONE</span> 8.10 <code>exec</code> Functions</a></li>
<li><a href="#org8ad3713"><span class="done DONE">DONE</span> 8.11 Changing User IDs and Group IDs</a></li>
<li><a href="#orged6c700"><span class="done DONE">DONE</span> 8.12 Interpreter Files</a></li>
<li><a href="#orgb2333b6"><span class="done DONE">DONE</span> 8.13 <code>system</code> Function</a></li>
<li><a href="#org11b330c"><span class="done DONE">DONE</span> 8.14 Process Accounting</a></li>
<li><a href="#org0850ff0"><span class="done DONE">DONE</span> 8.15 User Identification</a></li>
<li><a href="#org3bdf437"><span class="done DONE">DONE</span> 8.16 Process Scheduling</a></li>
<li><a href="#org231e432"><span class="done DONE">DONE</span> 8.17 Process Times</a></li>
<li><a href="#orgbcc9d3a"><span class="done DONE">DONE</span> 8.18 Summary</a></li>
</ul>
</li>
<li><a href="#org280714c"><span class="done DONE">DONE</span> Chapter 9. Process Relationships <code>[12/12]</code></a>
<ul>
<li><a href="#org994e973"><span class="done DONE">DONE</span> 9.1 Introduction</a></li>
<li><a href="#orge9b6c29"><span class="done DONE">DONE</span> 9.2 Terminal Logins</a></li>
<li><a href="#org2f31f89"><span class="done DONE">DONE</span> 9.3 Network Logins</a></li>
<li><a href="#org5d68865"><span class="done DONE">DONE</span> 9.4 Process Groups</a></li>
<li><a href="#org54c4902"><span class="done DONE">DONE</span> 9.5 Sessions</a></li>
<li><a href="#orgccfc4a7"><span class="done DONE">DONE</span> 9.6 Controlling Terminal</a></li>
<li><a href="#org9a4b604"><span class="done DONE">DONE</span> 9.7 <code>tcgetpgrp</code>, <code>tcsetpgrp</code>, and <code>tcgetsid</code> Functions</a></li>
<li><a href="#org5ba546b"><span class="done DONE">DONE</span> 9.8 Job Control</a></li>
<li><a href="#orgadd3033"><span class="done DONE">DONE</span> 9.9 Shell Execution Programs</a></li>
<li><a href="#org5781c40"><span class="done DONE">DONE</span> 9.10 Orphaned Process Groups</a></li>
<li><a href="#orgf8a1d31"><span class="done DONE">DONE</span> 9.11 FreeBSD Implementation</a></li>
<li><a href="#org8cb2deb"><span class="done DONE">DONE</span> 9.12 Summary</a></li>
</ul>
</li>
<li><a href="#org399fcc6"><span class="done DONE">DONE</span> Chapter 10. Signals <code>[23/23]</code></a>
<ul>
<li><a href="#org23c97af"><span class="done DONE">DONE</span> 10.1 Introduction</a></li>
<li><a href="#org580735b"><span class="done DONE">DONE</span> 10.2 Signal Concepts</a></li>
<li><a href="#org9f02130"><span class="done DONE">DONE</span> 10.3 <code>signal</code> Function</a></li>
<li><a href="#org4bd23ae"><span class="done DONE">DONE</span> 10.4 Unreliable Signals</a></li>
<li><a href="#org6ea79fa"><span class="done DONE">DONE</span> 10.5 Interrupted System Calls</a></li>
<li><a href="#orga5fc21b"><span class="done DONE">DONE</span> 10.6 Reentrant Functions</a></li>
<li><a href="#org6be964c"><span class="done DONE">DONE</span> 10.7 <code>SIGCLD</code> Semantics</a></li>
<li><a href="#orga32f4ab"><span class="done DONE">DONE</span> 10.8 Reliable-Signal Terminology and Semantics</a></li>
<li><a href="#org99a71a2"><span class="done DONE">DONE</span> 10.9 <code>kill</code> and <code>raise</code> Functions</a></li>
<li><a href="#org69b8fb4"><span class="done DONE">DONE</span> 10.10 <code>alarm</code> and <code>pause</code> Functions</a></li>
<li><a href="#org49a99ee"><span class="done DONE">DONE</span> 10.11 Signal Sets</a></li>
<li><a href="#org4fa12c2"><span class="done DONE">DONE</span> 10.12 <code>sigprocmask</code> Function</a></li>
<li><a href="#orgfb805a8"><span class="done DONE">DONE</span> 10.13 <code>sigpending</code> Function</a></li>
<li><a href="#orgc96baab"><span class="done DONE">DONE</span> 10.14 <code>sigaction</code> Function</a></li>
<li><a href="#org274595e"><span class="done DONE">DONE</span> 10.15 <code>sigsetjmp</code> and <code>siglongjmp</code> Functions</a></li>
<li><a href="#orgde41900"><span class="done DONE">DONE</span> 10.16 <code>sigsuspend</code> Function</a></li>
<li><a href="#org032bff3"><span class="done DONE">DONE</span> 10.17 <code>abort</code> Function</a></li>
<li><a href="#orgf1bfe67"><span class="done DONE">DONE</span> 10.18 <code>system</code> Function</a></li>
<li><a href="#org3207ef3"><span class="done DONE">DONE</span> 10.19 <code>sleep</code>, <code>nanaosleep</code>, and <code>clock_nanosleep</code> Functions</a></li>
<li><a href="#org2c46025"><span class="done DONE">DONE</span> 10.20 <code>sigqueue</code> Function</a></li>
<li><a href="#org509f2bf"><span class="done DONE">DONE</span> 10.21 Job-Control Signals</a></li>
<li><a href="#orgfdaa842"><span class="done DONE">DONE</span> 10.22 Signal Names and Numbers</a></li>
<li><a href="#org74f9bab"><span class="done DONE">DONE</span> 10.23 Summary</a></li>
</ul>
</li>
<li><a href="#org777604a"><span class="done DONE">DONE</span> Chapter 11. Threads <code>[7/7]</code></a>
<ul>
<li><a href="#org19b290b"><span class="done DONE">DONE</span> 11.1 Introduction</a></li>
<li><a href="#org49f7c83"><span class="done DONE">DONE</span> 11.2 Thread Concepts</a></li>
<li><a href="#orga1d4510"><span class="done DONE">DONE</span> 11.3 Thread Identification</a></li>
<li><a href="#org68ced8c"><span class="done DONE">DONE</span> 11.4 Thread Creation</a></li>
<li><a href="#org0616651"><span class="done DONE">DONE</span> 11.5 Thread Termination</a></li>
<li><a href="#org416bbdf"><span class="done DONE">DONE</span> 11.6 Thread Synchronization <code>[8/8]</code></a></li>
<li><a href="#org8f4319b"><span class="done DONE">DONE</span> 11.7 Summary</a></li>
</ul>
</li>
<li><a href="#org73e5e40"><span class="done DONE">DONE</span> Chapter 12. Thread Control <code>[11/11]</code></a>
<ul>
<li><a href="#orge8a5f65"><span class="done DONE">DONE</span> 12.1 Introduction</a></li>
<li><a href="#org5b12dca"><span class="done DONE">DONE</span> 12.2 Thread Limits</a></li>
<li><a href="#org3e68586"><span class="done DONE">DONE</span> 12.3 Thread Attributes</a></li>
<li><a href="#orgaf84f26"><span class="done DONE">DONE</span> 12.4 Synchronization Attributes <code>[4/4]</code></a></li>
<li><a href="#org3cfca7e"><span class="done DONE">DONE</span> 12.5 Reentrancy</a></li>
<li><a href="#org2028d10"><span class="done DONE">DONE</span> 12.6 Thread-Specific Data</a></li>
<li><a href="#org4cb9df1"><span class="done DONE">DONE</span> 12.7 Cancel Options</a></li>
<li><a href="#org7e90f92"><span class="done DONE">DONE</span> 12.8 Threads and Signals</a></li>
<li><a href="#org0e949d4"><span class="done DONE">DONE</span> 12.9 Threads and fork</a></li>
<li><a href="#org1a67823"><span class="done DONE">DONE</span> 12.10 Threads and I/O</a></li>
<li><a href="#orgd288d81"><span class="done DONE">DONE</span> 12.11 Summary</a></li>
</ul>
</li>
<li><a href="#org0e9dd2a"><span class="done DONE">DONE</span> Chapter 13. Daemon Processes <code>[8/8]</code></a>
<ul>
<li><a href="#orge973961"><span class="done DONE">DONE</span> 13.1 Introduction</a></li>
<li><a href="#org63a6cc9"><span class="done DONE">DONE</span> 13.2 Daemon Characteristics</a></li>
<li><a href="#orgc4d760e"><span class="done DONE">DONE</span> 13.3 Coding Rules</a></li>
<li><a href="#orgb93a416"><span class="done DONE">DONE</span> 13.4 Error Logging</a></li>
<li><a href="#org36b56fe"><span class="done DONE">DONE</span> 13.5 Single-Instance Daemons</a></li>
<li><a href="#org3513f3c"><span class="done DONE">DONE</span> 13.6 Daemon Conventions</a></li>
<li><a href="#orgc4d41d7"><span class="done DONE">DONE</span> 13.7 Client-Server Model</a></li>
<li><a href="#orgef638ae"><span class="done DONE">DONE</span> 13.8 Summary</a></li>
</ul>
</li>
<li><a href="#orgd027684"><span class="done DONE">DONE</span> Chapter 14. Advanced I/O <code>[8/8]</code></a>
<ul>
<li><a href="#org72ab6f0"><span class="done DONE">DONE</span> 14.1 Introduction</a></li>
<li><a href="#org16c0397"><span class="done DONE">DONE</span> 14.2 Nonblocking I/O</a></li>
<li><a href="#org999950d"><span class="done DONE">DONE</span> 14.3 Record Locking</a></li>
<li><a href="#org9395618">14.4 I/O Multiplexing <code>[2/2]</code></a></li>
<li><a href="#org6880fc7"><span class="done DONE">DONE</span> 14.5 Asynchronous I/O <code>[3/3]</code></a></li>
<li><a href="#orgc60bd6e"><span class="done DONE">DONE</span> 14.6 <code>readv</code> and <code>writev</code> Functions</a></li>
<li><a href="#org0326513"><span class="done DONE">DONE</span> 14.7 <code>readn</code> and <code>writen</code> Functions</a></li>
<li><a href="#org89786a6"><span class="done DONE">DONE</span> 14.9 Summary</a></li>
</ul>
</li>
<li><a href="#orgfe8102c"><span class="todo TODO">TODO</span> Chapter 15. Interprocess Communication <code>[11/12]</code></a>
<ul>
<li><a href="#orgccd86f3"><span class="done DONE">DONE</span> 15.1 Introduction</a></li>
<li><a href="#org2ac5526"><span class="done DONE">DONE</span> 15.2 Pipes</a></li>
<li><a href="#orge82d4b8"><span class="done DONE">DONE</span> 15.3 <code>popen</code> and <code>pclose</code> Functions</a></li>
<li><a href="#orgafa570c"><span class="done DONE">DONE</span> 15.4 Coprocesses</a></li>
<li><a href="#org3adf3c0"><span class="done DONE">DONE</span> 15.5 FIFOs</a></li>
<li><a href="#orgc7d6e6a"><span class="done DONE">DONE</span> 15.6 XSI IPC <code>[4/4]</code></a></li>
<li><a href="#org9829e4f"><span class="done DONE">DONE</span> 15.7 Message Queues</a></li>
<li><a href="#org992b009"><span class="done DONE">DONE</span> 15.8 Semaphores</a></li>
<li><a href="#org818d4a7"><span class="done DONE">DONE</span> 15.9 Shared Memory</a></li>
<li><a href="#org1eb758b"><span class="done DONE">DONE</span> 15.10 POSIX Semaphores</a></li>
<li><a href="#org3fd6e1b"><span class="done DONE">DONE</span> 15.11 Client-Server Properties</a></li>
<li><a href="#org5b1ad03"><span class="todo TODO">TODO</span> 15.12 Summary</a></li>
</ul>
</li>
<li><a href="#org9351430"><span class="todo TODO">TODO</span> Chapter 16. Network IPC: Sockets <code>[2/9]</code></a>
<ul>
<li><a href="#org82e185a"><span class="done DONE">DONE</span> 16.1 Introduction</a></li>
<li><a href="#org48fce5c"><span class="done DONE">DONE</span> 16.2 Socket Descriptors</a></li>
<li><a href="#orgf19dbde"><span class="todo TODO">TODO</span> 16.3 Addressing</a></li>
<li><a href="#org5e4e352"><span class="todo TODO">TODO</span> 16.4 Connection Establishment</a></li>
<li><a href="#org6a354b0"><span class="todo TODO">TODO</span> 16.5 Data Transfer</a></li>
<li><a href="#orgef8e949"><span class="todo TODO">TODO</span> 16.6 Socket Options</a></li>
<li><a href="#orge7422cb"><span class="todo TODO">TODO</span> 16.7 Out-of-Band Data</a></li>
<li><a href="#orgea231cf"><span class="todo TODO">TODO</span> 16.8 Nonblocking and Asynchronous I/O</a></li>
<li><a href="#org37b2573"><span class="todo TODO">TODO</span> 16.9 Summary</a></li>
</ul>
</li>
<li><a href="#org02a997c"><span class="todo TODO">TODO</span> Chapter 17. Advanced IPC <code>[2/7]</code></a>
<ul>
<li><a href="#org67eb00b"><span class="todo TODO">TODO</span> 17.1 Introduction</a></li>
<li><a href="#orgdc46013"><span class="done DONE">DONE</span> 17.2 UNIX Domain Sockets</a></li>
<li><a href="#org0e80c97"><span class="done DONE">DONE</span> 17.3 Unique Connections</a></li>
<li><a href="#org6d85444"><span class="todo TODO">TODO</span> 17.4 Passing File Descriptors</a></li>
<li><a href="#orga30e533"><span class="todo TODO">TODO</span> 17.5 An Open Server, Version 1</a></li>
<li><a href="#org7df9cb5"><span class="todo TODO">TODO</span> 17.6 An Open Server, Version 2</a></li>
<li><a href="#org85379f3"><span class="todo TODO">TODO</span> 17.7 Summary</a></li>
</ul>
</li>
<li><a href="#org3e62f4c"><span class="todo TODO">TODO</span> Chapter 18. Terminal I/O <code>[0/0]</code></a></li>
<li><a href="#org81aa478"><span class="todo TODO">TODO</span> Chapter 19. Pseudo Terminals <code>[0/0]</code></a></li>
<li><a href="#org45be014"><span class="todo TODO">TODO</span> Chapter 20. A Database Library <code>[0/0]</code></a></li>
<li><a href="#org20280e2"><span class="todo TODO">TODO</span> Chapter 21. Communication with a Network Printer <code>[0/0]</code></a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgcf9d953" class="outline-2">
<h2 id="orgcf9d953">Advanced Programming in the Unix Environment <code>[66%]</code></h2>
<div class="outline-text-2" id="text-orgcf9d953">
</div>
<div id="outline-container-org27aad7d" class="outline-3">
<h3 id="org27aad7d"><span class="done DONE">DONE</span> Chapter 1. UNIX System Overview <code>[12/12]</code></h3>
<div class="outline-text-3" id="text-org27aad7d">
</div>
<div id="outline-container-orgd3ef768" class="outline-4">
<h4 id="orgd3ef768"><span class="done DONE">DONE</span> 1.1 Introduction</h4>
</div>
<div id="outline-container-org9c95d85" class="outline-4">
<h4 id="org9c95d85"><span class="done DONE">DONE</span> 1.2 UNIX Architecture</h4>
</div>
<div id="outline-container-orgd8bf013" class="outline-4">
<h4 id="orgd8bf013"><span class="done DONE">DONE</span> 1.3 Logging in</h4>
<div class="outline-text-4" id="text-orgd8bf013">
<ul class="org-ul">
<li>Login Name</li>
</ul>
</div>
</div>
<div id="outline-container-org0f2b409" class="outline-4">
<h4 id="org0f2b409"><span class="done DONE">DONE</span> 1.4 Files and Directories</h4>
<div class="outline-text-4" id="text-org0f2b409">
<ul class="org-ul">
<li>File System</li>
<li>Pathname
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Figure 1.3 List all the files in a directory</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">dirent.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">DIR</span>           *<span style="color: #8787d7;">dp</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">dirent</span> *<span style="color: #8787d7;">dirp</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: ls directory_name"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>dp = opendir<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %ls"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>dirp = readdir<span style="color: #67b11d;">(</span>dp<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>strcoll<span style="color: #67b11d;">(</span>dirp-&gt;d_name, <span style="color: #2aa198;">"."</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span> &amp;&amp;
            strcoll<span style="color: #67b11d;">(</span>dirp-&gt;d_name, <span style="color: #2aa198;">".."</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"%s\n"</span>, dirp-&gt;d_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    closedir<span style="color: #d75fd7;">(</span>dp<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org0e6a25d" class="outline-4">
<h4 id="org0e6a25d"><span class="done DONE">DONE</span> 1.5 Input and Output - File Descriptors</h4>
<div class="outline-text-4" id="text-org0e6a25d">
<ul class="org-ul">
<li>Standard Input, Standard Output, and Standard Error</li>
<li>Unbuffered I/O
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Figure 1.4 Copy standard input to standard output</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">BUFFSIZE</span> <span style="color: #d75fd7;">4096</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">n</span> = <span style="color: #d75fd7;">0</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>BUFFSIZE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, buf, BUFFSIZE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>write<span style="color: #67b11d;">(</span>STDOUT_FILENO, buf, n<span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>n &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>

<li>Standard I/O
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>Figure 1.5 Copy standard input to standard output, using standard I/O</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">c</span>;
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>c = getc<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != EOF<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>putc<span style="color: #67b11d;">(</span>c, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"output error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ferror<span style="color: #2aa198;">(</span>stdin<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"input error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgca7aab1" class="outline-4">
<h4 id="orgca7aab1"><span class="done DONE">DONE</span> 1.6 Programs and Processes</h4>
<div class="outline-text-4" id="text-orgca7aab1">
<ul class="org-ul">
<li>Program</li>
<li>Proceses and Process ID
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Figure 1.6 Print the process ID</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"hello world from process ID %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li>Process Control
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Figure 1.7 Read commands from standard input and execute them</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">from apue.h */</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">status</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%% "</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">print prompt (printf require %% to print %) */</span>

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fgets<span style="color: #2aa198;">(</span>buf, MAXLINE, stdin<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>buf<span style="color: #67b11d;">[</span>strlen<span style="color: #875f00;">(</span>buf<span style="color: #875f00;">)</span> - <span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span> == <span style="color: #2aa198;">'\n'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            buf<span style="color: #67b11d;">[</span>strlen<span style="color: #875f00;">(</span>buf<span style="color: #875f00;">)</span> - <span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span> = <span style="color: #d75fd7;">0</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">replace newline with null */</span>
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #875f00;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            execlp<span style="color: #67b11d;">(</span>buf, buf, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span>;
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"coulnd't excute: %s"</span>, buf<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent */</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>pid = waitpid<span style="color: #875f00;">(</span>pid, &amp;status, <span style="color: #d75fd7;">0</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%% "</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc8aaf8f" class="outline-4">
<h4 id="orgc8aaf8f"><span class="done DONE">DONE</span> 1.7 Error Handling</h4>
<div class="outline-text-4" id="text-orgc8aaf8f">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>Figure 1.8 Demonstrate strerror and perror</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    fprintf<span style="color: #d75fd7;">(</span>stderr, <span style="color: #2aa198;">"EACCESS: %s\n"</span>, strerror<span style="color: #2aa198;">(</span>EACCES<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    errno = ENOENT;
    perror<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgeac906b" class="outline-4">
<h4 id="orgeac906b"><span class="done DONE">DONE</span> 1.8 User identification</h4>
<div class="outline-text-4" id="text-orgeac906b">
<ul class="org-ul">
<li>User ID</li>
<li>Group ID
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>Figure 1.9 Print user ID and group ID</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     uidgid.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-01</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    print uid and gid</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"uid = %d, gid = %d\n"</span>, getuid<span style="color: #2aa198;">()</span>, getgid<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span>EXIT_SUCCESS<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
<li>Supplementary Group IDs</li>
</ul>
</div>
</div>
<div id="outline-container-org4a1249e" class="outline-4">
<h4 id="org4a1249e"><span class="done DONE">DONE</span> 1.9 Signals</h4>
<div class="outline-text-4" id="text-org4a1249e">
<p>
Process choices:
</p>
<ol class="org-ol">
<li>Ignore</li>
<li>default action</li>
<li>provide call function (catch signal)</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>Figure 1.10 Read commands from standard input and execute them</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/types.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_int</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">our signal-catching function */</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">from apue.h */</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">status</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGINT, sig_int<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal error"</span><span style="color: #d75fd7;">)</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%% "</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">print prompt (printf requires %% to print %) */</span>
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fgets<span style="color: #2aa198;">(</span>buf, MAXLINE, stdin<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>buf<span style="color: #67b11d;">[</span>strlen<span style="color: #875f00;">(</span>buf<span style="color: #875f00;">)</span> - <span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span> == <span style="color: #2aa198;">'\n'</span><span style="color: #2aa198;">)</span>
            buf<span style="color: #2aa198;">[</span>strlen<span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span> - <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span> = <span style="color: #d75fd7;">0</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">replace newline with null */</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #875f00;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            execlp<span style="color: #67b11d;">(</span>buf, buf, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span>;
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"couldn't execute: %s"</span>, buf<span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span><span style="color: #d75fd7;">127</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_int</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"interrupt\n%% "</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgb4aad53" class="outline-4">
<h4 id="orgb4aad53"><span class="done DONE">DONE</span> 1.10 Time Values</h4>
<div class="outline-text-4" id="text-orgb4aad53">
<ol class="org-ol">
<li>Calendar time.</li>
<li>Process time.
<ul class="org-ul">
<li>Clock time</li>
<li>User CPU time</li>
<li>System CPU time</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-org14de799" class="outline-4">
<h4 id="org14de799"><span class="done DONE">DONE</span> 1.11 System calls and Library Functions</h4>
<div class="outline-text-4" id="text-org14de799">
<ul class="org-ul">
<li>Concepts:
<ul class="org-ul">
<li>System calls: <br />
<ul class="org-ul">
<li>Can be learned with <code>man 2</code> (Section 2 of <i>Unix Programmer's Mannual</i>)</li>
</ul></li>
<li>Library Functions:
<ul class="org-ul">
<li>Can be learned with <code>man 3</code> for <b>general-purpose</b> (Section 3 of <i>Unix Programmer's Mannual</i>)</li>
<li>These functions aren’t entry points into the kernel, although they may invoke one or more of the kernel’s system calls</li>
</ul></li>
</ul></li>
<li>Distinction:
<ul class="org-ul">
<li>the system calls usually cannot be replaced</li>
<li>UNIX System provides to determine the current time and date</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8893258" class="outline-4">
<h4 id="org8893258"><span class="done DONE">DONE</span> 1.12 Summary</h4>
<div class="outline-text-4" id="text-org8893258">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>1.1</li>
<li>1.2  53268 50922 was occupied</li>
<li>1.3  strerror: int, value transfer, can not be changed, global errno can not be forecast
perror: pointer, can be changed the value point to, const set constant</li>
<li>1.4  2038, \( \frac{2^{31}}{(60*60*24*365)+1970} \)
change time_t to u_64_t
recompile the program</li>
<li>1.5  \( \frac{2^{31}}{(60*60*24*100)}=248.551348 \) days</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org14c3c1f" class="outline-3">
<h3 id="org14c3c1f"><span class="done DONE">DONE</span> Chapter 2. UNIX Standardization and Implementations <code>[10/10]</code></h3>
<div class="outline-text-3" id="text-org14c3c1f">
</div>
<div id="outline-container-orgd8d0569" class="outline-4">
<h4 id="orgd8d0569"><span class="done DONE">DONE</span> 2.1 Introduction</h4>
</div>
<div id="outline-container-orgd35dbd9" class="outline-4">
<h4 id="orgd35dbd9"><span class="done DONE">DONE</span> 2.2 UNIX Standardization</h4>
<div class="outline-text-4" id="text-orgd35dbd9">
</div>
<ul class="org-ul">
<li><a id="org4898fc7"></a><span class="done DONE">DONE</span> ISO C<br /></li>
<li><a id="org216ee1d"></a><span class="done DONE">DONE</span> IEEE POSIX<br /></li>
<li><a id="orgde3c47a"></a><span class="done DONE">DONE</span> The Single UNIX Specification<br />
<div class="outline-text-5" id="text-orgde3c47a">
<ul class="org-ul">
<li>Encryption: denoted by <code>_XOPEN_CRYPE</code></li>
<li>Real-time: denoted by <code>_XOPEN_REALTIME</code></li>
<li>Advanced real-time</li>
<li>Real-time threads: denoted by <code>_XOPEN_REALTIME_THREADS</code></li>
<li>Advanced real-time threads</li>
</ul>
</div>
</li>
<li><a id="org210e969"></a><span class="done DONE">DONE</span> FIPS<br /></li>
</ul>
</div>
<div id="outline-container-orge8c10fa" class="outline-4">
<h4 id="orge8c10fa"><span class="done DONE">DONE</span> 2.3 UNIX System Implementations</h4>
<div class="outline-text-4" id="text-orge8c10fa">
</div>
<ul class="org-ul">
<li><a id="orgf755449"></a><span class="done DONE">DONE</span> SVR4<br /></li>
<li><a id="org4b3cd93"></a><span class="done DONE">DONE</span> 2.3.1 4.4BSD<br /></li>
<li><a id="org00f1bfb"></a><span class="done DONE">DONE</span> 2.3.2 FreeBSD<br /></li>
<li><a id="org1c5b96f"></a><span class="done DONE">DONE</span> Linux<br /></li>
<li><a id="org03c3d5a"></a><span class="done DONE">DONE</span> Mac OS X<br /></li>
<li><a id="org48e336d"></a><span class="done DONE">DONE</span> SOlaris<br /></li>
<li><a id="org01344aa"></a><span class="done DONE">DONE</span> Others<br />
<div class="outline-text-5" id="text-org01344aa">
<ul class="org-ul">
<li>AIX, IBMUNIX</li>
<li>HP-UX, HP</li>
<li>IRIX, Silicon Graphics</li>
<li>Unix Ware, SVR4 distribution</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgec031f7" class="outline-4">
<h4 id="orgec031f7"><span class="done DONE">DONE</span> 2.4 Relationship of Standards and Implementations</h4>
</div>
<div id="outline-container-org6f597cf" class="outline-4">
<h4 id="org6f597cf"><span class="done DONE">DONE</span> 2.5 Limits</h4>
<div class="outline-text-4" id="text-org6f597cf">
<ol class="org-ol">
<li>Comipile-time limits</li>
<li>Runtime limits</li>
</ol>
</div>
<ul class="org-ul">
<li><a id="org574fc58"></a><span class="done DONE">DONE</span> ISO C Limits<br /></li>
<li><a id="orgf7f2be8"></a><span class="done DONE">DONE</span> POSIX Limits<br />
<div class="outline-text-5" id="text-orgf7f2be8">
<ol class="org-ol">
<li>Numerical limits: <code>LONG_BIT</code>, <code>SSIZE_MAX</code>, and <code>WORD_BIT</code></li>
<li>Minimum value：</li>
<li>Maximum value: <code>_POSIX_CLOCKRES_MIN</code></li>
<li>Runtime increasable values: <code>CHARCLASS_NAME_MAX</code>, <code>COLL_WEIGHTS_MAX</code>, <code>LINE_MAX</code>, <code>NGROUPS_MAX</code>, and <code>RE_DUP_MAX</code></li>
<li>Runtime invariant values;</li>
<li>Other invariant values: <code>NL_ARGMAX</code>, <code>NL_MSGMAX</code>, <code>NL_SETMAX</code>, and <code>NL_TEXTMAX</code>;</li>
<li>Pathname variables values: <code>FILESIZEBITS</code>, <code>LINK_MAX</code>, <code>MAX_CANON</code>, <code>MAX_INPUT</code>, <code>NAME_MAX</code>, <code>PATH_MAX</code>, <code>PIPE_BUF</code>, and <code>SYMLINK_MAX</code></li>
</ol>
</div>
</li>
<li><a id="org2f07512"></a><span class="done DONE">DONE</span> XSI Limits<br />
<div class="outline-text-5" id="text-org2f07512">
<ol class="org-ol">
<li>Minimum values:</li>
<li>Runtime invariant values, possibly indeterminate: <b>IOV_MAX</b> and <b>PAGE_SIZE</b></li>
</ol>
</div>
</li>
<li><a id="orgc16173d"></a><span class="done DONE">DONE</span> <code>sysconf</code>, <code>pathconf</code>, and <code>fpathconf</code> Functions<br />
<div class="outline-text-5" id="text-orgc16173d">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>Figure 2.13 Build C program to print all supported configuration limits</label><pre class="src src-awk"><span style="color: #008787; background-color: #262626;">#</span><span style="color: #008787; background-color: #262626;">!/usr/bin/awk -f</span>

<span style="color: #268bd2; font-weight: bold;">BEGIN</span>   <span style="color: #268bd2;">{</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"#include \"apue.h\"\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"#include &lt;errno.h&gt;\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"#include &lt;limits.h&gt;\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"static void pr_sysconf(char *, int);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"static void pr_pathconf(char *, char *, int);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"int\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"main(int argc, char *argv[])\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"{\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\tif (argc != 2)\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\terr_quit(\"usage: a.out &lt;dirname&gt;\");\n\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #8787d7;">FS</span>=<span style="color: #2aa198;">"\t+"</span>
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">getline</span> &lt;<span style="color: #2aa198;">"sysconf.sym"</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#ifdef %s\n"</span>, $1<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\tprintf(\"%s defined to be %%ld\\n\", (long)%s+0);\n"</span>, $1, $1<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#else\n"</span><span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $1<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#endif\n"</span><span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#ifdef %s\n"</span>, $2<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\tpr_sysconf(\"%s =\", %s);\n"</span>, $1, $2<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#else\n"</span><span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $2<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#endif\n"</span><span style="color: #2aa198;">)</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #d75fd7;">close</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"sysconf.sym"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">getline</span> &lt;<span style="color: #2aa198;">"pathconf.sym"</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#ifdef %s\n"</span>, $1<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\tprintf(\"%s defined to be %%ld\\n\", (long)%s+0);\n"</span>, $1, $1<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#else\n"</span><span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $1<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#endif\n"</span><span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#ifdef %s\n"</span>, $2<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\tpr_pathconf(\"%s =\", argv[1], %s);\n"</span>, $1, $2<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#else\n"</span><span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $2<span style="color: #2aa198;">)</span>
        <span style="color: #d75fd7;">printf</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"#endif\n"</span><span style="color: #2aa198;">)</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #d75fd7;">close</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pathconf.sym"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #268bd2; font-weight: bold;">exit</span>
<span style="color: #268bd2;">}</span>
<span style="color: #268bd2; font-weight: bold;">END</span> <span style="color: #268bd2;">{</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\texit(0);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"}\n\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"static void\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pr_sysconf(char *mesg, int name)\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"{\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\tlong  val;\n\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\tfputs(mesg, stdout);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\terrno = 0;\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\tif ((val = sysconf(name)) &lt; 0) {\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\tif (errno != 0) {\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\tif (errno == EINVAL)\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\t\tfputs(\" (not supported)\\n\", stdout);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\telse\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\t\terr_sys(\"sysconf error\");\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t} else {\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\tfputs(\" (no limit)\\n\", stdout);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t}\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t} else {\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\tprintf(\" %%ld\\n\", val);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t}\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"}\n\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"static void\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pr_pathconf(char *mesg, char *path, int name)\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"{\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\tlong val;\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\tfputs(mesg, stdout);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\terrno = 0;\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\tif ((val = pathconf(path, name)) &lt; 0) {\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\tif (errno != 0) {\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\tif (errno == EINVAL)\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\t\tfputs(\" (not supported)\\n\", stdout);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\telse\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\t\terr_sys(\"pathconf error, path = %%s\", path);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t} else {\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t\tfputs(\" (no limit)\\n\", stdout);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\t}\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t} else {\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t\tprintf(\" %%ld\\n\", val);\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\t}\n"</span><span style="color: #d75fd7;">)</span>
    <span style="color: #d75fd7;">printf</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"}\n"</span><span style="color: #d75fd7;">)</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="orgd65b806"></a><span class="done DONE">DONE</span> Indeterminate Runtime Limits<br />
<div class="outline-text-5" id="text-orgd65b806">
<ol class="org-ol">
<li></li>
</ol>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>pathalloc</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#ifdef</span>  PATH_MAX
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">pathmax</span> = PATH_MAX;
<span style="color: #d75fd7;">#else</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">pathmax</span> = <span style="color: #d75fd7;">0</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">posix_version</span> = <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">xsi_version</span> = <span style="color: #d75fd7;">0</span>;

<span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">If PATH_MAX is indeterminate, no guarantee this is adequate */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">PATH_MAX_GUESS</span>  <span style="color: #d75fd7;">1024</span>

<span style="color: #df005f; font-weight: bold;">char</span> *
<span style="color: #d75fd7; font-weight: bold;">path_alloc</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">size_t</span> *<span style="color: #8787d7;">sizep</span><span style="color: #268bd2;">)</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">also return allocated size, if nonnull */</span>
<span style="color: #268bd2;">{</span>
  <span style="color: #df005f; font-weight: bold;">char</span>  *<span style="color: #8787d7;">ptr</span>;
  <span style="color: #df005f; font-weight: bold;">size_t</span>  <span style="color: #8787d7;">size</span>;

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>posix_version == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
    posix_version = sysconf<span style="color: #d75fd7;">(</span>_SC_VERSION<span style="color: #d75fd7;">)</span>;

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>xsi_version == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
    xsi_version = sysconf<span style="color: #d75fd7;">(</span>_SC_XOPEN_VERSION<span style="color: #d75fd7;">)</span>;

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pathmax == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>   <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">first time through */</span>
    errno = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>pathmax = pathconf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"/"</span>, _PC_PATH_MAX<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
      <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span>
        pathmax = PATH_MAX_GUESS; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">it's indeterminate */</span>
      <span style="color: #268bd2; font-weight: bold;">else</span>
        err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"pathconf error for _PC_PATH_MAX"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
      pathmax++;    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">add one since it's relative to root */</span>
    <span style="color: #2aa198;">}</span>
  <span style="color: #d75fd7;">}</span>

  <span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;">   * Before POSIX.1-2001, we aren't guaranteed that PATH_MAX includes</span>
<span style="color: #008787; background-color: #262626;">   * the terminating null byte.  Same goes for XPG3.</span>
<span style="color: #008787; background-color: #262626;">   */</span>
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>posix_version &lt; <span style="color: #d75fd7;">200112L</span><span style="color: #2aa198;">)</span> &amp;&amp; <span style="color: #2aa198;">(</span>xsi_version &lt; <span style="color: #d75fd7;">4</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>
    size = pathmax + <span style="color: #d75fd7;">1</span>;
  <span style="color: #268bd2; font-weight: bold;">else</span>
    size = pathmax;

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ptr = malloc<span style="color: #67b11d;">(</span>size<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
    err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"malloc error for pathname"</span><span style="color: #d75fd7;">)</span>;

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sizep != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
    *sizep = size;
  <span style="color: #268bd2; font-weight: bold;">return</span><span style="color: #d75fd7;">(</span>ptr<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<ol class="org-ol">
<li></li>
</ol>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>openmax</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#ifdef</span> OPEN_MAX
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">openmax</span> = OPEN_MAX;
<span style="color: #d75fd7;">#else</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">openmax</span> = <span style="color: #d75fd7;">0</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;"> * If OPEN_MAX is indeterminate, this might be inadequate.</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">OPEN_MAX_GUESS</span> <span style="color: #d75fd7;">256</span>

<span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #d75fd7; font-weight: bold;">open_max</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>openmax == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">first time through */</span>
        errno = <span style="color: #d75fd7;">0</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>openmax = sysconf<span style="color: #875f00;">(</span>_SC_OPEN_MAX<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span>
                openmax = OPEN_MAX_GUESS; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">it's indeterminate */</span>
            <span style="color: #268bd2; font-weight: bold;">else</span>
                err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"sysconf error for _SC_OPEN_MAX"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>openmax<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-org55a57ac" class="outline-4">
<h4 id="org55a57ac"><span class="done DONE">DONE</span> 2.6 Options</h4>
<div class="outline-text-4" id="text-org55a57ac">
<ol class="org-ol">
<li>Compile-time options are defined in <code>&lt;unistd.h&gt;</code></li>
<li>Runtime options are not associated with a file or a directory are idnetified with the <code>sysconf</code> function</li>
<li>Runtime options that are associated with a file or a directory are discovered by calling either the <code>pathconf</code> or the <code>fpathconf</code> function</li>
</ol>
</div>
</div>
<div id="outline-container-org3e6f7b2" class="outline-4">
<h4 id="org3e6f7b2"><span class="done DONE">DONE</span> 2.7 Features Test Macros</h4>
<div class="outline-text-4" id="text-org3e6f7b2">
<p>
<code>cc -D_POSIX_C_SOURCE=200809L code.c</code>
</p>
</div>
</div>
<div id="outline-container-orga676255" class="outline-4">
<h4 id="orga676255"><span class="done DONE">DONE</span> 2.8 Primitive System Data Types</h4>
<div class="outline-text-4" id="text-orga676255">
<p>
The header <code>&lt;sys/types.h&gt;</code> defines some implementation-dependent data types, called the <i>primitive system data types</i>.
</p>
</div>
</div>
<div id="outline-container-org1b0f504" class="outline-4">
<h4 id="org1b0f504"><span class="done DONE">DONE</span> 2.9 Differences Between Standards</h4>
</div>
<div id="outline-container-org6129f97" class="outline-4">
<h4 id="org6129f97"><span class="done DONE">DONE</span> 2.10 Summary</h4>
<div class="outline-text-4" id="text-org6129f97">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>2.1  #ifndef &#x2026; #define &#x2026; #endif</li>
<li>2.2  <code>u_long, ushort, uint, u_quad_t, quad_t, qaddr_t, daddr_t, fixpt_t</code></li>
<li><p>
2.3
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>OPEN_MAX exercise</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/resource.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">OPEN_MAX_GUESS</span> <span style="color: #d75fd7;">256</span>

<span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #d75fd7; font-weight: bold;">open_max</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span>          <span style="color: #8787d7;">openmax</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">rlimit</span> <span style="color: #8787d7;">rl</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>openmax = sysconf<span style="color: #67b11d;">(</span>_SC_OPEN_MAX<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span> || openmax == LONG_MAX<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>getrlimit<span style="color: #67b11d;">(</span>RLIMIT_NOFILE, &amp;rl<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"can&#8242;t get file limit"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>rl.rlim_max == RLIM_INFINITY<span style="color: #2aa198;">)</span>
            openmax = OPEN_MAX_GUESS;
        <span style="color: #268bd2; font-weight: bold;">else</span>
            openmax = rl.rlim_max;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>openmax<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%ld\n"</span>, open_max<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc78aa6e" class="outline-3">
<h3 id="orgc78aa6e"><span class="done DONE">DONE</span> Chapter 3. File I/O <code>[17/17]</code></h3>
<div class="outline-text-3" id="text-orgc78aa6e">
</div>
<div id="outline-container-org4f393a8" class="outline-4">
<h4 id="org4f393a8"><span class="done DONE">DONE</span> 3.1 Introduction</h4>
</div>
<div id="outline-container-org2df318f" class="outline-4">
<h4 id="org2df318f"><span class="done DONE">DONE</span> 3.2 File Descriptors</h4>
<div class="outline-text-4" id="text-org2df318f">
<p>
To the kernel, all open file are referred to by file descriptors.
</p>
<ul class="org-ul">
<li>0: stdin</li>
<li>1: stdout</li>
<li>2: stderr</li>
</ul>
</div>
</div>
<div id="outline-container-org9daac86" class="outline-4">
<h4 id="org9daac86"><span class="done DONE">DONE</span> 3.3 <code>open</code> and <code>openat</code> Functions</h4>
<div class="outline-text-4" id="text-org9daac86">
<p>
<code>man 2 open</code>
</p>
</div>
</div>
<div id="outline-container-orgb3eb2df" class="outline-4">
<h4 id="orgb3eb2df"><span class="done DONE">DONE</span> 3.4 <code>creat</code> Function</h4>
<div class="outline-text-4" id="text-orgb3eb2df">
<p>
<code>man 2 creat</code>
</p>
</div>
</div>
<div id="outline-container-org56a4d48" class="outline-4">
<h4 id="org56a4d48"><span class="done DONE">DONE</span> 3.5 <code>close</code> Function</h4>
<div class="outline-text-4" id="text-org56a4d48">
<p>
<code>man 2 close</code>
</p>
</div>
</div>
<div id="outline-container-orge805f69" class="outline-4">
<h4 id="orge805f69"><span class="done DONE">DONE</span> 3.6 <code>lseek</code> Function</h4>
<div class="outline-text-4" id="text-orge805f69">
<p>
<code>man 2 lseek</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>Figure 3.1 Test whether standard input is capable of seeking</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>lseek<span style="color: #2aa198;">(</span>STDIN_FILENO, <span style="color: #d75fd7;">0</span>, SEEK_CUR<span style="color: #2aa198;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"seek OK\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>Figure 3.2 Create a file with a hole in it</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf1</span><span style="color: #268bd2;">[]</span> = <span style="color: #2aa198;">"abcdefghij"</span>;
<span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf2</span><span style="color: #268bd2;">[]</span> = <span style="color: #2aa198;">"ABCDEFGHIJ"</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = creat<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"file.hole"</span>, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"creat error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>write<span style="color: #2aa198;">(</span>fd, buf1, <span style="color: #d75fd7;">10</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">10</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"buf1 write error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>lseek<span style="color: #2aa198;">(</span>fd, <span style="color: #d75fd7;">16384</span>, SEEK_SET<span style="color: #2aa198;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"lssek error: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>write<span style="color: #2aa198;">(</span>fd, buf2, <span style="color: #d75fd7;">10</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">10</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"buf2 write error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org656a112" class="outline-4">
<h4 id="org656a112"><span class="done DONE">DONE</span> 3.7 <code>read</code> Function</h4>
<div class="outline-text-4" id="text-org656a112">
<p>
<code>man 2 read</code>
</p>
</div>
</div>
<div id="outline-container-org72d89b1" class="outline-4">
<h4 id="org72d89b1"><span class="done DONE">DONE</span> 3.8 <code>write</code> Function</h4>
<div class="outline-text-4" id="text-org72d89b1">
<p>
<code>man 2 write</code>
</p>
</div>
</div>
<div id="outline-container-orgdbf68ef" class="outline-4">
<h4 id="orgdbf68ef"><span class="done DONE">DONE</span> 3.9 I/O Efficiency</h4>
<div class="outline-text-4" id="text-orgdbf68ef">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>Figure 3.5 Copy standard input to standard output</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/stat.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>BUFSIZ<span style="color: #d75fd7;">]</span>;

    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">in</span>  = open<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, O_RDONLY<span style="color: #d75fd7;">)</span>;
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">out</span> = open<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">]</span>, O_CREAT | O_RDWR, <span style="color: #d75fd7;">0644</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>n = read<span style="color: #67b11d;">(</span>in, buf, BUFSIZ<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>write<span style="color: #67b11d;">(</span>out, buf, n<span style="color: #67b11d;">)</span> != n<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    close<span style="color: #d75fd7;">(</span>in<span style="color: #d75fd7;">)</span>;
    close<span style="color: #d75fd7;">(</span>out<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>n &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3848f6a" class="outline-4">
<h4 id="org3848f6a"><span class="done DONE">DONE</span> 3.10 File Sharing</h4>
<div class="outline-text-4" id="text-org3848f6a">
<ol class="org-ol">
<li>Every process has an entry in the process table.</li>
<li>The kernel maintains a file table for all open files.</li>
<li>Each open file(or device) has a v-node structure that contains information about the type of file <br />
and pointers to functions that operate on the file;</li>
</ol>
</div>
</div>
<div id="outline-container-org0934e08" class="outline-4">
<h4 id="org0934e08"><span class="done DONE">DONE</span> 3.11 Atomic Operations</h4>
<div class="outline-text-4" id="text-org0934e08">
<ul class="org-ul">
<li>Appending to a File</li>
<li><code>pread</code> and <code>pwrite</code> Functions
Calling pread is equivalent to calling lseek followed by a call to read, with the following exceptions.
<ul class="org-ul">
<li>There is no way to interrupt the two operations that occur when we call pread.</li>
<li>The current file offset is not updated.</li>
</ul></li>

<li>Creating a File
<i>atomic operation</i> refers to an operation that might be composed of multiple steps</li>
</ul>
</div>
</div>
<div id="outline-container-orgee0dc87" class="outline-4">
<h4 id="orgee0dc87"><span class="done DONE">DONE</span> 3.12 <code>dup</code> and <code>dup2</code> Functions</h4>
<div class="outline-text-4" id="text-orgee0dc87">
<p>
<code>man 2 dup</code>
</p>
<ul class="org-ul">
<li><code>dup(fd)</code> ~ =fcntl(fd, F_DUPFD, 0)~</li>
<li><code>dup2(fd, fd2)= = =close(fd2); fcntl(fd, F_DUPFD, fd2);</code> <br /></li>
</ul>
<p>
Differences:
</p>
<ul class="org-ul">
<li>dup2 is an atomic operation, whereas the alternate form involves two function calls.</li>
<li>errno differences</li>
</ul>
</div>
</div>
<div id="outline-container-orga8fce9a" class="outline-4">
<h4 id="orga8fce9a"><span class="done DONE">DONE</span> 3.13 <code>sync</code>, <code>fsync</code> and <code>fdatasync</code> Functions</h4>
<div class="outline-text-4" id="text-orga8fce9a">
<p>
<code>man 2 sync</code>
</p>
</div>
</div>
<div id="outline-container-org7aed7c9" class="outline-4">
<h4 id="org7aed7c9"><span class="done DONE">DONE</span> 3.14 <code>fcntl</code> Function</h4>
<div class="outline-text-4" id="text-org7aed7c9">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">fcntl</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">cmd</span>, ... <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">int arg */</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: dependos on cmd if OK (see following), -1 on error</span>
</pre>
</div>
<p>
The <code>fcntl</code> function is used for five different purposes.
</p>
<ol class="org-ol">
<li>Duplicate an existing descriptor (<i>cmd</i> = <code>F_DUPFD</code> or <code>F_DUPFD_CLOEXEC</code>)</li>
<li>Get/set file descriptor flags (<i>cmd</i> = <code>F_GETFD</code> or <code>F_SETFD</code>)</li>
<li>Get/set file status flags (<i>cmd</i> = <code>F_GETFL</code> or <code>F_SETFL</code>)</li>
<li>Get/set asynchronous I/O ownership (<i>cmd</i> = <code>F_GETOWN</code> or <code>F_SETOWN</code>)</li>
<li>Get/set record locks (<i>cmd</i> = <code>F_GETLK</code>, <code>F_SETLK</code>, or <code>F_SETLKW</code>)</li>

<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>Figure 3.11 Print file flags for specified descriptor</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">val</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: ./a.out &lt;descriptor#"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>val = fcntl<span style="color: #67b11d;">(</span>atoi<span style="color: #875f00;">(</span>argv<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span><span style="color: #875f00;">)</span>, F_GETFL, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fcntl error for  %d: %s"</span>, atoi<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #d75fd7;">(</span>val &amp; O_ACCMODE<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">case</span> O_RDONLY:
            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read only"</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">case</span> O_WRONLY:
            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"write only"</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">case</span> O_RDWR:
            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read write"</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">default</span>:
            err_dump<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"unknown access mode"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>val &amp; O_APPEND<span style="color: #d75fd7;">)</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">", append"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>val &amp; O_NONBLOCK<span style="color: #d75fd7;">)</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">", nonblocking"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>val &amp; O_SYNC<span style="color: #d75fd7;">)</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">", synchronous writes"</span><span style="color: #d75fd7;">)</span>;

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">!</span><span style="color: #d75fd7;">defined</span><span style="color: #d75fd7;">(</span>_POSIX_C_SOURCE<span style="color: #d75fd7;">)</span> &amp;&amp; <span style="color: #d75fd7;">defined</span><span style="color: #d75fd7;">(</span>O_FSYNC<span style="color: #d75fd7;">)</span> &amp;&amp; <span style="color: #d75fd7;">(</span>O_FSYNC != O_SYNC<span style="color: #d75fd7;">)</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>val &amp; O_FSYNC<span style="color: #d75fd7;">)</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">", synchronous writes"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>
    putchar<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">'\n'</span><span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ol>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>Figure 3.12 Turn on one or more of the file status flags for a descriptor</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">set_fl</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">flags</span><span style="color: #268bd2;">)</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">flags are file status flags to turn on */</span>

<span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">val</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>val = fcntl<span style="color: #67b11d;">(</span>fd, F_GETFL, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fcntl F_GETFL: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    val |= flags; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">turn on flags */</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fcntl<span style="color: #2aa198;">(</span>fd, F_SETFL, val<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fcntl F_SETFL: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6849410" class="outline-4">
<h4 id="org6849410"><span class="done DONE">DONE</span> 3.15 <code>ioctl</code> Function</h4>
<div class="outline-text-4" id="text-org6849410">
<p>
<code>man 2 ioctl</code>
</p>
</div>
</div>
<div id="outline-container-orgd536f09" class="outline-4">
<h4 id="orgd536f09"><span class="done DONE">DONE</span> 3.16 <code>/dev/fd</code></h4>
</div>
<div id="outline-container-org5d3ebed" class="outline-4">
<h4 id="org5d3ebed"><span class="done DONE">DONE</span> 3.17 Summary</h4>
<div class="outline-text-4" id="text-org5d3ebed">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>3.1  All disk I/O need to via buffer block. <br />
<code>read/write</code> always be buffered via kernel automatically, unbuffered only means user process;</li>
<li><p>
3.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">my_dup2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd2</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fd2 &gt; open_max<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;">     * use lseek to verify whether fd is valid</span>
<span style="color: #008787; background-color: #262626;">     */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>lseek<span style="color: #2aa198;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_CUR<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span> &amp;&amp; errno == EBADF<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"file descriptor: %d is not valid, %m\n"</span>, fd<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">return if fd2 is fd */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fd == fd2<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> fd2;
    <span style="color: #d75fd7;">}</span>

    close<span style="color: #d75fd7;">(</span>fd2<span style="color: #d75fd7;">)</span>;

    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">i</span> = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; open_max<span style="color: #2aa198;">()</span>; i++<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        i = dup<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>i == fd2<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">for (; i &gt; fd; i--) { */</span>
    <span style="color: #008787; background-color: #262626;">/*   </span><span style="color: #008787; background-color: #262626;">close(i); */</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">} */</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fd2<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc &lt; <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: ./a.out &lt;string&gt;"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%ld\n"</span>, open_max<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    my_dup2<span style="color: #d75fd7;">(</span>STDERR_FILENO, <span style="color: #d75fd7;">5</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">i</span> = <span style="color: #d75fd7;">1</span>; i &lt; argc; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        write<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">5</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, strlen<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
        write<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">5</span>, <span style="color: #2aa198;">"\n"</span>, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    close<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">5</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>3.3  F_SETFD: affect fd1 <b>file descriptor</b> <br />
F_SETFL: affect fd1 and fd2 <b>file table</b></li>
<li>3.4  without <code>if (fd &gt; 2)</code>, there are 4 descriptors pointer to file, otherwise , there will be 3</li>
<li>3.5  <code>./a.out &gt; outfile 2&gt;&amp;1</code>: stdout <code>&gt; outfile, stderr =&gt; stdout =&gt; outfile
        =./a.out 2&gt;&amp;1 &gt; outfile</code>: stderr =&gt; stdout, stdout =&gt; outfile <br /></li>
<li><p>
3.6
</p>
<div class="org-src-container">
<pre class="src src-c,">#include &lt;fcntl.h&gt;

#include "apue.h"

int main(int argc, char *argv[argc]) {
    int  fd           = 0;
    int  ret          = 0;
    char buf[MAXLINE] = {0};

    fd = open("./a.txt", O_CREAT | O_RDWR | O_APPEND);
    if (fd &lt; 0) {
        err_sys("open: %s", strerror(errno));
    }

    ret = write(fd, "hello world", 11);
    if (ret &lt; 0) {
        err_sys("write: %s", strerror(errno));
    }

    ret = lseek(fd, 0, SEEK_SET);
    while ((ret = read(fd, buf, MAXLINE))) {
        ;
    }
    if (ret == -1) {
        err_sys("read: %s", strerror(errno));
    }
    printf("read: %s\n", buf);

    ret = lseek(fd, -18, SEEK_CUR);
    ret = write(fd, "hello world", 11);
    if (ret &lt; 0) {
        err_sys("write: %s", strerror(errno));
    }

    ret = lseek(fd, 0, SEEK_SET);
    while ((ret = read(fd, buf, MAXLINE)) &gt; 0) {
        ;
    }
    if (ret == -1) {
        err_sys("read: %s", strerror(errno));
    }
    printf("read: %s\n", buf);

    ret = lseek(fd, 10, SEEK_SET);
    while ((ret = read(fd, buf, MAXLINE)) &gt; 0) {
        ;
    }
    if (ret == -1) {
        err_sys("read: %s", strerror(errno));
    }
    printf("read: %s\n", buf);

    return 0;
}
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1a54e6d" class="outline-3">
<h3 id="org1a54e6d"><span class="done DONE">DONE</span> Chapter 4. System Data Files and Information <code>[26/26]</code></h3>
<div class="outline-text-3" id="text-org1a54e6d">
</div>
<div id="outline-container-org9c8f1b9" class="outline-4">
<h4 id="org9c8f1b9"><span class="done DONE">DONE</span> 4.1 Introduction</h4>
</div>
<div id="outline-container-orgad984b9" class="outline-4">
<h4 id="orgad984b9"><span class="done DONE">DONE</span> 4.2 <code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</h4>
<div class="outline-text-4" id="text-orgad984b9">
<p>
<code>man 2 stat</code>
</p>
</div>
</div>
<div id="outline-container-org8075790" class="outline-4">
<h4 id="org8075790"><span class="done DONE">DONE</span> 4.3 File Types</h4>
<div class="outline-text-4" id="text-org8075790">
<ol class="org-ol">
<li>Regular file.
There is no distinction to the UNIX kernel whether this data is text or binary.</li>
<li>Directory file.</li>
<li>Block special file.</li>
<li>Character special file.
providing unbuffered I/O access.</li>
<li>FIFO.</li>
<li>Socket</li>
<li>Symbolic link.</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>Figure 4.3 Print type of file for each command-line argument</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/stat.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">i</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> <span style="color: #8787d7;">buf</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *      <span style="color: #8787d7;">ptr</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">1</span>; i &lt; argc; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>lstat<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"%s"</span>, argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>, strerror<span style="color: #875f00;">(</span>errno<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISREG<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ptr = <span style="color: #2aa198;">"regular"</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISLNK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ptr = <span style="color: #2aa198;">"symbolic link"</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISSOCK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ptr = <span style="color: #2aa198;">"socket"</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ptr = <span style="color: #2aa198;">"block special"</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ptr = <span style="color: #2aa198;">"directory"</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ptr = <span style="color: #2aa198;">"character special"</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISFIFO<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ptr = <span style="color: #2aa198;">"named pipe(fifo)"</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            ptr = <span style="color: #2aa198;">"** unknown mode **"</span>;
        <span style="color: #2aa198;">}</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s\n"</span>, ptr<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org7c47d09" class="outline-4">
<h4 id="org7c47d09"><span class="done DONE">DONE</span> 4.4 Set-User-ID and Set-Group-ID</h4>
<div class="outline-text-4" id="text-org7c47d09">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">IDs</th>
<th scope="col" class="org-left">using for</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">real user ID</td>
<td class="org-left">who we really are</td>
</tr>

<tr>
<td class="org-left">real group ID</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">effective user ID</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">effective group ID</td>
<td class="org-left">used for file access permission checks</td>
</tr>

<tr>
<td class="org-left">supplementary group IDs</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">save set-user-ID</td>
<td class="org-left">saved by exec functions</td>
</tr>

<tr>
<td class="org-left">save set-group-ID</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org8a0592a" class="outline-4">
<h4 id="org8a0592a"><span class="done DONE">DONE</span> 4.5 File Access Permissions</h4>
<div class="outline-text-4" id="text-org8a0592a">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">st_mode mask</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_IRUSR</td>
<td class="org-left">user-read</td>
</tr>

<tr>
<td class="org-left">S_IWUSR</td>
<td class="org-left">user-write</td>
</tr>

<tr>
<td class="org-left">S_IXUSR</td>
<td class="org-left">user-execute</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IRGRP</td>
<td class="org-left">group-read</td>
</tr>

<tr>
<td class="org-left">S_IWGRP</td>
<td class="org-left">group-write</td>
</tr>

<tr>
<td class="org-left">S_IXGRP</td>
<td class="org-left">group-execute</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IROTH</td>
<td class="org-left">other-read</td>
</tr>

<tr>
<td class="org-left">S_IWOTH</td>
<td class="org-left">other-write</td>
</tr>

<tr>
<td class="org-left">S_IXOTH</td>
<td class="org-left">other-execute</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org88e4db3" class="outline-4">
<h4 id="org88e4db3"><span class="done DONE">DONE</span> 4.6 Ownership of New Files and Directories</h4>
</div>
<div id="outline-container-org2c7a686" class="outline-4">
<h4 id="org2c7a686"><span class="done DONE">DONE</span> <code>access</code> and <code>faccessat</code> Functions</h4>
<div class="outline-text-4" id="text-org2c7a686">
<p>
<code>man 2 access</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>Figure 4.8 Example of access function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: a.out &lt;pathname&gt;"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>access<span style="color: #2aa198;">(</span>argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span>, R_OK<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_ret<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"access error for %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read access OK\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = open<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_ret<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open error for %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open for reading OK\n"</span><span style="color: #2aa198;">)</span>;
        close<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org7d7be0d" class="outline-4">
<h4 id="org7d7be0d"><span class="done DONE">DONE</span> <code>umask</code> Function</h4>
<div class="outline-text-4" id="text-org7d7be0d">
<p>
<code>man 2 umask</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span>Figure 4.9 Example of umask function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">RWRWRW</span> <span style="color: #268bd2;">(</span>S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH<span style="color: #268bd2;">)</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    umask<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>creat<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"foo"</span>, RWRWRW<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"creat \"foo\": %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    umask<span style="color: #d75fd7;">(</span>S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>creat<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"bar"</span>, RWRWRW<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"creat \"bar\": %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org8be32f5" class="outline-4">
<h4 id="org8be32f5"><span class="done DONE">DONE</span> <code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</h4>
<div class="outline-text-4" id="text-org8be32f5">
<p>
<code>man 2 chmod</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>Figure 4.12 Example of chmod function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> <span style="color: #8787d7;">statbuf</span>;

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">turn on set-group-ID and turn off group-execute */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>stat<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"foo"</span>, &amp;statbuf<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"stat error for foo"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>chmod<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"foo"</span>, <span style="color: #67b11d;">(</span>statbuf.st_mode &amp; ~S_IXGRP<span style="color: #67b11d;">)</span> | S_ISGID<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"chmod error for foo"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">set absolute mode to "rw-r--r--" */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>chmod<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"bar"</span>, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"chmod error for bar"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org5d21abe" class="outline-4">
<h4 id="org5d21abe"><span class="done DONE">DONE</span> Sticky Bit</h4>
<div class="outline-text-4" id="text-org5d21abe">
<p>
If it was set for an executable program file, then the first time the program was executed, <br />
a copy of the program’s text was saved in the swap area when the process terminated
</p>
</div>
</div>
<div id="outline-container-org37c9daa" class="outline-4">
<h4 id="org37c9daa"><span class="done DONE">DONE</span> <code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</h4>
<div class="outline-text-4" id="text-org37c9daa">
<p>
<code>man 2 chown</code>
</p>
</div>
</div>
<div id="outline-container-orgcb18ddd" class="outline-4">
<h4 id="orgcb18ddd"><span class="done DONE">DONE</span> File Size</h4>
<div class="outline-text-4" id="text-orgcb18ddd">
<p>
<code>struct stat.st_size</code>
</p>
</div>
</div>
<div id="outline-container-org7b10626" class="outline-4">
<h4 id="org7b10626"><span class="done DONE">DONE</span> File Truncation</h4>
<div class="outline-text-4" id="text-org7b10626">
<p>
<code>man 2 truncate</code>
</p>
</div>
</div>
<div id="outline-container-org814522e" class="outline-4">
<h4 id="org814522e"><span class="done DONE">DONE</span> File Systems</h4>
<div class="outline-text-4" id="text-org814522e">
<ul class="org-ul">
<li>Only when the link count goes to 0 can the file be deleted. <br />
<code>struct stat.st_nlink</code></li>
<li>The other type of link is called a symbolic link. With a symbolic link, the actual contents of the file—the data blocks—store the name of the file that the symbolic link points to.</li>
<li>The i-node contains all the information about the file. <br />
Most of the information in the stat structure is obtained from the i-node, exclude <b>filename</b> and <b>i-node</b> number.</li>
<li>a directory entry can’t refer to an i-node in a different file system.</li>
<li>When renaming a file without changing file systems, the actual contents of the file need not be moved—all that needs to be done is to add a new directory entry that points to the existing i-node and then unlink the old directory entry.</li>
</ul>
</div>
</div>
<div id="outline-container-orgcb01620" class="outline-4">
<h4 id="orgcb01620"><span class="done DONE">DONE</span> <code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</h4>
<div class="outline-text-4" id="text-orgcb01620">
<p>
<code>man 2 link</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>Figure 4.16 Open a file and then unlink it</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>open<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"tempfile"</span>, O_RDWR<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>unlink<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"tempfile"</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"unlink: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"file unlinked\n"</span><span style="color: #d75fd7;">)</span>;
    sleep<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">15</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"done\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orge192979" class="outline-4">
<h4 id="orge192979"><span class="done DONE">DONE</span> <code>rename</code> and <code>renameat</code> Functions</h4>
<div class="outline-text-4" id="text-orge192979">
<p>
<code>man 2 rename</code>
</p>
<ol class="org-ol">
<li>If oldname specifies a file that is not a directory, then we are renaming a file or a symbolic link.</li>
<li>If oldname specifies a directory, then we are renaming a directory.</li>
<li>If either oldname or newname refers to a symbolic link, then the link itself is processed, not the file to which it resolves.</li>
<li>We can’t rename dot or dot-dot.</li>
<li>As a special case, if oldname and newname refer to the same file, the function returns successfully without changing anything.</li>
</ol>
</div>
</div>
<div id="outline-container-org29d69ca" class="outline-4">
<h4 id="org29d69ca"><span class="done DONE">DONE</span> Symbolic Links</h4>
<div class="outline-text-4" id="text-org29d69ca">
<ul class="org-ul">
<li>Hard links normally require that the link and the file reside in the same file system.</li>
<li>Only the superuser can create a hard link to a directory (when supported by the underlying file system).</li>
</ul>
</div>
</div>
<div id="outline-container-org65df438" class="outline-4">
<h4 id="org65df438"><span class="done DONE">DONE</span> Creating and Reading Symbolic Links</h4>
<div class="outline-text-4" id="text-org65df438">
<p>
<code>man 2 symlink</code>
<code>man 2 readlink</code>
</p>
</div>
</div>
<div id="outline-container-org6c45c4e" class="outline-4">
<h4 id="org6c45c4e"><span class="done DONE">DONE</span> File Times</h4>
</div>
<div id="outline-container-org9656028" class="outline-4">
<h4 id="org9656028"><span class="done DONE">DONE</span> <code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</h4>
<div class="outline-text-4" id="text-org9656028">
<p>
POSIX.1
<code>man 2 futimens</code>
XSI
<code>man 2 utimes</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>Figure 4.21 Example of futimens function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/stat.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">fd</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span>     <span style="color: #8787d7;">statbuf</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> <span style="color: #8787d7;">times</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; argc; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>, &amp;statbuf<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">fetch current times */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"%s: %s"</span>, argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>, strerror<span style="color: #875f00;">(</span>errno<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">continue</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>fd = open<span style="color: #875f00;">(</span>argv<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>, O_RDWR | O_TRUNC<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">truncate */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"%s: %s"</span>, argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>, strerror<span style="color: #875f00;">(</span>errno<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">continue</span>;
        <span style="color: #2aa198;">}</span>

        times<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span> = statbuf.st_atimespec;
        times<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span> = statbuf.st_mtimespec;

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>futimens<span style="color: #67b11d;">(</span>fd, times<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">reset times */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"%s: %s"</span>, argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>, strerror<span style="color: #875f00;">(</span>errno<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        close<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgee69e66" class="outline-4">
<h4 id="orgee69e66"><span class="done DONE">DONE</span> <code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</h4>
<div class="outline-text-4" id="text-orgee69e66">
<p>
Creat:
<code>man 2 mkdir</code>
Remove:
<code>man 2 rmdir</code>
</p>
</div>
</div>
<div id="outline-container-org3db2627" class="outline-4">
<h4 id="org3db2627"><span class="done DONE">DONE</span> Reading Directories</h4>
<div class="outline-text-4" id="text-org3db2627">
<p>
<code>man 3 opendir</code>
</p>
<ul class="org-ul">
<li>Example <br />
<a href="file:///Users/zhoush/Private/Notes/books/c/APUE/Chapter04/ftw.c">Figure 4.22 Recursively descend a directory hierarchy, counting file types</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgb5e8824" class="outline-4">
<h4 id="orgb5e8824"><span class="done DONE">DONE</span> <code>chidr</code>, <code>fchdir</code> and <code>getcwd</code> Functions</h4>
<div class="outline-text-4" id="text-orgb5e8824">
<p>
<code>man 2 chdir</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>Figure 4.23 Example of chdir function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>chdir<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/tmp"</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        perror<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"chdir: "</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"chdir to /tmp SUCCESS\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
<p>
<code>man 3 getcwd</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span>Figure 4.24 Example of getcwd function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> * <span style="color: #8787d7;">ptr</span>;
    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">size</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>chdir<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/usr/local"</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"chdir: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    ptr = path_alloc<span style="color: #d75fd7;">(</span>&amp;size<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>getcwd<span style="color: #2aa198;">(</span>ptr, size<span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"getcwd: %s\n"</span>, ptr<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"cwd = %s\n"</span>, ptr<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org1eb84ee" class="outline-4">
<h4 id="org1eb84ee"><span class="done DONE">DONE</span> Device Special Files</h4>
<div class="outline-text-4" id="text-org1eb84ee">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span>Figure 4.25 Print st_dev and st_rdev values</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#ifdef</span> SOLARIS
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/mkdev.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#endif</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">SOLARIS</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">i</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> <span style="color: #8787d7;">buf</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; argc; i++<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"stat error"</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">continue</span>;
        <span style="color: #2aa198;">}</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"dev = %d/%d"</span>, MAJOR<span style="color: #67b11d;">(</span>buf.st_dev<span style="color: #67b11d;">)</span>, MINOR<span style="color: #67b11d;">(</span>buf.st_dev<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span> || S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">" (%s) rdev = %d/%d"</span>,
                   <span style="color: #875f00;">(</span>S_ISCHR<span style="color: #268bd2;">(</span>buf.st_mode<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> ? <span style="color: #2aa198;">"character"</span> : <span style="color: #2aa198;">"block"</span>,
                   major<span style="color: #875f00;">(</span>buf.st_mode<span style="color: #875f00;">)</span>, minor<span style="color: #875f00;">(</span>buf.st_rdev<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orga632694" class="outline-4">
<h4 id="orga632694"><span class="done DONE">DONE</span> Summary of File Access Permission Bits</h4>
<div class="outline-text-4" id="text-orga632694">
<p>
S_IRWXU = S_IRUSR | S_IWUSR | S_IXUSR
S_IRWXG = S_IRGRP | S_IWGRP | S_IXGRP
S_IRWXO = S_IROTH | S_IWOTH | S_IXOTH
</p>
</div>
</div>
<div id="outline-container-org069ba14" class="outline-4">
<h4 id="org069ba14"><span class="done DONE">DONE</span> Summary</h4>
<div class="outline-text-4" id="text-org069ba14">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
4.1
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">i</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> <span style="color: #8787d7;">buf</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *      <span style="color: #8787d7;">ptr</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">1</span>; i &lt; argc; i++<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"lstat error"</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">continue</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISREG<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>
            ptr = <span style="color: #2aa198;">"regular"</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>
            ptr = <span style="color: #2aa198;">"directory"</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>
            ptr = <span style="color: #2aa198;">"character special"</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>
            ptr = <span style="color: #2aa198;">"block special"</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISFIFO<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>
            ptr = <span style="color: #2aa198;">"fifo"</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISLNK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>
            ptr = <span style="color: #2aa198;">"symbolic link"</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISSOCK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>
            ptr = <span style="color: #2aa198;">"socket"</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span>
            ptr = <span style="color: #2aa198;">"** unknown mode **"</span>;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s\n"</span>, ptr<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<p>
before modification: symbolic link
after  modification: regular
</p></li>
<li>4.2  default permissions: <code>----------</code></li>
<li>4.3  <code>cat</code> get : Permission denied</li>
<li>4.4  nothing changed.</li>
<li>4.5  directory always shoud be entries for . and ..
the size of symbolic link should be the size of the file contained in.</li>
<li><p>
4.6
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">in</span>, <span style="color: #8787d7;">out</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>        <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>BUFSIZ<span style="color: #d75fd7;">]</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> <span style="color: #8787d7;">stbuf</span> = <span style="color: #d75fd7;">{</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">}</span>;

    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">l_size</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>stat<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"src.txt"</span>, &amp;stbuf<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"stat: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    l_size = stbuf.st_size;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>in = open<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"src.txt"</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span> ||
        <span style="color: #2aa198;">(</span>out = open<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"dst.txt"</span>, O_CREAT | O_RDWR, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">l_sum</span> = <span style="color: #d75fd7;">0</span>;
    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">l_cur</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>l_cur = read<span style="color: #67b11d;">(</span>in, buf, BUFSIZ<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        l_sum += l_cur;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>write<span style="color: #67b11d;">(</span>out, buf, l_cur<span style="color: #67b11d;">)</span> != l_cur<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"write: %s"</span>, strerror<span style="color: #875f00;">(</span>errno<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    close<span style="color: #d75fd7;">(</span>in<span style="color: #d75fd7;">)</span>;
    close<span style="color: #d75fd7;">(</span>out<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>4.7  default access permissions are different</li>
<li>4.8  <code>du</code> check the file/directory/path space instead of disk , and may need path permissions.</li>
<li>4.9  it's not the last link to the file.</li>
<li>4.10  recursive depth number</li>
<li><p>
4.11
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">dirent.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">function type that is called for each filename */</span>
<span style="color: #268bd2; font-weight: bold;">typedef</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #df005f; font-weight: bold;">Myfunc</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">fpath</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> *<span style="color: #8787d7;">sb</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">typeflag</span><span style="color: #268bd2;">)</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">Myfunc</span> <span style="color: #8787d7;">myfunc</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>    <span style="color: #d75fd7; font-weight: bold;">myftw</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">dirpath</span>, <span style="color: #df005f; font-weight: bold;">Myfunc</span> *<span style="color: #8787d7;">func</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>    <span style="color: #d75fd7; font-weight: bold;">dopath</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">dirname</span>, <span style="color: #df005f; font-weight: bold;">Myfunc</span> *<span style="color: #8787d7;">func</span><span style="color: #268bd2;">)</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">nreg</span>, <span style="color: #8787d7;">ndir</span>, <span style="color: #8787d7;">nblk</span>, <span style="color: #8787d7;">nchr</span>, <span style="color: #8787d7;">nfifo</span>, <span style="color: #8787d7;">nslink</span>, <span style="color: #8787d7;">nsock</span>, <span style="color: #8787d7;">ntot</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">ret</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s &lt;starting-pathname&gt;"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    ret = myftw<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, myfunc<span style="color: #d75fd7;">)</span>;

    ntot = nreg + ndir + nblk + nchr + nfifo + nslink + nsock;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ntot == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        ntot = <span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"regular files  = %7ld, %5.2f %%\n"</span>, nreg, nreg * <span style="color: #d75fd7;">100.0</span> / ntot<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"directories    = %7ld, %5.2f %%\n"</span>, ndir, ndir * <span style="color: #d75fd7;">100.0</span> / ntot<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"block special  = %7ld, %5.2f %%\n"</span>, nblk, nblk * <span style="color: #d75fd7;">100.0</span> / ntot<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"char special   = %7ld, %5.2f %%\n"</span>, nchr, nchr * <span style="color: #d75fd7;">100.0</span> / ntot<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"FIFOs          = %7ld, %5.2f %%\n"</span>, nfifo, nfifo * <span style="color: #d75fd7;">100.0</span> / ntot<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"symbolic links = %7ld, %5.2f %%\n"</span>, nslink, nslink * <span style="color: #d75fd7;">100.0</span> / ntot<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"sockets        = %7ld, %5.2f %%\n"</span>, nsock, nsock * <span style="color: #d75fd7;">100.0</span> / ntot<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;"> * Descend through the hierarchy, starting at "pathname".</span>
<span style="color: #008787; background-color: #262626;"> * The caller's func() is called for every file.</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">FTW_F</span>   <span style="color: #d75fd7;">1</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">file other than directory */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">FTW_D</span>   <span style="color: #d75fd7;">2</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">directory */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">FTW_DNR</span> <span style="color: #d75fd7;">3</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">dirctory that cant'be read */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">FTW_NS</span>  <span style="color: #d75fd7;">4</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">file that we can't stat */</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">pathlen</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">myftw</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pathname</span>, <span style="color: #df005f; font-weight: bold;">Myfunc</span> *<span style="color: #8787d7;">func</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">fullpath</span> = path_alloc<span style="color: #d75fd7;">(</span>&amp;pathlen<span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">malloc PATH_MAX+1 bytes */</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pathlen &lt;= strlen<span style="color: #2aa198;">(</span>pathname<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pathlen = strlen<span style="color: #2aa198;">(</span>pathname<span style="color: #2aa198;">)</span> * <span style="color: #d75fd7;">2</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>fullpath = realloc<span style="color: #875f00;">(</span>fullpath, pathlen<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"realloc %s"</span>, strerror<span style="color: #875f00;">(</span>errno<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>dopath<span style="color: #2aa198;">(</span>pathname, func<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;"> * Descend through the hierarchy, starting at "fullpath".</span>
<span style="color: #008787; background-color: #262626;"> * If "fullpath" is anything other than a directory, we lstat() it,</span>
<span style="color: #008787; background-color: #262626;"> * call func(), and return. For a directory, we call ourself</span>
<span style="color: #008787; background-color: #262626;"> * recursively for each name in the directory.</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">we return whatever func() returns  */</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">dopath</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pathname</span>, <span style="color: #df005f; font-weight: bold;">Myfunc</span> *<span style="color: #8787d7;">func</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span>    <span style="color: #8787d7;">statbuf</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">dirent</span> *<span style="color: #8787d7;">dirp</span>;
    <span style="color: #df005f; font-weight: bold;">DIR</span> *          <span style="color: #8787d7;">dp</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">ret</span>, <span style="color: #8787d7;">n</span>;

    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">l</span>   = <span style="color: #d75fd7;">0</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> * <span style="color: #8787d7;">cwd</span> = path_alloc<span style="color: #d75fd7;">(</span>&amp;l<span style="color: #d75fd7;">)</span>;

    chdir<span style="color: #d75fd7;">(</span>pathname<span style="color: #d75fd7;">)</span>;
    getcwd<span style="color: #d75fd7;">(</span>cwd, l<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#ifdef</span> DEBUG
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s\n"</span>, cwd<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>dp = opendir<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"."</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">can't read directory */</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>func<span style="color: #67b11d;">(</span>pathname, &amp;statbuf, FTW_DNR<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>dirp = readdir<span style="color: #67b11d;">(</span>dp<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>strcmp<span style="color: #875f00;">(</span>dirp-&gt;d_name, <span style="color: #2aa198;">"."</span><span style="color: #875f00;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> ||
            <span style="color: #67b11d;">(</span>strcmp<span style="color: #875f00;">(</span>dirp-&gt;d_name, <span style="color: #2aa198;">".."</span><span style="color: #875f00;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">continue</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">ignore dot and dot-dot */</span>
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>lstat<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">stat error */</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_NS<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>statbuf.st_mode<span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">not a directory */</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_F<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_D<span style="color: #67b11d;">)</span>;
            <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">chdir(dirp-&gt;d_name); */</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>ret = dopath<span style="color: #268bd2;">(</span>dirp-&gt;d_name, func<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">chdir(".."); */</span>
            getcwd<span style="color: #67b11d;">(</span>cwd, l<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>closedir<span style="color: #2aa198;">(</span>dp<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_ret<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: %s"</span>, cwd, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>ret<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">myfunc</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pathname</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> *<span style="color: #8787d7;">statptr</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">type</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #d75fd7;">(</span>type<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">case</span> FTW_F:
            <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #2aa198;">(</span>statptr-&gt;st_mode &amp; S_IFMT<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
                <span style="color: #268bd2; font-weight: bold;">case</span> S_IFREG:
                    nreg++;
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #268bd2; font-weight: bold;">case</span> S_IFBLK:
                    nblk++;
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #268bd2; font-weight: bold;">case</span> S_IFCHR:
                    nchr++;
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #268bd2; font-weight: bold;">case</span> S_IFIFO:
                    nfifo++;
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #268bd2; font-weight: bold;">case</span> S_IFLNK:
                    nslink++;
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #268bd2; font-weight: bold;">case</span> S_IFSOCK:
                    nsock++;
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #268bd2; font-weight: bold;">case</span> S_IFDIR:
                    err_dump<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"for S_IFDIR for %s"</span>, pathname<span style="color: #67b11d;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">default</span>:
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #2aa198;">}</span>
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">case</span> FTW_D:
            ndir++;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">case</span> FTW_DNR:
            err_dump<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: %s"</span>, pathname, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">case</span> FTW_NS:
            err_dump<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"stat error for %s"</span>, pathname<span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">default</span>:
            err_dump<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"unknown type %d for pathname %s"</span>, type, pathname<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>4.12  FTP</li>
<li>4.13  <code>stat</code> first, set timespec array to current time that you expect not change, and the other to the value you want.</li>
<li>4.14  access time is the last read time <br />
modify time is last received</li>
<li>4.15  The change time isn't stored because, even if it was stored, you wouldn't be able to set it to the original time. You cannot cheat the change time, it is always based on when the inode data was actually changed.
<br />
Depending on the utility (tar or cpio), you can tell it to keep the original access and/or modify times. For example, tar by default maintains the original modify time but you can use the -m switch to set it to extraction time. The access time is always set to extraction time.</li>
<li><p>
4.16
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">dirname</span> = <span style="color: #2aa198;">"testdir"</span>;
    <span style="color: #df005f; font-weight: bold;">size_t</span>      <span style="color: #8787d7;">pathmax</span> = pathconf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"."</span>, _PC_PATH_MAX<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pathmax: %ld\n"</span>, pathmax<span style="color: #d75fd7;">)</span>;

    <span style="color: #df005f; font-weight: bold;">char</span>   <span style="color: #8787d7;">path</span><span style="color: #d75fd7;">[</span>pathmax<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">curlen</span>;

    strcpy<span style="color: #d75fd7;">(</span>path, dirname<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        curlen = strlen<span style="color: #2aa198;">(</span>getcwd<span style="color: #67b11d;">(</span>path, pathmax<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> + strlen<span style="color: #2aa198;">(</span>dirname<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>curlen &lt;= pathmax<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>mkdir<span style="color: #875f00;">(</span>dirname, <span style="color: #d75fd7;">0777</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"mkdir: %s\n"</span>, strerror<span style="color: #268bd2;">(</span>errno<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
            <span style="color: #67b11d;">}</span>
            sprintf<span style="color: #67b11d;">(</span>path, <span style="color: #2aa198;">"/%s"</span>, dirname<span style="color: #67b11d;">)</span>;
            chdir<span style="color: #67b11d;">(</span>dirname<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"curlen = %ld\n"</span>, curlen<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
4.17
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">path</span> = <span style="color: #2aa198;">"/dev/fd/1"</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">ret</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ret = unlink<span style="color: #67b11d;">(</span>path<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"unlink: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = creat<span style="color: #67b11d;">(</span>path, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"creat: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<p>
<code>unlink: Operation not permitted</code>
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org93be71b" class="outline-3">
<h3 id="org93be71b"><span class="done DONE">DONE</span> Chapter 5. Standard I/O Library <code>[16/16]</code></h3>
<div class="outline-text-3" id="text-org93be71b">
</div>
<div id="outline-container-orgae5d7a8" class="outline-4">
<h4 id="orgae5d7a8"><span class="done DONE">DONE</span> 5.1 Introduction</h4>
<div class="outline-text-4" id="text-orgae5d7a8">
<p>
This library is specified by the ISO C standard because it has been implemented on many operating systems other than the UNIX System.
</p>
</div>
</div>
<div id="outline-container-org48666a2" class="outline-4">
<h4 id="org48666a2"><span class="done DONE">DONE</span> 5.2 Streams and FILE Objects</h4>
<div class="outline-text-4" id="text-org48666a2">
<p>
<code>man 3 fwide</code>
</p>
</div>
</div>
<div id="outline-container-org6da16e1" class="outline-4">
<h4 id="org6da16e1"><span class="done DONE">DONE</span> 5.3 Standard Input, Standard Output and Standard Error</h4>
<div class="outline-text-4" id="text-org6da16e1">
<p>
<code>STDIN_FILENO</code>, <code>STDOUT_FILENO</code>, <code>STDERR_FILENO</code>
</p>
</div>
</div>
<div id="outline-container-org9ebfd7e" class="outline-4">
<h4 id="org9ebfd7e"><span class="done DONE">DONE</span> 5.4 Buffering</h4>
<div class="outline-text-4" id="text-org9ebfd7e">
<p>
Three types of buffering are provided:
</p>
<ol class="org-ol">
<li>Fully buffered. <br />
In this case, actual I/O takes place when the standard I/O buffer is filled.</li>
<li>Line buffered. <br />
In this case, the standard I/O library performs I/O when a newline character is encountered on input or output.</li>
<li>Unbuffered. <br /></li>
</ol>

<p>
ISO C requires the following buffering characteristics:
</p>
<ul class="org-ul">
<li>Standard input and standard output are fully buffered, if and only if they do not refer to an interactive device.</li>
<li>Standard error is never fully buffered.</li>
</ul>

<p>
Most implementations default to the following types of buffering:
</p>
<ul class="org-ul">
<li>Standard error is always unbuffered.</li>
<li>All other streams are line buffered if they refer to a terminal device; otherwise, they are fully buffered.</li>
</ul>


<p>
<code>man 3 setbuf</code>
<code>man 3 fflush</code>
</p>
</div>
</div>
<div id="outline-container-orge99ab7a" class="outline-4">
<h4 id="orge99ab7a"><span class="done DONE">DONE</span> 5.5 Opening a Stream</h4>
<div class="outline-text-4" id="text-orge99ab7a">
<p>
<code>man 3 fopen</code>
<code>man 3 fclose</code>
</p>
</div>
</div>
<div id="outline-container-org7cbe46a" class="outline-4">
<h4 id="org7cbe46a"><span class="done DONE">DONE</span> 5.6 Reading and Writing a Stream</h4>
<div class="outline-text-4" id="text-org7cbe46a">
<p>
Three types of unformatted I/O:
</p>
<ol class="org-ol">
<li>Character-at-a-time I/O.</li>
<li>Line-at-a-time I/O.</li>
<li>Direct I/O.</li>
</ol>
<p>
5.7 <b>**</b> DONE Input Functions
<code>man 3 getc</code>
</p>
<ol class="org-ol">
<li>The argument to getc should not be an expression with side effects, because it could be evaluated more than once.</li>
<li>Since fgetc is guaranteed to be a function, we can take its address. This allows us to pass the address of fgetc as an argument to another function.</li>
<li>Calls to fgetc probably take longer than calls to getc, as it usually takes more time to call a function.</li>
</ol>


<p>
In most implementations, two flags are maintained for each stream in the FILE object:
<code>man 3 ferror</code>
</p>
<ul class="org-ul">
<li>An error flag</li>
<li>An end-of file flagp</li>
</ul>


<p>
After reading from a stream, we can push back characters by calling <code>ungetc</code>.
5.8 <b>**</b> DONE Output Functions
<code>man 3 putc</code>
</p>
</div>
</div>
<div id="outline-container-orgdd17171" class="outline-4">
<h4 id="orgdd17171"><span class="done DONE">DONE</span> 5.9 Line-at-a-Time I/O</h4>
<div class="outline-text-4" id="text-orgdd17171">
<p>
<code>man fgets</code>
</p>
</div>
</div>
<div id="outline-container-orgc58a5a7" class="outline-4">
<h4 id="orgc58a5a7"><span class="done DONE">DONE</span> 5.10 Standard I/O Efficiency</h4>
<div class="outline-text-4" id="text-orgc58a5a7">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span>Figure 5.4 Copy standard input to output using getc and putc</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">c</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>c = getc<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != EOF<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>putc<span style="color: #67b11d;">(</span>c, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2aa198;">)</span>
            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"output error: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ferror<span style="color: #2aa198;">(</span>stdin<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"input error: %s"</span>, strerror<span style="color: #2aa198;">(</span>errno<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span>Figure 5.5 Copy standard input to output using fgets and fputs</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fgets<span style="color: #2aa198;">(</span>buf, MAXLINE, stdin<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fputs<span style="color: #2aa198;">(</span>buf, stdout<span style="color: #2aa198;">)</span> == EOF<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"output error"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ferror<span style="color: #2aa198;">(</span>stdin<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"input error: %s"</span>, strerror<span style="color: #2aa198;">(</span>errno<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8e26b13" class="outline-4">
<h4 id="org8e26b13"><span class="done DONE">DONE</span> 5.11 Binary I/O</h4>
<div class="outline-text-4" id="text-org8e26b13">
<p>
<code>man fread</code>
</p>
</div>
</div>
<div id="outline-container-org781cafc" class="outline-4">
<h4 id="org781cafc"><span class="done DONE">DONE</span> 5.12 Positioning a Stream</h4>
<div class="outline-text-4" id="text-org781cafc">
<p>
Three way to position a standard I/O stream:
</p>
<ol class="org-ol">
<li><code>ftell</code> and <code>fseek</code></li>
<li><code>ftello</code> and <code>fseeko</code></li>
<li><code>fgetpos</code> and <code>fsetpos</code></li>
</ol>


<p>
When porting applications to non-UNIX systems, use fgetpos and fsetpos.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span>
<span style="color: #d75fd7; font-weight: bold;">fgetpos</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">stream</span>, <span style="color: #df005f; font-weight: bold;">fpos_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">pos</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span>
<span style="color: #d75fd7; font-weight: bold;">fseek</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">stream</span>, <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">offset</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">whence</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span>
<span style="color: #d75fd7; font-weight: bold;">fseeko</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">stream</span>, <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">offset</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">whence</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span>
<span style="color: #d75fd7; font-weight: bold;">fsetpos</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">stream</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">fpos_t</span> *<span style="color: #8787d7;">pos</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">long</span>
<span style="color: #d75fd7; font-weight: bold;">ftell</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">stream</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">off_t</span>
<span style="color: #d75fd7; font-weight: bold;">ftello</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">stream</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">void</span>
<span style="color: #d75fd7; font-weight: bold;">rewind</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">stream</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org0c721f9" class="outline-4">
<h4 id="org0c721f9"><span class="done DONE">DONE</span> 5.13 Formated I/O</h4>
<div class="outline-text-4" id="text-org0c721f9">
<p>
<code>man 3 printf</code>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Figure 5.7 The flags component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flag</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">'</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">(apostrophe) format integer with thousands grouping characters</a></td>
</tr>

<tr>
<td class="org-left">-</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">left justify</a></td>
</tr>

<tr>
<td class="org-left">+</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">always display sign of a signed conversion</a></td>
</tr>

<tr>
<td class="org-left">(space)</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">prefix by a space if no sign is generated</a></td>
</tr>

<tr>
<td class="org-left">\#</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">convert using alternative form(include 0x prefix for hexadecimal format, for example)</a></td>
</tr>

<tr>
<td class="org-left">0</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">prefix with leading zeros instead of padding with spaces</a></td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Figure 5.8 The lenth modifier component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Length modifer</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">hh</td>
<td class="org-left">signed or unsigned char</td>
</tr>

<tr>
<td class="org-left">h</td>
<td class="org-left">sigend or unsigned short</td>
</tr>

<tr>
<td class="org-left">l</td>
<td class="org-left">signed or unsigned long or wide character</td>
</tr>

<tr>
<td class="org-left">ll</td>
<td class="org-left">signed or unsigned long long</td>
</tr>

<tr>
<td class="org-left">j</td>
<td class="org-left">inmax_t or uintmax_t</td>
</tr>

<tr>
<td class="org-left">z</td>
<td class="org-left">size_t</td>
</tr>

<tr>
<td class="org-left">t</td>
<td class="org-left">ptrdiff_t</td>
</tr>

<tr>
<td class="org-left">L</td>
<td class="org-left">long double</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Figure 5.9 The conversion type component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Conversion type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">d,i</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">signed decimal</a></td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned octal</a></td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned decimal</a></td>
</tr>

<tr>
<td class="org-left">x,X</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned hexadecimal</a></td>
</tr>

<tr>
<td class="org-left">f,F</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number</a></td>
</tr>

<tr>
<td class="org-left">e,E</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number in exponential format</a></td>
</tr>

<tr>
<td class="org-left">g,G</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">interpreted as f, F, e, or E, depending on value converted</a></td>
</tr>

<tr>
<td class="org-left">a,A</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number in hexadecimal exponential format</a></td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">character (with 1 length modifier, wide character)</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">string(with 1 length modifier, wide character string)</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">pointer to a void</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">pointer to a signed integer into which is written the number of characters written so far</td>
</tr>

<tr>
<td class="org-left">%</td>
<td class="org-left">a % character</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">wide chracter(XSI option, equivalent to lc)</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">wide chracter string(XSI option, equivalent to ls)</td>
</tr>
</tbody>
</table>


<p>
<b>Formatted Input</b>
<code>man 3 scanf</code>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Figure 5.9 The conversion type component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Conversion type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">d</td>
<td class="org-left">signed decimal, base 10</td>
</tr>

<tr>
<td class="org-left">i</td>
<td class="org-left">signed decimal, base determined by format of input</td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left">unsigned octal(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left">unsigned decimal, base 10(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">x,X</td>
<td class="org-left">unsigned hexadecimal(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">a,A,e,E,f,F,g,G</td>
<td class="org-left">floating-point number</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">character (with 1 length modifier, wide character)</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">string(with 1 length modifier, wide character string)</td>
</tr>

<tr>
<td class="org-left">[</td>
<td class="org-left">mathches a sequence of listed characters, ending with ]</td>
</tr>

<tr>
<td class="org-left">[^</td>
<td class="org-left">mathches all characters except the ones listed, ending with ]</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">pointer to a void</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">pointer to a signed integer into which is written the number of characters written so far</td>
</tr>

<tr>
<td class="org-left">%</td>
<td class="org-left">a % character</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">wide chracter(XSI option, equivalent to lc)</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">wide chracter string(XSI option, equivalent to ls)</td>
</tr>
</tbody>
</table>

<p>
<b>*</b>
</p>
</div>
</div>
<div id="outline-container-org3455d20" class="outline-4">
<h4 id="org3455d20"><span class="done DONE">DONE</span> 5.14 Implementation Details</h4>
<div class="outline-text-4" id="text-org3455d20">
<p>
<code>man 3 fileno</code>
</p>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 29: </span>Figure 5.11 Print buffering for various standard I/O streams</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_stdio</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *, <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #d75fd7; font-weight: bold;">is_unbuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #d75fd7; font-weight: bold;">is_linebuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #d75fd7; font-weight: bold;">buffer_size</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>;

    fputs<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"enter any character\n"</span>, stdout<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>getchar<span style="color: #2aa198;">()</span> == EOF<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"getchar: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    fputs<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"one line to standard error\n"</span>, stderr<span style="color: #d75fd7;">)</span>;

    pr_stdio<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"stdin"</span>, stdin<span style="color: #d75fd7;">)</span>;
    pr_stdio<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"stdout"</span>, stdout<span style="color: #d75fd7;">)</span>;
    pr_stdio<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"stderr"</span>, stderr<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = fopen<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"/etc/passwd"</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fopen: %s\n"</span>, strerror<span style="color: #2aa198;">(</span>errno<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>getc<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span> == EOF<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"getc: %s\n"</span>, strerror<span style="color: #2aa198;">(</span>errno<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_stdio</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"stream = %s, "</span>, name<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>is_unbuffered<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"unbuffered"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>is_linebuffered<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"line buffered"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">if neither or above */</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fully buffered"</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">", buffer size = %d\n"</span>, buffer_size<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;"> * The following is nonportable</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>_IO_UNBUFFERED<span style="color: #268bd2;">)</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">is_unbuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;flags &amp; _IO_UNBUFFERED<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">is_linebuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;flags &amp; _IO_LINE_BUF<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">buffer_size</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #d75fd7;">#elif</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>__SNBF<span style="color: #268bd2;">)</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">is_unbuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_flags &amp; __SNBF<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">is_linebuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_flags &amp; __SLBF<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">buffer_size</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_bf._size<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #d75fd7;">#elif</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>_IONBF<span style="color: #268bd2;">)</span>

<span style="color: #d75fd7;">#ifdef</span> _LP64
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">_flag</span> __pad<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">4</span><span style="color: #268bd2;">]</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">_ptr</span>  __pad<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">_base</span> __pad<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">2</span><span style="color: #268bd2;">]</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">is_unbuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_flag &amp; _IONBF<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">is_linebuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_flag &amp; _IOLBF<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">buffer_size</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
<span style="color: #d75fd7;">#ifdef</span> _LP64
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_base - fp-&gt;_ptr<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#else</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>BUFSIZ<span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">just a guess */</span>
<span style="color: #d75fd7;">#endif</span>
<span style="color: #268bd2;">}</span>

<span style="color: #d75fd7;">#else</span>

<span style="color: #d75fd7;">#error</span> <span style="color: #2aa198;">unknown stdio implementation;</span>

<span style="color: #d75fd7;">#endif</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org8f8b851" class="outline-4">
<h4 id="org8f8b851"><span class="done DONE">DONE</span> 5.15 Temporary Files</h4>
<div class="outline-text-4" id="text-org8f8b851">
<p>
<code>man 3 tmpnam</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 30: </span>Figure 5.12 Demonstrate tmpnam and tmpfile functions</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">name</span><span style="color: #d75fd7;">[</span>L_tmpnam<span style="color: #d75fd7;">]</span>, <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s\n"</span>, tmpnam<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">first temp name */</span>

    tmpnam<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">second temp name */</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s\n"</span>, name<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = tmpfile<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">create temp file */</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"tmpfile: %s\n"</span>, strerror<span style="color: #2aa198;">(</span>errno<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;

    fputs<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"one line of output\n"</span>, fp<span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">write to temp file */</span>
    rewind<span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fgets<span style="color: #2aa198;">(</span>line, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>, fp<span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fgets: %s\n"</span>, strerror<span style="color: #2aa198;">(</span>errno<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    fputs<span style="color: #d75fd7;">(</span>line, stdout<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>

<p>
<code>man 3 mkdtemp</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 31: </span>Figure 5.13 Demonstrate mkstemp function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">make_temp</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">template</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">good_template</span><span style="color: #d75fd7;">[]</span> = <span style="color: #2aa198;">"/tmp/dirXXXX"</span>;  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">right way */</span>
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">bad_template</span>    = <span style="color: #2aa198;">"/tmp/dir/</span><span style="color: #dc752f;">XXXX</span><span style="color: #2aa198;">"</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">bad way */</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"trying to create first temp file ...\n"</span><span style="color: #d75fd7;">)</span>;
    make_temp<span style="color: #d75fd7;">(</span>good_template<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"trying to create second temp file ...\n"</span><span style="color: #d75fd7;">)</span>;
    make_temp<span style="color: #d75fd7;">(</span>bad_template<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">make_temp</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">template</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">fd</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> <span style="color: #8787d7;">sbuf</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = mkstemp<span style="color: #67b11d;">(</span>template<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"create temp: %s\n"</span>, strerror<span style="color: #2aa198;">(</span>errno<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"temp name = %s\n"</span>, template<span style="color: #d75fd7;">)</span>;
    close<span style="color: #d75fd7;">(</span>fd<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>stat<span style="color: #2aa198;">(</span>template, &amp;sbuf<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"stat: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"file exists\n"</span><span style="color: #2aa198;">)</span>;
        unlink<span style="color: #2aa198;">(</span>template<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgcb8e55e" class="outline-4">
<h4 id="orgcb8e55e"><span class="done DONE">DONE</span> 5.16 Memory Streams</h4>
<div class="outline-text-4" id="text-orgcb8e55e">
<p>
<code>man 3 fmemopen</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 32: </span>Figure 5.15 Investigate memory stream write behavior</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">BSZ</span> <span style="color: #d75fd7;">48</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>BSZ<span style="color: #d75fd7;">]</span>;

    memset<span style="color: #d75fd7;">(</span>buf, <span style="color: #2aa198;">'a'</span>, BSZ - <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span>;
    buf<span style="color: #d75fd7;">[</span>BSZ - <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span> = <span style="color: #2aa198;">'\0'</span>;
    buf<span style="color: #d75fd7;">[</span>BSZ - <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">]</span> = <span style="color: #2aa198;">'X'</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = fmemopen<span style="color: #67b11d;">(</span>buf, BSZ, <span style="color: #2aa198;">"w+"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fmemopen failed"</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"initial buffer contents: %s\n"</span>, buf<span style="color: #d75fd7;">)</span>;
    fprintf<span style="color: #d75fd7;">(</span>fp, <span style="color: #2aa198;">"hello, world"</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"before flush: %s\n"</span>, buf<span style="color: #d75fd7;">)</span>;
    fflush<span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"after fflush: %s\n"</span>, buf<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"len of string in buf = %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>strlen<span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;

    memset<span style="color: #d75fd7;">(</span>buf, <span style="color: #2aa198;">'b'</span>, BSZ - <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span>;
    buf<span style="color: #d75fd7;">[</span>BSZ - <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span> = <span style="color: #2aa198;">'\0'</span>;
    buf<span style="color: #d75fd7;">[</span>BSZ - <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">]</span> = <span style="color: #2aa198;">'X'</span>;
    fprintf<span style="color: #d75fd7;">(</span>fp, <span style="color: #2aa198;">"hello, world"</span><span style="color: #d75fd7;">)</span>;
    fseek<span style="color: #d75fd7;">(</span>fp, <span style="color: #d75fd7;">0</span>, SEEK_SET<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"after fseek: %s\n"</span>, buf<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"len of string in buf = %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>strlen<span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    memset<span style="color: #d75fd7;">(</span>buf, <span style="color: #2aa198;">'c'</span>, BSZ - <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span>;
    buf<span style="color: #d75fd7;">[</span>BSZ - <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span> = <span style="color: #2aa198;">'\0'</span>;
    buf<span style="color: #d75fd7;">[</span>BSZ - <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">]</span> = <span style="color: #2aa198;">'X'</span>;
    fprintf<span style="color: #d75fd7;">(</span>fp, <span style="color: #2aa198;">"hello, world"</span><span style="color: #d75fd7;">)</span>;
    fclose<span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"after fclose: %s\n"</span>, buf<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"len of string in buf = %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>strlen<span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
<p>
<b>linux</b> result:
</p>
<blockquote>
<p>
initial buffer contents: <br />
before flush: <br />
after fflush: hello, world <br />
len of string in buf = 12 <br />
after fseek: hello, world <br />
len of string in buf = 24 <br />
after fclose: hello, world <br />
len of string in buf = 46
</p>
</blockquote>

<p>
The other two functions:
<code>man open_memstream</code>
</p>
</div>
</div>
<div id="outline-container-org4e081e5" class="outline-4">
<h4 id="org4e081e5"><span class="done DONE">DONE</span> 5.17 Alternatives to Standard I/O</h4>
<div class="outline-text-4" id="text-org4e081e5">
<p>
The standard I/O library is not perfect. some in the basic design, but most in the various implementations.
</p>
</div>
</div>
<div id="outline-container-org50d2294" class="outline-4">
<h4 id="org50d2294"><span class="done DONE">DONE</span> 5.18 Summary</h4>
<div class="outline-text-4" id="text-org50d2294">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
3.1
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">setbuf_</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">stream</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">buf</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>stream == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        setvbuf<span style="color: #2aa198;">(</span>stream, buf, _IONBF, BUFSIZ<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>isatty<span style="color: #2aa198;">(</span>fileno<span style="color: #67b11d;">(</span>stream<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        setvbuf<span style="color: #2aa198;">(</span>stream, buf, _IOLBF, BUFSIZ<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        setvbuf<span style="color: #2aa198;">(</span>stream, buf, _IOFBF, BUFSIZ<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">is_unbuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_flags &amp; __SNBF<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">is_linebuffered</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_flags &amp; __SLBF<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">buffer_size</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp-&gt;_bf._size<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_stdio</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"stream = %s, "</span>, name<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>is_unbuffered<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"unbuffered"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>is_linebuffered<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"line buffered"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">if neither or above */</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fully buffered"</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">", buffer size = %d\n"</span>, buffer_size<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>BUFSIZ<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc &lt; <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: ./a.out &lt;path&gt;"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    fp = fopen<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, <span style="color: #2aa198;">"r+"</span><span style="color: #d75fd7;">)</span>;
    pr_stdio<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, fp<span style="color: #d75fd7;">)</span>;
    setbuf_<span style="color: #d75fd7;">(</span>fp, buf<span style="color: #d75fd7;">)</span>;
    pr_stdio<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, fp<span style="color: #d75fd7;">)</span>;
    fclose<span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
3.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#ifdef</span> MAXLINE
<span style="color: #d75fd7;">#undef</span> MAXLINE
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MAXLINE</span> <span style="color: #d75fd7;">4</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">i</span> = <span style="color: #d75fd7;">0</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"MAXLINE: %d\n"</span>, MAXLINE<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fgets<span style="color: #2aa198;">(</span>buf, MAXLINE, stdin<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fputs<span style="color: #67b11d;">(</span>buf, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2aa198;">)</span> err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"output error"</span><span style="color: #2aa198;">)</span>;
        ++i;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">nums</span> = printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"loop_time: %d\n"</span>, i<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"nums: %d\n"</span>, nums<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ferror<span style="color: #2aa198;">(</span>stdin<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"input error: %s"</span>, strerror<span style="color: #2aa198;">(</span>errno<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<p>
execute <code>fgets</code> and <code>fputs</code> more than 1 times;
</p></li>
<li>3.3  print nothing</li>
<li>3.4  This is a common error. The return value from getc and getchar is an int, not a char. EOF is often defined to be −1, so if the system uses signed characters, the code normally works</li>
<li>3.5  call <code>fflush</code> first</li>
<li>3.6  stdin and stdout are both line buffered. fgets will fflush automatically</li>
<li><p>
3.7
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">string.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">memstream</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> * <span style="color: #8787d7;">buf</span>;    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">in-memory buffer */</span>
    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">rsize</span>;  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">real size of buffer */</span>
    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">vsize</span>;  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">virtual size of buffer */</span>
    <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">curpos</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">current position in buffer */</span>
    <span style="color: #df005f; font-weight: bold;">int</span>    <span style="color: #8787d7;">flags</span>;  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">see below */</span>
<span style="color: #268bd2;">}</span>;

<span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">flags */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MS_READ</span>    <span style="color: #d75fd7;">0x01</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">open for reading */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MS_WRITE</span>   <span style="color: #d75fd7;">0x02</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">open for writing */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MS_APPEND</span>  <span style="color: #d75fd7;">0x04</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">append to stream */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MS_TRUNCAT</span> <span style="color: #d75fd7;">0x08</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">truncate the stream on open */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MS_MYBUF</span>   <span style="color: #d75fd7;">0x10</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">free buffer on close */</span>

<span style="color: #d75fd7;">#if</span><span style="color: #d75fd7;">n</span><span style="color: #d75fd7;">def</span> MIN
<span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">MIN</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">a</span>, <span style="color: #8787d7;">b</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>a<span style="color: #d75fd7;">)</span> &lt; <span style="color: #d75fd7;">(</span>b<span style="color: #d75fd7;">)</span> ? <span style="color: #d75fd7;">(</span>a<span style="color: #d75fd7;">)</span> : <span style="color: #d75fd7;">(</span>b<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>    <span style="color: #d75fd7; font-weight: bold;">mstream_read</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *, <span style="color: #df005f; font-weight: bold;">char</span> *, <span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>    <span style="color: #d75fd7; font-weight: bold;">mstream_write</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *, <span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">fpos_t</span> <span style="color: #d75fd7; font-weight: bold;">mstream_seek</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *, <span style="color: #df005f; font-weight: bold;">fpos_t</span>, <span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>    <span style="color: #d75fd7; font-weight: bold;">mstream_close</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #268bd2;">)</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #d75fd7; font-weight: bold;">type_to_flags</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__restrict</span> type<span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #d75fd7; font-weight: bold;">find_end</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">buf</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">len</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #d75fd7; font-weight: bold;">fmemopen</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">__restrict</span> buf, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">size</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__restrict</span> type<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">memstream</span> *<span style="color: #8787d7;">ms</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *            <span style="color: #8787d7;">fp</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>size == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ms = malloc<span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">memstream</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = ENOMEM;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ms-&gt;flags = type_to_flags<span style="color: #67b11d;">(</span>type<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        free<span style="color: #2aa198;">(</span>ms<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>buf == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>ms-&gt;flags &amp; <span style="color: #875f00;">(</span>MS_READ | MS_WRITE<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #67b11d;">(</span>MS_READ | MS_WRITE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            errno = EINVAL;
            free<span style="color: #67b11d;">(</span>ms<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>ms-&gt;buf = malloc<span style="color: #875f00;">(</span>size<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            errno = ENOMEM;
            free<span style="color: #67b11d;">(</span>ms<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
        <span style="color: #2aa198;">}</span>
        ms-&gt;rsize = size;
        ms-&gt;flags |= MS_MYBUF;
        ms-&gt;curpos = <span style="color: #d75fd7;">0</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        ms-&gt;buf   = buf;
        ms-&gt;rsize = size;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ms-&gt;curpos = find_end<span style="color: #67b11d;">(</span>ms-&gt;buf, ms-&gt;rsize<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            ms-&gt;curpos = <span style="color: #d75fd7;">0</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        ms-&gt;vsize = ms-&gt;curpos;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ms-&gt;flags &amp; MS_TRUNCAT<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        ms-&gt;vsize = <span style="color: #d75fd7;">0</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        ms-&gt;vsize = size;
    <span style="color: #d75fd7;">}</span>

    fp = funopen<span style="color: #d75fd7;">(</span>ms, mstream_read, mstream_write, mstream_seek, mstream_close<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fp == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ms-&gt;flags &amp; MS_MYBUF<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            free<span style="color: #67b11d;">(</span>ms-&gt;buf<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> fp;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">type_to_flags</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__restrict</span> type<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cp</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">flags</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>cp = type; *cp != <span style="color: #d75fd7;">0</span>; cp++<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #2aa198;">(</span>*cp<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #2aa198;">'r'</span>:
                <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
                flags |= MS_READ;
                <span style="color: #268bd2; font-weight: bold;">break</span>;

            <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #2aa198;">'w'</span>:
                <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
                flags |= MS_WRITE | MS_TRUNCAT;
                <span style="color: #268bd2; font-weight: bold;">break</span>;

            <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #2aa198;">'a'</span>:
                <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
                flags |= MS_APPEND;
                <span style="color: #268bd2; font-weight: bold;">break</span>;

            <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #2aa198;">'+'</span>:
                <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
                flags |= MS_READ | MS_WRITE;
                <span style="color: #268bd2; font-weight: bold;">break</span>;

            <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #2aa198;">'b'</span>:
                <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;

            <span style="color: #268bd2; font-weight: bold;">default</span>:
                <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> flags;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #d75fd7; font-weight: bold;">find_end</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">buf</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">len</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">off</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>off &lt; len<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>buf<span style="color: #67b11d;">[</span>off<span style="color: #67b11d;">]</span> == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #268bd2; font-weight: bold;">break</span>;
        off++;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> off;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">mstream_read</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">cookie</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">buf</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">len</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>               <span style="color: #8787d7;">nr</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">memstream</span> *<span style="color: #8787d7;">ms</span> = cookie;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">!</span><span style="color: #2aa198;">(</span>ms-&gt;flags &amp; MS_READ<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EBADF;
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ms-&gt;curpos &gt;= ms-&gt;vsize<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
    <span style="color: #d75fd7;">}</span>

    nr = MIN<span style="color: #d75fd7;">(</span>len, ms-&gt;vsize - ms-&gt;curpos<span style="color: #d75fd7;">)</span>;
    memcpy<span style="color: #d75fd7;">(</span>buf, ms-&gt;buf + ms-&gt;curpos, nr<span style="color: #d75fd7;">)</span>;
    ms-&gt;curpos += nr;
    <span style="color: #268bd2; font-weight: bold;">return</span> nr;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">mstream_write</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">cookie</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">buf</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">len</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>               <span style="color: #8787d7;">nw</span>, <span style="color: #8787d7;">off</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">memstream</span> *<span style="color: #8787d7;">ms</span> = cookie;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">!</span><span style="color: #2aa198;">(</span>ms-&gt;flags &amp; <span style="color: #67b11d;">(</span>MS_APPEND | MS_WRITE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EBADF;
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        off = ms-&gt;vsize;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        off = ms-&gt;curpos;
    <span style="color: #d75fd7;">}</span>

    nw = MIN<span style="color: #d75fd7;">(</span>len, ms-&gt;rsize - off<span style="color: #d75fd7;">)</span>;
    memcpy<span style="color: #d75fd7;">(</span>ms-&gt;buf + off, buf, nw<span style="color: #d75fd7;">)</span>;
    ms-&gt;curpos = off + nw;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ms-&gt;curpos &gt; ms-&gt;vsize<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        ms-&gt;vsize = ms-&gt;curpos;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>ms-&gt;flags &amp; <span style="color: #268bd2;">(</span>MS_READ | MS_WRITE<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> == <span style="color: #875f00;">(</span>MS_READ | MS_WRITE<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &amp;&amp;
            ms-&gt;vsize &lt; ms-&gt;rsize<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;vsize<span style="color: #67b11d;">)</span> = <span style="color: #d75fd7;">0</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ms-&gt;flags &amp; <span style="color: #67b11d;">(</span>MS_WRITE | MS_APPEND<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &amp;&amp; <span style="color: #d75fd7;">!</span><span style="color: #2aa198;">(</span>ms-&gt;flags &amp; MS_READ<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ms-&gt;curpos &lt; ms-&gt;rsize<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;curpos<span style="color: #67b11d;">)</span> = <span style="color: #d75fd7;">0</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;rsize - <span style="color: #d75fd7;">1</span><span style="color: #67b11d;">)</span> = <span style="color: #d75fd7;">0</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> nw;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">fpos_t</span> <span style="color: #d75fd7; font-weight: bold;">mstream_seek</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">cookie</span>, <span style="color: #df005f; font-weight: bold;">fpos_t</span> <span style="color: #8787d7;">pos</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">whence</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>               <span style="color: #8787d7;">off</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">memstream</span> *<span style="color: #8787d7;">ms</span> = cookie;

    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #d75fd7;">(</span>whence<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">case</span> SEEK_SET:
            off = pos;
            <span style="color: #268bd2; font-weight: bold;">break</span>;

        <span style="color: #268bd2; font-weight: bold;">case</span> SEEK_END:
            off = ms-&gt;vsize + pos;
            <span style="color: #268bd2; font-weight: bold;">break</span>;

        <span style="color: #268bd2; font-weight: bold;">case</span> SEEK_CUR:
            off = ms-&gt;curpos + pos;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>off &lt; <span style="color: #d75fd7;">0</span> || off &gt; ms-&gt;vsize<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>
    ms-&gt;curpos = off;
    <span style="color: #268bd2; font-weight: bold;">return</span> off;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">mstream_close</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">cookie</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">memstream</span> *<span style="color: #8787d7;">ms</span> = cookie;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ms-&gt;flags &amp; MS_MYBUF<span style="color: #d75fd7;">)</span> free<span style="color: #d75fd7;">(</span>ms-&gt;buf<span style="color: #d75fd7;">)</span>;
    free<span style="color: #d75fd7;">(</span>ms<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org4fbe11f" class="outline-3">
<h3 id="org4fbe11f"><span class="done DONE">DONE</span> Chapter 6. System Data Files and Information <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org4fbe11f">
</div>
<div id="outline-container-org055138d" class="outline-4">
<h4 id="org055138d"><span class="done DONE">DONE</span> 6.1 introduction</h4>
</div>
<div id="outline-container-org79b35bb" class="outline-4">
<h4 id="org79b35bb"><span class="done DONE">DONE</span> 6.2 Password File</h4>
<div class="outline-text-4" id="text-org79b35bb">
<p>
<code>man getpwuid</code>
</p>
</div>
</div>
<div id="outline-container-org11c649c" class="outline-4">
<h4 id="org11c649c"><span class="done DONE">DONE</span> 6.3 Shadow Passwords</h4>
<div class="outline-text-4" id="text-org11c649c">
<p>
<b>On Linux 3.2.0 and Solaris 10,</b>
<code>man getspnam</code>
<b>On FreeBSD 8.0 and Mac OS X 10.6.8, there is no shadow password structure</b>
</p>
</div>
</div>
<div id="outline-container-org5d00721" class="outline-4">
<h4 id="org5d00721"><span class="done DONE">DONE</span> 6.4 Group File</h4>
<div class="outline-text-4" id="text-org5d00721">
<p>
<code>man getgrgid</code>
</p>
</div>
</div>
<div id="outline-container-org4212c73" class="outline-4">
<h4 id="org4212c73"><span class="done DONE">DONE</span> 6.5 Supplementary Group Ids</h4>
<div class="outline-text-4" id="text-org4212c73">
<p>
<code>man getgroups</code> <br />
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 33: </span>Example for get groups' info</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">grp.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">uuid/uuid.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>           <span style="color: #8787d7;">grpmax</span> = sysconf<span style="color: #d75fd7;">(</span>_SC_NGROUPS_MAX<span style="color: #d75fd7;">)</span>;
    <span style="color: #df005f; font-weight: bold;">gid_t</span>         <span style="color: #8787d7;">grouplist</span><span style="color: #d75fd7;">[</span>grpmax<span style="color: #d75fd7;">]</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">group</span> *<span style="color: #8787d7;">grp</span> = <span style="color: #d75fd7;">NULL</span>;

    getgroups<span style="color: #d75fd7;">(</span>grpmax, grouplist<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span> = <span style="color: #d75fd7;">0</span>; i &lt; grpmax; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        grp = getgrgid<span style="color: #2aa198;">(</span>grouplist<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%d\t%s\n"</span>, grouplist<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, grp-&gt;gr_name<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgfedf116" class="outline-4">
<h4 id="orgfedf116"><span class="done DONE">DONE</span> 6.6 Implementation Differences</h4>
</div>
<div id="outline-container-org46cc3ab" class="outline-4">
<h4 id="org46cc3ab"><span class="done DONE">DONE</span> 6.7 Other Data Files</h4>
<div class="outline-text-4" id="text-org46cc3ab">
<p>
at least three functions:
</p>
<ol class="org-ol">
<li>A get function that reads the next record, opening the file if necessary.</li>
<li>A set function that opens the file, if not already open, and rewinds the file.</li>
<li>An end entry that closes the data file.</li>
</ol>
</div>
</div>
<div id="outline-container-org215990d" class="outline-4">
<h4 id="org215990d"><span class="done DONE">DONE</span> 6.8 Login Accounting</h4>
<div class="outline-text-4" id="text-org215990d">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">utmp</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">ut_line</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">8</span><span style="color: #d75fd7;">]</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">tty line: "ttyh0", "ttyd0", "ttyp0", ... */</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">ut_name</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">8</span><span style="color: #d75fd7;">]</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">login name */</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">ut_time</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">seconds since Epoch */</span>
<span style="color: #268bd2;">}</span>;
</pre>
</div>

<p>
login: filled in and written to te utmp file, and appended to the wtmp file by the login program.
logout: utmp file was filled with null bytes by the init process, and a new entry was appended to the wtmp file.
</p>

<p>
<code>who</code> reads utmp file
<code>last</code> reads wtmp file
</p>
</div>
</div>
<div id="outline-container-org9f5fb36" class="outline-4">
<h4 id="org9f5fb36"><span class="done DONE">DONE</span> 6.9 System Identification</h4>
<div class="outline-text-4" id="text-org9f5fb36">
<p>
information on the current host and operating system.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/utsname.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">uname</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">utsname</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: non-negative value if OK, -1 on error</span>
</pre>
</div>

<p>
network hostname:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">gethostname</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">namelen</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6f2bb7d" class="outline-4">
<h4 id="org6f2bb7d"><span class="done DONE">DONE</span> 6.10 Time and Date Routines</h4>
<div class="outline-text-4" id="text-org6f2bb7d">
<p>
<code>man 3 time</code>
<code>man 3 clock_gettime</code>
<code>man 3 gmtime</code>
<code>man 3 strftime</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 34: </span>Figure 6.11 Using the strftime function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>     <span style="color: #8787d7;">t</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tm</span> *<span style="color: #8787d7;">tmp</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>       <span style="color: #8787d7;">buf1</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">16</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>       <span style="color: #8787d7;">buf2</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">64</span><span style="color: #d75fd7;">]</span>;

    time<span style="color: #d75fd7;">(</span>&amp;t<span style="color: #d75fd7;">)</span>;
    tmp = localtime<span style="color: #d75fd7;">(</span>&amp;t<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>strftime<span style="color: #2aa198;">(</span>buf1, <span style="color: #d75fd7;">16</span>, <span style="color: #2aa198;">"time and date: %r, %a %b %d, %Y"</span>, tmp<span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"buffer length 16 is too small\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s\n"</span>, buf1<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>strftime<span style="color: #2aa198;">(</span>buf2, <span style="color: #d75fd7;">64</span>, <span style="color: #2aa198;">"time and date: %r, %a %b %d, %Y"</span>, tmp<span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"buffer length 64 is too small\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s\n"</span>, buf2<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
<p>
<code>man 3 strptim</code>
</p>
</div>
</div>
<div id="outline-container-org5f3b49e" class="outline-4">
<h4 id="org5f3b49e"><span class="done DONE">DONE</span> 6.11 Summary</h4>
<div class="outline-text-4" id="text-org5f3b49e">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>6.1  On Mac OS, I can't get it <br />
On Linux, use <code>getsnam</code> group functions</li>
<li><p>
6.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">shadow.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">spwd</span> *<span style="color: #8787d7;">ptr</span>;

    ptr = getspent<span style="color: #d75fd7;">()</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"password: %s\n"</span>, ptr-&gt;sp_pwdp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
6.3
</p>
<div class="org-src-container">
<pre class="src src-c,">#include &lt;stdio.h&gt;
#include &lt;sys/utsname.h&gt;

int main() {
    struct utsname name;
    uname(&amp;name);
    printf("%s %s %s %s %s \n", name.sysname, name.nodename, name.release,
           name.version, name.machine);
}
</pre>
</div></li>
<li>6.4 32-bit time: <code>1970 + (2^{31}/60/60/24/365)</code> <br />
after pass : <code>1970 - (2^{31}/60/60/24/365)</code></li>
<li><p>
6.5
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span>   <span style="color: #8787d7;">tbuf</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">64</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">time_t</span> <span style="color: #8787d7;">t</span>;

    time<span style="color: #d75fd7;">(</span>&amp;t<span style="color: #d75fd7;">)</span>;

    strftime<span style="color: #d75fd7;">(</span>tbuf, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>tbuf<span style="color: #2aa198;">)</span>, <span style="color: #2aa198;">"%a %b %d %T %Z %Y"</span>, localtime<span style="color: #2aa198;">(</span>&amp;t<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s\n"</span>, tbuf<span style="color: #d75fd7;">)</span>;

    setenv<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"TZ"</span>, <span style="color: #2aa198;">"dkladjlkjklasdj"</span>, <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    strftime<span style="color: #d75fd7;">(</span>tbuf, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>tbuf<span style="color: #2aa198;">)</span>, <span style="color: #2aa198;">"%a %b %d %T %Z %Y"</span>, localtime<span style="color: #2aa198;">(</span>&amp;t<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s\n"</span>, tbuf<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org3cb16d8" class="outline-3">
<h3 id="org3cb16d8"><span class="done DONE">DONE</span> Chapter 7. Process Environment <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org3cb16d8">
</div>
<div id="outline-container-orgb176489" class="outline-4">
<h4 id="orgb176489"><span class="done DONE">DONE</span> 7.1 Introduction</h4>
</div>
<div id="outline-container-org2c99639" class="outline-4">
<h4 id="org2c99639"><span class="done DONE">DONE</span> 7.2 main Function</h4>
<div class="outline-text-4" id="text-org2c99639">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org2e84266" class="outline-4">
<h4 id="org2e84266"><span class="done DONE">DONE</span> 7.3 Process Termination</h4>
<div class="outline-text-4" id="text-org2e84266">
<p>
There are eight ways for a process to terminate.
Normal termination occurs in five ways:
</p>
<ol class="org-ol">
<li>Return from main</li>
<li>Calling <code>exit</code></li>
<li>Calling <code>_exit</code> or <code>_Exit</code></li>
<li>Return of the last thread from its start routine (Section 11.5)</li>
<li>Calling pthread_exit (Section 11.5) from the last thread</li>
</ol>


<p>
Abnormal termination occurs in three ways
</p>
<ol class="org-ol">
<li>Calling abort</li>
<li>Receipt of a signal</li>
<li>Response of the last thread to a cancellation request</li>
</ol>
</div>
<ul class="org-ul">
<li><a id="org5a344ce"></a><span class="done DONE">DONE</span> Exit Functions<br />
<div class="outline-text-5" id="text-org5a344ce">
<p>
<code>man 3 exit</code>
<code>man 2 _exit</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">exit</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">status</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">1. call the functions registered with atexit(3) function, in the reverse order of their registration</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">2. Flush all open output streams</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">3. close all open streams</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">4. unlink all files created with the tmpfile functions</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">_Exit</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">status</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">terminates without calling functions registered with atexit(3),</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">may or my not perform the other actions listed</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">_exit</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">status</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">The _exit() function terminates a process, with the following consequences:</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">o   All of the descriptors that were open in the calling process are closed.  This may entail delays; for example, waiting for output to drain.  A process in this state may not be</span>
<span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">killed, as it is already dying.</span>
<span style="color: #008787; background-color: #262626;">//</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">o   If the parent process of the calling process has an outstanding wait call or catches the SIGCHLD signal, it is notified of the calling process's termination; the status is set as</span>
<span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">defined by wait(2).</span>
<span style="color: #008787; background-color: #262626;">//</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">o   The parent process-ID of all of the calling process's existing child processes are set to 1; the initialization process (see the DEFINITIONS section of intro(2)) inherits each of</span>
<span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">these processes.</span>
<span style="color: #008787; background-color: #262626;">//</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">o   If the termination of the process causes any process group to become orphaned (usually because the parents of all members of the group have now exited; see ``orphaned process</span>
<span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">group'' in intro(2)), and if any member of the orphaned group is stopped, the SIGHUP signal and the SIGCONT signal are sent to all members of the newly-orphaned process group.</span>
<span style="color: #008787; background-color: #262626;">//</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">o   If the process is a controlling process (see intro(2)), the SIGHUP signal is sent to the foreground process group of the controlling terminal.  All current access to the control-</span>
<span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">ling terminal is revoked.</span>
</pre>
</div>
<p>
<code>_exit</code> does not perform any flushing of standard I/O buffers.
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<pre class="src src-c">
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 35: </span>Figure 7.1 Classic C program</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span>* <span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"hello world\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org630425d"></a><span class="done DONE">DONE</span> <code>atexit</code> Function<br />
<div class="outline-text-5" id="text-org630425d">
<p>
<code>man 3 atexit</code>
The <code>exit</code> function calls these functions in reverse order of their registration.
</p>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 36: </span>Figure 7.3 Example of exit handlers</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">my_exit1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">my_exit2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>atexit<span style="color: #2aa198;">(</span>my_exit2<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't register my_exit2: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>atexit<span style="color: #2aa198;">(</span>my_exit1<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't register my_exit1: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>atexit<span style="color: #2aa198;">(</span>my_exit1<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't register my_exit1: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"main is done\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">my_exit1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"first exit handler \n"</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">my_exit2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"second exit handler\n"</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org629b6c5"></a><span class="done DONE">DONE</span> Commond-Line Arguments<br />
<div class="outline-text-5" id="text-org629b6c5">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 37: </span>Figure 7.4 Echo all command-line arguments to standard output</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; argc; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">echo all command-line args */</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"argv[%d]: %s\n"</span>, i, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org76c84de" class="outline-4">
<h4 id="org76c84de"><span class="done DONE">DONE</span> 7.5 Environment List</h4>
<div class="outline-text-4" id="text-org76c84de">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">environ</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf669cae" class="outline-4">
<h4 id="orgf669cae"><span class="done DONE">DONE</span> 7.6 Memory Layout of a C Program</h4>
<div class="outline-text-4" id="text-orgf669cae">

<div class="figure">
<p><img src="Chapter07/07fig06.jpg" alt="07fig06.jpg" />
</p>
</div>



<p>
Historically, a C program has been composed of the following pieces:
</p>
<ul class="org-ul">
<li>Text segment: consisting of the machine instructions that the CPU executes.</li>
<li><p>
Initilized data segment, usually called simply the data segment, <br />
containing variables that are specifically initialized in the program.<br />
For example:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">maxcount</span>=<span style="color: #d75fd7;">99</span>;
</pre>
</div></li>
<li><p>
Uninitilized data segment, often called the “bss” segment, <br />
named after an ancient assembler operator that stood for “block started by symbol.”
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">sum</span><span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1024</span><span style="color: #268bd2;">]</span>;
</pre>
</div></li>
<li>Stack, where automatic variables are stored, <br />
along with information that is saved each time a function is called.</li>
<li><p>
Heap, where dynamic memory allocation usually takes place.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7; font-weight: bold;">malloc</span><span style="color: #268bd2;">()</span>;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orga49684d" class="outline-4">
<h4 id="orga49684d"><span class="done DONE">DONE</span> 7.7 Shared Libraries</h4>
<div class="outline-text-4" id="text-orga49684d">
<p>
without shared libraries
</p>
<div class="org-src-container">
<pre class="src src-bash">gcc -static hello.c
size a.out
text     data     bss     dec     hex filename
<span style="color: #d75fd7;">723103</span>     <span style="color: #d75fd7;">7284</span>    <span style="color: #d75fd7;">6392</span>  <span style="color: #d75fd7;">736779</span>   b3e0b a.out
</pre>
</div>
<p>
use shared libraries, the text and data size are greatly decreased
</p>
<div class="org-src-container">
<pre class="src src-bash">gcc hello.c
size a.out
text     data     bss     dec     hex filename
<span style="color: #d75fd7;">1173</span>      <span style="color: #d75fd7;">552</span>       <span style="color: #d75fd7;">8</span>    <span style="color: #d75fd7;">1733</span>     <span style="color: #d75fd7;">6c5</span> a.out
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbb62982" class="outline-4">
<h4 id="orgbb62982"><span class="done DONE">DONE</span> 7.8 Memory Allocation</h4>
<div class="outline-text-4" id="text-orgbb62982">
<p>
<code>man 3 malloc</code>
</p>
<ol class="org-ol">
<li><code>malloc</code>, allocates specified number of bytes of memory without initialized</li>
<li><code>calloc</code>, allocates specified number of bytes of memroy with initializing to 0</li>
<li><code>realloc</code>, increase or decrease the size of previous allocated area, the increased area was not initialized</li>
</ol>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">malloc</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">size</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">calloc</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">nobj</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">size</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">realloc</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">ptr</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">newsize</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">free</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #8787d7;">ptr</span><span style="color: #268bd2;">)</span>;
</pre>
</div>


<ul class="org-ul">
<li>Alternative Memory Allocators
<ul class="org-ul">
<li><code>jemalloc</code> <br />
designed to scale well when used with multithreaded applications running on multiprocessor systems.</li>
<li><code>TCMalloc</code> <br />
for high performance, scalability, and memory efficiency.</li>
<li><code>alloca</code> Function <br />
alloc memmory from stack, instaead of heap, so we don't have to free the space;</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org27ef0b9" class="outline-4">
<h4 id="org27ef0b9"><span class="done DONE">DONE</span> 7.9 Environment Variable</h4>
<div class="outline-text-4" id="text-org27ef0b9">
<p>
<code>man 3 getenv</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #d75fd7; font-weight: bold;">getenv</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">putenv</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">setenv</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">value</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">rewrite</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">unsetenv</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<p>
<b>malloc</b>
</p>
</div>
</div>

<div id="outline-container-orgbae14a7" class="outline-4">
<h4 id="orgbae14a7"><span class="done DONE">DONE</span> 7.10 <code>setjmp</code> and <code>longjmp</code> Functions</h4>
<div class="outline-text-4" id="text-orgbae14a7">
<ul class="org-ul">
<li><b>useful for dealing errors and interrupts</b></li>

<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 38: </span>Figure 7.9 Typical program skeleton for command-processing</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">TOK_ADD</span> <span style="color: #d75fd7;">5</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">do_line</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span>*<span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">cmd_add</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #d75fd7; font-weight: bold;">get_token</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fgets<span style="color: #2aa198;">(</span>line, MAXLINE, stdin<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        do_line<span style="color: #2aa198;">(</span>line<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">char</span>* <span style="color: #8787d7;">tok_ptr</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">global pointer for get_token() */</span>
<span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">tok</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">do_line</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span>* <span style="color: #8787d7;">ptr</span><span style="color: #268bd2;">)</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">process one line of input */</span>
<span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">cmd</span>;

    tok_ptr = ptr;
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>cmd = get_token<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #2aa198;">(</span>cmd<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">one case for each command */</span>
            <span style="color: #268bd2; font-weight: bold;">case</span> TOK_ADD:
                cmd_add<span style="color: #67b11d;">()</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">cmd_add</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">token</span>;

    token = get_token<span style="color: #d75fd7;">()</span>;
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">reset of processing for this command */</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">get_token</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">fetch next token from line pointed to by tok_ptr */</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> tok++;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>


<p>
<code>man 3 setjmp</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 39: </span>Figure 7.13 Effect of longjmp on various type of variables</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">setjmp.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">f1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span>, <span style="color: #df005f; font-weight: bold;">int</span>, <span style="color: #df005f; font-weight: bold;">int</span>, <span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">f2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">jmp_buf</span> <span style="color: #8787d7;">jmpbuffer</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>     <span style="color: #8787d7;">globval</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>          <span style="color: #8787d7;">autoval</span>;
    <span style="color: #268bd2; font-weight: bold;">register</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">regival</span>;
    <span style="color: #268bd2; font-weight: bold;">volatile</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">volaval</span>;
    <span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">statval</span>;

    globval = <span style="color: #d75fd7;">1</span>;
    autoval = <span style="color: #d75fd7;">2</span>;
    regival = <span style="color: #d75fd7;">3</span>;
    volaval = <span style="color: #d75fd7;">4</span>;
    statval = <span style="color: #d75fd7;">5</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>setjmp<span style="color: #2aa198;">(</span>jmpbuffer<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"after longjmp:\n"</span><span style="color: #2aa198;">)</span>;
        printf<span style="color: #2aa198;">(</span>
            <span style="color: #2aa198;">"globval = %d, autoval = %d, regival = %d,"</span>
            <span style="color: #2aa198;">" volaval = %d, statval = %d\n"</span>,
            globval, autoval, regival, volaval, statval<span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;">     * Change variables after setjmp, but before longjmp.</span>
<span style="color: #008787; background-color: #262626;">     */</span>
    globval = <span style="color: #d75fd7;">95</span>;
    autoval = <span style="color: #d75fd7;">96</span>;
    regival = <span style="color: #d75fd7;">97</span>;
    volaval = <span style="color: #d75fd7;">98</span>;
    statval = <span style="color: #d75fd7;">99</span>;

    f1<span style="color: #d75fd7;">(</span>autoval, regival, volaval, statval<span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">never returns */</span>
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">f1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">j</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">k</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">l</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"in                     f1():\n"</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span>
        <span style="color: #2aa198;">"globval = %d, autoval = %d, regival = %d,"</span>
        <span style="color: #2aa198;">" volaval = %d, statval = %d\n"</span>,
        globval, i, j, k, l<span style="color: #d75fd7;">)</span>;
    f2<span style="color: #d75fd7;">()</span>;
<span style="color: #268bd2;">}</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">f2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> longjmp<span style="color: #d75fd7;">(</span>jmpbuffer, <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><b>Automatic, Register and Volatile Variables</b> <br />
Most implementations do not try to roll back these automatic variables and register variables, but the standards say only that their values are indeterminate</li>
</ul>


<p>
<b>Potential Problem with Automatic Variables</b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 40: </span>Figure 7.14 Incorrect usage of an automatic variable</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     incorrect_usage.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-09-19</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Incorrect usage of an automatic variable</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">FILE</span>* <span style="color: #d75fd7; font-weight: bold;">open_data</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">FILE</span>* <span style="color: #8787d7;">fp</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">databuf</span><span style="color: #d75fd7;">[</span>BUFSIZ<span style="color: #d75fd7;">]</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">setvbuf makes this the stdio buffer */</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = fopen<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"datafile"</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>setvbuf<span style="color: #2aa198;">(</span>fp, databuf, _IOLBF, BUFSIZ<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> fp;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<blockquote>
<p>
The problem is that when open_data returns, the space it used on the stack will be used by the stack frame for the next function that is called. But the standard I/O library will still be using that portion of memory for its stream buffer. Chaos is sure to result. To correct this problem, the array databuf needs to be allocated from global memory, either statically (static or extern) or dynamically (one of the alloc functions)
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgc845721" class="outline-4">
<h4 id="orgc845721"><span class="done DONE">DONE</span> <code>getrlimit</code> and <code>setrlimit</code> Functions</h4>
<div class="outline-text-4" id="text-orgc845721">
<p>
<code>man 3 getrlimit</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 41: </span>Figure 7.16 print the current resource limits</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/resource.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">doit</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span> pr_limits<span style="color: #268bd2;">(</span>#name, name<span style="color: #268bd2;">)</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_limits</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *, <span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
<span style="color: #d75fd7;">#ifdef</span> RLIMIT_AS
    doit<span style="color: #d75fd7;">(</span>RLIMIT_AS<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

    doit<span style="color: #d75fd7;">(</span>RLIMIT_CORE<span style="color: #d75fd7;">)</span>;
    doit<span style="color: #d75fd7;">(</span>RLIMIT_CPU<span style="color: #d75fd7;">)</span>;
    doit<span style="color: #d75fd7;">(</span>RLIMIT_DATA<span style="color: #d75fd7;">)</span>;
    doit<span style="color: #d75fd7;">(</span>RLIMIT_FSIZE<span style="color: #d75fd7;">)</span>;

<span style="color: #d75fd7;">#ifdef</span> RLIMIT_MEMLOCK
    doit<span style="color: #d75fd7;">(</span>RLIMIT_MEMLOCK<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#ifdef</span> RLIMITS_MSGQUEUE
    doit<span style="color: #d75fd7;">(</span>RLIMITS_MSGQUEUE<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

    doit<span style="color: #d75fd7;">(</span>RLIMIT_NOFILE<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">rlimit</span> <span style="color: #8787d7;">r</span>;
    memset<span style="color: #d75fd7;">(</span>&amp;r, <span style="color: #d75fd7;">0</span>, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>r<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    getrlimit<span style="color: #d75fd7;">(</span>RLIMIT_NOFILE, &amp;r<span style="color: #d75fd7;">)</span>;
    r.rlim_cur = <span style="color: #d75fd7;">4096</span>;
    setrlimit<span style="color: #d75fd7;">(</span>RLIMIT_NOFILE, &amp;r<span style="color: #d75fd7;">)</span>;

    doit<span style="color: #d75fd7;">(</span>RLIMIT_NOFILE<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#ifdef</span> RLIMIT_NPTS
    doit<span style="color: #d75fd7;">(</span>RLIMIT_NPTS<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#ifdef</span> RLIMIT_RSS
    doit<span style="color: #d75fd7;">(</span>RLIMIT_RSS<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#ifdef</span> RLIMIT_SBSIZE
    doit<span style="color: #d75fd7;">(</span>RLIMIT_SBSIZE<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#ifdef</span> RLIMIT_SIGPENDING
    doit<span style="color: #d75fd7;">(</span>RLIMIT_SIGPENDING<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

    doit<span style="color: #d75fd7;">(</span>RLIMIT_STACK<span style="color: #d75fd7;">)</span>;

<span style="color: #d75fd7;">#ifdef</span> RLIMIT_SWAP
    doit<span style="color: #d75fd7;">(</span>RLIMIT_SWAP<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#ifdef</span> RLIMIT_VMEM
    doit<span style="color: #d75fd7;">(</span>RLIMIT_VMEM<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_limits</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">resource</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">rlimit</span>      <span style="color: #8787d7;">limit</span>;
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">lim</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>getrlimit<span style="color: #2aa198;">(</span>resource, &amp;limit<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"getrlimit error for %s"</span>, name<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%-14s "</span>, name<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>limit.rlim_cur == RLIM_INFINITY<span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"(infinite) "</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        lim = limit.rlim_cur;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%10lld "</span>, lim<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>limit.rlim_max == RLIM_INFINITY<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"(infinite)"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        lim = limit.rlim_max;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%10lld"</span>, lim<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    putchar<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">'\n'</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4486891" class="outline-4">
<h4 id="org4486891"><span class="done DONE">DONE</span> Summary</h4>
<div class="outline-text-4" id="text-org4486891">
<ul class="org-ul">
<li>Exercises
<ol class="org-ol">
<li>the length of "hello, world"</li>
<li><code>man 3 exit</code></li>
<li>Nope</li>
<li><b>for NULL usage</b></li>
<li><code>typedef void Exitfunc(void);</code> <br />
<code>int atexit(Exitfunc *func);</code></li>
<li>Yep, not sure</li>
<li>the heap and stack aren't allocated before applying</li>
<li>a.out include symbol info</li>
<li>standard I/O library was copied</li>
<li>Nope. num in heap</li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc36db4e" class="outline-3">
<h3 id="orgc36db4e"><span class="done DONE">DONE</span> Chapter 8. Process Control <code>[18/18]</code></h3>
<div class="outline-text-3" id="text-orgc36db4e">
</div>
<div id="outline-container-org7cf033a" class="outline-4">
<h4 id="org7cf033a"><span class="done DONE">DONE</span> 8.1 Introduction</h4>
</div>
<div id="outline-container-org752ce8e" class="outline-4">
<h4 id="org752ce8e"><span class="done DONE">DONE</span> 8.2 Process Identifiers</h4>
<div class="outline-text-4" id="text-org752ce8e">
<p>
Process ID 0 is usually the scheduler process and is often know as <i>swapper</i>.
Process ID 1 is usually the <b>init</b> process.
responsible for bring up a UNIX system after the kernel has been bootstrapped
Process ID 2 is pagedaemon.
responsible for supporting paging of virtual memory system.
</p>

<p>
<code>man 2 getpid</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span> pid_t getpid<span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: process ID of calling process</span>

<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">getppid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: parent process ID of calling process</span>

<span style="color: #df005f; font-weight: bold;">uid_t</span> <span style="color: #d75fd7; font-weight: bold;">getuid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: real user ID of calling process</span>

<span style="color: #df005f; font-weight: bold;">uid_t</span> <span style="color: #d75fd7; font-weight: bold;">geteuid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: effective user ID of calling process</span>

<span style="color: #df005f; font-weight: bold;">gid_t</span> <span style="color: #d75fd7; font-weight: bold;">getgid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: real group ID of calling process</span>

<span style="color: #df005f; font-weight: bold;">gid_t</span> <span style="color: #d75fd7; font-weight: bold;">getegid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: effective group ID of calling process</span>
</pre>
</div>

<blockquote>
<p>
Note that none of these functions has an error return.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgf17e3af" class="outline-4">
<h4 id="orgf17e3af"><span class="done DONE">DONE</span> 8.3 <code>fork</code> Function</h4>
<div class="outline-text-4" id="text-orgf17e3af">
<p>
<code>man 3 fork</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">fork</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 in child, process ID of child in parent, &#8722;1 on error</span>
</pre>
</div>


<blockquote>
<p>
called once but return twice.
</p>

<p>
return value in child is 0, whereas the return value in the parent is the process ID of the new child
</p>

<p>
the child gets a copy of the parent’s data space, heap, and stack, parents and child do not share memmory
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 42: </span>Figure 8.1 Example of fork function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">globvar</span> = <span style="color: #d75fd7;">6</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">external variable in initialized data */</span>
<span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #268bd2;">[]</span>   = <span style="color: #2aa198;">"a write to stdout\n"</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">var</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    var = <span style="color: #d75fd7;">88</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>write<span style="color: #2aa198;">(</span>STDOUT_FILENO, buf, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span> - <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> != <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span> - <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"before fork\n"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        globvar++; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child */</span>
        var++;     <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">modify variables */</span>
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span>, globvar, var<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
<p>
<b>changes to variables in a child process do not affect the value of the variables in the parent process.</b>
</p>
<ul class="org-ul">
<li>File Sharing
handling the descriptors after a fork.
<ol class="org-ol">
<li>The parent waits for the child to complete.</li>
<li>Both the parent and the child go their own ways. after fork, close needless descriptors(<b>socket</b>)</li>
</ol></li>
</ul>


<ul class="org-ul">
<li>inherits:
<ul class="org-ul">
<li>Real user ID, real group ID, effective user ID, and effective group ID</li>
<li>Supplementary group IDs</li>
<li>Process group ID</li>
<li>Session ID</li>
<li>Controlling terminal</li>
<li>The set-user-ID and set-group-ID flags</li>
<li>Current working directory</li>
<li>Root directory</li>
<li>File mode creation mask</li>
<li>Signal mask and dispositions</li>
<li>The close-on-exec flag for any open file descriptors</li>
<li>Environment</li>
<li>Attached shared memory segments</li>
<li>Memory mappings</li>
<li>Resource limits</li>
</ul></li>

<li>differences
<ul class="org-ul">
<li>return value</li>
<li>process id</li>
<li>parent id</li>
<li>child's tms_utime, tms_stime, tms_cutime, tms_cstime set to 0</li>
<li>parent's file locks are not inherited</li>
<li>pending alarms are cleared for the child</li>
<li>pending signals set is set to empty for child</li>
</ul></li>

<li><p>
There are two uses for fork:
</p>
<blockquote>
<ol class="org-ol">
<li>When a process wants to duplicate itself so that the parent and the child can each execute different sections of code at the same time.</li>
<li>When a process wants to execute a different program.</li>
</ol>
</blockquote></li>
</ul>
</div>
</div>
<div id="outline-container-orgb4ffdd3" class="outline-4">
<h4 id="orgb4ffdd3"><span class="done DONE">DONE</span> 8.4 <code>vfork</code> Function</h4>
<div class="outline-text-4" id="text-orgb4ffdd3">
<blockquote>
<p>
just like fork, without copying the address space of the parent into the child, as the child won’t reference that address space
</p>

<p>
the child runs in the address space of the parent until it calls either exec or exit.
</p>

<p>
<b>vfork guarantees that the child runs first, until the child calls exec or exit.</b>
</p>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 43: </span>Figure 8.3 Example of vfork function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">globvar</span> = <span style="color: #d75fd7;">6</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">external variable in initialized data */</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">var</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">automatic variable on the stack */</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    var = <span style="color: #d75fd7;">88</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"before vfork\n"</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">we don't flush stdio */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"vfork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child */</span>
        globvar++;         <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">modify parent's variables */</span>
        var++;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child terminaltes */</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent continues here */</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span>, globvar, var<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org1d4d04c" class="outline-4">
<h4 id="org1d4d04c"><span class="done DONE">DONE</span> 8.5 <code>exit</code> Function</h4>
<div class="outline-text-4" id="text-org1d4d04c">
<blockquote>
<p>
As we described in Section 7.3, a process can terminate normally in five ways:
</p>
<ol class="org-ol">
<li>Executing a return from the main function.</li>
<li>Calling the exit function.</li>
<li>Calling the _exit or _Exit function. <b>terminate without running exit handlers or signal handlers.</b></li>
<li>Executing a return from the start routine of the last thread in the process.</li>
<li>Calling the pthread_exit function from the last thread in the process.</li>
</ol>
</blockquote>

<blockquote>
<p>
The three forms of abnormal termination are as follows:
</p>
<ol class="org-ol">
<li>Calling abort. generates <b>SIGABRT</b> signal</li>
<li>When the process receives certain signals.</li>
<li>The last thread responds to a cancellation request.</li>
</ol>
</blockquote>

<blockquote>
<ul class="org-ul">
<li>In UNIX System terminology, a process that has terminated, but whose parent has not yet waited for it, is called a zombie.</li>

<li>The ps(1) command prints the state of a zombie process as Z.</li>
</ul>
</blockquote>
</div>
</div>
<div id="outline-container-org5450b88" class="outline-4">
<h4 id="org5450b88"><span class="done DONE">DONE</span> 8.6 <code>wait</code> and <code>waitpid</code> Functions</h4>
<div class="outline-text-4" id="text-org5450b88">
<blockquote>
<p>
we need to be aware that a process that calls wait or waitpid can
</p>
<ul class="org-ul">
<li>Block, if all of its children are still running</li>
<li>Return immediately with the termination status of a child, if a child has terminated and is waiting for its termination for its termination status to be fetched</li>
<li>Return immediately with an error, if it doesn't have any child processes</li>
</ul>
</blockquote>


<p>
<code>man 2 wait</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">wait</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #8787d7;">statloc</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">waitpid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>, <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #8787d7;">statloc</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">options</span><span style="color: #268bd2;">)</span>;

Both <span style="color: #268bd2; font-weight: bold;">return</span>: process ID <span style="color: #268bd2; font-weight: bold;">if</span> OK, <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">see</span> <span style="color: #8787d7;">later</span><span style="color: #268bd2;">)</span>, or -<span style="color: #d75fd7;">1</span> on error
</pre>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 44: </span>Figure 8.5 Print a description of the exit status</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_exit</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">status</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>WIFEXITED<span style="color: #2aa198;">(</span>status<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"normal termination, exit status = %d\n"</span>, WEXITSTATUS<span style="color: #2aa198;">(</span>status<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>WIFSIGNALED<span style="color: #2aa198;">(</span>status<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"abnormal termination, signal number = %d%s\n"</span>, WTERMSIG<span style="color: #2aa198;">(</span>status<span style="color: #2aa198;">)</span>,
<span style="color: #d75fd7;">#ifdef</span> WCOREDUMP
               WCOREDUMP<span style="color: #2aa198;">(</span>status<span style="color: #2aa198;">)</span> ? <span style="color: #2aa198;">" (core file generated)"</span> : <span style="color: #2aa198;">""</span><span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#else</span>
               <span style="color: #2aa198;">""</span><span style="color: #e0211d; text-decoration: overline;">)</span>;
<span style="color: #d75fd7;">#endif</span>
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>WIFSTOPPED<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>
        printf<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"child stopped, signal number = %d\n"</span>, WSTOPSIG<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>;
<span style="color: #e0211d; text-decoration: overline;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 45: </span>Figure 8.6 Demonstrate various exit status</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">status</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child */</span>
        exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">7</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>wait<span style="color: #2aa198;">(</span>&amp;status<span style="color: #2aa198;">)</span> != pid<span style="color: #d75fd7;">)</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">wait for child */</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"wait error"</span><span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        abort<span style="color: #d75fd7;">()</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>wait<span style="color: #2aa198;">(</span>&amp;status<span style="color: #2aa198;">)</span> != pid<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"wait error"</span><span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        status /= <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>wait<span style="color: #2aa198;">(</span>&amp;status<span style="color: #2aa198;">)</span> != pid<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"wait error"</span><span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<p>
The waitpid function provides three features that aren’t provided by the wait function.
</p>
<ol class="org-ol">
<li>The waitpid function lets us wait for one particular process, whereas the wait function returns the status of any terminated child.</li>
<li>The waitpid function provides a nonblocking version of wait.</li>
<li>The waitpid function provides support for job control with the WUNTRACED and WCONTINUED options.</li>
</ol>
</blockquote>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 46: </span>Figure 8.8 Avoid zombie processes by calling fork twice</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">first child */</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #875f00;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>pid &gt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>
            exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent from second fork == first child */</span>

        <span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;">         * We're the second child; our parent becomes init as soon as</span>
<span style="color: #008787; background-color: #262626;">         * our real parent calls exit() in the statement above.</span>
<span style="color: #008787; background-color: #262626;">         * Here's where we'd continue executing, knowing that when we're done,</span>
<span style="color: #008787; background-color: #262626;">         * init will reap our status.</span>
<span style="color: #008787; background-color: #262626;">         */</span>
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"second child, parent pid = %ld\n"</span>, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>waitpid<span style="color: #2aa198;">(</span>pid, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> != pid<span style="color: #d75fd7;">)</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">wait for first child */</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"waitpid error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;">     * We're the parent (the original process); we continue executing,</span>
<span style="color: #008787; background-color: #262626;">     * knowing that we're not the parent of the second child</span>
<span style="color: #008787; background-color: #262626;">     */</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org8cf537d" class="outline-4">
<h4 id="org8cf537d"><span class="done DONE">DONE</span> 8.7 <code>waitid</code> Function</h4>
<div class="outline-text-4" id="text-org8cf537d">
<p>
<code>man 2 waitid</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span> <span style="color: #df005f; font-weight: bold;">int</span> waitid<span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">idtype_t</span> <span style="color: #8787d7;">idtype</span>, <span style="color: #df005f; font-weight: bold;">id_t</span> <span style="color: #8787d7;">id</span>, <span style="color: #df005f; font-weight: bold;">siginfo_t</span> *<span style="color: #8787d7;">infop</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">options</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, &#8722;1 on error</span>
</pre>
</div>
<p>
(OS X can't get the info, but the function is valid)
</p>
</div>
</div>
<div id="outline-container-orgb52642c" class="outline-4">
<h4 id="orgb52642c"><span class="done DONE">DONE</span> 8.8 <code>wait3</code> and <code>wait4</code> Functions</h4>
<div class="outline-text-4" id="text-orgb52642c">
<p>
<code>man 2 wait3</code>
</p>
</div>
</div>
<div id="outline-container-org77b6700" class="outline-4">
<h4 id="org77b6700"><span class="done DONE">DONE</span> 8.9 Race Conditions</h4>
<div class="outline-text-4" id="text-org77b6700">
<p>
<b>Avoid race by signal</b>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 47: </span>Figure 8.12 Program with a race condition</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">charatatime</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork_ error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        charatatime<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"output from child\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        charatatime<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"output from parent\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">charatatime</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">ptr</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">c</span>;

    setbuf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">set unbuffered */</span>
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>ptr = str; <span style="color: #2aa198;">(</span>c = *ptr++<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span>;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">usleep(100);</span>
        putc<span style="color: #2aa198;">(</span>c, stdout<span style="color: #2aa198;">)</span>;
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">putchar(c);</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 48: </span>Figure 8.13 Modification of Figure 8.12 to avoid race condition</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">charatatime</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    TELL_WAIT<span style="color: #d75fd7;">()</span>;

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">1</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        WAIT_PARENT<span style="color: #2aa198;">()</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent goes first */</span>
        charatatime<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"output from child\n"</span><span style="color: #2aa198;">)</span>;
        TELL_PARENT<span style="color: #2aa198;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        charatatime<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"output from parent\n"</span><span style="color: #2aa198;">)</span>;
        TELL_CHILD<span style="color: #2aa198;">(</span>pid<span style="color: #2aa198;">)</span>;
        WAIT_CHILD<span style="color: #2aa198;">()</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #d75fd7;">#else</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        charatatime<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"output from child\n"</span><span style="color: #2aa198;">)</span>;
        TELL_PARENT<span style="color: #2aa198;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        WAIT_CHILD<span style="color: #2aa198;">()</span>;
        charatatime<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"output from parent\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #d75fd7;">#endif</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">charatatime</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">ptr</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">c</span>;

    setbuf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">set unbuffered */</span>
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>ptr = str; <span style="color: #2aa198;">(</span>c = *ptr++<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span>;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        usleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">100</span><span style="color: #2aa198;">)</span>;
        putc<span style="color: #2aa198;">(</span>c, stdout<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org9d39d87" class="outline-4">
<h4 id="org9d39d87"><span class="done DONE">DONE</span> 8.10 <code>exec</code> Functions</h4>
<div class="outline-text-4" id="text-org9d39d87">
<p>
<code>man 3 exec</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">execl</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pathname</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">arg0</span>, ... <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">(char *)0 */</span> <span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">execv</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pathname</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">execle</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pathname</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">arg0</span>, ...
           <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">(char *)0, char *const envp[] */</span> <span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">execve</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pathname</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #8787d7;">envp</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">execlp</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">filename</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">arg0</span>, ... <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">(char *)0 */</span> <span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">execvp</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">filename</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">fexecve</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #8787d7;">envp</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<p>
Returns: All seven return: −1 on error, no return on success
</p>


<blockquote>
<p>
The first difference in these functions is that the first four take a pathname argument, the next two take a filename argument, and the last one takes a file descriptor argument. When a filename argument is specified,
</p>
<ul class="org-ul">
<li>If filename contains a slash, it is taken as a pathname.</li>
<li>Otherwise, the executable file is searched for in the directories specified by the <b>PATH</b> environment variable.</li>
</ul>
</blockquote>


<p>
<code>execlp</code> and <code>execvp</code> assume <b>link</b> as a <b>shell script</b>, and try to invoke <code>/bin/sh</code> with <b>filename</b>
</p>


<blockquote>
<p>
The letter <b>p</b> means that the function takes a filename argument and uses the PATH environment variable to find the executable file
The letter <b>l</b> means that the function takes a list of arguments and is mutually exclusive
The letter <b>v</b>, means that it takes an argv[] vector.
Finally, the letter <b>e</b> means that the function takes an envp[] array instead of using the current environment.
</p>
</blockquote>



<div class="figure">
<p><img src="Chapter08/08fig14.jpg" alt="08fig14.jpg" />
</p>
<p><span class="figure-number">Figure 2: </span>Figure 8.14 Differences among the seven exec functions</p>
</div>


<div class="figure">
<p><img src="Chapter08/08fig15.jpg" alt="08fig15.jpg" />
</p>
<p><span class="figure-number">Figure 3: </span>Figure 8.15 Relationship of the seven exec functions</p>
</div>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 49: </span>Figure 8.16 Example of exec functions</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">env_init</span><span style="color: #268bd2;">[]</span> = <span style="color: #268bd2;">{</span><span style="color: #2aa198;">"USER=unknown"</span>, <span style="color: #2aa198;">"PATH=/tmp"</span>, <span style="color: #d75fd7;">NULL</span><span style="color: #268bd2;">}</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">specify pathname, specify environment */</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>execle<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"echo"</span>, <span style="color: #2aa198;">"echoall"</span>, <span style="color: #2aa198;">"myarg1"</span>, <span style="color: #2aa198;">"MY ARG2"</span>, <span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #875f00;">)</span><span style="color: #d75fd7;">0</span>,
                   env_init<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"execle error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>waitpid<span style="color: #2aa198;">(</span>pid, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"wait error"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">specify filename, inherit environment */</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>execlp<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"echo"</span>, <span style="color: #2aa198;">"echoall"</span>, <span style="color: #2aa198;">"only 1 arg"</span>, <span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #875f00;">)</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>
            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"execlp error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 50: </span>Figure 8.17 Echo all command-line arguments and all environment strings</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>           <span style="color: #8787d7;">i</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> **       <span style="color: #8787d7;">ptr</span>;
    <span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">environ</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; argc; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">"echo all command-line args" */</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"argv[%d]: %s\n"</span>, i, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>ptr = environ; *ptr != <span style="color: #d75fd7;">0</span>; ++ptr<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s\n"</span>, *ptr<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org8ad3713" class="outline-4">
<h4 id="org8ad3713"><span class="done DONE">DONE</span> 8.11 Changing User IDs and Group IDs</h4>
<div class="outline-text-4" id="text-org8ad3713">
<p>
<code>man 2 setuid</code>
</p>
<blockquote>
<ol class="org-ol">
<li>If the process has superuser privileges, the setuid function sets the real user ID, effective user ID, and saved set-user-ID to uid.</li>

<li>If the process does not have superuser privileges, but uid equals either the real user ID or the saved set-user-ID, setuid sets only the effective user ID to uid. The real user ID and the saved set-user-ID are not changed.</li>

<li>If neither of these two conditions is true, errno is set to EPERM and −1 is returned.</li>
</ol>
</blockquote>
<p>
<img src="Chapter08/08fig18.jpg" alt="08fig18.jpg" />
<code>man 2 setreuid</code>
<code>man 2 setregid</code>
</p>
</div>
</div>
<div id="outline-container-orged6c700" class="outline-4">
<h4 id="orged6c700"><span class="done DONE">DONE</span> 8.12 Interpreter Files</h4>
<div class="outline-text-4" id="text-orged6c700">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 51: </span>Figure 8.20 A program that execs an interpreter file</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>execlp<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"systype.sh"</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"execl error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>waitpid<span style="color: #2aa198;">(</span>pid, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"waitpid error"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 52: </span>Figure 8.21 An awk program as an interpreter file</label><pre class="src src-c">#<span style="color: #d75fd7;">!</span>/usr/bin/awk -f
<span style="color: #d75fd7;"># Note</span>: On Solaris, use <span style="color: #df005f; font-weight: bold;">nawk</span> <span style="color: #8787d7;">instead</span>

BEGIN <span style="color: #268bd2;">{</span>
  <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; ARGC; i ++<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    printf <span style="color: #2aa198;">"ARGV[%d] = %s\n"</span>, i, ARGV<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>
  <span style="color: #d75fd7;">}</span>
  exit
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgb2333b6" class="outline-4">
<h4 id="orgb2333b6"><span class="done DONE">DONE</span> 8.13 <code>system</code> Function</h4>
<div class="outline-text-4" id="text-orgb2333b6">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">system</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cmdstring</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<p>
*if <i>cmdstring</i> is a <code>NULL</code>, <code>system</code> returns nonzero only if a command processor is available.
</p>
<blockquote>
<ol class="org-ol">
<li>If either the fork fails or waitpid returns an error other than EINTR, system returns −1 with errno set to indicate the error.</li>

<li>If the exec fails, implying that the shell can’t be executed, the return value is as if the shell had executed exit(127).</li>

<li>Otherwise, all three functions—fork, exec, and waitpid—succeed, and the return value from system is the termination status of the shell, in the format specified for waitpid.</li>
</ol>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 53: </span>Figure 8.22 The system function, without signal handling</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">version without signal handling</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">system</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cmdstring</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">status</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>cmdstring == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">1</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">always a command processor with UNIX */</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        status = -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        execl<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/bin/sh"</span>, <span style="color: #2aa198;">"shell1"</span>, <span style="color: #2aa198;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
        _exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">27</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #d75fd7;">1</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> status;
<span style="color: #268bd2;">}</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">calling system function</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">status</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"date"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #d75fd7;">)</span>;

    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"nosuchcommand"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"who; exit 44"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 54: </span>Figure 8.23 Calling the system function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">version without signal handling</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">system</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cmdstring</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">status</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>cmdstring == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">1</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">always a command processor with UNIX */</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        status = -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        execl<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/bin/sh"</span>, <span style="color: #2aa198;">"shell1"</span>, <span style="color: #2aa198;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
        _exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">27</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #d75fd7;">1</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> status;
<span style="color: #268bd2;">}</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">calling system function</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">status</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"date"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #d75fd7;">)</span>;

    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"nosuchcommand"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"who; exit 44"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<p>
The advantage in using system, instead of using fork and exec directly, is that system does all the required error handling and (in our next version of this function in Section 10.18) all the required signal handling.
</p>
</blockquote>



<p>
<b>Set-User-ID Programs</b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 55: </span>Figure 8.24 Execute the command-line argument using system</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">status</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc &lt; <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> err_quit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"command-line argument required"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>status = system<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 56: </span>Figure 8.25 Print real and effective user IDs</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"real uid = %d, effective uid = %d\n"</span>, getuid<span style="color: #2aa198;">()</span>, geteuid<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org11b330c" class="outline-4">
<h4 id="org11b330c"><span class="done DONE">DONE</span> 8.14 Process Accounting</h4>
<div class="outline-text-4" id="text-org11b330c">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 57: </span>Figure 8.28 Program to generate accounting data</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">4</span><span style="color: #2aa198;">)</span>;
        abort<span style="color: #2aa198;">()</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        execl<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/bin/dd"</span>, <span style="color: #2aa198;">"dd"</span>, <span style="color: #2aa198;">"if=/etc/passwd"</span>, <span style="color: #2aa198;">"of=/dev/null"</span>, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">7</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">8</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    sleep<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">6</span><span style="color: #d75fd7;">)</span>;
    kill<span style="color: #d75fd7;">(</span>getpid<span style="color: #2aa198;">()</span>, SIGKILL<span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">6</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 58: </span>Figure 8.29 Print select fields from system's accounting file</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">ctype.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/acct.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/types.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>BSD<span style="color: #268bd2;">)</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">different structure in FreeBSD */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">acct</span>    acctv2
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">ac_flag</span> ac_trailer.ac_flag
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">FMT</span>     <span style="color: #2aa198;">"%-*.*s e = %.0f, chars = %.0f, %c %c %c %c\n"</span>
<span style="color: #d75fd7;">#elif</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>HAS_AC_STAT<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">FMT</span> <span style="color: #2aa198;">"%-*.*s e = %6ld, chars = %7ld, stat = %3u: %c %c %c %c\n"</span>
<span style="color: #d75fd7;">#else</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">FMT</span> <span style="color: #2aa198;">"%-*.*s e = %6ld, chars = %7ld, %c %c %c %c\n"</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>LINUX<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">acct</span> acct_v3 <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">different structure in Linux */</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">!</span><span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>ACORE<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">ACORE</span> <span style="color: #d75fd7;">0</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">!</span><span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>AXSIG<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">AXSIG</span> <span style="color: #d75fd7;">0</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">!</span><span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>BSD<span style="color: #268bd2;">)</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #d75fd7; font-weight: bold;">compt2ulong</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">comp_t</span> <span style="color: #8787d7;">comptime</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">convert comp_t to unsigned long */</span>
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">val</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>           <span style="color: #8787d7;">exp</span>;

    val = comptime &amp; <span style="color: #d75fd7;">0x1fff</span>;    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">13-bit fraction  */</span>
    exp = <span style="color: #d75fd7;">(</span>comptime &gt;&gt; <span style="color: #d75fd7;">13</span><span style="color: #d75fd7;">)</span> &amp; <span style="color: #d75fd7;">7</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">3-bit exponent(0-7)  */</span>
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>exp-- &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> val *= <span style="color: #d75fd7;">8</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> val;
<span style="color: #268bd2;">}</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[</span>argc<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">acct</span> <span style="color: #8787d7;">acdata</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *      <span style="color: #8787d7;">fp</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> err_quit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"usage pracct filename"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"can't open %s"</span>, argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fread<span style="color: #2aa198;">(</span>&amp;acdata, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>acdata<span style="color: #67b11d;">)</span>, <span style="color: #d75fd7;">1</span>, fp<span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span>FMT, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #67b11d;">)</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>acdata.ac_comm<span style="color: #67b11d;">)</span>, acdata.ac_comm,
<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #67b11d;">(</span>BSD<span style="color: #67b11d;">)</span>
               acdata.ac_etime, acdata.ac_io,
<span style="color: #d75fd7;">#else</span>
               compt2ulong<span style="color: #67b11d;">(</span>acdata.ac_etime<span style="color: #67b11d;">)</span>, compt2ulong<span style="color: #67b11d;">(</span>acdata.ac_io<span style="color: #67b11d;">)</span>,
<span style="color: #d75fd7;">#endif</span>
<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #67b11d;">(</span>HAS_AC_STAT<span style="color: #67b11d;">)</span>
               <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span><span style="color: #67b11d;">)</span>acdata.ac_stat,
<span style="color: #d75fd7;">#endif</span>
               acdata.ac_flag &amp; ACORE ? <span style="color: #2aa198;">'D'</span> : <span style="color: #2aa198;">' '</span>,
               acdata.ac_flag &amp; AXSIG ? <span style="color: #2aa198;">'X'</span> : <span style="color: #2aa198;">' '</span>,
               acdata.ac_flag &amp; AFORK ? <span style="color: #2aa198;">'F'</span> : <span style="color: #2aa198;">' '</span>,
               acdata.ac_flag &amp; ASU ? <span style="color: #2aa198;">'S'</span> : <span style="color: #2aa198;">' '</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org0850ff0" class="outline-4">
<h4 id="org0850ff0"><span class="done DONE">DONE</span> 8.15 User Identification</h4>
<div class="outline-text-4" id="text-org0850ff0">
<p>
<code>man 2 getlogin</code>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 59: </span>getlogin</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s\n"</span>, getlogin<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3bdf437" class="outline-4">
<h4 id="org3bdf437"><span class="done DONE">DONE</span> 8.16 Process Scheduling</h4>
<div class="outline-text-4" id="text-org3bdf437">
<p>
Lower nice values have higher scheduling priority.
</p>

<p>
<code>man 3 nice</code>
<code>man 3 getpriority</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 60: </span>Figure 8.30 Evaluate the effect of changing the nice value</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>__APPLE__<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/syslimits.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#elif</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>SOLARIS<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#elif</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>BSD<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/param.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">count</span>;
<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span>     <span style="color: #8787d7;">end</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">checktime</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">tv</span>;

    gettimeofday<span style="color: #d75fd7;">(</span>&amp;tv, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>tv.tv_sec &gt;= end.tv_sec &amp;&amp; tv.tv_usec &gt;= end.tv_usec<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s count = %lld\n"</span>, str, count<span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">s</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">nzero</span>, <span style="color: #8787d7;">ret</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">adj</span> = <span style="color: #d75fd7;">0</span>;

    setbuf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #d75fd7;">(</span>NZERO<span style="color: #d75fd7;">)</span>
    nzero = NZERO;
<span style="color: #d75fd7;">#elif</span> <span style="color: #d75fd7;">defined</span><span style="color: #d75fd7;">(</span>_SC_NZERO<span style="color: #d75fd7;">)</span>
    nzero = sysconf<span style="color: #d75fd7;">(</span>_SC_NZERO<span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#else</span>
<span style="color: #d75fd7;">#error</span> <span style="color: #2aa198;">NZERO undefined</span>
<span style="color: #d75fd7;">#endif</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"NZERO = %d\n"</span>, nzero<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc == <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> adj = strtol<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">10</span><span style="color: #d75fd7;">)</span>;
    gettimeofday<span style="color: #d75fd7;">(</span>&amp;end, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    end.tv_sec += <span style="color: #d75fd7;">10</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">run for 10 seconds */</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork failed"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child */</span>
        s = <span style="color: #2aa198;">"child"</span>;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"current nice value in child is %d adjusting by %d\n"</span>,
               nice<span style="color: #67b11d;">(</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> + nzero, adj<span style="color: #2aa198;">)</span>;
        errno = <span style="color: #d75fd7;">0</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>ret = nice<span style="color: #875f00;">(</span>adj<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #d75fd7;">1</span> &amp;&amp; errno != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child set scheduling priority"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"now child nice value is %d\n"</span>, ret + nzero<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent */</span>
        s = <span style="color: #2aa198;">"parent"</span>;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"current nice value in parent is %d\n"</span>, nice<span style="color: #67b11d;">(</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> + nzero<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>++count == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_quit<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"%s counter wrap"</span>, s<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        checktime<span style="color: #2aa198;">(</span>s<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org231e432" class="outline-4">
<h4 id="org231e432"><span class="done DONE">DONE</span> 8.17 Process Times</h4>
<div class="outline-text-4" id="text-org231e432">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/times.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">clock_t</span> <span style="color: #d75fd7; font-weight: bold;">times</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tms</span> *<span style="color: #8787d7;">buf</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: elapsed wall clock time in clock ticks if OK, -1 on error</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 61: </span>Figure 8.31 Time and execute all command-line arguments</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/times.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_times</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">clock_t</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tms</span> *, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tms</span> *<span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">do_cmd</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span>;
    setbuf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">1</span>; i &lt; argc; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        do_cmd<span style="color: #2aa198;">(</span>argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">do_cmd</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cmd</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tms</span> <span style="color: #8787d7;">tmsstart</span>, <span style="color: #8787d7;">tmsend</span>;
    <span style="color: #df005f; font-weight: bold;">clock_t</span>    <span style="color: #8787d7;">start</span>, <span style="color: #8787d7;">end</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>        <span style="color: #8787d7;">status</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\ncommand: %s\n"</span>, cmd<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>start = times<span style="color: #67b11d;">(</span>&amp;tmsstart<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"times error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>status = system<span style="color: #67b11d;">(</span>cmd<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>end = times<span style="color: #67b11d;">(</span>&amp;tmsend<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"times error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    pr_times<span style="color: #d75fd7;">(</span>end - start, &amp;tmsstart, &amp;tmsend<span style="color: #d75fd7;">)</span>;
    pr_exit<span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_times</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">clock_t</span> <span style="color: #8787d7;">real</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tms</span> *<span style="color: #8787d7;">tmsstart</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tms</span> *<span style="color: #8787d7;">tmsend</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">clktck</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>clktck == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>clktck = sysconf<span style="color: #875f00;">(</span>_SC_CLK_TCK<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"sysconf error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"  real:         %7.2f\n"</span>, real / <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">double</span><span style="color: #2aa198;">)</span>clktck<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"  user:         %7.2f\n"</span>,
           <span style="color: #2aa198;">(</span>tmsend-&gt;tms_utime - tmsstart-&gt;tms_utime<span style="color: #2aa198;">)</span> / <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">double</span><span style="color: #2aa198;">)</span>clktck<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"  sys:          %7.2f\n"</span>,
           <span style="color: #2aa198;">(</span>tmsend-&gt;tms_stime - tmsstart-&gt;tms_stime<span style="color: #2aa198;">)</span> / <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">double</span><span style="color: #2aa198;">)</span>clktck<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"  child user:   %7.2f\n"</span>,
           <span style="color: #2aa198;">(</span>tmsend-&gt;tms_cutime - tmsstart-&gt;tms_cutime<span style="color: #2aa198;">)</span> / <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">double</span><span style="color: #2aa198;">)</span>clktck<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"  child sys:    %7.2f\n"</span>,
           <span style="color: #2aa198;">(</span>tmsend-&gt;tms_cstime - tmsstart-&gt;tms_cstime<span style="color: #2aa198;">)</span> / <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">double</span><span style="color: #2aa198;">)</span>clktck<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbcc9d3a" class="outline-4">
<h4 id="orgbcc9d3a"><span class="done DONE">DONE</span> 8.18 Summary</h4>
<div class="outline-text-4" id="text-orgbcc9d3a">
<p>
functions to master: <code>fork</code>, <code>exec</code> family, <code>_exit</code>, <code>wait</code> and <code>waitpid</code>.
</p>

<p>
<code>fork</code> function gave us an opportunity to look at race conditions.
</p>

<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 62: </span>8.1</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">globvar</span> = <span style="color: #d75fd7;">6</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">external variable in initialized data */</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">var</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">automatic variable on the stack */</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    var = <span style="color: #d75fd7;">88</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"before vfork\n"</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">we don't flush stdio */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"vfork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child */</span>
        globvar++;         <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">modify parent's variables */</span>
        var++;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child terminaltes */</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent continues here */</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span>, globvar, var<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 63: </span>8.2</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">f1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>, <span style="color: #d75fd7; font-weight: bold;">f2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    f1<span style="color: #d75fd7;">()</span>;

    f2<span style="color: #d75fd7;">()</span>;

    _exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">f1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"vfork error"</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child and parent both return */</span>
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">f2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">100</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">i</span>;

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">automatic variables */</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span>; i++<span style="color: #d75fd7;">)</span> buf<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span> = <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 64: </span>8.3</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">globvar</span> = <span style="color: #d75fd7;">6</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">external variable in initialized data */</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">var</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">automatic variable on the stack */</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    var = <span style="color: #d75fd7;">88</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"before vfork\n"</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">we don't flush stdio */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"vfork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child */</span>
        globvar++;         <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">modify parent's variables */</span>
        var++;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child terminaltes */</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent continues here */</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span>, globvar, var<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>8.4</li>
</ul></li>
</ul>
<p>
In Figure 8.13, we have the parent write its output first. When the parent is done, the child writes its output, but we let the parent terminate. Whether the parent terminates or whether the child finishes its output first depends on the kernel’s scheduling of the two processes (another race condition). When the parent terminates, the shell starts up the next program, and this next program can interfere with the output from the previous child.
We can prevent this from happening by not letting the parent terminate until the child has also finished its output. Replace the code following the fork with the following:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>pid ~~ <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    WAIT_PARENT<span style="color: #d75fd7;">()</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent goes first */</span>
    charatatime<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"output from child\n"</span><span style="color: #d75fd7;">)</span>;
    TELL_PARENT<span style="color: #d75fd7;">(</span>getppid<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">tell parent we&#8217;re done */</span>
<span style="color: #268bd2;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2;">{</span>
    charatatime<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"output from parent\n"</span><span style="color: #d75fd7;">)</span>;
    TELL_CHILD<span style="color: #d75fd7;">(</span>pid<span style="color: #d75fd7;">)</span>;
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">tell child we&#8217;re done */</span>
    WAIT_CHILD<span style="color: #d75fd7;">()</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">wait for child to finish */</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
<p>
We won’t see this happen if we let the child go first, since the shell doesn’t start the next program until the parent terminates.
</p>
<ul class="org-ul">
<li>8.5 The same value</li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 65: </span>8.6</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    sleep<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">4</span><span style="color: #d75fd7;">)</span>;

    system<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"ps -o pid,ppid,state,tty,command"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org280714c" class="outline-3">
<h3 id="org280714c"><span class="done DONE">DONE</span> Chapter 9. Process Relationships <code>[12/12]</code></h3>
<div class="outline-text-3" id="text-org280714c">
</div>
<div id="outline-container-org994e973" class="outline-4">
<h4 id="org994e973"><span class="done DONE">DONE</span> 9.1 Introduction</h4>
</div>
<div id="outline-container-orge9b6c29" class="outline-4">
<h4 id="orge9b6c29"><span class="done DONE">DONE</span> 9.2 Terminal Logins</h4>
<div class="outline-text-4" id="text-orge9b6c29">
<ul class="org-ul">
<li><p>
BSD Terminal Logins
</p>

<div class="figure">
<p><a href="Chapter09/9fig1.jpg"><img src="Chapter09/09fig01.jpg" alt="09fig01.jpg" /></a>
</p>
<p><span class="figure-number">Figure 4: </span>Figure 9.1 Processes invoked by init to allow terminal logins</p>
</div>
<blockquote>
<p>
a real user ID of 0 and an effective user ID of 0
</p>
</blockquote>

<p>
<code>login</code> program similar to
</p>
<div class="org-src-container">
<pre class="src src-c">execle<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"/bin/login"</span>, <span style="color: #2aa198;">"login"</span>, <span style="color: #2aa198;">"-p"</span>, username, <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #d75fd7;">)</span><span style="color: #d75fd7;">0</span>, envp<span style="color: #268bd2;">)</span>;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org2f31f89" class="outline-4">
<h4 id="org2f31f89"><span class="done DONE">DONE</span> 9.3 Network Logins</h4>
<div class="outline-text-4" id="text-org2f31f89">
<blockquote>
<p>
The main (physical) difference between logging in to a system through a serial terminal and logging ni to a system through a network is that the connection between the terminal and the computer isn't point-to-point.
</p>

<p>
To allow the same software to process logins over both terminal logins and network logins, a software driver called a pseudo terminal is used to emulate the behavior of a serial terminal and map terminal operations to network operations, and vice versa.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org5d68865" class="outline-4">
<h4 id="org5d68865"><span class="done DONE">DONE</span> 9.4 Process Groups</h4>
<div class="outline-text-4" id="text-org5d68865">
<div class="org-src-container">
<pre class="src src-c" id="orgb5a21ff"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">getpgrp</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: process group ID of calling process</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-c" id="orgb3a6a7e"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">getpgid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: process group ID if OK, -1 on error</span>
</pre>
</div>

<p>
<code>getpgid(0) == getpgrp()</code>
</p>

<div class="org-src-container">
<pre class="src src-c" id="orga6fffb4"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">setpgid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">ipd_t</span> <span style="color: #8787d7;">pid</span>, <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pgid</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
<p>
if <i>pid == pgid</i>, the pid becomes a process group leader
if <i>pid == 0</i>, the process ID of the caller is used.
if <i>pgid == 0</i>, the process ID specified by pid is used as process group ID
</p>
</div>
</div>

<div id="outline-container-org54c4902" class="outline-4">
<h4 id="org54c4902"><span class="done DONE">DONE</span> 9.5 Sessions</h4>
<div class="outline-text-4" id="text-org54c4902">
<blockquote>
<p>
A session is a collection of one or more process groups.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c" id="org5c4968a"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">setsid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: process group ID if OK, -1 on error</span>
</pre>
</div>
<ol class="org-ol">
<li>The process becomes the <i>session leader</i> of this new session. (A session leader is the process that creates a session)</li>
<li>The process becomes the process group leader of a new process group.</li>
<li>The process has no controlling terminal.</li>
</ol>


<div class="org-src-container">
<pre class="src src-c" id="org0565813"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">getsid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: session leader's process group ID if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgccfc4a7" class="outline-4">
<h4 id="orgccfc4a7"><span class="done DONE">DONE</span> 9.6 Controlling Terminal</h4>
<div class="outline-text-4" id="text-orgccfc4a7">
<p>
Sessions and progress groups have a few other characteristics
</p>
<ul class="org-ul">
<li>A session can have a single <i>controlling terminal</i>.</li>
<li>The session leader that establishes the connection to the controlling terminal</li>
<li>The process groups within a session can be divided into a single <i>foreground process group</i> and one or more <i>background proces groups</i></li>
<li>If a session has a controlling terminal, it has a single foreground process group and all other process groups in the session are background process groups</li>
<li>Whenever we press the terminal's interrupt key(often DELETE or Control-C), the interrupt signal is sent to all processes in the foreground process group.</li>
<li>Whenever we press the terminal's quit key(Often Control-backslash), the quit signal is sent to all processes in the foreground process group.</li>
<li>If a modem(or network) disconnect is detected by the terminal interface, the hang-up signal is sent to the controlling process (the session leader).</li>
</ul>
</div>
</div>

<div id="outline-container-org9a4b604" class="outline-4">
<h4 id="org9a4b604"><span class="done DONE">DONE</span> 9.7 <code>tcgetpgrp</code>, <code>tcsetpgrp</code>, and <code>tcgetsid</code> Functions</h4>
<div class="outline-text-4" id="text-org9a4b604">
<div class="org-src-container">
<pre class="src src-c" id="orge09e7bd"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">tcgetpgrp</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: process group ID of foreground process group if OK, -1 on error</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">tcsetpgrp</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pgrpid</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c" id="orgf17726d"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">termios.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">tcgetsid</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: session leader's process group ID if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ba546b" class="outline-4">
<h4 id="org5ba546b"><span class="done DONE">DONE</span> 9.8 Job Control</h4>
<div class="outline-text-4" id="text-org5ba546b">
<p>
Requirements:
</p>
<ol class="org-ol">
<li>A shell that supports job control</li>
<li>The terminal driver in the kernel must support job control</li>
<li>The kernel must support certain job-control signals</li>
</ol>


<div class="org-src-container">
<pre class="src src-sh">cat &gt; temp.foo &amp; <span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">&amp; let start in background</span>
<span style="color: #268bd2;">fg</span> % <span style="color: #d75fd7;">1</span> <span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">% bring job number into the foreground</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">stty tostop <span style="color: #008787; background-color: #262626;"># </span><span style="color: #008787; background-color: #262626;">disable ability of background to output to controlling terminal</span>
</pre>
</div>


<p>
generate signals to the foreground process group:
</p>
<ol class="org-ol">
<li>The interrupt character (typically DELETE or Control-C) generates SIGINT.</li>
<li>The quit character (typically Control-backslash) generates SIGQUIT.</li>
<li>The suspend character (typically Control-Z) generates SIGTSTP.</li>
</ol>


<div class="figure">
<p><img src="Chapter09/09fig09.jpg" alt="09fig09.jpg" />
</p>
<p><span class="figure-number">Figure 5: </span>Figure 9.9 Summary of job control features with foreground and background jobs, and terminal driver</p>
</div>
</div>
</div>
<div id="outline-container-orgadd3033" class="outline-4">
<h4 id="orgadd3033"><span class="done DONE">DONE</span> 9.9 Shell Execution Programs</h4>
<div class="outline-text-4" id="text-orgadd3033">
<div class="org-src-container">
<pre class="src src-sh">ps -o pid,ppid,pgid,comm
</pre>
</div>



<div class="figure">
<p><img src="Chapter09/09fig10.jpg" alt="09fig10.jpg" />
</p>
<p><span class="figure-number">Figure 6: </span>Figure 9.10 Processes in the pipeline as <code>ps | cat1 | cat2 when invoked by bash</code></p>
</div>
</div>
</div>

<div id="outline-container-org5781c40" class="outline-4">
<h4 id="org5781c40"><span class="done DONE">DONE</span> 9.10 Orphaned Process Groups</h4>
<div class="outline-text-4" id="text-org5781c40">

<div class="figure">
<p><img src="Chapter09/09fig11.jpg" alt="09fig11.jpg" />
</p>
<p><span class="figure-number">Figure 7: </span>Figure 9.11 Example of a process group about to be orphaned</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 66: </span>Figure 9.12 Creating an orphaned process group</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     09fig12.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-09</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Creating an orphaned process group</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_hup</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIGHUP received, pid = %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_ids</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s: pid = %ld, ppid = %ld, pgrp = %ld, tpgrp = %ld\n"</span>, name,
           <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getppid<span style="color: #2aa198;">()</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpgrp<span style="color: #2aa198;">()</span>,
           <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>tcgetpgrp<span style="color: #2aa198;">(</span>STDIN_FILENO<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    fflush<span style="color: #d75fd7;">(</span>stdout<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">c</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    pr_ids<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"parent"</span><span style="color: #d75fd7;">)</span>;
    pid = fork<span style="color: #d75fd7;">()</span>;
    <span style="color: #268bd2; font-weight: bold;">switch</span><span style="color: #d75fd7;">(</span>pid<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    <span style="color: #268bd2; font-weight: bold;">case</span> -<span style="color: #d75fd7;">1</span>:
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #d75fd7;">0</span>:
        pr_ids<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"child"</span><span style="color: #2aa198;">)</span>;
        signal<span style="color: #2aa198;">(</span>SIGHUP, sig_hup<span style="color: #2aa198;">)</span>;
        kill<span style="color: #2aa198;">(</span>getpid<span style="color: #67b11d;">()</span>, SIGTSTP<span style="color: #2aa198;">)</span>;
        pr_ids<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"child"</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>read<span style="color: #67b11d;">(</span>STDIN_FILENO, &amp;c, <span style="color: #d75fd7;">1</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"read error %d on controlling TTY\n"</span>, errno<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

    <span style="color: #268bd2; font-weight: bold;">default</span>:
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">5</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<blockquote>
<p>
After the fork
</p>
<ul class="org-ul">
<li>The parent sleeps for 5 seconds.</li>
<li>The child establishes a signal handler for the hang-up signal(SIGHUP) so we can see whether it is sent to the child.</li>
<li>The child sends itself to stop signal(SIGTSTP) with the kill function.</li>
<li>When the parent terminates, the child is orphaned, so the child's parent process ID becomes 1, which is the init process ID.</li>
<li>At this point, the child is now a member of an <i>orphaned process group</i>.</li>
<li>Since the process group is orphaned when the parent terminates, and the process group contains a stopped process, <b>POSIX.1 requires that every process in the newly orphaned process group be sent the hang-up signal(SIGHUP) followed by the continue signal(SIGCONT)</b></li>
<li>This causes the child to be continued, after processing the hang-up signal.</li>
</ul>
</blockquote>
</div>
</div>

<div id="outline-container-orgf8a1d31" class="outline-4">
<h4 id="orgf8a1d31"><span class="done DONE">DONE</span> 9.11 FreeBSD Implementation</h4>
<div class="outline-text-4" id="text-orgf8a1d31">

<div class="figure">
<p><img src="Chapter09/09fig13.jpg" alt="09fig13.jpg" />
</p>
<p><span class="figure-number">Figure 8: </span>Figure 9.13 Free BSD implementation of sessions and process groups</p>
</div>

<blockquote>
<p>
<b>session structure</b>
</p>
<ul class="org-ul">
<li><code>s_count</code>: the number of the process groups in the session.</li>
<li><code>s_leader</code>: a pointer to the proc structure of the session leader</li>
<li><code>s_ttyvp</code>: a pointer to the vnode structure of the controlling terminal</li>
<li><code>s_ttyp</code>: a pointer to the tty structure of the controlling terminal</li>
<li><code>s_sid</code>: the session ID.</li>
</ul>


<p>
<b>tty structure</b>
</p>
<ul class="org-ul">
<li><code>t_session</code>: points to the session structure that has this terminal as its controlling terminal.</li>
<li><code>t_pgrp</code>: points to the pgrp structure of the foreground process group.</li>
<li><code>t_termios</code>: is a structure containing all the special characters and related information for this terminal.</li>
<li><code>t_winsize</code>: is a winsize structure that contains the current size of the terminal window.</li>
</ul>


<p>
<b>pgrp structure</b>
</p>
<ul class="org-ul">
<li><code>pg_id</code>: the process group ID</li>
<li><code>pg_session</code>: points to the session structure to the session leader</li>
<li><code>pg_members</code>: a pointer to the list of members' proc structures</li>
</ul>


<p>
<b>proc structure</b>
</p>
<ul class="org-ul">
<li><code>p_pid</code>: contains the process ID</li>
<li><code>p_pptr</code>: a pointer to the proc structure of the parent process.</li>
<li><code>p_pgrp</code>: a pointer to the pgrp structure of the process group to which it belongs to</li>
<li><code>p_pglist</code>: a structure containing pointers to the next and previous process in the process group.</li>
</ul>


<p>
<b>vnode structure</b> : allocated when the controlling terminal device is opened.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org8cb2deb" class="outline-4">
<h4 id="org8cb2deb"><span class="done DONE">DONE</span> 9.12 Summary</h4>
<div class="outline-text-4" id="text-org8cb2deb">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
9.1
</p>
<blockquote>
<p>
The init process learns when a terminal user logs out, because init is the parent of the login shell and receives the SIGCHLD signal when the login shell terminates.
</p>

<p>
For a network login, however, init is not involved. Instead, the login entries in the utmp and wtmp files, and their corresponding logout entries, are usually written by the process that handles the login and detects the logout (telnetd in our example).
</p>
</blockquote></li>

<li><p>
9.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex9.2.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-14</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Exercises 9.2</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  Write a small program that calls fork and has the child create a new</span>
<span style="color: #008787; background-color: #262626;"> * session. Verify that the child becomes a process group leader and that the</span>
<span style="color: #008787; background-color: #262626;"> * child no longer has a controlling terminal.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span>  = <span style="color: #d75fd7;">0</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span> = <span style="color: #d75fd7;">0</span>;

    TELL_WAIT<span style="color: #d75fd7;">()</span>;

    pid = fork<span style="color: #d75fd7;">()</span>;
    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #d75fd7;">(</span>pid<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">case</span> -<span style="color: #d75fd7;">1</span>:
            err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #d75fd7;">0</span>:
            WAIT_PARENT<span style="color: #2aa198;">()</span>;

            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"getsid in child before setsid: %lu\n"</span>,
                   <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getsid<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
            setsid<span style="color: #2aa198;">()</span>;
            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"getsid in child after setsid : %lu\n"</span>,
                   <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getsid<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;

            fd = open<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/dev/tty"</span>, O_RDONLY<span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
                printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child get tty failed: %s\n"</span>, strerror<span style="color: #875f00;">(</span>errno<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
                printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child get tty success\n"</span><span style="color: #67b11d;">)</span>;
                close<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span>;
            <span style="color: #2aa198;">}</span>

            TELL_PARENT<span style="color: #2aa198;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span>;
            exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">default</span>:
            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"getsid in parent before child setsid: %lu\n"</span>,
                   <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getsid<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
            TELL_CHILD<span style="color: #2aa198;">(</span>pid<span style="color: #2aa198;">)</span>;
            WAIT_CHILD<span style="color: #2aa198;">()</span>;

            fd = open<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/dev/tty"</span>, O_RDONLY<span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
                printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"parent get tty failed: %s\n"</span>, strerror<span style="color: #875f00;">(</span>errno<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
                printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"parent get tty success\n"</span><span style="color: #67b11d;">)</span>;
                close<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span>;
            <span style="color: #2aa198;">}</span>

            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"getsid in parent after child setsid: %lu\n"</span>,
                   <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getsid<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;

            exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org399fcc6" class="outline-3">
<h3 id="org399fcc6"><span class="done DONE">DONE</span> Chapter 10. Signals <code>[23/23]</code></h3>
<div class="outline-text-3" id="text-org399fcc6">
</div>
<div id="outline-container-org23c97af" class="outline-4">
<h4 id="org23c97af"><span class="done DONE">DONE</span> 10.1 Introduction</h4>
<div class="outline-text-4" id="text-org23c97af">
<blockquote>
<p>
Signals provide a way of handling asynchronous events
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org580735b" class="outline-4">
<h4 id="org580735b"><span class="done DONE">DONE</span> 10.2 Signal Concepts</h4>
<div class="outline-text-4" id="text-org580735b">
<p>
<code>&lt;signal.h&gt;</code>
conditions can generate a signal
</p>
<ul class="org-ul">
<li>terminal generated when users press certain terminal keys.</li>
<li>hardware exceptions</li>
<li>function <code>kill</code> (man 2 kill)</li>
<li>command <code>kill</code> (man 1 kill)</li>
<li>software conditions : <code>SIGURG</code> <code>SIGPIPE</code> <code>SIGALARM</code></li>
</ul>


<p>
deal with signals via one of things below:
</p>
<ul class="org-ul">
<li>ignore</li>
<li>catch</li>
<li>use defaut action apply</li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Figure 10.1 UNIX System signals</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Default Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SIGABRT</td>
<td class="org-left">abnormal termination(abort)</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGALARM</td>
<td class="org-left">timer expired(alarm)</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGBUS</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGCHLD</td>
<td class="org-left">change in the status of child</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGCONT</td>
<td class="org-left">continue stopped process</td>
<td class="org-left">continue/ignore</td>
</tr>

<tr>
<td class="org-left">SIGEMT</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGFPE</td>
<td class="org-left">arithmetic exception</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGFREEZE</td>
<td class="org-left">checkpoint freeze</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGHUP</td>
<td class="org-left">hangup</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGILL</td>
<td class="org-left">illegal instruction</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGINFO</td>
<td class="org-left">status request from keyboard</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGINT</td>
<td class="org-left">terminal interrupt character</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGIO</td>
<td class="org-left">asynchronous I/O</td>
<td class="org-left">terminate/ignore</td>
</tr>

<tr>
<td class="org-left">SIGIOT</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGKILL</td>
<td class="org-left">termination : <b>can't be caught or ignored</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPIPE</td>
<td class="org-left">write to pipe with no readers</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPOLL</td>
<td class="org-left">pollable event(poll): <b>might be removed</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPROF</td>
<td class="org-left">profiling time alarm(setitimer):  <b>might be removed</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPWR</td>
<td class="org-left">power fail/restart</td>
<td class="org-left">terminate/ignore</td>
</tr>

<tr>
<td class="org-left">SIGQUIT</td>
<td class="org-left">terminal quit character</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGSEGV</td>
<td class="org-left">invalid memory reference</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGSTKFLT</td>
<td class="org-left">coprocessor stack fault</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGSTOP</td>
<td class="org-left">stop: <b>can't be caught or ignored</b></td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGSYS</td>
<td class="org-left">invalid system call</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGTERM</td>
<td class="org-left">termination</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGTHAW</td>
<td class="org-left">checkpoint thaw</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGTHR</td>
<td class="org-left">threads library internal use</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGTRAP</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGTSTP</td>
<td class="org-left">terminal stop character</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGTTIN</td>
<td class="org-left">background read from control tty</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGTTOU</td>
<td class="org-left">background write to control tty</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGURG</td>
<td class="org-left">urgent condition(sockets)</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGUSR1</td>
<td class="org-left">user-defined signal</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGUSR2</td>
<td class="org-left">user-defined signal</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGVTALRM</td>
<td class="org-left">virtual time alarm(setitimer)</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGWAITING</td>
<td class="org-left">threads library internal use</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGWINCH</td>
<td class="org-left">terminal window size change</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGXCPU</td>
<td class="org-left">CPU limit exceeded (setrlimit)</td>
<td class="org-left">terminate or terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGXFSZ</td>
<td class="org-left">file size limit exceeded(setrlimit0)</td>
<td class="org-left">terminate or terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGXRES</td>
<td class="org-left">resource control exceeded</td>
<td class="org-left">ignore</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
The core file will not be generated if
</p>
<ol class="org-ol">
<li>the process was set-user-ID and the current user is not the owner of the program file</li>
<li>the process was set-group-ID and the current user is not the group owner of the file</li>
<li>the user does not have permission to write in the current working directory</li>
<li>the file already exists and the user does not have permission to write it</li>
<li>the file is too big (recall the RLIMIT_CORE)</li>
</ol>

<p>
The permission of the core file are usually <code>rw</code>, although Mac OSX sets only <code>r</code>
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org9f02130" class="outline-4">
<h4 id="org9f02130"><span class="done DONE">DONE</span> 10.3 <code>signal</code> Function</h4>
<div class="outline-text-4" id="text-org9f02130">
<div class="org-src-container">
<pre class="src src-sh">man signal
</pre>
</div>

<ul class="org-ul">
<li>Example: <br /></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 67: </span>Figure 10.2 Simple program to catch SIGUSR1 and SIGUSR2</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_usr</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>; <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">one handler for both signals */</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGUSR1, sig_usr<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"can't catch SIGUSR1"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGUSR2, sig_usr<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"can't catch SIGUSR2"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> pause<span style="color: #d75fd7;">()</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_usr</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signo == SIGUSR1<span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"received SIGUSR1\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signo == SIGUSR2<span style="color: #d75fd7;">)</span>
        printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"received SIGUSR2\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span>
        err_dump<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"received signal %d\n"</span>, signo<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<blockquote>
<p>
FreeBSD 8.0 and Mac OS X 10.6.8 don’t exhibit this problem, because BSD - based systems generally don’t support historical System V semantics for SIGCLD. Linux 3.2.0 also doesn’t exhibit this problem, because it doesn’t call the SIGCHLD signal handler when a process arranges to catch SIGCHLD and child processes are ready to be waited for, even though SIGCLD and SIGCHLD are defined to be the same value.
</p>
</blockquote>

<ul class="org-ul">
<li>Program Start-Up
we are not able to determine the current disposition of a signal without changing the disposition</li>
</ul>
</div>
</div>
<div id="outline-container-org4bd23ae" class="outline-4">
<h4 id="org4bd23ae"><span class="done DONE">DONE</span> 10.4 Unreliable Signals</h4>
<div class="outline-text-4" id="text-org4bd23ae">
<p>
In ealier versions of the UNIX system :
</p>
<ul class="org-ul">
<li>signals could get lost</li>
<li>the process was unable to turn a signal off when it didn’t want the signal to occur</li>
</ul>
</div>
</div>
<div id="outline-container-org6ea79fa" class="outline-4">
<h4 id="org6ea79fa"><span class="done DONE">DONE</span> 10.5 Interrupted System Calls</h4>
<div class="outline-text-4" id="text-org6ea79fa">
<ul class="org-ul">
<li>automatically restarted functions: <code>ioctl</code>, <code>read</code>, <code>readv</code>, <code>write</code>, <code>writev</code>, <code>wait</code>, <code>waitpid</code> <br />
POSIX.1 requires an implementation to restart system calls only when the SA_RESTART flag is in effect for the interrupting signal.</li>
</ul>
</div>
</div>
<div id="outline-container-orga5fc21b" class="outline-4">
<h4 id="orga5fc21b"><span class="done DONE">DONE</span> 10.6 Reentrant Functions</h4>
<div class="outline-text-4" id="text-orga5fc21b">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 68: </span>Figure 10.5 Call a nonreentrant function from a signal handler</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pwd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">my_alarm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">passwd</span> *<span style="color: #8787d7;">rootptr</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"in signal hander\n"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>rootptr = getpwnam<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"hello"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"getpwnam(root) error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">passwd</span> *<span style="color: #8787d7;">ptr</span>;
    signal<span style="color: #d75fd7;">(</span>SIGALRM, my_alarm<span style="color: #d75fd7;">)</span>;
    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">usleep(500);                  // it seems alarm cannot interrupt sleep</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">function</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>ptr = getpwnam<span style="color: #875f00;">(</span><span style="color: #2aa198;">"zhoush"</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"getpwnam error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>strcmp<span style="color: #67b11d;">(</span>ptr-&gt;pw_name, <span style="color: #2aa198;">"zhoush"</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"return value corrupted!, pw_name = %s\n"</span>, ptr-&gt;pw_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6be964c" class="outline-4">
<h4 id="org6be964c"><span class="done DONE">DONE</span> 10.7 <code>SIGCLD</code> Semantics</h4>
<div class="outline-text-4" id="text-org6be964c">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 69: </span>Figure 10.6 System V SIGCLD handler that doesn't work</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_cld</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #d75fd7;">(</span>__linux__<span style="color: #d75fd7;">)</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGCLD, sig_cld<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        perror<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"signal error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

<span style="color: #d75fd7;">#endif</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        perror<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
        _exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    pause<span style="color: #d75fd7;">()</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_cld</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">interrupts pause()</span>

    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">status</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIGCLD received\n"</span><span style="color: #d75fd7;">)</span>;

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #d75fd7;">(</span>__linux__<span style="color: #d75fd7;">)</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGCLD, sig_cld<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        perror<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"signal erro"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #d75fd7;">#endif</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = wait<span style="color: #67b11d;">(</span>&amp;status<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        perror<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"wait error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"pid = %d\n"</span>, pid<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga32f4ab" class="outline-4">
<h4 id="orga32f4ab"><span class="done DONE">DONE</span> 10.8 Reliable-Signal Terminology and Semantics</h4>
<div class="outline-text-4" id="text-orga32f4ab">
<blockquote>
<p>
If the system delivers the signal more than once, we say that the signals are queued. <br />
<b>Most UNIX systems do <i>not</i> queue signals unless they support the real-time extensions to POSIX.1.</b> <br />
POSIX.1 <b>does not specify the order</b> in which the signals are delivered to the process more than once.
</p>
</blockquote>

<ul class="org-ul">
<li><i>signal mask</i>: a set of signals currently blocked from delivery to the process (<b>on</b> is blocked)</li>
<li><i><code>sigprocmask</code></i>: examine and change its current signal mask</li>
</ul>
</div>
</div>
<div id="outline-container-org99a71a2" class="outline-4">
<h4 id="org99a71a2"><span class="done DONE">DONE</span> 10.9 <code>kill</code> and <code>raise</code> Functions</h4>
<div class="outline-text-4" id="text-org99a71a2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">kill</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">raise</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>

<p>
<code>raise(signo);</code> is equivalent to <code>kill(getpid(), signo);</code>
</p>
</div>
</div>

<div id="outline-container-org69b8fb4" class="outline-4">
<h4 id="org69b8fb4"><span class="done DONE">DONE</span> 10.10 <code>alarm</code> and <code>pause</code> Functions</h4>
<div class="outline-text-4" id="text-org69b8fb4">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">alarm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">seconds</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 or number of seconds until previously set alarm</span>
</pre>
</div>

<blockquote>
<p>

</p>

<p>
There is only one of these alarm clocks per process. If, when we call alarm, a previously registered alarm clock for the process has not yet expired, the number of seconds left for that alarm clock is returned as the value of this function.
</p>

<p>
If a previously registered alarm clock for the process has not yet expired and if the seconds value is 0, the previous alarm clock is canceled.
</p>

<p>
If we call alarm first and are sent SIGALRM before we can install the signal handler, our process will terminate
</p>
</blockquote>


<p>
suspends the calling process until a signal is caught
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pause</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: -1 with errno set to EINTR</span>
</pre>
</div>


<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 70: </span>Figure 10.7 Simple, incomplete implementation of sleep</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">nothing to do , just return to wake up the pause;</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sleep1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">seconds</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGALRM, sig_alrm<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>seconds<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    alarm<span style="color: #d75fd7;">(</span>seconds<span style="color: #d75fd7;">)</span>;     <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">start timer</span>
    pause<span style="color: #d75fd7;">()</span>;            <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">caught signal wake up</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>alarm<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">turn off timer, return unslept time</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 71: </span>Figure 10.8 Another (imperfect) implementation of sleep</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">setjmp.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">jmp_buf</span> <span style="color: #8787d7;">env_alrm</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> longjmp<span style="color: #d75fd7;">(</span>env_alrm, <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sleep2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">seconds</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGALRM, sig_alrm<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>seconds<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>setjmp<span style="color: #2aa198;">(</span>env_alrm<span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        alarm<span style="color: #2aa198;">(</span>seconds<span style="color: #2aa198;">)</span>;
        pause<span style="color: #2aa198;">()</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 72: </span>Figure 10.9 Calling sleep2 from a program that catches other signals</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sleep2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span>  <span style="color: #d75fd7; font-weight: bold;">sig_int</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">unslept</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGINT, sig_int<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"signal(SIGINT) error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    unslept = sleep2<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">5</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"sleep2 returned: %u\n"</span>, unslept<span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_int</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>          <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">j</span>;
    <span style="color: #268bd2; font-weight: bold;">volatile</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">k</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\nsig_int starting\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">3000000</span>; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>j = <span style="color: #d75fd7;">0</span>; j &lt; <span style="color: #d75fd7;">40000</span>; ++j<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            k += i * j;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"sig_int finished"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 73: </span>Figure 10.10 Calling <code>read</code> with a timeout</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig10.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-26</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    calling read() with timeout</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  @bug race condition between first call to alarm() and read()</span>
<span style="color: #008787; background-color: #262626;"> *  @bug if system are automatically restarted, the read is not interrupted</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGALRM, sig_alrm<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"signal(SIGALRM) error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">10</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;

    write<span style="color: #d75fd7;">(</span>STDOUT_FILENO, line, n<span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 74: </span>Figure 10.11 Calling <code>read</code> with a timeout, using longjmp</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig11.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-26</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    calling read with a timeout, using longjmp</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">setjmp.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span>    <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">jmp_buf</span> <span style="color: #8787d7;">env_alrm</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGALRM, sig_alrm<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGALRM) error"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>setjmp<span style="color: #2aa198;">(</span>env_alrm<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_quit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"read timeout"</span><span style="color: #d75fd7;">)</span>;

    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">10</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #d75fd7;">)</span>;

    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;

    write<span style="color: #d75fd7;">(</span>STDOUT_FILENO, line, n<span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> longjmp<span style="color: #d75fd7;">(</span>env_alrm, <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org49a99ee" class="outline-4">
<h4 id="org49a99ee"><span class="done DONE">DONE</span> 10.11 Signal Sets</h4>
<div class="outline-text-4" id="text-org49a99ee">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigemptyset</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #8787d7;">set</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigfillset</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #8787d7;">set</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigaddset</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigset</span> *<span style="color: #8787d7;">set</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigdelset</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigset</span> *<span style="color: #8787d7;">set</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">All four returns: 0 if OK, -1 on error</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigismember</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">sigset</span> *<span style="color: #8787d7;">set</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 1 if true, 0 if false, -1 on error</span>
</pre>
</div>

<p>
Implementation:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">sigemptyset</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">ptr</span><span style="color: #268bd2;">)</span>  <span style="color: #268bd2;">(</span>*<span style="color: #d75fd7;">(</span>ptr<span style="color: #d75fd7;">)</span> = <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">sigfillset</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">ptr</span><span style="color: #268bd2;">)</span>   <span style="color: #268bd2;">(</span>*<span style="color: #d75fd7;">(</span>ptr<span style="color: #d75fd7;">)</span> = ~<span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">sigset_t</span><span style="color: #d75fd7;">)</span><span style="color: #d75fd7;">0</span>, <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span>
</pre>
</div>
<p>
<code>sigfillset</code> returns value after the comma (value: 0)
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig12.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-26</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    implementations</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  An implementation of sigaddset(), sigdelset(), sigismember()</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * &lt;signal.h&gt; usually defines NSIG to include signal number 0.</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">SIGBAD</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">signao</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>signo<span style="color: #d75fd7;">)</span> &lt;= <span style="color: #d75fd7;">0</span> || <span style="color: #d75fd7;">(</span>signo<span style="color: #d75fd7;">)</span> &gt;= NSIG<span style="color: #268bd2;">)</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">my_sigaddset</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #8787d7;">set</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>SIGBAD<span style="color: #2aa198;">(</span>signo<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    *set |= <span style="color: #d75fd7;">1</span> &lt;&lt; <span style="color: #d75fd7;">(</span>signo - <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">turn bit on</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">my_sigdelset</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #8787d7;">set</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>SIGBAD<span style="color: #2aa198;">(</span>signo<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    *set &amp;= ~<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span> &lt;&lt; <span style="color: #2aa198;">(</span>signo - <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">turn bit off</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">my_sigismember</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #8787d7;">set</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>SIGBAD<span style="color: #2aa198;">(</span>signo<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>*set &amp; <span style="color: #67b11d;">(</span><span style="color: #d75fd7;">1</span> &lt;&lt; <span style="color: #875f00;">(</span>signo - <span style="color: #d75fd7;">1</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4fa12c2" class="outline-4">
<h4 id="org4fa12c2"><span class="done DONE">DONE</span> 10.12 <code>sigprocmask</code> Function</h4>
<div class="outline-text-4" id="text-org4fa12c2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigprocmask</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">how</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">set</span>, <span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">oset</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Figure 10.13 Ways to change the current signal mask using sigprocmask</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">how</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>SIG_BLOCK</code></td>
<td class="org-left"><i>set</i> contains the additional signals that we want to block.</td>
</tr>

<tr>
<td class="org-left"><code>SIG_UNBLOCK</code></td>
<td class="org-left"><i>set</i> contains the signals that we want to unblock</td>
</tr>

<tr>
<td class="org-left"><code>SIG_SETMASK</code></td>
<td class="org-left">new signal mask replaced by the signal set pointed to by <i>set</i></td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 75: </span>Figure 10.14 Print the signal mask for the process</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig14.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-27</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Print the signal mask for the process</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *   shows a function that prints the names of the signals in the signal mask of</span>
<span style="color: #008787; background-color: #262626;"> * the calling process.</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_mask</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">sigset_t</span> <span style="color: #8787d7;">sigset</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>      <span style="color: #8787d7;">errno_save</span>;

    errno_save = errno;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">we can be canceld by signal handlers</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span>, <span style="color: #d75fd7;">NULL</span>, &amp;sigset<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_ret<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"sigprocmask error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s"</span>, str<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGINT<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">" SIGINT"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGQUIT<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">" SIGQUIT"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGUSR1<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">" SIGUSR1"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGALRM<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">" SIGGALRM"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    errno = errno_save;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgfb805a8" class="outline-4">
<h4 id="orgfb805a8"><span class="done DONE">DONE</span> 10.13 <code>sigpending</code> Function</h4>
<div class="outline-text-4" id="text-orgfb805a8">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigpending</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #8787d7;">set</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 76: </span>Example of signal sets and sigprocmask</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pwd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">my_alarm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">passwd</span> *<span style="color: #8787d7;">rootptr</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"in signal hander\n"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>rootptr = getpwnam<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"hello"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"getpwnam(root) error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">passwd</span> *<span style="color: #8787d7;">ptr</span>;
    signal<span style="color: #d75fd7;">(</span>SIGALRM, my_alarm<span style="color: #d75fd7;">)</span>;
    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">usleep(500);                  // it seems alarm cannot interrupt sleep</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">function</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>ptr = getpwnam<span style="color: #875f00;">(</span><span style="color: #2aa198;">"zhoush"</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"getpwnam error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>strcmp<span style="color: #67b11d;">(</span>ptr-&gt;pw_name, <span style="color: #2aa198;">"zhoush"</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"return value corrupted!, pw_name = %s\n"</span>, ptr-&gt;pw_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgc96baab" class="outline-4">
<h4 id="orgc96baab"><span class="done DONE">DONE</span> 10.14 <code>sigaction</code> Function</h4>
<div class="outline-text-4" id="text-orgc96baab">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigaction</span> <span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span>* <span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">act</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span>* <span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">oact</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*sa_handler<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #d75fd7;">)</span>;       <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">addr of signal handler or SIG_IGN or SIG_DFL</span>

    <span style="color: #df005f; font-weight: bold;">sigset_t</span> <span style="color: #8787d7;">sa_mask</span>;               <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">addtional signals to block</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">sa_flags</span>;                   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">signal options, Figure 10.16</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">alternate handler</span>
    <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*sa_action<span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">int</span>, <span style="color: #df005f; font-weight: bold;">siginfo_t</span> *, <span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Figure 10.16 Option flags (sa_flags) for the handling of each signal</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Option</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD</th>
<th scope="col" class="org-left">Linux</th>
<th scope="col" class="org-left">Mac OSX</th>
<th scope="col" class="org-left">Solaris</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SA_INTERRUPT</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">system call interrupted by this signal are not automatically restarted</td>
</tr>

<tr>
<td class="org-left">SA_NOCLDSTOP</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">SIGCHLD do not generate signal when a child process stops(job control).</td>
</tr>

<tr>
<td class="org-left">SA_NOCLDWAIT</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">SIGCHLD prevents the system call from creating process zombie processes</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">when children of the calling process terminate.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">if the subsequently calls wait, the calling process blocks until all</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">its child processes have terminated and then returns -1 when errno set to ECHILD</td>
</tr>

<tr>
<td class="org-left">SA_NODEFER</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">signal is not automatically blocked by the system while the signao-catching function executes</td>
</tr>

<tr>
<td class="org-left">SA_ONSTACK</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">if an alternative stack has been declared with <code>signalstack</code><sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></td>
</tr>

<tr>
<td class="org-left">SA_RESETHAND</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">the disposition for this signal is reset to SIG_DFL, and the SA_SIGINFO flag is cleared</td>
</tr>

<tr>
<td class="org-left">SA_RESTART</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">system calls interrupted by this signal are automatically restarted</td>
</tr>

<tr>
<td class="org-left">SA_SIGINFO</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">provides additional information to a signal hander</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">normal signal handler</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">handler</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if SA_SIGINFO flag is set</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">handler</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #df005f; font-weight: bold;">siginfo_t</span> *<span style="color: #8787d7;">info</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">context</span><span style="color: #268bd2;">)</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">siginfo</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">si_signo</span>;          <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">signal number</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">si_errno</span>;          <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if nonzero, errno value from errno.h</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">si_code</span>;           <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">additional info (depends on signal)</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">si_pid</span>;          <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">sending process ID</span>
    <span style="color: #df005f; font-weight: bold;">uid_t</span> <span style="color: #8787d7;">si_uid</span>;          <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">sending process real user ID</span>
    <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">si_addr</span>;         <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">address that caused the fault</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">si_status</span>;         <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">exit value or signal number</span>
    <span style="color: #268bd2; font-weight: bold;">union</span> <span style="color: #df005f; font-weight: bold;">sigval</span> <span style="color: #8787d7;">si_value</span>; <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">application-specific value</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">possibly other fields also</span>
<span style="color: #268bd2;">}</span>;
<span style="color: #268bd2; font-weight: bold;">union</span> <span style="color: #df005f; font-weight: bold;">sigval</span> <span style="color: #268bd2;">{</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">sival_int</span>; <span style="color: #df005f; font-weight: bold;">void</span>* <span style="color: #8787d7;">sival_ptr</span>; <span style="color: #268bd2;">}</span>;

</pre>
</div>


<p>
<code>man sigaction</code> (linux)for details
</p>

<ul class="org-ul">
<li><p>
Example - <code>signal</code> function
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 77: </span>Figure 10.18 An implementation of signal using sigaction</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig18.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-27</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    An implementation of signal using sigaction</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Reliable version of signal(), using POSIX sigaction().</span>

<span style="color: #df005f; font-weight: bold;">Sigfunc</span> *<span style="color: #d75fd7; font-weight: bold;">signal</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #df005f; font-weight: bold;">Sigfunc</span> *<span style="color: #8787d7;">func</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span> <span style="color: #8787d7;">act</span>, <span style="color: #8787d7;">oact</span>;

    act.sa_handler = func;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;act.sa_mask<span style="color: #d75fd7;">)</span>;
    act.sa_flags = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signo == SIGALRM<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #2aa198;">(</span>SA_INTERRUPT<span style="color: #2aa198;">)</span>
        act.sa_flags |= SA_INTERRUPT;
<span style="color: #d75fd7;">#endif</span>
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        act.sa_flags |= SA_RESTART;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigaction<span style="color: #2aa198;">(</span>signo, &amp;act, &amp;oact<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> SIG_ERR;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> oact.sa_handler;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>

<li><p>
Example - <code>signal_intr</code> function
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 78: </span>Figure 10.19 The signal_intr function</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig19.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-27</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    The signal_intr function</span>
<span style="color: #008787; background-color: #262626;"> *   tries to prevent any interrupted system calls from being restarted.</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">Sigfunc</span> *<span style="color: #d75fd7; font-weight: bold;">signal_intr</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #df005f; font-weight: bold;">Sigfunc</span> *<span style="color: #8787d7;">func</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span> <span style="color: #8787d7;">act</span>, <span style="color: #8787d7;">oact</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>             <span style="color: #8787d7;">signame</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">32</span><span style="color: #d75fd7;">]</span> = <span style="color: #d75fd7;">{</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">}</span>;

    psignal<span style="color: #d75fd7;">(</span>signo, signame<span style="color: #d75fd7;">)</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s is caught\n"</span>, signame<span style="color: #d75fd7;">)</span>;

    act.sa_handler = func;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;act.sa_mask<span style="color: #d75fd7;">)</span>;
    act.sa_flags = <span style="color: #d75fd7;">0</span>;
<span style="color: #d75fd7;">#ifdef</span> SA_INTERRUPT
    act.sa_flags |= SA_INTERRUPT;
<span style="color: #d75fd7;">#endif</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigaction<span style="color: #2aa198;">(</span>signo, &amp;act, &amp;oact<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> SIG_ERR;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>oact.sa_handler<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org274595e" class="outline-4">
<h4 id="org274595e"><span class="done DONE">DONE</span> 10.15 <code>sigsetjmp</code> and <code>siglongjmp</code> Functions</h4>
<div class="outline-text-4" id="text-org274595e">
<p>
These two functions should always be used when branching from a signal handler.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">setjmp.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigsetjmp</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigjmp_buf</span> <span style="color: #8787d7;">env</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">savemask</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if called directly, nonzero if returning from a call to siglongjmp</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">siglongjmp</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sigjmp_buf</span> <span style="color: #8787d7;">env</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">val</span><span style="color: #268bd2;">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 79: </span>Figure 10.20 Example of signal masks, sigsetjmp, and siglongjmp</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig20.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Figure 10.20 Example of signal masks, sigsetjmp, and siglongjmp</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">setjmp.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span>                  <span style="color: #d75fd7; font-weight: bold;">sig_usr1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span>                  <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">sigjmp_buf</span>            <span style="color: #8787d7;">jmpbuf</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #268bd2; font-weight: bold;">volatile</span> <span style="color: #df005f; font-weight: bold;">sig_atomic_t</span> <span style="color: #8787d7;">canjump</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGUSR1, sig_usr1<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGUSR1) error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGALRM, sig_alrm<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGALRM) error"</span><span style="color: #d75fd7;">)</span>;

    pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"starting main: "</span><span style="color: #d75fd7;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Figure 10.14</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigsetjmp<span style="color: #2aa198;">(</span>jmpbuf, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pr_mask<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"ending main: "</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    canjump = <span style="color: #d75fd7;">1</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> pause<span style="color: #d75fd7;">()</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_usr1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span> <span style="color: #8787d7;">starttime</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>canjump == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span>;
    <span style="color: #d75fd7;">}</span>

    pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"starting sig_usr1: "</span><span style="color: #d75fd7;">)</span>;

    alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">3</span><span style="color: #d75fd7;">)</span>;
    starttime = time<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>time<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &gt; starttime + <span style="color: #d75fd7;">5</span><span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">break</span>;

    pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"finishing sig_usr1: "</span><span style="color: #d75fd7;">)</span>;

    canjump = <span style="color: #d75fd7;">0</span>;
    siglongjmp<span style="color: #d75fd7;">(</span>jmpbuf, <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">jump back to main, don't return</span>
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"in sig_alrm: "</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div>

<blockquote>
<p>
If we change the program in Figure 10.20 so that the calls to sigsetjmp and siglongjmp are replaced with calls to setjmp and longjmp on Linux (or _setjmp and _longjmp on FreeBSD), the final line of output becomes
</p>

<p>
ending main: SIGUSR1
</p>

<p>
This means that the main function is executing with the SIGUSR1 signal blocked, after the call to setjmp.
</p>
</blockquote></li>
</ul>
</div>
</div>

<div id="outline-container-orgde41900" class="outline-4">
<h4 id="orgde41900"><span class="done DONE">DONE</span> 10.16 <code>sigsuspend</code> Function</h4>
<div class="outline-text-4" id="text-orgde41900">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigsuspend</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #8787d7;">sigmask</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: &#8722;1 with errno set to EINTR</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 80: </span>Figure 10.22 Protecting a critical region from a signal</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig22.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Protecting a critical region from a signal</span>
<span style="color: #008787; background-color: #262626;"> *   the correct way to protect a critical region of code from a speci&#64257;c signal.</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_int</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">sigset_t</span> <span style="color: #8787d7;">newmask</span>, <span style="color: #8787d7;">oldmask</span>, <span style="color: #8787d7;">waitmask</span>;

    pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"program start: "</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGINT, sig_int<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGINT) error"</span><span style="color: #d75fd7;">)</span>;

    sigemptyset<span style="color: #d75fd7;">(</span>&amp;waitmask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;waitmask, SIGUSR1<span style="color: #d75fd7;">)</span>;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;newmask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;newmask, SIGINT<span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">block SIGINT and save current signal mask</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIG_BLOCK error"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">critical region of code</span>
    pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"in critical region: "</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">pause, allowing all signals except SIGUSR1</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigsuspend<span style="color: #2aa198;">(</span>&amp;waitmask<span style="color: #2aa198;">)</span> != -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"sigsuspend error"</span><span style="color: #d75fd7;">)</span>;

    pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"after return from sigsuspend"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">reset signal mask which unblock SIGINT</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"SIG_SETMASK error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">and continue processing...</span>
    pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"program exit: "</span><span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_int</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"\nin sig_int: "</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 81: </span>Figure 10.23 Using sigsuspend to wait for a global variable to be set</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig23.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    wait for a signal handler to set a global variable</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  catch both the interrupt signal and the quit signal,</span>
<span style="color: #008787; background-color: #262626;"> *  but want to wake up the main routine only when the quit signal is caught.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>
<span style="color: #268bd2; font-weight: bold;">volatile</span> <span style="color: #df005f; font-weight: bold;">sig_atomic_t</span> <span style="color: #8787d7;">quitflag</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">one signal handler for SIGINT and SIGQUIT</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_int</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signo == SIGINT<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\ninterrupt\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signo == SIGQUIT<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        quitflag = <span style="color: #d75fd7;">1</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">set flag for main loop</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">sigset_t</span> <span style="color: #8787d7;">newmask</span>, <span style="color: #8787d7;">oldmask</span>, <span style="color: #8787d7;">zeromask</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGINT, sig_int<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGINT) error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGQUIT, sig_int<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGQUIT) error"</span><span style="color: #d75fd7;">)</span>;

    sigemptyset<span style="color: #d75fd7;">(</span>&amp;zeromask<span style="color: #d75fd7;">)</span>;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;newmask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;newmask, SIGQUIT<span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">block SIGQUIT and save current signal mask.</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIG_BLOCK error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>quitflag == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> sigsuspend<span style="color: #d75fd7;">(</span>&amp;zeromask<span style="color: #d75fd7;">)</span>;

    quitflag = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIG_SETMASK error"</span><span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 82: </span>Figure 10.24 Routines to allow a parent and child to synchronize</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig24.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Routines to allow a parent and child to synchronize</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  show how signals can be used to synchronize a parent and child.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #268bd2; font-weight: bold;">volatile</span> <span style="color: #df005f; font-weight: bold;">sig_atomic_t</span> <span style="color: #8787d7;">sigflag</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">set nonzero by sig handler</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">sigset_t</span>              <span style="color: #8787d7;">newmask</span>, <span style="color: #8787d7;">oldmask</span>, <span style="color: #8787d7;">zeromask</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">one signal handler for SIGUSR1 and SIGUSR2</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_usr</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> sigflag = <span style="color: #d75fd7;">1</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">TELL_WAIT</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGUSR1, sig_usr<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGUSR1) error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGUSR2, sig_usr<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGUSR2) error"</span><span style="color: #d75fd7;">)</span>;

    sigemptyset<span style="color: #d75fd7;">(</span>&amp;zeromask<span style="color: #d75fd7;">)</span>;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;newmask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;newmask, SIGUSR1<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;newmask, SIGUSR2<span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">block SIGUSR1 and SIGUSR2, and save current signal mask</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIG_BLOCK error"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">TELL_PARENT</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> kill<span style="color: #d75fd7;">(</span>pid, SIGUSR2<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">WAIT_PARENT</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>sigflag == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> sigsuspend<span style="color: #d75fd7;">(</span>&amp;zeromask<span style="color: #d75fd7;">)</span>;

    sigflag = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIG_SETMASK error"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">TELL_CHILD</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> kill<span style="color: #d75fd7;">(</span>pid, SIGUSR1<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">WAIT_CHILD</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>sigflag == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> sigsuspend<span style="color: #d75fd7;">(</span>&amp;zeromask<span style="color: #d75fd7;">)</span>;
    sigflag = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIG_SETMASK error"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<ol class="org-ol">
<li>Block SIGINT and SIGALRM.</li>

<li>Test the two global variables to see whether either signal has occurred and, if so, handle the condition.</li>

<li>Call read (or any other system function) and unblock the two signals, as an atomic operation.</li>
</ol>

<p>
The sigsuspend function helps us only if step 3 is a pause operation.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org032bff3" class="outline-4">
<h4 id="org032bff3"><span class="done DONE">DONE</span> 10.17 <code>abort</code> Function</h4>
<div class="outline-text-4" id="text-org032bff3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">abort</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 83: </span>Figure 10.25 Implementation of POSIX.1 <code>abort</code></label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig25.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Implementation of POSIX.1 abort</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">POSIX-style abort() function</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">abort</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">sigset_t</span>         <span style="color: #8787d7;">mask</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span> <span style="color: #8787d7;">action</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">caller can't ignore SIGABRT, if so reset to defautl</span>
    sigaction<span style="color: #d75fd7;">(</span>SIGABRT, <span style="color: #d75fd7;">NULL</span>, &amp;action<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>action.sa_handler == SIG_IGN<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        action.sa_handler = SIG_DFL;
        sigaction<span style="color: #2aa198;">(</span>SIGABRT, &amp;action, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>action.sa_handler == SIG_DFL<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        fflush<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">flush all open stdio streams</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">caller can't block SIGABRT; make sure it's unblocked</span>
    sigfillset<span style="color: #d75fd7;">(</span>&amp;mask<span style="color: #d75fd7;">)</span>;
    sigdelset<span style="color: #d75fd7;">(</span>&amp;mask, SIGABRT<span style="color: #d75fd7;">)</span>;
    sigprocmask<span style="color: #d75fd7;">(</span>SIG_SETMASK, &amp;mask, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    kill<span style="color: #d75fd7;">(</span>getpid<span style="color: #2aa198;">()</span>, SIGABRT<span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if we're here, process caught SIGABRT and returned</span>
    fflush<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    action.sa_handler = SIG_DFL;
    sigaction<span style="color: #d75fd7;">(</span>SIG_DFL, &amp;action, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    sigprocmask<span style="color: #d75fd7;">(</span>SIG_SETMASK, &amp;mask, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    kill<span style="color: #d75fd7;">(</span>getpid<span style="color: #2aa198;">()</span>, SIGABRT<span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf1bfe67" class="outline-4">
<h4 id="orgf1bfe67"><span class="done DONE">DONE</span> 10.18 <code>system</code> Function</h4>
<div class="outline-text-4" id="text-orgf1bfe67">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 84: </span>Figure 10.26 Using <code>system</code> to invoke the <code>ed</code> editor</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig26.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Using system to invoke the ed editor</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_int</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"caught SIGINT\n"</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_chld</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"caught SIGCHLD\n"</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGINT, sig_int<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGINT) error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGCHLD, sig_chld<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"signal(SIGCHLD) error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>system<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/bin/ed"</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"system() error"</span><span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>


<div class="figure">
<p><img src="Chapter10/10fig27.jpg" alt="10fig27.jpg" />
</p>
<p><span class="figure-number">Figure 9: </span>Figure 10.27 Foreground and background process groups for Figure 10.26</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 85: </span>Figure 10.28 Correct POSIX.1 implementation of <code>system</code> function</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig28.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Correct POSIX.1 implementation of system function</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  implementation of the system function with the required signal handling</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">with appropriate signal handling</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">system</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cmdstring</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span>            <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>              <span style="color: #8787d7;">status</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span> <span style="color: #8787d7;">ignore</span>, <span style="color: #8787d7;">saveintr</span>, <span style="color: #8787d7;">savequit</span>;
    <span style="color: #df005f; font-weight: bold;">sigset_t</span>         <span style="color: #8787d7;">chldmask</span>, <span style="color: #8787d7;">savemask</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>cmdstring == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">always a command processor with UNIX</span>
    <span style="color: #d75fd7;">}</span>

    ignore.sa_handler = SIG_IGN;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;ignore.sa_mask<span style="color: #d75fd7;">)</span>;
    ignore.sa_flags = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigaction<span style="color: #2aa198;">(</span>SIGINT, &amp;ignore, &amp;saveintr<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigaction<span style="color: #2aa198;">(</span>SIGQUIT, &amp;ignore, &amp;savequit<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    sigemptyset<span style="color: #d75fd7;">(</span>&amp;chldmask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;chldmask, SIGCHLD<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_BLOCK, &amp;chldmask, &amp;savemask<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        status = -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">restore previous signal actions &amp; reset signal mask</span>
        sigaction<span style="color: #2aa198;">(</span>SIGINT, &amp;saveintr, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span>;
        sigaction<span style="color: #2aa198;">(</span>SIGQUIT, &amp;savequit, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span>;
        sigprocmask<span style="color: #2aa198;">(</span>SIG_SETMASK, &amp;savemask, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span>;

        execl<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/bin/sh"</span>, <span style="color: #2aa198;">"sh"</span>, <span style="color: #2aa198;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
        _exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">127</span><span style="color: #2aa198;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">exec error</span>
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #d75fd7;">1</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">error other than EINTR from waitpid()</span>
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">restore previous signal actions &amp; reset signal mask</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigaction<span style="color: #2aa198;">(</span>SIGINT, &amp;saveintr, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigaction<span style="color: #2aa198;">(</span>SIGQUIT, &amp;savequit, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_SETMASK, &amp;savemask, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>status<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3207ef3" class="outline-4">
<h4 id="org3207ef3"><span class="done DONE">DONE</span> 10.19 <code>sleep</code>, <code>nanaosleep</code>, and <code>clock_nanosleep</code> Functions</h4>
<div class="outline-text-4" id="text-org3207ef3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sleep</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">seconds</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 or number of unslept seconds</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 86: </span>Figure 10.29 Reliable implementation of <code>sleep</code></label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10.29.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Implementation of the POSIX.1 sleep function</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  modification of figure 10.17, hands signals reliably</span>
<span style="color: #008787; background-color: #262626;"> *  avoiding the race condition in the earlier implementation</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_alrm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">nothing to do, just return wakes up sigsuspend()</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sleep</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">seconds</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span> <span style="color: #8787d7;">newact</span>, <span style="color: #8787d7;">oldact</span>;
    <span style="color: #df005f; font-weight: bold;">sigset_t</span>         <span style="color: #8787d7;">newmask</span>, <span style="color: #8787d7;">oldmask</span>, <span style="color: #8787d7;">suspmask</span>;
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span>     <span style="color: #8787d7;">unslept</span>;

    newact.sa_handler = sig_alrm;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;newact.sa_mask<span style="color: #d75fd7;">)</span>;
    newact.sa_flags = <span style="color: #d75fd7;">0</span>;
    sigaction<span style="color: #d75fd7;">(</span>SIGALRM, &amp;newact, &amp;oldact<span style="color: #d75fd7;">)</span>;

    sigemptyset<span style="color: #d75fd7;">(</span>&amp;newmask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;newmask, SIGALRM<span style="color: #d75fd7;">)</span>;
    sigprocmask<span style="color: #d75fd7;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #d75fd7;">)</span>;

    alarm<span style="color: #d75fd7;">(</span>seconds<span style="color: #d75fd7;">)</span>;
    suspmask = oldmask;

    sigdelset<span style="color: #d75fd7;">(</span>&amp;suspmask, SIGALRM<span style="color: #d75fd7;">)</span>;

    sigsuspend<span style="color: #d75fd7;">(</span>&amp;suspmask<span style="color: #d75fd7;">)</span>;

    unslept = alarm<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;

    sigaction<span style="color: #d75fd7;">(</span>SIGALRM, &amp;oldact, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;

    sigprocmask<span style="color: #d75fd7;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>unslept<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">clock_nanosleep</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">clockid_t</span> <span style="color: #8787d7;">clock_id</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">flags</span>,
                    <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span>* <span style="color: #8787d7;">reqtp</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span>* <span style="color: #8787d7;">remtp</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if slept for requested time or error number on failue</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org2c46025" class="outline-4">
<h4 id="org2c46025"><span class="done DONE">DONE</span> 10.20 <code>sigqueue</code> Function</h4>
<div class="outline-text-4" id="text-org2c46025">
<ul class="org-ul">
<li>Specify the SA_SIGINFO flag when we install a signal handler using the sigaction function</li>
<li>Provide a signal handler in the sa_sigaction member of the sigaction structure instead of using the usual sa_handler field.</li>
<li><p>
Use the sigqueue function to send signals.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigqueue</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">union</span> <span style="color: #df005f; font-weight: bold;">sigval</span> <span style="color: #8787d7;">value</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Figure 10.30 Behavior of queued signals on various platforms</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Behavior</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD8.0</th>
<th scope="col" class="org-left">Linux3.2.0</th>
<th scope="col" class="org-left">Mac OSX</th>
<th scope="col" class="org-left">Solaris</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">supports sigqueue</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">queues other signals besides SIGRTMIN to SIGRTMAX</td>
<td class="org-left">optional</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">queues signals even if the caller don't use the SA_SIGINFO flags</td>
<td class="org-left">optional</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>

<div id="outline-container-org509f2bf" class="outline-4">
<h4 id="org509f2bf"><span class="done DONE">DONE</span> 10.21 Job-Control Signals</h4>
<div class="outline-text-4" id="text-org509f2bf">
<p>
job-control signals:
SIGCHLD   Child process has stopped or terminated
SIGCONT   Continue process, if stopped.
SIGSTOP   Stop signal(can't caught or ignored)
SIGTSTP   Interactive stop signal.
SIGTTIN   Read from controlling terminately by background process group number
SIGTTOU   Write to controlling terminal by a background process group member
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 87: </span>Figure 10.31 How to handle SIGTSTP</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig31.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    How to handle SIGTSTP</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">BUFFSIZE</span> <span style="color: #d75fd7;">1024</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">signal handler to SIGTSTP</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_tstp</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">sigset_t</span> <span style="color: #8787d7;">mask</span>;

    sigemptyset<span style="color: #d75fd7;">(</span>&amp;mask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;mask, SIGTSTP<span style="color: #d75fd7;">)</span>;
    sigprocmask<span style="color: #d75fd7;">(</span>SIG_UNBLOCK, &amp;mask, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;

    signal<span style="color: #d75fd7;">(</span>SIGTSTP, SIG_DFL<span style="color: #d75fd7;">)</span>;
    kill<span style="color: #d75fd7;">(</span>getpid<span style="color: #2aa198;">()</span>, SIGTSTP<span style="color: #d75fd7;">)</span>;

    signal<span style="color: #d75fd7;">(</span>SIGTSTP, sig_tstp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>BUFFSIZE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGTSTP, SIG_IGN<span style="color: #2aa198;">)</span> == SIG_DFL<span style="color: #d75fd7;">)</span> signal<span style="color: #d75fd7;">(</span>SIGTSTP, sig_tstp<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, buf, BUFFSIZE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>write<span style="color: #2aa198;">(</span>STDOUT_FILENO, buf, n<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>n &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfdaa842" class="outline-4">
<h4 id="orgfdaa842"><span class="done DONE">DONE</span> 10.22 Signal Names and Numbers</h4>
<div class="outline-text-4" id="text-orgfdaa842">
<p>
map between signal numbers and names.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">sys_siglist</span><span style="color: #268bd2;">[]</span>;
</pre>
</div>

<p>
in a portable manner
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">psignal</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">msg</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<p>
print signal information
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">psiginfo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">siginfo_t</span>* <span style="color: #8787d7;">info</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">msg</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<p>
string description of the signal and don't necessarily wnat to write it to standard error
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">string.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #d75fd7; font-weight: bold;">strsignal</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: a pointer to a string describing the signal</span>
</pre>
</div>

<p>
<b>Solaris provides</b>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sig2str</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">str2sig</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span>, <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #8787d7;">signop</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org74f9bab" class="outline-4">
<h4 id="org74f9bab"><span class="done DONE">DONE</span> 10.23 Summary</h4>
<div class="outline-text-4" id="text-org74f9bab">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
10.1
</p>
<blockquote>
<p>
terminates the first time
<code>pause</code> until a signal is received from either the kill(2) function or an interval timer
</p>
</blockquote></li>
<li><p>
10.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex10.2.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    example code for 10.2</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sig2str</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signo &lt;= <span style="color: #d75fd7;">0</span> || signo &gt;= NSIG<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>
    snprintf<span style="color: #d75fd7;">(</span>str, SIG2STR_MAX, <span style="color: #2aa198;">"%s"</span>, sys_siglist<span style="color: #2aa198;">[</span>signo<span style="color: #2aa198;">]</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>10.3
<a href="Chapter10/ex10.3.png"><img src="file:///Users/zhoush/Documents/Notes/books/system/APUE/Chapter10/ex10.3.png" alt="ex10.3.png" /></a></li>
<li>10.4
race condition between first call <code>alarm</code> and <code>setjmp</code></li>
<li>10.5
<a href="http://www.kohala.com/start/libes.timers.txt">www.kohala.com/start/libes.timers.txt</a></li>
<li><p>
10.6
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     exx10.6.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-29</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    test figure 10.24</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span> = fopen<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"a.txt"</span>, <span style="color: #2aa198;">"w+"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">num</span> = <span style="color: #d75fd7;">0</span>;

    fwrite<span style="color: #d75fd7;">(</span>&amp;num, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>num<span style="color: #2aa198;">)</span>, <span style="color: #d75fd7;">1</span>, fp<span style="color: #d75fd7;">)</span>;

    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span> = fork<span style="color: #d75fd7;">()</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">fread(&amp;num, sizeof(num), 1, fp);</span>
        ++num;
        fwrite<span style="color: #2aa198;">(</span>&amp;num, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>num<span style="color: #67b11d;">)</span>, <span style="color: #d75fd7;">1</span>, fp<span style="color: #2aa198;">)</span>;
        fprintf<span style="color: #2aa198;">(</span>stdout, <span style="color: #2aa198;">"child process: %d\n"</span>, num<span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">fread(&amp;num, sizeof(num), 1, fp);</span>
    ++num;
    fwrite<span style="color: #d75fd7;">(</span>&amp;num, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>num<span style="color: #2aa198;">)</span>, <span style="color: #d75fd7;">1</span>, fp<span style="color: #d75fd7;">)</span>;
    fprintf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #2aa198;">"parent process: %d\n"</span>, num<span style="color: #d75fd7;">)</span>;

    fclose<span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
10.7
</p>
<blockquote>
<p>
the termination status of the process would not show that it was terminated by the SIGABRT signal.
</p>
</blockquote></li>
<li><p>
10.8
</p>
<blockquote>
<p>
If the signal was sent by a process owned by some other user, the process has to be set-user-ID to either root or to the owner of the receiving process, or the kill attempt won’t work. Therefore, the real user ID provides more information to the receiver of the signal.
</p>
</blockquote></li>
<li><p>
10.9
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10fig14.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-27</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Print the signal mask for the process</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *   shows a function that prints the names of the signals in the signal mask of</span>
<span style="color: #008787; background-color: #262626;"> * the calling process.</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#if</span><span style="color: #d75fd7;">n</span><span style="color: #d75fd7;">def</span> NSIG
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NSIG</span> <span style="color: #d75fd7;">32</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pr_mask</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">sigset_t</span> <span style="color: #8787d7;">sigset</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>      <span style="color: #8787d7;">errno_save</span>;

    errno_save = errno;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">we can be canceld by signal handlers</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span>, <span style="color: #d75fd7;">NULL</span>, &amp;sigset<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_ret<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"sigprocmask error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s"</span>, str<span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span> = <span style="color: #d75fd7;">1</span>; signo &lt; NSIG; ++signo<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>sigismember<span style="color: #875f00;">(</span>&amp;sigset, signo<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"%s "</span>, strdup<span style="color: #268bd2;">(</span>strsignal<span style="color: #d75fd7;">(</span>signo<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>

        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    errno = errno_save;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span> pr_mask<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"starting main"</span><span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
10.10
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex10.10.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-03</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">spawn.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">log_to_stderr</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">cron</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    log_to_stderr = <span style="color: #d75fd7;">0</span>;
    log_open<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"ex10.10"</span>, <span style="color: #d75fd7;">0</span>, <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span> = <span style="color: #d75fd7;">0</span>;; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>i % <span style="color: #d75fd7;">5</span> == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #df005f; font-weight: bold;">time_t</span>    <span style="color: #8787d7;">t</span>  = time<span style="color: #67b11d;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tm</span> <span style="color: #8787d7;">st</span> = <span style="color: #67b11d;">{}</span>;

            localtime_r<span style="color: #67b11d;">(</span>&amp;t, &amp;st<span style="color: #67b11d;">)</span>;
            log_msg<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"time_of day: %02d:%02d:%02d"</span>, st.tm_hour, st.tm_min,
                    st.tm_sec<span style="color: #67b11d;">)</span>;
            log_msg<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"tm_sec: %d"</span>, st.tm_sec<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">60</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span>, <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">env</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span> = <span style="color: #d75fd7;">0</span>;
    daemonize<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span><span style="color: #d75fd7;">)</span>;
    cron<span style="color: #d75fd7;">()</span>;
    exit<span style="color: #d75fd7;">(</span>EXIT_SUCCESS<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
10.11
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/resource.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/stat.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">BUFFSIZ</span> <span style="color: #d75fd7;">10</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">ret</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>BUFFSIZ<span style="color: #d75fd7;">]</span>;

    signal<span style="color: #d75fd7;">(</span>SIGXFSZ, signal_intr<span style="color: #d75fd7;">)</span>;

    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">in</span>  = open<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, O_RDONLY<span style="color: #d75fd7;">)</span>;
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">out</span> = open<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">]</span>, O_CREAT | O_RDWR, <span style="color: #d75fd7;">0644</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">rlimit</span> <span style="color: #8787d7;">r</span> = <span style="color: #d75fd7;">{</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">}</span>;
    r.rlim_max      = <span style="color: #d75fd7;">12</span>;
    setrlimit<span style="color: #d75fd7;">(</span>RLIMIT_FSIZE, &amp;r<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>n = read<span style="color: #67b11d;">(</span>in, buf, BUFFSIZ<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>ret = write<span style="color: #875f00;">(</span>out, buf, n<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> != n<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">err_sys("write error: %d", ret);</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"%d write\n"</span>, ret<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    close<span style="color: #d75fd7;">(</span>in<span style="color: #d75fd7;">)</span>;
    close<span style="color: #d75fd7;">(</span>out<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>n &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<p>
SIGXFSZ never caught
</p></li>
<li><p>
10.12
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex10.2.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    example code for 10.2</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sig2str</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">str</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signo &lt;= <span style="color: #d75fd7;">0</span> || signo &gt;= NSIG<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>
    snprintf<span style="color: #d75fd7;">(</span>str, SIG2STR_MAX, <span style="color: #2aa198;">"%s"</span>, sys_siglist<span style="color: #2aa198;">[</span>signo<span style="color: #2aa198;">]</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<p>
finished, alarm appears until fwrite finshied, it seems the kernel is blocking SIGALRM
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org777604a" class="outline-3">
<h3 id="org777604a"><span class="done DONE">DONE</span> Chapter 11. Threads <code>[7/7]</code></h3>
<div class="outline-text-3" id="text-org777604a">
</div>
<div id="outline-container-org19b290b" class="outline-4">
<h4 id="org19b290b"><span class="done DONE">DONE</span> 11.1 Introduction</h4>
<div class="outline-text-4" id="text-org19b290b">
</div>
</div>
<div id="outline-container-org49f7c83" class="outline-4">
<h4 id="org49f7c83"><span class="done DONE">DONE</span> 11.2 Thread Concepts</h4>
<div class="outline-text-4" id="text-org49f7c83">
<p>
benefits
</p>
<ul class="org-ul">
<li>asynchronous</li>
<li>same memory address space and file descriptors</li>
<li>problem partition</li>
<li>seperate portions of the program</li>
</ul>
</div>
</div>
<div id="outline-container-orga1d4510" class="outline-4">
<h4 id="orga1d4510"><span class="done DONE">DONE</span> 11.3 Thread Identification</h4>
<div class="outline-text-4" id="text-orga1d4510">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_equal</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid1</span>, <span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid2</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: nonzero if equal, 0 otherwise</span>
</pre>
</div>

<p>
obtain its own thread ID :
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #d75fd7; font-weight: bold;">pthread_self</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: the thread ID of the calling thread</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org68ced8c" class="outline-4">
<h4 id="org68ced8c"><span class="done DONE">DONE</span> 11.4 Thread Creation</h4>
<div class="outline-text-4" id="text-org68ced8c">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_create</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">tidp</span>,
                   <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                   <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">start_rtn</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #d75fd7;">)</span>,
                   <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 88: </span>Figure 11.2 Printing thread IDs</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">ntid</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">printids</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">s</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span>     <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid</span>;

    pid = getpid<span style="color: #d75fd7;">()</span>;
    tid = pthread_self<span style="color: #d75fd7;">()</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s pid %lu tid %lu (0x%lx)\n"</span>, s, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>pid,
           <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>tid, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>tid<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printids<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"new thread: "</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">err</span>;

    pthread_create<span style="color: #d75fd7;">(</span>&amp;ntid, <span style="color: #d75fd7;">NULL</span>, thr_fn, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't creat thread"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printids<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"main thread: "</span><span style="color: #d75fd7;">)</span>;
    sleep<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org0616651" class="outline-4">
<h4 id="org0616651"><span class="done DONE">DONE</span> 11.5 Thread Termination</h4>
<div class="outline-text-4" id="text-org0616651">
<ol class="org-ol">
<li>thread return from start routine.</li>
<li>can be canceled by another thread in the same process</li>
<li>can call <code>pthread_exit</code></li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pthread_exit</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">rval_ptr</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_join</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">thread</span>, <span style="color: #df005f; font-weight: bold;">void</span> **<span style="color: #8787d7;">rval_ptr</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<blockquote>
<p>
The calling thread will block until the specified thread calls pthread_exit, returns from its start routine, or is canceled.
</p>
</blockquote>

<blockquote>
<p>
<b>The Linux Programming Language:</b>
If the main thread calls pthread_exit() instead of calling exit() or performing a return, then the other threads continue to execute.
</p>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 89: </span>Figure 11.3 Fetching the thread exit status</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 1 returning\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 2 returning\n"</span><span style="color: #d75fd7;">)</span>;
    pthread_exit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>       <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid1</span>, <span style="color: #8787d7;">tid2</span>;
    <span style="color: #df005f; font-weight: bold;">void</span> *    <span style="color: #8787d7;">tret</span>;

    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid1, <span style="color: #d75fd7;">NULL</span>, thr_fn1, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread1"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid2, <span style="color: #d75fd7;">NULL</span>, thr_fn2, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread2"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    err = pthread_join<span style="color: #d75fd7;">(</span>tid1, &amp;tret<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't join thread1"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 1 exit code %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>tret<span style="color: #d75fd7;">)</span>;
    err = pthread_join<span style="color: #d75fd7;">(</span>tid2, &amp;tret<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't join thread2"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 2 exit code %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>tret<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>

<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 90: </span>Figure 11.4 Incorrect use of <code>pthread_exit</code> argument</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig04.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-05</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Figure 11.4</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  shows the problem with using an automatic variable (allocated on the stack)</span>
<span style="color: #008787; background-color: #262626;"> * as the argument to pthread_exit.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">a</span>, <span style="color: #8787d7;">b</span>, <span style="color: #8787d7;">c</span>, <span style="color: #8787d7;">d</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">printfoo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">s</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s"</span>, s<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" structure at 0x%lx\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>fp<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" foo.a = %d\n"</span>, fp-&gt;a<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" foo.b = %d\n"</span>, fp-&gt;b<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" foo.c = %d\n"</span>, fp-&gt;c<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" foo.d = %d\n"</span>, fp-&gt;d<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> <span style="color: #8787d7;">foo</span> = <span style="color: #d75fd7;">{</span><span style="color: #d75fd7;">1</span>, <span style="color: #d75fd7;">2</span>, <span style="color: #d75fd7;">3</span>, <span style="color: #d75fd7;">4</span><span style="color: #d75fd7;">}</span>;
    printfoo<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 1:\n"</span>, &amp;foo<span style="color: #d75fd7;">)</span>;
    pthread_exit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span>&amp;foo<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 2: ID is %lu\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>pthread_self<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    pthread_exit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>   <span style="color: #8787d7;">tid1</span>, <span style="color: #8787d7;">tid2</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span>;

    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid1, <span style="color: #d75fd7;">NULL</span>, thr_fn1, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread 1"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    err = pthread_join<span style="color: #d75fd7;">(</span>tid1, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span>&amp;fp<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't join with thread 1"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    sleep<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid2, <span style="color: #d75fd7;">NULL</span>, thr_fn2, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    sleep<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    printfoo<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"parent:\n"</span>, fp<span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<blockquote>
<p>
the contents of the structure (allocated on the stack of thread tid1) have changed by the time the main thread can access the structure
</p>
</blockquote></li>
</ul>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cancel</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
in default circumstances, <code>pthread_exit</code> with <b>PTHREAD_CANCELD</b> <br />
doesn't wait for the thread to terminate; it merely makes the request. <br />
similar to <code>atexit</code> used by a process <br />
known as <i>thread cleanup handlers</i>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cleanup_push</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">rtn</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #d75fd7;">)</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cleanup_pop</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">execute</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<blockquote>
<p>
• Makes a call to pthread_exit
</p>

<p>
• Responds to a cancellation request
</p>

<p>
• Makes a call to pthread_cleanup_pop with a nonzero execute argument
</p>

<p>
If the execute argument is set to zero, the cleanup function is not called
</p>
</blockquote>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 91: </span>Figure 11.5 Thread cleanup handler</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig05.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-05</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    use thread cleanup handlers</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">cleanup</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"cleanup: %s\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #2aa198;">)</span>arg<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #875f00;">NOTE</span><span style="color: #008787; background-color: #262626;">: return will be cuz segment fault here</span>
<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 1 start\n"</span><span style="color: #d75fd7;">)</span>;
    pthread_cleanup_push<span style="color: #d75fd7;">(</span>cleanup, <span style="color: #2aa198;">"thread 1 first handler"</span><span style="color: #d75fd7;">)</span>;
    pthread_cleanup_push<span style="color: #d75fd7;">(</span>cleanup, <span style="color: #2aa198;">"thread 1 second handler"</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 1 push complete\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>arg<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">return ((void *)1);</span>
        pthread_exit<span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #67b11d;">)</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_cleanup_pop<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    pthread_cleanup_pop<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">return ((void *)1);</span>
    pthread_exit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 2 start\n"</span><span style="color: #d75fd7;">)</span>;
    pthread_cleanup_push<span style="color: #d75fd7;">(</span>cleanup, <span style="color: #2aa198;">"thread 2 first handler"</span><span style="color: #d75fd7;">)</span>;
    pthread_cleanup_push<span style="color: #d75fd7;">(</span>cleanup, <span style="color: #2aa198;">"thread 2 second handler"</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 2 push complete\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>arg<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pthread_exit<span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #67b11d;">)</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_cleanup_pop<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    pthread_cleanup_pop<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    pthread_exit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>       <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid1</span>, <span style="color: #8787d7;">tid2</span>;
    <span style="color: #df005f; font-weight: bold;">void</span> *    <span style="color: #8787d7;">tret</span>;

    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid1, <span style="color: #d75fd7;">NULL</span>, thr_fn1, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread 1"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid2, <span style="color: #d75fd7;">NULL</span>, thr_fn2, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread 2"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    err = pthread_join<span style="color: #d75fd7;">(</span>tid1, &amp;tret<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't join with thread 1"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 1 exit code %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>tret<span style="color: #d75fd7;">)</span>;
    err = pthread_join<span style="color: #d75fd7;">(</span>tid2, &amp;tret<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't join with thread 2"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 2 exit code %ld\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>tret<span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<blockquote>
<p>
if the thread terminates by returning from its start routine, its cleanup handlers are not called, although this behavior varies among implementations
</p>
</blockquote></li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> Figure 11.6 Comparison of process and thread primitives</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Process primitives</th>
<th scope="col" class="org-left">Thread Primitive</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">fork</td>
<td class="org-left">pthread_create</td>
<td class="org-left">create a new flow of control</td>
</tr>

<tr>
<td class="org-left">exit</td>
<td class="org-left">pthread_exit</td>
<td class="org-left">exit from an existing flow of control</td>
</tr>

<tr>
<td class="org-left">waitpid</td>
<td class="org-left">pthread_join</td>
<td class="org-left">get exit status from flow of control</td>
</tr>

<tr>
<td class="org-left">atexit</td>
<td class="org-left">pthread_cleanup_push</td>
<td class="org-left">register function to be called at exit from flow of control</td>
</tr>

<tr>
<td class="org-left">getpid</td>
<td class="org-left">pthread_self</td>
<td class="org-left">get ID for flow of control</td>
</tr>

<tr>
<td class="org-left">abort</td>
<td class="org-left">pthread_cancel</td>
<td class="org-left">request abnormal termination of flow of control</td>
</tr>
</tbody>
</table>


<p>
detach a thread by calling <code>pthread_detach</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_detach</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org416bbdf" class="outline-4">
<h4 id="org416bbdf"><span class="done DONE">DONE</span> 11.6 Thread Synchronization <code>[8/8]</code></h4>
<div class="outline-text-4" id="text-org416bbdf">
<p>
Increment operation:
</p>
<blockquote>
<ol class="org-ol">
<li>Read the memory location into a register.</li>
<li>Increment the value in the register.</li>
<li>Write the new value back to the memory location.</li>
</ol>


<p>
<b>If our data always appears to be sequentially consistent, then we need no additional synchronization.</b>
</p>
</blockquote>


<div class="figure">
<p><a href="Chapter11/11fig9.jpg"><img src="Chapter11/11fig09.jpg" alt="11fig09.jpg" /></a>
</p>
<p><span class="figure-number">Figure 10: </span>Figure 11.9 Two unsynchronized threads incrementing the same variable</p>
</div>
</div>
<ul class="org-ul">
<li><a id="org7136909"></a><span class="done DONE">DONE</span> 11.6.1 Mutexes<br />
<div class="outline-text-5" id="text-org7136909">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutex_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">mutex</span>,
                       <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutex_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #8787d7;">mutex</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutex_lock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #8787d7;">mutex</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutex_trylock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #8787d7;">mutex</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutex_unlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #8787d7;">mutex</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">All return: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 92: </span>Figure 11.10 Using a mutex to protect a data structure</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig10.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-06</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    use mutex to protect a data structure</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">f_count</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">f_lock</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">f_id</span>;
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">... more stuff here  ...</span>
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #d75fd7; font-weight: bold;">foo_alloc</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">fp</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        fp-&gt;f_count = <span style="color: #d75fd7;">1</span>;
        fp-&gt;f_id    = id;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">foo_hold</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;fp-&gt;f_lock<span style="color: #d75fd7;">)</span>;
    fp-&gt;f_count++;
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;fp-&gt;f_lock<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">foo_rele</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;fp-&gt;f_lock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>--fp-&gt;f_count == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        pthread_mutex_destroy<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        free<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="orgb1dbc1a"></a><span class="done DONE">DONE</span> 11.6.2 Deadlock Avoidance<br />
<div class="outline-text-5" id="text-orgb1dbc1a">
<p>
lock the same mutex twice will cause deadlock
</p>

<p>
Deadlocks can be avoided by carefully controlling the order in which mutexes are locked
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 93: </span>Figure 11.11 Using two mutexes</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig11.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-06</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    the use of two mutexes</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NHASH</span>    <span style="color: #d75fd7;">29</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">HASH</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>id<span style="color: #d75fd7;">)</span> % NHASH<span style="color: #268bd2;">)</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">fh</span><span style="color: #268bd2;">[</span>NHASH<span style="color: #268bd2;">]</span>;

<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">hashlock</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">f_count</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">f_lock</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">f_id</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>*     <span style="color: #8787d7;">f_next</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">protected by hashlock</span>
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #d75fd7; font-weight: bold;">foo_alloc</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">fp</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">idx</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        fp-&gt;f_count = <span style="color: #d75fd7;">1</span>;
        fp-&gt;f_id    = id;

        idx = HASH<span style="color: #2aa198;">(</span>id<span style="color: #2aa198;">)</span>;
        pthread_mutex_lock<span style="color: #2aa198;">(</span>&amp;hashlock<span style="color: #2aa198;">)</span>;
        fp-&gt;f_next = fh<span style="color: #2aa198;">[</span>idx<span style="color: #2aa198;">]</span>;
        pthread_mutex_lock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;hashlock<span style="color: #2aa198;">)</span>;
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">continue initialization</span>
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">foo_hold</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;fp-&gt;f_lock<span style="color: #d75fd7;">)</span>;
    fp-&gt;f_count++;
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;fp-&gt;f_lock<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #d75fd7; font-weight: bold;">foo_find</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">fp</span>;

    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;hashlock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>fp = fh<span style="color: #2aa198;">[</span>HASH<span style="color: #67b11d;">(</span>id<span style="color: #67b11d;">)</span><span style="color: #2aa198;">]</span>; fp != <span style="color: #d75fd7;">NULL</span>; fp = fp-&gt;f_next<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fp-&gt;f_id == id<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            foo_hold<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;hashlock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">release a reference to the object</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">foo_rele</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span>* <span style="color: #8787d7;">tfp</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">idx</span>;

    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;fp-&gt;f_lock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fp-&gt;f_count == <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        pthread_mutex_lock<span style="color: #2aa198;">(</span>&amp;hashlock<span style="color: #2aa198;">)</span>;
        pthread_mutex_lock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fp-&gt;f_count != <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            fp-&gt;f_count--;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock<span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;hashlock<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span>;
        <span style="color: #2aa198;">}</span>

        idx = HASH<span style="color: #2aa198;">(</span>fp-&gt;f_id<span style="color: #2aa198;">)</span>;
        tfp = fh<span style="color: #2aa198;">[</span>idx<span style="color: #2aa198;">]</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>tfp == fp<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            fh<span style="color: #67b11d;">[</span>idx<span style="color: #67b11d;">]</span> = fp-&gt;f_next;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>tfp-&gt;f_next != fp<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tfp = tfp-&gt;f_next;
            <span style="color: #67b11d;">}</span>
            tfp-&gt;f_next = fp-&gt;f_next;
        <span style="color: #2aa198;">}</span>
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;hashlock<span style="color: #2aa198;">)</span>;
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        pthread_mutex_destroy<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        free<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        fp-&gt;f_count--;
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>

<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 94: </span>Figure 11.12 Simplified locking</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig12.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-08</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Simplified locking</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NHASH</span>    <span style="color: #d75fd7;">29</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">HASH</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>id<span style="color: #d75fd7;">)</span> % NHASH<span style="color: #268bd2;">)</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *    <span style="color: #8787d7;">fh</span><span style="color: #268bd2;">[</span>NHASH<span style="color: #268bd2;">]</span>;
<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">hashlock</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">f_count</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">protected by hashlock</span>
    <span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">f_lock</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">f_id</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *    <span style="color: #8787d7;">f_next</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">protected by hashlock</span>
                             <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">... more stuff here ...</span>
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #d75fd7; font-weight: bold;">foo_alloc</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">idx</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        fp-&gt;f_count = <span style="color: #d75fd7;">1</span>;
        fp-&gt;f_id    = id;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        idx = HASH<span style="color: #2aa198;">(</span>id<span style="color: #2aa198;">)</span>;
        pthread_mutex_lock<span style="color: #2aa198;">(</span>&amp;hashlock<span style="color: #2aa198;">)</span>;
        fp-&gt;f_next = fh<span style="color: #2aa198;">[</span>idx<span style="color: #2aa198;">]</span>;
        fh<span style="color: #2aa198;">[</span>idx<span style="color: #2aa198;">]</span>    = fp;
        pthread_mutex_lock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;hashlock<span style="color: #2aa198;">)</span>;
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">continue initialization</span>
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">foo_hold</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;hashlock<span style="color: #d75fd7;">)</span>;
    fp-&gt;f_count++;
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;hashlock<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #d75fd7; font-weight: bold;">foo_find</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span>;

    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;hashlock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>fp = fh<span style="color: #2aa198;">[</span>HASH<span style="color: #67b11d;">(</span>id<span style="color: #67b11d;">)</span><span style="color: #2aa198;">]</span>; fp != <span style="color: #d75fd7;">NULL</span>; fp = fp-&gt;f_next<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fp-&gt;f_id == id<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            fp-&gt;f_count++;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;hashlock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">foo_rele</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">tfp</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">idx</span>;

    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;hashlock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>--fp-&gt;f_count == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        idx = HASH<span style="color: #2aa198;">(</span>fp-&gt;f_id<span style="color: #2aa198;">)</span>;
        tfp = fh<span style="color: #2aa198;">[</span>idx<span style="color: #2aa198;">]</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>tfp == fp<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            fh<span style="color: #67b11d;">[</span>idx<span style="color: #67b11d;">]</span> = fp-&gt;f_next;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>tfp-&gt;f_next != fp<span style="color: #67b11d;">)</span> tfp = tfp-&gt;f_next;
            tfp-&gt;f_next = fp-&gt;f_next;
        <span style="color: #2aa198;">}</span>
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;hashlock<span style="color: #2aa198;">)</span>;
        pthread_mutex_destroy<span style="color: #2aa198;">(</span>&amp;fp-&gt;f_lock<span style="color: #2aa198;">)</span>;
        free<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;hashlock<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org45b7c64"></a><span class="done DONE">DONE</span> 11.6.3 <code>pthread_mutex_timedlock</code> function<br />
<div class="outline-text-5" id="text-org45b7c64">
<p>
<b>Mac OSX 10.15.1 doesn't support <code>pthread_mutex_timedlock</code> yet</b>
</p>

<p>
<code>pthread_mutex_timedlock</code> is equivalent to <code>pthread_mutex_lock</code>, but returns <b>ETIMEDOUT</b> without locking mutex after timeout
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutex_timedlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">mutex</span>,
                            <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">tsptr</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 95: </span>Figure 11.13 Using <code>pthread_mutex_timedlock</code></label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig13.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-08</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    use pthread_mutex_timedlock() to avoid blocking indefinitely</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">err</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> <span style="color: #8787d7;">tout</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">tm</span>*      <span style="color: #8787d7;">tmp</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>            <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">64</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">lock</span> = PTHREAD_MUTEX_INITIALIZER;

    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;lock<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"mutex is locked"</span><span style="color: #d75fd7;">)</span>;
    clock_gettime<span style="color: #d75fd7;">(</span>CLOCK_REALTIME, &amp;tout<span style="color: #d75fd7;">)</span>;
    tmp = localtime<span style="color: #d75fd7;">(</span>&amp;tout.tv_sec<span style="color: #d75fd7;">)</span>;
    strftime<span style="color: #d75fd7;">(</span>buf, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span>, <span style="color: #2aa198;">"%r"</span>, tmp<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"current time is %s\n"</span>, buf<span style="color: #d75fd7;">)</span>;

    tout.tv_sec += <span style="color: #d75fd7;">10</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">10 seconds from now</span>

    err = pthread_mutex_timedlock<span style="color: #d75fd7;">(</span>&amp;lock, &amp;tout<span style="color: #d75fd7;">)</span>;
    clock_gettime<span style="color: #d75fd7;">(</span>CLOCK_REALTIME, &amp;tout<span style="color: #d75fd7;">)</span>;
    tmp = localtime<span style="color: #d75fd7;">(</span>&amp;tout.tv_sec<span style="color: #d75fd7;">)</span>;
    strftime<span style="color: #d75fd7;">(</span>buf, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span>, <span style="color: #2aa198;">"%r"</span>, tmp<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"the time is now %s\n"</span>, buf<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"mutex locked again!\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't lock mutex again: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>err<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org84daceb"></a><span class="done DONE">DONE</span> 11.6.4 Reader-Writer Locks<br />
<div class="outline-text-5" id="text-org84daceb">
<ul class="org-ul">
<li>mutex  : can only one thread lock it at a time, lock/unlock.</li>
<li>rw-lock: read lock, write lock, unlock.</li>
<li>rw-lock: only one thread can hold a rw-lock in write mode, but multiple threads can hold a rw-lock in read mode at the same time.
<ul class="org-ul">
<li>w-lock: all threads attempting to lock it block until it is unlocked (<b>exclusive mode</b>)</li>
<li>r-lock: all threads attempting to do r-lock are given access, but w-lock block (<b>shared mode</b>)</li>
</ul></li>
</ul>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">rwlock</span>,
                        <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #8787d7;">rwlock</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
The Single UNIX specification defines <b>PTHREAD_RWLOCK_INITIALIZE</b> constant in the XSI option to initialize a statically allocated rw lock.
</p>

<p>
rw-lock control:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_rdlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #8787d7;">rwlock</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_wrlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #8787d7;">rwlock</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_unlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #8787d7;">rwlock</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">All return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
rw-lock try control:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_tryrdlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #8787d7;">rwlock</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_trywrlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #8787d7;">rwlock</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>


<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 96: </span>Figure 11.14 Using reader-writer locks</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig14.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-09</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    illustrates the use of reader&#8211;writer locks</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">j_next</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">j_prev</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>   <span style="color: #8787d7;">j_id</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">tells which thread handles this job</span>
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *     <span style="color: #8787d7;">q_head</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *     <span style="color: #8787d7;">q_tail</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> <span style="color: #8787d7;">q_lock</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">queue_init</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">q</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">err</span>;

    q-&gt;q_head = <span style="color: #d75fd7;">NULL</span>;
    q-&gt;q_tail = <span style="color: #d75fd7;">NULL</span>;
    err       = pthread_rwlock_init<span style="color: #d75fd7;">(</span>&amp;q-&gt;q_lock, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>err<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">continue initialization</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">job_insert</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">qp</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">jp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_rwlock_wrlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_lock<span style="color: #d75fd7;">)</span>;
    jp-&gt;j_next = qp-&gt;q_head;
    jp-&gt;j_prev = <span style="color: #d75fd7;">NULL</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>qp-&gt;q_head != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
        qp-&gt;q_head-&gt;j_prev = jp;
    <span style="color: #268bd2; font-weight: bold;">else</span>
        qp-&gt;q_tail = jp;

    qp-&gt;q_head = jp;
    pthread_rwlock_unlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_lock<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">job_append</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">qp</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">jp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_rwlock_wrlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_lock<span style="color: #d75fd7;">)</span>;
    jp-&gt;j_next = <span style="color: #d75fd7;">NULL</span>;
    jp-&gt;j_prev = qp-&gt;q_tail;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>qp-&gt;q_tail != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
        qp-&gt;q_tail-&gt;j_next = jp;
    <span style="color: #268bd2; font-weight: bold;">else</span>
        qp-&gt;q_head = jp;

    qp-&gt;q_tail = jp;

    pthread_rwlock_unlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_lock<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">job_remove</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">qp</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">jp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_rwlock_wrlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_lock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>jp == qp-&gt;q_head<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        qp-&gt;q_head = jp-&gt;j_next;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>qp-&gt;q_tail == jp<span style="color: #2aa198;">)</span>
            qp-&gt;q_tail = <span style="color: #d75fd7;">NULL</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span>
            jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>jp == qp-&gt;q_tail<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        qp-&gt;q_tail         = jp-&gt;j_prev;
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
        jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #d75fd7;">}</span>
    pthread_rwlock_unlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_lock<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #d75fd7; font-weight: bold;">job_find</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">qp</span>, <span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">jp</span> = <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pthread_rwlock_rdlock<span style="color: #2aa198;">(</span>&amp;qp-&gt;q_lock<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>jp = qp-&gt;q_head; jp; jp = jp-&gt;j_next<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>pthread_equal<span style="color: #67b11d;">(</span>id, jp-&gt;j_id<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #268bd2; font-weight: bold;">break</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_rwlock_unlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_lock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>jp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="orgb576327"></a><span class="done DONE">DONE</span> 11.6.5 Reader-Writer Locking with Timeouts<br />
<div class="outline-text-5" id="text-orgb576327">
<p>
rw-lock with timeout to avoid blocking indefinitely
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_timedrdlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">rwlock</span>,
                               <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">tsptr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlock_timedwrlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">rwlock</span>,
                               <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">tsptr</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<b>the timeout specifies an absolute time, not a relative one.</b>
</p>
</div>
</li>
<li><a id="org8f1f27f"></a><span class="done DONE">DONE</span> 11.6.6 Condition Variables<br />
<div class="outline-text-5" id="text-org8f1f27f">
<blockquote>
<p>
The condition itself is protected by a mutex. A thread must first lock the mutex to change the condition state. Other threads will not notice the change until they acquire the mutex, because the mutex must be locked to be able to evaluate the condition.
</p>

<p>
assign the constant PTHREAD_COND_INITIALIZER to a statically allocated condition variable
</p>
</blockquote>

<p>
<code>pthread_cond_init/destroy</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cond_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_cond_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">cond</span>,
                      <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cond_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_cond_t</span> *<span style="color: #8787d7;">cond</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both returns: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
<code>pthread_cond wait/timedwait</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cond_wait</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_cond_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">cond</span>,
                      <span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">mutex</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cond_timedwait</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_cond_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">cond</span>,
                           <span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">mutex</span>,
                           <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">tsptr</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
wait as an absolute time instead of a relative time.
</p>

<p>
To obtain the absolute time for the timeout value,
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/time.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">maketimeout</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #8787d7;">tsp</span>, <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">minutes</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
  <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">now</span>;

  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">get the current time</span>
  gettimeofday<span style="color: #d75fd7;">(</span>&amp;now, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
  tsp-&gt;tv_sec = now.tv_sec;
  tsp-&gt;tv_nsec = now.tv_usec * <span style="color: #d75fd7;">1000</span>; <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">usec to nsec</span>
  tsp-&gt;tv_sec += minutes * <span style="color: #d75fd7;">60</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>


<p>
notify threads that a condition has been satisfied.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cond_signal</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_cond_t</span> *<span style="color: #8787d7;">cond</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_cond_broadcast</span> <span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_cond_t</span> *<span style="color: #8787d7;">cond</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 97: </span>Figure 11.15 Using a condition variable</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig15.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-10</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    an example of how to use a condition variable and a mutex</span>
<span style="color: #008787; background-color: #262626;"> * together to synchronize threads.</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">msg</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">msg</span> *<span style="color: #8787d7;">m_next</span>;
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">more stuff here</span>
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">msg</span> *<span style="color: #8787d7;">workd</span>;

<span style="color: #df005f; font-weight: bold;">pthread_cond_t</span>  <span style="color: #8787d7;">qready</span> = PTHREAD_COND_INITIALIZER;
<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">qlock</span>  = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">process_msg</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">msg</span> *<span style="color: #8787d7;">mp</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pthread_mutex_lock<span style="color: #2aa198;">(</span>&amp;qlock<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>workd == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            pthread_cond_wait<span style="color: #67b11d;">(</span>&amp;qready, &amp;qlock<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        mp    = workd;
        workd = mp-&gt;m_next;
        pthread_mutex_unlock<span style="color: #2aa198;">(</span>&amp;qlock<span style="color: #2aa198;">)</span>;
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">now process the messg mp</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">enqueue_msg</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">msg</span> *<span style="color: #8787d7;">mp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;qlock<span style="color: #d75fd7;">)</span>;
    mp-&gt;m_next = workd;
    workd      = mp;
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;qlock<span style="color: #d75fd7;">)</span>;
    pthread_cond_signal<span style="color: #d75fd7;">(</span>&amp;qready<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org4399f5a"></a><span class="done DONE">DONE</span> 11.6.7 Spin Locks<br />
<div class="outline-text-5" id="text-org4399f5a">
<blockquote>
<p>
A spin lock is like a mutex, except that <b>instead of blocking</b> a process by sleeping, the process is blocked by busy-waiting (spinning) until the lock can be acquired
</p>

<p>
use for short periods of times
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_spin_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #8787d7;">lock</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">pshared</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_spin_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #8787d7;">lock</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<ul class="org-ul">
<li><b>PTHREAD_PROCESS_SHARED</b>: the spin lock can be acquired by threads that have access to the lock's underlying memory</li>
<li><b>PTHREAD_PROCESS_PRIVATE</b>: the spin lock can be accessed by only from threads within the process that initialized it.</li>
</ul>


<p>
<code>pthread_spin_trylock</code> doesn't spin,
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_spin_lock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #8787d7;">lock</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_spin_trylock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #8787d7;">lock</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_spin_unlock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #8787d7;">lock</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">All return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
If either pthread_spin_lock or pthread_spin_trylock returns 0, then the spin lock is locked
</p>
</div>
</li>

<li><a id="org6a1f0e4"></a><span class="done DONE">DONE</span> 11.6.8 Barriers<br />
<div class="outline-text-5" id="text-org6a1f0e4">
<p>
<b>Mac OSX doesn't implemented yet, but we can implemente it by pthread_cond and pthread_mutex</b>
coordinate multiple threads working in parallel.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrier_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">barrier</span>,
                         <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                         <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">count</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrier_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #8787d7;">barrier</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<b>count</b> refers to the number of threads that must call <code>pthread_barrier_wait()</code> (includes the calling in process)
</p>

<p>
<code>pthread_barrier_wait</code> indicates a thread is done with its work and is ready to wait for all the other threads to catch up .
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrier_wait</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #8787d7;">barrier</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 or PTHREAD_BARRIER_SERIAL_THREAD if OK, error number on failure</span>
</pre>
</div>
<p>
calling <code>pthread_barrier_wait</code> is put to sleep if barrier count is not yet satisfied.
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 98: </span>Figure 11.16 Using a barrier</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig16.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-10</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    show how a barrier can be used to synchronize threads cooperating</span>
<span style="color: #008787; background-color: #262626;"> * on a single task</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NTHR</span>   <span style="color: #d75fd7;">8</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NUMNUM</span> <span style="color: #d75fd7;">800000L</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">TNUM</span>   <span style="color: #268bd2;">(</span>NUMNUM / NTHR<span style="color: #268bd2;">)</span>

<span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">nums</span><span style="color: #268bd2;">[</span>NUMNUM<span style="color: #268bd2;">]</span>;
<span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">snums</span><span style="color: #268bd2;">[</span>NUMNUM<span style="color: #268bd2;">]</span>;

<span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span> <span style="color: #8787d7;">b</span>;

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>SOLARIS<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">heapsort</span> gsort
<span style="color: #d75fd7;">#elif</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>__linux__<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">heapsort</span> qsort
<span style="color: #d75fd7;">#else</span>
<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">heapsort</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *, <span style="color: #df005f; font-weight: bold;">size_t</span>, <span style="color: #df005f; font-weight: bold;">size_t</span>,
                    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7;">)(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">complong</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg1</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg2</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">l1</span> = *<span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #d75fd7;">)</span>arg1;
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">l2</span> = *<span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #d75fd7;">)</span>arg2;

    <span style="color: #268bd2; font-weight: bold;">return</span> l1 == l2 ? <span style="color: #d75fd7;">0</span> : l1 &gt; l2 ? <span style="color: #d75fd7;">1</span> : -<span style="color: #d75fd7;">1</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">idx</span> = <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #d75fd7;">)</span>arg;

    heapsort<span style="color: #d75fd7;">(</span>&amp;nums<span style="color: #2aa198;">[</span>idx<span style="color: #2aa198;">]</span>, TNUM, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>, complong<span style="color: #d75fd7;">)</span>;
    pthread_barrier_wait<span style="color: #d75fd7;">(</span>&amp;b<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">merge</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">idx</span><span style="color: #d75fd7;">[</span>NTHR<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">minidx</span>, <span style="color: #8787d7;">sidx</span>, <span style="color: #8787d7;">num</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NTHR; i++<span style="color: #d75fd7;">)</span> idx<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span> = i * TNUM;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>sidx = <span style="color: #d75fd7;">0</span>; sidx &lt; NUMNUM; sidx++<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        num = LONG_MAX;
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NTHR; ++i<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>idx<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span> &lt; <span style="color: #268bd2;">(</span>i + <span style="color: #d75fd7;">1</span><span style="color: #268bd2;">)</span> * TNUM<span style="color: #875f00;">)</span> &amp;&amp; <span style="color: #875f00;">(</span>nums<span style="color: #268bd2;">[</span>idx<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">]</span> &lt; num<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                num    = nums<span style="color: #875f00;">[</span>idx<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span><span style="color: #875f00;">]</span>;
                minidx = i;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        snums<span style="color: #2aa198;">[</span>sidx<span style="color: #2aa198;">]</span> = nums<span style="color: #2aa198;">[</span>idx<span style="color: #67b11d;">[</span>minidx<span style="color: #67b11d;">]</span><span style="color: #2aa198;">]</span>;
        idx<span style="color: #2aa198;">[</span>minidx<span style="color: #2aa198;">]</span>++;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span>  <span style="color: #8787d7;">i</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">start</span>, <span style="color: #8787d7;">end</span>;
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #df005f; font-weight: bold;">long</span>      <span style="color: #8787d7;">startusec</span>, <span style="color: #8787d7;">endusec</span>;
    <span style="color: #df005f; font-weight: bold;">double</span>         <span style="color: #8787d7;">elapsed</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>      <span style="color: #8787d7;">tid</span>;

    srandom<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NUMNUM; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        nums<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = random<span style="color: #2aa198;">()</span>;
    <span style="color: #d75fd7;">}</span>

    gettimeofday<span style="color: #d75fd7;">(</span>&amp;start, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    pthread_barrier_init<span style="color: #d75fd7;">(</span>&amp;b, <span style="color: #d75fd7;">NULL</span>, NTHR + <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NTHR; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err = pthread_create<span style="color: #2aa198;">(</span>&amp;tid, <span style="color: #d75fd7;">NULL</span>, thr_fn, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span>i * TNUM<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2aa198;">"can't create thread"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    pthread_barrier_wait<span style="color: #d75fd7;">(</span>&amp;b<span style="color: #d75fd7;">)</span>;
    merge<span style="color: #d75fd7;">()</span>;
    gettimeofday<span style="color: #d75fd7;">(</span>&amp;end, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;

    startusec = start.tv_sec * <span style="color: #d75fd7;">1000000</span> + start.tv_usec;
    endusec   = end.tv_sec * <span style="color: #d75fd7;">100000</span> + end.tv_usec;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"sort took %.4f seconds"</span>, elapsed<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NUMNUM; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%ld\n"</span>, snums<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org8f4319b" class="outline-4">
<h4 id="org8f4319b"><span class="done DONE">DONE</span> 11.7 Summary</h4>
<div class="outline-text-4" id="text-org8f4319b">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
11.1
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig04.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-05</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Exerciese 11.1</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">a</span>, <span style="color: #8787d7;">b</span>, <span style="color: #8787d7;">c</span>, <span style="color: #8787d7;">d</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">printfoo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">s</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s"</span>, s<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" structure at 0x%lx\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>fp<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" foo.a = %d\n"</span>, fp-&gt;a<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" foo.b = %d\n"</span>, fp-&gt;b<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" foo.c = %d\n"</span>, fp-&gt;c<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">" foo.d = %d\n"</span>, fp-&gt;d<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn1</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span> = <span style="color: #d75fd7;">NULL</span>;

    fp = calloc<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span>, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;

    fp-&gt;a = <span style="color: #d75fd7;">1</span>;
    fp-&gt;b = <span style="color: #d75fd7;">2</span>;
    fp-&gt;c = <span style="color: #d75fd7;">3</span>;
    fp-&gt;d = <span style="color: #d75fd7;">4</span>;

    printfoo<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 1:\n"</span>, fp<span style="color: #d75fd7;">)</span>;
    pthread_exit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn2</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span> = arg;
    printfoo<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 2: "</span>, fp<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread 2: ID is %lu\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>pthread_self<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    pthread_exit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>   <span style="color: #8787d7;">tid1</span>, <span style="color: #8787d7;">tid2</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">foo</span> *<span style="color: #8787d7;">fp</span>;

    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid1, <span style="color: #d75fd7;">NULL</span>, thr_fn1, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread 1"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    err = pthread_join<span style="color: #d75fd7;">(</span>tid1, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span>&amp;fp<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't join with thread 1"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid2, <span style="color: #d75fd7;">NULL</span>, thr_fn2, fp<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    printfoo<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"parent:\n"</span>, fp<span style="color: #d75fd7;">)</span>;

    free<span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
11.2
</p>
<blockquote>
<p>
write-mode lock on the whole list while the ID is changing.
</p>

<p>
the thread ID between <code>job_find</code> and <code>job_remove</code> maybe changed
</p>

<p>
to solve this problem, add another mutex in struct job
</p>
</blockquote></li>
<li><p>
11.3
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig14.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-09</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    illustrates the use of reader&#8211;writer locks</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *   @todo     something need to be considered</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">j_next</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">j_prev</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>   <span style="color: #8787d7;">j_id</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">tells which thread handles this job</span>
    <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">(</span>*j_func<span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>       <span style="color: #8787d7;">q_id</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *    <span style="color: #8787d7;">q_head</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *    <span style="color: #8787d7;">q_tail</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_cond_t</span>  <span style="color: #8787d7;">q_cond</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">q_mutex</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread %lu start\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>pthread_self<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    pthread_exit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">queue_init</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">q</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">err</span>;

    q-&gt;q_id   = pthread_self<span style="color: #d75fd7;">()</span>;
    q-&gt;q_head = <span style="color: #d75fd7;">NULL</span>;
    q-&gt;q_tail = <span style="color: #d75fd7;">NULL</span>;
    err       = pthread_mutex_init<span style="color: #d75fd7;">(</span>&amp;q-&gt;q_mutex, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>err<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    err = pthread_cond_init<span style="color: #d75fd7;">(</span>&amp;q-&gt;q_cond, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pthread_mutex_destroy<span style="color: #2aa198;">(</span>&amp;q-&gt;q_mutex<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">continue initialization</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> err;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">job_insert</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">qp</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">jp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_mutex<span style="color: #d75fd7;">)</span>;

    jp-&gt;j_next = qp-&gt;q_head;
    jp-&gt;j_prev = <span style="color: #d75fd7;">NULL</span>;
    jp-&gt;j_func = thr_fn;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>qp-&gt;q_head != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
        qp-&gt;q_head-&gt;j_prev = jp;
    <span style="color: #268bd2; font-weight: bold;">else</span>
        qp-&gt;q_tail = jp;

    qp-&gt;q_head = jp;

    pthread_cond_signal<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_cond<span style="color: #d75fd7;">)</span>;
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_mutex<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">job_append</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">qp</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">jp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_mutex<span style="color: #d75fd7;">)</span>;

    jp-&gt;j_next = <span style="color: #d75fd7;">NULL</span>;
    jp-&gt;j_prev = qp-&gt;q_tail;
    jp-&gt;j_func = thr_fn;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>qp-&gt;q_tail != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
        qp-&gt;q_tail-&gt;j_next = jp;
    <span style="color: #268bd2; font-weight: bold;">else</span>
        qp-&gt;q_head = jp;

    qp-&gt;q_tail = jp;

    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_mutex<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">job_remove</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">qp</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">jp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_mutex<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>jp == qp-&gt;q_head<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        qp-&gt;q_head = jp-&gt;j_next;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>qp-&gt;q_tail == jp<span style="color: #2aa198;">)</span>
            qp-&gt;q_tail = <span style="color: #d75fd7;">NULL</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span>
            jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>jp == qp-&gt;q_tail<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        qp-&gt;q_tail         = jp-&gt;j_prev;
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
        jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #d75fd7;">}</span>

    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_mutex<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #d75fd7; font-weight: bold;">job_find</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">queue</span> *<span style="color: #8787d7;">qp</span>, <span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">job</span> *<span style="color: #8787d7;">jp</span> = <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pthread_mutex_lock<span style="color: #2aa198;">(</span>&amp;qp-&gt;q_mutex<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>jp = qp-&gt;q_head; jp; jp = jp-&gt;j_next<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>pthread_equal<span style="color: #67b11d;">(</span>id, jp-&gt;j_id<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #268bd2; font-weight: bold;">break</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;qp-&gt;q_mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>jp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>rwlock change to condition lock, and need additional mutex lock</li>
<li>data structure for each thread OR</li>
<li>if lock the whole list, the other jobs have to wait, it is the waste of time</li>
</ol></li>
<li><p>
11.4
</p>
<blockquote>
<p>
It depends on the circumstances. In general, both can be correct, but each alternative has drawbacks. In the first sequence, the waiting threads will be scheduled to run after we call pthread_cond_broadcast. If the program is running on a multiprocessor, some threads will run and immediately block because we are still holding the mutex (recall that pthread_cond_wait returns with the mutex held). In the second sequence, a running thread can acquire the mutex between steps 3 and 4, invalidate the condition, and release the mutex. Then, when we call pthread_cond_broadcast, the condition will no longer be true, and the threads will run needlessly. This is why the awakened threads must recheck the condition and not assume that it is true merely because pthread_cond_wait returned.
</p>
</blockquote></li>
<li><p>
11.5
pthread_cond &amp;&amp; counter
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     11fig16.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-10</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    show how a barrier can be used to synchronize threads cooperating</span>
<span style="color: #008787; background-color: #262626;"> * on a single task</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NTHR</span>   <span style="color: #d75fd7;">8</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NUMNUM</span> <span style="color: #d75fd7;">800000L</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">TNUM</span>   <span style="color: #268bd2;">(</span>NUMNUM / NTHR<span style="color: #268bd2;">)</span>

<span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">nums</span><span style="color: #268bd2;">[</span>NUMNUM<span style="color: #268bd2;">]</span>;
<span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">snums</span><span style="color: #268bd2;">[</span>NUMNUM<span style="color: #268bd2;">]</span>;

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>SOLARIS<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">heapsort</span> gsort
<span style="color: #d75fd7;">#elif</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>__linux__<span style="color: #268bd2;">)</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">heapsort</span> qsort
<span style="color: #d75fd7;">#else</span>
<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">heapsort</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *, <span style="color: #df005f; font-weight: bold;">size_t</span>, <span style="color: #df005f; font-weight: bold;">size_t</span>,
                    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7;">)(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>;
<span style="color: #d75fd7;">#endif</span>

<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">defined</span><span style="color: #268bd2;">(</span>__APPLE__<span style="color: #268bd2;">)</span>
<span style="color: #268bd2; font-weight: bold;">typedef</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">counter</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_cond_t</span>  <span style="color: #8787d7;">cond</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">mutex</span>;
<span style="color: #268bd2;">}</span> <span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrier_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #8787d7;">b</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">attr</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">count</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">ret</span>;

    ret = pthread_mutex_init<span style="color: #d75fd7;">(</span>&amp;b-&gt;mutex, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ret != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">err</span>;
    <span style="color: #d75fd7;">}</span>
    ret = pthread_cond_init<span style="color: #d75fd7;">(</span>&amp;b-&gt;cond, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ret != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pthread_mutex_destroy<span style="color: #2aa198;">(</span>&amp;b-&gt;mutex<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">err</span>;
    <span style="color: #d75fd7;">}</span>
    b-&gt;counter = count;

    <span style="color: #268bd2; font-weight: bold;">return</span> ret;
<span style="color: #d75fd7;">err</span>:
    <span style="color: #268bd2; font-weight: bold;">return</span> ret;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #8787d7;">b</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">ret</span> = <span style="color: #d75fd7;">0</span>;

    ret = pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;b-&gt;mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ret != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">err</span>;
    <span style="color: #d75fd7;">}</span>

    ret = pthread_mutex_destroy<span style="color: #d75fd7;">(</span>&amp;b-&gt;mutex<span style="color: #d75fd7;">)</span>;
    ret = pthread_cond_destroy<span style="color: #d75fd7;">(</span>&amp;b-&gt;cond<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> ret;
<span style="color: #d75fd7;">err</span>:
    <span style="color: #268bd2; font-weight: bold;">return</span> ret;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrier_wait</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #8787d7;">b</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">cancel</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">ret</span> = pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;b-&gt;mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ret != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">err</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>--b-&gt;counter == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pthread_cond_broadcast<span style="color: #2aa198;">(</span>&amp;b-&gt;cond<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        pthread_setcancelstate<span style="color: #2aa198;">(</span>PTHREAD_CANCEL_DISABLE, &amp;cancel<span style="color: #2aa198;">)</span>;

        pthread_cond_wait<span style="color: #2aa198;">(</span>&amp;b-&gt;cond, &amp;b-&gt;mutex<span style="color: #2aa198;">)</span>;
        pthread_setcancelstate<span style="color: #2aa198;">(</span>cancel, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;b-&gt;mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> ret;

<span style="color: #d75fd7;">err</span>:
    <span style="color: #268bd2; font-weight: bold;">return</span> ret;
<span style="color: #268bd2;">}</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">pthread_barrier_t</span> <span style="color: #8787d7;">b</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">complong</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg1</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg2</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">l1</span> = *<span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #d75fd7;">)</span>arg1;
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">l2</span> = *<span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #d75fd7;">)</span>arg2;

    <span style="color: #268bd2; font-weight: bold;">return</span> l1 == l2 ? <span style="color: #d75fd7;">0</span> : l1 &gt; l2 ? <span style="color: #d75fd7;">1</span> : -<span style="color: #d75fd7;">1</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">idx</span> = <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #d75fd7;">)</span>arg;

    heapsort<span style="color: #d75fd7;">(</span>&amp;nums<span style="color: #2aa198;">[</span>idx<span style="color: #2aa198;">]</span>, TNUM, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>, complong<span style="color: #d75fd7;">)</span>;
    pthread_barrier_wait<span style="color: #d75fd7;">(</span>&amp;b<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">merge</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">idx</span><span style="color: #d75fd7;">[</span>NTHR<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">minidx</span>, <span style="color: #8787d7;">sidx</span>, <span style="color: #8787d7;">num</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NTHR; i++<span style="color: #d75fd7;">)</span> idx<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span> = i * TNUM;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>sidx = <span style="color: #d75fd7;">0</span>; sidx &lt; NUMNUM; sidx++<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        num = LONG_MAX;
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NTHR; ++i<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>idx<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span> &lt; <span style="color: #268bd2;">(</span>i + <span style="color: #d75fd7;">1</span><span style="color: #268bd2;">)</span> * TNUM<span style="color: #875f00;">)</span> &amp;&amp; <span style="color: #875f00;">(</span>nums<span style="color: #268bd2;">[</span>idx<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span><span style="color: #268bd2;">]</span> &lt; num<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                num    = nums<span style="color: #875f00;">[</span>idx<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span><span style="color: #875f00;">]</span>;
                minidx = i;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        snums<span style="color: #2aa198;">[</span>sidx<span style="color: #2aa198;">]</span> = nums<span style="color: #2aa198;">[</span>idx<span style="color: #67b11d;">[</span>minidx<span style="color: #67b11d;">]</span><span style="color: #2aa198;">]</span>;
        idx<span style="color: #2aa198;">[</span>minidx<span style="color: #2aa198;">]</span>++;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span>  <span style="color: #8787d7;">i</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">start</span>, <span style="color: #8787d7;">end</span>;
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #df005f; font-weight: bold;">long</span>      <span style="color: #8787d7;">startusec</span>, <span style="color: #8787d7;">endusec</span>;
    <span style="color: #df005f; font-weight: bold;">double</span>         <span style="color: #8787d7;">elapsed</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>      <span style="color: #8787d7;">tid</span>;

    srandom<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NUMNUM; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        nums<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> = random<span style="color: #2aa198;">()</span>;
    <span style="color: #d75fd7;">}</span>

    gettimeofday<span style="color: #d75fd7;">(</span>&amp;start, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    pthread_barrier_init<span style="color: #d75fd7;">(</span>&amp;b, <span style="color: #d75fd7;">NULL</span>, NTHR + <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NTHR; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">func</span> = thr_fn;
        err        = pthread_create<span style="color: #2aa198;">(</span>&amp;tid, <span style="color: #d75fd7;">NULL</span>, thr_fn, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span>i * TNUM<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2aa198;">"can't create thread"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    pthread_barrier_wait<span style="color: #d75fd7;">(</span>&amp;b<span style="color: #d75fd7;">)</span>;
    merge<span style="color: #d75fd7;">()</span>;
    gettimeofday<span style="color: #d75fd7;">(</span>&amp;end, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;

    startusec = start.tv_sec * <span style="color: #d75fd7;">1000000</span> + start.tv_usec;
    endusec   = end.tv_sec * <span style="color: #d75fd7;">100000</span> + end.tv_usec;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"sort took %.4f seconds"</span>, elapsed<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NUMNUM; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%ld\n"</span>, snums<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org73e5e40" class="outline-3">
<h3 id="org73e5e40"><span class="done DONE">DONE</span> Chapter 12. Thread Control <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org73e5e40">
</div>
<div id="outline-container-orge8a5f65" class="outline-4">
<h4 id="orge8a5f65"><span class="done DONE">DONE</span> 12.1 Introduction</h4>
<div class="outline-text-4" id="text-orge8a5f65">
</div>
</div>
<div id="outline-container-org5b12dca" class="outline-4">
<h4 id="org5b12dca"><span class="done DONE">DONE</span> 12.2 Thread Limits</h4>
<div class="outline-text-4" id="text-org5b12dca">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 10:</span> Figure 12.1 Thread limits and <i>name</i> arguments to <code>sysconf</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name of limit</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left"><i>name</i> argument</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_DESTRUCTOR_ITERATIONS</td>
<td class="org-left">maximum number of times an implemetation will</td>
<td class="org-left">_SC_THREAD_DESTRUCTOR_ITERATIONS</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">try to destroy the thread-specific data</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">when a thread exits (Section 12.6)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_KEYS_MAX</td>
<td class="org-left">maximum number of keys that can be created</td>
<td class="org-left">_SC_THREAD_KEYS_MAX</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">by a process (Section 12.6)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_STACK_MIN</td>
<td class="org-left">minimum number of bytes that can be used</td>
<td class="org-left">_SC_THREAD_STACK_MIN</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">for a thread's stack (Section by 12.3)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_STACK_MAX</td>
<td class="org-left">maximum number of threads that can be created</td>
<td class="org-left">_SC_THREAD_STACK_MAX</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">in a process (Section 12.3)</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org3e68586" class="outline-4">
<h4 id="org3e68586"><span class="done DONE">DONE</span> 12.3 Thread Attributes</h4>
<div class="outline-text-4" id="text-org3e68586">
<blockquote>
<ol class="org-ol">
<li>Each object is associated with its own type of attribute object (threads with thread attributes, mutexes with mutex attributes, and so on).</li>

<li>An initialization function exists to set the attributes to their default values.</li>

<li>Another function exists to destroy the attributes object.</li>

<li>Each attribute has a function to get the value of the attribute from the attribute object.</li>

<li>Each attribute has a function to set the value of the attribute.</li>
</ol>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_attr_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_attr_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
attributes:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 11:</span> Figure 12.3 POSIX.1 thread attributes</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><i>detachstate</i></td>
<td class="org-left">detached threada attribute</td>
</tr>

<tr>
<td class="org-left"><i>guardsize</i></td>
<td class="org-left">guard buffer size in bytes at end of thread stack</td>
</tr>

<tr>
<td class="org-left"><i>stackaddr</i></td>
<td class="org-left">lowest address of thread stack</td>
</tr>

<tr>
<td class="org-left"><i>stacksize</i></td>
<td class="org-left">minimum size in bytes of thread stack</td>
</tr>
</tbody>
</table>

<p>
detachstate:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_attr_getdetachstate</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">ptrhead_attr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                                <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #8787d7;">detachstate</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_attr_setdetachstate</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #8787d7;">attr</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">detachstate</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<code>PTHREAD_CREATE_DETACHED</code> or <code>PTHREAD_CREATE_JOINABLE</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 99: </span>Figure 12.4 Creating a thread in the detached state</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     12fig04.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-15</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    create a thread in the detached state</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">makethread</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">fn</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>      <span style="color: #8787d7;">tid</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> <span style="color: #8787d7;">attr</span>;

    err = pthread_attr_init<span style="color: #d75fd7;">(</span>&amp;attr<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>err<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    err = pthread_attr_setdetachstate<span style="color: #d75fd7;">(</span>&amp;attr, PTHREAD_CREATE_DETACHED<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err = pthread_create<span style="color: #2aa198;">(</span>&amp;tid, &amp;attr, fn, arg<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_attr_destroy<span style="color: #d75fd7;">(</span>&amp;attr<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> err;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>

<p>
stack:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_attr_getstack</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                          <span style="color: #df005f; font-weight: bold;">void</span> **<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">stackattr</span>,
                          <span style="color: #df005f; font-weight: bold;">size_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">stacksize</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_attr_setstack</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #8787d7;">attr</span>,
                          <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">stackaddr</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">stacksize</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
guardsize:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_attr_getguardsize</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                              <span style="color: #df005f; font-weight: bold;">size_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">guardsize</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_attr_setguardsize</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #8787d7;">attr</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">guardsize</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
Threads have other attributes not represented by the pthread_attr_t structure: the cancelability state and the cancelability type.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgaf84f26" class="outline-4">
<h4 id="orgaf84f26"><span class="done DONE">DONE</span> 12.4 Synchronization Attributes <code>[4/4]</code></h4>
<div class="outline-text-4" id="text-orgaf84f26">
</div>
<ul class="org-ul">
<li><a id="org501cf18"></a><span class="done DONE">DONE</span> 12.4.1 Mutex Attributes<br />
<div class="outline-text-5" id="text-org501cf18">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutexattr_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutexattr_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutexattr</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutexattr_getpshared</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                                 <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">pshared</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutexattr_setpshared</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #8787d7;">attr</span>,
                                 <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">pshared</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
default: <code>PTHREAD_PROCESS_PRIVATE</code>
</p>
<blockquote>
<p>
multiple threads can access the same synchronization object
</p>
</blockquote>
<p>
other: <code>PTHREAD_PROCESS_SHARED</code>
</p>
<blockquote>
<p>
a mutex allocated from a memory extent shared between multiple processes may be used for synchronization by those processes.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutexattr_getrobust</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                                <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">robust</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutexattr_setrobust</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #8787d7;">attr</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">robust</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
default: <code>PTHREAD_MUTEX_STALLED</code>
</p>
<blockquote>
<p>
use of the mutex can result in undefined behavior, and applications waiting for it to be unlocked are effectively "stalled".
</p>
</blockquote>
<p>
other:   <code>PTHREAD_MUTEX_ROBUST</code>
</p>
<blockquote>
<p>
This value will cause a thread blocked in a call to pthread_mutex_lock to acquire the lock when another process holding the lock terminates without first unlocking it, but the return value from pthread_mutex_lock is EOWNERDEAD instead of 0.
</p>
</blockquote>

<p>
<b>Using robust mutexes has to check for three return values instead of two</b>:
</p>
<ul class="org-ul">
<li>success with no recovery</li>
<li>success but recovery needj</li>
<li>failure</li>
</ul>


<p>
for application can't be recovered to indicate that the state associated with the mutex is consistent before unlocking the mutex.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutex_consistent</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #8787d7;">mutex</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 12:</span> mutex types</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_MUTEX_NORMAL</td>
<td class="org-left">doesn't do any special error checking or deadlock detection</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_ERRORCHECK</td>
<td class="org-left">provides error checking</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_RECURSIVE</td>
<td class="org-left">allow the same thread to lock multiple times without first unlocking</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_DEFAULT</td>
<td class="org-left">prividing default characteristics and behavior.</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 13:</span> Figure 12.5 Mutex type behavior</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Mutex type</th>
<th scope="col" class="org-left">Relock without unlock?</th>
<th scope="col" class="org-left">Unlock when not owned?</th>
<th scope="col" class="org-left">Unlock when unlocked?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_MUTEX_NORMAL</td>
<td class="org-left">deadlock</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_ERRORCHECK</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_RECURSIVE</td>
<td class="org-left">allowed</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_DEFAULT</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutexattr_gettype</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                              <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">type</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_mutexattr_settype</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">type</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
If a recursive mutex is locked multiple times and used in a call to pthread_cond_wait, the condition can never be satisfied, because the unlock done by pthread_cond_wait doesn’t release the mutex.
</p>

<p>
should be used only when no other solution is possible.
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 100: </span>Figure 12.8 Using a recursive mutex</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     fig.8.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-15</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Using a recursive mutex</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/time.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">makethread</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #268bd2;">)</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*to_fn<span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span>;    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">function</span>
    <span style="color: #df005f; font-weight: bold;">void</span> *          <span style="color: #8787d7;">to_arg</span>;   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">argument</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> <span style="color: #8787d7;">to_wait</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">time to wait</span>
<span style="color: #268bd2;">}</span>;

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">SECTONSEC</span> <span style="color: #d75fd7;">1000000000</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">seconds to nanoseconds</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">clock_nanosleep</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">ID</span>, <span style="color: #8787d7;">FL</span>, <span style="color: #8787d7;">REQ</span>, <span style="color: #8787d7;">REM</span><span style="color: #268bd2;">)</span> nanosleep<span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>REQ<span style="color: #d75fd7;">)</span>, <span style="color: #d75fd7;">(</span>REM<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #d75fd7;">#if</span><span style="color: #d75fd7;">n</span><span style="color: #d75fd7;">def</span> CLOCK_REALTIME
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">CLOCK_REALTIME</span> <span style="color: #d75fd7;">0</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">USECTONSEC</span>     <span style="color: #d75fd7;">1000</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">microseconds to nanoseconds</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">clock_gettime</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">id</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #8787d7;">tsp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">tv</span>;

    gettimeofday<span style="color: #d75fd7;">(</span>&amp;tv, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    tsp-&gt;tv_sec  = tv.tv_sec;
    tsp-&gt;tv_nsec = tv.tv_usec * USECTONSEC
<span style="color: #268bd2;">}</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">timeout_helper</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span> *<span style="color: #8787d7;">tip</span>;

    tip = <span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span> *<span style="color: #d75fd7;">)</span>arg;
    clock_nanosleep<span style="color: #d75fd7;">(</span>CLOCK_REALTIME, <span style="color: #d75fd7;">0</span>, &amp;tip-&gt;to_wait, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #d75fd7;">(</span>*tip-&gt;to_fn<span style="color: #d75fd7;">)(</span>tip-&gt;to_arg<span style="color: #d75fd7;">)</span>;
    free<span style="color: #d75fd7;">(</span>arg<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">timeout</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #8787d7;">when</span>, <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">func</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> <span style="color: #8787d7;">now</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span> *<span style="color: #8787d7;">tip</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">err</span>;

    clock_gettime<span style="color: #d75fd7;">(</span>CLOCK_REALTIME, &amp;now<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>when-&gt;tv_sec &gt; now.tv_sec<span style="color: #2aa198;">)</span> ||
        <span style="color: #2aa198;">(</span>when-&gt;tv_sec == now.tv_sec &amp;&amp; when-&gt;tv_nsec &gt; now.tv_nsec<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        tip = malloc<span style="color: #2aa198;">(</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>tip != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            tip-&gt;to_fn          = func;
            tip-&gt;to_arg         = arg;
            tip-&gt;to_wait.tv_sec = when-&gt;tv_sec - now.tv_sec;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>when-&gt;tv_nsec &gt;= now.tv_nsec<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_nsec = when-&gt;tv_nsec - now.tv_nsec;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_sec--;
                tip-&gt;to_wait.tv_nsec = SECTONSEC - now.tv_nsec + when-&gt;tv_nsec;
            <span style="color: #67b11d;">}</span>

            <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">err = makethread(timeout_helper, (void *)tip);</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>err == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #268bd2; font-weight: bold;">return</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                free<span style="color: #875f00;">(</span>tip<span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #d75fd7;">(</span>*func<span style="color: #d75fd7;">)(</span>arg<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #8787d7;">attr</span>;
<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span>     <span style="color: #8787d7;">mutex</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">retry</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;mutex<span style="color: #d75fd7;">)</span>;

    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;mutex<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">err</span> = <span style="color: #d75fd7;">0</span>, <span style="color: #8787d7;">condition</span> = <span style="color: #d75fd7;">0</span>, <span style="color: #8787d7;">arg</span> = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> <span style="color: #8787d7;">when</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutexattr_init<span style="color: #67b11d;">(</span>&amp;attr<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"pthread_mutexattr_init failed"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutexattr_settype<span style="color: #67b11d;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> !=
        <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't set recursive type"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;mutex, &amp;attr<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create recursive mutex"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>condition == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        clock_gettime<span style="color: #2aa198;">(</span>CLOCK_REALTIME, &amp;when<span style="color: #2aa198;">)</span>;
        when.tv_sec += <span style="color: #d75fd7;">10</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">10 seconds after now</span>
        timeout<span style="color: #2aa198;">(</span>&amp;when, retry, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span><span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #875f00;">)</span>arg<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;mutex<span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org117082d"></a><span class="done DONE">DONE</span> 12.4.2 Reader-Writer Lock Attributes<br />
<div class="outline-text-5" id="text-org117082d">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlockattr_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlockattr_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlockattr_getpshared</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                                  <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #8787d7;">restirct</span> pshared<span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_rwlockattr_setpshared</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                                  <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">pshared</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>
<li><a id="org49b08e8"></a><span class="done DONE">DONE</span> 12.4.3 Condition Variable Attributes<br />
<div class="outline-text-5" id="text-org49b08e8">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_condattr_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_condattr_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_condattr_getpshared</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_condattr_t</span> <span style="color: #268bd2; font-weight: bold;">const</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                                <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">pshared</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_condattr_setpshared</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #8787d7;">attr</span>,
                                <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">pshared</span><span style="color: #268bd2;">)</span>; ;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_condattr_getclock</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                              <span style="color: #df005f; font-weight: bold;">clockid_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">clock_id</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_condattr_setclock</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #8787d7;">attr</span>,
                              <span style="color: #df005f; font-weight: bold;">clockid_t</span> <span style="color: #8787d7;">clock_id</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>
<li><a id="orgd0df2fb"></a><span class="done DONE">DONE</span> 12.4.4 Barrier Attributes<br />
<div class="outline-text-5" id="text-orgd0df2fb">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrierattr_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrierattr_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #8787d7;">attr</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrierattr_getpshared</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">attr</span>,
                                   <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">pshared</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_barrierattr_setpshared</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #8787d7;">attr</span>,
                                   <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">pshared</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-org3cfca7e" class="outline-4">
<h4 id="org3cfca7e"><span class="done DONE">DONE</span> 12.5 Reentrancy</h4>
<div class="outline-text-4" id="text-org3cfca7e">
<blockquote>
<p>
If a function can be safely called by multiple threads at the same time, we say that the function is thread-safe.
</p>

<p>
<i>thread-safe</i> version of functions with an _r appended at the end of its name
</p>
</blockquote>

<p>
lock associated with a given FILE object
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sstdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">ftrylockfile</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, nonzero if lock can't be acquired</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">flockfile</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">funlockfile</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<p>
I/O routines might be implemented to be thread-safe, but locking applications is still useful
</p>


<p>
lock associated with character-based standard I/O
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">getchar_unlcoked</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">getc_unlcoked</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: the next character if OK, EOF on the end of file or error</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">putchar_unlocked</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">c</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">putc_unlcoked</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">c</span>, <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: c if OK, EOF on error</span>
</pre>
</div>
<blockquote>
<p>
<b>These four functions should not be called unless they are surrounded by calls to flockfile (or ftrylockfile) and funlockfile</b>
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 101: </span>Figure 12.11 A nonreentrant version of getenv</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     12fig11.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-17</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    a possible implementation of getenv</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">string.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MAXSTRINGSZ</span> <span style="color: #d75fd7;">4096</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">envbuf</span><span style="color: #268bd2;">[</span>MAXSTRINGSZ<span style="color: #268bd2;">]</span>;

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">environ</span>;

<span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #d75fd7; font-weight: bold;">getenv</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">len</span>;

    len = strlen<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; environ<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> != <span style="color: #d75fd7;">NULL</span>; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #875f00;">(</span>name, environ<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>, len<span style="color: #875f00;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len<span style="color: #875f00;">]</span> == <span style="color: #2aa198;">'='</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            strncpy<span style="color: #67b11d;">(</span>envbuf, &amp;environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len + <span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, MAXSTRINGSZ - <span style="color: #d75fd7;">1</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 102: </span>Figure 12.12 a reentrant (thread-safe) version of getenv</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     12fig12.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-17</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    a reentrant version of getenv</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">string.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">environ</span>;

<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">env_mutex</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">pthread_once_t</span> <span style="color: #8787d7;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">thread_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #8787d7;">attr</span>;

    pthread_mutexattr_init<span style="color: #d75fd7;">(</span>&amp;attr<span style="color: #d75fd7;">)</span>;
    pthread_mutexattr_settype<span style="color: #d75fd7;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #d75fd7;">)</span>;
    pthread_mutex_init<span style="color: #d75fd7;">(</span>&amp;env_mutex, &amp;attr<span style="color: #d75fd7;">)</span>;
    pthread_mutexattr_destroy<span style="color: #d75fd7;">(</span>&amp;attr<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">getenv_r</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">buf</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">buflen</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">len</span>, <span style="color: #8787d7;">olen</span>;

    pthread_once<span style="color: #d75fd7;">(</span>&amp;init_done, thread_init<span style="color: #d75fd7;">)</span>;
    len = strlen<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; environ<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> != <span style="color: #d75fd7;">NULL</span>; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #875f00;">(</span>name, environ<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>, len<span style="color: #875f00;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len<span style="color: #875f00;">]</span> == <span style="color: #2aa198;">'='</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            olen = strlen<span style="color: #67b11d;">(</span>&amp;environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len + <span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>olen &gt;= buflen<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                pthread_mutex_unlock<span style="color: #875f00;">(</span>&amp;env_mutex<span style="color: #875f00;">)</span>;
                pthread_mutex_destroy<span style="color: #875f00;">(</span>&amp;env_mutex<span style="color: #875f00;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #875f00;">(</span>ENOSPC<span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            strcpy<span style="color: #67b11d;">(</span>buf, &amp;environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len + <span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            pthread_mutex_destroy<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    pthread_mutex_destroy<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>ENOENT<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org2028d10" class="outline-4">
<h4 id="org2028d10"><span class="done DONE">DONE</span> 12.6 Thread-Specific Data</h4>
<div class="outline-text-4" id="text-org2028d10">
<blockquote>
<p>
Thread-specific data, also known as thread-private data, is a mechanism for storing and finding data associated with a particular thread
</p>

<p>
The reasons to prevent sharing process data and attributes
</p>
<ul class="org-ul">
<li>First, sometimes we need to maintain data on a per-thread basis.</li>
<li>The second reason for thread-private data is to provide a mechanism for adapting process-based interfaces to a multithreaded environment.</li>
</ul>
</blockquote>

<p>
crate a <i>key</i> to gain acess to with the thread-specific data
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_key_create</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_key_t</span> *<span style="color: #8787d7;">keyp</span>, <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">destructor</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
break the association of a key with the thread-specific data
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_key_delete</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_key_t</span> <span style="color: #8787d7;">key</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<blockquote>
<p>
<b>calling pthread_key_delete will not invoke the destructor function. To free a key:</b>
ensure a key we allocated doesn't change because of a race during initialization. Code like the following can result in two threads both calling <code>pthread_key_create</code>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">destructor</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">pthread_key_t</span> <span style="color: #8787d7;">key</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">init_done</span> = <span style="color: #d75fd7;">0</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">threadfunc</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">!</span>init_done<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    init_done = <span style="color: #d75fd7;">1</span>;
    err = pthread_key_create<span style="color: #2aa198;">(</span>&amp;key, destructor<span style="color: #2aa198;">)</span>;
  <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<p>
The proper way to create a key without a race is as follows:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">destructor</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">pthread_key_t</span> <span style="color: #8787d7;">key</span>;
<span style="color: #df005f; font-weight: bold;">pthread_once_t</span> <span style="color: #8787d7;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">thread_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
  err = pthread_key_create<span style="color: #d75fd7;">(</span>&amp;key, destructor<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">threadfunc</span> <span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
  pthread_once<span style="color: #d75fd7;">(</span>&amp;init_done, thread_init<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 103: </span>Figure 12.13 A thread-safe, compatible version of getenv</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     12fig13.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-17</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    a hypothetical implementation of getenv</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">string.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MAXSTRINGSZ</span> <span style="color: #d75fd7;">4096</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">pthread_key_t</span>  <span style="color: #8787d7;">key</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">pthread_once_t</span> <span style="color: #8787d7;">init_done</span> = PTHREAD_ONCE_INIT;
<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span>       <span style="color: #8787d7;">env_mutex</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">environ</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">thread_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> pthread_key_create<span style="color: #d75fd7;">(</span>&amp;key, free<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #d75fd7; font-weight: bold;">getenv</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">len</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">envbuf</span>;

    pthread_once<span style="color: #d75fd7;">(</span>&amp;init_done, thread_init<span style="color: #d75fd7;">)</span>;
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    envbuf = <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #d75fd7;">)</span>pthread_getspecific<span style="color: #d75fd7;">(</span>key<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>envbuf == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        envbuf = malloc<span style="color: #2aa198;">(</span>MAXSTRINGSZ<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>envbuf == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">nil</span>;
        <span style="color: #2aa198;">}</span>
        pthread_setspecific<span style="color: #2aa198;">(</span>key, envbuf<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    len = strlen<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; environ<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> != <span style="color: #d75fd7;">NULL</span>; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #875f00;">(</span>name, environ<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>, len<span style="color: #875f00;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len<span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span> == <span style="color: #2aa198;">'='</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            snprintf<span style="color: #67b11d;">(</span>envbuf, MAXSTRINGSZ - <span style="color: #d75fd7;">1</span>, <span style="color: #2aa198;">"%s"</span>, &amp;environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len + <span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

<span style="color: #d75fd7;">nil</span>:
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4cb9df1" class="outline-4">
<h4 id="org4cb9df1"><span class="done DONE">DONE</span> 12.7 Cancel Options</h4>
<div class="outline-text-4" id="text-org4cb9df1">
<blockquote>
<p>
The <i>cancelability state</i> attribute can be either PTHREAD_CANCEL_ENABLE or PTHREAD_CANCEL_DISABLE.
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_setcancelstate</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">state</span>, <span style="color: #df005f; font-weight: bold;">int</span>* <span style="color: #8787d7;">oldstate</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
a call to pthread_cancel doesn’t wait for a thread to terminate. In the default case, a thread will continue to execute after a cancellation request is made until the thread reaches a cancellation point.
</p>


<p>
When the state is set to PTHREAD_CANCEL_DISABLE, a call to pthread_cancel will not kill the thread. Instead, the cancellation request remains pending for the thread. When the state is enabled again, the thread will act on any pending cancellation requests at the next cancellation point.
</p>
</blockquote>

<p>
add you own cancellation points
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">pthread_testcancel</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<p>
Cancel the pending and enbaled cancellation request, no effect when cancellation is disabled.
</p>

<p>
change the cancellation type
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_setcanceltype</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">type</span>, <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #8787d7;">oldtype</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
type: PTHREAD_CANCEL_DEFERRED, PTHREAD_CANCEL_ASYNCHRONOUS
</p>
</div>
</div>
<div id="outline-container-org7e90f92" class="outline-4">
<h4 id="org7e90f92"><span class="done DONE">DONE</span> 12.8 Threads and Signals</h4>
<div class="outline-text-4" id="text-org7e90f92">
<p>
function like <code>sigprocmask</code>, but works with threads and returns error number instead:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_sigmask</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">how</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">set</span>,
                    <span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">oset</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
how values:
</p>
<ul class="org-ul">
<li>SIG_BLOCK</li>
<li>SIG_SETMASK</li>
<li><p>
SIG_UNBLOCK
</p>

<p>
wait one or more signals:
</p></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sigwait</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">siget_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">set</span>, <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">signop</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
function like <code>kill</code>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">signal.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_kill</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">thread</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 104: </span>Figure 12.16 Synchronous signal handling</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     12fig16.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-27</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes81 <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    threads protect flag via mutex</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span>      <span style="color: #8787d7;">quitflag</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">set nonzero by thread</span>
<span style="color: #df005f; font-weight: bold;">sigset_t</span> <span style="color: #8787d7;">mask</span>;

<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">lock</span>    = PTHREAD_MUTEX_INITIALIZER;
<span style="color: #df005f; font-weight: bold;">pthread_cond_t</span>  <span style="color: #8787d7;">waitloc</span> = PTHREAD_COND_INITIALIZER;

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">err</span>, <span style="color: #8787d7;">signo</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err = sigwait<span style="color: #2aa198;">(</span>&amp;mask, &amp;signo<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2aa198;">"sigwait failed"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #2aa198;">(</span>signo<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">case</span> SIGINT:
                printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"\ninterrupt\n"</span><span style="color: #67b11d;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;

            <span style="color: #268bd2; font-weight: bold;">case</span> SIGQUIT:
                pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock<span style="color: #67b11d;">)</span>;
                quitflag = <span style="color: #d75fd7;">1</span>;
                pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock<span style="color: #67b11d;">)</span>;
                pthread_cond_signal<span style="color: #67b11d;">(</span>&amp;waitloc<span style="color: #67b11d;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;

            <span style="color: #268bd2; font-weight: bold;">default</span>:
                printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"unexpected signal %s\n"</span>, strsignal<span style="color: #875f00;">(</span>signo<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span>;
                exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>       <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">sigset_t</span>  <span style="color: #8787d7;">oldmask</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid</span>;

    sigemptyset<span style="color: #d75fd7;">(</span>&amp;mask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;mask, SIGINT<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;mask, SIGQUIT<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_sigmask<span style="color: #67b11d;">(</span>SIG_BLOCK, &amp;mask, &amp;oldmask<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"SIG_BLOCK error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid, <span style="color: #d75fd7;">NULL</span>, thr_fn, <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;lock<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>quitflag == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        pthread_cond_wait<span style="color: #2aa198;">(</span>&amp;waitloc, &amp;lock<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;lock<span style="color: #d75fd7;">)</span>;

    quitflag = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigprocmask<span style="color: #2aa198;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"SIG_SETMASK error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org0e949d4" class="outline-4">
<h4 id="org0e949d4"><span class="done DONE">DONE</span> 12.9 Threads and fork</h4>
<div class="outline-text-4" id="text-org0e949d4">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pthread_atfork</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">prepare</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #d75fd7;">)</span>, <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">parent</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #d75fd7;">)</span>,
                   <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">child</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><b>prepare</b> called before <code>fork</code> creates the child process</li>
<li><b>parent</b> called in parent after <code>fork</code> has created the child but before returned</li>
<li><b>child</b> called in child before returning</li>
</ul>


<p>
<b>the child will get a copy of all locks that the parent defined, but in new memory</b>
</p>
<ol class="org-ol">
<li>The parent acquired all its locks.</li>
<li>The child acquired all its locks.</li>
<li>The parent released its locks.</li>
<li>The child relased its locks.</li>
</ol>


<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 105: </span>Figure 12.17 pthread_atfork example</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     12fig17.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-27</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes81 <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    pthread_atfork example</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">lock1</span> = PTHREAD_MUTEX_INITIALIZER;
<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">lock2</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">prepare</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">err</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"preparing locks ...\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_cont<span style="color: #d75fd7;">(</span>err, <span style="color: #2aa198;">"can't lock lock1 in the prepare handler"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_cont<span style="color: #d75fd7;">(</span>err, <span style="color: #2aa198;">"can't lock lock2 in the prepare handler"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">parent</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">err</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"parent unlocking locks...\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_cont<span style="color: #d75fd7;">(</span>err, <span style="color: #2aa198;">"can't unlock lock1 in parent handler"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_cont<span style="color: #d75fd7;">(</span>err, <span style="color: #2aa198;">"can't unlock lock2 in parent handler"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">child</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">err</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"child unlocking locks...\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_cont<span style="color: #d75fd7;">(</span>err, <span style="color: #2aa198;">"can't unlock lock1 in child handler"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_cont<span style="color: #d75fd7;">(</span>err, <span style="color: #2aa198;">"can't unlock lock2 in child handler"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"thread started...\n"</span><span style="color: #d75fd7;">)</span>;
    pause<span style="color: #d75fd7;">()</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>       <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span>     <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span> <span style="color: #8787d7;">tid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_atfork<span style="color: #67b11d;">(</span>prepare, parent, child<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_exit<span style="color: #d75fd7;">(</span>err, <span style="color: #2aa198;">"can't install fork handlers"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_create<span style="color: #67b11d;">(</span>&amp;tid, <span style="color: #d75fd7;">NULL</span>, thr_fn, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_exit<span style="color: #d75fd7;">(</span>err, <span style="color: #2aa198;">"can't create thread"</span><span style="color: #d75fd7;">)</span>;

    sleep<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"parent about to fork...\n"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #d75fd7;">(</span>fork<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">case</span> -<span style="color: #d75fd7;">1</span>:
            err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork failed"</span><span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #d75fd7;">0</span>:
            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"child returned from fork\n"</span><span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">default</span>:
            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"parent returned from fork\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>


<p>
<b>drawbacks</b>:
</p>
<blockquote>
<ul class="org-ul">
<li>no good way to reinitialize the state for more complex synchronization like conditioon and barriers.</li>
<li>some implementations of error-checking mutexes will generate errors when the child fork handler tries to unlock a mutex that was locked by the parent</li>
<li>recursive mutexes can't be cleand up in the child fork handler, because there is no way to determine the number of times one has been locked</li>
<li>if child process are allowed to call only async-singal safe functions, then the child fork handler shouldn't even be able to clean up synchronization objects, because none of the functions are used to manipulate them are async-signal safe.</li>
<li>if an application calls fork in a signal handler(which is legal, because fork is async-signal safe), then the fork handlers registered by <code>pthread_atfork</code> can only async-signal safe functions, or else the results are undefined.</li>
</ul>
</blockquote>
</div>
</div>

<div id="outline-container-org1a67823" class="outline-4">
<h4 id="org1a67823"><span class="done DONE">DONE</span> 12.10 Threads and I/O</h4>
<div class="outline-text-4" id="text-org1a67823">
<p>
use <code>pread/pwrite</code> in Chapter 3 to solve I/O at different record
</p>
</div>
</div>
<div id="outline-container-orgd288d81" class="outline-4">
<h4 id="orgd288d81"><span class="done DONE">DONE</span> 12.11 Summary</h4>
<div class="outline-text-4" id="text-orgd288d81">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
12.1 there are duplicated prints in the file
</p>
<blockquote>
<p>
This is not a multithreading problem, as one might first guess. The standard I/O routines are indeed thread-safe. When we call fork, each process gets a copy of the standard I/O data structures. When we run the program with standard output attached to a terminal, the output is line buffered, so every time we print a line, the standard I/O library writes it to our terminal. However, if we redirect the standard output to a file, then the standard output is fully buffered. The output is written when the buffer fills or the process closes the stream. When we fork in this example, the buffer contains several printed lines not yet written, so when the parent and the child finally flush their copies of the buffer, the initial duplicate contents are written to the file.
</p>
</blockquote></li>
<li><p>
12.2 reentrant version of <code>putenv</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex12.2.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    a thread-safe reentrant version of putenv</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">string.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">environ</span>;

<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span> <span style="color: #8787d7;">env_mutex</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">pthread_once_t</span> <span style="color: #8787d7;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">thread_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #8787d7;">attr</span>;

    pthread_mutexattr_init<span style="color: #d75fd7;">(</span>&amp;attr<span style="color: #d75fd7;">)</span>;
    pthread_mutexattr_settype<span style="color: #d75fd7;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #d75fd7;">)</span>;
    pthread_mutex_init<span style="color: #d75fd7;">(</span>&amp;env_mutex, &amp;attr<span style="color: #d75fd7;">)</span>;
    pthread_mutexattr_destroy<span style="color: #d75fd7;">(</span>&amp;attr<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">putenv_r</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">val</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">len</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">buf</span> = <span style="color: #d75fd7;">NULL</span>;

    pthread_once<span style="color: #d75fd7;">(</span>&amp;init_done, thread_init<span style="color: #d75fd7;">)</span>;
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;

    setenv<span style="color: #d75fd7;">(</span>name, val, <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    pthread_mutex_destroy<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
12.3 a signal-blocked version of getenv
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     12fig13.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-17</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    a signal-blocked version of getenv</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">string.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MAXSTRINGSZ</span> <span style="color: #d75fd7;">4096</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">pthread_key_t</span>  <span style="color: #8787d7;">key</span>;
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">pthread_once_t</span> <span style="color: #8787d7;">init_done</span> = PTHREAD_ONCE_INIT;
<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span>       <span style="color: #8787d7;">env_mutex</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">environ</span>;

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">thread_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> pthread_key_create<span style="color: #d75fd7;">(</span>&amp;key, free<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #d75fd7; font-weight: bold;">getenv</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>       <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">len</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>     *<span style="color: #8787d7;">envbuf</span>;
    <span style="color: #df005f; font-weight: bold;">sigset_t</span>  <span style="color: #8787d7;">mask</span>, <span style="color: #8787d7;">omask</span>;

    sigfillset<span style="color: #d75fd7;">(</span>&amp;mask<span style="color: #d75fd7;">)</span>;
    sigprocmask<span style="color: #d75fd7;">(</span>SIG_BLOCK, &amp;mask, &amp;omask<span style="color: #d75fd7;">)</span>;

    pthread_once<span style="color: #d75fd7;">(</span>&amp;init_done, thread_init<span style="color: #d75fd7;">)</span>;
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    envbuf = <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #d75fd7;">)</span>pthread_getspecific<span style="color: #d75fd7;">(</span>key<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>envbuf == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        envbuf = malloc<span style="color: #2aa198;">(</span>MAXSTRINGSZ<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>envbuf == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">nil</span>;
        <span style="color: #2aa198;">}</span>
        pthread_setspecific<span style="color: #2aa198;">(</span>key, envbuf<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    len = strlen<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; environ<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span> != <span style="color: #d75fd7;">NULL</span>; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #875f00;">(</span>name, environ<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>, len<span style="color: #875f00;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len<span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span> == <span style="color: #2aa198;">'='</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            snprintf<span style="color: #67b11d;">(</span>envbuf, MAXSTRINGSZ - <span style="color: #d75fd7;">1</span>, <span style="color: #2aa198;">"%s"</span>, &amp;environ<span style="color: #875f00;">[</span>i<span style="color: #875f00;">][</span>len + <span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;

            sigprocmask<span style="color: #67b11d;">(</span>SIG_SETMASK, &amp;omask, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

<span style="color: #d75fd7;">nil</span>:
    sigprocmask<span style="color: #d75fd7;">(</span>SIG_SETMASK, &amp;omask, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;env_mutex<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<blockquote>
<p>
The problem is that we don’t know whether any of the functions we call might unmask a signal that we’ve blocked, thereby making it possible for the function to be reentered through another signal handler.
</p>
</blockquote></li>
<li><p>
12.4 just copied the answer
</p>
<blockquote>
<p>
On FreeBSD 8.0, the program drops core. With gdb, we are able to see that the program initialization calls pthread functions, which call getenv to find the value of the LIBPTHREAD_SPINLOOPS and LIBPTHREAD_YIELDLOOPS environment variables. However, our thread-safe version of getenv calls back into the pthread library while it is in an intermediate, inconsistent state. In addition, the thread initialization functions call malloc, which, in turn, call getenv to find the value of the MALLOC_OPTIONS environment variable.
</p>

<p>
To get around this problem, we could make the reasonable assumption that program start-up is single threaded, and use a flag to indicate whether the thread initialization had been completed by our version of getenv. While this flag is false, our version of getenv can operate as the non-reentrant version does (and avoid all calls to pthread functions and malloc). Then we could provide a separate initialization function to call pthread_once, instead of calling it from inside getenv. This requires that the program call our initialization function before calling getenv. This solves our problem, because this can’t be done until the program start-up initialization completes. After the program calls our initialization function, our version of getenv operates in a thread-safe manner.
</p>
</blockquote></li>
<li>12.5 run a program within a program</li>
<li><p>
12.6 implemented sleep by using select
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     10.29.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-10-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    implementation of sleep using select</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sleep</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">seconds</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">slept</span>;
    <span style="color: #df005f; font-weight: bold;">time_t</span>         <span style="color: #8787d7;">start</span>, <span style="color: #8787d7;">end</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">tv</span>;

    tv.tv_sec  = seconds;
    tv.tv_usec = <span style="color: #d75fd7;">0</span>;

    time<span style="color: #d75fd7;">(</span>&amp;start<span style="color: #d75fd7;">)</span>;
    n = select<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span>, &amp;tv<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>n == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
    <span style="color: #d75fd7;">}</span>
    time<span style="color: #d75fd7;">(</span>&amp;end<span style="color: #d75fd7;">)</span>;
    slept = end - start;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>slept &gt;= seconds<span style="color: #d75fd7;">)</span> <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> seconds - slept;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>12.7 unsafe to do that, because we hardly acquire and release the mutex protected condition variable</li>
<li><p>
12.8 use select instead?
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     fig.8.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-15</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Using a recursive mutex</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/time.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">makethread</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #268bd2;">)</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*to_fn<span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span>;   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">function</span>
    <span style="color: #df005f; font-weight: bold;">void</span> *         <span style="color: #8787d7;">to_arg</span>;   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">argument</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">to_wait</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">time to wait</span>
<span style="color: #268bd2;">}</span>;

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">SECTOUSEC</span> <span style="color: #d75fd7;">1000000</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">seconds to nanoseconds</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">clock_nanosleep</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">ID</span>, <span style="color: #8787d7;">FL</span>, <span style="color: #8787d7;">REQ</span>, <span style="color: #8787d7;">REM</span><span style="color: #268bd2;">)</span> nanosleep<span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>REQ<span style="color: #d75fd7;">)</span>, <span style="color: #d75fd7;">(</span>REM<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>

<span style="color: #d75fd7;">#if</span><span style="color: #d75fd7;">n</span><span style="color: #d75fd7;">def</span> CLOCK_REALTIME
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">CLOCK_REALTIME</span> <span style="color: #d75fd7;">0</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">USECTONSEC</span>     <span style="color: #d75fd7;">1000</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">microseconds to nanoseconds</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">clock_gettime</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">id</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #8787d7;">tsp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">tv</span>;

    gettimeofday<span style="color: #d75fd7;">(</span>&amp;tv, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    tsp-&gt;tv_sec  = tv.tv_sec;
    tsp-&gt;tv_nsec = tv.tv_usec * USECTONSEC
<span style="color: #268bd2;">}</span>
<span style="color: #d75fd7;">#endif</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">timeout_helper</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span> *<span style="color: #8787d7;">tip</span>;

    tip = <span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span> *<span style="color: #d75fd7;">)</span>arg;
    clock_nanosleep<span style="color: #d75fd7;">(</span>CLOCK_REALTIME, <span style="color: #d75fd7;">0</span>, &amp;tip-&gt;to_wait, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #d75fd7;">(</span>*tip-&gt;to_fn<span style="color: #d75fd7;">)(</span>tip-&gt;to_arg<span style="color: #d75fd7;">)</span>;
    free<span style="color: #d75fd7;">(</span>arg<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">timeout</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #8787d7;">when</span>, <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*<span style="color: #d75fd7; font-weight: bold;">func</span><span style="color: #d75fd7;">)(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7;">)</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> <span style="color: #8787d7;">now</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span> *<span style="color: #8787d7;">tip</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">err</span>;

    clock_gettime<span style="color: #d75fd7;">(</span>CLOCK_REALTIME, &amp;now<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>when-&gt;tv_sec &gt; now.tv_sec<span style="color: #2aa198;">)</span> ||
        <span style="color: #2aa198;">(</span>when-&gt;tv_sec == now.tv_sec &amp;&amp; when-&gt;tv_nsec &gt; now.tv_nsec<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        tip = malloc<span style="color: #2aa198;">(</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">to_info</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>tip != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            tip-&gt;to_fn          = func;
            tip-&gt;to_arg         = arg;
            tip-&gt;to_wait.tv_sec = when-&gt;tv_sec - now.tv_sec;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>when-&gt;tv_nsec &gt;= now.tv_nsec<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_usec = when-&gt;tv_nsec / <span style="color: #d75fd7;">1000</span> - now.tv_nsec;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_sec--;
                tip-&gt;to_wait.tv_usec =
                    SECTOUSEC - now.tv_usec + when-&gt;tv_nsec / <span style="color: #d75fd7;">1000</span>;
            <span style="color: #67b11d;">}</span>

            select<span style="color: #67b11d;">(</span><span style="color: #d75fd7;">0</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span>, &amp;tip-&gt;to_wait<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #d75fd7;">(</span>*func<span style="color: #d75fd7;">)(</span>arg<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #8787d7;">attr</span>;
<span style="color: #df005f; font-weight: bold;">pthread_mutex_t</span>     <span style="color: #8787d7;">mutex</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">retry</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    pthread_mutex_lock<span style="color: #d75fd7;">(</span>&amp;mutex<span style="color: #d75fd7;">)</span>;

    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;mutex<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">err</span> = <span style="color: #d75fd7;">0</span>, <span style="color: #8787d7;">condition</span> = <span style="color: #d75fd7;">0</span>, <span style="color: #8787d7;">arg</span> = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> <span style="color: #8787d7;">when</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutexattr_init<span style="color: #67b11d;">(</span>&amp;attr<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"pthread_mutexattr_init failed"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutexattr_settype<span style="color: #67b11d;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> !=
        <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't set recursive type"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;mutex, &amp;attr<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create recursive mutex"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>condition == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        clock_gettime<span style="color: #2aa198;">(</span>CLOCK_REALTIME, &amp;when<span style="color: #2aa198;">)</span>;
        when.tv_sec += <span style="color: #d75fd7;">10</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">10 seconds after now</span>
        timeout<span style="color: #2aa198;">(</span>&amp;when, retry, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span><span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #875f00;">)</span>arg<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    pthread_mutex_unlock<span style="color: #d75fd7;">(</span>&amp;mutex<span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org0e9dd2a" class="outline-3">
<h3 id="org0e9dd2a"><span class="done DONE">DONE</span> Chapter 13. Daemon Processes <code>[8/8]</code></h3>
<div class="outline-text-3" id="text-org0e9dd2a">
</div>
<div id="outline-container-orge973961" class="outline-4">
<h4 id="orge973961"><span class="done DONE">DONE</span> 13.1 Introduction</h4>
<div class="outline-text-4" id="text-orge973961">
<p>
A process live for a long time in the background.
</p>
</div>
</div>
<div id="outline-container-org63a6cc9" class="outline-4">
<h4 id="org63a6cc9"><span class="done DONE">DONE</span> 13.2 Daemon Characteristics</h4>
<div class="outline-text-4" id="text-org63a6cc9">
<div class="org-src-container">
<pre class="src src-sh">ps -axj
</pre>
</div>

<blockquote>
<ul class="org-ul">
<li>The kswapd daemon is also known as pageout daemon. It supports the virtual memory subsystem by writing dirty pages to disk slowly over time, so the pages can be reclamed.</li>
<li>The flush daemon fluhes dirty pages to disk when available memory reaches a configured minimul thrshold.</li>
<li>The sync_supers daemon periodically fluhes the system metadata to disk.</li>
<li>The jbd daemon helps implement the journal in the ext4 file system.</li>
</ul>
</blockquote>

<blockquote>
<p>
Process 1 is uaually init (launchd on Mac OS X). It is a system daemon responsible for, among other things, starting system services specific to various run levels.
</p>

<p>
The rpcbind provides the service of mapping RPC(Remote Procedure Call) program numbers to network port. The rsyslogd daemon is available to any program to log system messages for administrator.
</p>

<p>
inetd daemon listens on the system's network interfaces for incoming requests for various network servers. The nfsd, nfsiod, lockd, rpciod, rpc.idmapd, rpc.statd, and rpc.mountd daemons provide support for the Network File System(NFS). The fist four are <b>kernel</b> daemons, while the last three are <b>user-level</b> daemons
</p>

<p>
The cron daemon executes commands at regularly scheduled dates and times.
</p>

<p>
most of daemons run with superuser(root) privileges.
</p>

<p>
the parent of the user-level daemons is the init process.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgc4d760e" class="outline-4">
<h4 id="orgc4d760e"><span class="done DONE">DONE</span> 13.3 Coding Rules</h4>
<div class="outline-text-4" id="text-orgc4d760e">
<p>
basic rules to coding a daemon prevent unwanted interactions from happening.
</p>
<ol class="org-ol">
<li>Call unmask to set the file mode createion mask to a known value, usually 0.</li>
<li>Call fork and have the parent exit.</li>
<li>Call setsid to create a new session.
<ol class="org-ol">
<li>becomes the leader of a new session</li>
<li>becomes the leader of a new process group</li>
<li>is disassociated from its controlling terminal</li>
</ol></li>
<li>Change the current working directory to the root directory.</li>
<li>Unneeded file descriptors should be closed</li>
<li>Some daemons open file descriptors 0, 1 and 2 to /dev/null so that any library routines that try to read from standard input or write to standard output or standard error will have no effect.</li>
</ol>


<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 106: </span>Figure 13.1 initialize a daemon process</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     13fig01.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    a function that can be called from a program</span>
<span style="color: #008787; background-color: #262626;"> *             that wants to initialize itsef as a daemon</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/resource.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">syslog.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__progname</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">daemonize</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cmd</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>              <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">fd0</span>, <span style="color: #8787d7;">fd1</span>, <span style="color: #8787d7;">fd2</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span>            <span style="color: #8787d7;">pid</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">rlimit</span>    <span style="color: #8787d7;">rl</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span> <span style="color: #8787d7;">sa</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>cmd == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        cmd = __progname;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">clear file creation mask.</span>
    umask<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">get maximum number of file descriptors</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>getrlimit<span style="color: #2aa198;">(</span>RLIMIT_NOFILE, &amp;rl<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: can't get file limit"</span>, cmd<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">become a session leader to lose controlling TTY.</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: can't fork"</span>, cmd<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">parent</span>
    <span style="color: #d75fd7;">}</span>

    setsid<span style="color: #d75fd7;">()</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">ensure future opens won't allocate controlling TTYs.</span>
    sa.sa_handler = SIG_IGN;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;sa.sa_mask<span style="color: #d75fd7;">)</span>;
    sa.sa_flags = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigaction<span style="color: #2aa198;">(</span>SIGHUP, &amp;sa, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>
        err_quit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s: can't ignore SIGHUP"</span>, cmd<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: can't fork"</span>, cmd<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">parent</span>
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">change the current working directory to the root so</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">we won't prevent file systems from being unmounted.</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>chdir<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/"</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: can't change directory to /"</span>, cmd<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    chroot<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"/"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close all open file descriptors</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>rl.rlim_max == RLIM_INFINITY<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        rl.rlim_max = <span style="color: #d75fd7;">1024</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; rl.rlim_max; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        close<span style="color: #2aa198;">(</span>i<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">attach file descriptors 0, 1 and 2 to /dev/null</span>
    fd0 = open<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"/dev/null"</span>, O_RDWR<span style="color: #d75fd7;">)</span>;
    fd1 = dup<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    fd2 = dup<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">initialize the log file</span>
    openlog<span style="color: #d75fd7;">(</span>cmd, LOG_CONS, LOG_DAEMON<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fd0 != <span style="color: #d75fd7;">0</span> || fd1 != <span style="color: #d75fd7;">1</span> || fd2 != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        syslog<span style="color: #2aa198;">(</span>LOG_ERR, <span style="color: #2aa198;">"unexpected file descriptors %d %d %d"</span>, fd0, fd1, fd2<span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgb93a416" class="outline-4">
<h4 id="orgb93a416"><span class="done DONE">DONE</span> 13.4 Error Logging</h4>
<div class="outline-text-4" id="text-orgb93a416">
<p>
three ways to generate log messages:
</p>
<ul class="org-ul">
<li>Kernel routines can call the log function.</li>
<li>Most user processes (daemons) call the syslog(3) function to generate log messages.</li>
<li>A user process on this host, or on some other host that is connected to this host by a TCP/IP network can send log messages to UDP port 514.</li>
</ul>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">syslog.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">openlog</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">ident</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">option</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">facility</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">syslog</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">priority</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">fmt</span>, ...<span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">closelog</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">setlogmask</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">maskpri</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: previous log priority mask value</span>
</pre>
</div>
<p>
calling openlog is optional. the first time syslog called automatically calls openlog.
</p>

<p>
calling closelog is also optional.
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 14:</span> Figure 13.3 The <i>option</i> argument for <code>openlog</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><i>option</i></th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_CONS</td>
<td class="org-left">ifthe log message can't be sent to syslog via the UNIX domain datagram,</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">the message is writen to the console instead</td>
</tr>

<tr>
<td class="org-left">LOG_NDELAY</td>
<td class="org-left">Open the UNIX domain datagram socket to the syslogd daemon immediately;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">don't wait until the frst message is logged.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">Normally, the socket is not opened until the first message is logged.</td>
</tr>

<tr>
<td class="org-left">LOG_NOWAIT</td>
<td class="org-left">Do not wait for child processes that might have been created in the process</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">of logging message. The prevents conflicts with applications that catch <b>SIGCHLD</b>,</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">since the application might have retrieved the child's status by the time that syslog calls <code>wait</code></td>
</tr>

<tr>
<td class="org-left">LOG_ODELAY</td>
<td class="org-left">Delay the opening ofthe connection to the syslogd daemon until the first message is logged.</td>
</tr>

<tr>
<td class="org-left">LOG_PERROR</td>
<td class="org-left">write the log message to standard error in addition to sending it to syslogd</td>
</tr>

<tr>
<td class="org-left">LOG_PID</td>
<td class="org-left">Log the process ID with each message. This is intended fr daemons that fork a child process</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">to handle different requests (as compared to daemons, such as syslogd, that never call fork)</td>
</tr>
</tbody>
</table>

<p>
<b><i>format</i> and any other arguments are passed to vsprintf function for formatting. %m in <i>format</i> are first replaced with the error message string(strerror)</b>
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<pre class="src src-c">openlog<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"lpd"</span>, LOG_PID, LOG_LPR<span style="color: #268bd2;">)</span>;
<span style="color: #d75fd7; font-weight: bold;">syslog</span><span style="color: #268bd2;">(</span>LOG_ERR, <span style="color: #2aa198;">"open error for %s: %m"</span>, filename<span style="color: #268bd2;">)</span>;
</pre>
</div>
<p>
if we had not called <code>openlog</code>, the second call could have been
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7; font-weight: bold;">syslog</span><span style="color: #268bd2;">(</span>LOG_ERR | LOG_LPR, <span style="color: #2aa198;">"open error for %s: %m"</span>, filename<span style="color: #268bd2;">)</span>;
</pre>
</div></li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 15:</span> Figure 13.4 The <i>facility</i> argument for <code>openlog</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">facility</th>
<th scope="col" class="org-left">XSI</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_AUDIT</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the audit fcility</td>
</tr>

<tr>
<td class="org-left">LOG_AUTH</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">authorization programs: login, su, getty, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_AUTHPRIV</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">same as LOG_AUTH, but logged to fle with restricted permissions</td>
</tr>

<tr>
<td class="org-left">LOG_CONSOLE</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">messages written to /dev/console</td>
</tr>

<tr>
<td class="org-left">LOG_CRON</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">cron and at</td>
</tr>

<tr>
<td class="org-left">LOG_DAEMON</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">system daemons: inetd, routed, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_FTP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the FTP daemon (ftpd)</td>
</tr>

<tr>
<td class="org-left">LOG_KERN</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">messages generated by the kernel</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL0</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL1</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL2</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL3</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL4</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL5</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL6</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL7</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LPR</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">line printer system: lpd, lpc, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_MAIL</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the mail system</td>
</tr>

<tr>
<td class="org-left">LOG_NEWS</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the network time protocol system</td>
</tr>

<tr>
<td class="org-left">LOG_SECURITY</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the security subsystem</td>
</tr>

<tr>
<td class="org-left">LOG_SYSLOG</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the syslogd daemon itself</td>
</tr>

<tr>
<td class="org-left">LOG_USER</td>
<td class="org-left">*</td>
<td class="org-left">message from other user processes(deafult)</td>
</tr>

<tr>
<td class="org-left">LOG_UUCP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the UUCP system</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 16:</span> Figure 13.5 The <code>syslog</code> <i>levels</i> (ordered)</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">level</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_EMERG</td>
<td class="org-left">emergency (system is unusuable) (highest priority)</td>
</tr>

<tr>
<td class="org-left">LOG_ALERT</td>
<td class="org-left">condition that must be fxed immediately</td>
</tr>

<tr>
<td class="org-left">LOG_CRIT</td>
<td class="org-left">critical condition (e.g., hard device error)</td>
</tr>

<tr>
<td class="org-left">LOG_ERR</td>
<td class="org-left">error condition</td>
</tr>

<tr>
<td class="org-left">LOG_WARNING</td>
<td class="org-left">warning condition</td>
</tr>

<tr>
<td class="org-left">LOG_NOTICE</td>
<td class="org-left">normal, but significant condition</td>
</tr>

<tr>
<td class="org-left">LOG_INFO</td>
<td class="org-left">infrmational message</td>
</tr>

<tr>
<td class="org-left">LOG_DEBUG</td>
<td class="org-left">debug message(lowest priority)</td>
</tr>
</tbody>
</table>


<p>
syslog that handles variable argument lists
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">syslog.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdarg.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">vsyslog</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">priority</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">format</span>, <span style="color: #df005f; font-weight: bold;">va_list</span> <span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org36b56fe" class="outline-4">
<h4 id="org36b56fe"><span class="done DONE">DONE</span> 13.5 Single-Instance Daemons</h4>
<div class="outline-text-4" id="text-org36b56fe">
<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 107: </span>Figure 13.6 Ensure that only one copy of a daemon is running</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     13fig06.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-29</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    figure 13.6</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  illustrates the use of file and record locking</span>
<span style="color: #008787; background-color: #262626;"> *  to ensure that only one coyp of a daemon is running</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">string.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/stat.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">syslog.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">LOCKFILE</span> <span style="color: #2aa198;">"/var/run/daemon.pid"</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">LOCKMODE</span> <span style="color: #268bd2;">(</span>S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH<span style="color: #268bd2;">)</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">lockfile</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">already_running</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">fd</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">16</span><span style="color: #d75fd7;">]</span>;

    fd = open<span style="color: #d75fd7;">(</span>LOCKFILE, O_RDWR | O_CREAT, LOCKFILE<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fd &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        syslog<span style="color: #2aa198;">(</span>LOG_ERR, <span style="color: #2aa198;">"can't open %s: %m"</span>, LOCKFILE<span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_FAILURE<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>lockfile<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>errno == EACCES || errno == EAGAIN<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        syslog<span style="color: #2aa198;">(</span>LOG_ERR, <span style="color: #2aa198;">"can't lock %s: %m"</span>, LOCKFILE<span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_FAILURE<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    ftruncate<span style="color: #d75fd7;">(</span>fd, <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    sprintf<span style="color: #d75fd7;">(</span>buf, <span style="color: #2aa198;">"%ld"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    write<span style="color: #d75fd7;">(</span>fd, <span style="color: #2aa198;">"%ld"</span>, strlen<span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span> + <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org3513f3c" class="outline-4">
<h4 id="org3513f3c"><span class="done DONE">DONE</span> 13.6 Daemon Conventions</h4>
<div class="outline-text-4" id="text-org3513f3c">
<ul class="org-ul">
<li>daemon's lock file is usually stored in /var/run. (might need superuser permissions to create a file here.)</li>
<li>daemon's configuration options usually stored in /etc</li>
<li>daemons can be started from the command line , but they are usually started from one of the system initialization scripts</li>
<li>daemon read configuration file when it starts, but usually won't look at it again.</li>
</ul>


<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 108: </span>Figure 13.7 Daemon reredaing configuration files</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     13fig07.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-11-30</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    one way a daemon can reread its configuration file.</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">syslog.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">sigset_t</span> <span style="color: #8787d7;">mask</span>;

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">already_running</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">reread</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">...</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">thr_fn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">err</span>, <span style="color: #8787d7;">signo</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err = sigwait<span style="color: #2aa198;">(</span>&amp;mask, &amp;signo<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            syslog<span style="color: #67b11d;">(</span>LOG_ERR, <span style="color: #2aa198;">"sigwait failed: %m"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #2aa198;">(</span>signo<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">case</span> SIGHUP:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2aa198;">"Re-reading configuration file"</span><span style="color: #67b11d;">)</span>;
                reread<span style="color: #67b11d;">()</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;

            <span style="color: #268bd2; font-weight: bold;">case</span> SIGTERM:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2aa198;">"got SIGTERM; exiting"</span><span style="color: #67b11d;">)</span>;
                exit<span style="color: #67b11d;">(</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span>;

            <span style="color: #268bd2; font-weight: bold;">default</span>:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2aa198;">"unexpected signal: %d\n"</span>, signo<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>              <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>        <span style="color: #8787d7;">tid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>            *<span style="color: #8787d7;">cmd</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span> <span style="color: #8787d7;">sa</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>cmd = strchr<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">'/'</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        cmd = argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        cmd++;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">become a dameon</span>
    daemonize<span style="color: #d75fd7;">(</span>cmd<span style="color: #d75fd7;">)</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">make sure only one copy of the daemon is running</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>already_running<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        syslog<span style="color: #2aa198;">(</span>LOG_ERR, <span style="color: #2aa198;">"daemon already running"</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">restore SIGHUP default and block all signals.</span>
    sa.sa_handler = SIG_DFL;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;sa.sa_mask<span style="color: #d75fd7;">)</span>;
    sa.sa_flags = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sigaction<span style="color: #2aa198;">(</span>SIGHUP, &amp;sa, <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        syslog<span style="color: #2aa198;">(</span>LOG_ERR, <span style="color: #2aa198;">"%m: can't restore SIGHUP default."</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    sigfillset<span style="color: #d75fd7;">(</span>&amp;mask<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>err = pthread_sigmask<span style="color: #67b11d;">(</span>SIG_BLOCK, &amp;mask, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"SIG_BLOCK error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">create a thread to handle SIGHUP and SIGTERM</span>
    err = pthread_create<span style="color: #d75fd7;">(</span>&amp;tid, <span style="color: #d75fd7;">NULL</span>, thr_fn, <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"can't create thread"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>

<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 109: </span>Figure 13.8 Alternative implementation of daemon rereading configuration files</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     13fig08.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-01</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    single-threaded daemon can catch SIGHUP and reread its configuration file.</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">syslog.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>


<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">lockfile</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;
<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">already_running</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">reread</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">...</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sigterm</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    syslog<span style="color: #d75fd7;">(</span>LOG_INFO, <span style="color: #2aa198;">"got SIGTERM; exiting"</span><span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sighup</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    syslog<span style="color: #d75fd7;">(</span>LOG_INFO, <span style="color: #2aa198;">"Re-reading configuration file"</span><span style="color: #d75fd7;">)</span>;
    reread<span style="color: #d75fd7;">()</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span>             *<span style="color: #8787d7;">cmd</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigaction</span>  <span style="color: #8787d7;">sa</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>cmd = strchr<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">'/'</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>
        cmd = argv<span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #268bd2; font-weight: bold;">else</span>
        cmd++;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">become a daemon</span>
    daemonize<span style="color: #d75fd7;">(</span>cmd<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>already_running<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        syslog<span style="color: #2aa198;">(</span>LOG_ERR, <span style="color: #2aa198;">"daemon already running"</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_FAILURE<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    sa.sa_handler = sigterm;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;sa.sa_mask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;sa.sa_mask, SIGHUP<span style="color: #d75fd7;">)</span>;
    sa.sa_flags = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>sigaction<span style="color: #67b11d;">(</span>SIGTERM, &amp;sa, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        syslog<span style="color: #2aa198;">(</span>LOG_ERR, <span style="color: #2aa198;">"can't catch SIGTERM: %m"</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_FAILURE<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    sa.sa_handler = sighup;
    sigemptyset<span style="color: #d75fd7;">(</span>&amp;sa.sa_mask<span style="color: #d75fd7;">)</span>;
    sigaddset<span style="color: #d75fd7;">(</span>&amp;sa.sa_mask, SIGTERM<span style="color: #d75fd7;">)</span>;
    sa.sa_flags = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>sigaction<span style="color: #67b11d;">(</span>SIGHUP, &amp;sa, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        syslog<span style="color: #2aa198;">(</span>LOG_ERR, <span style="color: #2aa198;">"can't catch SIGHUP: %m"</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_FAILURE<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgc4d41d7" class="outline-4">
<h4 id="orgc4d41d7"><span class="done DONE">DONE</span> 13.7 Client-Server Model</h4>
<div class="outline-text-4" id="text-orgc4d41d7">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 110: </span>Figure 13.9 Set close-on-exec flag</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     13fig09.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-01</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    solve multiple file descriptors may left open</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">set_cloexec</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">val</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>val = fcntl<span style="color: #67b11d;">(</span>fd, FD_GETFD, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    val |= FD_CLOEXEC;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fcntl<span style="color: #2aa198;">(</span>fd, FD_SETFD, val<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef638ae" class="outline-4">
<h4 id="orgef638ae"><span class="done DONE">DONE</span> 13.8 Summary</h4>
<div class="outline-text-4" id="text-orgef638ae">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
13.1 actually I didn't find there is anything wrong here, but the answer is:
</p>
<blockquote>
<p>
If it calls chroot, the process will not be able to open /dev/log. The solution is for the daemon to call openlog with an option of LOG_NDELAY, before calling chroot. This opens the special device file (the UNIX domain datagram socket), yielding a descriptor that is still valid, even after a call to chroot. This scenario is encountered in daemons, such as ftpd (the File Transfer Protocol daemon), that specifically call chroot for security reasons but still need to call syslog to log error conditions.
</p>
</blockquote></li>
<li>13.2 syslog did not to create a session</li>
<li>&#x2026;</li>
<li><p>
13.4 code below
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 111: </span>call daemon and get login name</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex13.3.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-01</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    call daemonize then call getlogin</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__progname</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>   = <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span> = <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">tdir</span> = <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">out</span><span style="color: #d75fd7;">[</span>FILENAME_MAX<span style="color: #d75fd7;">]</span> = <span style="color: #d75fd7;">{</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">}</span>;

    daemonize<span style="color: #d75fd7;">(</span>__progname<span style="color: #d75fd7;">)</span>;
    name = getlogin<span style="color: #d75fd7;">()</span>;

    tdir = getenv<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"TMPDIR"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>tdir<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        snprintf<span style="color: #2aa198;">(</span>out, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>out<span style="color: #67b11d;">)</span>, <span style="color: #2aa198;">"%s/getlog.txt"</span>, tdir<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        snprintf<span style="color: #2aa198;">(</span>out, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>out<span style="color: #67b11d;">)</span>, <span style="color: #2aa198;">"/var/tmp/getlog.txt"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    fp = fopen<span style="color: #d75fd7;">(</span>out, <span style="color: #2aa198;">"w+"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fp != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>name == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            fprintf<span style="color: #67b11d;">(</span>fp, <span style="color: #2aa198;">"null"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            fprintf<span style="color: #67b11d;">(</span>fp, <span style="color: #2aa198;">"login name: %s\n"</span>, name<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    fclose<span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
    fp = <span style="color: #d75fd7;">NULL</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgd027684" class="outline-3">
<h3 id="orgd027684"><span class="done DONE">DONE</span> Chapter 14. Advanced I/O <code>[8/8]</code></h3>
<div class="outline-text-3" id="text-orgd027684">
</div>
<div id="outline-container-org72ab6f0" class="outline-4">
<h4 id="org72ab6f0"><span class="done DONE">DONE</span> 14.1 Introduction</h4>
<div class="outline-text-4" id="text-org72ab6f0">
<p>
nonblocking I/O, I/O multiplexing(<code>select</code> and <code>poll</code>), asynchronous I/O, the <code>readv</code> and <code>writev</code> functions, and memory-mapped I/O (mmap).
</p>
</div>
</div>
<div id="outline-container-org16c0397" class="outline-4">
<h4 id="org16c0397"><span class="done DONE">DONE</span> 14.2 Nonblocking I/O</h4>
<div class="outline-text-4" id="text-org16c0397">
<p>
slow system calls can block forever. include:
</p>
<ul class="org-ul">
<li>reads if data isn't present with certain file types</li>
<li>writes if data isn't present with certain file types</li>
<li>open conditions</li>
<li>mandatory record locking</li>
<li><code>ioctl</code> options</li>
<li>IPC</li>
</ul>


<p>
Q: What does Nonblocking do?
A: returns immediately with an error nothing that the operation would have blocked if the operation cannot be completed.
</p>

<p>
two way to specify nonblocking I/O:
</p>
<ol class="org-ol">
<li><code>open</code> to get the descriptor, specify <code>O_NONBLOCK</code> flag</li>
<li>call <code>fcntl</code> to trun on the <code>O_NONBLOCK</code> if already open.</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 112: </span>Figure 14.1 Large nonblocking write</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     14fig01.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-15</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Figure 14.1 Large nonblocking write</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #268bd2;">[</span><span style="color: #d75fd7;">50000</span><span style="color: #268bd2;">]</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">ntowrite</span>, <span style="color: #8787d7;">nwrite</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">ptr</span>;

    ntowrite = read<span style="color: #d75fd7;">(</span>STDIN_FILENO, buf, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    fprintf<span style="color: #d75fd7;">(</span>stderr, <span style="color: #2aa198;">"read %d bytes\n"</span>, ntowrite<span style="color: #d75fd7;">)</span>;

    set_fl<span style="color: #d75fd7;">(</span>STDOUT_FILENO, O_NONBLOCK<span style="color: #d75fd7;">)</span>;

    ptr = buf;
    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>ntowrite &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno  = <span style="color: #d75fd7;">0</span>;
        nwrite = write<span style="color: #2aa198;">(</span>STDOUT_FILENO, ptr, ntowrite<span style="color: #2aa198;">)</span>;
        fprintf<span style="color: #2aa198;">(</span>stderr, <span style="color: #2aa198;">"nwrite = %d, errno = %d\n"</span>, nwrite, errno<span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>nwrite &gt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            ptr += nwrite;
            ntowrite -= nwrite;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    clr_fl<span style="color: #d75fd7;">(</span>STDOUT_FILENO, O_NONBLOCK<span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span>EXIT_SUCCESS<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">ls -l /etc/services
bin/14fig01 &lt; /etc/services &gt; temp.file
ls -l temp.file
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">bin/14fig01 &lt; /etc/services <span style="color: #d75fd7;">2</span>&gt;stderr.out
cat stderr.out
</pre>
</div>

<blockquote>
<p>
On OSX, a there are lots of
nwirte = some number, errno = 0
nwrite = -1, errno = 35
</p>

<p>
but on Linux, the error message is
nwrite = -1, errno = 11 instead
</p>

<p>
<b>they are both EAGAIN number</b>
</p>
</blockquote></li>
</ul>
</div>
</div>
<div id="outline-container-org999950d" class="outline-4">
<h4 id="org999950d"><span class="done DONE">DONE</span> 14.3 Record Locking</h4>
<div class="outline-text-4" id="text-org999950d">
<p>
Record locking is the term normally used to describe the ability of a process to prevent other processes from modifying a region of a file while the first process is reading or modifying that portion of the file
</p>
<ul class="org-ul">
<li>1. History</li>
</ul>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 17:</span> Figure 14.2 Forms of record locking supported by various UNIX systems</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Systems</th>
<th scope="col" class="org-left">Advisory</th>
<th scope="col" class="org-left">Mandatory</th>
<th scope="col" class="org-left">fcntl</th>
<th scope="col" class="org-left">lockf</th>
<th scope="col" class="org-left">flock</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SUS</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">XSI</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">FreeBSD 8.0</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">Linux 3.2.0</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">Mac OS X 10.6.8</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">Solaris</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
2. <code>fcntl</code> Record Locking
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">        #include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">fcntl</span>.<span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">cmd</span>, ... <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">struct flock *flockptr */</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: depends on cmd if OK (see following), -1 on error</span>
</pre>
</div>
<p>
<code>cmd</code> is F_GETLK, F_SETLK, or F_SETLKW.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">flock</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">short</span> <span style="color: #8787d7;">l_type</span>;                  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">F_RDLCK, or F_UNLCK</span>
    <span style="color: #df005f; font-weight: bold;">short</span> <span style="color: #8787d7;">l_whence</span>;                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">SEEK_SET, SEEK_CUR, or SEEK_END</span>
    <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">l_start</span>;                 <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">offset in bytes, relative to l_whence</span>
    <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">l_len</span>;                   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">length, in bytes; 0 means lock to EOF</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">l_pid</span>;                   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">returned with F_GETLK</span>
<span style="color: #268bd2;">}</span>;
</pre>
</div>

<ul class="org-ul">
<li>describes
<ul class="org-ul">
<li>The type of lock desired: F_RDLCK, F_WRLCK, or F_UNLCK</li>
<li>The starting byte offset of the region being locked or unlocked (l_start and l_whence)</li>
<li>The size of the region in bytes(l_len)</li>
<li>The ID(l_pid) of the process holding the lock that can block the current process(returned by F_GETLK only)</li>
</ul></li>
<li><p>
rules to the specification of the region to be locked or unlocked
</p>
<ul class="org-ul">
<li>The two elements that specify the starting offset of the region are similar to the last two arguments of the <code>lseek</code> function.</li>
<li>Locks can start and extend beyond the current end of file, but cannot start or extend before the beginning of the file</li>
<li>if l_len is 0, it means that the lock extends to the <b>largest</b> possible offset of the file</li>
<li>To lock the entire file, we set l_start and l_whence to point the beginning of the file and specify a length(l_len) of 0.</li>
</ul>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 18:</span> Figure 14.3 Compatibility between different types</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">conditions</th>
<th scope="col" class="org-left">read lock</th>
<th scope="col" class="org-left">write lock</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">no locks</td>
<td class="org-left">OK</td>
<td class="org-left">OK</td>
</tr>

<tr>
<td class="org-left">one or more read locks</td>
<td class="org-left">OK</td>
<td class="org-left">denied</td>
</tr>

<tr>
<td class="org-left">one or more write lock</td>
<td class="org-left">denied</td>
<td class="org-left">denied</td>
</tr>
</tbody>
</table></li>

<li>Commands for the <code>fcntl</code> function
<ul class="org-ul">
<li>F_GETLK: determine lock</li>
<li>F_SETLK: set lock, also used to clear lock(F_UNLCK)</li>
<li>F_SETLWK: a block version of F_SETLK. (The <b>W</b> means wait)</li>
</ul></li>
</ul></li>
</ul>


<p>
testing for a lock with F_GETLK and then trying to obtain that lock with F_SETLK or F_SETLKW is not an atomic operation
</p>


<div class="figure">
<p><img src="Chapter14/14fig04.jpg" alt="14fig04.jpg" />
</p>
<p><span class="figure-number">Figure 11: </span>Figure 14.4 File byte-range lock diagram</p>
</div>


<ul class="org-ul">
<li><p>
Example - Requesting and Releasing a Lock
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 113: </span>Figure 14.5 Function to lock or unlock a region of a file</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     14fig05.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-16</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Function to lock or unlock a region of a file</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">lock_reg</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">cmd</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">type</span>, <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">offset</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">whence</span>, <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">len</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">flock</span> <span style="color: #8787d7;">lock</span>;

    lock.l_type   = type;
    lock.l_start  = offset;
    lock.l_whence = whence;
    lock.l_len    = len;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fcntl<span style="color: #2aa198;">(</span>fd, cmd, &amp;lock<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>

<li><p>
Example - Testing for a Lock
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 114: </span>Figure 14.6 Function to test for a locking condition</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     14fig06.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-16</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Figure 14.6 Function to test for a locking condition</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #d75fd7; font-weight: bold;">lock_test</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">type</span>, <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">offset</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">whence</span>, <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">len</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">flock</span> <span style="color: #8787d7;">lock</span>;

    lock.l_type   = type;
    lock.l_start  = offset;
    lock.l_whence = whence;
    lock.l_len    = len;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fcntl<span style="color: #2aa198;">(</span>fd, F_GETLK, &amp;lock<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fcntl error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>lock.l_type == F_UNLCK<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>lock.l_pid<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>

<li><p>
Example - Deadlock <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 115: </span>Figure 14.7 Example of deadlock detection</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     deadlock.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-16</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Example of deadlock detection</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">lockabyte</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">off_t</span> <span style="color: #8787d7;">offset</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>writew_lock<span style="color: #2aa198;">(</span>fd, offset, SEEK_SET, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"%s: writew_lock error"</span>, name<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"%s: got the lock, byte %lld\n"</span>, name, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>offset<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;">     * Create a file and write two bytes to it.</span>
<span style="color: #008787; background-color: #262626;">     */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = creat<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"templock"</span>, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"creat error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>write<span style="color: #2aa198;">(</span>fd, <span style="color: #2aa198;">"ab"</span>, <span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    TELL_WAIT<span style="color: #d75fd7;">()</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        lockabyte<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"child"</span>, fd, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
        TELL_PARENT<span style="color: #2aa198;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span>;
        WAIT_PARENT<span style="color: #2aa198;">()</span>;
        lockabyte<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"child"</span>, fd, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        lockabyte<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"parent"</span>, fd, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
        TELL_CHILD<span style="color: #2aa198;">(</span>pid<span style="color: #2aa198;">)</span>;
        WAIT_CHILD<span style="color: #2aa198;">()</span>;
        lockabyte<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"parent"</span>, fd, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>

<li>Implied Inheritance and Release of Locks
<ol class="org-ol">
<li>Locks are associated with a process and a file.</li>
<li>Locks are never inherited by the child accross a fork</li>
<li>Locks are inherited by a new program accross exec.</li>
</ol></li>

<li><p>
FreeBSD Implementation
</p>
<p>
<img src="Chapter14/14fig08.jpg" alt="14fig08.jpg" />
new here are <b>lockf</b> structure
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 116: </span>Figure 14.9 Place a write lock on an entire file</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     14fig09.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-16</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Place a write lock on an entire file</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">lockfile</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">flock</span> <span style="color: #8787d7;">fl</span>;

    fl.l_type   = F_WRLCK;
    fl.l_start  = <span style="color: #d75fd7;">0</span>;
    fl.l_whence = SEEK_SET;
    fl.l_len    = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fcntl<span style="color: #2aa198;">(</span>fd, F_SETLK, &amp;fl<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>

<p>
macro
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#define</span> <span style="color: #d75fd7; font-weight: bold;">lockfile</span><span style="color: #268bd2;">(</span><span style="color: #8787d7;">fd</span><span style="color: #268bd2;">)</span> write_lock<span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>fd<span style="color: #d75fd7;">)</span>, <span style="color: #d75fd7;">0</span>, SEEK_SET, <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span>
</pre>
</div></li>

<li><p>
Locks at End of File
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">The commented code should be the right one</span>
<span style="color: #d75fd7; font-weight: bold;">writew_lock</span><span style="color: #268bd2;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_END, <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span>;
<span style="color: #d75fd7; font-weight: bold;">write</span><span style="color: #268bd2;">(</span>fd, buf, <span style="color: #d75fd7;">1</span><span style="color: #268bd2;">)</span>;
<span style="color: #d75fd7; font-weight: bold;">un_lock</span><span style="color: #268bd2;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_END<span style="color: #268bd2;">)</span>;       <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">un_lock(fd, -1, SEEK_END) instead</span>
<span style="color: #d75fd7; font-weight: bold;">write</span><span style="color: #268bd2;">(</span>fd, buf, <span style="color: #d75fd7;">1</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<div class="figure">
<p><img src="Chapter14/14fig10.jpg" alt="14fig10.jpg" />
</p>
<p><span class="figure-number">Figure 12: </span>Figure 14.10 File range lock diagram</p>
</div></li>
<li><p>
Advisory versus Mandatory Locking
</p>

<div class="figure">
<p><img src="Chapter14/14fig11.jpg" alt="14fig11.jpg" />
</p>
<p><span class="figure-number">Figure 13: </span>Figure 14.11 Effect of mandatory locking on reads and writes by other processes</p>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 117: </span>Figure 14.12 Determine whether mandatory locking is supported</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     mandatory.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-17</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    determine whether our system supports mandatory locking</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">fd</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span>       <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>        <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">5</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> <span style="color: #8787d7;">statbuf</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s filename"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = open<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>write<span style="color: #2aa198;">(</span>fd, <span style="color: #2aa198;">"abcdef"</span>, <span style="color: #d75fd7;">6</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">6</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fstat error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fstat<span style="color: #2aa198;">(</span>fd, &amp;statbuf<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fstat error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fchmod<span style="color: #2aa198;">(</span>fd, <span style="color: #67b11d;">(</span>statbuf.st_mode &amp; ~S_IXGRP<span style="color: #67b11d;">)</span> | S_ISGID<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fchmod error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    TELL_WAIT<span style="color: #d75fd7;">()</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>write_lock<span style="color: #67b11d;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_SET, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"write_lock error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        TELL_CHILD<span style="color: #2aa198;">(</span>pid<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        WAIT_PARENT<span style="color: #2aa198;">()</span>;

        set_fl<span style="color: #2aa198;">(</span>fd, O_NONBLOCK<span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>read_lock<span style="color: #67b11d;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_SET, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> != -<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child: read_lock succeeded"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read_lock of already-locked region returns %d\n"</span>, errno<span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>lseek<span style="color: #67b11d;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_SET<span style="color: #67b11d;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"lseek error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>read<span style="color: #67b11d;">(</span>fd, buf, <span style="color: #d75fd7;">2</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>
            err_ret<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read failed (mandatory locking works)"</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">else</span>
            printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read OK(no mandatory locking), buf = %2.2s\n"</span>, buf<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">bin/14fig12 temp.lockk
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9395618" class="outline-4">
<h4 id="org9395618">14.4 I/O Multiplexing <code>[2/2]</code></h4>
<div class="outline-text-4" id="text-org9395618">

<div class="figure">
<p><img src="Chapter14/14fig13.jpg" alt="14fig13.jpg" />
</p>
</div>


<div class="figure">
<p><img src="Chapter14/14fig14.jpg" alt="14fig14.jpg" />
</p>
</div>

<p>
polling:
</p>
<ul class="org-ul">
<li>waste CPU time</li>
</ul>

<p>
asynchronous IO:
</p>
<ul class="org-ul">
<li>*we tell the kernel to notify us with a signal when a descriptor is ready for I/O.</li>
<li>*If we enable this signal for two descriptors (in the example we’ve been talking about, reading from two descriptors), the occurrence of the signal doesn’t tell us which descriptor is ready.</li>
</ul>

<p>
I/O multiplexing:
</p>
<ul class="org-ul">
<li>build a list of descriptors that we are interested in</li>
<li>call a function that doesn't return until one of the descriptors is ready for I/O.</li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org89012be"></a><span class="done DONE">DONE</span> 14.4.1 <code>select</code> and <code>pselect</code> Functions<br />
<div class="outline-text-5" id="text-org89012be">
<p>
select arguments:
</p>
<ul class="org-ul">
<li>which descriptors we're interested in</li>
<li>which conditions we're interested in for each descriptor.</li>
<li>How long we want to wait.</li>
</ul>

<p>
return information:
</p>
<ul class="org-ul">
<li>The total count of the number of descriptors that are ready.</li>
<li>which descriptors are ready for each of the three conditions (read, write, or exception)</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/select.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">select</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">maxfdp1</span>, <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">readfds</span>,
           <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">wriefds</span>, <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">exceptfds</span>,
           <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timevval</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">tvptr</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: count of ready descriptors, 0 on timeout, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c" id="orgb074db7"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/select.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">FD_ISSET</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #8787d7;">fdset</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: nonzero if fd is in set, 0 otherwise</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">FD_CLR</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #8787d7;">fdset</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">FD_SET</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #8787d7;">fdset</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">FD_ZERO</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #8787d7;">fdset</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c" id="org701bb02"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/select.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pselect</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">maxfdp1</span>, <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">readfds</span>,
            <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">writefds</span>, <span style="color: #df005f; font-weight: bold;">fd_set</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">exceptfds</span>,
            <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">tsptr</span>,
            <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">sigset_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">sigmask</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<p>
differences from select
</p>
<ul class="org-ul">
<li>timeout value for <code>select</code> is specified by a timeval structure, but timespec structure for pselect</li>
<li>timeout for pselect is declared const</li>
<li>An optional signal mask argument is available for pselect.</li>
</ul>
</div>
</li>
<li><a id="org7e31b81"></a><span class="done DONE">DONE</span> 14.4.2 <code>poll</code> Function<br />
<div class="outline-text-5" id="text-org7e31b81">
<p>
<code>poll</code> is similar to <code>select</code>, but without differentiating conditions
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">poll.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">poll</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">pollfd</span> <span style="color: #8787d7;">fdarray</span><span style="color: #d75fd7;">[]</span>, <span style="color: #df005f; font-weight: bold;">nfds_t</span> <span style="color: #8787d7;">nfds</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">timeout</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">typedef</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span>;                        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">file descriptor to check, or &lt;0 to ignore</span>
    <span style="color: #df005f; font-weight: bold;">short</span> <span style="color: #8787d7;">events</span>;                    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">events of interest on fd</span>
    <span style="color: #df005f; font-weight: bold;">short</span> <span style="color: #8787d7;">revents</span>;                   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">events that occurred on fd</span>
<span style="color: #268bd2;">}</span>;
</pre>
</div>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 19:</span> Figure 14.17 The events and revents flags for poll</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Input to events?</th>
<th scope="col" class="org-left">Result from revents?</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">POLLIN</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Equivalent to POLLRDNORM <code>OR</code> POLLRDBAND</td>
</tr>

<tr>
<td class="org-left">POLLRDNORM</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Normal data can bread without blocking</td>
</tr>

<tr>
<td class="org-left">POLLRDBAND</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Priority data can be read without blocking</td>
</tr>

<tr>
<td class="org-left">POLLPRI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">High-priority data can be read without blocking</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">POLLOUT</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Normal data can be written without blocking</td>
</tr>

<tr>
<td class="org-left">POLLWRNORM</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Same as POLLOUT</td>
</tr>

<tr>
<td class="org-left">POLLWRBAND</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">Priority data can be written without blocking</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">POLLERR</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">An error has occurred</td>
</tr>

<tr>
<td class="org-left">POLLHUP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">A hangup has occurred</td>
</tr>

<tr>
<td class="org-left">POLLNVAL</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">The descriptor does not reference an open file</td>
</tr>
</tbody>
</table>

<p>
When a descriptor is hang up (POLLHUP), we can no longer write, but still can read
</p>

<ul class="org-ul">
<li>Interruptibility of <code>select</code> and <code>poll</code>
When the automatic restarting of interrupted system calls was introduced with 4.2BSD, the <code>select</code> function was never restarted.  <br />
even if the SA_RESTART option is specified. <br />
but under SVR4, if SA_RESTART was specified, even <code>select</code> and <code>poll</code> were automatically restarted.</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org6880fc7" class="outline-4">
<h4 id="org6880fc7"><span class="done DONE">DONE</span> 14.5 Asynchronous I/O <code>[3/3]</code></h4>
<div class="outline-text-4" id="text-org6880fc7">
</div>
<ul class="org-ul">
<li><a id="org57d0676"></a><span class="done DONE">DONE</span> 14.5.1 System V Asynchronous I/O<br />
<div class="outline-text-5" id="text-org57d0676">
<p>
<code>&lt;stropt.h&gt;</code>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 20:</span> Figure 14.18 Conditions for generating SIGPOLL signal</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Constant</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_INPUT</td>
<td class="org-left">We can read data (other than high-priority data) without blocking</td>
</tr>

<tr>
<td class="org-left">S_RDNORM</td>
<td class="org-left">We can read normal data without blocking</td>
</tr>

<tr>
<td class="org-left">S_RDBND</td>
<td class="org-left">We can read priority dat without blocking</td>
</tr>

<tr>
<td class="org-left">S_BANDURG</td>
<td class="org-left">If this constant is specified with S_RDBAND, the SIGURG signal is generated</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">instead of SIGPOLL When we can read priority data without blocking</td>
</tr>

<tr>
<td class="org-left">S_HIPRI</td>
<td class="org-left">we can read high-priority data without blocking</td>
</tr>

<tr>
<td class="org-left">S_OUTPUT</td>
<td class="org-left">We can write normal data wihout blocking</td>
</tr>

<tr>
<td class="org-left">S_WRNORM</td>
<td class="org-left">Same as S_OUTPUT</td>
</tr>

<tr>
<td class="org-left">S_WRBAND</td>
<td class="org-left">We can write priority data without blocing.</td>
</tr>

<tr>
<td class="org-left">S_MSG</td>
<td class="org-left">The SIGPOLL signal message has reached the stream head.</td>
</tr>

<tr>
<td class="org-left">S_ERROR</td>
<td class="org-left">The stream has an error.</td>
</tr>

<tr>
<td class="org-left">S_HANGUP</td>
<td class="org-left">The stream has hung up.</td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="orgbfdfd94"></a><span class="done DONE">DONE</span> 14.5.2 BSD Asynchronous I/O<br />
<div class="outline-text-5" id="text-orgbfdfd94">
<p>
Asynchronous I/O in BSD-derived system is a combination of two signals: SIGIO and SIGURG.
</p>

<p>
To receive the <code>SIGIO</code> signal, perform the following steps:
</p>
<ol class="org-ol">
<li>Establish a signal handler for SIGIO, by calling either <code>signal</code> or <code>sigaction</code>.</li>
<li>Set the process ID or process group ID to receive the signal for the descriptor, by calling <code>fcntl</code> with a command of <code>F_SETOWN</code> (Section 3.14)</li>
<li>Enable asynchronous I/O on the descriptor by calling <code>fcntl</code> with a command of <code>F_SETFL</code> to set the <code>O_ASYNC</code> file status flag (Figure 3.10)</li>
</ol>

<p>
For the <code>SIGURG</code> signal, we need perform only steps 1 and 2. <code>SIGURG</code> is generated only for descriptors that refer to network connections that support out-of-band data, such as TCP connections.
</p>
</div>
</li>
<li><a id="org3cc7f8a"></a><span class="done DONE">DONE</span> 14.5.3 POSIX Asynchronous I/O<br />
<div class="outline-text-5" id="text-org3cc7f8a">
<p>
The asynchronous I/O interfaces use AIO control blocks to describe I/O operations.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">aio_filedes</span>;    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">file descriptor</span>
    <span style="color: #df005f; font-weight: bold;">off_t</span>           <span style="color: #8787d7;">aio_offset</span>;     <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">file offset for I/O</span>
    <span style="color: #268bd2; font-weight: bold;">volatile</span> <span style="color: #df005f; font-weight: bold;">void</span>   *<span style="color: #8787d7;">aio_buf</span>;       <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">buffer for I/O</span>
    <span style="color: #df005f; font-weight: bold;">size_t</span>          <span style="color: #8787d7;">aio_nbytes</span>;     <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">number of bytes to transfer</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">aio_reqprio</span>;    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">priority</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigevent</span> <span style="color: #8787d7;">aio_sigevent</span>;   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">signal information</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">aio_lio_opcode</span>; <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">operation for list I/O</span>
<span style="color: #268bd2;">}</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigevent</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">sigev_notify</span>;                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">notify type</span>
    <span style="color: #df005f; font-weight: bold;">int</span>             <span style="color: #8787d7;">sigev_signo</span>;                 <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">signal number</span>
    <span style="color: #268bd2; font-weight: bold;">union</span> <span style="color: #df005f; font-weight: bold;">sigval</span>    <span style="color: #8787d7;">sigev_values</span>;                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">notify argument</span>
    <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7;">(</span>*sigev_notify_function<span style="color: #d75fd7;">)(</span><span style="color: #268bd2; font-weight: bold;">union</span> <span style="color: #df005f; font-weight: bold;">sigval</span><span style="color: #d75fd7;">)</span>; <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">notify function</span>
    <span style="color: #df005f; font-weight: bold;">pthread_attr_t</span> *<span style="color: #8787d7;">sigev_notify_attributes</span>;     <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">notify attrs</span>
<span style="color: #268bd2;">}</span>;
</pre>
</div>
<p>
<code>sigev_notify</code> taks one of three values:
</p>
<ul class="org-ul">
<li>SIGEV_NONE    The process is not notified when the asynchronous I/O request completes.</li>
<li>SIGEV_SIGNAL  The signal specified by the <code>sigev_signo</code> field is generated when the asynchronous I/O request completes.</li>
<li>SIGEV_THREAD  The function specified by the <code>sigev_notify_function</code> field is called when the asynchronous I/O request completes.</li>
</ul>


<p>
AIO related functions:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">aio.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">aio_read</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #8787d7;">aiocb</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">aio_write</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #8787d7;">aiocb</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return 0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">When the functions return success, the asynchronous I/O request has been queued for processing by the operating system.</span>

<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@brief force write all pending asynchronous</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">aio_fsync</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">op</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #8787d7;">aiocb</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>

<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@brief determine the completion status of beyond operations</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">air_error</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span>* <span style="color: #8787d7;">aiocb</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0             if SUCCESS (need to cal aio_return)</span>
<span style="color: #008787; background-color: #262626;">//         </span><span style="color: #008787; background-color: #262626;">-1            on ERROR (errno for details)</span>
<span style="color: #008787; background-color: #262626;">//         </span><span style="color: #008787; background-color: #262626;">EINPROGRESS   still pending</span>

<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@brief get return value if succeeded</span>
<span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #d75fd7; font-weight: bold;">aio_return</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #8787d7;">aiocb</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: return results if OK, -1 and set errno on error</span>

<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@brief block operation until an operation completes</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">aio_suspend</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #8787d7;">list</span><span style="color: #d75fd7;">[]</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">ncnt</span>,
                <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #8787d7;">timeout</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>

<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@brief cancel pending asynchronous I/O operations</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">aio_cancel</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #8787d7;">aiocb</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: AIO_ALLDONE      all of the operations completed before the attempt to cancel</span>
<span style="color: #008787; background-color: #262626;">//          </span><span style="color: #008787; background-color: #262626;">AIO_CANCELED     all of the requested operations have been canceled</span>
<span style="color: #008787; background-color: #262626;">//          </span><span style="color: #008787; background-color: #262626;">AIO_NOTCANCELED  at least one of the requested operations could not be canceled</span>
<span style="color: #008787; background-color: #262626;">//          </span><span style="color: #008787; background-color: #262626;">-1               failed.</span>
</pre>
</div>

<p>
additional function submits a set of I/O requests described by a list of AIO control blocks
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">aio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">lio_listio</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">mode</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #8787d7;">list</span><span style="color: #d75fd7;">[</span><span style="color: #268bd2; font-weight: bold;">restrict</span><span style="color: #d75fd7;">]</span>,
               <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">ncnt</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sigevent</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">sigev</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<p>
mode: <code>LIO_WAIT</code> / <code>LIO_NOWAIT</code>
list: points to a list of AIO control blocks specifying the I/O operations to perform (LIO_READ, LIO_WRITE in <code>aio_lio_opcode</code>)
ncnt: count of list
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 21:</span> Figure 14.19 POSIX.1 runtime invariant values for asynchronous I/O</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Minimum acceptable values</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">AIO_LISTIO_MAX</td>
<td class="org-left">maximum number of I/O operations in a single list I/O call</td>
<td class="org-left">_POSIX_AIO_LISTIO_MAX</td>
</tr>

<tr>
<td class="org-left">AIO_MAX</td>
<td class="org-left">maximum number of outstanding asynchronous I/O operations</td>
<td class="org-left">_POSIX_AIO_MAX</td>
</tr>

<tr>
<td class="org-left">AIO_PRIO_DELTA_MAX</td>
<td class="org-left">maximum amount by which a process can decrease its asynchronous I/O priority level</td>
<td class="org-left">0</td>
</tr>
</tbody>
</table>
<p>
<code>AIO_LISTIO_MAX</code>      = sysconf(_SC_IO_LISTIO_MAX)
<code>AIO_MAX</code>             = sysconf(_SC_AIO_MAX)
<code>AIO_PRIO_DELTA_MAX</code>  = sysconf(_SC_AIO_PRIO_DELTA_MAX)
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 118: </span>Figure 14.20 Translate a file using ROT-13</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     14fig20.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-26</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    translate a file using ROT-13</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *   block mode</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">ctype.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span>* <span style="color: #8787d7;">__progname</span>;

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">BSZ</span> <span style="color: #d75fd7;">4096</span>

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buf</span><span style="color: #268bd2;">[</span>BSZ<span style="color: #268bd2;">]</span>;

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #d75fd7; font-weight: bold;">translate</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">c</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>isalpha<span style="color: #2aa198;">(</span>c<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'n'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c -= <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'a'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c += <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'N'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c -= <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            c += <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> c;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span>* <span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">ifd</span>, <span style="color: #8787d7;">ofd</span>, <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">n</span>, <span style="color: #8787d7;">nw</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">3</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s infile outfile"</span>, __progname<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ifd = open<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ofd = open<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">2</span><span style="color: #875f00;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">2</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>n = read<span style="color: #67b11d;">(</span>ifd, buf, BSZ<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; n; ++i<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            buf<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span> = translate<span style="color: #67b11d;">(</span>buf<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>nw = write<span style="color: #875f00;">(</span>ofd, buf, n<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> != n<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>nw &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"write failed"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                err_quit<span style="color: #875f00;">(</span><span style="color: #2aa198;">"short write (%d/%d)"</span>, nw, n<span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    fsync<span style="color: #d75fd7;">(</span>ofd<span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 119: </span>Figure 14.21 Translate a file using ROT-13 and asynchronous I/O</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     14fig21.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-26</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    translate a file using ROT-13</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *   block mode</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">aio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">ctype.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__progname</span>;

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">BSZ</span>  <span style="color: #d75fd7;">4096</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NBUF</span> <span style="color: #d75fd7;">8</span>

<span style="color: #268bd2; font-weight: bold;">enum</span> <span style="color: #df005f; font-weight: bold;">rwop</span> <span style="color: #268bd2;">{</span> <span style="color: #8787d7;">UNUSED</span> = <span style="color: #d75fd7;">0</span>, <span style="color: #8787d7;">READ_PENDING</span> = <span style="color: #d75fd7;">1</span>, <span style="color: #8787d7;">WRITE_PENDING</span> = <span style="color: #d75fd7;">2</span> <span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">buf</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">enum</span> <span style="color: #df005f; font-weight: bold;">rwop</span>     <span style="color: #8787d7;">op</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>           <span style="color: #8787d7;">last</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span>  <span style="color: #8787d7;">aiocb</span>;
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">data</span><span style="color: #d75fd7;">[</span>BSZ<span style="color: #d75fd7;">]</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">buf</span> <span style="color: #8787d7;">bufs</span><span style="color: #268bd2;">[</span>NBUF<span style="color: #268bd2;">]</span>;

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #d75fd7; font-weight: bold;">translate</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">c</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>isalpha<span style="color: #2aa198;">(</span>c<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'n'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c -= <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'a'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c += <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'N'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c -= <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            c += <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> c;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">argv</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>                 <span style="color: #8787d7;">ifd</span>, <span style="color: #8787d7;">ofd</span>, <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">j</span>, <span style="color: #8787d7;">n</span>, <span style="color: #8787d7;">err</span>, <span style="color: #8787d7;">numop</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span>         <span style="color: #8787d7;">sbuf</span>;
    <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #8787d7;">aiolist</span><span style="color: #d75fd7;">[</span>NBUF<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">off_t</span>               <span style="color: #8787d7;">off</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">3</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s infile outfile"</span>, __progname<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ifd = open<span style="color: #67b11d;">(</span>STDIN_FILENO, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ofd = open<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">2</span><span style="color: #875f00;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">2</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NBUF; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.op                              = UNUSED;
        bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.aiocb.aio_buf                   = bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.data;
        bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.aiocb.aio_sigevent.sigev_notify = SIGEV_NONE;
        aiolist<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>                              = <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    numop = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NBUF; ++i<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #67b11d;">(</span>bufs<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>.op<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #268bd2; font-weight: bold;">case</span> UNUSED: <span style="color: #875f00;">{</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>off &lt; sbuf.st_size<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.op               = READ_PENDING;
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_fildes = ifd;
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_offset = off;
                        off += BSZ;
                        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>off &gt;= sbuf.st_size<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
                            bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.last = <span style="color: #d75fd7;">1</span>;
                        <span style="color: #d75fd7;">}</span>
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_nbytes = BSZ;
                        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>aio_read<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
                            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"aio_read failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span>
                        aiolist<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span> = &amp;bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb;
                        numop++;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #875f00;">}</span>

                <span style="color: #268bd2; font-weight: bold;">case</span> READ_PENDING: <span style="color: #875f00;">{</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>err = aio_error<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> == EINPROGRESS<span style="color: #268bd2;">)</span>
                        <span style="color: #268bd2; font-weight: bold;">continue</span>;

                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
                            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"aio_error failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
                            err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"read failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span>
                    <span style="color: #268bd2;">}</span>

                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>n = aio_return<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"aio_return failed"</span><span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>n != BSZ &amp;&amp; <span style="color: #d75fd7;">!</span>bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.last<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_quit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"short read (%d/%d)"</span>, n, BSZ<span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>j = <span style="color: #d75fd7;">0</span>; j &lt; n; ++j<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.data<span style="color: #d75fd7;">[</span>j<span style="color: #d75fd7;">]</span> = translate<span style="color: #d75fd7;">(</span>bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.data<span style="color: #2aa198;">[</span>j<span style="color: #2aa198;">]</span><span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>

                    bufs<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>.op               = WRITE_PENDING;
                    bufs<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>.aiocb.aio_fildes = ofd;
                    bufs<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>.aiocb.aio_nbytes = n;
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>aio_write<span style="color: #d75fd7;">(</span>&amp;bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.aiocb<span style="color: #d75fd7;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"aio_write failed"</span><span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>

                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #875f00;">}</span>

                <span style="color: #268bd2; font-weight: bold;">case</span> WRITE_PENDING: <span style="color: #875f00;">{</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>err = aio_error<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> == EINPROGRESS<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        <span style="color: #268bd2; font-weight: bold;">continue</span>;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
                            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"aio_error failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
                            err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"write failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span>
                    <span style="color: #268bd2;">}</span>

                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>n = aio_return<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"aio_return failed"</span><span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>n != bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_nbytes<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_quit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"short write (%d/%d)"</span>, n,
                                 bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.aiocb.aio_nbytes<span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>

                    aiolist<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span> = <span style="color: #d75fd7;">NULL</span>;
                    bufs<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>.op = UNUSED;
                    numop--;
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #875f00;">}</span>

                <span style="color: #268bd2; font-weight: bold;">default</span>:
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>numop == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>off &gt;= sbuf.st_size<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>aio_suspend<span style="color: #875f00;">(</span>aiolist, NBUF, <span style="color: #d75fd7;">NULL</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"aio_suspend failed"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_fildes = ofd;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>aio_fsync<span style="color: #2aa198;">(</span>O_SYNC, &amp;bufs<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span>.aiocb<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"aio_fsync failed"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span>EXIT_SUCCESS<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
<blockquote>
<p>
this might actually reduce performance—if the reads are presented to the ﬁle system out of order, it can defeat the operating system's read-ahead algorithm.
</p>
</blockquote>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgc60bd6e" class="outline-4">
<h4 id="orgc60bd6e"><span class="done DONE">DONE</span> 14.6 <code>readv</code> and <code>writev</code> Functions</h4>
<div class="outline-text-4" id="text-orgc60bd6e">
<p>
<i>scatter read</i> and <i>gather write</i>.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/uio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #d75fd7; font-weight: bold;">readv</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">iovec</span> *<span style="color: #8787d7;">iov</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">iovcnt</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #d75fd7; font-weight: bold;">writev</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">iovec</span> *<span style="color: #8787d7;">iov</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">iovcnt</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: number of bytes read or written, -1 on error</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">iovec</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">void</span>   *<span style="color: #8787d7;">ivo_base</span>;                 <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">starting address of buffer</span>
    <span style="color: #df005f; font-weight: bold;">size_t</span>  <span style="color: #8787d7;">iov_len</span>;                  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">sizeof of buffer</span>
<span style="color: #268bd2;">}</span>;
</pre>
</div>


<div class="figure">
<p><img src="Chapter14/14fig22.jpg" alt="14fig22.jpg" />
</p>
<p><span class="figure-number">Figure 16: </span>Figure 14.22 The iovec structure for readv and writev</p>
</div>

<p>
Three ways to write two buffers consecutively to a file:
</p>
<ol class="org-ol">
<li>Call <code>write</code> twice, once for each buffer</li>
<li>allocate a buffer, merge two buffers into the allocated buffer, then call <code>write</code></li>
<li>call <code>writev</code> to both buffers</li>
</ol>


<div class="figure">
<p><img src="Chapter14/14fig23.jpg" alt="14fig23.jpg" />
</p>
<p><span class="figure-number">Figure 17: </span>Figure 14.23 Timing results comparing writev and other techniques</p>
</div>
</div>
</div>
<div id="outline-container-org0326513" class="outline-4">
<h4 id="org0326513"><span class="done DONE">DONE</span> 14.7 <code>readn</code> and <code>writen</code> Functions</h4>
<div class="outline-text-4" id="text-org0326513">
<p>
impletations for reading/writing only <i>n</i> bytes
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>
<span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #d75fd7; font-weight: bold;">readn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">buf</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">nbytes</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #d75fd7; font-weight: bold;">writen</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">buf</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">nbyts</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both Returns: number of bytes read or write, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 120: </span>Figure 14.24 The <code>readn</code> and <code>writen</code> functions</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     14fig24.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    implementations of readn and writen</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #d75fd7; font-weight: bold;">readn</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">ptr</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">n</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">size_t</span>  <span style="color: #8787d7;">nleft</span>;
    <span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #8787d7;">nread</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>nleft = n; nleft &gt; <span style="color: #d75fd7;">0</span>; nleft -= nread<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>nread = read<span style="color: #875f00;">(</span>fd, ptr, nleft<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">error occured</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>nleft == n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">no read</span>
                <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">return read amount</span>
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>nread == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
        ptr += nread;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> n - nleft;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #d75fd7; font-weight: bold;">writen</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">ptr</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">n</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">size_t</span>  <span style="color: #8787d7;">nleft</span>;
    <span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #8787d7;">nwritten</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>nleft = n; nleft &gt; <span style="color: #d75fd7;">0</span>; nleft -= nwritten<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>nwritten = write<span style="color: #875f00;">(</span>fd, ptr, nleft<span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">error occured</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>nleft == n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">no written</span>
                <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">return written amount</span>
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>nwritten == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
        ptr += nwritten;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> n - nleft;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org89786a6" class="outline-4">
<h4 id="org89786a6"><span class="done DONE">DONE</span> 14.9 Summary</h4>
<div class="outline-text-4" id="text-org89786a6">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
14.1
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex14.1.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-28</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    test write lock</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/select.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">fd_set</span> <span style="color: #8787d7;">set</span>;

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sigint</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{}</span>

<span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid1</span>, <span style="color: #8787d7;">pid2</span>, <span style="color: #8787d7;">pid3</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span>;

    setbuf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    signal_intr<span style="color: #d75fd7;">(</span>SIGINT, sigint<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = open<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"lockfile"</span>, O_RDWR | O_CREAT, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't create lockfile"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid1 = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">case</span> -<span style="color: #d75fd7;">1</span>:
            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork failed"</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #d75fd7;">0</span>: <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>read_lock<span style="color: #875f00;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_SET, <span style="color: #d75fd7;">0</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"child 1: can't set RD-LOCK on file"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child 1: read lock on file.\n"</span><span style="color: #67b11d;">)</span>;
            pause<span style="color: #67b11d;">()</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child 1: exit.\n"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_SUCCESS<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">default</span>:
            sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid2 = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">case</span> -<span style="color: #d75fd7;">1</span>:
            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork failed"</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #d75fd7;">0</span>: <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>read_lock<span style="color: #875f00;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_SET, <span style="color: #d75fd7;">0</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"child 2: can't set RD-LOCK on file"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child 2: read lock on file.\n"</span><span style="color: #67b11d;">)</span>;
            pause<span style="color: #67b11d;">()</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child 2: exit.\n"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_SUCCESS<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">default</span>:
            sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid3 = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">case</span> -<span style="color: #d75fd7;">1</span>:
            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork failed"</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #268bd2; font-weight: bold;">case</span> <span style="color: #d75fd7;">0</span>: <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write_lock<span style="color: #875f00;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_SET, <span style="color: #d75fd7;">0</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"child 3: can't set WR-LOCK on file.\n"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child 3: wait to set WR_LOCK.\n"</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>writew_lock<span style="color: #875f00;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_SET, <span style="color: #d75fd7;">0</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"child 3: can't WR-LOCK on file"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child 3: obtained write lock on file.\n"</span><span style="color: #67b11d;">)</span>;
            pause<span style="color: #67b11d;">()</span>;
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child 3: exit.\n"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_SUCCESS<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">default</span>:
            sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>read_lock<span style="color: #2aa198;">(</span>fd, <span style="color: #d75fd7;">0</span>, SEEK_SET, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"parent: can't set RD-LOCK on file: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        printf<span style="color: #2aa198;">(</span>
            <span style="color: #2aa198;">"parent: set RD-LOCK on file success while WR-LOCK is pending.\n"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"killing child 1...\n"</span><span style="color: #d75fd7;">)</span>;
    kill<span style="color: #d75fd7;">(</span>pid1, SIGINT<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"killing child 2...\n"</span><span style="color: #d75fd7;">)</span>;
    kill<span style="color: #d75fd7;">(</span>pid2, SIGINT<span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"killing child 3...\n"</span><span style="color: #d75fd7;">)</span>;
    kill<span style="color: #d75fd7;">(</span>pid3, SIGINT<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
14.2
</p>
<blockquote>
<p>
Most systems define the fd_set data type to be a structure that contains a single member: an array of long integers. One bit in this array corresponds to each descriptor. The four FD_ macros then manipulate this array of longs, turning specific bits on and off and testing specific bits.
</p>

<p>
One reason that the data type is defined to be a structure containing an array and not simply an array is to allow variables of type fd_set to be assigned to one another with the C assignment statement.
</p>
</blockquote></li>
<li>14.3
define or redefine(undefine first) the macro <code>FD_SETSIZE</code> (or <code>__FD_SETSIZE</code>)</li>
<li><p>
14.4
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">file descriptor sets</th>
<th scope="col" class="org-left">signal sets</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">FD_ZERO</td>
<td class="org-left">sigemptyset</td>
</tr>

<tr>
<td class="org-left">FD_SET</td>
<td class="org-left">sigaddset</td>
</tr>

<tr>
<td class="org-left">FD_CLR</td>
<td class="org-left">sigdelset</td>
</tr>

<tr>
<td class="org-left">FD_ISSET</td>
<td class="org-left">sigismember</td>
</tr>
</tbody>
</table></li>
<li><p>
14.5
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex14.5.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-29</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    wait for specified number of microseconds via select</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/poll.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/select.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sleep_us_select</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">nusecs</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">tval</span>;

    tval.tv_sec  = nusecs / <span style="color: #d75fd7;">10e6</span>;
    tval.tv_usec = nusecs % <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span><span style="color: #d75fd7;">)</span><span style="color: #d75fd7;">10e6</span>;
    select<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span>, &amp;tval<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sleep_us_poll</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">nusecs</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">pollfd</span> <span style="color: #8787d7;">fds</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>           <span style="color: #8787d7;">timeout</span>;

    timeout = nusecs / <span style="color: #d75fd7;">10e3</span>;
    timeout = timeout &lt;= <span style="color: #d75fd7;">0</span> ? <span style="color: #d75fd7;">1</span> : timeout;

    poll<span style="color: #d75fd7;">(</span>&amp;fds, <span style="color: #d75fd7;">0</span>, timeout<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    setbuf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"before select sleep\n"</span><span style="color: #d75fd7;">)</span>;
    sleep_us_select<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">2</span> * <span style="color: #d75fd7;">10e6</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"after select sleep\n"</span><span style="color: #d75fd7;">)</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"before poll sleep\n"</span><span style="color: #d75fd7;">)</span>;
    sleep_us_poll<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">2</span> * <span style="color: #d75fd7;">10e6</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"after poll sleep\n"</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>14.6
No. <b>call <code>fork</code> releases all the locks in the child, so the child can't start off with any locks of its own</b></li>
<li><p>
14.7
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex14.7.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-29</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    pipe using nonblocking writes.</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">limits.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error."</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    set_fl<span style="color: #d75fd7;">(</span>fd<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, O_NONBLOCK<span style="color: #d75fd7;">)</span>;

    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">capacity</span>;
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>capacity = <span style="color: #d75fd7;">0</span>;; capacity++<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">nwritten</span> = <span style="color: #d75fd7;">0</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>nwritten = write<span style="color: #875f00;">(</span>fd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, <span style="color: #2aa198;">"a"</span>, <span style="color: #d75fd7;">1</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"nwritten = %d\n"</span>, nwritten<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"capacity = %d\n"</span>, capacity<span style="color: #d75fd7;">)</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"PIPE_BUF = %d\n"</span>, PIPE_BUF<span style="color: #d75fd7;">)</span>;

    exit<span style="color: #d75fd7;">(</span>EXIT_SUCCESS<span style="color: #d75fd7;">)</span>;

<span style="color: #268bd2;">}</span>
</pre>
</div>
<blockquote>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Platform</th>
<th scope="col" class="org-right">Pipe Capacity(bytes)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">FreeBSD 8.0</td>
<td class="org-right">65536</td>
</tr>

<tr>
<td class="org-left"><b>Linux 4.1.0</b></td>
<td class="org-right">65536</td>
</tr>

<tr>
<td class="org-left"><b>Mac OS X 10.15.2</b></td>
<td class="org-right">65536</td>
</tr>

<tr>
<td class="org-left">Solaris 10</td>
<td class="org-right">16384</td>
</tr>
</tbody>
</table>

<p>
These values can differ from the corresponding <code>PIPE_BUF</code> values, because PIPE_BUF is defined to be the maximum amount of data that <b>can be written</b> to a pipe atomically. Here, we calculate the amount of data that a pipe <b>can hold</b> independent of any atomicity constraints.
</p>
</blockquote></li>
<li><p>
14.8
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex14.8.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-26</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    rewrite 14fig21.c</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *   block mode</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">aio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">ctype.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__progname</span>;

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">BSZ</span>  <span style="color: #d75fd7;">4096</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NBUF</span> <span style="color: #d75fd7;">8</span>

<span style="color: #268bd2; font-weight: bold;">enum</span> <span style="color: #df005f; font-weight: bold;">rwop</span> <span style="color: #268bd2;">{</span> <span style="color: #8787d7;">UNUSED</span> = <span style="color: #d75fd7;">0</span>, <span style="color: #8787d7;">READ_PENDING</span> = <span style="color: #d75fd7;">1</span>, <span style="color: #8787d7;">WRITE_PENDING</span> = <span style="color: #d75fd7;">2</span> <span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">buf</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">enum</span> <span style="color: #df005f; font-weight: bold;">rwop</span>     <span style="color: #8787d7;">op</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>           <span style="color: #8787d7;">last</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span>  <span style="color: #8787d7;">aiocb</span>;
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">data</span><span style="color: #d75fd7;">[</span>BSZ<span style="color: #d75fd7;">]</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">buf</span> <span style="color: #8787d7;">bufs</span><span style="color: #268bd2;">[</span>NBUF<span style="color: #268bd2;">]</span>;

<span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #d75fd7; font-weight: bold;">translate</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">c</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>isalpha<span style="color: #2aa198;">(</span>c<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'n'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c -= <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'a'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c += <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c &gt;= <span style="color: #2aa198;">'N'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c -= <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            c += <span style="color: #d75fd7;">13</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> c;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> **<span style="color: #8787d7;">argv</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>                 <span style="color: #8787d7;">ifd</span>, <span style="color: #8787d7;">ofd</span>, <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">j</span>, <span style="color: #8787d7;">n</span>, <span style="color: #8787d7;">err</span>, <span style="color: #8787d7;">numop</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span>         <span style="color: #8787d7;">sbuf</span>;
    <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">aiocb</span> *<span style="color: #8787d7;">aiolist</span><span style="color: #d75fd7;">[</span>NBUF<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">off_t</span>               <span style="color: #8787d7;">off</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if (argc != 3) {</span>
    <span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">err_quit("usage: %s infile outfile", __progname);</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if ((ifd = open(argv[1], O_RDONLY)) &lt; 0) {</span>
    <span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">err_sys("can't open %s", argv[1]);</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if ((ofd = open(argv[2], O_RDWR | O_CREAT | O_TRUNC, FILE_MODE)) &lt; 0) {</span>
    <span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">err_sys("can't open %s", argv[2]);</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">}</span>

    ifd = STDIN_FILENO;         <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">for pipe: ifd = pfd[0]?</span>
    ofd = STDOUT_FILENO;        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">for pipe: ofd = pfd[1]?</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NBUF; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.op                              = UNUSED;
        bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.aiocb.aio_buf                   = bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.data;
        bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.aiocb.aio_sigevent.sigev_notify = SIGEV_NONE;
        aiolist<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>                              = <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    numop = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NBUF; ++i<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">switch</span> <span style="color: #67b11d;">(</span>bufs<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>.op<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #268bd2; font-weight: bold;">case</span> UNUSED: <span style="color: #875f00;">{</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>off &lt; sbuf.st_size<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.op               = READ_PENDING;
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_fildes = ifd;
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_offset = off;
                        off += BSZ;
                        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>off &gt;= sbuf.st_size<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
                            bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.last = <span style="color: #d75fd7;">1</span>;
                        <span style="color: #d75fd7;">}</span>
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_nbytes = BSZ;
                        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>aio_read<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
                            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"aio_read failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span>
                        aiolist<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span> = &amp;bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb;
                        numop++;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #875f00;">}</span>

                <span style="color: #268bd2; font-weight: bold;">case</span> READ_PENDING: <span style="color: #875f00;">{</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>err = aio_error<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> == EINPROGRESS<span style="color: #268bd2;">)</span>
                        <span style="color: #268bd2; font-weight: bold;">continue</span>;

                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
                            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"aio_error failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
                            err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"read failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span>
                    <span style="color: #268bd2;">}</span>

                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>n = aio_return<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"aio_return failed"</span><span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>n != BSZ &amp;&amp; <span style="color: #d75fd7;">!</span>bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.last<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_quit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"short read (%d/%d)"</span>, n, BSZ<span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #268bd2;">(</span>j = <span style="color: #d75fd7;">0</span>; j &lt; n; ++j<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.data<span style="color: #d75fd7;">[</span>j<span style="color: #d75fd7;">]</span> = translate<span style="color: #d75fd7;">(</span>bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.data<span style="color: #2aa198;">[</span>j<span style="color: #2aa198;">]</span><span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>

                    bufs<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>.op               = WRITE_PENDING;
                    bufs<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>.aiocb.aio_fildes = ofd;
                    bufs<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>.aiocb.aio_nbytes = n;
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>aio_write<span style="color: #d75fd7;">(</span>&amp;bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.aiocb<span style="color: #d75fd7;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"aio_write failed"</span><span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>

                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #875f00;">}</span>

                <span style="color: #268bd2; font-weight: bold;">case</span> WRITE_PENDING: <span style="color: #875f00;">{</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>err = aio_error<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> == EINPROGRESS<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        <span style="color: #268bd2; font-weight: bold;">continue</span>;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>err != <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>err == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
                            err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"aio_error failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
                            err_exit<span style="color: #2aa198;">(</span>err, <span style="color: #2aa198;">"write failed"</span><span style="color: #2aa198;">)</span>;
                        <span style="color: #d75fd7;">}</span>
                    <span style="color: #268bd2;">}</span>

                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span>n = aio_return<span style="color: #2aa198;">(</span>&amp;bufs<span style="color: #9cb6ad;">[</span>i<span style="color: #9cb6ad;">]</span>.aiocb<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_sys<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"aio_return failed"</span><span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>
                    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #268bd2;">(</span>n != bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_nbytes<span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
                        err_quit<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"short write (%d/%d)"</span>, n,
                                 bufs<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.aiocb.aio_nbytes<span style="color: #d75fd7;">)</span>;
                    <span style="color: #268bd2;">}</span>

                    aiolist<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span> = <span style="color: #d75fd7;">NULL</span>;
                    bufs<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>.op = UNUSED;
                    numop--;
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
                <span style="color: #875f00;">}</span>

                <span style="color: #268bd2; font-weight: bold;">default</span>:
                    <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>numop == <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>off &gt;= sbuf.st_size<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>aio_suspend<span style="color: #875f00;">(</span>aiolist, NBUF, <span style="color: #d75fd7;">NULL</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"aio_suspend failed"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    bufs<span style="color: #d75fd7;">[</span>i<span style="color: #d75fd7;">]</span>.aiocb.aio_fildes = ofd;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>aio_fsync<span style="color: #2aa198;">(</span>O_SYNC, &amp;bufs<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span>.aiocb<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"aio_fsync failed"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span>EXIT_SUCCESS<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li>14.9
just try to execute the program with a very large file</li>
<li>14.10
Not changed</li>
<li><p>
14.11
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     ex14.11.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2019-12-29</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    rewrite 14fig27</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  close fd after calling mmap</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/mman.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/select.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">COPYINCR</span> <span style="color: #268bd2;">(</span><span style="color: #d75fd7;">1024</span> * <span style="color: #d75fd7;">1024</span> * <span style="color: #d75fd7;">1024</span><span style="color: #268bd2;">)</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">1GB</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>         <span style="color: #8787d7;">fdin</span>, <span style="color: #8787d7;">fdout</span>;
    <span style="color: #df005f; font-weight: bold;">void</span> *      <span style="color: #8787d7;">src</span>, *<span style="color: #8787d7;">dst</span>;
    <span style="color: #df005f; font-weight: bold;">size_t</span>      <span style="color: #8787d7;">copysz</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span> <span style="color: #8787d7;">sbuf</span>;
    <span style="color: #df005f; font-weight: bold;">off_t</span>       <span style="color: #8787d7;">fsz</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">3</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s &lt;from-file&gt; &lt;to-file&gt;"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fdin = open<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %s for reading"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fdout = open<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">2</span><span style="color: #875f00;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't create %s for writting"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">2</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fstat<span style="color: #2aa198;">(</span>fdin, &amp;sbuf<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fstat error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">If we don&#8217;t set the output file&#8217;s size, the call to mmap for the output</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">file is successful, but the first reference to the associated memory</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">region generates a SIGBUS signal.</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ftruncate<span style="color: #2aa198;">(</span>fdout, sbuf.st_size<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"ftruncate error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fsz &lt; sbuf.st_size<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>sbuf.st_size - fsz<span style="color: #67b11d;">)</span> &gt; COPYINCR<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            copysz = COPYINCR;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            copysz = sbuf.st_size - fsz;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>src = mmap<span style="color: #875f00;">(</span><span style="color: #d75fd7;">0</span>, copysz, PROT_READ, MAP_SHARED, fdin, fsz<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> ==
            MAP_FAILED<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"mmap error for input"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">calling close fd to verify</span>
        close<span style="color: #2aa198;">(</span>fdin<span style="color: #2aa198;">)</span>;


        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>dst = mmap<span style="color: #875f00;">(</span><span style="color: #d75fd7;">0</span>, copysz, PROT_READ | PROT_WRITE, MAP_SHARED, fdout,
                        fsz<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == MAP_FAILED<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"mmap error for output"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        close<span style="color: #2aa198;">(</span>fdout<span style="color: #2aa198;">)</span>;

        memcpy<span style="color: #2aa198;">(</span>dst, src, copysz<span style="color: #2aa198;">)</span>;

        munmap<span style="color: #2aa198;">(</span>src, copysz<span style="color: #2aa198;">)</span>;
        munmap<span style="color: #2aa198;">(</span>dst, copysz<span style="color: #2aa198;">)</span>;
        fsz += copysz;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgfe8102c" class="outline-3">
<h3 id="orgfe8102c"><span class="todo TODO">TODO</span> Chapter 15. Interprocess Communication <code>[11/12]</code></h3>
<div class="outline-text-3" id="text-orgfe8102c">
</div>
<div id="outline-container-orgccd86f3" class="outline-4">
<h4 id="orgccd86f3"><span class="done DONE">DONE</span> 15.1 Introduction</h4>
<div class="outline-text-4" id="text-orgccd86f3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 22:</span> Figure 15.1 Summary of UNIX System IPC</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">IPC type</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD 8.0</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
<th scope="col" class="org-left">Solaris 10</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">half-duplex pipes</td>
<td class="org-left">*</td>
<td class="org-left">(full)</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">(full)</td>
</tr>

<tr>
<td class="org-left">FIFOs</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">full-duplex pipes</td>
<td class="org-left">allowed</td>
<td class="org-left">*, UDS</td>
<td class="org-left">UDS</td>
<td class="org-left">UDS</td>
<td class="org-left">*, UDS</td>
</tr>

<tr>
<td class="org-left">named full-duplex pipes</td>
<td class="org-left">obsolescent</td>
<td class="org-left">UDS</td>
<td class="org-left">UDS</td>
<td class="org-left">UDS</td>
<td class="org-left">*, UDS</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">XSI message queues</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">XSI semaphores</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">XSI shared memory</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">message queues (real-time)</td>
<td class="org-left">MSG option</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">semaphores</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">shared memory  (real-time)</td>
<td class="org-left">SHM option</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">sockets</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">STREAMS</td>
<td class="org-left">obsolescent</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org2ac5526" class="outline-4">
<h4 id="org2ac5526"><span class="done DONE">DONE</span> 15.2 Pipes</h4>
<div class="outline-text-4" id="text-org2ac5526">
<p>
Limitations:
</p>
<ol class="org-ol">
<li>for maximum protability, we should never assume that ful-duplex pipes is the case</li>
<li>pipes can be used only between proesses that have a common ancestor.</li>
</ol>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h.</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief create pipe</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @param  fd[0]  open for reading</span>
<span style="color: #008787; background-color: #262626;"> *         fd[1]  open for writing</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @retval 0     OK</span>
<span style="color: #008787; background-color: #262626;"> * @retval -1    error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pipe</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span><span style="color: #268bd2;">)</span>;
</pre>
</div>


<div class="figure">
<p><img src="Chapter15/15fig02.jpg" alt="15fig02.jpg" />
</p>
<p><span class="figure-number">Figure 18: </span>Figure 15.2 Two ways to view a half-duplex pipe</p>
</div>


<div class="figure">
<p><img src="Chapter15/15fig03.jpg" alt="15fig03.jpg" />
</p>
<p><span class="figure-number">Figure 19: </span>Figure 15.3 Half-duplex pipe after a fork</p>
</div>


<div class="figure">
<p><img src="Chapter15/15fig04.jpg" alt="15fig04.jpg" />
</p>
<p><span class="figure-number">Figure 20: </span>Figure 15.4 Pipe from parent to child</p>
</div>

<p>
the parent closes fd[1], and the child closes fd[0].
</p>

<blockquote>
<p>
When one end of a pipe is closed, two rules apply.
</p>
<ol class="org-ol">
<li>If we read from a pipe whose write end has been closed, read returns 0 to indicate an EOF <b>after</b> all data has been read.</li>
<li>If we write to a pipe whose read end has been closed, the signal SIGPIPE is generated. If we either ignore the signal or catch it and return from the signal handler, write returns -1 with errno set to EPIPE.</li>
</ol>
</blockquote>

<p>
the constant <code>PIPE_BUF</code> specifies the kernel's pipe buffer size.
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 121: </span>Figure 15.5 Send data from parent to child over a pipe</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig05.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-04</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Figure 15.5 send data from parent to child over a pipe</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pipe<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        write<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span>, <span style="color: #2aa198;">"hello world\n"</span>, <span style="color: #d75fd7;">12</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        n = read<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span>, line, MAXLINE<span style="color: #2aa198;">)</span>;
        write<span style="color: #2aa198;">(</span>STDOUT_FILENO, line, n<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 122: </span>Figure 15.6 Copy file to pager program</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig06.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-04</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    copy file to pager program</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__progname</span>;

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">DEF_PAGER</span> <span style="color: #2aa198;">"/bin/more"</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">default pager program</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pager</span>, *<span style="color: #8787d7;">argv0</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s &lt;pathname&gt;"</span>, __progname<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;

    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">child</span>
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close write end</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #875f00;">(</span>fd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">]</span>, STDIN_FILENO<span style="color: #875f00;">)</span> != STDIN_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"dup2 error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>pager = getenv<span style="color: #875f00;">(</span><span style="color: #2aa198;">"PAGER"</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            pager = DEF_PAGER;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>argv0 = strchr<span style="color: #875f00;">(</span>pager, <span style="color: #2aa198;">'/'</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            argv0++;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            argv0 = pager;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>execl<span style="color: #67b11d;">(</span>pager, argv0, <span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #875f00;">)</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"execl error for %s"</span>, pager<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">parent</span>
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close read end</span>

        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>fgets<span style="color: #67b11d;">(</span>line, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span>line<span style="color: #875f00;">)</span>, fp<span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #875f00;">(</span>fd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, line, n<span style="color: #875f00;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"write to pipe error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ferror<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fgets error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 123: </span>Figure 15.7 Routine to let a parent and child synchronized</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig07.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-07</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Routines to let a parent and child synchronize</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">pfd1</span><span style="color: #268bd2;">[</span><span style="color: #d75fd7;">2</span><span style="color: #268bd2;">]</span>, <span style="color: #8787d7;">pfd2</span><span style="color: #268bd2;">[</span><span style="color: #d75fd7;">2</span><span style="color: #268bd2;">]</span>;

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">TELL_WAIT</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>pfd1<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span> || pipe<span style="color: #2aa198;">(</span>pfd2<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">TELL_PARENT</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>write<span style="color: #2aa198;">(</span>pfd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span>, <span style="color: #2aa198;">"c"</span>, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">WAIT_PARENT</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">c</span> ;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>read<span style="color: #2aa198;">(</span>pfd1<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span>, &amp;c, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>c != <span style="color: #2aa198;">'p'</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"WAIT_PARENT: incorrect data"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">TELL_CHILD</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>write<span style="color: #2aa198;">(</span>pfd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span>, <span style="color: #2aa198;">"p"</span>, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">WAIT_CHILD</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">c</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span><span style="color: #d75fd7;">(</span>read<span style="color: #2aa198;">(</span>pfd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span>, &amp;c, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>c != <span style="color: #2aa198;">'c'</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"WAIT_CHILD: incorrect data"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>


<div class="figure">
<p><img src="Chapter15/15fig08.jpg" alt="15fig08.jpg" />
</p>
<p><span class="figure-number">Figure 21: </span>Figure 15.8 Using two pipes for parent-child synchronization</p>
</div>
</div>
</div>
<div id="outline-container-orge82d4b8" class="outline-4">
<h4 id="orge82d4b8"><span class="done DONE">DONE</span> 15.3 <code>popen</code> and <code>pclose</code> Functions</h4>
<div class="outline-text-4" id="text-orge82d4b8">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@brief fork() , then exec()</span>
<span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #d75fd7; font-weight: bold;">popen</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cmdstring</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">type</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: file pointer if OK, NULL on error</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pclose</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: termination status of cmdstring, or -1 on error</span>
</pre>
</div>
<p>
<code>type == "r"</code>:
</p>
<p>
<img src="Chapter15/15fig09.jpg" alt="15fig09.jpg" />
<code>type == "w"</code>:
</p>

<div class="figure">
<p><img src="Chapter15/15fig10.jpg" alt="15fig10.jpg" />
</p>
<p><span class="figure-number">Figure 22: </span>Figure 15.10 Result of fp = popen(cmdstring, "w");</p>
</div>

<p>
The <i>cmdstring</i> is executed by bash, as in
</p>
<div class="org-src-container">
<pre class="src src-bash">sh -c cmdstring
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 124: </span>Figure 15.11 Copy file to pager program using <code>popen</code></label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig11.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-07</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    copy file to pager program using popen</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">PAGER</span> <span style="color: #2aa198;">"${PAGER:-more}"</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">environment variable, or default</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__progname</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fpin</span>, *<span style="color: #8787d7;">fpout</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s &lt;pathname&gt;"</span>, __progname<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fpin = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open %s error"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fpout = popen<span style="color: #67b11d;">(</span>PAGER, <span style="color: #2aa198;">"w"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"popen error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fgets<span style="color: #2aa198;">(</span>line, MAXLINE, fpin<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fputs<span style="color: #67b11d;">(</span>line, fpout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fputs error to pipe"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>ferror<span style="color: #2aa198;">(</span>fpin<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fgets error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fclose<span style="color: #2aa198;">(</span>fpin<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fclose error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pclose<span style="color: #2aa198;">(</span>fpout<span style="color: #2aa198;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pclose error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 125: </span>Figure 15.12 The <code>popen</code> and <code>pclose</code> functions</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig12.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-07</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    shows our version of popen and pclose</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Pointer to array allocated at run-time</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">pid_t</span> *<span style="color: #8787d7;">childpid</span> = <span style="color: #d75fd7;">NULL</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">From our open_max(), Figure 2.17</span>
<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">maxfd</span>;

<span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #d75fd7; font-weight: bold;">popen</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">cmdstring</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">type</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">i</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">pfd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">only allow "r" or "w"</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>type<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span> != <span style="color: #2aa198;">'r'</span> &amp;&amp; type<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span> != <span style="color: #2aa198;">'w'</span><span style="color: #2aa198;">)</span> || type<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span> != <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">for more than once we called popen, store pid</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>childpid == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        maxfd = open_max<span style="color: #2aa198;">()</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>childpid = calloc<span style="color: #875f00;">(</span>maxfd, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #268bd2;">(</span>pid_t<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>pfd<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pfd<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span> &gt;= maxfd || pfd<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span> &gt;= maxfd<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        close<span style="color: #2aa198;">(</span>pfd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        close<span style="color: #2aa198;">(</span>pfd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        errno = EMFILE;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>*type == <span style="color: #2aa198;">'r'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            close<span style="color: #67b11d;">(</span>pfd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pfd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span> != STDOUT_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                dup2<span style="color: #875f00;">(</span>pfd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, STDOUT_FILENO<span style="color: #875f00;">)</span>;
                close<span style="color: #875f00;">(</span>pfd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            close<span style="color: #67b11d;">(</span>pfd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pfd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span> != STDIN_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                dup2<span style="color: #875f00;">(</span>pfd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">]</span>, STDIN_FILENO<span style="color: #875f00;">)</span>;
                close<span style="color: #875f00;">(</span>pfd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">]</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>

        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close all descriptors in childpid</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; maxfd; ++i<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>childpid<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                close<span style="color: #875f00;">(</span>i<span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>

        execl<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"/bin/sh"</span>, <span style="color: #2aa198;">"sh"</span>, <span style="color: #2aa198;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
        _exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">127</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">parent continues ...</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>*type == <span style="color: #2aa198;">'r'</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        close<span style="color: #2aa198;">(</span>pfd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>fp = fdopen<span style="color: #875f00;">(</span>pfd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">]</span>, type<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            close<span style="color: #67b11d;">(</span>pfd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>fp = fdopen<span style="color: #268bd2;">(</span>pfd<span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">]</span>, type<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    childpid<span style="color: #d75fd7;">[</span>fileno<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">]</span> = pid;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">remember child pid for this fd;</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">pclose</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span>, <span style="color: #8787d7;">stat</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>childpid == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">popen has never been called</span>
    <span style="color: #d75fd7;">}</span>

    fd = fileno<span style="color: #d75fd7;">(</span>fp<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fd &gt; maxfd<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = childpid<span style="color: #67b11d;">[</span>fd<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = EINVAL;
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>

    childpid<span style="color: #d75fd7;">[</span>fd<span style="color: #d75fd7;">]</span> = <span style="color: #d75fd7;">0</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>fclose<span style="color: #2aa198;">(</span>fp<span style="color: #2aa198;">)</span> == EOF<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">fp wasn't opened by popen()</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>waitpid<span style="color: #2aa198;">(</span>pid, &amp;stat, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>errno != EINTR<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">error other than EINTR from waitpid();</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>stat<span style="color: #d75fd7;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">return child's termination status</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>


<div class="figure">
<p><img src="Chapter15/15fig13.jpg" alt="15fig13.jpg" />
</p>
<p><span class="figure-number">Figure 23: </span>Figure 15.13 Transforming input using <code>popen</code></p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 126: </span>Figure 15.14 Filter to convert uppercase characters to lowercase</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig14.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-07</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    filter to convert uppercase characters to lowercase</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">ctype.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">c</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>c = getchar<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> != EOF<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>isupper<span style="color: #67b11d;">(</span>c<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            c = tolower<span style="color: #67b11d;">(</span>c<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>putchar<span style="color: #67b11d;">(</span>c<span style="color: #67b11d;">)</span> != EOF<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"output error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>c == <span style="color: #2aa198;">'\n'</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            fflush<span style="color: #67b11d;">(</span>stdout<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    exit<span style="color: #d75fd7;">(</span>EXIT_SUCCESS<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 127: </span>Figure 15.15 Invoke uppercase/lowercase filter to read commands</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig15.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-07</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Invoke uppercase/lowercase filter to read commands</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fpin</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fpin = popen<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"../bin/15fig14"</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"popen error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        fputs<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"prompt&gt; "</span>, stdout<span style="color: #2aa198;">)</span>;
        fflush<span style="color: #2aa198;">(</span>stdout<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fgets<span style="color: #67b11d;">(</span>line, MAXLINE, fpin<span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">break</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fputs<span style="color: #67b11d;">(</span>line, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fputs error to pipe"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pclose<span style="color: #2aa198;">(</span>fpin<span style="color: #2aa198;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pclose error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    putchar<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">'\n'</span><span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgafa570c" class="outline-4">
<h4 id="orgafa570c"><span class="done DONE">DONE</span> 15.4 Coprocesses</h4>
<div class="outline-text-4" id="text-orgafa570c">
<blockquote>
<p>
A filter becomes a <i>coprocess</i> when the same program generates the filter's input and reads the filter's output.
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="figure">
<p><img src="Chapter15/15fig16.jpg" alt="15fig16.jpg" />
</p>
<p><span class="figure-number">Figure 24: </span>Figure 15.16 Driving a coprocess by writing its standard input and reading its standard output.</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 128: </span>Figure 15.17 Simple filter to add two numbers</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig17.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-08</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Simple filter to add two numbers</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">n</span>, <span style="color: #8787d7;">int1</span>, <span style="color: #8787d7;">int2</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        line<span style="color: #2aa198;">[</span>n<span style="color: #2aa198;">]</span> = <span style="color: #d75fd7;">0</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>sscanf<span style="color: #67b11d;">(</span>line, <span style="color: #2aa198;">"%d%d"</span>, &amp;int1, &amp;int2<span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            sprintf<span style="color: #67b11d;">(</span>line, <span style="color: #2aa198;">"%d\n"</span>, int1 + int2<span style="color: #67b11d;">)</span>;
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #875f00;">(</span>STDOUT_FILENO, line, n<span style="color: #875f00;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #875f00;">(</span>STDOUT_FILENO, <span style="color: #2aa198;">"invalid args\n"</span>, <span style="color: #d75fd7;">13</span><span style="color: #875f00;">)</span> != <span style="color: #d75fd7;">13</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 129: </span>Figure 15.18 Program to drive the 15fig17 filter</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig18.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-08</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Program to drive the add2 filter</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_pipe</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">our signal handler</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">n</span>, <span style="color: #8787d7;">fd1</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>, <span style="color: #8787d7;">fd2</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGPIPE, sig_pipe<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"signal error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>fd1<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span> || pipe<span style="color: #2aa198;">(</span>fd2<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">parent process</span>
        close<span style="color: #2aa198;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        close<span style="color: #2aa198;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>fgets<span style="color: #67b11d;">(</span>line, MAXLINE, stdin<span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #875f00;">(</span>fd1<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, line, n<span style="color: #875f00;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>n = read<span style="color: #268bd2;">(</span>fd2<span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">]</span>, line, MAXLINE<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>n == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_msg<span style="color: #875f00;">(</span><span style="color: #2aa198;">"child closed pipe"</span><span style="color: #875f00;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
            line<span style="color: #67b11d;">[</span>n<span style="color: #67b11d;">]</span> = <span style="color: #d75fd7;">0</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>fputs<span style="color: #875f00;">(</span>line, stdout<span style="color: #875f00;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"fputs error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ferror<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fgets error on stdin"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">child process</span>
        close<span style="color: #2aa198;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        close<span style="color: #2aa198;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #875f00;">(</span>fd1<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">]</span>, STDIN_FILENO<span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"dup2 error to stdin"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd1<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span> != STDOUT_FILENO<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #875f00;">(</span>fd2<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, STDOUT_FILENO<span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"dup2 error to stdout"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd2<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if (execl("../bin/15fig17", "15fig17", (char*)0) &lt; 0) {</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>execl<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"../bin/15fig19"</span>, <span style="color: #2aa198;">"15fig19"</span>, <span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">char</span>*<span style="color: #875f00;">)</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"excel error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_pipe</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIGPIPE caught\n"</span><span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span>EXIT_FAILURE<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 130: </span>Figure 15.19 Filter to add two numbers, using standard I/O</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig19.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-08</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    filter to add two numbers, using standard I/O</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>  <span style="color: #8787d7;">int1</span>, <span style="color: #8787d7;">int2</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">since the stdin is a pipe, defaults to fully buffered</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">it is blocked reading from stdin</span>
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">15fig18 is blocked reading from pipe</span>
<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">0</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">method 1: no buffer to fix blocking</span>
    setbuf<span style="color: #d75fd7;">(</span>stdin, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
    setbuf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#else</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">OR method 2: line buffer to fix blocking</span>
    setvbuf<span style="color: #d75fd7;">(</span>stdin, <span style="color: #d75fd7;">NULL</span>, _IOLBF, <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    setvbuf<span style="color: #d75fd7;">(</span>stdout, <span style="color: #d75fd7;">NULL</span>, _IOLBF, <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #d75fd7;">#endif</span>

    <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span>fgets<span style="color: #2aa198;">(</span>line, MAXLINE, stdin<span style="color: #2aa198;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>sscanf<span style="color: #67b11d;">(</span>line, <span style="color: #2aa198;">"%d%d"</span>, &amp;int1, &amp;int2<span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"%d\n"</span>, int1 + int2<span style="color: #875f00;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"printf error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"invalid args\n"</span><span style="color: #875f00;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"printf error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org3adf3c0" class="outline-4">
<h4 id="org3adf3c0"><span class="done DONE">DONE</span> 15.5 FIFOs</h4>
<div class="outline-text-4" id="text-org3adf3c0">
<p>
named pipe. with FIFOs, unrelated processes can exchange data.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/stat.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">mkfifo</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">path</span>, <span style="color: #df005f; font-weight: bold;">mode_t</span> <span style="color: #8787d7;">mode</span><span style="color: #268bd2;">)</span>;
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">mkfifoat</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">path</span>, <span style="color: #df005f; font-weight: bold;">mode_t</span> <span style="color: #8787d7;">mode</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>
<p>
three case for mkfifoat;
</p>
<ol class="org-ol">
<li>If the <i>path</i> parameter specifies an absolute pathname, then the <i>fd</i> parameter is ignored and the <code>mkfifoat</code> function behaves like the mkfifo function.</li>
<li>If the <i>path</i> parameter specifies a relative pathname and the <i>fd</i> parameter is a valid file descriptor for an open directory, the pathname is evaluated relative to this directory.</li>
<li>If the <i>path</i> parameter specifies a relative pathname and the <i>fd</i> parameter has the special value with AT_FDCWD, the pathname is evaluated starting in the current working directory, and the <code>mkfifoat</code> behaves like <code>mkfifo</code>.</li>
</ol>


<p>
When we <code>open</code> a FIFO, the nonblocking flag (<code>O_NONBLOCK</code>) affects what happens.
</p>
<ul class="org-ul">
<li>In the normal case (without <code>O_NONBLOCK</code>), an <code>open</code> for read-only blocks until some other processes opens the FIFO for writing .</li>
<li>If <code>O_NONBLOCK</code> is specified, an <code>open</code> for read-only returns immediately. But an <code>open</code> for write-only returns -1 with errno set to <code>ENXIO</code> if no process has the FIFO open for reading.</li>
</ul>


<ul class="org-ul">
<li><p>
Example - Using FIFOs to Duplicate Output Streams
</p>


<div class="figure">
<p><img src="Chapter15/15fig20.jpg" alt="15fig20.jpg" />
</p>
<p><span class="figure-number">Figure 25: </span>Figure 15.20 Procedure that preocesses a filtered input stream twice</p>
</div></li>
</ul>


<div class="org-src-container">
<pre class="src src-sh">mkfifo fifo1
prog3 &lt; fifo1 &amp;
prog1 &lt; infile | tee fifo1 | prog2
</pre>
</div>

<div class="figure">
<p><img src="Chapter15/15fig21.jpg" alt="15fig21.jpg" />
</p>
<p><span class="figure-number">Figure 26: </span>Figure 15.21 Using a FIFO and tee to send a stream to two different processes</p>
</div>


<ul class="org-ul">
<li><p>
Example - Clent-Server Communication Using a FIFO
</p>


<div class="figure">
<p><img src="Chapter15/15fig22.jpg" alt="15fig22.jpg" />
</p>
<p><span class="figure-number">Figure 27: </span>Figure 15.22 Clients sending requests to a server using a FIFO</p>
</div>


<div class="figure">
<p><img src="Chapter15/15fig23.jpg" alt="15fig23.jpg" />
</p>
<p><span class="figure-number">Figure 28: </span>Figure 15.23 Client-server communication using FIFOs</p>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgc7d6e6a" class="outline-4">
<h4 id="orgc7d6e6a"><span class="done DONE">DONE</span> 15.6 XSI IPC <code>[4/4]</code></h4>
<div class="outline-text-4" id="text-orgc7d6e6a">
</div>
<ul class="org-ul">
<li><a id="org812054b"></a><span class="done DONE">DONE</span> 15.6.1 Identifiers and Keys<br />
<div class="outline-text-5" id="text-org812054b">
<p>
The identifier is an internal name for an IPC object. an IPC object is associated with a <i>key</i> that acts as an external name for cooperating processes to be able to rendezvous using the same IPC object.
</p>

<p>
<b>Whenever an IPC structure is being created, a key (&lt;sys/types.h&gt;::key_st) must be specified.</b>
</p>

<p>
ways for a client and a server to rendezvous at the same IPC structure.
</p>
<ol class="org-ol">
<li>The server can create a new IPC structure by specifying a key of <code>IPC_PRIVATE</code> and store the returned identifier somewhere (such as a file) for the client to obtain.</li>
<li>The client and the server can agree on a key by defining the key in a common header.</li>
<li>The client and the server can agree on a pathname and project ID (the project ID is a character value between 0 and 255) and call the function <code>ftok</code> to convert these two values into a key.</li>
</ol>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/ipc.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@brief generating a key from a pathname and project ID</span>
<span style="color: #008787; background-color: #262626;">///</span>
<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@param path        refer to an existing file</span>
<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@param id          only lower 8 bits used</span>
<span style="color: #008787; background-color: #262626;">///</span>
<span style="color: #008787; background-color: #262626;">/// </span><span style="color: #008787; background-color: #262626;">@note              usually formed by taking part of st_dev and st_ino fields in stat structure</span>
<span style="color: #df005f; font-weight: bold;">key_t</span> <span style="color: #d75fd7; font-weight: bold;">ftok</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">path</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">id</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: key if OK, (key_t)-1 on error</span>
</pre>
</div>

<blockquote>
<p>
If we want to create a new IPC structure, making sure that we don't reference an existing one with the same identifier, we must specify a <i>flag</i> with both the <code>IPC_CREAT</code> and <code>IPC_EXCL</code> bits set. Doing this causes an error returned of EEXIST if the IPC structure already exists.
</p>
</blockquote>
</div>
</li>
<li><a id="orgd612467"></a><span class="done DONE">DONE</span> 15.6.2 Permission Structure<br />
<div class="outline-text-5" id="text-orgd612467">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">ipc_perm</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">uid_t</span>           <span style="color: #8787d7;">uid</span>;            <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">[XSI] Owner's user ID */</span>
    <span style="color: #df005f; font-weight: bold;">gid_t</span>           <span style="color: #8787d7;">gid</span>;            <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">[XSI] Owner's group ID */</span>
    <span style="color: #df005f; font-weight: bold;">uid_t</span>           <span style="color: #8787d7;">cuid</span>;           <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">[XSI] Creator's user ID */</span>
    <span style="color: #df005f; font-weight: bold;">gid_t</span>           <span style="color: #8787d7;">cgid</span>;           <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">[XSI] Creator's group ID */</span>
    <span style="color: #df005f; font-weight: bold;">mode_t</span>          <span style="color: #8787d7;">mode</span>;           <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">[XSI] Read/write permission */</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">... more additional members depends on system</span>
<span style="color: #268bd2;">}</span>;
</pre>
</div>


<div class="figure">
<p><img src="Chapter15/15fig24.jpg" alt="15fig24.jpg" />
</p>
<p><span class="figure-number">Figure 29: </span>Figure 15.24 XSI IPC permissions</p>
</div>
</div>
</li>
<li><a id="org09d27dd"></a><span class="done DONE">DONE</span> 15.6.3 Configuration Limits<br />
<div class="outline-text-5" id="text-org09d27dd">
<p>
modify kernel configuration parameters:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">system</th>
<th scope="col" class="org-left">cmd</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">FreeBSD</td>
<td class="org-left">sysctl</td>
</tr>

<tr>
<td class="org-left">Linux</td>
<td class="org-left">sysctl</td>
</tr>

<tr>
<td class="org-left">Mac OS X</td>
<td class="org-left">sysctl</td>
</tr>

<tr>
<td class="org-left">Solaris 10</td>
<td class="org-left">prctl</td>
</tr>
</tbody>
</table>

<p>
display the IPC-related limits:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">system</th>
<th scope="col" class="org-left">cmd</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Linux</td>
<td class="org-left"><code>ipcs -l</code></td>
</tr>

<tr>
<td class="org-left">Mac OS X</td>
<td class="org-left"><code>ipcs -T</code></td>
</tr>

<tr>
<td class="org-left">FreeBSD</td>
<td class="org-left"><code>icps -T</code></td>
</tr>

<tr>
<td class="org-left">Solaris</td>
<td class="org-left"><code>sysdef -i</code></td>
</tr>
</tbody>
</table>
</div>
</li>

<li><a id="orga155a46"></a><span class="done DONE">DONE</span> 15.6.4 Advantages and Disadvantages<br />
<div class="outline-text-5" id="text-orga155a46">
<ul class="org-ul">
<li>all forms of XSI IPC remain in existence even when no process is using them.</li>
<li>we can't see the IPC objects with an <code>ls</code> command, can't remove them with the <code>rm</code> command, can't change their permissions with <code>chmod</code> command. use <code>ipcs</code> and <code>ipcrm</code> instead.</li>
<li>since they don't use file descriptors, we can't use multiplexed I/O functions(<code>select</code>, <code>poll</code>, <code>epoll</code>) with them.</li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 23:</span> Figure 15.25 Comparison of features of various forms of IPC</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">IPC type</th>
<th scope="col" class="org-left">Connectionless?</th>
<th scope="col" class="org-left">Reliable?</th>
<th scope="col" class="org-left">Flow control?</th>
<th scope="col" class="org-left">Records?</th>
<th scope="col" class="org-left">Message types or priorties?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">message queues</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
</tr>

<tr>
<td class="org-left">STREAMS</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
</tr>

<tr>
<td class="org-left">UNIX domain stream socket</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">no</td>
<td class="org-left">no</td>
</tr>

<tr>
<td class="org-left">UNIX domain datagram socket</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">no</td>
</tr>

<tr>
<td class="org-left">FIFOs (non-STREAMS)</td>
<td class="org-left">no</td>
<td class="org-left">yes</td>
<td class="org-left">yes</td>
<td class="org-left">no</td>
<td class="org-left">no</td>
</tr>
</tbody>
</table>
</div>
</li>
</ul>
</div>

<div id="outline-container-org9829e4f" class="outline-4">
<h4 id="org9829e4f"><span class="done DONE">DONE</span> 15.7 Message Queues</h4>
<div class="outline-text-4" id="text-org9829e4f">
<p>
A message queue is a linked list of messages stored within the kernel and identified by a message queue identifer.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">msqid_ds</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">ipc_perm</span>  <span style="color: #8787d7;">msg_perm</span>;     <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">see Section 15.6.2      */</span>
    <span style="color: #df005f; font-weight: bold;">msgqnum_t</span>        <span style="color: #8787d7;">msg_qnum</span>;     <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;"># of messages on queue  */</span>
    <span style="color: #df005f; font-weight: bold;">msglen_t</span>         <span style="color: #8787d7;">msg_qbytes</span>;   <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">max # of bytes on queue */</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span>            <span style="color: #8787d7;">msg_lspid</span>;    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">pid of last msgsnd()    */</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span>            <span style="color: #8787d7;">msg_lrpid</span>;    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">pid of last msgrcv()    */</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>           <span style="color: #8787d7;">msg_stime</span>;    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">last-msgsnd() time      */</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>           <span style="color: #8787d7;">msg_rtime</span>;    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">last-msgrcv() time      */</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>           <span style="color: #8787d7;">msg_ctime</span>;    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">last-change time        */</span>
    .
    .
    .
<span style="color: #268bd2;">}</span>;
</pre>
</div>


<div class="figure">
<p><img src="Chapter15/15fig26.jpg" alt="15fig26.jpg" />
</p>
<p><span class="figure-number">Figure 30: </span>Figure 15.26 System limits that affect message queues</p>
</div>

<p>
message queue related functions:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/msg.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief either open an existing queue or create a new queue</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * * The ipc_perm structure is initialized .</span>
<span style="color: #008787; background-color: #262626;"> * * msg_qnum,msg_lspid,msg_lrpid,msg_stime, and msg_rtime set to 0</span>
<span style="color: #008787; background-color: #262626;"> * * msg_ctime is set to the current time</span>
<span style="color: #008787; background-color: #262626;"> * * msg_qbytes is set to the system limit</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @retval msqID  OK</span>
<span style="color: #008787; background-color: #262626;"> * @retval -1     error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">msgget</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">key_t</span> <span style="color: #8787d7;">key</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">flag</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief ioctl-like functions for XSI IPC</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * * IPC_STAT fetch the msqid_ds structure for this queue</span>
<span style="color: #008787; background-color: #262626;"> * * IPC_SET copy the following fields from the structure pointed to by buf to</span>
<span style="color: #008787; background-color: #262626;"> * the msqid_ds</span>
<span style="color: #008787; background-color: #262626;"> * * IPC_RMID remove the message queue from the system and any data still on the</span>
<span style="color: #008787; background-color: #262626;"> * queue.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @retval 0     OK</span>
<span style="color: #008787; background-color: #262626;"> * @retval -1    error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">msgctl</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">msqid</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">cmd</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">msqid_ds</span> *<span style="color: #8787d7;">buf</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief data is placed on a message queue by calling msgsnd.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * messages are always placed at the end of the queue.</span>
<span style="color: #008787; background-color: #262626;"> * * IPC_NOWAIT can be specified, this is similar to the nonblocking I/O flag</span>
<span style="color: #008787; background-color: #262626;"> * for file I/O.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @retval 0 OK</span>
<span style="color: #008787; background-color: #262626;"> * @retval -1 error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">msgsnd</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">msqid</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">ptr</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">nbytes</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">flag</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief messages are retrieved from a queue by msgrcv.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * * type == 0 the first message on the queue is returned</span>
<span style="color: #008787; background-color: #262626;"> * * type &gt; 0  the first message on the queue whose message type equals type is</span>
<span style="color: #008787; background-color: #262626;"> * returned.</span>
<span style="color: #008787; background-color: #262626;"> * * type &lt; 0  the fire message on the queue whose message type is the lowest</span>
<span style="color: #008787; background-color: #262626;"> * values less than or equal to the absolute value of type is returned.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return sizeof data portion of message if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">ssize_t</span> <span style="color: #d75fd7; font-weight: bold;">msgrcv</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">msqid</span>, <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">ptr</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">nbytes</span>, <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">type</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">flag</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example - Timing Comparison of Message Queues and Full-Duplex Pipes.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 24:</span> Figure 15.27 Timing comparison of IPC alternatives on Solaris</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operation</th>
<th scope="col" class="org-right">User</th>
<th scope="col" class="org-right">Systems</th>
<th scope="col" class="org-right">Clock</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">message queue</td>
<td class="org-right">0.58</td>
<td class="org-right">4.16</td>
<td class="org-right">5.09</td>
</tr>

<tr>
<td class="org-left">full-duplex pipe</td>
<td class="org-right">0.61</td>
<td class="org-right">4.30</td>
<td class="org-right">5.24</td>
</tr>

<tr>
<td class="org-left">UNIX domain socket</td>
<td class="org-right">0.59</td>
<td class="org-right">5.58</td>
<td class="org-right">7.49</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>
<div id="outline-container-org992b009" class="outline-4">
<h4 id="org992b009"><span class="done DONE">DONE</span> 15.8 Semaphores</h4>
<div class="outline-text-4" id="text-org992b009">
<p>
A semaphore is a counter used to provide access to a shared data object for multiple processes.
obtain a shared resource:
</p>
<ol class="org-ol">
<li>Test the semaphore that controls the resource.</li>
<li>If the value of the semaphore is positive, the process can use the resource.</li>
<li>Otherwise, if the value of the semaphore is 0, the process goes to sleep until the semaphore value is greater than 0.</li>
</ol>


<p>
XSI semaphores :
</p>
<ol class="org-ol">
<li>A semaphore is not simply a single non-negative value.</li>
<li>The creation of a semaphore (<code>semget</code>) is independent of its initialization (<code>semctl</code>).</li>
<li>Since all forms of XSI IPC remain in existence even when no process is using them, we have to worry about a program that terminates without releasing the semaphores it has been allocated.</li>
</ol>


<p>
The kernel maintains a <code>semid_ds</code> structure for each semaphore set:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">semid_ds</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">ipc_perm</span> <span style="color: #8787d7;">sem_perm</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">see section 15.6.2</span>
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">short</span>  <span style="color: #8787d7;">sem_nsems</span>; <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;"># of semaphores in set</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>          <span style="color: #8787d7;">sem_otime</span>; <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">last-semop time</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>          <span style="color: #8787d7;">sem_ctime</span>; <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">last-change time</span>
    .
    .
    .
<span style="color: #268bd2;">}</span>;
</pre>
</div>

<p>
Each semaphore is represented by an anonymous structure containing at least the following members:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">short</span> <span style="color: #8787d7;">semval</span>;          <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">semaphore value, alwyas &gt;= 0</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span>          <span style="color: #8787d7;">sempid</span>;          <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">pid for last operation</span>
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">short</span> <span style="color: #8787d7;">semncnt</span>;         <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;"># processes awaiting semval &gt; curval</span>
    <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">short</span> <span style="color: #8787d7;">semzcnt</span>;         <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;"># processes awaiting semval == 0</span>
    .
    .
    .
<span style="color: #268bd2;">}</span>;
</pre>
</div>



<div class="figure">
<p><img src="Chapter15/15fig28.jpg" alt="15fig28.jpg" />
</p>
<p><span class="figure-number">Figure 31: </span>Figure 15.28 System limits that affect semaphores</p>
</div>

<p>
XSI semaphores using:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/sem.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief obtain a semaphore ID</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * * ipc_perm structure is initialized, the mode member depends on perssion bits of flag.</span>
<span style="color: #008787; background-color: #262626;"> * * sem_otime is set to 0.</span>
<span style="color: #008787; background-color: #262626;"> * * sem_ctime is set to the current time.</span>
<span style="color: #008787; background-color: #262626;"> * * sem_nsems is set to the nsems.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @param    nsems      the number of semaphores</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return   semaphore ID if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">semget</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">key_t</span> <span style="color: #8787d7;">key</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">nsems</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">flag</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *  @brief catchall for various semaphore operations</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * A union of various command-specific arguments.</span>
<span style="color: #008787; background-color: #262626;"> * union semun {</span>
<span style="color: #008787; background-color: #262626;"> *    int              val;     // for SETVAL</span>
<span style="color: #008787; background-color: #262626;"> *    struct semid_ds *buf;     // for IPC_STAT and IPC_SET</span>
<span style="color: #008787; background-color: #262626;"> *    unsigned short  *array;   // for GETALL and SETALL</span>
<span style="color: #008787; background-color: #262626;"> * };</span>
<span style="color: #008787; background-color: #262626;"> * The optional argument is the actual union, not a pointer to the union.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @param   semid   set specified semaphore</span>
<span style="color: #008787; background-color: #262626;"> * @param   cmd     specifies one of the following ten commands to be performed</span>
<span style="color: #008787; background-color: #262626;"> *                  IPC_STAT    fetch semid_ds structure for this set</span>
<span style="color: #008787; background-color: #262626;"> *                  IPC_SET     set the sem_perm.uid,sem_perm.gid, and sem_perm.mode</span>
<span style="color: #008787; background-color: #262626;"> *                  IPC_RMID    remove the semaphore from the system.</span>
<span style="color: #008787; background-color: #262626;"> *                  GETVAL      return the value of semval for the member semnum;</span>
<span style="color: #008787; background-color: #262626;"> *                  SETVAL      set the value of semval for the member semnum.</span>
<span style="color: #008787; background-color: #262626;"> *                  GETPID      get the value of sempid</span>
<span style="color: #008787; background-color: #262626;"> *                  GETNCNT     return the value of semncnt for the member semnum.</span>
<span style="color: #008787; background-color: #262626;"> *                  GETZCNT     return the value of semzcnt for the member semnum.</span>
<span style="color: #008787; background-color: #262626;"> *                  GETALL      fetch all the semaphore values in the set.</span>
<span style="color: #008787; background-color: #262626;"> *                  SETALL      set all the semaphore values in the set to the values pointed to by arg array.</span>
<span style="color: #008787; background-color: #262626;"> * @return   for all the GET commands other than GETALL, see above for details,</span>
<span style="color: #008787; background-color: #262626;"> *          otherwise, 0 if OK, -1 on error and set errno</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">semctl</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">semid</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">semnum</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">cmd</span>, ... <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">union semun arg */</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief atomically performs an array of operations on a semaphore set</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * struct sembuf {</span>
<span style="color: #008787; background-color: #262626;"> *     unsigned short sem_num;  // member # in set (0, 1, ... nsems-1);</span>
<span style="color: #008787; background-color: #262626;"> *     short          sem_op;   // operation(negative, 0, or positive);</span>
<span style="color: #008787; background-color: #262626;"> *     short          sem_flg;  // IPC_NOWAIT, SEM_UNDO</span>
<span style="color: #008787; background-color: #262626;"> * };</span>
<span style="color: #008787; background-color: #262626;"> * see following for details</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return 0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">semop</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">semid</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sembuf</span> <span style="color: #8787d7;">semoparray</span><span style="color: #d75fd7;">[]</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">nops</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<p>
sem_op value effects:
</p>
<blockquote>
<ol class="org-ol">
<li>The easiest case is when sem_op is positive. This case corresponds to the returning of resources by the process. The value of sem_op is added to the semaphore’s value. If the undo flag is specified, sem_op is also subtracted from the semaphore’s adjustment value for this process.</li>

<li><p>
If sem_op is negative, we want to obtain resources that the semaphore controls.
</p>

<p>
If the semaphore’s value is greater than or equal to the absolute value of sem_op (the resources are available), the absolute value of sem_op is subtracted from the semaphore’s value. This guarantees the resulting semaphore value is greater than or equal to 0. If the undo flag is specified, the absolute value of sem_op is also added to the semaphore’s adjustment value for this process.
</p>

<p>
If the semaphore’s value is less than the absolute value of sem_op (the resources are not available), the following conditions apply.
</p>

<ul class="org-ul">
<li>If IPC_NOWAIT is specified, semop returns with an error of EAGAIN.</li>

<li>If IPC_NOWAIT is not specified, the semncnt value for this semaphore is incremented (since the caller is about to go to sleep), and the calling process is suspended until one of the following occurs.

<ul class="org-ul">
<li>The semaphore’s value becomes greater than or equal to the absolute value of sem_op (i.e., some other process has released some resources). The value of semncnt for this semaphore is decremented (since the calling process is done waiting), and the absolute value of sem_op is subtracted from the semaphore’s value. If the undo flag is specified, the absolute value of sem_op is also added to the semaphore’s adjustment value for this process.</li>

<li>The semaphore is removed from the system. In this case, the function returns an error of EIDRM.</li>

<li>A signal is caught by the process, and the signal handler returns. In this case, the value of semncnt for this semaphore is decremented (since the calling process is no longer waiting), and the function returns an error of EINTR.</li>
</ul></li>
</ul></li>

<li><p>
If sem_op is 0, this means that the calling process wants to wait until the semaphore’s value becomes 0.
</p>

<p>
If the semaphore’s value is currently 0, the function returns immediately.
</p>

<p>
If the semaphore’s value is nonzero, the following conditions apply.
</p>

<ul class="org-ul">
<li>If IPC_NOWAIT is specified, return is made with an error of EAGAIN.</li>

<li>If IPC_NOWAIT is not specified, the semzcnt value for this semaphore is incremented (since the caller is about to go to sleep), and the calling process is suspended until one of the following occurs.

<ul class="org-ul">
<li>The semaphore’s value becomes 0. The value of semzcnt for this semaphore is decremented (since the calling process is done waiting).</li>

<li>The semaphore is removed from the system. In this case, the function returns an error of EIDRM.</li>

<li>A signal is caught by the process, and the signal handler returns. In this case, the value of semzcnt for this semaphore is decremented (since the calling process is no longer waiting), and the function returns an error of EINTR.</li>
</ul></li>
</ul></li>
</ol>
</blockquote>

<ul class="org-ul">
<li>Semaphore Adjustment on exit
using <code>semctl</code> with either <code>SETVAL</code> or <code>SETALL</code> commands, the adjustment value for that semaphore in all processes is set to 0

<ul class="org-ul">
<li><p>
Example - Timing Comparison of Semaphores, Record Locking, and Mutexes
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 25:</span> Figure 15.29 Timing comparison of locking alternatives on Linux</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operation</th>
<th scope="col" class="org-right">User</th>
<th scope="col" class="org-right">System</th>
<th scope="col" class="org-right">Clock</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">semaphores with undo</td>
<td class="org-right">0.50</td>
<td class="org-right">6.08</td>
<td class="org-right">7.55</td>
</tr>

<tr>
<td class="org-left">advisory record locking</td>
<td class="org-right">0.51</td>
<td class="org-right">9.06</td>
<td class="org-right">4.38</td>
</tr>

<tr>
<td class="org-left">mutex in shared memory</td>
<td class="org-right">0.21</td>
<td class="org-right">0.40</td>
<td class="org-right">0.25</td>
</tr>
</tbody>
</table>

<p>
with locking single resource and don't need all the features of XSI semaphores, record locking is preferable, cause that is much simpler to use and system take care of any lingering locks when process terminates.
unless performance is the primary concerned, record locking is still more preferable than mutex (1. easier to use, 2. cross-platform support)
</p></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org818d4a7" class="outline-4">
<h4 id="org818d4a7"><span class="done DONE">DONE</span> 15.9 Shared Memory</h4>
<div class="outline-text-4" id="text-org818d4a7">
<p>
Shared memory allows two or more processes to share a given region of memory. This is the <b>fastest</b> form of IPC.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">shmid_ds</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">ipc_perm</span> <span style="color: #8787d7;">shm_per</span>;     <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">see section 15.6.2</span>
    <span style="color: #df005f; font-weight: bold;">size_t</span>          <span style="color: #8787d7;">shm_segsz</span>;   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">sizeof segment in bytes</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span>           <span style="color: #8787d7;">shm_lpid</span>;    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">pid of last shmop()</span>
    <span style="color: #df005f; font-weight: bold;">pid_t</span>           <span style="color: #8787d7;">shm_cpid</span>;    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">pid of creator</span>
    <span style="color: #df005f; font-weight: bold;">shmatt_t</span>        <span style="color: #8787d7;">shm_nattch</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">number of current attaches, shmatt_t is defined to be an unsigned short</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>          <span style="color: #8787d7;">shm_atime</span>;   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">last-attach time</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>          <span style="color: #8787d7;">shm_dtime</span>;   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">last-detach time</span>
    <span style="color: #df005f; font-weight: bold;">time_t</span>          <span style="color: #8787d7;">shm_ctime</span>;   <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">last-change time</span>
    ...
<span style="color: #268bd2;">}</span>;
</pre>
</div>


<div class="figure">
<p><img src="Chapter15/15fig30.jpg" alt="15fig30.jpg" />
</p>
<p><span class="figure-number">Figure 32: </span>Figure 15.30 System limits that affect shared memory</p>
</div>


<p>
Shared memory API:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/shm.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      obtain a shared memory identifier</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @details    the following members of shmid_ds structure are initialized.</span>
<span style="color: #008787; background-color: #262626;"> *             * ipc_perm</span>
<span style="color: #008787; background-color: #262626;"> *             * shm_lpid,shm_nattch,shm_atime, and shm_dtime are all set to 0</span>
<span style="color: #008787; background-color: #262626;"> *             * shm_ctime is set to the current time</span>
<span style="color: #008787; background-color: #262626;"> *             * shm_segsz is set to the size requested</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @param[in]  key    for converting into an identifier</span>
<span style="color: #008787; background-color: #262626;"> * @param[in]  size   the size of the shared memory segment in bytes</span>
<span style="color: #008787; background-color: #262626;"> * @param[in]  flag   for ipc_perm's permission bits set</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     shared memory ID if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">shmget</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">key_t</span> <span style="color: #8787d7;">key</span>, <span style="color: #df005f; font-weight: bold;">size_t</span> <span style="color: #8787d7;">size</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">flag</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      catchall for various shared memory operations</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @param[in]  shmid      speicify which shared memory to operate</span>
<span style="color: #008787; background-color: #262626;"> * @param[in]  cmd        IPC_STAT    fetch the shmid_ds structure for this segment, storing to buf</span>
<span style="color: #008787; background-color: #262626;"> *                        IPC_SET     set the following three fields from buf</span>
<span style="color: #008787; background-color: #262626;"> *                                    shm_perm.uid,shm_perm.gid,shm_perm.mode</span>
<span style="color: #008787; background-color: #262626;"> *                                    can be only executed by UID == shm_perm.cuid or shm_perm.uid or root</span>
<span style="color: #008787; background-color: #262626;"> *                        IPC_RMID    remove the shared memory segment set from the system</span>
<span style="color: #008787; background-color: #262626;"> *                                    actually it is attachment count decrease 1</span>
<span style="color: #008787; background-color: #262626;"> *                                    be removed until the last process using the segment terminates or detaches it .</span>
<span style="color: #008787; background-color: #262626;"> *                                    regardless of whether the segment is still in use</span>
<span style="color: #008787; background-color: #262626;"> *                                    can be only executed by UID == shm_perm.cuid or shm_perm.uid or root.</span>
<span style="color: #008787; background-color: #262626;"> *                        additional commands for Linux and Solaris only</span>
<span style="color: #008787; background-color: #262626;"> *                        SHM_LOCK    lock the shared memory</span>
<span style="color: #008787; background-color: #262626;"> *                        SHM_UNLOCK  unlock the shared memory</span>
<span style="color: #008787; background-color: #262626;"> * @param[in,out] buf     read or write, depends on cmd specified</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">shmctl</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">shmid</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">cmd</span>, <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">shmid_ds</span> *<span style="color: #8787d7;">buf</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      a process attach a existing shared memory segment.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @details</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @param[in]  shmid      specify which shared memory segment to attach</span>
<span style="color: #008787; background-color: #262626;"> * @param[in]  addr       is 0, the segment is attached at the first available address selected by the kernel.</span>
<span style="color: #008787; background-color: #262626;"> *                        is nonzero and SHM_RND is not specified, the segment is attached at addr</span>
<span style="color: #008787; background-color: #262626;"> *                        is nonzero and SHM_RND is specified, attached at (addr - (addr modulus SHMLBA)),</span>
<span style="color: #008787; background-color: #262626;"> *                          SHMLBA stands for "low boundary address multiple" and is always a power of 2.</span>
<span style="color: #008787; background-color: #262626;"> *                          round the address down to the next multiple of SHMLBA.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">shmat</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">shmid</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">addr</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">flag</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      detach a shared memory segment.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @details    this DOES NOT removed the identifier and associated data structure</span>
<span style="color: #008787; background-color: #262626;"> *             the identifier remains in existence until removes by calling shmctl with IPC_RMID.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @param      addr to detach</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">shmdt</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">addr</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 131: </span>Figure 15.31 Print where various types of data are stored</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig31.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-10</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    print where various type of data are stored</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  prints some information on where one particular system</span>
<span style="color: #008787; background-color: #262626;"> *  places various types of data.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/shm.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">ARRAY_SIZE</span>  <span style="color: #d75fd7;">40000</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MALLOC_SIZE</span> <span style="color: #d75fd7;">100000</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">SHM_SIZE</span>    <span style="color: #d75fd7;">100000</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">SHM_MODE</span>    <span style="color: #d75fd7;">0600</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">user read/write</span>


<span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">array</span><span style="color: #268bd2;">[</span>ARRAY_SIZE<span style="color: #268bd2;">]</span>;         <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">uninitialized data = bss</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">shmid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">ptr</span>, *<span style="color: #8787d7;">shmptr</span>;

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"array[] from %p to %p\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #2aa198;">)</span>&amp;array<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #2aa198;">)</span>&amp;array<span style="color: #2aa198;">[</span>ARRAY_SIZE<span style="color: #2aa198;">]</span><span style="color: #d75fd7;">)</span>;
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"stack around %p\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #2aa198;">)</span>&amp;shmid<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>ptr = malloc<span style="color: #67b11d;">(</span>MALLOC_SIZE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"malloc errro"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"malloced from %p to %p\n"</span>, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #2aa198;">)</span>ptr, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #2aa198;">)</span>ptr + MALLOC_SIZE<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>shmid = shmget<span style="color: #67b11d;">(</span>IPC_PRIVATE, SHM_SIZE, SHM_MODE<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"shmget error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>shmptr = shmat<span style="color: #67b11d;">(</span>shmid, <span style="color: #d75fd7;">0</span> , <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">void</span>*<span style="color: #2aa198;">)</span>-<span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"shmat error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"shared memory attached from %p to %p\n"</span>, shmptr, shmptr + SHM_SIZE<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>shmctl<span style="color: #2aa198;">(</span>shmid, IPC_RMID, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"shmctl error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
<blockquote>
<p>
Results on Linux:
</p>

<p>
array[] from 0x602540 to 0x60c180
</p>

<p>
stack around 0x7ffdaff9121c
</p>

<p>
malloced from 0xd2c010 to 0xd446b0
</p>

<p>
shared memory attached from 0x7f40d9097000 to 0x7f40d90af6a0
</p>
</blockquote>
<blockquote>
<p>
Results on Mac OS X
</p>

<p>
array[] from 0x102d40090 to 0x102d49cd0
</p>

<p>
stack around 0x7ffeecec2438
</p>

<p>
malloced from 0x102d60000 to 0x102d786a0
</p>

<p>
shared memory attached from 0x102d7a000 to 0x102d926a0
</p>
</blockquote>

<div class="figure">
<p><img src="Chapter15/15fig32.jpg" alt="15fig32.jpg" />
</p>
<p><span class="figure-number">Figure 33: </span>Figure 15.32 Memory layout on an Intel-based Linux system.</p>
</div>

<ul class="org-ul">
<li><p>
Example - Memory Mapping of /dev/zero
techinque for related processes
</p>
<ul class="org-ul">
<li>An unnamed memory region is created whose size is the second argument to mmap, rounded up to the nearest page size on the system.</li>
<li>The memory region is initialized to 0.</li>
<li>Multiple processes can share this region if a common ancestor specifies the MAP_SHARED flag to mmap.</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 132: </span>Figure 15.33 IPC between parent and child using memory mapped I/O of /dev/zero</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig33.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-10</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    IPC between parent and child using memory mapped I/O of /dev/zero</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/mman.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NLOOPS</span> <span style="color: #d75fd7;">1000</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">SIZE</span>   <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #268bd2;">)</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">size of shared memory area</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">update</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #8787d7;">ptr</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>*ptr<span style="color: #2aa198;">)</span>++<span style="color: #d75fd7;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">return value before increment</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span>, <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">counter</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">area</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = open<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"/dev/zero"</span>, O_RDWR<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>area = mmap<span style="color: #67b11d;">(</span><span style="color: #d75fd7;">0</span>, SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> ==
        MAP_FAILED<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"mmap error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    close<span style="color: #d75fd7;">(</span>fd<span style="color: #d75fd7;">)</span>;

    TELL_WAIT<span style="color: #d75fd7;">()</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent */</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NLOOPS; i += <span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>counter = update<span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #d75fd7;">)</span>area<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> != i<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_quit<span style="color: #875f00;">(</span><span style="color: #2aa198;">"parent: expected %d, got %d"</span>, i, counter<span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"parent: %d\n"</span>, counter<span style="color: #67b11d;">)</span>;
            TELL_CHILD<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span>;
            WAIT_CHILD<span style="color: #67b11d;">()</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child */</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">1</span>; i &lt; NLOOPS + <span style="color: #d75fd7;">1</span>; i += <span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            WAIT_PARENT<span style="color: #67b11d;">()</span>;

            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>counter = update<span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #d75fd7;">)</span>area<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> != i<span style="color: #67b11d;">)</span>
                err_quit<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child: expected %d, got %d"</span>, i, counter<span style="color: #67b11d;">)</span>;

            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child: %d\n"</span>, counter<span style="color: #67b11d;">)</span>;
            TELL_PARENT<span style="color: #67b11d;">(</span>getppid<span style="color: #875f00;">()</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
Example - Anonymous Memory Mapping
To use this facility, specify <code>MAP_ANONYMOUS</code> (<code>MAP_ANON</code> deprecated on Linux) flag to <code>mmap</code> and specify the fd to -1.
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 133: </span>modify <a href="Chapter15/15fig33.c#MissingReference">Figure 15.33</a> to use this facility</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig33a.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-10</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    IPC between parent and child using memory mapped I/O of /dev/zero</span>
<span style="color: #008787; background-color: #262626;"> *            use anoynymous facility</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/mman.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NLOOPS</span> <span style="color: #d75fd7;">1000</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">SIZE</span>   <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #268bd2;">)</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">size of shared memory area</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">update</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #8787d7;">ptr</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>*ptr<span style="color: #2aa198;">)</span>++<span style="color: #d75fd7;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">return value before increment</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span>, <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">counter</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">area</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if ((fd = open("/dev/zero", O_RDWR)) &lt; 0) {</span>
    <span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">err_sys("open error");</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">}</span>
    fd = -<span style="color: #d75fd7;">1</span>;

    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if ((area = mmap(0, SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0)) ==</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">MAP_FAILED) {</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>area = mmap<span style="color: #67b11d;">(</span><span style="color: #d75fd7;">0</span>, SIZE, PROT_READ | PROT_WRITE, MAP_ANON | MAP_SHARED, fd,
                     <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == MAP_FAILED<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"mmap error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close(fd);</span>

    TELL_WAIT<span style="color: #d75fd7;">()</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">parent */</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NLOOPS; i += <span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>counter = update<span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #d75fd7;">)</span>area<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> != i<span style="color: #67b11d;">)</span>
                err_quit<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"parent: expected %d, got %d"</span>, i, counter<span style="color: #67b11d;">)</span>;

            TELL_CHILD<span style="color: #67b11d;">(</span>pid<span style="color: #67b11d;">)</span>;
            WAIT_CHILD<span style="color: #67b11d;">()</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">child */</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">1</span>; i &lt; NLOOPS + <span style="color: #d75fd7;">1</span>; i += <span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            WAIT_PARENT<span style="color: #67b11d;">()</span>;

            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>counter = update<span style="color: #268bd2;">(</span><span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">long</span> *<span style="color: #d75fd7;">)</span>area<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> != i<span style="color: #67b11d;">)</span>
                err_quit<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"child: expected %d, got %d"</span>, i, counter<span style="color: #67b11d;">)</span>;

            TELL_PARENT<span style="color: #67b11d;">(</span>getppid<span style="color: #875f00;">()</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org1eb758b" class="outline-4">
<h4 id="org1eb758b"><span class="done DONE">DONE</span> 15.10 POSIX Semaphores</h4>
<div class="outline-text-4" id="text-org1eb758b">
<p>
The POSIX semaphore mechanism is one of three IPC mechanisms that originated with the real-time extensions to POSIX.1.
</p>

<p>
The POSIX semaphore interfaces were meant to address several deficiencies with the XSI semaphore interfaces:
</p>
<ul class="org-ul">
<li>The POSIX semaphore interfaces allow for higher-performance implementations compared to XSI semaphores.</li>
<li>The POSIX semaphore interfaces are simpler to use: no semaphore sets, and several of the interfaces are patterned after familiar file system operations.</li>
<li>The POSIX semaphores behave more gracefully when removed.</li>
</ul>


<p>
APIs:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">semaphore.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      create a new named semaphore or use an existing one</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     Pointer to semaphore if OK, SEM_FAILED on error</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @note       To promote portability</span>
<span style="color: #008787; background-color: #262626;"> * * The first character in the name should be a slash</span>
<span style="color: #008787; background-color: #262626;"> * * The name should contain no other slashes to avoid implementation-defined</span>
<span style="color: #008787; background-color: #262626;"> * behavior.</span>
<span style="color: #008787; background-color: #262626;"> * * The maximum length of the semaphore name is implementation defined.</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #d75fd7; font-weight: bold;">sem_open</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">oflag</span>,
                ... <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">mode_t mode, unsigned int value */</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      release any resources associated with the semaphore</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_close</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #8787d7;">sem</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      remove the name of the semaphore.</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_unlink</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      decrement the value of a semaphore</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> * @note       avoids blocking if the semaphore count is 0</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_trywait</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #8787d7;">sem</span><span style="color: #268bd2;">)</span>;
<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      decrement the value of a semaphore</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> * @note       blocks if the semaphore count is 0.</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_wait</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #8787d7;">sem</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      block for a bounded amount of time</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_timedwait</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">sem</span>, <span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timespec</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">tsptr</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      increment the value of a semaphore</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_post</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #8787d7;">sem</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      create an unnamed semaphore</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_init</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #8787d7;">sem</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">pshared</span>, <span style="color: #df005f; font-weight: bold;">unsigned</span> <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">value</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      discard an unnamed semaphore</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_destroy</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #8787d7;">sem</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> * @brief      retrieve the value of a semaphore</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> * @return     0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">sem_getvalue</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">sem_t</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">sem</span>, <span style="color: #df005f; font-weight: bold;">int</span> *<span style="color: #268bd2; font-weight: bold;">restrict</span> <span style="color: #8787d7;">valp</span><span style="color: #268bd2;">)</span>;
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>

<div class="figure">
<p><img src="Chapter15/15fig34.jpg" alt="15fig34.jpg" />
</p>
<p><span class="figure-number">Figure 34: </span>Figure 15.34 Timing comparison of semaphore implementation</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 134: </span>Figure 15.35 Mutual exclusion using a POSIX semaphore</label><pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15fig35.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-11</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Mutual exclusion using a POSIX semaphore</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdio.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">stdlib.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">unistd.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"slock.h"</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">slock</span> *<span style="color: #d75fd7; font-weight: bold;">s_alloc</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">slock</span> *<span style="color: #8787d7;">sp</span>;
    <span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">int</span>    <span style="color: #8787d7;">cnt</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>sp = malloc<span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">slock</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">do</span> <span style="color: #d75fd7;">{</span>
        snprintf<span style="color: #2aa198;">(</span>sp-&gt;name, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>sp-&gt;name<span style="color: #67b11d;">)</span>, <span style="color: #2aa198;">"/%ld.%d"</span>, <span style="color: #67b11d;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getpid<span style="color: #67b11d;">()</span>, cnt++<span style="color: #2aa198;">)</span>;
        sp-&gt;semp = sem_open<span style="color: #2aa198;">(</span>sp-&gt;name, O_CREAT | O_EXCL, S_IRWXU, <span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>sp-&gt;semp == SEM_FAILED<span style="color: #2aa198;">)</span> &amp;&amp; <span style="color: #2aa198;">(</span>errno == EEXIST<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>sp-&gt;semp == SEM_FAILED<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        free<span style="color: #2aa198;">(</span>sp<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #d75fd7;">}</span>

    sem_unlink<span style="color: #d75fd7;">(</span>sp-&gt;name<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> sp;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">s_free</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">slock</span> *<span style="color: #8787d7;">sp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    sem_close<span style="color: #d75fd7;">(</span>sp-&gt;semp<span style="color: #d75fd7;">)</span>;
    free<span style="color: #d75fd7;">(</span>sp<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">s_lock</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">slock</span> *<span style="color: #8787d7;">sp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> sem_wait<span style="color: #d75fd7;">(</span>sp-&gt;semp<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">s_trylock</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">slock</span> *<span style="color: #8787d7;">sp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> sem_trywait<span style="color: #d75fd7;">(</span>sp-&gt;semp<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">s_unlock</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">slock</span> *<span style="color: #8787d7;">sp</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span> <span style="color: #268bd2; font-weight: bold;">return</span> sem_post<span style="color: #d75fd7;">(</span>sp-&gt;semp<span style="color: #d75fd7;">)</span>; <span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org3fd6e1b" class="outline-4">
<h4 id="org3fd6e1b"><span class="done DONE">DONE</span> 15.11 Client-Server Properties</h4>
<div class="outline-text-4" id="text-org3fd6e1b">
<p>
<b>A child cannot pass a descriptor back to the parent (unless special programming techniques are used, which we cover in Chapter 17).</b>
</p>

<p>
Message queue(Either of these two techniques using message queue can be implemented using shared memory and a synchronization method) :
</p>
<ol class="org-ol">
<li>A single queue can be used between the srever and all the clients, using the type field of each mesage to indicate the message recipient.</li>
<li>Alternatively, an individual message queue can be used for each client.</li>
</ol>
</div>
</div>
<div id="outline-container-org5b1ad03" class="outline-4">
<h4 id="org5b1ad03"><span class="todo TODO">TODO</span> 15.12 Summary</h4>
<div class="outline-text-4" id="text-org5b1ad03">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
15.1 pager program blocks
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15ex01.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-04</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    copy file to pager program</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__progname</span>;

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">DEF_PAGER</span> <span style="color: #2aa198;">"/bin/more"</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">default pager program</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pager</span>, *<span style="color: #8787d7;">argv0</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s &lt;pathname&gt;"</span>, __progname<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;

    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">child</span>
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close write end</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #875f00;">(</span>fd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">]</span>, STDIN_FILENO<span style="color: #875f00;">)</span> != STDIN_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"dup2 error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>pager = getenv<span style="color: #875f00;">(</span><span style="color: #2aa198;">"PAGER"</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            pager = DEF_PAGER;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>argv0 = strchr<span style="color: #875f00;">(</span>pager, <span style="color: #2aa198;">'/'</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            argv0++;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            argv0 = pager;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>execl<span style="color: #67b11d;">(</span>pager, argv0, <span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #875f00;">)</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"execl error for %s"</span>, pager<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">parent</span>
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close read end</span>

        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>fgets<span style="color: #67b11d;">(</span>line, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span>line<span style="color: #875f00;">)</span>, fp<span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #875f00;">(</span>fd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, line, n<span style="color: #875f00;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"write to pipe error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ferror<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fgets error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close(fd[1]);</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
15.2
</p>
<blockquote>
<p>
The parent terminates right after writing the last line to the pipe. The read end of the pipe is automatically closed when the parent terminates. But the parent is probably running ahead of the child by one pipe buffer, since the child (the pager program) is waiting for us to look at a page of output. If we’re running a shell, such as the Korn shell, with interactive command-line editing enabled, the shell probably changes the terminal mode when our parent terminates and the shell prints a prompt. This undoubtedly interferes with the pager program, which has also modified the terminal mode. (Most pager programs set the terminal to noncanonical mode when awaiting input to proceed to the next page.)
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15ex02.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-04</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    copy file to pager program</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/wait.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">extern</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">__progname</span>;

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">DEF_PAGER</span> <span style="color: #2aa198;">"/bin/more"</span>  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">default pager program</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">n</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">pager</span>, *<span style="color: #8787d7;">argv0</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fp</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_quit<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"usage: %s &lt;pathname&gt;"</span>, __progname<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;

    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">child</span>
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close write end</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #875f00;">(</span>fd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">]</span>, STDIN_FILENO<span style="color: #875f00;">)</span> != STDIN_FILENO<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"dup2 error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>pager = getenv<span style="color: #875f00;">(</span><span style="color: #2aa198;">"PAGER"</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            pager = DEF_PAGER;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>argv0 = strchr<span style="color: #875f00;">(</span>pager, <span style="color: #2aa198;">'/'</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            argv0++;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            argv0 = pager;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>execl<span style="color: #67b11d;">(</span>pager, argv0, <span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #875f00;">)</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"execl error for %s"</span>, pager<span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">parent</span>
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">close read end</span>

        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>fgets<span style="color: #67b11d;">(</span>line, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span>line<span style="color: #875f00;">)</span>, fp<span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #875f00;">(</span>fd<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, line, n<span style="color: #875f00;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"write to pipe error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ferror<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fgets error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if (waitpid(pid, NULL, 0) &lt; 0) {</span>
        <span style="color: #008787; background-color: #262626;">//     </span><span style="color: #008787; background-color: #262626;">err_sys("waitpid error");</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">}</span>
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
15.3 cannot execute the non-existent command
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15ex03.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-15</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    test popen for non-existent command</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>


<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">pret</span> = <span style="color: #d75fd7;">NULL</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pret = popen<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"./a.out"</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        perror<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"popen"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>
</pre>
</div>
<p>
sh: ./a.out: No such file or directory
</p>
<blockquote>
<p>
pclose returns the termination status of the command as it is returned by waitpid.
</p>
</blockquote></li>
<li><p>
15.4
</p>
<blockquote>
<p>
When the parent terminates, look at its termination status with the shell. For the Bourne shell, Bourne-again shell, and Korn shell, the command is echo $?. The number printed is 128 plus the signal number.
</p>
</blockquote>
<p>
➜   echo $?
141
</p></li>
<li><p>
15.5
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15ex05.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-08</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    Program to drive the add2 filter</span>
<span style="color: #008787; background-color: #262626;"> *          use standard I/O library instead</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_pipe</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span><span style="color: #268bd2;">)</span>;  <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">our signal handler</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>   <span style="color: #8787d7;">n</span>, <span style="color: #8787d7;">fd1</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>, <span style="color: #8787d7;">fd2</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">FILE</span> *<span style="color: #8787d7;">fpr</span>, *<span style="color: #8787d7;">fpw</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span> <span style="color: #8787d7;">pid</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>  <span style="color: #8787d7;">line</span><span style="color: #d75fd7;">[</span>MAXLINE<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>signal<span style="color: #2aa198;">(</span>SIGPIPE, sig_pipe<span style="color: #2aa198;">)</span> == SIG_ERR<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"signal error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>fd1<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span> || pipe<span style="color: #2aa198;">(</span>fd2<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fpr = fdopen<span style="color: #67b11d;">(</span>fd2<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fdopen error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>setvbuf<span style="color: #2aa198;">(</span>fpr, <span style="color: #d75fd7;">NULL</span>, _IOLBF, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"setvbuf error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fpw = fdopen<span style="color: #67b11d;">(</span>fd1<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">"w"</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fdopen error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>setvbuf<span style="color: #2aa198;">(</span>fpw, <span style="color: #d75fd7;">NULL</span>, _IOLBF, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"setvbuf error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid &gt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">parent process</span>
        close<span style="color: #2aa198;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        close<span style="color: #2aa198;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">while</span> <span style="color: #2aa198;">(</span>fgets<span style="color: #67b11d;">(</span>line, MAXLINE, stdin<span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">NULL</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            n = strlen<span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>;
<span style="color: #d75fd7;">#if</span> <span style="color: #d75fd7;">0</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>write<span style="color: #875f00;">(</span>fd1<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, line, n<span style="color: #875f00;">)</span> != n<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #875f00;">(</span>n = read<span style="color: #268bd2;">(</span>fd2<span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">]</span>, line, MAXLINE<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>n == <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_msg<span style="color: #875f00;">(</span><span style="color: #2aa198;">"child closed pipe"</span><span style="color: #875f00;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
<span style="color: #d75fd7;">#endif</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>fputs<span style="color: #875f00;">(</span>line, fpw<span style="color: #875f00;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"fputs error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>fgets<span style="color: #875f00;">(</span>line, MAXLINE, fpr<span style="color: #875f00;">)</span> == <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_msg<span style="color: #875f00;">(</span><span style="color: #2aa198;">"fgets error"</span><span style="color: #875f00;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
            line<span style="color: #67b11d;">[</span>n<span style="color: #67b11d;">]</span> = <span style="color: #d75fd7;">0</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>fputs<span style="color: #875f00;">(</span>line, stdout<span style="color: #875f00;">)</span> == EOF<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"fputs error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ferror<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"fgets error on stdin"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">child process</span>
        close<span style="color: #2aa198;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        close<span style="color: #2aa198;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd1<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span> != STDIN_FILENO<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #875f00;">(</span>fd1<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">]</span>, STDIN_FILENO<span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"dup2 error to stdin"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd1<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>fd2<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span> != STDOUT_FILENO<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>dup2<span style="color: #875f00;">(</span>fd2<span style="color: #268bd2;">[</span><span style="color: #d75fd7;">1</span><span style="color: #268bd2;">]</span>, STDOUT_FILENO<span style="color: #875f00;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"dup2 error to stdout"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
            close<span style="color: #67b11d;">(</span>fd2<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">if (execl("../bin/15fig17", "15fig17", (char*)0) &lt; 0) {</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>execl<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"../bin/15fig19"</span>, <span style="color: #2aa198;">"15fig19"</span>, <span style="color: #875f00;">(</span><span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #875f00;">)</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"excel error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #268bd2; font-weight: bold;">static</span> <span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">sig_pipe</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">signo</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"SIGPIPE caught\n"</span><span style="color: #d75fd7;">)</span>;
    exit<span style="color: #d75fd7;">(</span>EXIT_FAILURE<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
15.6
The wait function catch the child that popen function generated because we can't distinguish which is the child we want.
</p>
<blockquote>
<p>
The system function calls wait, and the first child to terminate is the child generated by popen. Since that’s not the child that system created, it calls wait again and blocks until the sleep is done. Then system returns. When pclose calls wait, an error is returned, since there are no more children to wait for. Then pclose returns an error.
</p>
</blockquote></li>
<li><p>
15.7
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15ex07.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-15</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    select/poll a pipe</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/poll.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/select.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">test_select_closew</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">fd_set</span>         <span style="color: #8787d7;">rfds</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">tv</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">ret</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span>          <span style="color: #8787d7;">pid</span>;

    puts<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"test select: close write end"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    FD_ZERO<span style="color: #d75fd7;">(</span>&amp;rfds<span style="color: #d75fd7;">)</span>;
    FD_SET<span style="color: #d75fd7;">(</span>fd<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span>, &amp;rfds<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">5</span><span style="color: #2aa198;">)</span>;
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"child: write end closed"</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>;;<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            tv.tv_sec  = <span style="color: #d75fd7;">1</span>;
            tv.tv_usec = <span style="color: #d75fd7;">0</span>;

            write<span style="color: #67b11d;">(</span>fd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">1</span><span style="color: #875f00;">]</span>, <span style="color: #2aa198;">"hello, world\n"</span>, <span style="color: #d75fd7;">13</span><span style="color: #67b11d;">)</span>;
            ret = select<span style="color: #67b11d;">(</span>fd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span> + <span style="color: #d75fd7;">1</span>, &amp;rfds, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span>, &amp;tv<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ret == -<span style="color: #d75fd7;">1</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"select error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ret &gt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"data ready\n"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"time expired\n"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        waitpid<span style="color: #2aa198;">(</span>pid, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">test_select_closer</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">fd_set</span>         <span style="color: #8787d7;">rfds</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">timeval</span> <span style="color: #8787d7;">tv</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>            <span style="color: #8787d7;">ret</span>;
    <span style="color: #df005f; font-weight: bold;">pid_t</span>          <span style="color: #8787d7;">pid</span>;

    puts<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"test select: close read end"</span><span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pipe<span style="color: #2aa198;">(</span>fd<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"pipe error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    FD_ZERO<span style="color: #d75fd7;">(</span>&amp;rfds<span style="color: #d75fd7;">)</span>;
    FD_SET<span style="color: #d75fd7;">(</span>fd<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span>, &amp;rfds<span style="color: #d75fd7;">)</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"fork error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>pid == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        write<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span>, <span style="color: #2aa198;">"hello, world\n"</span>, <span style="color: #d75fd7;">13</span><span style="color: #2aa198;">)</span>;
        sleep<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">5</span><span style="color: #2aa198;">)</span>;
        close<span style="color: #2aa198;">(</span>fd<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">0</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"child: read end closed"</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>;;<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            tv.tv_sec  = <span style="color: #d75fd7;">1</span>;
            tv.tv_usec = <span style="color: #d75fd7;">0</span>;

            ret = select<span style="color: #67b11d;">(</span>fd<span style="color: #875f00;">[</span><span style="color: #d75fd7;">0</span><span style="color: #875f00;">]</span> + <span style="color: #d75fd7;">1</span>, &amp;rfds, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">NULL</span>, &amp;tv<span style="color: #67b11d;">)</span>;
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ret == -<span style="color: #d75fd7;">1</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                err_sys<span style="color: #875f00;">(</span><span style="color: #2aa198;">"select error"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>ret &gt; <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"\rdata ready\n"</span><span style="color: #875f00;">)</span>;
                <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #875f00;">(</span>FD_ISSET<span style="color: #268bd2;">(</span>fd<span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">]</span>, &amp;rfds<span style="color: #268bd2;">)</span><span style="color: #875f00;">)</span> <span style="color: #875f00;">{</span>
                    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">buff</span><span style="color: #268bd2;">[</span>MAXLINE<span style="color: #268bd2;">]</span> = <span style="color: #268bd2;">{</span><span style="color: #d75fd7;">0</span><span style="color: #268bd2;">}</span>;
                    read<span style="color: #268bd2;">(</span>fd<span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">]</span>, buff, MAXLINE<span style="color: #268bd2;">)</span>;
                    printf<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"data read: %s"</span>, buff<span style="color: #268bd2;">)</span>;
                    write<span style="color: #268bd2;">(</span>fd<span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">]</span>, buff, strlen<span style="color: #d75fd7;">(</span>buff<span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span>;
                <span style="color: #875f00;">}</span>
            <span style="color: #67b11d;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"time expired\n"</span><span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
        waitpid<span style="color: #2aa198;">(</span>pid, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span>EXIT_SUCCESS<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">void</span> <span style="color: #d75fd7; font-weight: bold;">test_poll</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span> test_select_closer<span style="color: #d75fd7;">()</span>; <span style="color: #268bd2;">}</span>
</pre>
</div>
<p>
The answer gives the following table about various behaviors on different systems, but when I test, it seems different
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 26:</span> Figure C.19 Pipe behavior with select and poll</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operation</th>
<th scope="col" class="org-left">FreeBSD 8.0</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
<th scope="col" class="org-left">Solaris</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">select on read end of pipe with write end closed</td>
<td class="org-left">R/W/E</td>
<td class="org-left">R</td>
<td class="org-left">R/W</td>
<td class="org-left">R/W/E</td>
</tr>

<tr>
<td class="org-left">poll on read end of pipe with write end closed</td>
<td class="org-left">R/HUP</td>
<td class="org-left">HUP</td>
<td class="org-left">INV</td>
<td class="org-left">HUP</td>
</tr>

<tr>
<td class="org-left">select on write end of pipe with read end closed</td>
<td class="org-left">R/W/E</td>
<td class="org-left">R/W</td>
<td class="org-left">R/W</td>
<td class="org-left">R/W</td>
</tr>

<tr>
<td class="org-left">poll on write end of pipe with read end closed</td>
<td class="org-left">R/HUP</td>
<td class="org-left">W/ERR</td>
<td class="org-left">INV</td>
<td class="org-left">HUP</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 27:</span> tested answer</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operation</th>
<th scope="col" class="org-left">Linux 3.2.0</th>
<th scope="col" class="org-left">Mac OS X 10.6.8</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">select on read end of pipe with write end closed</td>
<td class="org-left">R/W</td>
<td class="org-left">R/W</td>
</tr>

<tr>
<td class="org-left">select on write end of pipe with read end closed</td>
<td class="org-left">HUP</td>
<td class="org-left">HUP</td>
</tr>
</tbody>
</table></li>
<li>15.8
parent's standard error appears.</li>
<li><p>
15.9
<code>fork</code>, then <code>exec</code>, <code>waitpid</code>, <code>exit</code>
</p>
<blockquote>
<p>
The popen function forks a child, and the child executes the shell. The shell in turn calls fork, and the child of the shell executes the command string. When cmdstring terminates, the shell is waiting for this to happen. The shell then exits, which is what the waitpid in pclose is waiting for.
</p>
</blockquote></li>
<li><p>
15.10 open twice, and using O_NONBLOCK for reading mode
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15ex10.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-17</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    read and write a FIFO</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">fcntl.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">TMPFIFO</span> <span style="color: #2aa198;">"/tmp/tmp.fifo"</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fr</span>, <span style="color: #8787d7;">fw</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>mkfifo<span style="color: #2aa198;">(</span>TMPFIFO, FILE_MODE<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"mkfifo error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fr = open<span style="color: #67b11d;">(</span>TMPFIFO, O_RDONLY | O_NONBLOCK<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">non-block for avoiding deadlock</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fw = open<span style="color: #67b11d;">(</span>TMPFIFO, O_WRONLY<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"open error"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    clr_fl<span style="color: #d75fd7;">(</span>fr, O_NONBLOCK<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
15.11
</p>
<blockquote>
<p>
The identifier of the message queue. The queue would have to allow the appropriate level of access (probably world-read, for a random malicious process). It would interfere with the running of the server/clients though, because each would probably be expecting messages to exist on the queue that aren't there.
</p>
</blockquote></li>
<li><p>
15.12
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *   @file     15ex12.c</span>
<span style="color: #008787; background-color: #262626;"> *   @date     2020-01-17</span>
<span style="color: #008787; background-color: #262626;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #008787; background-color: #262626;"> *   @version  1.0</span>
<span style="color: #008787; background-color: #262626;"> *   @brief    practice a message queue</span>
<span style="color: #008787; background-color: #262626;"> */</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/ipc.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/msg.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/types.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MSG_KEY</span> <span style="color: #d75fd7;">5</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MSG_LEN</span> <span style="color: #d75fd7;">32</span>

<span style="color: #268bd2; font-weight: bold;">typedef</span> <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">mtype</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">mtext</span><span style="color: #d75fd7;">[</span>MSG_LEN<span style="color: #d75fd7;">]</span>;
<span style="color: #268bd2;">}</span> <span style="color: #df005f; font-weight: bold;">msgbuf</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>    <span style="color: #8787d7;">msqid</span>;
    <span style="color: #df005f; font-weight: bold;">msgbuf</span> <span style="color: #8787d7;">msg</span> = <span style="color: #d75fd7;">{</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">}</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span> = <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">5</span>; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>msqid = msgget<span style="color: #875f00;">(</span>MSG_KEY, IPC_CREAT<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_msg<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"msgget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span> <span style="color: #268bd2; font-weight: bold;">else</span> <span style="color: #2aa198;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"id: %d\n"</span>, msqid<span style="color: #67b11d;">)</span>;
            msgctl<span style="color: #67b11d;">(</span>msqid, IPC_RMID, <span style="color: #d75fd7;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    getchar<span style="color: #d75fd7;">()</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">i</span> = <span style="color: #d75fd7;">0</span>; i &lt; <span style="color: #d75fd7;">5</span>; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>msqid = msgget<span style="color: #875f00;">(</span>IPC_PRIVATE, IPC_CREAT | <span style="color: #d75fd7;">0600</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_msg<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"msgget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        msg.mtype = <span style="color: #d75fd7;">1</span>;
        snprintf<span style="color: #2aa198;">(</span>msg.mtext, MSG_LEN, <span style="color: #2aa198;">"hello world"</span><span style="color: #2aa198;">)</span>;

        <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">msgsz</span> = strlen<span style="color: #2aa198;">(</span>msg.mtext<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>msgsnd<span style="color: #875f00;">(</span>msqid, &amp;msg, msgsz, <span style="color: #d75fd7;">0</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            perror<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"msgsnd error: "</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        memset<span style="color: #2aa198;">(</span>msg.mtext, <span style="color: #d75fd7;">0</span>, MSG_LEN<span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>msgrcv<span style="color: #67b11d;">(</span>msqid, &amp;msg, MSG_LEN, <span style="color: #d75fd7;">0</span>, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span> == -<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            perror<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"msgrcv error: "</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"mtext: %s\n"</span>, msg.mtext<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
<li><p>
15.13 The actual addresses are different for different processes, so we need to store offsets instead.
</p>
<blockquote>
<p>
We never store actual addresses in a shared memory segment, since it’s possible for the server and all the clients to attach the segment at different addresses. Instead, when a linked list is built in a shared memory segment, the list pointers should be stored as offsets to other objects in the shared memory segment. These offsets are formed by subtracting the start of the shared memory segment from the actual address of the object.
</p>
</blockquote></li>
<li>15.14
<img src="Chapter15/15ex14.jpg" alt="15ex14.jpg" /></li>
<li>15.15</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9351430" class="outline-3">
<h3 id="org9351430"><span class="todo TODO">TODO</span> Chapter 16. Network IPC: Sockets <code>[2/9]</code></h3>
<div class="outline-text-3" id="text-org9351430">
</div>
<div id="outline-container-org82e185a" class="outline-4">
<h4 id="org82e185a"><span class="done DONE">DONE</span> 16.1 Introduction</h4>
<div class="outline-text-4" id="text-org82e185a">
<p>
<b>only an overview of the socket API</b>
</p>
</div>
</div>
<div id="outline-container-org48fce5c" class="outline-4">
<h4 id="org48fce5c"><span class="done DONE">DONE</span> 16.2 Socket Descriptors</h4>
<div class="outline-text-4" id="text-org48fce5c">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/socket..h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *  @brief create socket</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  @param domain   determines the nature of the communication, includes the</span>
<span style="color: #008787; background-color: #262626;"> *                  address format</span>
<span style="color: #008787; background-color: #262626;"> *  @param type     determines the type of the socket, which further determine</span>
<span style="color: #008787; background-color: #262626;"> *                  the communication characteristics</span>
<span style="color: #008787; background-color: #262626;"> *  @param protocol usually 0, to select the default protocol for the given</span>
<span style="color: #008787; background-color: #262626;"> *                  domain and socket type. but can select a particular protocol</span>
<span style="color: #008787; background-color: #262626;"> *</span>
<span style="color: #008787; background-color: #262626;"> *  @return file (socket) descriptor if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">socket</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">domain</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">type</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">protocol</span><span style="color: #268bd2;">)</span>;

<span style="color: #008787; background-color: #262626;">/**</span>
<span style="color: #008787; background-color: #262626;"> *  @brief diasable I/O on a socket</span>
<span style="color: #008787; background-color: #262626;"> *  @param sockfd     socket's return value</span>
<span style="color: #008787; background-color: #262626;"> *  @param how        SHUT_RD,   reading is disabled</span>
<span style="color: #008787; background-color: #262626;"> *                    SHUT_WR,   writing is disabled</span>
<span style="color: #008787; background-color: #262626;"> *                    SHUT_RDWR, disable both data transmission and reception</span>
<span style="color: #008787; background-color: #262626;"> *  @return 0 if OK, -1 on error</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">shutdown</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">sockfd</span>, <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">how</span><span style="color: #268bd2;">)</span>;
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 28:</span> Figure 16.1 Socket communication domains</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Domain</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">AF_INET</td>
<td class="org-left">IPv4 Internet domain</td>
</tr>

<tr>
<td class="org-left">AF_INET6</td>
<td class="org-left">IPv6 Internet domain (optional in POSIX.1)</td>
</tr>

<tr>
<td class="org-left">AF_UNIX</td>
<td class="org-left">UNIX domain</td>
</tr>

<tr>
<td class="org-left">AF_UNSPEC</td>
<td class="org-left">unspecified</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 29:</span> Figure 16.2 Socket types</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SOCK_DGRAM</td>
<td class="org-left">fix-length, connectionless, unreliable messages</td>
</tr>

<tr>
<td class="org-left">SOCK_RAW</td>
<td class="org-left">datagram interface to IP (optional in POSIX.1)</td>
</tr>

<tr>
<td class="org-left">SOCK_SEQPACKET</td>
<td class="org-left">fix-length, sequenced, reliable, connection-oriented message</td>
</tr>

<tr>
<td class="org-left">SOCK_STREAMS</td>
<td class="org-left">sequenced, reliable, bidirectional, connection-oriented byte streams</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 30:</span> Figure 16.3 Protocols defined for Internet domain socks</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Protocol</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">IPPROTO_IP</td>
<td class="org-left">IPv4 Internet Protocol</td>
</tr>

<tr>
<td class="org-left">IPPROTO_IPV6</td>
<td class="org-left">IPv6 Internet Protocol (optional in POSIX.1)</td>
</tr>

<tr>
<td class="org-left">IPPROTO_ICMP</td>
<td class="org-left">Internet Control message Protocol</td>
</tr>

<tr>
<td class="org-left">IPPROTO_RAW</td>
<td class="org-left">Raw IP packets protocol (optional in POSIX.1)</td>
</tr>

<tr>
<td class="org-left">IPPROTO_TCP</td>
<td class="org-left">Transmission Control Protocol</td>
</tr>

<tr>
<td class="org-left">IPPROTO_UDP</td>
<td class="org-left">User Datagram Protocol</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgf19dbde" class="outline-4">
<h4 id="orgf19dbde"><span class="todo TODO">TODO</span> 16.3 Addressing</h4>
<div class="outline-text-4" id="text-orgf19dbde">
</div>
<ul class="org-ul">
<li><a id="orgeff957c"></a><span class="todo TODO">TODO</span> 16.3.1 Byte Ordering<br /></li>
<li><a id="org2104a6c"></a><span class="todo TODO">TODO</span> 16.3.2 Address Formats<br /></li>
<li><a id="org4752c4a"></a><span class="todo TODO">TODO</span> 16.3.3 Address Lookup<br /></li>
<li><a id="orgcea126d"></a><span class="todo TODO">TODO</span> 16.3.4 Associating Addresses with Sockets<br /></li>
</ul>
</div>
<div id="outline-container-org5e4e352" class="outline-4">
<h4 id="org5e4e352"><span class="todo TODO">TODO</span> 16.4 Connection Establishment</h4>
</div>
<div id="outline-container-org6a354b0" class="outline-4">
<h4 id="org6a354b0"><span class="todo TODO">TODO</span> 16.5 Data Transfer</h4>
</div>
<div id="outline-container-orgef8e949" class="outline-4">
<h4 id="orgef8e949"><span class="todo TODO">TODO</span> 16.6 Socket Options</h4>
</div>
<div id="outline-container-orge7422cb" class="outline-4">
<h4 id="orge7422cb"><span class="todo TODO">TODO</span> 16.7 Out-of-Band Data</h4>
</div>
<div id="outline-container-orgea231cf" class="outline-4">
<h4 id="orgea231cf"><span class="todo TODO">TODO</span> 16.8 Nonblocking and Asynchronous I/O</h4>
</div>
<div id="outline-container-org37b2573" class="outline-4">
<h4 id="org37b2573"><span class="todo TODO">TODO</span> 16.9 Summary</h4>
</div>
</div>
<div id="outline-container-org02a997c" class="outline-3">
<h3 id="org02a997c"><span class="todo TODO">TODO</span> Chapter 17. Advanced IPC <code>[2/7]</code></h3>
<div class="outline-text-3" id="text-org02a997c">
</div>
<div id="outline-container-org67eb00b" class="outline-4">
<h4 id="org67eb00b"><span class="todo TODO">TODO</span> 17.1 Introduction</h4>
</div>
<div id="outline-container-orgdc46013" class="outline-4">
<h4 id="orgdc46013"><span class="done DONE">DONE</span> 17.2 UNIX Domain Sockets</h4>
<div class="outline-text-4" id="text-orgdc46013">
<ul class="org-ul">
<li><p>
Example &#x2013; Polling XSI Message Queues with the Help of UNIX Domain Sockets
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 135: </span>Figure 17.3 Poll for XSI Messsages using UNIX domain sockets</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">poll.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">pthread.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/msg.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/socket.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">NQ</span>     <span style="color: #d75fd7;">3</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MAXMSZ</span> <span style="color: #d75fd7;">512</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">KEY</span>    <span style="color: #d75fd7;">0x123</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">threadinfo</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">qid</span>;
    <span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">fd</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">mymesg</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">mtype</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">mtext</span><span style="color: #d75fd7;">[</span>MAXMSZ<span style="color: #d75fd7;">]</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #d75fd7; font-weight: bold;">helper</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span> *<span style="color: #8787d7;">arg</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>                <span style="color: #8787d7;">n</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">mymesg</span>      <span style="color: #8787d7;">m</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">threadinfo</span> *<span style="color: #8787d7;">tip</span> = arg;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        memset<span style="color: #2aa198;">(</span>&amp;m, <span style="color: #d75fd7;">0</span>, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>m<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span>;
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>n = msgrcv<span style="color: #875f00;">(</span>tip-&gt;qid, &amp;m, MAXMSZ, <span style="color: #d75fd7;">0</span>, MSG_NOERROR<span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"msgrcv error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>write<span style="color: #67b11d;">(</span>tip-&gt;fd, m.mtext, n<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
<span style="color: #268bd2;">}</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">()</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>               <span style="color: #8787d7;">i</span>, <span style="color: #8787d7;">n</span>, <span style="color: #8787d7;">err</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>               <span style="color: #8787d7;">fd</span><span style="color: #d75fd7;">[</span><span style="color: #d75fd7;">2</span><span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>               <span style="color: #8787d7;">qid</span><span style="color: #d75fd7;">[</span>NQ<span style="color: #d75fd7;">]</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">pollfd</span>     <span style="color: #8787d7;">pfd</span><span style="color: #d75fd7;">[</span>NQ<span style="color: #d75fd7;">]</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">threadinfo</span> <span style="color: #8787d7;">ti</span><span style="color: #d75fd7;">[</span>NQ<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">pthread_t</span>         <span style="color: #8787d7;">tid</span><span style="color: #d75fd7;">[</span>NQ<span style="color: #d75fd7;">]</span>;
    <span style="color: #df005f; font-weight: bold;">char</span>              <span style="color: #8787d7;">buf</span><span style="color: #d75fd7;">[</span>MAXMSZ<span style="color: #d75fd7;">]</span>;

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NQ; ++i<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>qid<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span> = msgget<span style="color: #875f00;">(</span><span style="color: #268bd2;">(</span>KEY + i<span style="color: #268bd2;">)</span>, IPC_CREAT | <span style="color: #d75fd7;">0666</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"msgget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        printf<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"queue ID %d is %d\n"</span>, i, qid<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>socketpair<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_DGRAM, <span style="color: #d75fd7;">0</span>, fd<span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"socketpair error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        pfd<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.fd     = fd<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">0</span><span style="color: #2aa198;">]</span>;
        pfd<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.events = POLLIN;
        ti<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.qid     = qid<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>;
        ti<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.fd      = fd<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>;

        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span><span style="color: #67b11d;">(</span>err = pthread_create<span style="color: #875f00;">(</span>&amp;tid<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>, <span style="color: #d75fd7;">NULL</span>, helper, &amp;ti<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span><span style="color: #875f00;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2aa198;">"pthread_create error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>

    <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #d75fd7;">(</span>;;<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>poll<span style="color: #67b11d;">(</span>pfd, NQ, -<span style="color: #d75fd7;">1</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2aa198;">"poll error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2aa198;">}</span>

        <span style="color: #268bd2; font-weight: bold;">for</span> <span style="color: #2aa198;">(</span>i = <span style="color: #d75fd7;">0</span>; i &lt; NQ; ++i<span style="color: #2aa198;">)</span> <span style="color: #2aa198;">{</span>
            <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pfd<span style="color: #875f00;">[</span>i<span style="color: #875f00;">]</span>.revents &amp; POLLIN<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #875f00;">(</span><span style="color: #268bd2;">(</span>n = read<span style="color: #d75fd7;">(</span>pfd<span style="color: #2aa198;">[</span>i<span style="color: #2aa198;">]</span>.fd, buf, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>buf<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span><span style="color: #268bd2;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #875f00;">)</span> <span style="color: #875f00;">{</span>
                    err_sys<span style="color: #268bd2;">(</span><span style="color: #2aa198;">"read error"</span><span style="color: #268bd2;">)</span>;
                <span style="color: #875f00;">}</span>
                buf<span style="color: #875f00;">[</span>n<span style="color: #875f00;">]</span> = <span style="color: #d75fd7;">0</span>;
                printf<span style="color: #875f00;">(</span><span style="color: #2aa198;">"queue id %d, message %s\n"</span>, qid<span style="color: #268bd2;">[</span>i<span style="color: #268bd2;">]</span>, buf<span style="color: #875f00;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2aa198;">}</span>
    <span style="color: #d75fd7;">}</span>
    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 136: </span>Figure 17.4 Post a message to XSI message queue</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/msg.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">MAXMSZ</span> <span style="color: #d75fd7;">512</span>

<span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">mymesg</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">long</span> <span style="color: #8787d7;">mtype</span>;
    <span style="color: #df005f; font-weight: bold;">char</span> <span style="color: #8787d7;">mtext</span><span style="color: #d75fd7;">[</span>MAXMSZ<span style="color: #d75fd7;">]</span>;
<span style="color: #268bd2;">}</span>;

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">argc</span>, <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">argv</span><span style="color: #d75fd7;">[]</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">key_t</span>         <span style="color: #8787d7;">key</span>;
    <span style="color: #df005f; font-weight: bold;">long</span>          <span style="color: #8787d7;">qid</span>;
    <span style="color: #df005f; font-weight: bold;">size_t</span>        <span style="color: #8787d7;">nbytes</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">mymesg</span> <span style="color: #8787d7;">m</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>argc != <span style="color: #d75fd7;">3</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        fprintf<span style="color: #2aa198;">(</span>stderr, <span style="color: #2aa198;">"usage: sendmsg KEY message\n"</span><span style="color: #2aa198;">)</span>;
        exit<span style="color: #2aa198;">(</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    key = strtol<span style="color: #d75fd7;">(</span>argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">1</span><span style="color: #2aa198;">]</span>, <span style="color: #d75fd7;">NULL</span>, <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>qid = msgget<span style="color: #67b11d;">(</span>key, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't open queue key %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #d75fd7;">1</span><span style="color: #67b11d;">]</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    memset<span style="color: #d75fd7;">(</span>&amp;m, <span style="color: #d75fd7;">0</span>, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>m<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    strncpy<span style="color: #d75fd7;">(</span>m.mtext, argv<span style="color: #2aa198;">[</span><span style="color: #d75fd7;">2</span><span style="color: #2aa198;">]</span>, MAXMSZ - <span style="color: #d75fd7;">1</span><span style="color: #d75fd7;">)</span>;
    nbytes  = strlen<span style="color: #d75fd7;">(</span>m.mtext<span style="color: #d75fd7;">)</span>;
    m.mtype = <span style="color: #d75fd7;">1</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>msgsnd<span style="color: #2aa198;">(</span>qid, &amp;m, nbytes, <span style="color: #d75fd7;">0</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"can't send message"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    exit<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
<ul class="org-ul">
<li><a id="org722a0d1"></a><span class="done DONE">DONE</span> 17.2.1 Naming UNIX Domain Sockets<br />
<div class="outline-text-5" id="text-org722a0d1">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 137: </span>Figure 17.5 Binding an address to a UNIX domain socket</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">apue.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/socket.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/un.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">main</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">void</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>                <span style="color: #8787d7;">fd</span>, <span style="color: #8787d7;">size</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr_un</span> <span style="color: #8787d7;">un</span>;

    un.sun_family = AF_UNIX;
    strcpy<span style="color: #d75fd7;">(</span>un.sun_path, <span style="color: #2aa198;">"foo.socket"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"socket failed"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    size = offsetof<span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #d75fd7;">)</span> + strlen<span style="color: #d75fd7;">(</span>un.sun_path<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>bind<span style="color: #2aa198;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, size<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        err_sys<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"bind failed"</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    printf<span style="color: #d75fd7;">(</span><span style="color: #2aa198;">"UNIX domain socket bound\n"</span><span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">0</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org0e80c97" class="outline-4">
<h4 id="org0e80c97"><span class="done DONE">DONE</span> 17.3 Unique Connections</h4>
<div class="outline-text-4" id="text-org0e80c97">
<p>
develop three functions can be used to create unique connections between unrelated processes running on same machine:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">serv_listen</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span>;            <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: file descriptor to listen on if OK, negative value on error</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">serv_accept</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">listenfd</span>, <span style="color: #df005f; font-weight: bold;">uid_t</span> *<span style="color: #8787d7;">uidptr</span><span style="color: #268bd2;">)</span>; <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: new file descriptor if OK, negative value on Error</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">cli_conn</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span>;               <span style="color: #008787; background-color: #262626;">// </span><span style="color: #008787; background-color: #262626;">Returns: file descriptor if OK, negative value on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/socket.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/un.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">QLEN</span> <span style="color: #d75fd7;">10</span>

<span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;"> * Create a server endpoint of a connection.</span>
<span style="color: #008787; background-color: #262626;"> * Returns fd if all OK, &lt;0 on error.</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">serv_listen</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span>
<span style="color: #268bd2;">{</span>
  <span style="color: #df005f; font-weight: bold;">int</span>                <span style="color: #8787d7;">fd</span>, <span style="color: #8787d7;">len</span>, <span style="color: #8787d7;">err</span>, <span style="color: #8787d7;">rval</span>;
  <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr_un</span> <span style="color: #8787d7;">un</span>;

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>strlen<span style="color: #2aa198;">(</span>name<span style="color: #2aa198;">)</span> &gt;= <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>un.sun_path<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    errno = ENAMETOOLONG;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
  <span style="color: #d75fd7;">}</span>

  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">create a UNIX domain stream socket */</span>
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
  <span style="color: #d75fd7;">}</span>

  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">in case it already exists */</span>
  unlink<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;

  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">fill in socket address structure */</span>
  memset<span style="color: #d75fd7;">(</span>&amp;un, <span style="color: #d75fd7;">0</span>, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>un<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
  un.sun_family = AF_UNIX;
  strcpy<span style="color: #d75fd7;">(</span>un.sun_path, name<span style="color: #d75fd7;">)</span>;
  len = offsetof<span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #d75fd7;">)</span> + strlen<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;

  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">bind the name to the descriptor */</span>
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>bind<span style="color: #2aa198;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, len<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    rval = -<span style="color: #d75fd7;">3</span>;
    <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
  <span style="color: #d75fd7;">}</span>

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>listen<span style="color: #2aa198;">(</span>fd, QLEN<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">tell kernel we're a server */</span>
    rval = -<span style="color: #d75fd7;">4</span>;
    <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
  <span style="color: #d75fd7;">}</span>

  <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fd<span style="color: #d75fd7;">)</span>;

 <span style="color: #d75fd7;">errout</span>:
  err = errno;
  close<span style="color: #d75fd7;">(</span>fd<span style="color: #d75fd7;">)</span>;
  errno = err;
  <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>rval<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-center">
<p>
Figure 17.8 The <code>serv_listen</code> function
</p>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/socket.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/un.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">time.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">STALE</span> <span style="color: #d75fd7;">30</span> <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">client's name can't be older than this (sec) */</span>

<span style="color: #008787; background-color: #262626;">/**********************************************************</span><span style="color: #008787; background-color: #262626;">/</span>
<span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">Wait for a client connection to arrive, and accept it. */</span>
<span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">We also obtain the client's user ID from the pathname  */</span>
<span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">that it must bind before calling us.                   */</span>
<span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">Returns new fd if all OK, &lt;0 on error                  */</span>
<span style="color: #008787; background-color: #262626;">/**********************************************************</span><span style="color: #008787; background-color: #262626;">/</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">serv_accept</span><span style="color: #268bd2;">(</span><span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #8787d7;">listenfd</span>, <span style="color: #df005f; font-weight: bold;">uid_t</span> *<span style="color: #8787d7;">uidptr</span><span style="color: #268bd2;">)</span>
<span style="color: #268bd2;">{</span>
  <span style="color: #df005f; font-weight: bold;">int</span>                <span style="color: #8787d7;">clifd</span>, <span style="color: #8787d7;">err</span>, <span style="color: #8787d7;">rval</span>;
  <span style="color: #df005f; font-weight: bold;">socklen_t</span>          <span style="color: #8787d7;">len</span>;
  <span style="color: #df005f; font-weight: bold;">time_t</span>             <span style="color: #8787d7;">staletime</span>;
  <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr_un</span> <span style="color: #8787d7;">un</span>;
  <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">stat</span>        <span style="color: #8787d7;">statbuf</span>;
  <span style="color: #df005f; font-weight: bold;">char</span> *             <span style="color: #8787d7;">name</span>;

  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">allocate enough space for longest name plus terminating null */</span>
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>name = malloc<span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #875f00;">(</span>un.sun_path<span style="color: #875f00;">)</span> + <span style="color: #d75fd7;">1</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
  <span style="color: #d75fd7;">}</span>
  len = <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #d75fd7;">(</span>un<span style="color: #d75fd7;">)</span>;
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>clifd = accept<span style="color: #67b11d;">(</span>listenfd, <span style="color: #875f00;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr</span> *<span style="color: #875f00;">)</span>&amp;un, &amp;len<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    free<span style="color: #2aa198;">(</span>name<span style="color: #2aa198;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">2</span><span style="color: #2aa198;">)</span>;
  <span style="color: #d75fd7;">}</span>

  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">obtain the client't uid from its calling address */</span>
  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">len of pathname */</span>
  len -= offsetof<span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #d75fd7;">)</span>;
  memcpy<span style="color: #d75fd7;">(</span>name, un.sun_path, len<span style="color: #d75fd7;">)</span>;
  <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">null terminate */</span>
  name<span style="color: #d75fd7;">[</span>len<span style="color: #d75fd7;">]</span> = <span style="color: #d75fd7;">0</span>;
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>stat<span style="color: #2aa198;">(</span>name, &amp;statbuf<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    rval = -<span style="color: #d75fd7;">3</span>;
    <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
  <span style="color: #d75fd7;">}</span>

<span style="color: #d75fd7;">#ifdef</span> S_ISSOCK
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>S_ISSOCK<span style="color: #2aa198;">(</span>statbuf.st_mode<span style="color: #2aa198;">)</span> == <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">not a socket */</span>
    rval = -<span style="color: #d75fd7;">4</span>;
    <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
  <span style="color: #d75fd7;">}</span>
<span style="color: #d75fd7;">#endif</span>

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>statbuf.st_mode &amp; <span style="color: #67b11d;">(</span>S_IRWXG | S_IRWXO<span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> ||
      <span style="color: #2aa198;">(</span>statbuf.st_mode &amp; S_IRWXU<span style="color: #2aa198;">)</span> != S_IRWXU<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">is not rwx------ */</span>
    rval = -<span style="color: #d75fd7;">5</span>;
    <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
  <span style="color: #d75fd7;">}</span>

  staletime = time<span style="color: #d75fd7;">(</span><span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> - STALE;
  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>statbuf.st_atime &lt; staletime ||
      statbuf.st_ctime &lt; staletime ||
      statbuf.st_mtime &lt; staletime<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">i-node is too old */</span>;
    rval = -<span style="color: #d75fd7;">6</span>;
    <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
  <span style="color: #d75fd7;">}</span>

  <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>uidptr != <span style="color: #d75fd7;">NULL</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">return uid of caller */</span>
    *uidptr = statbuf.st_uid;
  <span style="color: #d75fd7;">}</span>
  unlink<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;
  free<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;
  <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>clifd<span style="color: #d75fd7;">)</span>;

 <span style="color: #d75fd7;">errout</span>:
  err = errno;
  close<span style="color: #d75fd7;">(</span>clifd<span style="color: #d75fd7;">)</span>;
  free<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;
  errno = err;
  <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>rval<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>

<div class="org-center">
<p>
Figure 17.9 The <code>serv_accept</code> function
</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 138: </span>Figure 17.10 The <code>cli_conn</code> function</label><pre class="src src-c"><span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">errno.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/socket.h</span><span style="color: #268bd2;">&gt;</span>
<span style="color: #d75fd7;">#include</span> <span style="color: #268bd2;">&lt;</span><span style="color: #2aa198;">sys/un.h</span><span style="color: #268bd2;">&gt;</span>

<span style="color: #d75fd7;">#include</span> <span style="color: #2aa198;">"apue.h"</span>

<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">CLI_PATH</span> <span style="color: #2aa198;">"/var/tmp"</span>
<span style="color: #d75fd7;">#define</span> <span style="color: #8787d7;">CLI_PERM</span> S_IRWXU <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">rwx for user only */</span>

<span style="color: #008787; background-color: #262626;">/*</span>
<span style="color: #008787; background-color: #262626;"> * Create a client endpoint and connect to a server.</span>
<span style="color: #008787; background-color: #262626;"> * Returns fd if all OK, &lt;0 on error.</span>
<span style="color: #008787; background-color: #262626;"> */</span>
<span style="color: #df005f; font-weight: bold;">int</span> <span style="color: #d75fd7; font-weight: bold;">cli_conn</span><span style="color: #268bd2;">(</span><span style="color: #268bd2; font-weight: bold;">const</span> <span style="color: #df005f; font-weight: bold;">char</span> *<span style="color: #8787d7;">name</span><span style="color: #268bd2;">)</span> <span style="color: #268bd2;">{</span>
    <span style="color: #df005f; font-weight: bold;">int</span>                <span style="color: #8787d7;">fd</span>, <span style="color: #8787d7;">len</span>, <span style="color: #8787d7;">err</span>, <span style="color: #8787d7;">rval</span>;
    <span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr_un</span> <span style="color: #8787d7;">un</span>, <span style="color: #8787d7;">sun</span>;
    <span style="color: #df005f; font-weight: bold;">int</span>                <span style="color: #8787d7;">do_unlink</span> = <span style="color: #d75fd7;">0</span>;

    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>strlen<span style="color: #2aa198;">(</span>name<span style="color: #2aa198;">)</span> &gt;= <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>un.sun_path<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        errno = ENAMETOOLONG;
        <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #2aa198;">(</span>-<span style="color: #d75fd7;">1</span><span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">create a UNIX domain stream socket */</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span><span style="color: #2aa198;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #d75fd7;">0</span><span style="color: #67b11d;">)</span><span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        <span style="color: #268bd2; font-weight: bold;">return</span> -<span style="color: #d75fd7;">1</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">fill socket address structure with our address */</span>
    memset<span style="color: #d75fd7;">(</span>&amp;un, <span style="color: #d75fd7;">0</span>, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>un<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    un.sun_family = AF_UNIX;
    sprintf<span style="color: #d75fd7;">(</span>un.sun_path, <span style="color: #2aa198;">"%s%05ld"</span>, CLI_PATH, <span style="color: #2aa198;">(</span><span style="color: #df005f; font-weight: bold;">long</span><span style="color: #2aa198;">)</span>getpid<span style="color: #2aa198;">()</span><span style="color: #d75fd7;">)</span>;
    len = offsetof<span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">typeof</span><span style="color: #2aa198;">(</span>un<span style="color: #2aa198;">)</span>, sun_path<span style="color: #d75fd7;">)</span>;

    unlink<span style="color: #d75fd7;">(</span>un.sun_path<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>bind<span style="color: #2aa198;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, len<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        rval = -<span style="color: #d75fd7;">2</span>;
        <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>chmod<span style="color: #2aa198;">(</span>un.sun_path, CLI_PERM<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        rval      = -<span style="color: #d75fd7;">3</span>;
        do_unlink = <span style="color: #d75fd7;">1</span>;
        <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
    <span style="color: #d75fd7;">}</span>

    <span style="color: #008787; background-color: #262626;">/* </span><span style="color: #008787; background-color: #262626;">fill socket address structure with server's address */</span>
    memset<span style="color: #d75fd7;">(</span>&amp;un, <span style="color: #d75fd7;">0</span>, <span style="color: #268bd2; font-weight: bold;">sizeof</span><span style="color: #2aa198;">(</span>un<span style="color: #2aa198;">)</span><span style="color: #d75fd7;">)</span>;
    sun.sun_family = AF_UNIX;
    strcpy<span style="color: #d75fd7;">(</span>sun.sun_path, name<span style="color: #d75fd7;">)</span>;
    len = offsetof<span style="color: #d75fd7;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #d75fd7;">)</span> + strlen<span style="color: #d75fd7;">(</span>name<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>connect<span style="color: #2aa198;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #268bd2; font-weight: bold;">struct</span> <span style="color: #df005f; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;sun, len<span style="color: #2aa198;">)</span> &lt; <span style="color: #d75fd7;">0</span><span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        rval      = -<span style="color: #d75fd7;">4</span>;
        do_unlink = <span style="color: #d75fd7;">1</span>;
        <span style="color: #268bd2; font-weight: bold;">goto</span> <span style="color: #d75fd7;">errout</span>;
    <span style="color: #d75fd7;">}</span>
    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>fd<span style="color: #d75fd7;">)</span>;

<span style="color: #d75fd7;">errout</span>:
    err = errno;
    close<span style="color: #d75fd7;">(</span>fd<span style="color: #d75fd7;">)</span>;
    <span style="color: #268bd2; font-weight: bold;">if</span> <span style="color: #d75fd7;">(</span>do_unlink<span style="color: #d75fd7;">)</span> <span style="color: #d75fd7;">{</span>
        unlink<span style="color: #2aa198;">(</span>un.sun_path<span style="color: #2aa198;">)</span>;
    <span style="color: #d75fd7;">}</span>
    errno = err;

    <span style="color: #268bd2; font-weight: bold;">return</span> <span style="color: #d75fd7;">(</span>rval<span style="color: #d75fd7;">)</span>;
<span style="color: #268bd2;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6d85444" class="outline-4">
<h4 id="org6d85444"><span class="todo TODO">TODO</span> 17.4 Passing File Descriptors</h4>
</div>
<div id="outline-container-orga30e533" class="outline-4">
<h4 id="orga30e533"><span class="todo TODO">TODO</span> 17.5 An Open Server, Version 1</h4>
</div>
<div id="outline-container-org7df9cb5" class="outline-4">
<h4 id="org7df9cb5"><span class="todo TODO">TODO</span> 17.6 An Open Server, Version 2</h4>
</div>
<div id="outline-container-org85379f3" class="outline-4">
<h4 id="org85379f3"><span class="todo TODO">TODO</span> 17.7 Summary</h4>
</div>
</div>
<div id="outline-container-org3e62f4c" class="outline-3">
<h3 id="org3e62f4c"><span class="todo TODO">TODO</span> Chapter 18. Terminal I/O <code>[0/0]</code></h3>
</div>
<div id="outline-container-org81aa478" class="outline-3">
<h3 id="org81aa478"><span class="todo TODO">TODO</span> Chapter 19. Pseudo Terminals <code>[0/0]</code></h3>
</div>
<div id="outline-container-org45be014" class="outline-3">
<h3 id="org45be014"><span class="todo TODO">TODO</span> Chapter 20. A Database Library <code>[0/0]</code></h3>
</div>
<div id="outline-container-org20280e2" class="outline-3">
<h3 id="org20280e2"><span class="todo TODO">TODO</span> Chapter 21. Communication with a Network Printer <code>[0/0]</code></h3>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<code>signalstack</code>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: whiothes</p>
<p class="date">Created: 2020-01-19 Sun 20:31</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-11-06 Wed 00:33 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced Programming in the Unix Environment</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="zhoush" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://whiothes.xyz/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://whiothes.xyz/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://whiothes.xyz/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://whiothes.xyz/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Advanced Programming in the Unix Environment</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd4cdb7a">Chapter 1. UNIX System Overview</a>
<ul>
<li><a href="#orgca72c56">Introduction</a></li>
<li><a href="#org997196b">UNIX Architecture</a></li>
<li><a href="#org7f0626a">Logging in</a></li>
<li><a href="#orgef66300">Files and Directories</a></li>
<li><a href="#org9d6d5b8">Input and Output</a></li>
<li><a href="#orgde0bde2">Programs and Processes</a></li>
<li><a href="#org4592874">Error Handling</a></li>
<li><a href="#org3d90d7c">User identification</a></li>
<li><a href="#org994bc6d">Signals</a></li>
<li><a href="#orge64f4b7">Time Values</a></li>
<li><a href="#org740d0b6">System calls and Library Functions</a></li>
<li><a href="#org4aa463b">Summary</a></li>
</ul>
</li>
<li><a href="#org52727c8">Chapter 2. UNIX Standardization and Implementations</a>
<ul>
<li><a href="#org5bd6750">Introduction</a></li>
<li><a href="#org5118233">UNIX Standardization</a>
<ul>
<li><a href="#org341c6fd">ISO C</a></li>
<li><a href="#orgeb635ac">IEEE POSIX</a></li>
<li><a href="#orgca5ee93">The Single UNIX Specification</a></li>
<li><a href="#org2a75d7f">FIPS</a></li>
</ul>
</li>
<li><a href="#orgd87c12c">UNIX System Implementations</a>
<ul>
<li><a href="#orgf161816">SVR4</a></li>
<li><a href="#org5f64633">4.4BSD</a></li>
<li><a href="#org99376d7">FreeBSD</a></li>
<li><a href="#org4dbb3d7">Linux</a></li>
<li><a href="#org042729a">Mac OS X</a></li>
<li><a href="#orgd5de41d">SOlaris</a></li>
<li><a href="#org2c1ca04">Others</a></li>
</ul>
</li>
<li><a href="#org5fa6a37">Relationship of Standards and Implementations</a></li>
<li><a href="#org4acd428">Limits</a>
<ul>
<li><a href="#orgede736c">ISO C Limits</a></li>
<li><a href="#org1279007">POSIX Limits</a></li>
<li><a href="#orgfb35739">XSI Limits</a></li>
<li><a href="#org6ad9586"><code>sysconf</code>, <code>pathconf</code>, and <code>fpathconf</code> Functions</a></li>
<li><a href="#org6a7916a">Indeterminate Runtime Limits</a></li>
</ul>
</li>
<li><a href="#orgb5d0494">Options</a></li>
<li><a href="#orgfad4533">Features Test Macros</a></li>
<li><a href="#org476fc37">Primitive System Data Types</a></li>
<li><a href="#orgeeff89a">Differences Between Standards</a></li>
<li><a href="#org8fff5e3">Summary</a></li>
</ul>
</li>
<li><a href="#orgc0e0846">Chapter 3. File I/O</a>
<ul>
<li><a href="#org882b4f2">Introduction</a></li>
<li><a href="#orgf012769">File Descriptors</a></li>
<li><a href="#org8c25169"><code>open</code> and <code>openat</code> Functions</a></li>
<li><a href="#org520b30c"><code>creat</code> Function</a></li>
<li><a href="#org29990bb"><code>close</code> Function</a></li>
<li><a href="#org208e136"><code>lseek</code> Function</a></li>
<li><a href="#orgdbdeeff"><code>read</code> Function</a></li>
<li><a href="#orgf0d5fbd"><code>write</code> Function</a></li>
<li><a href="#orgcc74a77">I/O Efficiency</a></li>
<li><a href="#orgfebebef">File Sharing</a></li>
<li><a href="#orgc4d81d6">Atomic Operations</a></li>
<li><a href="#org59fcf81"><code>dup</code> and <code>dup2</code> Functions</a></li>
<li><a href="#org9d5d726"><code>sync</code>, <code>fsync</code> and <code>fdatasync</code> Functions</a></li>
<li><a href="#org9da05a8"><code>fcntl</code> Function</a></li>
<li><a href="#org581c7df"><code>ioctl</code> Function</a></li>
<li><a href="#org6c77d7d"><code>/dev/fd</code></a></li>
<li><a href="#org4e4ffc9">Summary</a></li>
</ul>
</li>
<li><a href="#org3d3dc08">Chapter 4. System Data Files and Information</a>
<ul>
<li><a href="#org272c38d">4.1 Introduction</a></li>
<li><a href="#orgd635a70">4.2 <code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</a></li>
<li><a href="#orgbeb8e43">4.3 File Types</a></li>
<li><a href="#orgbfbdb60">4.4 Set-User-ID and Set-Group-ID</a></li>
<li><a href="#org7e52a2c">4.5 File Access Permissions</a></li>
<li><a href="#org400d365">4.6 Ownership of New Files and Directories</a></li>
<li><a href="#org6378708"><code>access</code> and <code>faccessat</code> Functions</a></li>
<li><a href="#org80263be"><code>umask</code> Function</a></li>
<li><a href="#org82907ac"><code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</a></li>
<li><a href="#orgcd6ad51">Sticky Bit</a></li>
<li><a href="#orgb7c4a88"><code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</a></li>
<li><a href="#orga940e0c">File Size</a></li>
<li><a href="#org4fad6cc">File Truncation</a></li>
<li><a href="#org8e6cf90">File Systems</a></li>
<li><a href="#orga185757"><code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</a></li>
<li><a href="#org12dfa80"><code>rename</code> and <code>renameat</code> Functions</a></li>
<li><a href="#org9e4bdc4">Symbolic Links</a></li>
<li><a href="#org77b051c">Creating and Reading Symbolic Links</a></li>
<li><a href="#org9d834ae">File Times</a></li>
<li><a href="#orgc2342f4"><code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</a></li>
<li><a href="#orgdc23d5d"><code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</a></li>
<li><a href="#org0052b4c">Reading Directories</a></li>
<li><a href="#org06219a7"><code>chidr</code>, <code>fchdir</code> and <code>getcwd</code> Functions</a></li>
<li><a href="#orgf38548d">Device Special Files</a></li>
<li><a href="#org4d6ddf8">Summary of File Access Permission Bits</a></li>
<li><a href="#orgc9aa5d6">Summary</a></li>
</ul>
</li>
<li><a href="#org8fce3b1">Chapter 5. Standard I/O Library</a>
<ul>
<li><a href="#orge0f2c3e">Introduction</a></li>
<li><a href="#org2f5299d">Streams and FILE Objects</a></li>
<li><a href="#orgb45376a">Standard Input, Standard Output and Standard Error</a></li>
<li><a href="#org4d9a214">Buffering</a></li>
<li><a href="#org4d28ebe">Opening a Stream</a></li>
<li><a href="#org9cd999a">Reading and Writing a Stream</a>
<ul>
<li><a href="#org01e5a4a">Input Functions</a></li>
<li><a href="#org22a7e22">Output Functions</a></li>
</ul>
</li>
<li><a href="#org2528678">Line-at-a-Time I/O</a></li>
<li><a href="#org44c0d44">Standard I/O Efficiency</a></li>
<li><a href="#orgc958ee0">Binary I/O</a></li>
<li><a href="#orgaee2e9c">Positioning a Stream</a></li>
<li><a href="#orgc7f391f">Formated I/O</a></li>
<li><a href="#orge52b186">Implementation Details</a></li>
<li><a href="#org5209d6f">Temporary Files</a></li>
<li><a href="#org232e0a7">Memory Streams</a></li>
<li><a href="#org11f9c68">Alternatives to Standard I/O</a></li>
<li><a href="#org8f47052">Summary</a></li>
</ul>
</li>
<li><a href="#orgdd6e18a">Chapter 6. System Data Files and Information</a>
<ul>
<li><a href="#org59b6597">introduction</a></li>
<li><a href="#org943e919">Password File</a></li>
<li><a href="#org624cbe8">Shadow Passwords</a></li>
<li><a href="#orgfaaa119">Group File</a></li>
<li><a href="#orgf3593c2">Supplementary Group Ids</a></li>
<li><a href="#orgef23769">Implementation Differences</a></li>
<li><a href="#orgec986a3">Other Data Files</a></li>
<li><a href="#orgb748468">Login Accounting</a></li>
<li><a href="#org8eec094">System Identification</a></li>
<li><a href="#orge300752">Time and Date Routines</a></li>
<li><a href="#org72ce8c8">Summary</a></li>
</ul>
</li>
<li><a href="#orgadff71e">Chapter 7. Process Environment</a>
<ul>
<li><a href="#org798133d">7.1 Introduction</a></li>
<li><a href="#orgf750182">7.2 main Function</a></li>
<li><a href="#orgf9df433">7.3 Process Termination</a>
<ul>
<li><a href="#orgcdad77c">Exit Functions</a></li>
<li><a href="#org8a5530a"><code>atexit</code> Function</a></li>
<li><a href="#org884a376">Commond-Line Arguments</a></li>
</ul>
</li>
<li><a href="#org6ec376e">7.5 Environment List</a></li>
<li><a href="#orge17ecbf">7.6 Memory Layout of a C Program</a></li>
<li><a href="#orga82270c">7.7 Shared Libraries</a></li>
<li><a href="#org4151cfa">7.8 Memory Allocation</a></li>
<li><a href="#org4674ca4">7.9 Environment Variable</a></li>
<li><a href="#orgd5f0654">7.10 <code>setjmp</code> and <code>longjmp</code> Functions</a></li>
<li><a href="#org37fe4b9"><code>getrlimit</code> and <code>setrlimit</code> Functions</a></li>
<li><a href="#orgb25e653">Summary</a></li>
</ul>
</li>
<li><a href="#orgc337870">Chapter 8. Process Control</a>
<ul>
<li><a href="#orgf4edc82">8.1 Introduction</a></li>
<li><a href="#orge83b954">8.2 Process Identifiers</a></li>
<li><a href="#orgc4e8d37">8.3 <code>fork</code> Function</a></li>
<li><a href="#orgd57f63c">8.4 <code>vfork</code> Function</a></li>
<li><a href="#org6439324">8.5 <code>exit</code> Function</a></li>
<li><a href="#org520f797">8.6 <code>wait</code> and <code>waitpid</code> Functions</a></li>
<li><a href="#orgaf5b2b9">8.7 <code>waitid</code> Function</a></li>
<li><a href="#org8dd3bc2">8.8 <code>wait3</code> and <code>wait4</code> Functions</a></li>
<li><a href="#orgbcdf09b">8.9 Race Conditions</a></li>
<li><a href="#org4d97b4e">8.10 <code>exec</code> Functions</a></li>
<li><a href="#org29699e8">8.11 Changing User IDs and Group IDs</a></li>
<li><a href="#orgf71d612">8.12 Interpreter Files</a></li>
<li><a href="#org4fa1292">8.13 <code>system</code> Function</a></li>
<li><a href="#org678b921">8.14 Process Accounting</a></li>
<li><a href="#orgfb36aaa">8.15 User Identification</a></li>
<li><a href="#orge84fbff">8.16 Process Scheduling</a></li>
<li><a href="#org6d5be1f">8.17 Process Times</a></li>
<li><a href="#orge694c1b">8.18 Summary</a></li>
</ul>
</li>
<li><a href="#orgf54368b">Chapter 9. Process Relationships</a>
<ul>
<li><a href="#orgb5df351">9.1 Introduction</a></li>
<li><a href="#orgd73d9e8">9.2 Terminal Logins</a></li>
<li><a href="#org716a08f">9.3 Network Logins</a></li>
<li><a href="#org747ac91">9.4 Process Groups</a></li>
<li><a href="#org2e657aa">9.5 Sessions</a></li>
<li><a href="#orgc2a5a39">9.6 Controlling Terminal</a></li>
<li><a href="#org3ac1e1f">9.7 <code>tcgetpgrp</code>, <code>tcsetpgrp</code>, and <code>tcgetsid</code> Functions</a></li>
<li><a href="#org26bed99">9.8 Job Control</a></li>
<li><a href="#orga1a558a">9.9 Shell Execution Programs</a></li>
<li><a href="#orgf35ba5e">9.10 Orphaned Process Groups</a></li>
<li><a href="#org761be25">9.11 FreeBSD Implementation</a></li>
<li><a href="#org153944d">9.12 Summary</a></li>
</ul>
</li>
<li><a href="#orge781e35">Chapter 10. Signals</a>
<ul>
<li><a href="#org95bf58f">10.1 Introduction</a></li>
<li><a href="#org955d748">10.2 Signal Concepts</a></li>
<li><a href="#orgcc911c3">10.3 <code>signal</code> Function</a></li>
<li><a href="#org1511183">10.4 Unreliable Signals</a></li>
<li><a href="#org9baca49">10.5 Interrupted System Calls</a></li>
<li><a href="#org8ab10ab">10.6 Reentrant Functions</a></li>
<li><a href="#orga0968b6">10.7 <code>SIGCLD</code> Semantics</a></li>
<li><a href="#org73ca052">10.8 Reliable-Signal Terminology and Semantics</a></li>
<li><a href="#orgb089a05">10.9 <code>kill</code> and <code>raise</code> Functions</a></li>
<li><a href="#org5488547">10.10 <code>alarm</code> and <code>pause</code> Functions</a></li>
<li><a href="#orgf0e7ab2">10.11 Signal Sets</a></li>
<li><a href="#org1d153ca">10.12 <code>sigprocmask</code> Function</a></li>
<li><a href="#org305e71e">10.13 <code>sigpending</code> Function</a></li>
<li><a href="#org1ff8492">10.14 <code>sigaction</code> Function</a></li>
<li><a href="#org51a2479">10.15 <code>sigsetjmp</code> and <code>siglongjmp</code> Functions</a></li>
<li><a href="#orga27f497">10.16 <code>sigsuspend</code> Function</a></li>
<li><a href="#org2ce66d5">10.17 <code>abort</code> Function</a></li>
<li><a href="#orgb641332">10.18 <code>system</code> Function</a></li>
<li><a href="#org29630d4">10.19 <code>sleep</code>, <code>nanaosleep</code>, and <code>clock_nanosleep</code> Functions</a></li>
<li><a href="#org022e56e">10.20 <code>sigqueue</code> Function</a></li>
<li><a href="#orge349563">10.21 Job-Control Signals</a></li>
<li><a href="#org00b12f3">10.22 Signal Names and Numbers</a></li>
<li><a href="#org08abb99">10.23 Summary</a></li>
</ul>
</li>
<li><a href="#org63085c3">Chapter 11. Threads</a>
<ul>
<li><a href="#org2beece4">11.1 Introduction</a></li>
<li><a href="#org5677c79">11.2 Thread Concepts</a></li>
<li><a href="#orgeaf402c">11.3 Thread Identification</a></li>
<li><a href="#org397db34">11.4 Thread Creation</a></li>
<li><a href="#org4631690">11.5 Thread Termination</a></li>
<li><a href="#orgcac9643">11.6 Thread Synchronization</a></li>
</ul>
</li>
<li><a href="#org989d3c5">Chapter 12. Thread Control</a></li>
<li><a href="#orgba07661">Chapter 13. Daemon Processes</a></li>
<li><a href="#org110e165">Chapter 14. Advanced I/O</a>
<ul>
<li><a href="#orgbccc922">14.1 Introduction</a></li>
<li><a href="#orgd01eb66">14.2 Nonblocking I/O</a></li>
<li><a href="#org33d3214">14.3 Recording Locking</a>
<ul>
<li><a href="#org31fa03f">1. History</a></li>
<li><a href="#orgb61a614">2. <code>fcntl</code> Record Locking</a></li>
</ul>
</li>
<li><a href="#org03859e4">14.4 I/O Multiplexing</a>
<ul>
<li><a href="#org0e2b69b">14.4.1 <code>select</code> and <code>pselect</code> Functions</a></li>
<li><a href="#orgd3e1d00">14.4.2 <code>poll</code> Function</a></li>
</ul>
</li>
<li><a href="#orga981457">14.5 Asynchronous I/O</a>
<ul>
<li><a href="#org0ad161d">14.5.1 System V Asynchronous I/O</a></li>
<li><a href="#org161cd2c">14.5.2 BSD Asynchronous I/O</a></li>
<li><a href="#org2110e06">14.5.3 POSIX Asynchronous I/O</a></li>
</ul>
</li>
<li><a href="#org6b82ad4">14.6 <code>readv</code> and <code>writev</code> Functions</a></li>
<li><a href="#org3dd0a34">14.7 <code>readn</code> and <code>writen</code> Functions</a></li>
<li><a href="#orgc99b603">14.8 Memory-Mapped I/O</a></li>
<li><a href="#orgf457601">14.9 Summary</a></li>
</ul>
</li>
<li><a href="#org00237c1">Chapter 15. Interprocess Communication</a>
<ul>
<li><a href="#org1223d19">15.1 Introduction</a></li>
<li><a href="#org37693e5">15.2 Pipes</a></li>
<li><a href="#org521fb4e">15.3 <code>popen</code> and <code>pclose</code> Functions</a></li>
<li><a href="#orgf86c387">15.4 Coprocesses</a></li>
<li><a href="#orga9f5767">15.5 FIFOs</a></li>
<li><a href="#org118149f">15.6 XSI IPC</a></li>
<li><a href="#org083a2e5">15.6.1 Identifiers and Keys</a></li>
<li><a href="#org4ec6315">15.6.2 Permission Structure</a></li>
<li><a href="#org3dec06d">15.6.3 Configuration Limits</a></li>
<li><a href="#org760ee7c">15.6.4 Advantages and Disadvantages</a></li>
<li><a href="#orgc6e03dd">15.7 Message Queues</a></li>
<li><a href="#org196ed1f">15.8 Semaphores</a></li>
<li><a href="#orgf48d20e">15.9 Shared Memory</a></li>
<li><a href="#orgf5c6e84">15.10 POSIX Semaphores</a></li>
<li><a href="#orgcf02025">15.11 Client-Server Properties</a></li>
<li><a href="#orgcfff336">15.12 Summary</a></li>
</ul>
</li>
<li><a href="#org8dba0ee">Chapter 16. Network IPC: Sockets</a>
<ul>
<li><a href="#orga495a0d">16.1 Introduction</a></li>
<li><a href="#org01b8de9">16.2 Socket Descriptors</a></li>
<li><a href="#org79814fc">16.3 Addressing</a>
<ul>
<li><a href="#org6637645">16.3.1 Byte Ordering</a></li>
<li><a href="#org7ea9c3e">16.3.2 Address Formats</a></li>
<li><a href="#org5127ac7">16.3.3 Address Lookup</a></li>
<li><a href="#orgbe8dcd6">16.3.4 Associating Addresses with Sockets</a></li>
</ul>
</li>
<li><a href="#orgeea3e3a">16.4 Connection Establishment</a></li>
<li><a href="#org40bc859">16.5 Data Transfer</a></li>
<li><a href="#org1b0a2d1">16.6 Socket Options</a></li>
<li><a href="#org4150ad5">16.7 Out-of-Band Data</a></li>
<li><a href="#org4dfac22">16.8 Nonblocking and Asynchronous I/O</a></li>
<li><a href="#orgc029c4a">16.9 Summary</a></li>
</ul>
</li>
<li><a href="#org68cf1ac">Chapter 17. Advanced IPC</a>
<ul>
<li><a href="#org6927740">17.1 Introduction</a></li>
<li><a href="#org279455d">17.2 UNIX Domain Sockets</a>
<ul>
<li><a href="#orgecb93ff">17.2.1 Naming UNIX Domain Sockets</a></li>
</ul>
</li>
<li><a href="#org9872d72">17.3 Unique Connections</a></li>
<li><a href="#org720ecfb">17.4 Passing File Descriptors</a></li>
<li><a href="#orga886b95">17.5 An Open Server, Version 1</a></li>
<li><a href="#orged19e0b">17.6 An Open Server, Version 2</a></li>
<li><a href="#org6f29ddd">17.7 Summary</a></li>
</ul>
</li>
<li><a href="#org681bc74">Chapter 18. Terminal I/O</a></li>
<li><a href="#orgc54714b">Chapter 19. Pseudo Terminals</a></li>
<li><a href="#org91b1ad0">Chapter 20. A Database Library</a></li>
<li><a href="#orgc681a41">Chapter 21. Communication with a Network Printer</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgd4cdb7a" class="outline-2">
<h2 id="orgd4cdb7a">Chapter 1. UNIX System Overview</h2>
<div class="outline-text-2" id="text-orgd4cdb7a">
</div>
<div id="outline-container-orgca72c56" class="outline-3">
<h3 id="orgca72c56">Introduction</h3>
</div>
<div id="outline-container-org997196b" class="outline-3">
<h3 id="org997196b">UNIX Architecture</h3>
</div>
<div id="outline-container-org7f0626a" class="outline-3">
<h3 id="org7f0626a">Logging in</h3>
<div class="outline-text-3" id="text-org7f0626a">
<ul class="org-ul">
<li>Login Name</li>
</ul>
</div>
</div>
<div id="outline-container-orgef66300" class="outline-3">
<h3 id="orgef66300">Files and Directories</h3>
<div class="outline-text-3" id="text-orgef66300">
<ul class="org-ul">
<li>File System</li>
<li>Pathname
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<pre class="src src-C" id="org89bb40a"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">dirent.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">DIR</span> *<span style="color: #715ab1;">dp</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">dirent</span> *<span style="color: #715ab1;">dirp</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc != <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ls directory_name"</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>dp = opendir<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #4e3163;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>dirp = readdir<span style="color: #67b11d;">(</span>dp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, dirp-&gt;d_name<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  closedir<span style="color: #6c3163;">(</span>dp<span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org9d6d5b8" class="outline-3">
<h3 id="org9d6d5b8">Input and Output</h3>
<div class="outline-text-3" id="text-org9d6d5b8">
<ul class="org-ul">
<li>File Descriptors</li>
<li>Standard Input, Standard Output, and Standard Error</li>
<li>Unbuffered I/O
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Figure 1.4 Copy standard input to standard output</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">BUFFSIZE</span> <span style="color: #4e3163;">4096</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #715ab1;">n</span> = <span style="color: #4e3163;">0</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>BUFFSIZE<span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, buf, BUFFSIZE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>STDOUT_FILENO, buf, n<span style="color: #67b11d;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>n &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul></li>

<li>Standard I/O
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Figure 1.5 Copy standard input to standard output, using standard I/O</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">c</span>;
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>c = getc<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != EOF<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>putc<span style="color: #67b11d;">(</span>c, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"input error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgde0bde2" class="outline-3">
<h3 id="orgde0bde2">Programs and Processes</h3>
<div class="outline-text-3" id="text-orgde0bde2">
<ul class="org-ul">
<li>Program</li>
<li>Proceses and Process ID
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>Figure 1.6 Print the process ID</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"uid = %d, gid = %d\n"</span>, getuid<span style="color: #2d9574;">()</span>, getgid<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul></li>
<li>Process Control
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Figure 1.7 Read commands from standard input and execute them</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span>  <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>MAXLINE<span style="color: #6c3163;">]</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">from apue.h */</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">status</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">print prompt (printf require %% to print %) */</span>

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span> == <span style="color: #2d9574;">'\n'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span> = <span style="color: #4e3163;">0</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">replace newline with null */</span>
    <span style="color: #2d9574;">}</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      execlp<span style="color: #67b11d;">(</span>buf, buf, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span>;
      err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"coulnd't excute: %s"</span>, buf<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent */</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = waitpid<span style="color: #b1951d;">(</span>pid, &amp;status, <span style="color: #4e3163;">0</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org4592874" class="outline-3">
<h3 id="org4592874">Error Handling</h3>
<div class="outline-text-3" id="text-org4592874">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Figure 1.8 Demonstrate strerror and perror</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  fprintf<span style="color: #6c3163;">(</span>stderr, <span style="color: #2d9574;">"EACCESS: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>EACCES<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  errno = ENOENT;
  perror<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org3d90d7c" class="outline-3">
<h3 id="org3d90d7c">User identification</h3>
<div class="outline-text-3" id="text-org3d90d7c">
<ul class="org-ul">
<li>User ID</li>
<li>Group ID
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>Figure 1.9 Print user ID and group ID</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"uid = %d, gid = %d\n"</span>, getuid<span style="color: #2d9574;">()</span>, getgid<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul></li>
<li>Supplementary Group IDs</li>
</ul>
</div>
</div>
<div id="outline-container-org994bc6d" class="outline-3">
<h3 id="org994bc6d">Signals</h3>
<div class="outline-text-3" id="text-org994bc6d">
<p>
Process choices:
</p>
<ol class="org-ol">
<li>Ignore</li>
<li>default action</li>
<li>provide call function (catch signal)</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>Figure 1.10 Read commands from standard input and execute them</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_int</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">our signal-catching function */</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span>  <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>MAXLINE<span style="color: #6c3163;">]</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">from apue.h */</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">status</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal error"</span><span style="color: #6c3163;">)</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">print prompt (printf requires %% to print %) */</span>
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span> == <span style="color: #2d9574;">'\n'</span><span style="color: #2d9574;">)</span>
      buf<span style="color: #2d9574;">[</span>strlen<span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span> - <span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span> = <span style="color: #4e3163;">0</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">replace newline with null */</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      execlp<span style="color: #67b11d;">(</span>buf, buf, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span>;
      err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"couldn't execute: %s"</span>, buf<span style="color: #67b11d;">)</span>;
      exit<span style="color: #67b11d;">(</span><span style="color: #4e3163;">127</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span>
<span style="color: #6c3163; font-weight: bold;">sig_int</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"interrupt\n%% "</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orge64f4b7" class="outline-3">
<h3 id="orge64f4b7">Time Values</h3>
<div class="outline-text-3" id="text-orge64f4b7">
<ol class="org-ol">
<li>Calendar time.</li>
<li>Process time.
<ul class="org-ul">
<li>Clock time</li>
<li>User CPU time</li>
<li>System CPU time</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-org740d0b6" class="outline-3">
<h3 id="org740d0b6">System calls and Library Functions</h3>
<div class="outline-text-3" id="text-org740d0b6">
<ul class="org-ul">
<li>Concepts:
<ul class="org-ul">
<li>System calls: <br />
<ul class="org-ul">
<li>Can be learned with <code>man 2</code> (Section 2 of <i>Unix Programmer's Mannual</i>)</li>
</ul></li>
<li>Library Functions:
<ul class="org-ul">
<li>Can be learned with <code>man 3</code> for <b>general-purpose</b> (Section 3 of <i>Unix Programmer's Mannual</i>)</li>
<li>These functions aren’t entry points into the kernel, although they may invoke one or more of the kernel’s system calls</li>
</ul></li>
</ul></li>
<li>Distinction:
<ul class="org-ul">
<li>the system calls usually cannot be replaced</li>
<li>UNIX System provides to determine the current time and date</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org4aa463b" class="outline-3">
<h3 id="org4aa463b">Summary</h3>
<div class="outline-text-3" id="text-org4aa463b">
<p>
<b>Exercises</b>
</p>
<ol class="org-ol">
<li></li>

<li>53268 50922 was occupied</li>
<li>strerror: int, value transfer, cannnot be changed, global errno cannnot be forecast
perror: pointer, can be changed the value point to, const set constant</li>
<li>2038, 2<sup>31</sup>/(60*60*24*365)+1970
change time_t to u_64_t
recompile the program</li>
<li>2<sup>31</sup>/(60*60*24*100)=248.551348 days</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org52727c8" class="outline-2">
<h2 id="org52727c8">Chapter 2. UNIX Standardization and Implementations</h2>
<div class="outline-text-2" id="text-org52727c8">
</div>
<div id="outline-container-org5bd6750" class="outline-3">
<h3 id="org5bd6750">Introduction</h3>
</div>
<div id="outline-container-org5118233" class="outline-3">
<h3 id="org5118233">UNIX Standardization</h3>
<div class="outline-text-3" id="text-org5118233">
</div>
<div id="outline-container-org341c6fd" class="outline-4">
<h4 id="org341c6fd">ISO C</h4>
</div>
<div id="outline-container-orgeb635ac" class="outline-4">
<h4 id="orgeb635ac">IEEE POSIX</h4>
</div>
<div id="outline-container-orgca5ee93" class="outline-4">
<h4 id="orgca5ee93">The Single UNIX Specification</h4>
<div class="outline-text-4" id="text-orgca5ee93">
<ul class="org-ul">
<li>Encryption: denoted by <code>_XOPEN_CRYPE</code></li>
<li>Real-time: denoted by <code>_XOPEN_REALTIME</code></li>
<li>Advanced real-time</li>
<li>Real-time threads: denoted by <code>_XOPEN_REALTIME_THREADS</code></li>
<li>Advanced real-time threads</li>
</ul>
</div>
</div>
<div id="outline-container-org2a75d7f" class="outline-4">
<h4 id="org2a75d7f">FIPS</h4>
</div>
</div>
<div id="outline-container-orgd87c12c" class="outline-3">
<h3 id="orgd87c12c">UNIX System Implementations</h3>
<div class="outline-text-3" id="text-orgd87c12c">
</div>
<div id="outline-container-orgf161816" class="outline-4">
<h4 id="orgf161816">SVR4</h4>
</div>
<div id="outline-container-org5f64633" class="outline-4">
<h4 id="org5f64633">4.4BSD</h4>
</div>
<div id="outline-container-org99376d7" class="outline-4">
<h4 id="org99376d7">FreeBSD</h4>
</div>
<div id="outline-container-org4dbb3d7" class="outline-4">
<h4 id="org4dbb3d7">Linux</h4>
</div>
<div id="outline-container-org042729a" class="outline-4">
<h4 id="org042729a">Mac OS X</h4>
</div>
<div id="outline-container-orgd5de41d" class="outline-4">
<h4 id="orgd5de41d">SOlaris</h4>
</div>
<div id="outline-container-org2c1ca04" class="outline-4">
<h4 id="org2c1ca04">Others</h4>
<div class="outline-text-4" id="text-org2c1ca04">
<ul class="org-ul">
<li>AIX, IBMUNIX</li>
<li>HP-UX, HP</li>
<li>IRIX, Silicon Graphics</li>
<li>Unix Ware, SVR4 distribution</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5fa6a37" class="outline-3">
<h3 id="org5fa6a37">Relationship of Standards and Implementations</h3>
</div>
<div id="outline-container-org4acd428" class="outline-3">
<h3 id="org4acd428">Limits</h3>
<div class="outline-text-3" id="text-org4acd428">
<ol class="org-ol">
<li>Comipile-time limits</li>
<li>Runtime limits</li>
</ol>
</div>
<div id="outline-container-orgede736c" class="outline-4">
<h4 id="orgede736c">ISO C Limits</h4>
</div>
<div id="outline-container-org1279007" class="outline-4">
<h4 id="org1279007">POSIX Limits</h4>
<div class="outline-text-4" id="text-org1279007">
<ol class="org-ol">
<li>Numerical limits: <code>LONG_BIT</code>, <code>SSIZE_MAX</code>, and <code>WORD_BIT</code></li>
<li>Minimum value：</li>
<li>Maximum value: <code>_POSIX_CLOCKRES_MIN</code></li>
<li>Runtime increasable values: <code>CHARCLASS_NAME_MAX</code>, <code>COLL_WEIGHTS_MAX</code>, <code>LINE_MAX</code>, <code>NGROUPS_MAX</code>, and <code>RE_DUP_MAX</code></li>
<li>Runtime invariant values;</li>
<li>Other invariant values: <code>NL_ARGMAX</code>, <code>NL_MSGMAX</code>, <code>NL_SETMAX</code>, and <code>NL_TEXTMAX</code>;</li>
<li>Pathname variables values: <code>FIFLESIZEBITS</code>, <code>LINK_MAX</code>, <code>MAX_CANON</code>, <code>MAX_INPUT</code>, <code>NAME_MAX</code>, <code>PATH_MAX</code>, <code>PIPE_BUF</code>, and <code>SYMLINK_MAX</code></li>
</ol>
</div>
</div>
<div id="outline-container-orgfb35739" class="outline-4">
<h4 id="orgfb35739">XSI Limits</h4>
<div class="outline-text-4" id="text-orgfb35739">
<ol class="org-ol">
<li>Minimum values:</li>
<li>Runtime invariant values, possibly indeterminate: <b>IOV_MAX</b> and <b>PAGE_SIZE</b></li>
</ol>
</div>
</div>
<div id="outline-container-org6ad9586" class="outline-4">
<h4 id="org6ad9586"><code>sysconf</code>, <code>pathconf</code>, and <code>fpathconf</code> Functions</h4>
<div class="outline-text-4" id="text-org6ad9586">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>Figure 2.13 Build C program to print all supported configuration limits</label><pre class="src src-c">#<span style="color: #4e3163;">!</span>/usr/bin/awk -f

BEGIN   <span style="color: #3a81c3;">{</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"#include \"apue.h\"\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"#include &lt;errno.h&gt;\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"#include &lt;limits.h&gt;\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"static void pr_sysconf(char *, int);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"static void pr_pathconf(char *, char *, int);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"int\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"main(int argc, char *argv[])\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\tif (argc != 2)\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\terr_quit(\"usage: a.out &lt;dirname&gt;\");\n\n"</span><span style="color: #6c3163;">)</span>
    FS=<span style="color: #2d9574;">"\t+"</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>getline &lt;<span style="color: #2d9574;">"sysconf.sym"</span> &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"%s defined to be %%ld\\n\", (long)%s+0);\n"</span>, $1, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tpr_sysconf(\"%s =\", %s);\n"</span>, $1, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">}</span>
    close<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"sysconf.sym"</span><span style="color: #6c3163;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>getline &lt;<span style="color: #2d9574;">"pathconf.sym"</span> &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"%s defined to be %%ld\\n\", (long)%s+0);\n"</span>, $1, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tpr_pathconf(\"%s =\", argv[1], %s);\n"</span>, $1, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
    <span style="color: #6c3163;">}</span>
    close<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pathconf.sym"</span><span style="color: #6c3163;">)</span>
    exit
<span style="color: #3a81c3;">}</span>
END <span style="color: #3a81c3;">{</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\texit(0);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"}\n\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"static void\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pr_sysconf(char *mesg, int name)\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\tlong  val;\n\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\tfputs(mesg, stdout);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\terrno = 0;\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\tif ((val = sysconf(name)) &lt; 0) {\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\tif (errno != 0) {\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\tif (errno == EINVAL)\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\t\tfputs(\" (not supported)\\n\", stdout);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\telse\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\t\terr_sys(\"sysconf error\");\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t} else {\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\tfputs(\" (no limit)\\n\", stdout);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t}\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t} else {\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\tprintf(\" %%ld\\n\", val);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t}\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"}\n\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"static void\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pr_pathconf(char *mesg, char *path, int name)\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\tlong val;\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\tfputs(mesg, stdout);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\terrno = 0;\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\tif ((val = pathconf(path, name)) &lt; 0) {\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\tif (errno != 0) {\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\tif (errno == EINVAL)\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\t\tfputs(\" (not supported)\\n\", stdout);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\telse\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\t\terr_sys(\"pathconf error, path = %%s\", path);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t} else {\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t\tfputs(\" (no limit)\\n\", stdout);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\t}\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t} else {\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t\tprintf(\" %%ld\\n\", val);\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\t}\n"</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"}\n"</span><span style="color: #6c3163;">)</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6a7916a" class="outline-4">
<h4 id="org6a7916a">Indeterminate Runtime Limits</h4>
<div class="outline-text-4" id="text-org6a7916a">
<ol class="org-ol">
<li>#+caption: pathalloc</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#ifdef</span>  PATH_MAX
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">pathmax</span> = PATH_MAX;
<span style="color: #6c3163;">#else</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">pathmax</span> = <span style="color: #4e3163;">0</span>;
<span style="color: #6c3163;">#endif</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">posix_version</span> = <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">xsi_version</span> = <span style="color: #4e3163;">0</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">If PATH_MAX is indeterminate, no guarantee this is adequate */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">PATH_MAX_GUESS</span>  <span style="color: #4e3163;">1024</span>

<span style="color: #ba2f59; font-weight: bold;">char</span> *
<span style="color: #6c3163; font-weight: bold;">path_alloc</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">size_t</span> *<span style="color: #715ab1;">sizep</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">also return allocated size, if nonnull */</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span>  *<span style="color: #715ab1;">ptr</span>;
  <span style="color: #ba2f59; font-weight: bold;">size_t</span>  <span style="color: #715ab1;">size</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>posix_version == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    posix_version = sysconf<span style="color: #6c3163;">(</span>_SC_VERSION<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>xsi_version == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    xsi_version = sysconf<span style="color: #6c3163;">(</span>_SC_XOPEN_VERSION<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pathmax == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>   <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">first time through */</span>
    errno = <span style="color: #4e3163;">0</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pathmax = pathconf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"/"</span>, _PC_PATH_MAX<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span>
        pathmax = PATH_MAX_GUESS; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">it's indeterminate */</span>
      <span style="color: #3a81c3; font-weight: bold;">else</span>
        err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"pathconf error for _PC_PATH_MAX"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
      pathmax++;    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">add one since it's relative to root */</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   * Before POSIX.1-2001, we aren't guaranteed that PATH_MAX includes</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   * the terminating null byte.  Same goes for XPG3.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>posix_version &lt; <span style="color: #4e3163;">200112L</span><span style="color: #2d9574;">)</span> &amp;&amp; <span style="color: #2d9574;">(</span>xsi_version &lt; <span style="color: #4e3163;">4</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    size = pathmax + <span style="color: #4e3163;">1</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span>
    size = pathmax;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>ptr = malloc<span style="color: #67b11d;">(</span>size<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"malloc error for pathname"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sizep != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>
    *sizep = size;
  <span style="color: #3a81c3; font-weight: bold;">return</span><span style="color: #6c3163;">(</span>ptr<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>#+caption: openmax</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#ifdef</span>  OPEN_MAX
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">openmax</span> = OPEN_MAX;
<span style="color: #6c3163;">#else</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">openmax</span> = <span style="color: #4e3163;">0</span>;
<span style="color: #6c3163;">#endif</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * If OPEN_MAX is indeterminate, this might be inadequate.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">OPEN_MAX_GUESS</span>  <span style="color: #4e3163;">256</span>

<span style="color: #ba2f59; font-weight: bold;">long</span>
<span style="color: #6c3163; font-weight: bold;">open_max</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>openmax == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>   <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">first time through */</span>
    errno = <span style="color: #4e3163;">0</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>openmax = sysconf<span style="color: #b1951d;">(</span>_SC_OPEN_MAX<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span>
        openmax = OPEN_MAX_GUESS; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">it's indeterminate */</span>
      <span style="color: #3a81c3; font-weight: bold;">else</span>
        err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"sysconf error for _SC_OPEN_MAX"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span><span style="color: #6c3163;">(</span>openmax<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb5d0494" class="outline-3">
<h3 id="orgb5d0494">Options</h3>
<div class="outline-text-3" id="text-orgb5d0494">
<ol class="org-ol">
<li>Compile-time options are defined in <code>&lt;unistd.h&gt;</code></li>
<li>Runtime options are not associated with a file or a directory are idnetified with the <code>sysconf</code> function</li>
<li>Runtime options that are associated with a file or a directory are discovered by calling either the <code>pathconf</code> or the <code>fpathconf</code> function</li>
</ol>
</div>
</div>
<div id="outline-container-orgfad4533" class="outline-3">
<h3 id="orgfad4533">Features Test Macros</h3>
<div class="outline-text-3" id="text-orgfad4533">
<p>
<code>cc -D_POSIX_C_SOURCE=200809L code.c</code>
</p>
</div>
</div>
<div id="outline-container-org476fc37" class="outline-3">
<h3 id="org476fc37">Primitive System Data Types</h3>
<div class="outline-text-3" id="text-org476fc37">
<p>
The header <code>&lt;sys/types.h&gt;</code> defines some implementation-dependent data types, called the <i>primitive system data types</i>.
</p>
</div>
</div>
<div id="outline-container-orgeeff89a" class="outline-3">
<h3 id="orgeeff89a">Differences Between Standards</h3>
</div>
<div id="outline-container-org8fff5e3" class="outline-3">
<h3 id="org8fff5e3">Summary</h3>
<div class="outline-text-3" id="text-org8fff5e3">
<p>
<b>Exercises</b>
</p>
<ol class="org-ol">
<li>#ifndef &#x2026; #define &#x2026; #endif</li>
<li><code>u_long, ushort, uint, u_quad_t, quad_t, qaddr_t, daddr_t, fixpt_t</code></li>
<li>#+caption: OPEN_MAX exercise</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">OPEN_MAX_GUESS</span> <span style="color: #4e3163;">256</span>

<span style="color: #ba2f59; font-weight: bold;">long</span>
<span style="color: #6c3163; font-weight: bold;">open_max</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">long</span>          <span style="color: #715ab1;">openmax</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">rlimit</span> <span style="color: #715ab1;">rl</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>openmax = sysconf<span style="color: #67b11d;">(</span>_SC_OPEN_MAX<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span> || openmax == LONG_MAX<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>getrlimit<span style="color: #67b11d;">(</span>RLIMIT_NOFILE, &amp;rl<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"can&#8242;t get file limit"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>rl.rlim_max == RLIM_INFINITY<span style="color: #2d9574;">)</span>
      openmax = OPEN_MAX_GUESS;
    <span style="color: #3a81c3; font-weight: bold;">else</span>
      openmax = rl.rlim_max;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>openmax<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span>
<span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%ld\n"</span>, open_max<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc0e0846" class="outline-2">
<h2 id="orgc0e0846">Chapter 3. File I/O</h2>
<div class="outline-text-2" id="text-orgc0e0846">
</div>
<div id="outline-container-org882b4f2" class="outline-3">
<h3 id="org882b4f2">Introduction</h3>
</div>
<div id="outline-container-orgf012769" class="outline-3">
<h3 id="orgf012769">File Descriptors</h3>
<div class="outline-text-3" id="text-orgf012769">
<p>
To the kernel, all open file are referred to by file descriptors.
</p>
<ul class="org-ul">
<li>0: stdin</li>
<li>1: stdout</li>
<li>2: stderr</li>
</ul>
</div>
</div>
<div id="outline-container-org8c25169" class="outline-3">
<h3 id="org8c25169"><code>open</code> and <code>openat</code> Functions</h3>
<div class="outline-text-3" id="text-org8c25169">
<p>
<code>man 2 open</code>
</p>
</div>
</div>
<div id="outline-container-org520b30c" class="outline-3">
<h3 id="org520b30c"><code>creat</code> Function</h3>
<div class="outline-text-3" id="text-org520b30c">
<p>
<code>man 2 creat</code>
</p>
</div>
</div>
<div id="outline-container-org29990bb" class="outline-3">
<h3 id="org29990bb"><code>close</code> Function</h3>
<div class="outline-text-3" id="text-org29990bb">
<p>
<code>man 2 close</code>
</p>
</div>
</div>
<div id="outline-container-org208e136" class="outline-3">
<h3 id="org208e136"><code>lseek</code> Function</h3>
<div class="outline-text-3" id="text-org208e136">
<p>
<code>man 2 lseek</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>Figure 3.1 Test whether standard input is capable of seeking</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>lseek<span style="color: #2d9574;">(</span>STDIN_FILENO, <span style="color: #4e3163;">0</span>, SEEK_CUR<span style="color: #2d9574;">)</span> == -<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"seek OK\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>Figure 3.2 Create a file with a hole in it</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf1</span><span style="color: #3a81c3;">[]</span> = <span style="color: #2d9574;">"abcdefghij"</span>;
<span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf2</span><span style="color: #3a81c3;">[]</span> = <span style="color: #2d9574;">"ABCDEFGHIJ"</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"file.hole"</span>, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>write<span style="color: #2d9574;">(</span>fd, buf1, <span style="color: #4e3163;">10</span><span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">10</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buf1 write error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>lseek<span style="color: #2d9574;">(</span>fd, <span style="color: #4e3163;">16384</span>, SEEK_SET<span style="color: #2d9574;">)</span> == -<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"lssek error: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>write<span style="color: #2d9574;">(</span>fd, buf2, <span style="color: #4e3163;">10</span><span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">10</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buf2 write error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdbdeeff" class="outline-3">
<h3 id="orgdbdeeff"><code>read</code> Function</h3>
<div class="outline-text-3" id="text-orgdbdeeff">
<p>
<code>man 2 read</code>
</p>
</div>
</div>
<div id="outline-container-orgf0d5fbd" class="outline-3">
<h3 id="orgf0d5fbd"><code>write</code> Function</h3>
<div class="outline-text-3" id="text-orgf0d5fbd">
<p>
<code>man 2 write</code>
</p>
</div>
</div>
<div id="outline-container-orgcc74a77" class="outline-3">
<h3 id="orgcc74a77">I/O Efficiency</h3>
<div class="outline-text-3" id="text-orgcc74a77">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>Figure 3.5 Copy standard input to standard output</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #715ab1;">n</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>BUFSIZ<span style="color: #6c3163;">]</span>;

  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">in</span>  = open<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>, O_RDONLY<span style="color: #6c3163;">)</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">out</span> = open<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">]</span>, O_CREAT | O_RDWR, <span style="color: #4e3163;">0644</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>in, buf, BUFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>out, buf, n<span style="color: #67b11d;">)</span> != n<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  close<span style="color: #6c3163;">(</span>in<span style="color: #6c3163;">)</span>;
  close<span style="color: #6c3163;">(</span>out<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>n &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfebebef" class="outline-3">
<h3 id="orgfebebef">File Sharing</h3>
<div class="outline-text-3" id="text-orgfebebef">
<ol class="org-ol">
<li>Every process has an entry in the process table.</li>
<li>The kernel maintains a file table for all open files.</li>
<li>Each open file(or device) has a v-node structure that contains information about the type of file <br />
and pointers to functions that operate on the file;</li>
</ol>
</div>
</div>
<div id="outline-container-orgc4d81d6" class="outline-3">
<h3 id="orgc4d81d6">Atomic Operations</h3>
<div class="outline-text-3" id="text-orgc4d81d6">
<ul class="org-ul">
<li>Appending to a File</li>
<li><code>pread</code> and <code>pwrite</code> Functions
Calling pread is equivalent to calling lseek followed by a call to read, with the following exceptions.
<ul class="org-ul">
<li>There is no way to interrupt the two operations that occur when we call pread.</li>
<li>The current file offset is not updated.</li>
</ul></li>

<li>Creating a File
<i>atomic operation</i> refers to an operation that might be composed of multiple steps</li>
</ul>
</div>
</div>
<div id="outline-container-org59fcf81" class="outline-3">
<h3 id="org59fcf81"><code>dup</code> and <code>dup2</code> Functions</h3>
<div class="outline-text-3" id="text-org59fcf81">
<p>
<code>man 2 dup</code>
</p>
<ul class="org-ul">
<li><code>dup(fd)</code> ~ =fcntl(fd, F_DUPFD, 0)~</li>
<li><code>dup2(fd, fd2)= = =close(fd2); fcntl(fd, F_DUPFD, fd2);</code> <br /></li>
</ul>
<p>
Differences:
</p>
<ul class="org-ul">
<li>dup2 is an atomic operation, whereas the alternate form involves two function calls.</li>
<li>errno differences</li>
</ul>
</div>
</div>
<div id="outline-container-org9d5d726" class="outline-3">
<h3 id="org9d5d726"><code>sync</code>, <code>fsync</code> and <code>fdatasync</code> Functions</h3>
<div class="outline-text-3" id="text-org9d5d726">
<p>
<code>man 2 sync</code>
</p>
</div>
</div>
<div id="outline-container-org9da05a8" class="outline-3">
<h3 id="org9da05a8"><code>fcntl</code> Function</h3>
<div class="outline-text-3" id="text-org9da05a8">
<p>
<code>man 2 fcntl</code>
The <code>fcntl</code> function is used for five different purposes.
</p>
<ol class="org-ol">
<li>Duplicate an existing descriptor (<i>cmd</i> = <code>F_DUPFD</code> or <code>F_DUPFD_CLOEXEC</code>)</li>
<li>Get/set file descriptor flags (<i>cmd</i> = <code>F_GETFD</code> or <code>F_SETFD</code>)</li>
<li>Get/set file status flags (<i>cmd</i> = <code>F_GETFL</code> or <code>F_SETFL</code>)</li>
<li>Get/set asynchronous I/O ownership (<i>cmd</i> = <code>F_GETOWN</code> or <code>F_SETOWN</code>)</li>
<li>Get/set record locks (<i>cmd</i> = <code>F_GETLK</code>, <code>F_SETLK</code>, or <code>F_SETLKW</code>)</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>Figure 3.11 Print file flags for specified descriptor</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">val</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc != <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;descriptor#"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>val = fcntl<span style="color: #67b11d;">(</span>atoi<span style="color: #b1951d;">(</span>argv<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">1</span><span style="color: #3a81c3;">]</span><span style="color: #b1951d;">)</span>, F_GETFL, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl error for  %d: %s"</span>, atoi<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #4e3163;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">switch</span> <span style="color: #6c3163;">(</span>val &amp; O_ACCMODE<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">case</span> O_RDONLY:
      printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read only"</span><span style="color: #2d9574;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #3a81c3; font-weight: bold;">case</span> O_WRONLY:
      printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write only"</span><span style="color: #2d9574;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #3a81c3; font-weight: bold;">case</span> O_RDWR:
      printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read write"</span><span style="color: #2d9574;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #3a81c3; font-weight: bold;">default</span>:
      err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown access mode"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>val &amp; O_APPEND<span style="color: #6c3163;">)</span> printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">", append"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>val &amp; O_NONBLOCK<span style="color: #6c3163;">)</span> printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">", nonblocking"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>val &amp; O_SYNC<span style="color: #6c3163;">)</span> printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">", synchronous writes"</span><span style="color: #6c3163;">)</span>;

<span style="color: #6c3163;">#if</span> <span style="color: #4e3163;">!</span><span style="color: #6c3163;">defined</span><span style="color: #6c3163;">(</span>_POSIX_C_SOURCE<span style="color: #6c3163;">)</span> &amp;&amp; <span style="color: #6c3163;">defined</span><span style="color: #6c3163;">(</span>O_FSYNC<span style="color: #6c3163;">)</span> &amp;&amp; <span style="color: #6c3163;">(</span>O_FSYNC != O_SYNC<span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>val &amp; O_FSYNC<span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">", synchronous writes"</span><span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>
  putchar<span style="color: #6c3163;">(</span><span style="color: #2d9574;">'\n'</span><span style="color: #6c3163;">)</span>;

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>Figure 3.12 Turn on one or more of the file status flags for a descriptor</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">void</span>
<span style="color: #6c3163; font-weight: bold;">set_fl</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">flags</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">flags are file status flags to turn on */</span>

<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">val</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>val = fcntl<span style="color: #67b11d;">(</span>fd, F_GETFL, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl F_GETFL: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  val |= flags; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">turn on flags */</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>fcntl<span style="color: #2d9574;">(</span>fd, F_SETFL, val<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl F_SETFL: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org581c7df" class="outline-3">
<h3 id="org581c7df"><code>ioctl</code> Function</h3>
<div class="outline-text-3" id="text-org581c7df">
<p>
<code>man 2 ioctl</code>
</p>
</div>
</div>
<div id="outline-container-org6c77d7d" class="outline-3">
<h3 id="org6c77d7d"><code>/dev/fd</code></h3>
</div>
<div id="outline-container-org4e4ffc9" class="outline-3">
<h3 id="org4e4ffc9">Summary</h3>
<div class="outline-text-3" id="text-org4e4ffc9">
<p>
<b>Exercises</b>
</p>
<ol class="org-ol">
<li>All disk I/O need to via buffer block. <br />
<code>read/write</code> always be buffered via kernel automatically, unbuffered only means user process;</li>
<li>#+caption: mydup2</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">my_dup2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd2</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>fd2 &gt; open_max<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   * use lseek to verify whether fd is valid</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>lseek<span style="color: #2d9574;">(</span>fd, <span style="color: #4e3163;">0</span>, SEEK_CUR<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span> &amp;&amp; errno == EBADF<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"file descriptor: %d is not valid, %m\n"</span>, fd<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return if fd2 is fd */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>fd == fd2<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> fd2;
  <span style="color: #6c3163;">}</span>

  close<span style="color: #6c3163;">(</span>fd2<span style="color: #6c3163;">)</span>;

  <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">i</span> = <span style="color: #4e3163;">0</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; open_max<span style="color: #2d9574;">()</span>; i++<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    i = dup<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>i == fd2<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">for (; i &gt; fd; i--) { */</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/*   </span><span style="color: #2aa1ae; background-color: #ecf3ec;">close(i); */</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">} */</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fd2<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc &lt; <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;string&gt;"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%ld\n"</span>, open_max<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span>;
  my_dup2<span style="color: #6c3163;">(</span>STDERR_FILENO, <span style="color: #4e3163;">5</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">i</span> = <span style="color: #4e3163;">1</span>; i &lt; argc; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    write<span style="color: #2d9574;">(</span><span style="color: #4e3163;">5</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, strlen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    write<span style="color: #2d9574;">(</span><span style="color: #4e3163;">5</span>, <span style="color: #2d9574;">"\n"</span>, <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  close<span style="color: #6c3163;">(</span><span style="color: #4e3163;">5</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>F_SETFD: affect fd1 <b>file descriptor</b> <br />
F_SETFL: affect fd1 and fd2 <b>file table</b></li>
<li>without <code>if (fd &gt; 2)</code>, there are 4 descriptors pointer to file, otherwise , there will be 3</li>
<li><code>./a.out &gt; outfile 2&gt;&amp;1</code>: stdout <code>&gt; outfile, stderr =&gt; stdout =&gt; outfile
      =./a.out 2&gt;&amp;1 &gt; outfile</code>: stderr =&gt; stdout, stdout =&gt; outfile <br /></li>
<li>#+caption: ex06</li>
</ol>
<div class="org-src-container">
<pre class="src src-c,">#include &lt;fcntl.h&gt;
#include "apue.h"

int
main(int argc, char *argv[argc])
{
  int  fd           = 0;
  int  ret          = 0;
  char buf[MAXLINE] = {0};

  fd = open("./a.txt", O_CREAT | O_RDWR | O_APPEND);
  if (fd &lt; 0) {
    err_sys("open: %s", strerror(errno));
  }

  ret = write(fd, "hello world", 11);
  if (ret &lt; 0) {
    err_sys("write: %s", strerror(errno));
  }

  ret = lseek(fd, 0, SEEK_SET);
  while ((ret = read(fd, buf, MAXLINE))) {
    ;
  }
  if (ret == -1) {
    err_sys("read: %s", strerror(errno));
  }
  printf("read: %s\n", buf);

  ret = lseek(fd, -18, SEEK_CUR);
  ret = write(fd, "hello world", 11);
  if (ret &lt; 0) {
    err_sys("write: %s", strerror(errno));
  }

  ret = lseek(fd, 0, SEEK_SET);
  while ((ret = read(fd, buf, MAXLINE)) &gt; 0) {
    ;
  }
  if (ret == -1) {
    err_sys("read: %s", strerror(errno));
  }
  printf("read: %s\n", buf);

  ret = lseek(fd, 10, SEEK_SET);
  while ((ret = read(fd, buf, MAXLINE)) &gt; 0) {
    ;
  }
  if (ret == -1) {
    err_sys("read: %s", strerror(errno));
  }
  printf("read: %s\n", buf);

  return 0;
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3d3dc08" class="outline-2">
<h2 id="org3d3dc08">Chapter 4. System Data Files and Information</h2>
<div class="outline-text-2" id="text-org3d3dc08">
</div>
<div id="outline-container-org272c38d" class="outline-3">
<h3 id="org272c38d">4.1 Introduction</h3>
</div>
<div id="outline-container-orgd635a70" class="outline-3">
<h3 id="orgd635a70">4.2 <code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</h3>
<div class="outline-text-3" id="text-orgd635a70">
<p>
<code>man 2 stat</code>
</p>
</div>
</div>
<div id="outline-container-orgbeb8e43" class="outline-3">
<h3 id="orgbeb8e43">4.3 File Types</h3>
<div class="outline-text-3" id="text-orgbeb8e43">
<ol class="org-ol">
<li>Regular file.
There is no distinction to the UNIX kernel whether this data is text or binary.</li>
<li>Directory file.</li>
<li>Block special file.</li>
<li>Character special file.
providing unbuffered I/O access.</li>
<li>FIFO.</li>
<li>Socket</li>
<li>Symbolic link.</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>Figure 4.3 Print type of file for each command-line argument</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>         <span style="color: #715ab1;">i</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> <span style="color: #715ab1;">buf</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> *      <span style="color: #715ab1;">ptr</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">1</span>; i &lt; argc; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lstat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISREG<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ptr = <span style="color: #2d9574;">"regular"</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISLNK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ptr = <span style="color: #2d9574;">"symbolic link"</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISSOCK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ptr = <span style="color: #2d9574;">"socket"</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ptr = <span style="color: #2d9574;">"block special"</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ptr = <span style="color: #2d9574;">"directory"</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ptr = <span style="color: #2d9574;">"character special"</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISFIFO<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ptr = <span style="color: #2d9574;">"named pipe(fifo)"</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
      ptr = <span style="color: #2d9574;">"** unknown mode **"</span>;
    <span style="color: #2d9574;">}</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, ptr<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgbfbdb60" class="outline-3">
<h3 id="orgbfbdb60">4.4 Set-User-ID and Set-Group-ID</h3>
<div class="outline-text-3" id="text-orgbfbdb60">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">IDs</th>
<th scope="col" class="org-left">using for</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">real user ID</td>
<td class="org-left">who we really are</td>
</tr>

<tr>
<td class="org-left">real group ID</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">effective user ID</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">effective group ID</td>
<td class="org-left">used for file access permission checks</td>
</tr>

<tr>
<td class="org-left">supplementary group IDs</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">save set-user-ID</td>
<td class="org-left">saved by exec functions</td>
</tr>

<tr>
<td class="org-left">save set-group-ID</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org7e52a2c" class="outline-3">
<h3 id="org7e52a2c">4.5 File Access Permissions</h3>
<div class="outline-text-3" id="text-org7e52a2c">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">st_mode mask</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_IRUSR</td>
<td class="org-left">user-read</td>
</tr>

<tr>
<td class="org-left">S_IWUSR</td>
<td class="org-left">user-write</td>
</tr>

<tr>
<td class="org-left">S_IXUSR</td>
<td class="org-left">user-execute</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IRGRP</td>
<td class="org-left">group-read</td>
</tr>

<tr>
<td class="org-left">S_IWGRP</td>
<td class="org-left">group-write</td>
</tr>

<tr>
<td class="org-left">S_IXGRP</td>
<td class="org-left">group-execute</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IROTH</td>
<td class="org-left">other-read</td>
</tr>

<tr>
<td class="org-left">S_IWOTH</td>
<td class="org-left">other-write</td>
</tr>

<tr>
<td class="org-left">S_IXOTH</td>
<td class="org-left">other-execute</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org400d365" class="outline-3">
<h3 id="org400d365">4.6 Ownership of New Files and Directories</h3>
</div>
<div id="outline-container-org6378708" class="outline-3">
<h3 id="org6378708"><code>access</code> and <code>faccessat</code> Functions</h3>
<div class="outline-text-3" id="text-org6378708">
<p>
<code>man 2 access</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>Figure 4.8 Example of access function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc != <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: a.out &lt;pathname&gt;"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>access<span style="color: #2d9574;">(</span>argv<span style="color: #67b11d;">[</span><span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span>, R_OK<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"access error for %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read access OK\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #4e3163;">1</span><span style="color: #b1951d;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error for %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open for reading OK\n"</span><span style="color: #2d9574;">)</span>;
    close<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org80263be" class="outline-3">
<h3 id="org80263be"><code>umask</code> Function</h3>
<div class="outline-text-3" id="text-org80263be">
<p>
<code>man 2 umask</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>Figure 4.9 Example of umask function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">RWRWRW</span> <span style="color: #3a81c3;">(</span>S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH<span style="color: #3a81c3;">)</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  umask<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>creat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, RWRWRW<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat \"foo\": %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  umask<span style="color: #6c3163;">(</span>S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>creat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bar"</span>, RWRWRW<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat \"bar\": %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org82907ac" class="outline-3">
<h3 id="org82907ac"><code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</h3>
<div class="outline-text-3" id="text-org82907ac">
<p>
<code>man 2 chmod</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>Figure 4.12 Example of chmod function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> <span style="color: #715ab1;">statbuf</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">turn on set-group-ID and turn off group-execute */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>stat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat error for foo"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>chmod<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, <span style="color: #67b11d;">(</span>statbuf.st_mode &amp; ~S_IXGRP<span style="color: #67b11d;">)</span> | S_ISGID<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chmod error for foo"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">set absolute mode to "rw-r--r--" */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>chmod<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bar"</span>, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chmod error for bar"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgcd6ad51" class="outline-3">
<h3 id="orgcd6ad51">Sticky Bit</h3>
<div class="outline-text-3" id="text-orgcd6ad51">
<p>
If it was set for an executable program file, then the first time the program was executed, <br />
a copy of the program’s text was saved in the swap area when the process terminated
</p>
</div>
</div>
<div id="outline-container-orgb7c4a88" class="outline-3">
<h3 id="orgb7c4a88"><code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</h3>
<div class="outline-text-3" id="text-orgb7c4a88">
<p>
<code>man 2 chown</code>
</p>
</div>
</div>
<div id="outline-container-orga940e0c" class="outline-3">
<h3 id="orga940e0c">File Size</h3>
<div class="outline-text-3" id="text-orga940e0c">
<p>
<code>struct stat.st_size</code>
</p>
</div>
</div>
<div id="outline-container-org4fad6cc" class="outline-3">
<h3 id="org4fad6cc">File Truncation</h3>
<div class="outline-text-3" id="text-org4fad6cc">
<p>
<code>man 2 truncate</code>
</p>
</div>
</div>
<div id="outline-container-org8e6cf90" class="outline-3">
<h3 id="org8e6cf90">File Systems</h3>
<div class="outline-text-3" id="text-org8e6cf90">
<ul class="org-ul">
<li>Only when the link count goes to 0 can the file be deleted. <br />
<code>struct stat.st_nlink</code></li>
<li>The other type of link is called a symbolic link. With a symbolic link, the actual contents of the file—the data blocks—store the name of the file that the symbolic link points to.</li>
<li>The i-node contains all the information about the file. <br />
Most of the information in the stat structure is obtained from the i-node, exclude <b>filename</b> and <b>i-node</b> number.</li>
<li>a directory entry can’t refer to an i-node in a different file system.</li>
<li>When renaming a file without changing file systems, the actual contents of the file need not be moved—all that needs to be done is to add a new directory entry that points to the existing i-node and then unlink the old directory entry.</li>
</ul>
</div>
</div>
<div id="outline-container-orga185757" class="outline-3">
<h3 id="orga185757"><code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</h3>
<div class="outline-text-3" id="text-orga185757">
<p>
<code>man 2 link</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>Figure 4.16 Open a file and then unlink it</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>open<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"tempfile"</span>, O_RDWR<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>unlink<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"tempfile"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unlink: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"file unlinked\n"</span><span style="color: #6c3163;">)</span>;
  sleep<span style="color: #6c3163;">(</span><span style="color: #4e3163;">15</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"done\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org12dfa80" class="outline-3">
<h3 id="org12dfa80"><code>rename</code> and <code>renameat</code> Functions</h3>
<div class="outline-text-3" id="text-org12dfa80">
<p>
<code>man 2 rename</code>
</p>
<ol class="org-ol">
<li>If oldname specifies a file that is not a directory, then we are renaming a file or a symbolic link.</li>
<li>If oldname specifies a directory, then we are renaming a directory.</li>
<li>If either oldname or newname refers to a symbolic link, then the link itself is processed, not the file to which it resolves.</li>
<li>We can’t rename dot or dot-dot.</li>
<li>As a special case, if oldname and newname refer to the same file, the function returns successfully without changing anything.</li>
</ol>
</div>
</div>
<div id="outline-container-org9e4bdc4" class="outline-3">
<h3 id="org9e4bdc4">Symbolic Links</h3>
<div class="outline-text-3" id="text-org9e4bdc4">
<ul class="org-ul">
<li>Hard links normally require that the link and the file reside in the same file system.</li>
<li>Only the superuser can create a hard link to a directory (when supported by the underlying file system).</li>
</ul>
</div>
</div>
<div id="outline-container-org77b051c" class="outline-3">
<h3 id="org77b051c">Creating and Reading Symbolic Links</h3>
<div class="outline-text-3" id="text-org77b051c">
<p>
<code>man 2 symlink</code>
<code>man 2 readlink</code>
</p>
</div>
</div>
<div id="outline-container-org9d834ae" class="outline-3">
<h3 id="org9d834ae">File Times</h3>
</div>
<div id="outline-container-orgc2342f4" class="outline-3">
<h3 id="orgc2342f4"><code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</h3>
<div class="outline-text-3" id="text-orgc2342f4">
<p>
POSIX.1
<code>man 2 futimens</code>
XSI
<code>man 2 utimes</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>Figure 4.21 Example of futimens function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>             <span style="color: #715ab1;">i</span>, <span style="color: #715ab1;">fd</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span>     <span style="color: #715ab1;">statbuf</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">timespec</span> <span style="color: #715ab1;">times</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">2</span><span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; argc; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;statbuf<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fetch current times */</span>
      err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">continue</span>;
    <span style="color: #2d9574;">}</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fd = open<span style="color: #b1951d;">(</span>argv<span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span>, O_RDWR | O_TRUNC<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">truncate */</span>
      err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">continue</span>;
    <span style="color: #2d9574;">}</span>

    times<span style="color: #2d9574;">[</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">]</span> = statbuf.st_atimespec;
    times<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span> = statbuf.st_mtimespec;

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>futimens<span style="color: #67b11d;">(</span>fd, times<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">reset times */</span>
      err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    close<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgdc23d5d" class="outline-3">
<h3 id="orgdc23d5d"><code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</h3>
<div class="outline-text-3" id="text-orgdc23d5d">
<p>
Creat:
<code>man 2 mkdir</code>
Remove:
<code>man 2 rmdir</code>
</p>
</div>
</div>
<div id="outline-container-org0052b4c" class="outline-3">
<h3 id="org0052b4c">Reading Directories</h3>
<div class="outline-text-3" id="text-org0052b4c">
<p>
<code>man 3 opendir</code>
</p>
<ul class="org-ul">
<li>Example <br />
<a href="file:///Users/zhoush/Private/Notes/books/c/APUE/Chapter04/ftw.c">Figure 4.22 Recursively descend a directory hierarchy, counting file types</a></li>
</ul>
</div>
</div>
<div id="outline-container-org06219a7" class="outline-3">
<h3 id="org06219a7"><code>chidr</code>, <code>fchdir</code> and <code>getcwd</code> Functions</h3>
<div class="outline-text-3" id="text-org06219a7">
<p>
<code>man 2 chdir</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span>Figure 4.23 Example of chdir function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>chdir<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/tmp"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chdir: "</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"chdir to /tmp SUCCESS\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
<p>
<code>man 3 getcwd</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>Figure 4.24 Example of getcwd function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> * <span style="color: #715ab1;">ptr</span>;
  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">size</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>chdir<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/usr/local"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chdir: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  ptr = path_alloc<span style="color: #6c3163;">(</span>&amp;size<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>getcwd<span style="color: #2d9574;">(</span>ptr, size<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getcwd: %s\n"</span>, ptr<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"cwd = %s\n"</span>, ptr<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgf38548d" class="outline-3">
<h3 id="orgf38548d">Device Special Files</h3>
<div class="outline-text-3" id="text-orgf38548d">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>Figure 4.25 Print st_dev and st_rdev values</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#ifdef</span> SOLARIS
<span style="color: #6c3163;">#  include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/mkdev.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#endif</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">SOLARIS</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>         <span style="color: #715ab1;">i</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> <span style="color: #715ab1;">buf</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; argc; i++<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"stat error"</span><span style="color: #67b11d;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">continue</span>;
    <span style="color: #2d9574;">}</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"dev = %d/%d"</span>, MAJOR<span style="color: #67b11d;">(</span>buf.st_dev<span style="color: #67b11d;">)</span>, MINOR<span style="color: #67b11d;">(</span>buf.st_dev<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span> || S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" (%s) rdev = %d/%d"</span>,
             <span style="color: #b1951d;">(</span>S_ISCHR<span style="color: #3a81c3;">(</span>buf.st_mode<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> ? <span style="color: #2d9574;">"character"</span> : <span style="color: #2d9574;">"block"</span>, major<span style="color: #b1951d;">(</span>buf.st_mode<span style="color: #b1951d;">)</span>,
             minor<span style="color: #b1951d;">(</span>buf.st_rdev<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4d6ddf8" class="outline-3">
<h3 id="org4d6ddf8">Summary of File Access Permission Bits</h3>
<div class="outline-text-3" id="text-org4d6ddf8">
<p>
S_IRWXU = S_IRUSR | S_IWUSR | S_IXUSR
S_IRWXG = S_IRGRP | S_IWGRP | S_IXGRP
S_IRWXO = S_IROTH | S_IWOTH | S_IXOTH
</p>
</div>
</div>
<div id="outline-container-orgc9aa5d6" class="outline-3">
<h3 id="orgc9aa5d6">Summary</h3>
<div class="outline-text-3" id="text-orgc9aa5d6">
<p>
<b>Exercises</b>
</p>
<ol class="org-ol">
<li>#+caption: ex01</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>         <span style="color: #715ab1;">i</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> <span style="color: #715ab1;">buf</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> *      <span style="color: #715ab1;">ptr</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">1</span>; i &lt; argc; i++<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"lstat error"</span><span style="color: #67b11d;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">continue</span>;
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISREG<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
      ptr = <span style="color: #2d9574;">"regular"</span>;
    <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
      ptr = <span style="color: #2d9574;">"directory"</span>;
    <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
      ptr = <span style="color: #2d9574;">"character special"</span>;
    <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
      ptr = <span style="color: #2d9574;">"block special"</span>;
    <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISFIFO<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
      ptr = <span style="color: #2d9574;">"fifo"</span>;
    <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISLNK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
      ptr = <span style="color: #2d9574;">"symbolic link"</span>;
    <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISSOCK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
      ptr = <span style="color: #2d9574;">"socket"</span>;
    <span style="color: #3a81c3; font-weight: bold;">else</span>
      ptr = <span style="color: #2d9574;">"** unknown mode **"</span>;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, ptr<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<p>
before modification: symbolic link
after  modification: regular
</p>
<ol class="org-ol">
<li>default permissions: <code>----------</code></li>
<li><code>cat</code> get : Permission denied</li>
<li>nothing changed.</li>
<li>directory always shoud be entries for . and ..
the size of symbolic link should be the size of the file contained in.</li>
<li>#+caption: ex06</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>         <span style="color: #715ab1;">in</span>, <span style="color: #715ab1;">out</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>        <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>BUFSIZ<span style="color: #6c3163;">]</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> <span style="color: #715ab1;">stbuf</span> = <span style="color: #6c3163;">{</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">}</span>;

  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">l_size</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>stat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"src.txt"</span>, &amp;stbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  l_size = stbuf.st_size;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>in = open<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"src.txt"</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span> ||
      <span style="color: #2d9574;">(</span>out = open<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"dst.txt"</span>, O_CREAT | O_RDWR, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">l_sum</span> = <span style="color: #4e3163;">0</span>;
  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">l_cur</span> = <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>l_cur = read<span style="color: #67b11d;">(</span>in, buf, BUFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    l_sum += l_cur;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>out, buf, l_cur<span style="color: #67b11d;">)</span> != l_cur<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write: %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  close<span style="color: #6c3163;">(</span>in<span style="color: #6c3163;">)</span>;
  close<span style="color: #6c3163;">(</span>out<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>default access permissions are different</li>
<li><code>du</code> check the file/directory/path space instead of disk , and may need path permissions.</li>
<li>it's not the last link to the file.</li>
<li>recursive depth number</li>
<li>#+caption: ex11</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">dirent.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">function type that is called for each filename */</span>
<span style="color: #3a81c3; font-weight: bold;">typedef</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #ba2f59; font-weight: bold;">Myfunc</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">fpath</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> *<span style="color: #715ab1;">sb</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">typeflag</span><span style="color: #3a81c3;">)</span>;

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">Myfunc</span> <span style="color: #715ab1;">myfunc</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>    <span style="color: #6c3163; font-weight: bold;">myftw</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">dirpath</span>, <span style="color: #ba2f59; font-weight: bold;">Myfunc</span> *<span style="color: #715ab1;">func</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>    <span style="color: #6c3163; font-weight: bold;">dopath</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">dirname</span>, <span style="color: #ba2f59; font-weight: bold;">Myfunc</span> *<span style="color: #715ab1;">func</span><span style="color: #3a81c3;">)</span>;

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">nreg</span>, <span style="color: #715ab1;">ndir</span>, <span style="color: #715ab1;">nblk</span>, <span style="color: #715ab1;">nchr</span>, <span style="color: #715ab1;">nfifo</span>, <span style="color: #715ab1;">nslink</span>, <span style="color: #715ab1;">nsock</span>, <span style="color: #715ab1;">ntot</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">ret</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc != <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;starting-pathname&gt;"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #4e3163;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  ret = myftw<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>, myfunc<span style="color: #6c3163;">)</span>;

  ntot = nreg + ndir + nblk + nchr + nfifo + nslink + nsock;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ntot == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    ntot = <span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"regular files  = %7ld, %5.2f %%\n"</span>, nreg, nreg * <span style="color: #4e3163;">100.0</span> / ntot<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"directories    = %7ld, %5.2f %%\n"</span>, ndir, ndir * <span style="color: #4e3163;">100.0</span> / ntot<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"block special  = %7ld, %5.2f %%\n"</span>, nblk, nblk * <span style="color: #4e3163;">100.0</span> / ntot<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"char special   = %7ld, %5.2f %%\n"</span>, nchr, nchr * <span style="color: #4e3163;">100.0</span> / ntot<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"FIFOs          = %7ld, %5.2f %%\n"</span>, nfifo, nfifo * <span style="color: #4e3163;">100.0</span> / ntot<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"symbolic links = %7ld, %5.2f %%\n"</span>, nslink, nslink * <span style="color: #4e3163;">100.0</span> / ntot<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"sockets        = %7ld, %5.2f %%\n"</span>, nsock, nsock * <span style="color: #4e3163;">100.0</span> / ntot<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * Descend through the hierarchy, starting at "pathname".</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * The caller's func() is called for every file.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">FTW_F</span> <span style="color: #4e3163;">1</span>   <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">file other than directory */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">FTW_D</span> <span style="color: #4e3163;">2</span>   <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">directory */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">FTW_DNR</span> <span style="color: #4e3163;">3</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">dirctory that cant'be read */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">FTW_NS</span> <span style="color: #4e3163;">4</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">file that we can't stat */</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">pathlen</span>;

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">myftw</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">pathname</span>, <span style="color: #ba2f59; font-weight: bold;">Myfunc</span> *<span style="color: #715ab1;">func</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">fullpath</span> = path_alloc<span style="color: #6c3163;">(</span>&amp;pathlen<span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">malloc PATH_MAX+1 bytes */</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pathlen &lt;= strlen<span style="color: #2d9574;">(</span>pathname<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    pathlen = strlen<span style="color: #2d9574;">(</span>pathname<span style="color: #2d9574;">)</span> * <span style="color: #4e3163;">2</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fullpath = realloc<span style="color: #b1951d;">(</span>fullpath, pathlen<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"realloc %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>dopath<span style="color: #2d9574;">(</span>pathname, func<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * Descend through the hierarchy, starting at "fullpath".</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * If "fullpath" is anything other than a directory, we lstat() it,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * call func(), and return. For a directory, we call ourself</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * recursively for each name in the directory.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">we return whatever func() returns  */</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">dopath</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">pathname</span>, <span style="color: #ba2f59; font-weight: bold;">Myfunc</span> *<span style="color: #715ab1;">func</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span>    <span style="color: #715ab1;">statbuf</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">dirent</span> *<span style="color: #715ab1;">dirp</span>;
  <span style="color: #ba2f59; font-weight: bold;">DIR</span> *          <span style="color: #715ab1;">dp</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>            <span style="color: #715ab1;">ret</span>, <span style="color: #715ab1;">n</span>;

  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">l</span>   = <span style="color: #4e3163;">0</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> * <span style="color: #715ab1;">cwd</span> = path_alloc<span style="color: #6c3163;">(</span>&amp;l<span style="color: #6c3163;">)</span>;

  chdir<span style="color: #6c3163;">(</span>pathname<span style="color: #6c3163;">)</span>;
  getcwd<span style="color: #6c3163;">(</span>cwd, l<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#ifdef</span> DEBUG
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s\n"</span>, cwd<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>dp = opendir<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"."</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">can't read directory */</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>func<span style="color: #67b11d;">(</span>pathname, &amp;statbuf, FTW_DNR<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>dirp = readdir<span style="color: #67b11d;">(</span>dp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strcmp<span style="color: #b1951d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">"."</span><span style="color: #b1951d;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> || <span style="color: #67b11d;">(</span>strcmp<span style="color: #b1951d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">".."</span><span style="color: #b1951d;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">continue</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ignore dot and dot-dot */</span>
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lstat<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">stat error */</span>
      func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_NS<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>statbuf.st_mode<span style="color: #67b11d;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">not a directory */</span>
      func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_F<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
      func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_D<span style="color: #67b11d;">)</span>;
      <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">chdir(dirp-&gt;d_name); */</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>ret = dopath<span style="color: #3a81c3;">(</span>dirp-&gt;d_name, func<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        <span style="color: #3a81c3; font-weight: bold;">break</span>;
      <span style="color: #67b11d;">}</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">chdir(".."); */</span>
      getcwd<span style="color: #67b11d;">(</span>cwd, l<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>closedir<span style="color: #2d9574;">(</span>dp<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: %s"</span>, cwd, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>ret<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">myfunc</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">pathname</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> *<span style="color: #715ab1;">statptr</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">type</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">switch</span> <span style="color: #6c3163;">(</span>type<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">case</span> FTW_F:
      <span style="color: #3a81c3; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>statptr-&gt;st_mode &amp; S_IFMT<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
        <span style="color: #3a81c3; font-weight: bold;">case</span> S_IFREG:
          nreg++;
          <span style="color: #3a81c3; font-weight: bold;">break</span>;
        <span style="color: #3a81c3; font-weight: bold;">case</span> S_IFBLK:
          nblk++;
          <span style="color: #3a81c3; font-weight: bold;">break</span>;
        <span style="color: #3a81c3; font-weight: bold;">case</span> S_IFCHR:
          nchr++;
          <span style="color: #3a81c3; font-weight: bold;">break</span>;
        <span style="color: #3a81c3; font-weight: bold;">case</span> S_IFIFO:
          nfifo++;
          <span style="color: #3a81c3; font-weight: bold;">break</span>;
        <span style="color: #3a81c3; font-weight: bold;">case</span> S_IFLNK:
          nslink++;
          <span style="color: #3a81c3; font-weight: bold;">break</span>;
        <span style="color: #3a81c3; font-weight: bold;">case</span> S_IFSOCK:
          nsock++;
          <span style="color: #3a81c3; font-weight: bold;">break</span>;
        <span style="color: #3a81c3; font-weight: bold;">case</span> S_IFDIR:
          err_dump<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"for S_IFDIR for %s"</span>, pathname<span style="color: #67b11d;">)</span>;
        <span style="color: #3a81c3; font-weight: bold;">default</span>:
          <span style="color: #3a81c3; font-weight: bold;">break</span>;
      <span style="color: #2d9574;">}</span>
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #3a81c3; font-weight: bold;">case</span> FTW_D:
      ndir++;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #3a81c3; font-weight: bold;">case</span> FTW_DNR:
      err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: %s"</span>, pathname, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #3a81c3; font-weight: bold;">case</span> FTW_NS:
      err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat error for %s"</span>, pathname<span style="color: #2d9574;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #3a81c3; font-weight: bold;">default</span>:
      err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown type %d for pathname %s"</span>, type, pathname<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>FTP</li>
<li><code>stat</code> first, set timespec array to current time that you expect not change, and the other to the value you want.</li>
<li>access time is the last read time <br />
modify time is last received</li>
<li>The change time isn't stored because, even if it was stored, you wouldn't be able to set it to the original time. You cannot cheat the change time, it is always based on when the inode data was actually changed.
<br />
Depending on the utility (tar or cpio), you can tell it to keep the original access and/or modify times. For example, tar by default maintains the original modify time but you can use the -m switch to set it to extraction time. The access time is always set to extraction time.</li>
<li>#+caption: ex16</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">dirname</span> = <span style="color: #2d9574;">"testdir"</span>;
  <span style="color: #ba2f59; font-weight: bold;">size_t</span>      <span style="color: #715ab1;">pathmax</span> = pathconf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"."</span>, _PC_PATH_MAX<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pathmax: %ld\n"</span>, pathmax<span style="color: #6c3163;">)</span>;

  <span style="color: #ba2f59; font-weight: bold;">char</span>   <span style="color: #715ab1;">path</span><span style="color: #6c3163;">[</span>pathmax<span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">curlen</span>;

  strcpy<span style="color: #6c3163;">(</span>path, dirname<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    curlen = strlen<span style="color: #2d9574;">(</span>getcwd<span style="color: #67b11d;">(</span>path, pathmax<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> + strlen<span style="color: #2d9574;">(</span>dirname<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>curlen &lt;= pathmax<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>mkdir<span style="color: #b1951d;">(</span>dirname, <span style="color: #4e3163;">0777</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"mkdir: %s\n"</span>, strerror<span style="color: #3a81c3;">(</span>errno<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>;
        <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
      <span style="color: #67b11d;">}</span>
      sprintf<span style="color: #67b11d;">(</span>path, <span style="color: #2d9574;">"/%s"</span>, dirname<span style="color: #67b11d;">)</span>;
      chdir<span style="color: #67b11d;">(</span>dirname<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"curlen = %ld\n"</span>, curlen<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>#+caption: ex17</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">path</span> = <span style="color: #2d9574;">"/dev/fd/1"</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">fd</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">ret</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>ret = unlink<span style="color: #67b11d;">(</span>path<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unlink: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span>path, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<p>
<code>unlink: Operation not permitted</code>
</p>
</div>
</div>
</div>
<div id="outline-container-org8fce3b1" class="outline-2">
<h2 id="org8fce3b1">Chapter 5. Standard I/O Library</h2>
<div class="outline-text-2" id="text-org8fce3b1">
</div>
<div id="outline-container-orge0f2c3e" class="outline-3">
<h3 id="orge0f2c3e">Introduction</h3>
<div class="outline-text-3" id="text-orge0f2c3e">
<p>
This library is specified by the ISO C standard because it has been implemented on many operating systems other than the UNIX System.
</p>
</div>
</div>
<div id="outline-container-org2f5299d" class="outline-3">
<h3 id="org2f5299d">Streams and FILE Objects</h3>
<div class="outline-text-3" id="text-org2f5299d">
<p>
<code>man 3 fwide</code>
</p>
</div>
</div>
<div id="outline-container-orgb45376a" class="outline-3">
<h3 id="orgb45376a">Standard Input, Standard Output and Standard Error</h3>
<div class="outline-text-3" id="text-orgb45376a">
<p>
<code>STDIN_FILENO</code>, <code>STDOUT_FILENO</code>, <code>STDERR_FILENO</code>
</p>
</div>
</div>
<div id="outline-container-org4d9a214" class="outline-3">
<h3 id="org4d9a214">Buffering</h3>
<div class="outline-text-3" id="text-org4d9a214">
<p>
Three types of buffering are provided:
</p>
<ol class="org-ol">
<li>Fully buffered. <br />
In this case, actual I/O takes place when the standard I/O buffer is filled.</li>
<li>Line buffered. <br />
In this case, the standard I/O library performs I/O when a newline character is encountered on input or output.</li>
<li>Unbuffered. <br /></li>
</ol>

<p>
ISO C requires the following buffering characteristics:
</p>
<ul class="org-ul">
<li>Standard input and standard output are fully buffered, if and only if they do not refer to an interactive device.</li>
<li>Standard error is never fully buffered.</li>
</ul>

<p>
Most implementations default to the following types of buffering:
</p>
<ul class="org-ul">
<li>Standard error is always unbuffered.</li>
<li>All other streams are line buffered if they refer to a terminal device; otherwise, they are fully buffered.</li>
</ul>


<p>
<code>man 3 setbuf</code>
<code>man 3 fflush</code>
</p>
</div>
</div>
<div id="outline-container-org4d28ebe" class="outline-3">
<h3 id="org4d28ebe">Opening a Stream</h3>
<div class="outline-text-3" id="text-org4d28ebe">
<p>
<code>man 3 fopen</code>
<code>man 3 fclose</code>
</p>
</div>
</div>
<div id="outline-container-org9cd999a" class="outline-3">
<h3 id="org9cd999a">Reading and Writing a Stream</h3>
<div class="outline-text-3" id="text-org9cd999a">
<p>
Three types of unformatted I/O:
</p>
<ol class="org-ol">
<li>Character-at-a-time I/O.</li>
<li>Line-at-a-time I/O.</li>
<li>Direct I/O.</li>
</ol>
</div>
<div id="outline-container-org01e5a4a" class="outline-4">
<h4 id="org01e5a4a">Input Functions</h4>
<div class="outline-text-4" id="text-org01e5a4a">
<p>
<code>man 3 getc</code>
</p>
<ol class="org-ol">
<li>The argument to getc should not be an expression with side effects, because it could be evaluated more than once.</li>
<li>Since fgetc is guaranteed to be a function, we can take its address. This allows us to pass the address of fgetc as an argument to another function.</li>
<li>Calls to fgetc probably take longer than calls to getc, as it usually takes more time to call a function.</li>
</ol>


<p>
In most implementations, two flags are maintained for each stream in the FILE object:
<code>man 3 ferror</code>
</p>
<ul class="org-ul">
<li>An error flag</li>
<li>An end-of file flagp</li>
</ul>


<p>
After reading from a stream, we can push back characters by calling <code>ungetc</code>.
</p>
</div>
</div>
<div id="outline-container-org22a7e22" class="outline-4">
<h4 id="org22a7e22">Output Functions</h4>
<div class="outline-text-4" id="text-org22a7e22">
<p>
<code>man 3 putc</code>
</p>
</div>
</div>
</div>
<div id="outline-container-org2528678" class="outline-3">
<h3 id="org2528678">Line-at-a-Time I/O</h3>
<div class="outline-text-3" id="text-org2528678">
<p>
<code>man fgets</code>
</p>
</div>
</div>
<div id="outline-container-org44c0d44" class="outline-3">
<h3 id="org44c0d44">Standard I/O Efficiency</h3>
<div class="outline-text-3" id="text-org44c0d44">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>Figure 5.4 Copy standard input to output using getc and putc</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">c</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span><span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>c = getc<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != EOF<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>putc<span style="color: #67b11d;">(</span>c, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span>
      err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output error: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>Figure 5.5 Copy standard input to output using fgets and fputs</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>MAXLINE<span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>fputs<span style="color: #2d9574;">(</span>buf, stdout<span style="color: #2d9574;">)</span> == EOF<span style="color: #6c3163;">)</span>
      err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc958ee0" class="outline-3">
<h3 id="orgc958ee0">Binary I/O</h3>
<div class="outline-text-3" id="text-orgc958ee0">
<p>
<code>man fread</code>
</p>
</div>
</div>
<div id="outline-container-orgaee2e9c" class="outline-3">
<h3 id="orgaee2e9c">Positioning a Stream</h3>
<div class="outline-text-3" id="text-orgaee2e9c">
<p>
Three way to position a standard I/O stream:
</p>
<ol class="org-ol">
<li><code>ftell</code> and <code>fseek</code></li>
<li><code>ftello</code> and <code>fseeko</code></li>
<li><code>fgetpos</code> and <code>fsetpos</code></li>
</ol>


<p>
When porting applications to non-UNIX systems, use fgetpos and fsetpos.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">fgetpos</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">stream</span>, <span style="color: #ba2f59; font-weight: bold;">fpos_t</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">pos</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">fseek</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">stream</span>, <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">offset</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">whence</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">fseeko</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">stream</span>, <span style="color: #ba2f59; font-weight: bold;">off_t</span> <span style="color: #715ab1;">offset</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">whence</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">fsetpos</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">stream</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">fpos_t</span> *<span style="color: #715ab1;">pos</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">long</span>
<span style="color: #6c3163; font-weight: bold;">ftell</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">stream</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">off_t</span>
<span style="color: #6c3163; font-weight: bold;">ftello</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">stream</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span>
<span style="color: #6c3163; font-weight: bold;">rewind</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">stream</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc7f391f" class="outline-3">
<h3 id="orgc7f391f">Formated I/O</h3>
<div class="outline-text-3" id="text-orgc7f391f">
<p>
<code>man 3 printf</code>
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Figure 5.7 The flags component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flag</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">'</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">(apostrophe) format integer with thousands grouping characters</a></td>
</tr>

<tr>
<td class="org-left">-</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">left justify</a></td>
</tr>

<tr>
<td class="org-left">+</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">always display sign of a signed conversion</a></td>
</tr>

<tr>
<td class="org-left">(space)</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">prefix by a space if no sign is generated</a></td>
</tr>

<tr>
<td class="org-left">\#</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">convert using alternative form(include 0x prefix for hexadecimal format, for example)</a></td>
</tr>

<tr>
<td class="org-left">0</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">prefix with leading zeros instead of padding with spaces</a></td>
</tr>
</tbody>
</table>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Figure 5.8 The lenth modifier component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Length modifer</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">hh</td>
<td class="org-left">signed or unsigned char</td>
</tr>

<tr>
<td class="org-left">h</td>
<td class="org-left">sigend or unsigned short</td>
</tr>

<tr>
<td class="org-left">l</td>
<td class="org-left">signed or unsigned long or wide character</td>
</tr>

<tr>
<td class="org-left">ll</td>
<td class="org-left">signed or unsigned long long</td>
</tr>

<tr>
<td class="org-left">j</td>
<td class="org-left">inmax_t or uintmax_t</td>
</tr>

<tr>
<td class="org-left">z</td>
<td class="org-left">size_t</td>
</tr>

<tr>
<td class="org-left">t</td>
<td class="org-left">ptrdiff_t</td>
</tr>

<tr>
<td class="org-left">L</td>
<td class="org-left">long double</td>
</tr>
</tbody>
</table>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Figure 5.9 The conversion type component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Conversion type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">d,i</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">signed decimal</a></td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned octal</a></td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned decimal</a></td>
</tr>

<tr>
<td class="org-left">x,X</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned hexadecimal</a></td>
</tr>

<tr>
<td class="org-left">f,F</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number</a></td>
</tr>

<tr>
<td class="org-left">e,E</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number in exponential format</a></td>
</tr>

<tr>
<td class="org-left">g,G</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">interpreted as f, F, e, or E, depending on value converted</a></td>
</tr>

<tr>
<td class="org-left">a,A</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double ﬂoating-point number in hexadecimal exponential format</a></td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">character (with 1 length modifier, wide character)</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">string(with 1 length modifier, wide character string)</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">pointer to a void</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">pointer to a signed integer into which is written the number of characters written so far</td>
</tr>

<tr>
<td class="org-left">%</td>
<td class="org-left">a % character</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">wide chracter(XSI option, equivalent to lc)</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">wide chracter string(XSI option, equivalent to ls)</td>
</tr>
</tbody>
</table>


<p>
<b>Formatted Input</b>
<code>man 3 scanf</code>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Figure 5.9 The conversion type component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Conversion type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">d</td>
<td class="org-left">signed decimal, base 10</td>
</tr>

<tr>
<td class="org-left">i</td>
<td class="org-left">signed decimal, base determined by format of input</td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left">unsigned octal(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left">unsigned decimal, base 10(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">x,X</td>
<td class="org-left">unsigned hexadecimal(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">a,A,e,E,f,F,g,G</td>
<td class="org-left">floating-point number</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">character (with 1 length modifier, wide character)</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">string(with 1 length modifier, wide character string)</td>
</tr>

<tr>
<td class="org-left">[</td>
<td class="org-left">mathches a sequence of listed characters, ending with ]</td>
</tr>

<tr>
<td class="org-left">[^</td>
<td class="org-left">mathches all characters except the ones listed, ending with ]</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">pointer to a void</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">pointer to a signed integer into which is written the number of characters written so far</td>
</tr>

<tr>
<td class="org-left">%</td>
<td class="org-left">a % character</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">wide chracter(XSI option, equivalent to lc)</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">wide chracter string(XSI option, equivalent to ls)</td>
</tr>
</tbody>
</table>

<p>
<b>*</b>
</p>
</div>
</div>
<div id="outline-container-orge52b186" class="outline-3">
<h3 id="orge52b186">Implementation Details</h3>
<div class="outline-text-3" id="text-orge52b186">
<p>
<code>man 3 fileno</code>
</p>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span>Figure 5.11 Print buffering for various standard I/O streams</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pr_stdio</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *, <span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #6c3163; font-weight: bold;">is_unbuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #6c3163; font-weight: bold;">is_linebuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #6c3163; font-weight: bold;">buffer_size</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span>;

  fputs<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"enter any character\n"</span>, stdout<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>getchar<span style="color: #2d9574;">()</span> == EOF<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getchar: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  fputs<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"one line to standard error\n"</span>, stderr<span style="color: #6c3163;">)</span>;

  pr_stdio<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"stdin"</span>, stdin<span style="color: #6c3163;">)</span>;
  pr_stdio<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"stdout"</span>, stdout<span style="color: #6c3163;">)</span>;
  pr_stdio<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"stderr"</span>, stderr<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"/etc/passwd"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fopen: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>getc<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span> == EOF<span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"getc: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span>
<span style="color: #6c3163; font-weight: bold;">pr_stdio</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span>, <span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"stream = %s, "</span>, name<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>is_unbuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"unbuffered"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>is_linebuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"line buffered"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">if neither or above */</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fully buffered"</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">", buffer size = %d\n"</span>, buffer_size<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * The following is nonportable</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>_IO_UNBUFFERED<span style="color: #3a81c3;">)</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">is_unbuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;flags &amp; _IO_UNBUFFERED<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">is_linebuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;flags &amp; _IO_LINE_BUF<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">buffer_size</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #6c3163;">#elif</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>__SNBF<span style="color: #3a81c3;">)</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">is_unbuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_flags &amp; __SNBF<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">is_linebuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_flags &amp; __SLBF<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">buffer_size</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_bf._size<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #6c3163;">#elif</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>_IONBF<span style="color: #3a81c3;">)</span>

<span style="color: #6c3163;">#  ifdef</span> _LP64
<span style="color: #6c3163;">#    define</span> <span style="color: #715ab1;">_flag</span> __pad<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">4</span><span style="color: #3a81c3;">]</span>
<span style="color: #6c3163;">#    define</span> <span style="color: #715ab1;">_ptr</span> __pad<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">1</span><span style="color: #3a81c3;">]</span>
<span style="color: #6c3163;">#    define</span> <span style="color: #715ab1;">_base</span> __pad<span style="color: #3a81c3;">[</span><span style="color: #4e3163;">2</span><span style="color: #3a81c3;">]</span>
<span style="color: #6c3163;">#  endif</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">is_unbuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_flag &amp; _IONBF<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">is_linebuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_flag &amp; _IOLBF<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">buffer_size</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
<span style="color: #6c3163;">#  ifdef</span> _LP64
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_base - fp-&gt;_ptr<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#  else</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>BUFSIZ<span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">just a guess */</span>
<span style="color: #6c3163;">#  endif</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #6c3163;">#else</span>

<span style="color: #6c3163;">#  error</span> <span style="color: #2d9574;">unknown stdio implementation;</span>

<span style="color: #6c3163;">#endif</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org5209d6f" class="outline-3">
<h3 id="org5209d6f">Temporary Files</h3>
<div class="outline-text-3" id="text-org5209d6f">
<p>
<code>man 3 tmpnam</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span>Figure 5.12 Demonstrate tmpnam and tmpfile functions</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span>  <span style="color: #715ab1;">name</span><span style="color: #6c3163;">[</span>L_tmpnam<span style="color: #6c3163;">]</span>, <span style="color: #715ab1;">line</span><span style="color: #6c3163;">[</span>MAXLINE<span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s\n"</span>, tmpnam<span style="color: #2d9574;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">first temp name */</span>

  tmpnam<span style="color: #6c3163;">(</span>name<span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">second temp name */</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s\n"</span>, name<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fp = tmpfile<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create temp file */</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"tmpfile: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;

  fputs<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"one line of output\n"</span>, fp<span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">write to temp file */</span>
  rewind<span style="color: #6c3163;">(</span>fp<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>fgets<span style="color: #2d9574;">(</span>line, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>, fp<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fgets: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  fputs<span style="color: #6c3163;">(</span>line, stdout<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>

<p>
<code>man 3 mkdtemp</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span>Figure 5.13 Demonstrate mkstemp function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">make_temp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">template</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span>  <span style="color: #715ab1;">good_template</span><span style="color: #6c3163;">[]</span> = <span style="color: #2d9574;">"/tmp/dirXXXX"</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">right way */</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">bad_template</span>    = <span style="color: #2d9574;">"/tmp/dir/</span><span style="color: #dc752f;">XXXX</span><span style="color: #2d9574;">"</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bad way */</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"trying to create first temp file ...\n"</span><span style="color: #6c3163;">)</span>;
  make_temp<span style="color: #6c3163;">(</span>good_template<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"trying to create second temp file ...\n"</span><span style="color: #6c3163;">)</span>;
  make_temp<span style="color: #6c3163;">(</span>bad_template<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span>
<span style="color: #6c3163; font-weight: bold;">make_temp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">template</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>         <span style="color: #715ab1;">fd</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> <span style="color: #715ab1;">sbuf</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = mkstemp<span style="color: #67b11d;">(</span>template<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"create temp: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"temp name = %s\n"</span>, template<span style="color: #6c3163;">)</span>;
  close<span style="color: #6c3163;">(</span>fd<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>stat<span style="color: #2d9574;">(</span>template, &amp;sbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"file exists\n"</span><span style="color: #2d9574;">)</span>;
    unlink<span style="color: #2d9574;">(</span>template<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org232e0a7" class="outline-3">
<h3 id="org232e0a7">Memory Streams</h3>
<div class="outline-text-3" id="text-org232e0a7">
<p>
<code>man 3 fmemopen</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span>Figure 5.15 Investigate memory stream write behavior</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">BSZ</span> <span style="color: #4e3163;">48</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>  <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>BSZ<span style="color: #6c3163;">]</span>;

  memset<span style="color: #6c3163;">(</span>buf, <span style="color: #2d9574;">'a'</span>, BSZ - <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>;
  buf<span style="color: #6c3163;">[</span>BSZ - <span style="color: #4e3163;">2</span><span style="color: #6c3163;">]</span> = <span style="color: #2d9574;">'\0'</span>;
  buf<span style="color: #6c3163;">[</span>BSZ - <span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> = <span style="color: #2d9574;">'X'</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fp = fmemopen<span style="color: #67b11d;">(</span>buf, BSZ, <span style="color: #2d9574;">"w+"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fmemopen failed"</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"initial buffer contents: %s\n"</span>, buf<span style="color: #6c3163;">)</span>;
  fprintf<span style="color: #6c3163;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"before flush: %s\n"</span>, buf<span style="color: #6c3163;">)</span>;
  fflush<span style="color: #6c3163;">(</span>fp<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"after fflush: %s\n"</span>, buf<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span> strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;

  memset<span style="color: #6c3163;">(</span>buf, <span style="color: #2d9574;">'b'</span>, BSZ - <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>;
  buf<span style="color: #6c3163;">[</span>BSZ - <span style="color: #4e3163;">2</span><span style="color: #6c3163;">]</span> = <span style="color: #2d9574;">'\0'</span>;
  buf<span style="color: #6c3163;">[</span>BSZ - <span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> = <span style="color: #2d9574;">'X'</span>;
  fprintf<span style="color: #6c3163;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #6c3163;">)</span>;
  fseek<span style="color: #6c3163;">(</span>fp, <span style="color: #4e3163;">0</span>, SEEK_SET<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"after fseek: %s\n"</span>, buf<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span> strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  memset<span style="color: #6c3163;">(</span>buf, <span style="color: #2d9574;">'c'</span>, BSZ - <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>;
  buf<span style="color: #6c3163;">[</span>BSZ - <span style="color: #4e3163;">2</span><span style="color: #6c3163;">]</span> = <span style="color: #2d9574;">'\0'</span>;
  buf<span style="color: #6c3163;">[</span>BSZ - <span style="color: #4e3163;">1</span><span style="color: #6c3163;">]</span> = <span style="color: #2d9574;">'X'</span>;
  fprintf<span style="color: #6c3163;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #6c3163;">)</span>;
  fclose<span style="color: #6c3163;">(</span>fp<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"after fclose: %s\n"</span>, buf<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span> strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
<p>
<b>linux</b> result:
</p>
<blockquote>
<p>
initial buffer contents: <br />
before flush: <br />
after fflush: hello, world <br />
len of string in buf = 12 <br />
after fseek: bbbbbbbbbbbbhello, world <br />
len of string in buf = 24 <br />
after fclose: hello, worldcccccccccccccccccccccccccccccccccc <br />
len of string in buf = 46
</p>
</blockquote>

<p>
The other two functions:
<code>man open_memstream</code>
</p>
</div>
</div>
<div id="outline-container-org11f9c68" class="outline-3">
<h3 id="org11f9c68">Alternatives to Standard I/O</h3>
<div class="outline-text-3" id="text-org11f9c68">
<p>
The standard I/O library is not perfect. some in the basic design, but most in the various implementations.
</p>
</div>
</div>
<div id="outline-container-org8f47052" class="outline-3">
<h3 id="org8f47052">Summary</h3>
<div class="outline-text-3" id="text-org8f47052">
<p>
<b>Exercises</b>
</p>
<ol class="org-ol">
<li>#+caption: ex01</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">void</span>
<span style="color: #6c3163; font-weight: bold;">setbuf_</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">stream</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">buf</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>stream == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IONBF, BUFSIZ<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>isatty<span style="color: #2d9574;">(</span>fileno<span style="color: #67b11d;">(</span>stream<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IOLBF, BUFSIZ<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IOFBF, BUFSIZ<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">is_unbuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_flags &amp; __SNBF<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">is_linebuffered</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_flags &amp; __SLBF<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">buffer_size</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fp-&gt;_bf._size<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span>
<span style="color: #6c3163; font-weight: bold;">pr_stdio</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span>, <span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"stream = %s, "</span>, name<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>is_unbuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"unbuffered"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>is_linebuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"line buffered"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">if neither or above */</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fully buffered"</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">", buffer size = %d\n"</span>, buffer_size<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>  <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>BUFSIZ<span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc &lt; <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;path&gt;"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  fp = fopen<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #2d9574;">"r+"</span><span style="color: #6c3163;">)</span>;
  pr_stdio<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>, fp<span style="color: #6c3163;">)</span>;
  setbuf_<span style="color: #6c3163;">(</span>fp, buf<span style="color: #6c3163;">)</span>;
  pr_stdio<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>, fp<span style="color: #6c3163;">)</span>;
  fclose<span style="color: #6c3163;">(</span>fp<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>#+caption: ex02</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#ifdef</span> MAXLINE
<span style="color: #6c3163;">#  undef</span> MAXLINE
<span style="color: #6c3163;">#  define</span> <span style="color: #715ab1;">MAXLINE</span> <span style="color: #4e3163;">4</span>
<span style="color: #6c3163;">#endif</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>MAXLINE<span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #715ab1;">i</span> = <span style="color: #4e3163;">0</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"MAXLINE: %d\n"</span>, MAXLINE<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fputs<span style="color: #67b11d;">(</span>buf, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span>
      err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #2d9574;">)</span>;
    ++i;
  <span style="color: #6c3163;">}</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">nums</span> = printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"loop_time: %d\n"</span>, i<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"nums: %d\n"</span>, nums<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<p>
execute <code>fgets</code> and <code>fputs</code> more than 1 times;
</p>
<ol class="org-ol">
<li>print nothing</li>
<li>This is a common error. The return value from getc and getchar is an int, not a char. EOF is often defined to be −1, so if the system uses signed characters, the code normally works</li>
<li>call <code>fflush</code> first</li>
<li>stdin and stdout are both line buffered. fgets will fflush automatically</li>
<li>#+caption: ex07</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">memstream</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> * <span style="color: #715ab1;">buf</span>;    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">in-memory buffer */</span>
  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">rsize</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">real size of buffer */</span>
  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">vsize</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">virtual size of buffer */</span>
  <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">curpos</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">current position in buffer */</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>    <span style="color: #715ab1;">flags</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">see below */</span>
<span style="color: #3a81c3;">}</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">flags */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MS_READ</span>     <span style="color: #4e3163;">0x01</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">open for reading */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MS_WRITE</span>    <span style="color: #4e3163;">0x02</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">open for writing */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MS_APPEND</span>   <span style="color: #4e3163;">0x04</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">append to stream */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MS_TRUNCAT</span>  <span style="color: #4e3163;">0x08</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">truncate the stream on open */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MS_MYBUF</span>    <span style="color: #4e3163;">0x10</span>  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">free buffer on close */</span>

<span style="color: #6c3163;">#if</span><span style="color: #6c3163;">n</span><span style="color: #6c3163;">def</span> MIN
<span style="color: #6c3163;">#  define</span> <span style="color: #6c3163; font-weight: bold;">MIN</span><span style="color: #3a81c3;">(</span><span style="color: #715ab1;">a</span>, <span style="color: #715ab1;">b</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>a<span style="color: #6c3163;">)</span> &lt; <span style="color: #6c3163;">(</span>b<span style="color: #6c3163;">)</span> ? <span style="color: #6c3163;">(</span>a<span style="color: #6c3163;">)</span> : <span style="color: #6c3163;">(</span>b<span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#endif</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>    <span style="color: #6c3163; font-weight: bold;">mstream_read</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *, <span style="color: #ba2f59; font-weight: bold;">char</span> *, <span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>    <span style="color: #6c3163; font-weight: bold;">mstream_write</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *, <span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">fpos_t</span> <span style="color: #6c3163; font-weight: bold;">mstream_seek</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *, <span style="color: #ba2f59; font-weight: bold;">fpos_t</span>, <span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>    <span style="color: #6c3163; font-weight: bold;">mstream_close</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #3a81c3;">)</span>;

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #6c3163; font-weight: bold;">type_to_flags</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">__restrict</span> type<span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">off_t</span> <span style="color: #6c3163; font-weight: bold;">find_end</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">buf</span>, <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">len</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">FILE</span> *
<span style="color: #6c3163; font-weight: bold;">fmemopen</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">__restrict</span> buf, <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">size</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">__restrict</span> type<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">memstream</span> *<span style="color: #715ab1;">ms</span>;
  <span style="color: #ba2f59; font-weight: bold;">FILE</span> *            <span style="color: #715ab1;">fp</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>size == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = EINVAL;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">NULL</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>ms = malloc<span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">memstream</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = ENOMEM;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">NULL</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>ms-&gt;flags = type_to_flags<span style="color: #67b11d;">(</span>type<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = EINVAL;
    free<span style="color: #2d9574;">(</span>ms<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">NULL</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>buf == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ms-&gt;flags &amp; <span style="color: #b1951d;">(</span>MS_READ | MS_WRITE<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #67b11d;">(</span>MS_READ | MS_WRITE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      errno = EINVAL;
      free<span style="color: #67b11d;">(</span>ms<span style="color: #67b11d;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">NULL</span>;
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ms-&gt;buf = malloc<span style="color: #b1951d;">(</span>size<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      errno = ENOMEM;
      free<span style="color: #67b11d;">(</span>ms<span style="color: #67b11d;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">NULL</span>;
    <span style="color: #2d9574;">}</span>
    ms-&gt;rsize = size;
    ms-&gt;flags |= MS_MYBUF;
    ms-&gt;curpos = <span style="color: #4e3163;">0</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    ms-&gt;buf   = buf;
    ms-&gt;rsize = size;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ms-&gt;curpos = find_end<span style="color: #67b11d;">(</span>ms-&gt;buf, ms-&gt;rsize<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
      ms-&gt;curpos = <span style="color: #4e3163;">0</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    ms-&gt;vsize = ms-&gt;curpos;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ms-&gt;flags &amp; MS_TRUNCAT<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    ms-&gt;vsize = <span style="color: #4e3163;">0</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    ms-&gt;vsize = size;
  <span style="color: #6c3163;">}</span>

  fp = funopen<span style="color: #6c3163;">(</span>ms, mstream_read, mstream_write, mstream_seek, mstream_close<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>fp == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_MYBUF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      free<span style="color: #67b11d;">(</span>ms-&gt;buf<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> fp;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">type_to_flags</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">__restrict</span> type<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">cp</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>         <span style="color: #715ab1;">flags</span> = <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>cp = type; *cp != <span style="color: #4e3163;">0</span>; cp++<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>*cp<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">case</span> <span style="color: #2d9574;">'r'</span>:
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
        flags |= MS_READ;
        <span style="color: #3a81c3; font-weight: bold;">break</span>;

      <span style="color: #3a81c3; font-weight: bold;">case</span> <span style="color: #2d9574;">'w'</span>:
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
        flags |= MS_WRITE | MS_TRUNCAT;
        <span style="color: #3a81c3; font-weight: bold;">break</span>;

      <span style="color: #3a81c3; font-weight: bold;">case</span> <span style="color: #2d9574;">'a'</span>:
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
        flags |= MS_APPEND;
        <span style="color: #3a81c3; font-weight: bold;">break</span>;

      <span style="color: #3a81c3; font-weight: bold;">case</span> <span style="color: #2d9574;">'+'</span>:
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags == <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
        flags |= MS_READ | MS_WRITE;
        <span style="color: #3a81c3; font-weight: bold;">break</span>;

      <span style="color: #3a81c3; font-weight: bold;">case</span> <span style="color: #2d9574;">'b'</span>:
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags == <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
        <span style="color: #3a81c3; font-weight: bold;">break</span>;

      <span style="color: #3a81c3; font-weight: bold;">default</span>:
        <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> flags;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">off_t</span>
<span style="color: #6c3163; font-weight: bold;">find_end</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">buf</span>, <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">len</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">off_t</span> <span style="color: #715ab1;">off</span> = <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>off &lt; len<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>off<span style="color: #67b11d;">]</span> == <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #3a81c3; font-weight: bold;">break</span>;
    off++;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> off;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">mstream_read</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">cookie</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">buf</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">len</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>               <span style="color: #715ab1;">nr</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">memstream</span> *<span style="color: #715ab1;">ms</span> = cookie;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #4e3163;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_READ<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = EBADF;
    <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ms-&gt;curpos &gt;= ms-&gt;vsize<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
  <span style="color: #6c3163;">}</span>

  nr = MIN<span style="color: #6c3163;">(</span>len, ms-&gt;vsize - ms-&gt;curpos<span style="color: #6c3163;">)</span>;
  memcpy<span style="color: #6c3163;">(</span>buf, ms-&gt;buf + ms-&gt;curpos, nr<span style="color: #6c3163;">)</span>;
  ms-&gt;curpos += nr;
  <span style="color: #3a81c3; font-weight: bold;">return</span> nr;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">mstream_write</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">cookie</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">buf</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">len</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>               <span style="color: #715ab1;">nw</span>, <span style="color: #715ab1;">off</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">memstream</span> *<span style="color: #715ab1;">ms</span> = cookie;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #4e3163;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; <span style="color: #67b11d;">(</span>MS_APPEND | MS_WRITE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = EBADF;
    <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    off = ms-&gt;vsize;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    off = ms-&gt;curpos;
  <span style="color: #6c3163;">}</span>

  nw = MIN<span style="color: #6c3163;">(</span>len, ms-&gt;rsize - off<span style="color: #6c3163;">)</span>;
  memcpy<span style="color: #6c3163;">(</span>ms-&gt;buf + off, buf, nw<span style="color: #6c3163;">)</span>;
  ms-&gt;curpos = off + nw;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ms-&gt;curpos &gt; ms-&gt;vsize<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    ms-&gt;vsize = ms-&gt;curpos;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>ms-&gt;flags &amp; <span style="color: #3a81c3;">(</span>MS_READ | MS_WRITE<span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span> == <span style="color: #b1951d;">(</span>MS_READ | MS_WRITE<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &amp;&amp;
        ms-&gt;vsize &lt; ms-&gt;rsize<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;vsize<span style="color: #67b11d;">)</span> = <span style="color: #4e3163;">0</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; <span style="color: #67b11d;">(</span>MS_WRITE | MS_APPEND<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &amp;&amp; <span style="color: #4e3163;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_READ<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;curpos &lt; ms-&gt;rsize<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;curpos<span style="color: #67b11d;">)</span> = <span style="color: #4e3163;">0</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
      *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;rsize - <span style="color: #4e3163;">1</span><span style="color: #67b11d;">)</span> = <span style="color: #4e3163;">0</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> nw;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">fpos_t</span>
<span style="color: #6c3163; font-weight: bold;">mstream_seek</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">cookie</span>, <span style="color: #ba2f59; font-weight: bold;">fpos_t</span> <span style="color: #715ab1;">pos</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">whence</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>               <span style="color: #715ab1;">off</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">memstream</span> *<span style="color: #715ab1;">ms</span> = cookie;

  <span style="color: #3a81c3; font-weight: bold;">switch</span> <span style="color: #6c3163;">(</span>whence<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">case</span> SEEK_SET:
      off = pos;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;

    <span style="color: #3a81c3; font-weight: bold;">case</span> SEEK_END:
      off = ms-&gt;vsize + pos;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;

    <span style="color: #3a81c3; font-weight: bold;">case</span> SEEK_CUR:
      off = ms-&gt;curpos + pos;
      <span style="color: #3a81c3; font-weight: bold;">break</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>off &lt; <span style="color: #4e3163;">0</span> || off &gt; ms-&gt;vsize<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = EINVAL;
    <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>
  ms-&gt;curpos = off;
  <span style="color: #3a81c3; font-weight: bold;">return</span> off;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">mstream_close</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">cookie</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">memstream</span> *<span style="color: #715ab1;">ms</span> = cookie;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>ms-&gt;flags &amp; MS_MYBUF<span style="color: #6c3163;">)</span> free<span style="color: #6c3163;">(</span>ms-&gt;buf<span style="color: #6c3163;">)</span>;
  free<span style="color: #6c3163;">(</span>ms<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgdd6e18a" class="outline-2">
<h2 id="orgdd6e18a">Chapter 6. System Data Files and Information</h2>
<div class="outline-text-2" id="text-orgdd6e18a">
</div>
<div id="outline-container-org59b6597" class="outline-3">
<h3 id="org59b6597">introduction</h3>
</div>
<div id="outline-container-org943e919" class="outline-3">
<h3 id="org943e919">Password File</h3>
<div class="outline-text-3" id="text-org943e919">
<p>
<code>man getpwuid</code>
</p>
</div>
</div>
<div id="outline-container-org624cbe8" class="outline-3">
<h3 id="org624cbe8">Shadow Passwords</h3>
<div class="outline-text-3" id="text-org624cbe8">
<p>
<b>On Linux 3.2.0 and Solaris 10,</b>
<code>man getspnam</code>
<b>On FreeBSD 8.0 and Mac OS X 10.6.8, there is no shadow password structure</b>
</p>
</div>
</div>
<div id="outline-container-orgfaaa119" class="outline-3">
<h3 id="orgfaaa119">Group File</h3>
<div class="outline-text-3" id="text-orgfaaa119">
<p>
<code>man getgrgid</code>
</p>
</div>
</div>
<div id="outline-container-orgf3593c2" class="outline-3">
<h3 id="orgf3593c2">Supplementary Group Ids</h3>
<div class="outline-text-3" id="text-orgf3593c2">
<p>
<code>man getgroups</code> <br />
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 29: </span>Example for get groups' info</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">grp.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">uuid/uuid.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">grpmax</span> = sysconf<span style="color: #6c3163;">(</span>_SC_NGROUPS_MAX<span style="color: #6c3163;">)</span>;
  <span style="color: #ba2f59; font-weight: bold;">gid_t</span> <span style="color: #715ab1;">grouplist</span><span style="color: #6c3163;">[</span>grpmax<span style="color: #6c3163;">]</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">group</span> *<span style="color: #715ab1;">grp</span> = <span style="color: #4e3163;">NULL</span>;

  getgroups<span style="color: #6c3163;">(</span>grpmax, grouplist<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">i</span> = <span style="color: #4e3163;">0</span>; i &lt; grpmax; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    grp = getgrgid<span style="color: #2d9574;">(</span>grouplist<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%d\t%s\n"</span>, grouplist<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, grp-&gt;gr_name<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgef23769" class="outline-3">
<h3 id="orgef23769">Implementation Differences</h3>
</div>
<div id="outline-container-orgec986a3" class="outline-3">
<h3 id="orgec986a3">Other Data Files</h3>
<div class="outline-text-3" id="text-orgec986a3">
<p>
at least three functions:
</p>
<ol class="org-ol">
<li>A get function that reads the next record, opening the file if necessary.</li>
<li>A set function that opens the file, if not already open, and rewinds the file.</li>
<li>An end entry that closes the data file.</li>
</ol>
</div>
</div>
<div id="outline-container-orgb748468" class="outline-3">
<h3 id="orgb748468">Login Accounting</h3>
<div class="outline-text-3" id="text-orgb748468">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">utmp</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">ut_line</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">8</span><span style="color: #6c3163;">]</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">tty line: "ttyh0", "ttyd0", "ttyp0", ... */</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">ut_name</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">8</span><span style="color: #6c3163;">]</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">login name */</span>
  <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">ut_time</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">seconds since Epoch */</span>
<span style="color: #3a81c3;">}</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org8eec094" class="outline-3">
<h3 id="org8eec094">System Identification</h3>
<div class="outline-text-3" id="text-org8eec094">
<p>
<code>man 3 uname</code>
<code>man 3 gethostname</code>
</p>
</div>
</div>
<div id="outline-container-orge300752" class="outline-3">
<h3 id="orge300752">Time and Date Routines</h3>
<div class="outline-text-3" id="text-orge300752">
<p>
<code>man 3 time</code>
<code>man 3 clock_gettime</code>
<code>man 3 gmtime</code>
<code>man 3 strftime</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 30: </span>Figure 6.11 Using the strftime function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">time_t</span>     <span style="color: #715ab1;">t</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">tm</span> *<span style="color: #715ab1;">tmp</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>       <span style="color: #715ab1;">buf1</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">16</span><span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>       <span style="color: #715ab1;">buf2</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">64</span><span style="color: #6c3163;">]</span>;

  time<span style="color: #6c3163;">(</span>&amp;t<span style="color: #6c3163;">)</span>;
  tmp = localtime<span style="color: #6c3163;">(</span>&amp;t<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>strftime<span style="color: #2d9574;">(</span>buf1, <span style="color: #4e3163;">16</span>, <span style="color: #2d9574;">"time and date: %r, %a %b %d, %Y"</span>, tmp<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buffer length 16 is too small\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, buf1<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>strftime<span style="color: #2d9574;">(</span>buf2, <span style="color: #4e3163;">64</span>, <span style="color: #2d9574;">"time and date: %r, %a %b %d, %Y"</span>, tmp<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buffer length 64 is too small\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, buf2<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
<p>
<code>man 3 strptim</code>
</p>
</div>
</div>
<div id="outline-container-org72ce8c8" class="outline-3">
<h3 id="org72ce8c8">Summary</h3>
<div class="outline-text-3" id="text-org72ce8c8">
<p>
<b>Exercises</b>
</p>
<ol class="org-ol">
<li>On Mac OS, I can't get it <br />
On Linux, use <code>getsnam</code> group functions</li>
<li>#+caption: ex2</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">shadow.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">spwd</span> *<span style="color: #715ab1;">ptr</span>;

  ptr = getspent<span style="color: #6c3163;">()</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"password: %s\n"</span>, ptr-&gt;sp_pwdp<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>#+caption: ex3</li>
</ol>
<div class="org-src-container">
<pre class="src src-c,">#include &lt;stdio.h&gt;
#include &lt;sys/utsname.h&gt;

int main()
{
  struct utsname name;
  uname(&amp;name);
  printf("%s %s %s %s %s \n", name.sysname,  name.nodename,  name.release,  name.version, name.machine);
}
</pre>
</div>
<ol class="org-ol">
<li>32-bit time: <code>1970 + (2^{31}/60/60/24/365)</code> <br />
after pass : <code>1970 - (2^{31}/60/60/24/365)</code></li>
<li>#+caption: ex5</li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span>   <span style="color: #715ab1;">tbuf</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">64</span><span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">time_t</span> <span style="color: #715ab1;">t</span>;

  time<span style="color: #6c3163;">(</span>&amp;t<span style="color: #6c3163;">)</span>;

  strftime<span style="color: #6c3163;">(</span>tbuf, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>tbuf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%a %b %d %T %Z %Y"</span>, localtime<span style="color: #2d9574;">(</span>&amp;t<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s\n"</span>, tbuf<span style="color: #6c3163;">)</span>;

  setenv<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"TZ"</span>, <span style="color: #2d9574;">"dkladjlkjklasdj"</span>, <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
  strftime<span style="color: #6c3163;">(</span>tbuf, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>tbuf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%a %b %d %T %Z %Y"</span>, localtime<span style="color: #2d9574;">(</span>&amp;t<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s\n"</span>, tbuf<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgadff71e" class="outline-2">
<h2 id="orgadff71e">Chapter 7. Process Environment</h2>
<div class="outline-text-2" id="text-orgadff71e">
</div>
<div id="outline-container-org798133d" class="outline-3">
<h3 id="org798133d">7.1 Introduction</h3>
</div>
<div id="outline-container-orgf750182" class="outline-3">
<h3 id="orgf750182">7.2 main Function</h3>
<div class="outline-text-3" id="text-orgf750182">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf9df433" class="outline-3">
<h3 id="orgf9df433">7.3 Process Termination</h3>
<div class="outline-text-3" id="text-orgf9df433">
<p>
There are eight ways for a process to terminate.
Normal termination occurs in five ways:
</p>
<ol class="org-ol">
<li>Return from main</li>
<li>Calling <code>exit</code></li>
<li>Calling <code>_exit</code> or <code>_Exit</code></li>
<li>Return of the last thread from its start routine (Section 11.5)</li>
<li>Calling pthread_exit (Section 11.5) from the last thread</li>
</ol>


<p>
Abnormal termination occurs in three ways
</p>
<ol class="org-ol">
<li>Calling abort</li>
<li>Receipt of a signal</li>
<li>Response of the last thread to a cancellation request</li>
</ol>
</div>
<div id="outline-container-orgcdad77c" class="outline-4">
<h4 id="orgcdad77c">Exit Functions</h4>
<div class="outline-text-4" id="text-orgcdad77c">
<p>
<code>man 3 exit</code>
<code>man 2 _exit</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">exit</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">1. call the functions registered with atexit(3) function, in the reverse order of their registration</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">2. Flush all open output streams</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">3. close all open streams</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">4. unlink all files created with the tmpfile functions</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">_Exit</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">terminates without calling functions registered with atexit(3),</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">may or my not perform the other actions listed</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">_exit</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">The _exit() function terminates a process, with the following consequences:</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">o   All of the descriptors that were open in the calling process are closed.  This may entail delays; for example, waiting for output to drain.  A process in this state may not be</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">killed, as it is already dying.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">o   If the parent process of the calling process has an outstanding wait call or catches the SIGCHLD signal, it is notified of the calling process's termination; the status is set as</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">defined by wait(2).</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">o   The parent process-ID of all of the calling process's existing child processes are set to 1; the initialization process (see the DEFINITIONS section of intro(2)) inherits each of</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">these processes.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">o   If the termination of the process causes any process group to become orphaned (usually because the parents of all members of the group have now exited; see ``orphaned process</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">group'' in intro(2)), and if any member of the orphaned group is stopped, the SIGHUP signal and the SIGCONT signal are sent to all members of the newly-orphaned process group.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">o   If the process is a controlling process (see intro(2)), the SIGHUP signal is sent to the foreground process group of the controlling terminal.  All current access to the control-</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">//     </span><span style="color: #2aa1ae; background-color: #ecf3ec;">ling terminal is revoked.</span>
</pre>
</div>
<p>
<code>_exit</code> does not perform any ﬂushing of standard I/O buffers.
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<pre class="src src-c">
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 31: </span>Figure 7.1 Classic C program</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span>* <span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"hello world\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org8a5530a" class="outline-4">
<h4 id="org8a5530a"><code>atexit</code> Function</h4>
<div class="outline-text-4" id="text-org8a5530a">
<p>
<code>man 3 atexit</code>
The <code>exit</code> function calls these functions in reverse order of their registration.
</p>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 32: </span>Figure 7.3 Example of exit handlers</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">my_exit1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">my_exit2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit2<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit2: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit1<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit1: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit1<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit1: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"main is done\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">my_exit1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"first exit handler \n"</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">my_exit2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"second exit handler\n"</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org884a376" class="outline-4">
<h4 id="org884a376">Commond-Line Arguments</h4>
<div class="outline-text-4" id="text-org884a376">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 33: </span>Figure 7.4 Echo all command-line arguments to standard output</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>
<span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">i</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; argc; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">echo all command-line args */</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"argv[%d]: %s\n"</span>, i, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org6ec376e" class="outline-3">
<h3 id="org6ec376e">7.5 Environment List</h3>
<div class="outline-text-3" id="text-org6ec376e">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">extern</span> <span style="color: #ba2f59; font-weight: bold;">char</span> **<span style="color: #715ab1;">environ</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orge17ecbf" class="outline-3">
<h3 id="orge17ecbf">7.6 Memory Layout of a C Program</h3>
<div class="outline-text-3" id="text-orge17ecbf">
<p>
Historically, a C program has been composed of the following pieces:
</p>
<ul class="org-ul">
<li>Text segment: consisting of the machine instructions that the CPU executes.</li>
<li><p>
Initilized data segment, usually called simply the data segment, <br />
containing variables that are specifically initialized in the program.<br />
For example:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">maxcount</span>=<span style="color: #4e3163;">99</span>;
</pre>
</div></li>
<li><p>
Uninitilized data segment, often called the “bss” segment, <br />
named after an ancient assembler operator that stood for “block started by symbol.”
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">sum</span><span style="color: #3a81c3;">[</span><span style="color: #4e3163;">1024</span><span style="color: #3a81c3;">]</span>;
</pre>
</div></li>
<li>Stack, where automatic variables are stored, <br />
along with information that is saved each time a function is called.</li>
<li><p>
Heap, where dynamic memory allocation usually takes place.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163; font-weight: bold;">malloc</span><span style="color: #3a81c3;">()</span>;
</pre>
</div>
<p>
<a href="Chapter07/Figure7.6.png">Figure 7.6 Typical memory arrangement</a>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orga82270c" class="outline-3">
<h3 id="orga82270c">7.7 Shared Libraries</h3>
<div class="outline-text-3" id="text-orga82270c">
<p>
without shared libraries
</p>
<div class="org-src-container">
<pre class="src src-bash">gcc -static hello.c
size a.out
text     data     bss     dec     hex filename
<span style="color: #4e3163;">723103</span>     <span style="color: #4e3163;">7284</span>    <span style="color: #4e3163;">6392</span>  <span style="color: #4e3163;">736779</span>   b3e0b a.out
</pre>
</div>
<p>
use shared libraries, the text and data size are greatly decreased
</p>
<div class="org-src-container">
<pre class="src src-bash">gcc hello.c
size a.out
text     data     bss     dec     hex filename
<span style="color: #4e3163;">1173</span>      <span style="color: #4e3163;">552</span>       <span style="color: #4e3163;">8</span>    <span style="color: #4e3163;">1733</span>     <span style="color: #4e3163;">6c5</span> a.out
</pre>
</div>
</div>
</div>
<div id="outline-container-org4151cfa" class="outline-3">
<h3 id="org4151cfa">7.8 Memory Allocation</h3>
<div class="outline-text-3" id="text-org4151cfa">
<p>
<code>man 3 malloc</code>
</p>
<ol class="org-ol">
<li><code>malloc</code>, allocates specified number of bytes of memory without initialized</li>
<li><code>calloc</code>, allocates specified number of bytes of memroy with initializing to 0</li>
<li><code>realloc</code>, increase or decrease the size of previous allocated area, the increased area was not initialized</li>
</ol>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">malloc</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">size</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">calloc</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">nobj</span>, <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">size</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">realloc</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">ptr</span>, <span style="color: #ba2f59; font-weight: bold;">size_t</span> <span style="color: #715ab1;">newsize</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">free</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span>*<span style="color: #715ab1;">ptr</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>


<ul class="org-ul">
<li>Alternative Memory Allocators
<ul class="org-ul">
<li><code>jemalloc</code> <br />
designed to scale well when used with multithreaded applications running on multiprocessor systems.</li>
<li><code>TCMalloc</code> <br />
for high performance, scalability, and memory efficiency.</li>
<li><code>alloca</code> Function <br />
alloc memmory from stack, instaead of heap, so we don't have to free the space;</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org4674ca4" class="outline-3">
<h3 id="org4674ca4">7.9 Environment Variable</h3>
<div class="outline-text-3" id="text-org4674ca4">
<p>
<code>man 3 getenv</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163; font-weight: bold;">getenv</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">putenv</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">setenv</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">value</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">rewrite</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">unsetenv</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>

<p>
<b>malloc</b>
</p>
</div>
</div>

<div id="outline-container-orgd5f0654" class="outline-3">
<h3 id="orgd5f0654">7.10 <code>setjmp</code> and <code>longjmp</code> Functions</h3>
<div class="outline-text-3" id="text-orgd5f0654">
<ul class="org-ul">
<li><b>useful for dealing errors and interrupts</b></li>

<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 34: </span>Figure 7.9 Typical program skeleton for command-processing</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">TOK_ADD</span> <span style="color: #4e3163;">5</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">do_line</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span>*<span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">cmd_add</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #6c3163; font-weight: bold;">get_token</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">line</span><span style="color: #6c3163;">[</span>MAXLINE<span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>fgets<span style="color: #2d9574;">(</span>line, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    do_line<span style="color: #2d9574;">(</span>line<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">char</span>* <span style="color: #715ab1;">tok_ptr</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">global pointer for get_token() */</span>
<span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">tok</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">do_line</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span>* <span style="color: #715ab1;">ptr</span><span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">process one line of input */</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">cmd</span>;

  tok_ptr = ptr;
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>cmd = get_token<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>cmd<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">one case for each command */</span>
      <span style="color: #3a81c3; font-weight: bold;">case</span> TOK_ADD:
        cmd_add<span style="color: #67b11d;">()</span>;
        <span style="color: #3a81c3; font-weight: bold;">break</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">cmd_add</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">token</span>;

  token = get_token<span style="color: #6c3163;">()</span>;
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">reset of processing for this command */</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">get_token</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fetch next token from line pointed to by tok_ptr */</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> tok++;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>


<p>
<code>man 3 setjmp</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 35: </span>Figure 7.13 Effect of longjmp on various type of variables</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">f1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span>, <span style="color: #ba2f59; font-weight: bold;">int</span>, <span style="color: #ba2f59; font-weight: bold;">int</span>, <span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">f2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">jmp_buf</span> <span style="color: #715ab1;">jmpbuffer</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>     <span style="color: #715ab1;">globval</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>          <span style="color: #715ab1;">autoval</span>;
  <span style="color: #3a81c3; font-weight: bold;">register</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">regival</span>;
  <span style="color: #3a81c3; font-weight: bold;">volatile</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">volaval</span>;
  <span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">statval</span>;

  globval = <span style="color: #4e3163;">1</span>;
  autoval = <span style="color: #4e3163;">2</span>;
  regival = <span style="color: #4e3163;">3</span>;
  volaval = <span style="color: #4e3163;">4</span>;
  statval = <span style="color: #4e3163;">5</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>setjmp<span style="color: #2d9574;">(</span>jmpbuffer<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"after longjmp:\n"</span><span style="color: #2d9574;">)</span>;
    printf<span style="color: #2d9574;">(</span>
        <span style="color: #2d9574;">"globval = %d, autoval = %d, regival = %d,"</span>
        <span style="color: #2d9574;">" volaval = %d, statval = %d\n"</span>,
        globval,
        autoval,
        regival,
        volaval,
        statval<span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   * Change variables after setjmp, but before longjmp.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   */</span>
  globval = <span style="color: #4e3163;">95</span>;
  autoval = <span style="color: #4e3163;">96</span>;
  regival = <span style="color: #4e3163;">97</span>;
  volaval = <span style="color: #4e3163;">98</span>;
  statval = <span style="color: #4e3163;">99</span>;

  f1<span style="color: #6c3163;">(</span>autoval, regival, volaval, statval<span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">never returns */</span>
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">f1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">i</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">j</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">k</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">l</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"in                     f1():\n"</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span>
      <span style="color: #2d9574;">"globval = %d, autoval = %d, regival = %d,"</span>
      <span style="color: #2d9574;">" volaval = %d, statval = %d\n"</span>,
      globval,
      i,
      j,
      k,
      l<span style="color: #6c3163;">)</span>;
  f2<span style="color: #6c3163;">()</span>;
<span style="color: #3a81c3;">}</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">f2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  longjmp<span style="color: #6c3163;">(</span>jmpbuffer, <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li><b>Automatic, Register and Volatile Variables</b> <br />
Most implementations do not try to roll back these automatic variables and register variables, but the standards say only that their values are indeterminate</li>
</ul>


<p>
<b>Potential Problem with Automatic Variables</b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 36: </span>Figure 7.14 Incorrect usage of an automatic variable</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     incorrect_usage.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-09-19</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Incorrect usage of an automatic variable</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">FILE</span>* <span style="color: #6c3163; font-weight: bold;">open_data</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">FILE</span>* <span style="color: #715ab1;">fp</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>  <span style="color: #715ab1;">databuf</span><span style="color: #6c3163;">[</span>BUFSIZ<span style="color: #6c3163;">]</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">setvbuf makes this the stdio buffer */</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"datafile"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>setvbuf<span style="color: #2d9574;">(</span>fp, databuf, _IOLBF, BUFSIZ<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">NULL</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> fp;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<blockquote>
<p>
The problem is that when open_data returns, the space it used on the stack will be used by the stack frame for the next function that is called. But the standard I/O library will still be using that portion of memory for its stream buffer. Chaos is sure to result. To correct this problem, the array databuf needs to be allocated from global memory, either statically (static or extern) or dynamically (one of the alloc functions)
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org37fe4b9" class="outline-3">
<h3 id="org37fe4b9"><code>getrlimit</code> and <code>setrlimit</code> Functions</h3>
<div class="outline-text-3" id="text-org37fe4b9">
<p>
<code>man 3 getrlimit</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 37: </span>Figure 7.16 print the current resource limits</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#define</span> <span style="color: #6c3163; font-weight: bold;">doit</span><span style="color: #3a81c3;">(</span><span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span> pr_limits<span style="color: #3a81c3;">(</span>#name, name<span style="color: #3a81c3;">)</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pr_limits</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *, <span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
<span style="color: #6c3163;">#ifdef</span> RLIMIT_AS
  doit<span style="color: #6c3163;">(</span>RLIMIT_AS<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

  doit<span style="color: #6c3163;">(</span>RLIMIT_CORE<span style="color: #6c3163;">)</span>;
  doit<span style="color: #6c3163;">(</span>RLIMIT_CPU<span style="color: #6c3163;">)</span>;
  doit<span style="color: #6c3163;">(</span>RLIMIT_DATA<span style="color: #6c3163;">)</span>;
  doit<span style="color: #6c3163;">(</span>RLIMIT_FSIZE<span style="color: #6c3163;">)</span>;

<span style="color: #6c3163;">#ifdef</span> RLIMIT_MEMLOCK
  doit<span style="color: #6c3163;">(</span>RLIMIT_MEMLOCK<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#ifdef</span> RLIMITS_MSGQUEUE
  doit<span style="color: #6c3163;">(</span>RLIMITS_MSGQUEUE<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

  doit<span style="color: #6c3163;">(</span>RLIMIT_NOFILE<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">rlimit</span> <span style="color: #715ab1;">r</span>;
  memset<span style="color: #6c3163;">(</span>&amp;r, <span style="color: #4e3163;">0</span>, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>r<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  getrlimit<span style="color: #6c3163;">(</span>RLIMIT_NOFILE, &amp;r<span style="color: #6c3163;">)</span>;
  r.rlim_cur = <span style="color: #4e3163;">4096</span>;
  setrlimit<span style="color: #6c3163;">(</span>RLIMIT_NOFILE, &amp;r<span style="color: #6c3163;">)</span>;

  doit<span style="color: #6c3163;">(</span>RLIMIT_NOFILE<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#ifdef</span> RLIMIT_NPTS
  doit<span style="color: #6c3163;">(</span>RLIMIT_NPTS<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#ifdef</span> RLIMIT_RSS
  doit<span style="color: #6c3163;">(</span>RLIMIT_RSS<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#ifdef</span> RLIMIT_SBSIZE
  doit<span style="color: #6c3163;">(</span>RLIMIT_SBSIZE<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#ifdef</span> RLIMIT_SIGPENDING
  doit<span style="color: #6c3163;">(</span>RLIMIT_SIGPENDING<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

  doit<span style="color: #6c3163;">(</span>RLIMIT_STACK<span style="color: #6c3163;">)</span>;

<span style="color: #6c3163;">#ifdef</span> RLIMIT_SWAP
  doit<span style="color: #6c3163;">(</span>RLIMIT_SWAP<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#ifdef</span> RLIMIT_VMEM
  doit<span style="color: #6c3163;">(</span>RLIMIT_VMEM<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#endif</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pr_limits</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">resource</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">rlimit</span>      <span style="color: #715ab1;">limit</span>;
  <span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">lim</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>getrlimit<span style="color: #2d9574;">(</span>resource, &amp;limit<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"getrlimit error for %s"</span>, name<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%-14s "</span>, name<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>limit.rlim_cur == RLIM_INFINITY<span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"(infinite) "</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    lim = limit.rlim_cur;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%10lld "</span>, lim<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>limit.rlim_max == RLIM_INFINITY<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"(infinite)"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    lim = limit.rlim_max;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%10lld"</span>, lim<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  putchar<span style="color: #6c3163;">(</span><span style="color: #2d9574;">'\n'</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgb25e653" class="outline-3">
<h3 id="orgb25e653">Summary</h3>
<div class="outline-text-3" id="text-orgb25e653">
<p>
<b>Exercises</b>
</p>
<ol class="org-ol">
<li>the length of "hello, world"</li>
<li><code>man 3 exit</code></li>
<li>Nope</li>
<li><b>for NULL usage</b></li>
<li><code>typedef void Exitfunc(void);</code> <br />
<code>int atexit(Exitfunc *func);</code></li>
<li>Yep, not sure</li>
<li>the heap and stack aren't allocated before applying</li>
<li>a.out include symbol info</li>
<li>standard I/O library was copied</li>
<li>Nope. num in heap</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgc337870" class="outline-2">
<h2 id="orgc337870">Chapter 8. Process Control</h2>
<div class="outline-text-2" id="text-orgc337870">
</div>
<div id="outline-container-orgf4edc82" class="outline-3">
<h3 id="orgf4edc82">8.1 Introduction</h3>
</div>
<div id="outline-container-orge83b954" class="outline-3">
<h3 id="orge83b954">8.2 Process Identifiers</h3>
<div class="outline-text-3" id="text-orge83b954">
<p>
Process ID 0 is usually the scheduler process and is often know as <i>swapper</i>.
Process ID 1 is usually the <b>init</b> process.
responsible for bring up a UNIX system after the kernel has been bootstrapped
Process ID 2 is pagedaemon.
responsible for supporting paging of virtual memory system.
</p>

<p>
<code>man 2 getpid</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span> pid_t getpid<span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: process ID of calling process</span>

<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">getppid</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: parent process ID of calling process</span>

<span style="color: #ba2f59; font-weight: bold;">uid_t</span> <span style="color: #6c3163; font-weight: bold;">getuid</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: real user ID of calling process</span>

<span style="color: #ba2f59; font-weight: bold;">uid_t</span> <span style="color: #6c3163; font-weight: bold;">geteuid</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: effective user ID of calling process</span>

<span style="color: #ba2f59; font-weight: bold;">gid_t</span> <span style="color: #6c3163; font-weight: bold;">getgid</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: real group ID of calling process</span>

<span style="color: #ba2f59; font-weight: bold;">gid_t</span> <span style="color: #6c3163; font-weight: bold;">getegid</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: effective group ID of calling process</span>
</pre>
</div>

<blockquote>
<p>
Note that none of these functions has an error return.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgc4e8d37" class="outline-3">
<h3 id="orgc4e8d37">8.3 <code>fork</code> Function</h3>
<div class="outline-text-3" id="text-orgc4e8d37">
<p>
<code>man 3 fork</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">fork</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 in child, process ID of child in parent, &#8722;1 on error</span>
</pre>
</div>


<blockquote>
<p>
called once but return twice.
</p>

<p>
return value in child is 0, whereas the return value in the parent is the process ID of the new child
</p>

<p>
the child gets a copy of the parent’s data space, heap, and stack, parents and child do not share memmory
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 38: </span>Figure 8.1 Example of fork function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #715ab1;">globvar</span> = <span style="color: #4e3163;">6</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">external variable in initialized data */</span>
<span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #3a81c3;">[]</span>   = <span style="color: #2d9574;">"a write to stdout\n"</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">var</span>;
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  var = <span style="color: #4e3163;">88</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>write<span style="color: #2d9574;">(</span>STDOUT_FILENO, buf, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span> - <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span> != <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span> - <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"before fork\n"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    globvar++; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child */</span>
    var++;     <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">modify variables */</span>
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    sleep<span style="color: #2d9574;">(</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
<p>
<b>changes to variables in a child process do not affect the value of the variables in the parent process.</b>
</p>
<ul class="org-ul">
<li>File Sharing
handling the descriptors after a fork.
<ol class="org-ol">
<li>The parent waits for the child to complete.</li>
<li>Both the parent and the child go their own ways. after fork, close needless descriptors(<b>socket</b>)</li>
</ol></li>
</ul>


<ul class="org-ul">
<li>inherits:
<ul class="org-ul">
<li>Real user ID, real group ID, effective user ID, and effective group ID</li>
<li>Supplementary group IDs</li>
<li>Process group ID</li>
<li>Session ID</li>
<li>Controlling terminal</li>
<li>The set-user-ID and set-group-ID ﬂags</li>
<li>Current working directory</li>
<li>Root directory</li>
<li>File mode creation mask</li>
<li>Signal mask and dispositions</li>
<li>The close-on-exec ﬂag for any open file descriptors</li>
<li>Environment</li>
<li>Attached shared memory segments</li>
<li>Memory mappings</li>
<li>Resource limits</li>
</ul></li>

<li>differences
<ul class="org-ul">
<li>return value</li>
<li>process id</li>
<li>parent id</li>
<li>child's tms_utime, tms_stime, tms_cutime, tms_cstime set to 0</li>
<li>parent's file locks are not inherited</li>
<li>pending alarms are cleared for the child</li>
<li>pending signals set is set to empty for child</li>
</ul></li>

<li><p>
There are two uses for fork:
</p>
<blockquote>
<ol class="org-ol">
<li>When a process wants to duplicate itself so that the parent and the child can each execute different sections of code at the same time.</li>
<li>When a process wants to execute a different program.</li>
</ol>
</blockquote></li>
</ul>
</div>
</div>
<div id="outline-container-orgd57f63c" class="outline-3">
<h3 id="orgd57f63c">8.4 <code>vfork</code> Function</h3>
<div class="outline-text-3" id="text-orgd57f63c">
<blockquote>
<p>
just like fork, without copying the address space of the parent into the child, as the child won’t reference that address space
</p>

<p>
the child runs in the address space of the parent until it calls either exec or exit.
</p>

<p>
<b>vfork guarantees that the child runs first, until the child calls exec or exit.</b>
</p>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 39: </span>Figure 8.3 Example of vfork function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">globvar</span> = <span style="color: #4e3163;">6</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">external variable in initialized data */</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">var</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">automatic variable on the stack */</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  var = <span style="color: #4e3163;">88</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">we don't flush stdio */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child */</span>
    globvar++;           <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">modify parent's variables */</span>
    var++;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child terminaltes */</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent continues here */</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org6439324" class="outline-3">
<h3 id="org6439324">8.5 <code>exit</code> Function</h3>
<div class="outline-text-3" id="text-org6439324">
<blockquote>
<p>
As we described in Section 7.3, a process can terminate normally in five ways:
</p>
<ol class="org-ol">
<li>Executing a return from the main function.</li>
<li>Calling the exit function.</li>
<li>Calling the _exit or _Exit function. <b>terminate without running exit handlers or signal handlers.</b></li>
<li>Executing a return from the start routine of the last thread in the process.</li>
<li>Calling the pthread_exit function from the last thread in the process.</li>
</ol>
</blockquote>

<blockquote>
<p>
The three forms of abnormal termination are as follows:
</p>
<ol class="org-ol">
<li>Calling abort. generates <b>SIGABRT</b> signal</li>
<li>When the process receives certain signals.</li>
<li>The last thread responds to a cancellation request.</li>
</ol>
</blockquote>

<blockquote>
<ul class="org-ul">
<li>In UNIX System terminology, a process that has terminated, but whose parent has not yet waited for it, is called a zombie.</li>

<li>The ps(1) command prints the state of a zombie process as Z.</li>
</ul>
</blockquote>
</div>
</div>
<div id="outline-container-org520f797" class="outline-3">
<h3 id="org520f797">8.6 <code>wait</code> and <code>waitpid</code> Functions</h3>
<div class="outline-text-3" id="text-org520f797">
<blockquote>
<p>
we need to be aware that a process that calls wait or waitpid can
</p>
<ul class="org-ul">
<li>Block, if all of its children are still running</li>
<li>Return immediately with the termination status of a child, if a child has terminated and is waiting for its termination for its termination status to be fetched</li>
<li>Return immediately with an error, if it doesn't have any child processes</li>
</ul>
</blockquote>


<p>
<code>man 2 wait</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">wait</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">statloc</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #6c3163; font-weight: bold;">waitpid</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">statloc</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">options</span><span style="color: #3a81c3;">)</span>;

Both <span style="color: #3a81c3; font-weight: bold;">return</span>: process ID <span style="color: #3a81c3; font-weight: bold;">if</span> OK, <span style="color: #4e3163;">0</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">see</span> <span style="color: #715ab1;">later</span><span style="color: #3a81c3;">)</span>, or -<span style="color: #4e3163;">1</span> on error
</pre>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 40: </span>Figure 8.5 Print a description of the exit status</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pr_exit</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>WIFEXITED<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"normal termination, exit status = %d\n"</span>, WEXITSTATUS<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>WIFSIGNALED<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"abnormal termination, sginal number = %d%s\n"</span>,
           WTERMSIG<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span>,
           WCOREDUMP<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span> ? <span style="color: #2d9574;">" (core file generated)"</span> : <span style="color: #2d9574;">""</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>WIFSTOPPED<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"child stopped, signal number = %d\n"</span>, WSTOPSIG<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 41: </span>Figure 8.6 Demonstrate various exit status</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">status</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child */</span>
    exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">7</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #6c3163;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">wait for child */</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    abort<span style="color: #6c3163;">()</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    status /= <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<p>
The waitpid function provides three features that aren’t provided by the wait function.
</p>
<ol class="org-ol">
<li>The waitpid function lets us wait for one particular process, whereas the wait function returns the status of any terminated child.</li>
<li>The waitpid function provides a nonblocking version of wait.</li>
<li>The waitpid function provides support for job control with the WUNTRACED and WCONTINUED options.</li>
</ol>
</blockquote>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 42: </span>Figure 8.8 Avoid zombie processes by calling fork twice</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">first child */</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid &gt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>
      exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent from second fork == first child */</span>

    <span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     * We're the second child; our parent becomes init as soon as</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     * our real parent calls exit() in the statement above.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     * Here's where we'd continue executing, knowing that when we're done,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     * init will reap our status.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">     */</span>
    sleep<span style="color: #2d9574;">(</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span>;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"second child, parent pid = %ld\n"</span>, <span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> != pid<span style="color: #6c3163;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">wait for first child */</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   * We're the parent (the original process); we continue executing,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   * knowing that we're not the parent of the second child</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   */</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgaf5b2b9" class="outline-3">
<h3 id="orgaf5b2b9">8.7 <code>waitid</code> Function</h3>
<div class="outline-text-3" id="text-orgaf5b2b9">
<p>
<code>man 2 waitid</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span> <span style="color: #ba2f59; font-weight: bold;">int</span> waitid<span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">idtype_t</span> <span style="color: #715ab1;">idtype</span>, <span style="color: #ba2f59; font-weight: bold;">id_t</span> <span style="color: #715ab1;">id</span>, <span style="color: #ba2f59; font-weight: bold;">siginfo_t</span> *<span style="color: #715ab1;">infop</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">options</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK, &#8722;1 on error</span>
</pre>
</div>
<p>
(OS X can't get the info, but the function is valid)
</p>
</div>
</div>
<div id="outline-container-org8dd3bc2" class="outline-3">
<h3 id="org8dd3bc2">8.8 <code>wait3</code> and <code>wait4</code> Functions</h3>
<div class="outline-text-3" id="text-org8dd3bc2">
<p>
<code>man 2 wait3</code>
</p>
</div>
</div>
<div id="outline-container-orgbcdf09b" class="outline-3">
<h3 id="orgbcdf09b">8.9 Race Conditions</h3>
<div class="outline-text-3" id="text-orgbcdf09b">
<p>
<b>Avoid race by signal</b>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 43: </span>Figure 8.12 Program with a race condition</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">charatatime</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork_ error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">charatatime</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">ptr</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">c</span>;

  setbuf<span style="color: #6c3163;">(</span>stdout, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">set unbuffered */</span>
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>ptr = str; <span style="color: #2d9574;">(</span>c = *ptr++<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span>;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">usleep(100);</span>
    putc<span style="color: #2d9574;">(</span>c, stdout<span style="color: #2d9574;">)</span>;
    <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">putchar(c);</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 44: </span>Figure 8.13 Modification of Figure 8.12 to avoid race condition</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">charatatime</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  TELL_WAIT<span style="color: #6c3163;">()</span>;

<span style="color: #6c3163;">#if</span> <span style="color: #4e3163;">1</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    WAIT_PARENT<span style="color: #2d9574;">()</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent goes first */</span>
    charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
    TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
    TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
    WAIT_CHILD<span style="color: #2d9574;">()</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #6c3163;">#else</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
    TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    WAIT_CHILD<span style="color: #2d9574;">()</span>;
    charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #6c3163;">#endif</span>

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">charatatime</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">ptr</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">c</span>;

  setbuf<span style="color: #6c3163;">(</span>stdout, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">set unbuffered */</span>
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>ptr = str; <span style="color: #2d9574;">(</span>c = *ptr++<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span>;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    usleep<span style="color: #2d9574;">(</span><span style="color: #4e3163;">100</span><span style="color: #2d9574;">)</span>;
    putc<span style="color: #2d9574;">(</span>c, stdout<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4d97b4e" class="outline-3">
<h3 id="org4d97b4e">8.10 <code>exec</code> Functions</h3>
<div class="outline-text-3" id="text-org4d97b4e">
<p>
<code>man 3 exec</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">execl</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">pathname</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">arg0</span>, ... <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(char *)0 */</span> <span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">execv</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">pathname</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">execle</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">pathname</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">arg0</span>, ...
           <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(char *)0, char *const envp[] */</span> <span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">execve</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">pathname</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #715ab1;">envp</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">execlp</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">filename</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">arg0</span>, ... <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">(char *)0 */</span> <span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">execvp</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">filename</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">fexecve</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #715ab1;">envp</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
<p>
Returns: All seven return: −1 on error, no return on success
</p>


<blockquote>
<p>
The first difference in these functions is that the first four take a pathname argument, the next two take a filename argument, and the last one takes a file descriptor argument. When a filename argument is specified,
</p>
<ul class="org-ul">
<li>If filename contains a slash, it is taken as a pathname.</li>
<li>Otherwise, the executable file is searched for in the directories specified by the <b>PATH</b> environment variable.</li>
</ul>
</blockquote>


<p>
<code>execlp</code> and <code>execvp</code> assume <b>link</b> as a <b>shell script</b>, and try to invoke <code>/bin/sh</code> with <b>filename</b>
</p>


<blockquote>
<p>
The letter <b>p</b> means that the function takes a filename argument and uses the PATH environment variable to find the executable file
The letter <b>l</b> means that the function takes a list of arguments and is mutually exclusive
The letter <b>v</b>, means that it takes an argv[] vector.
Finally, the letter <b>e</b> means that the function takes an envp[] array instead of using the current environment.
</p>
</blockquote>



<div class="figure">
<p><img src="Chapter08/Figure8.14.png" alt="Figure8.14.png" />
</p>
<p><span class="figure-number">Figure 1: </span>Figure 8.14 Differences among the seven exec functions</p>
</div>


<div class="figure">
<p><img src="Chapter08/Figure8.15.png" alt="Figure8.15.png" />
</p>
<p><span class="figure-number">Figure 2: </span>Figure 8.15 Relationship of the seven exec functions</p>
</div>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 45: </span>Figure 8.16 Example of exec functions</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">env_init</span><span style="color: #3a81c3;">[]</span> = <span style="color: #3a81c3;">{</span><span style="color: #2d9574;">"USER=unknown"</span>, <span style="color: #2d9574;">"PATH=/tmp"</span>, <span style="color: #4e3163;">NULL</span><span style="color: #3a81c3;">}</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">specify pathname, specify environment */</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execle<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"echo"</span>,
               <span style="color: #2d9574;">"echoall"</span>,
               <span style="color: #2d9574;">"myarg1"</span>,
               <span style="color: #2d9574;">"MY ARG2"</span>,
               <span style="color: #b1951d;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #4e3163;">0</span>,
               env_init<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"execle error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">specify filename, inherit environment */</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execlp<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"echo"</span>, <span style="color: #2d9574;">"echoall"</span>, <span style="color: #2d9574;">"only 1 arg"</span>, <span style="color: #b1951d;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>
      err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"execlp error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 46: </span>Figure 8.17 Echo all command-line arguments and all environment strings</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>           <span style="color: #715ab1;">i</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> **       <span style="color: #715ab1;">ptr</span>;
  <span style="color: #3a81c3; font-weight: bold;">extern</span> <span style="color: #ba2f59; font-weight: bold;">char</span> **<span style="color: #715ab1;">environ</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; argc; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">"echo all command-line args" */</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"argv[%d]: %s\n"</span>, i, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>ptr = environ; *ptr != <span style="color: #4e3163;">0</span>; ++ptr<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, *ptr<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org29699e8" class="outline-3">
<h3 id="org29699e8">8.11 Changing User IDs and Group IDs</h3>
<div class="outline-text-3" id="text-org29699e8">
<p>
<code>man 2 setuid</code>
</p>
<blockquote>
<ol class="org-ol">
<li>If the process has superuser privileges, the setuid function sets the real user ID, effective user ID, and saved set-user-ID to uid.</li>

<li>If the process does not have superuser privileges, but uid equals either the real user ID or the saved set-user-ID, setuid sets only the effective user ID to uid. The real user ID and the saved set-user-ID are not changed.</li>

<li>If neither of these two conditions is true, errno is set to EPERM and −1 is returned.</li>
</ol>
</blockquote>
<p>
<img src="Chapter08/Figure8.18.png" alt="Figure8.18.png" />
<code>man 2 setreuid</code>
<code>man 2 setregid</code>
</p>
</div>
</div>
<div id="outline-container-orgf71d612" class="outline-3">
<h3 id="orgf71d612">8.12 Interpreter Files</h3>
<div class="outline-text-3" id="text-orgf71d612">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 47: </span>Figure 8.20 A program that execs an interpreter file</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execlp<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"systype.sh"</span>, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">NULL</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>
      err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"execl error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 48: </span>Figure 8.21 An awk program as an interpreter file</label><pre class="src src-c">#<span style="color: #4e3163;">!</span>/usr/bin/awk -f
<span style="color: #6c3163;"># Note</span>: On Solaris, use <span style="color: #ba2f59; font-weight: bold;">nawk</span> <span style="color: #715ab1;">instead</span>

BEGIN <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; ARGC; i ++<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf <span style="color: #2d9574;">"ARGV[%d] = %s\n"</span>, i, ARGV<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>
  <span style="color: #6c3163;">}</span>
  exit
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4fa1292" class="outline-3">
<h3 id="org4fa1292">8.13 <code>system</code> Function</h3>
<div class="outline-text-3" id="text-org4fa1292">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">system</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">cmdstring</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
<p>
*if <i>cmdstring</i> is a <code>NULL</code>, <code>system</code> returns nonzero only if a command processor is available.
</p>
<blockquote>
<ol class="org-ol">
<li>If either the fork fails or waitpid returns an error other than EINTR, system returns −1 with errno set to indicate the error.</li>

<li>If the exec fails, implying that the shell can’t be executed, the return value is as if the shell had executed exit(127).</li>

<li>Otherwise, all three functions—fork, exec, and waitpid—succeed, and the return value from system is the termination status of the shell, in the format specified for waitpid.</li>
</ol>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 49: </span>Figure 8.22 The system function, without signal handling</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">version without signal handling</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">system</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">cmdstring</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">status</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>cmdstring == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">1</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">always a command processor with UNIX */</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    status = -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"shell1"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
    _exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">27</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        status = -<span style="color: #4e3163;">1</span>;
        <span style="color: #3a81c3; font-weight: bold;">break</span>;
      <span style="color: #67b11d;">}</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> status;
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">calling system function</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"date"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #6c3163;">)</span>;

  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"nosuchcommand"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"who; exit 44"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 50: </span>Figure 8.23 Calling the system function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">version without signal handling</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">system</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">cmdstring</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">status</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>cmdstring == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">1</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">always a command processor with UNIX */</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    status = -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"shell1"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
    _exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">27</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        status = -<span style="color: #4e3163;">1</span>;
        <span style="color: #3a81c3; font-weight: bold;">break</span>;
      <span style="color: #67b11d;">}</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> status;
<span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">calling system function</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"date"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #6c3163;">)</span>;

  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"nosuchcommand"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"who; exit 44"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<p>
The advantage in using system, instead of using fork and exec directly, is that system does all the required error handling and (in our next version of this function in Section 10.18) all the required signal handling.
</p>
</blockquote>



<p>
<b>Set-User-ID Programs</b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 51: </span>Figure 8.24 Execute the command-line argument using system</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc &lt; <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>
    err_quit<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"command-line argument required"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #4e3163;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>

<p>
#+include; "Chapter08/pruids.c" src c
</p>
</div>
</div>
<div id="outline-container-org678b921" class="outline-3">
<h3 id="org678b921">8.14 Process Accounting</h3>
<div class="outline-text-3" id="text-org678b921">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 52: </span>Figure 8.28 Program to generate accounting data</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    sleep<span style="color: #2d9574;">(</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    sleep<span style="color: #2d9574;">(</span><span style="color: #4e3163;">4</span><span style="color: #2d9574;">)</span>;
    abort<span style="color: #2d9574;">()</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/dd"</span>, <span style="color: #2d9574;">"dd"</span>, <span style="color: #2d9574;">"if=/etc/passwd"</span>, <span style="color: #2d9574;">"of=/dev/null"</span>, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">7</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    sleep<span style="color: #2d9574;">(</span><span style="color: #4e3163;">8</span><span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  sleep<span style="color: #6c3163;">(</span><span style="color: #4e3163;">6</span><span style="color: #6c3163;">)</span>;
  kill<span style="color: #6c3163;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGKILL<span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">6</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 53: </span>Figure 8.29 Print select fields from system's accounting file</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/acct.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>BSD<span style="color: #3a81c3;">)</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">different structure in FreeBSD */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">acct</span>    acctv2
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">ac_flag</span> ac_trailer.ac_flag
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">FMT</span>     <span style="color: #2d9574;">"%-*.*s e = %.0f, chars = %.0f, %c %c %c %c\n"</span>
<span style="color: #6c3163;">#elif</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>HAS_AC_STAT<span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">FMT</span> <span style="color: #2d9574;">"%-*.*s e = %6ld, chars = %7ld, stat = %3u: %c %c %c %c\n"</span>
<span style="color: #6c3163;">#else</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">FMT</span> <span style="color: #2d9574;">"%-*.*s e = %6ld, chars = %7ld, %c %c %c %c\n"</span>
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>LINUX<span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">acct</span> acct_v3 <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">different structure in Linux */</span>
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#if</span> <span style="color: #4e3163;">!</span><span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>ACORE<span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">ACORE</span> <span style="color: #4e3163;">0</span>
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#if</span> <span style="color: #4e3163;">!</span><span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>AXSIG<span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">AXSIG</span> <span style="color: #4e3163;">0</span>
<span style="color: #6c3163;">#endif</span>

<span style="color: #6c3163;">#if</span> <span style="color: #4e3163;">!</span><span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>BSD<span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #6c3163; font-weight: bold;">compt2ulong</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">comp_t</span> <span style="color: #715ab1;">comptime</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">convert comp_t to unsigned long */</span>
  <span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">val</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>           <span style="color: #715ab1;">exp</span>;

  val = comptime &amp; <span style="color: #4e3163;">0x1fff</span>;    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">13-bit fraction  */</span>
  exp = <span style="color: #6c3163;">(</span>comptime &gt;&gt; <span style="color: #4e3163;">13</span><span style="color: #6c3163;">)</span> &amp; <span style="color: #4e3163;">7</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">3-bit exponent(0-7)  */</span>
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>exp-- &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    val *= <span style="color: #4e3163;">8</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> val;
<span style="color: #3a81c3;">}</span>
<span style="color: #6c3163;">#endif</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[</span>argc<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">acct</span> <span style="color: #715ab1;">acdata</span>;
  <span style="color: #ba2f59; font-weight: bold;">FILE</span> *      <span style="color: #715ab1;">fp</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc != <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>
    err_quit<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"usage pracct filename"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #4e3163;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>fread<span style="color: #2d9574;">(</span>&amp;acdata, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>acdata<span style="color: #67b11d;">)</span>, <span style="color: #4e3163;">1</span>, fp<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span>FMT,
           <span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #67b11d;">)</span><span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>acdata.ac_comm<span style="color: #67b11d;">)</span>,
           acdata.ac_comm,
<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #67b11d;">(</span>BSD<span style="color: #67b11d;">)</span>
           acdata.ac_etime,
           acdata.ac_io,
<span style="color: #6c3163;">#else</span>
           compt2ulong<span style="color: #67b11d;">(</span>acdata.ac_etime<span style="color: #67b11d;">)</span>,
           compt2ulong<span style="color: #67b11d;">(</span>acdata.ac_io<span style="color: #67b11d;">)</span>,
<span style="color: #6c3163;">#endif</span>
<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #67b11d;">(</span>HAS_AC_STAT<span style="color: #67b11d;">)</span>
           <span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">char</span><span style="color: #67b11d;">)</span>acdata.ac_stat,
<span style="color: #6c3163;">#endif</span>
           acdata.ac_flag &amp; ACORE ? <span style="color: #2d9574;">'D'</span> : <span style="color: #2d9574;">' '</span>,
           acdata.ac_flag &amp; AXSIG ? <span style="color: #2d9574;">'X'</span> : <span style="color: #2d9574;">' '</span>,
           acdata.ac_flag &amp; AFORK ? <span style="color: #2d9574;">'F'</span> : <span style="color: #2d9574;">' '</span>,
           acdata.ac_flag &amp; ASU ? <span style="color: #2d9574;">'S'</span> : <span style="color: #2d9574;">' '</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgfb36aaa" class="outline-3">
<h3 id="orgfb36aaa">8.15 User Identification</h3>
<div class="outline-text-3" id="text-orgfb36aaa">
<p>
<code>man 2 getlogin</code>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 54: </span>getlogin</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s\n"</span>, getlogin<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge84fbff" class="outline-3">
<h3 id="orge84fbff">8.16 Process Scheduling</h3>
<div class="outline-text-3" id="text-orge84fbff">
<p>
Lower nice values have higher scheduling priority.
</p>

<p>
<code>man 3 nice</code>
<code>man 3 getpriority</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 55: </span>Figure 8.30 Evaluate the effect of changing the nice value</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>MACOS<span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/syslimits.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#elif</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>SOLARIS<span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#elif</span> <span style="color: #6c3163;">defined</span><span style="color: #3a81c3;">(</span>BSD<span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/param.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#endif</span>

<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">count</span>;
<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">timeval</span>     <span style="color: #715ab1;">end</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">checktime</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">timeval</span> <span style="color: #715ab1;">tv</span>;

  gettimeofday<span style="color: #6c3163;">(</span>&amp;tv, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>tv.tv_sec &gt;= end.tv_sec &amp;&amp; tv.tv_usec &gt;= end.tv_usec<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s count = %lld\n"</span>, str, count<span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">s</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">nzero</span>, <span style="color: #715ab1;">ret</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">adj</span> = <span style="color: #4e3163;">0</span>;

  setbuf<span style="color: #6c3163;">(</span>stdout, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #6c3163;">(</span>NZERO<span style="color: #6c3163;">)</span>
  nzero = NZERO;
<span style="color: #6c3163;">#elif</span> <span style="color: #6c3163;">defined</span><span style="color: #6c3163;">(</span>_SC_NZERO<span style="color: #6c3163;">)</span>
  nzero = sysconf<span style="color: #6c3163;">(</span>_SC_NZERO<span style="color: #6c3163;">)</span>;
<span style="color: #6c3163;">#else</span>
<span style="color: #6c3163;">#error</span> <span style="color: #2d9574;">NZERO undefined</span>
<span style="color: #6c3163;">#endif</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"NZERO = %d\n"</span>, nzero<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc == <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>
    adj = strtol<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">10</span><span style="color: #6c3163;">)</span>;
  gettimeofday<span style="color: #6c3163;">(</span>&amp;end, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  end.tv_sec += <span style="color: #4e3163;">10</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">run for 10 seconds */</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork failed"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child */</span>
    s = <span style="color: #2d9574;">"child"</span>;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"current nice value in child is %d adjusting by %d\n"</span>,
           nice<span style="color: #67b11d;">(</span><span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> + nzero,
           adj<span style="color: #2d9574;">)</span>;
    errno = <span style="color: #4e3163;">0</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ret = nice<span style="color: #b1951d;">(</span>adj<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #4e3163;">1</span> &amp;&amp; errno != <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child set scheduling priority"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"now child nice value is %d\n"</span>, ret + nzero<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent */</span>
    s = <span style="color: #2d9574;">"parent"</span>;
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"current nice value in parent is %d\n"</span>, nice<span style="color: #67b11d;">(</span><span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> + nzero<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>


  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>++count == <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_quit<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s counter wrap"</span>, s<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    checktime<span style="color: #2d9574;">(</span>s<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>


  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org6d5be1f" class="outline-3">
<h3 id="org6d5be1f">8.17 Process Times</h3>
<div class="outline-text-3" id="text-org6d5be1f">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/times.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">clock_t</span> <span style="color: #6c3163; font-weight: bold;">times</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">tms</span> *<span style="color: #715ab1;">buf</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: elapsed wall clock time in clock ticks if OK, -1 on error</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 56: </span>Figure 8.31 Time and execute all command-line arguments</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/times.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pr_times</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">clock_t</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">tms</span> *, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">tms</span> *<span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">do_cmd</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">i</span>;
  setbuf<span style="color: #6c3163;">(</span>stdout, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">1</span>; i &lt; argc; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    do_cmd<span style="color: #2d9574;">(</span>argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>


<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">do_cmd</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">cmd</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">tms</span> <span style="color: #715ab1;">tmsstart</span>, <span style="color: #715ab1;">tmsend</span>;
  <span style="color: #ba2f59; font-weight: bold;">clock_t</span> <span style="color: #715ab1;">start</span>, <span style="color: #715ab1;">end</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\ncommand: %s\n"</span>, cmd<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>start = times<span style="color: #67b11d;">(</span>&amp;tmsstart<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == -<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"times error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span>cmd<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>end = times<span style="color: #67b11d;">(</span>&amp;tmsend<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == -<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys <span style="color: #2d9574;">(</span><span style="color: #2d9574;">"times error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  pr_times<span style="color: #6c3163;">(</span>end-start, &amp;tmsstart, &amp;tmsend<span style="color: #6c3163;">)</span>;
  pr_exit<span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pr_times</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">clock_t</span> <span style="color: #715ab1;">real</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">tms</span> *<span style="color: #715ab1;">tmsstart</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">tms</span> *<span style="color: #715ab1;">tmsend</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">clktck</span> = <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>clktck == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>clktck = sysconf<span style="color: #b1951d;">(</span>_SC_CLK_TCK<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"sysconf error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"  real:         %7.2f\n"</span>, real / <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"  user:         %7.2f\n"</span>, <span style="color: #2d9574;">(</span>tmsend-&gt;tms_utime - tmsstart-&gt;tms_utime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"  sys:          %7.2f\n"</span>, <span style="color: #2d9574;">(</span>tmsend-&gt;tms_stime - tmsstart-&gt;tms_stime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"  child user:   %7.2f\n"</span>, <span style="color: #2d9574;">(</span>tmsend-&gt;tms_cutime - tmsstart-&gt;tms_cutime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"  child sys:    %7.2f\n"</span>, <span style="color: #2d9574;">(</span>tmsend-&gt;tms_cstime - tmsstart-&gt;tms_cstime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge694c1b" class="outline-3">
<h3 id="orge694c1b">8.18 Summary</h3>
<div class="outline-text-3" id="text-orge694c1b">
<p>
functions to master: <code>fork</code>, <code>exec</code> family, <code>_exit</code>, <code>wait</code> and <code>waitpid</code>.
</p>

<p>
<code>fork</code> function gave us an opportunity to look at race conditions.
</p>

<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 57: </span>8.1</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">globvar</span> = <span style="color: #4e3163;">6</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">external variable in initialized data */</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">var</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">automatic variable on the stack */</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  var = <span style="color: #4e3163;">88</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">we don't flush stdio */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child */</span>
    globvar++;           <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">modify parent's variables */</span>
    var++;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child terminaltes */</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent continues here */</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 58: </span>8.2</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">f1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>, <span style="color: #6c3163; font-weight: bold;">f2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>

  f1<span style="color: #6c3163;">()</span>;

  f2<span style="color: #6c3163;">()</span>;

  _exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">f1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child and parent both return */</span>

<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">f2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>

  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">100</span><span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">i</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">automatic variables */</span>

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span>; i++<span style="color: #6c3163;">)</span>
    buf<span style="color: #6c3163;">[</span>i<span style="color: #6c3163;">]</span> = <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 59: </span>8.3</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">globvar</span> = <span style="color: #4e3163;">6</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">external variable in initialized data */</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">var</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">automatic variable on the stack */</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  var = <span style="color: #4e3163;">88</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">we don't flush stdio */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child */</span>
    globvar++;           <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">modify parent's variables */</span>
    var++;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">child terminaltes */</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent continues here */</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li>8.4</li>
</ul></li>
</ul>
<p>
In Figure 8.13, we have the parent write its output first. When the parent is done, the child writes its output, but we let the parent terminate. Whether the parent terminates or whether the child finishes its output first depends on the kernel’s scheduling of the two processes (another race condition). When the parent terminates, the shell starts up the next program, and this next program can interfere with the output from the previous child.
We can prevent this from happening by not letting the parent terminate until the child has also finished its output. Replace the code following the fork with the following:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #3a81c3;">(</span>pid ~~ <span style="color: #4e3163;">0</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  WAIT_PARENT<span style="color: #6c3163;">()</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">parent goes first */</span>
  charatatime<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #6c3163;">)</span>;
  TELL_PARENT<span style="color: #6c3163;">(</span>getppid<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">tell parent we&#8217;re done */</span>
<span style="color: #3a81c3;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3;">{</span>
  charatatime<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #6c3163;">)</span>;
  TELL_CHILD<span style="color: #6c3163;">(</span>pid<span style="color: #6c3163;">)</span>;
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">tell child we&#8217;re done */</span>
  WAIT_CHILD<span style="color: #6c3163;">()</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">wait for child to finish */</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<p>
We won’t see this happen if we let the child go first, since the shell doesn’t start the next program until the parent terminates.
</p>
<ul class="org-ul">
<li>8.5 The same value</li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 60: </span>8.6</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  sleep<span style="color: #6c3163;">(</span><span style="color: #4e3163;">4</span><span style="color: #6c3163;">)</span>;

  system<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"ps -o pid,ppid,state,tty,command"</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf54368b" class="outline-2">
<h2 id="orgf54368b">Chapter 9. Process Relationships</h2>
<div class="outline-text-2" id="text-orgf54368b">
</div>
<div id="outline-container-orgb5df351" class="outline-3">
<h3 id="orgb5df351">9.1 Introduction</h3>
</div>
<div id="outline-container-orgd73d9e8" class="outline-3">
<h3 id="orgd73d9e8">9.2 Terminal Logins</h3>
<div class="outline-text-3" id="text-orgd73d9e8">
<ul class="org-ul">
<li><p>
BSD Terminal Logins
</p>

<div class="figure">
<p><a href="Chapter09/fig9.1.png"><img src="Chapter09/fig9.1.png" alt="fig9.1.png" /></a>
</p>
<p><span class="figure-number">Figure 3: </span>Figure 9.1 Processes invoked by init to allow terminal logins</p>
</div>
<blockquote>
<p>
a real user ID of 0 and an effective user ID of 0
</p>
</blockquote>

<p>
<code>login</code> program similar to
</p>
<div class="org-src-container">
<pre class="src src-c">execle<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"/bin/login"</span>, <span style="color: #2d9574;">"login"</span>, <span style="color: #2d9574;">"-p"</span>, username, <span style="color: #6c3163;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163;">)</span><span style="color: #4e3163;">0</span>, envp<span style="color: #3a81c3;">)</span>;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org716a08f" class="outline-3">
<h3 id="org716a08f">9.3 Network Logins</h3>
</div>
<div id="outline-container-org747ac91" class="outline-3">
<h3 id="org747ac91">9.4 Process Groups</h3>
<div class="outline-text-3" id="text-org747ac91">
<div class="org-src-container">
<pre class="src src-c">getpgid<span style="color: #3a81c3;">(</span><span style="color: #4e3163;">0</span><span style="color: #3a81c3;">)</span> ~~ getpgrp<span style="color: #3a81c3;">()</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org2e657aa" class="outline-3">
<h3 id="org2e657aa">9.5 Sessions</h3>
</div>
<div id="outline-container-orgc2a5a39" class="outline-3">
<h3 id="orgc2a5a39">9.6 Controlling Terminal</h3>
</div>
<div id="outline-container-org3ac1e1f" class="outline-3">
<h3 id="org3ac1e1f">9.7 <code>tcgetpgrp</code>, <code>tcsetpgrp</code>, and <code>tcgetsid</code> Functions</h3>
</div>
<div id="outline-container-org26bed99" class="outline-3">
<h3 id="org26bed99">9.8 Job Control</h3>
<div class="outline-text-3" id="text-org26bed99">
<p>
Requirements:
</p>
<ol class="org-ol">
<li>A shell that supports job control</li>
<li>The terminal driver in the kernel must support job control</li>
<li>The kernel must support certain job-control signals</li>
</ol>


<div class="org-src-container">
<pre class="src src-sh">cat &gt; temp.foo &amp; <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">&amp; let start in background</span>
<span style="color: #3a81c3;">fg</span> % <span style="color: #4e3163;">1</span> <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">% bring job number into the foreground</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">stty tostop <span style="color: #2aa1ae; background-color: #ecf3ec;"># </span><span style="color: #2aa1ae; background-color: #ecf3ec;">disable ability of background to output to controlling terminal</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga1a558a" class="outline-3">
<h3 id="orga1a558a">9.9 Shell Execution Programs</h3>
</div>
<div id="outline-container-orgf35ba5e" class="outline-3">
<h3 id="orgf35ba5e">9.10 Orphaned Process Groups</h3>
</div>
<div id="outline-container-org761be25" class="outline-3">
<h3 id="org761be25">9.11 FreeBSD Implementation</h3>
</div>
<div id="outline-container-org153944d" class="outline-3">
<h3 id="org153944d">9.12 Summary</h3>
</div>
</div>
<div id="outline-container-orge781e35" class="outline-2">
<h2 id="orge781e35">Chapter 10. Signals</h2>
<div class="outline-text-2" id="text-orge781e35">
</div>
<div id="outline-container-org95bf58f" class="outline-3">
<h3 id="org95bf58f">10.1 Introduction</h3>
<div class="outline-text-3" id="text-org95bf58f">
<blockquote>
<p>
Signals provide a way of handling asynchronous events
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org955d748" class="outline-3">
<h3 id="org955d748">10.2 Signal Concepts</h3>
<div class="outline-text-3" id="text-org955d748">
<p>
<code>&lt;signal.h&gt;</code>
conditions can generate a signal
</p>
<ul class="org-ul">
<li>terminal generated when users press certain terminal keys.</li>
<li>hardware exceptions</li>
<li>function <code>kill</code> (man 2 kill)</li>
<li>command <code>kill</code> (man 1 kill)</li>
<li>software conditions : <code>SIGURG</code> <code>SIGPIPE</code> <code>SIGALARM</code></li>
</ul>


<p>
deal with signals via one of things below:
</p>
<ul class="org-ul">
<li>ignore</li>
<li>catch</li>
<li>use defaut action apply</li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Figure 10.1 UNIX System signals</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Default Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SIGABRT</td>
<td class="org-left">abnormal termination(abort)</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGALARM</td>
<td class="org-left">timer expired(alarm)</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGBUS</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGCHLD</td>
<td class="org-left">change in the status of child</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGCONT</td>
<td class="org-left">continue stopped process</td>
<td class="org-left">continue/ignore</td>
</tr>

<tr>
<td class="org-left">SIGEMT</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGFPE</td>
<td class="org-left">arithmetic exception</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGFREEZE</td>
<td class="org-left">checkpoint freeze</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGHUP</td>
<td class="org-left">hangup</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGILL</td>
<td class="org-left">illegal instruction</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGINFO</td>
<td class="org-left">status request from keyboard</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGINT</td>
<td class="org-left">terminal interrupt character</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGIO</td>
<td class="org-left">asynchronous I/O</td>
<td class="org-left">terminate/ignore</td>
</tr>

<tr>
<td class="org-left">SIGIOT</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGKILL</td>
<td class="org-left">termination : <b>can't be caught or ignored</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPIPE</td>
<td class="org-left">write to pipe with no readers</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPOLL</td>
<td class="org-left">pollable event(poll): <b>might be removed</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPROF</td>
<td class="org-left">profiling time alarm(setitimer):  <b>might be removed</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPWR</td>
<td class="org-left">power fail/restart</td>
<td class="org-left">terminate/ignore</td>
</tr>

<tr>
<td class="org-left">SIGQUIT</td>
<td class="org-left">terminal quit character</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGSEGV</td>
<td class="org-left">invalid memory reference</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGSTKFLT</td>
<td class="org-left">coprocessor stack fault</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGSTOP</td>
<td class="org-left">stop: <b>can't be caught or ignored</b></td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGSYS</td>
<td class="org-left">invalid system call</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGTERM</td>
<td class="org-left">termination</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGTHAW</td>
<td class="org-left">checkpoint thaw</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGTHR</td>
<td class="org-left">threads library internal use</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGTRAP</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGTSTP</td>
<td class="org-left">terminal stop character</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGTTIN</td>
<td class="org-left">background read from control tty</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGTTOU</td>
<td class="org-left">background write to control tty</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGURG</td>
<td class="org-left">urgent condition(sockets)</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGUSR1</td>
<td class="org-left">user-defined signal</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGUSR2</td>
<td class="org-left">user-defined signal</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGVTALRM</td>
<td class="org-left">virtual time alarm(setitimer)</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGWAITING</td>
<td class="org-left">threads library internal use</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGWINCH</td>
<td class="org-left">terminal window size change</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGXCPU</td>
<td class="org-left">CPU limit exceeded (setrlimit)</td>
<td class="org-left">terminate or terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGXFSZ</td>
<td class="org-left">file size limit exceeded(setrlimit0)</td>
<td class="org-left">terminate or terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGXRES</td>
<td class="org-left">resource control exceeded</td>
<td class="org-left">ignore</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
The core file will not be generated if
</p>
<ol class="org-ol">
<li>the process was set-user-ID and the current user is not the owner of the program file</li>
<li>the process was set-group-ID and the current user is not the group owner of the file</li>
<li>the user does not have permission to write in the current working directory</li>
<li>the file already exists and the user does not have permission to write it</li>
<li>the file is too big (recall the RLIMIT_CORE)</li>
</ol>

<p>
The permission of the core file are usually <code>rw</code>, although Mac OSX sets only <code>r</code>
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgcc911c3" class="outline-3">
<h3 id="orgcc911c3">10.3 <code>signal</code> Function</h3>
<div class="outline-text-3" id="text-orgcc911c3">
<div class="org-src-container">
<pre class="src src-sh">man signal
</pre>
</div>

<ul class="org-ul">
<li>Example: <br /></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 61: </span>Figure 10.2 Simple program to catch SIGUSR1 and SIGUSR2</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_usr</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">one handler for both signals */</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"can't catch SIGUSR1"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR2, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"can't catch SIGUSR2"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span> pause<span style="color: #6c3163;">()</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_usr</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signo == SIGUSR1<span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"received SIGUSR1\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signo == SIGUSR2<span style="color: #6c3163;">)</span>
    printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"received SIGUSR2\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">else</span>
    err_dump<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"received signal %d\n"</span>, signo<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<blockquote>
<p>
FreeBSD 8.0 and Mac OS X 10.6.8 don’t exhibit this problem, because BSD - based systems generally don’t support historical System V semantics for SIGCLD. Linux 3.2.0 also doesn’t exhibit this problem, because it doesn’t call the SIGCHLD signal handler when a process arranges to catch SIGCHLD and child processes are ready to be waited for, even though SIGCLD and SIGCHLD are defined to be the same value.
</p>
</blockquote>

<ul class="org-ul">
<li>Program Start-Up
we are not able to determine the current disposition of a signal without changing the disposition</li>
</ul>
</div>
</div>
<div id="outline-container-org1511183" class="outline-3">
<h3 id="org1511183">10.4 Unreliable Signals</h3>
<div class="outline-text-3" id="text-org1511183">
<p>
In ealier versions of the UNIX system :
</p>
<ul class="org-ul">
<li>signals could get lost</li>
<li>the process was unable to turn a signal off when it didn’t want the signal to occur</li>
</ul>
</div>
</div>
<div id="outline-container-org9baca49" class="outline-3">
<h3 id="org9baca49">10.5 Interrupted System Calls</h3>
<div class="outline-text-3" id="text-org9baca49">
<ul class="org-ul">
<li>automatically restarted functions: <code>ioctl</code>, <code>read</code>, <code>readv</code>, <code>write</code>, <code>writev</code>, <code>wait</code>, <code>waitpid</code> <br />
POSIX.1 requires an implementation to restart system calls only when the SA_RESTART ﬂag is in effect for the interrupting signal.</li>
</ul>
</div>
</div>
<div id="outline-container-org8ab10ab" class="outline-3">
<h3 id="org8ab10ab">10.6 Reentrant Functions</h3>
<div class="outline-text-3" id="text-org8ab10ab">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 62: </span>Figure 10.5 Call a nonreentrant function from a signal handler</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pwd.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">my_alarm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">passwd</span> *<span style="color: #715ab1;">rootptr</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"in signal hander\n"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>rootptr = getpwnam<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"hello"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getpwnam(root) error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>

  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">passwd</span> *<span style="color: #715ab1;">ptr</span>;
  signal<span style="color: #6c3163;">(</span>SIGALRM, my_alarm<span style="color: #6c3163;">)</span>;
  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">usleep(500);                  // it seems alarm cannot interrupt sleep function</span>

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ptr = getpwnam<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"zhoush"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"getpwnam error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>strcmp<span style="color: #67b11d;">(</span>ptr-&gt;pw_name, <span style="color: #2d9574;">"zhoush"</span><span style="color: #67b11d;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"return value corrupted!, pw_name = %s\n"</span>, ptr-&gt;pw_name<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga0968b6" class="outline-3">
<h3 id="orga0968b6">10.7 <code>SIGCLD</code> Semantics</h3>
<div class="outline-text-3" id="text-orga0968b6">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 63: </span>Figure 10.6 System V SIGCLD handler that doesn't work</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_cld</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #6c3163;">(</span>__linux__<span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGCLD, sig_cld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

<span style="color: #6c3163;">#endif</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    sleep<span style="color: #2d9574;">(</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span>;
    _exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  pause<span style="color: #6c3163;">()</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_cld</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">interrupts pause()</span>

  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">status</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"SIGCLD received\n"</span><span style="color: #6c3163;">)</span>;

<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #6c3163;">(</span>__linux__<span style="color: #6c3163;">)</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGCLD, sig_cld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal erro"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #6c3163;">#endif</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = wait<span style="color: #67b11d;">(</span>&amp;status<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"pid = %d\n"</span>, pid<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org73ca052" class="outline-3">
<h3 id="org73ca052">10.8 Reliable-Signal Terminology and Semantics</h3>
<div class="outline-text-3" id="text-org73ca052">
<blockquote>
<p>
If the system delivers the signal more than once, we say that the signals are queued. <br />
<b>Most UNIX systems do <i>not</i> queue signals unless they support the real-time extensions to POSIX.1.</b> <br />
POSIX.1 <b>does not specify the order</b> in which the signals are delivered to the process more than once.
</p>
</blockquote>

<ul class="org-ul">
<li><i>signal mask</i>: a set of signals currently blocked from delivery to the process (<b>on</b> is blocked)</li>
<li><i><code>sigprocmask</code></i>: examine and change its current signal mask</li>
</ul>
</div>
</div>
<div id="outline-container-orgb089a05" class="outline-3">
<h3 id="orgb089a05">10.9 <code>kill</code> and <code>raise</code> Functions</h3>
<div class="outline-text-3" id="text-orgb089a05">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">kill</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">raise</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>

<p>
<code>raise(signo);</code> is equivalent to <code>kill(getpid(), signo);</code>
</p>
</div>
</div>

<div id="outline-container-org5488547" class="outline-3">
<h3 id="org5488547">10.10 <code>alarm</code> and <code>pause</code> Functions</h3>
<div class="outline-text-3" id="text-org5488547">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">alarm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">seconds</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 or number of seconds until previously set alarm</span>
</pre>
</div>

<blockquote>
<p>

</p>

<p>
There is only one of these alarm clocks per process. If, when we call alarm, a previously registered alarm clock for the process has not yet expired, the number of seconds left for that alarm clock is returned as the value of this function.
</p>

<p>
If a previously registered alarm clock for the process has not yet expired and if the seconds value is 0, the previous alarm clock is canceled.
</p>

<p>
If we call alarm ﬁrst and are sent SIGALRM before we can install the signal handler, our process will terminate
</p>
</blockquote>


<p>
suspends the calling process until a signal is caught
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pause</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: -1 with errno set to EINTR</span>
</pre>
</div>


<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 64: </span>Figure 10.7 Simple, incomplete implementation of sleep</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">nothing to do , just return to wake up the pause;</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sleep1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">seconds</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  alarm<span style="color: #6c3163;">(</span>seconds<span style="color: #6c3163;">)</span>;               <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">start timer</span>
  pause<span style="color: #6c3163;">()</span>;                      <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">caught signal wake up</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>alarm<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;            <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">turn off timer, return unslept time</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 65: </span>Figure 10.8 Another (imperfect) implementation of sleep</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">jmp_buf</span> <span style="color: #715ab1;">env_alrm</span>;

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> longjmp<span style="color: #6c3163;">(</span>env_alrm, <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sleep2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">seconds</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>setjmp<span style="color: #2d9574;">(</span>env_alrm<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    alarm<span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
    pause<span style="color: #2d9574;">()</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 66: </span>Figure 10.9 Calling sleep2 from a program that catches other signals</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sleep2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span>  <span style="color: #6c3163; font-weight: bold;">sig_int</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">unslept</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  unslept = sleep2<span style="color: #6c3163;">(</span><span style="color: #4e3163;">5</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"sleep2 returned: %u\n"</span>, unslept<span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_int</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>          <span style="color: #715ab1;">i</span>, <span style="color: #715ab1;">j</span>;
  <span style="color: #3a81c3; font-weight: bold;">volatile</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">k</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\nsig_int starting\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; <span style="color: #4e3163;">3000000</span>; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>j = <span style="color: #4e3163;">0</span>; j &lt; <span style="color: #4e3163;">40000</span>; ++j<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      k += i * j;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"sig_int finished"</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 67: </span>Figure 10.10 Calling <code>read</code> with a timeout</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.10.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-26</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    calling read() with timeout</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  @bug race condition between first call to alarm() and read()</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  @bug if system are automatically restarted, the read is not interrupted</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #715ab1;">n</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">line</span><span style="color: #6c3163;">[</span>MAXLINE<span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">10</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;

  write<span style="color: #6c3163;">(</span>STDOUT_FILENO, line, n<span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 68: </span>Figure 10.11 Calling <code>read</code> with a timeout, using longjmp</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.11.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-26</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    calling read with a timeout, using longjmp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">jmp_buf</span> <span style="color: #715ab1;">env_alrm</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">n</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">line</span><span style="color: #6c3163;">[</span>MAXLINE<span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>setjmp<span style="color: #2d9574;">(</span>env_alrm<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_quit<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"read timeout"</span><span style="color: #6c3163;">)</span>;

  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">10</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #6c3163;">)</span>;

  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;

  write<span style="color: #6c3163;">(</span>STDOUT_FILENO, line, n<span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> longjmp<span style="color: #6c3163;">(</span>env_alrm, <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgf0e7ab2" class="outline-3">
<h3 id="orgf0e7ab2">10.11 Signal Sets</h3>
<div class="outline-text-3" id="text-orgf0e7ab2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigemptyset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigfillset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigaddset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigdelset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">All four returns: 0 if OK, -1 on error</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigismember</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">sigset</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 1 if true, 0 if false, -1 on error</span>
</pre>
</div>

<p>
Implementation:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#define</span> <span style="color: #6c3163; font-weight: bold;">sigemptyset</span><span style="color: #3a81c3;">(</span><span style="color: #715ab1;">ptr</span><span style="color: #3a81c3;">)</span>  <span style="color: #3a81c3;">(</span>*<span style="color: #6c3163;">(</span>ptr<span style="color: #6c3163;">)</span> = <span style="color: #4e3163;">0</span><span style="color: #3a81c3;">)</span>
<span style="color: #6c3163;">#define</span> <span style="color: #6c3163; font-weight: bold;">sigfillset</span><span style="color: #3a81c3;">(</span><span style="color: #715ab1;">ptr</span><span style="color: #3a81c3;">)</span>   <span style="color: #3a81c3;">(</span>*<span style="color: #6c3163;">(</span>ptr<span style="color: #6c3163;">)</span> = ~<span style="color: #6c3163;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span><span style="color: #6c3163;">)</span><span style="color: #4e3163;">0</span>, <span style="color: #4e3163;">0</span><span style="color: #3a81c3;">)</span>
</pre>
</div>
<p>
<code>sigfillset</code> returns value after the comma (value: 0)
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.12.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-26</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    implementations</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  An implementation of sigaddset(), sigdelset(), sigismember()</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * &lt;signal.h&gt; usually defines NSIG to include signal number 0.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#define</span> <span style="color: #6c3163; font-weight: bold;">SIGBAD</span><span style="color: #3a81c3;">(</span><span style="color: #715ab1;">signao</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">(</span><span style="color: #6c3163;">(</span>signo<span style="color: #6c3163;">)</span> &lt;= <span style="color: #4e3163;">0</span> || <span style="color: #6c3163;">(</span>signo<span style="color: #6c3163;">)</span> &gt;= NSIG<span style="color: #3a81c3;">)</span>


<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">my_sigaddset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = EINVAL;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  *set |= <span style="color: #4e3163;">1</span> &lt;&lt; <span style="color: #6c3163;">(</span>signo - <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">turn bit on</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">my_sigdelset</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = EINVAL;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  *set &amp;= ~<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span> &lt;&lt; <span style="color: #2d9574;">(</span>signo - <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">turn bit off</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">my_sigismember</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = EINVAL;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>*set &amp; <span style="color: #67b11d;">(</span><span style="color: #4e3163;">1</span> &lt;&lt; <span style="color: #b1951d;">(</span>signo - <span style="color: #4e3163;">1</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d153ca" class="outline-3">
<h3 id="org1d153ca">10.12 <code>sigprocmask</code> Function</h3>
<div class="outline-text-3" id="text-org1d153ca">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigprocmask</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">how</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">set</span>, <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">oset</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Figure 10.13 Ways to change the current signal mask using sigprocmask</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">how</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>SIG_BLOCK</code></td>
<td class="org-left"><i>set</i> contains the additional signals that we want to block.</td>
</tr>

<tr>
<td class="org-left"><code>SIG_UNBLOCK</code></td>
<td class="org-left"><i>set</i> contains the signals that we want to unblock</td>
</tr>

<tr>
<td class="org-left"><code>SIG_SETMASK</code></td>
<td class="org-left">new signal mask replaced by the signal set pointed to by <i>set</i></td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 69: </span>Figure 10.14 Print the signal mask for the process</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.14.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-27</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Print the signal mask for the process</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   shows a function that prints the names of the signals in the signal mask of</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * the calling process.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pr_mask</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> <span style="color: #715ab1;">sigset</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">errno_save</span>;

  errno_save = errno; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">we can be canceld by signal handlers</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span>, <span style="color: #4e3163;">NULL</span>, &amp;sigset<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"sigprocmask error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s"</span>, str<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGINT<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGINT"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGQUIT<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGQUIT"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGUSR1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGUSR1"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGALRM<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGGALRM"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  errno = errno_save;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org305e71e" class="outline-3">
<h3 id="org305e71e">10.13 <code>sigpending</code> Function</h3>
<div class="outline-text-3" id="text-org305e71e">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigpending</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">set</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 70: </span>Example of signal sets and sigprocmask</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pwd.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">my_alarm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">passwd</span> *<span style="color: #715ab1;">rootptr</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"in signal hander\n"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>rootptr = getpwnam<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"hello"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getpwnam(root) error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>

  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">passwd</span> *<span style="color: #715ab1;">ptr</span>;
  signal<span style="color: #6c3163;">(</span>SIGALRM, my_alarm<span style="color: #6c3163;">)</span>;
  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">usleep(500);                  // it seems alarm cannot interrupt sleep function</span>

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ptr = getpwnam<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"zhoush"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"getpwnam error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>strcmp<span style="color: #67b11d;">(</span>ptr-&gt;pw_name, <span style="color: #2d9574;">"zhoush"</span><span style="color: #67b11d;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"return value corrupted!, pw_name = %s\n"</span>, ptr-&gt;pw_name<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org1ff8492" class="outline-3">
<h3 id="org1ff8492">10.14 <code>sigaction</code> Function</h3>
<div class="outline-text-3" id="text-org1ff8492">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigaction</span> <span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sigaction</span>* <span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">act</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sigaction</span>* <span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">oact</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sigaction</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163;">(</span>*sa_handler<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #6c3163;">)</span>;       <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">addr of signal handler or SIG_IGN or SIG_DFL</span>

  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> <span style="color: #715ab1;">sa_mask</span>;               <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">addtional signals to block</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">sa_flags</span>;                   <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">signal options, Figure 10.16</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">alternate handler</span>
  <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163;">(</span>*sa_action<span style="color: #6c3163;">)(</span><span style="color: #ba2f59; font-weight: bold;">int</span>, <span style="color: #ba2f59; font-weight: bold;">siginfo_t</span> *, <span style="color: #ba2f59; font-weight: bold;">void</span>*<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Figure 10.16 Option ﬂags (sa_flags) for the handling of each signal</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Option</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD</th>
<th scope="col" class="org-left">Linux</th>
<th scope="col" class="org-left">Mac OSX</th>
<th scope="col" class="org-left">Solaris</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SA_INTERRUPT</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">system call interrupted by this signal are not automatically restarted</td>
</tr>

<tr>
<td class="org-left">SA_NOCLDSTOP</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">SIGCHLD do not generate signal when a child process stops(job control).</td>
</tr>

<tr>
<td class="org-left">SA_NOCLDWAIT</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">SIGCHLD prevents the system call from creating process zombie processes</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">when children of the calling process terminate.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">if the subsequently calls wait, the calling process blocks until all</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">its child processes have terminated and then returns -1 when errno set to ECHILD</td>
</tr>

<tr>
<td class="org-left">SA_NODEFER</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">signal is not automatically blocked by the system while the signao-catching function executes</td>
</tr>

<tr>
<td class="org-left">SA_ONSTACK</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">if an alternative stack has been declared with <code>signalstack</code><sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></td>
</tr>

<tr>
<td class="org-left">SA_RESETHAND</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">the disposition for this signal is reset to SIG_DFL, and the SA_SIGINFO flag is cleared</td>
</tr>

<tr>
<td class="org-left">SA_RESTART</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">system calls interrupted by this signal are automatically restarted</td>
</tr>

<tr>
<td class="org-left">SA_SIGINFO</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">provides additional information to a signal hander</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">normal signal handler</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">handler</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">if SA_SIGINFO flag is set</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">handler</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #ba2f59; font-weight: bold;">siginfo_t</span> *<span style="color: #715ab1;">info</span>, <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">context</span><span style="color: #3a81c3;">)</span>;

<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">siginfo</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">si_signo</span>;          <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">signal number</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">si_errno</span>;          <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">if nonzero, errno value from errno.h</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">si_code</span>;           <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">additional info (depends on signal)</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">si_pid</span>;          <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">sending process ID</span>
  <span style="color: #ba2f59; font-weight: bold;">uid_t</span> <span style="color: #715ab1;">si_uid</span>;          <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">sending process real user ID</span>
  <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">si_addr</span>;         <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">address that caused the fault</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">si_status</span>;         <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">exit value or signal number</span>
  <span style="color: #3a81c3; font-weight: bold;">union</span> <span style="color: #ba2f59; font-weight: bold;">sigval</span> <span style="color: #715ab1;">si_value</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">application-specific value</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">possibly other fields also</span>
<span style="color: #3a81c3;">}</span>;
<span style="color: #3a81c3; font-weight: bold;">union</span> <span style="color: #ba2f59; font-weight: bold;">sigval</span> <span style="color: #3a81c3;">{</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">sival_int</span>; <span style="color: #ba2f59; font-weight: bold;">void</span>* <span style="color: #715ab1;">sival_ptr</span>; <span style="color: #3a81c3;">}</span>;

</pre>
</div>


<p>
<code>man sigaction</code> (linux)for details
</p>

<ul class="org-ul">
<li><p>
Example - <code>signal</code> function
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 71: </span>Figure 10.18 An implementation of signal using sigaction</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.18.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-27</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    An implementation of signal using sigaction</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Reliable version of signal(), using POSIX sigaction().</span>

<span style="color: #ba2f59; font-weight: bold;">Sigfunc</span> *<span style="color: #6c3163; font-weight: bold;">signal</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #ba2f59; font-weight: bold;">Sigfunc</span> *<span style="color: #715ab1;">func</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sigaction</span> <span style="color: #715ab1;">act</span>, <span style="color: #715ab1;">oact</span>;

  act.sa_handler = func;
  sigemptyset<span style="color: #6c3163;">(</span>&amp;act.sa_mask<span style="color: #6c3163;">)</span>;
  act.sa_flags = <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signo == SIGALRM<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
<span style="color: #6c3163;">#if</span> <span style="color: #6c3163;">defined</span><span style="color: #2d9574;">(</span>SA_INTERRUPT<span style="color: #2d9574;">)</span>
    act.sa_flags |= SA_INTERRUPT;
<span style="color: #6c3163;">#endif</span>
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    act.sa_flags |= SA_RESTART;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigaction<span style="color: #2d9574;">(</span>signo, &amp;act, &amp;oact<span style="color: #2d9574;">)</span>&lt;<span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> SIG_ERR;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> oact.sa_handler;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>

<li><p>
Example - <code>signal_intr</code> function
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 72: </span>Figure 10.19 The signal_intr function</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.19.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-27</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    The signal_intr function</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   tries to prevent any interrupted system calls from being restarted.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">Sigfunc</span> *<span style="color: #6c3163; font-weight: bold;">signal_intr</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #ba2f59; font-weight: bold;">Sigfunc</span> *<span style="color: #715ab1;">func</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sigaction</span> <span style="color: #715ab1;">act</span>, <span style="color: #715ab1;">oact</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>             <span style="color: #715ab1;">signame</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">32</span><span style="color: #6c3163;">]</span> = <span style="color: #6c3163;">{</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">}</span>;

  psignal<span style="color: #6c3163;">(</span>signo, signame<span style="color: #6c3163;">)</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s is caught\n"</span>, signame<span style="color: #6c3163;">)</span>;

  act.sa_handler = func;
  sigemptyset<span style="color: #6c3163;">(</span>&amp;act.sa_mask<span style="color: #6c3163;">)</span>;
  act.sa_flags = <span style="color: #4e3163;">0</span>;
<span style="color: #6c3163;">#ifdef</span> SA_INTERRUPT
  act.sa_flags |= SA_INTERRUPT;
<span style="color: #6c3163;">#endif</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigaction<span style="color: #2d9574;">(</span>signo, &amp;act, &amp;oact<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> SIG_ERR;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>oact.sa_handler<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org51a2479" class="outline-3">
<h3 id="org51a2479">10.15 <code>sigsetjmp</code> and <code>siglongjmp</code> Functions</h3>
<div class="outline-text-3" id="text-org51a2479">
<p>
These two functions should always be used when branching from a signal handler.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigsetjmp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigjmp_buf</span> <span style="color: #715ab1;">env</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">savemask</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if called directly, nonzero if returning from a call to siglongjmp</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">siglongjmp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">sigjmp_buf</span> <span style="color: #715ab1;">env</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">val</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 73: </span>Figure 10.20 Example of signal masks, sigsetjmp, and siglongjmp</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.20.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Figure 10.20 Example of signal masks, sigsetjmp, and siglongjmp</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span>                  <span style="color: #6c3163; font-weight: bold;">sig_usr1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span>                  <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">sigjmp_buf</span>            <span style="color: #715ab1;">jmpbuf</span>;
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #3a81c3; font-weight: bold;">volatile</span> <span style="color: #ba2f59; font-weight: bold;">sig_atomic_t</span> <span style="color: #715ab1;">canjump</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr1<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGUSR1) error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #6c3163;">)</span>;

  pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"starting main: "</span><span style="color: #6c3163;">)</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Figure 10.14</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigsetjmp<span style="color: #2d9574;">(</span>jmpbuf, <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    pr_mask<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"ending main: "</span><span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  canjump = <span style="color: #4e3163;">1</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span> pause<span style="color: #6c3163;">()</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_usr1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">time_t</span> <span style="color: #715ab1;">starttime</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>canjump == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span>;
  <span style="color: #6c3163;">}</span>

  pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"starting sig_usr1: "</span><span style="color: #6c3163;">)</span>;

  alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">3</span><span style="color: #6c3163;">)</span>;
  starttime = time<span style="color: #6c3163;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>time<span style="color: #2d9574;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> &gt; starttime + <span style="color: #4e3163;">5</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">break</span>;

  pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"finishing sig_usr1: "</span><span style="color: #6c3163;">)</span>;

  canjump = <span style="color: #4e3163;">0</span>;
  siglongjmp<span style="color: #6c3163;">(</span>jmpbuf, <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;        <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">jump back to main, don't return</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"in sig_alrm: "</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>

<blockquote>
<p>
If we change the program in Figure 10.20 so that the calls to sigsetjmp and siglongjmp are replaced with calls to setjmp and longjmp on Linux (or _setjmp and _longjmp on FreeBSD), the ﬁnal line of output becomes
</p>

<p>
ending main: SIGUSR1
</p>

<p>
This means that the main function is executing with the SIGUSR1 signal blocked, after the call to setjmp.
</p>
</blockquote></li>
</ul>
</div>
</div>

<div id="outline-container-orga27f497" class="outline-3">
<h3 id="orga27f497">10.16 <code>sigsuspend</code> Function</h3>
<div class="outline-text-3" id="text-orga27f497">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigsuspend</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> *<span style="color: #715ab1;">sigmask</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: &#8722;1 with errno set to EINTR</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 74: </span>Figure 10.22 Protecting a critical region from a signal</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.22.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Protecting a critical region from a signal</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   the correct way to protect a critical region of code from a speci&#64257;c signal.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_int</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span><span style="color: #3a81c3;">)</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> <span style="color: #715ab1;">newmask</span>, <span style="color: #715ab1;">oldmask</span>, <span style="color: #715ab1;">waitmask</span>;

  pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"program start: "</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #6c3163;">)</span>;

  sigemptyset<span style="color: #6c3163;">(</span>&amp;waitmask<span style="color: #6c3163;">)</span>;
  sigaddset<span style="color: #6c3163;">(</span>&amp;waitmask, SIGUSR1<span style="color: #6c3163;">)</span>;
  sigemptyset<span style="color: #6c3163;">(</span>&amp;newmask<span style="color: #6c3163;">)</span>;
  sigaddset<span style="color: #6c3163;">(</span>&amp;newmask, SIGINT<span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">block SIGINT and save current signal mask</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">critical region of code</span>
  pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"in critical region: "</span><span style="color: #6c3163;">)</span>;
  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">pause, allowing all signals except SIGUSR1</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigsuspend<span style="color: #2d9574;">(</span>&amp;waitmask<span style="color: #2d9574;">)</span> != -<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"sigsuspend error"</span><span style="color: #6c3163;">)</span>;

  pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"after return from sigsuspend"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">reset signal mask which unblock SIGINT</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">and continue processing...</span>
  pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"program exit: "</span><span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_int</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"\nin sig_int: "</span><span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 75: </span>Figure 10.23 Using sigsuspend to wait for a global variable to be set</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.23.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    wait for a signal handler to set a global variable</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  catch both the interrupt signal and the quit signal,</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  but want to wake up the main routine only when the quit signal is caught.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #3a81c3; font-weight: bold;">volatile</span> <span style="color: #ba2f59; font-weight: bold;">sig_atomic_t</span> <span style="color: #715ab1;">quitflag</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">one signal handler for SIGINT and SIGQUIT</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_int</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signo == SIGINT<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\ninterrupt\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signo == SIGQUIT<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    quitflag = <span style="color: #4e3163;">1</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">set flag for main loop</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> <span style="color: #715ab1;">newmask</span>, <span style="color: #715ab1;">oldmask</span>, <span style="color: #715ab1;">zeromask</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGQUIT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGQUIT) error"</span><span style="color: #6c3163;">)</span>;

  sigemptyset<span style="color: #6c3163;">(</span>&amp;zeromask<span style="color: #6c3163;">)</span>;
  sigemptyset<span style="color: #6c3163;">(</span>&amp;newmask<span style="color: #6c3163;">)</span>;
  sigaddset<span style="color: #6c3163;">(</span>&amp;newmask, SIGQUIT<span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">block SIGQUIT and save current signal mask.</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>quitflag == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> sigsuspend<span style="color: #6c3163;">(</span>&amp;zeromask<span style="color: #6c3163;">)</span>;

  quitflag = <span style="color: #4e3163;">0</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #6c3163;">)</span>;

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 76: </span>Figure 10.24 Routines to allow a parent and child to synchronize</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.24.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Routines to allow a parent and child to synchronize</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  show how signals can be used to synchronize a parent and child.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #3a81c3; font-weight: bold;">volatile</span> <span style="color: #ba2f59; font-weight: bold;">sig_atomic_t</span> <span style="color: #715ab1;">sigflag</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">set nonzero by sig handler</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">sigset_t</span>              <span style="color: #715ab1;">newmask</span>, <span style="color: #715ab1;">oldmask</span>, <span style="color: #715ab1;">zeromask</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">one signal handler for SIGUSR1 and SIGUSR2</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_usr</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> sigflag = <span style="color: #4e3163;">1</span>; <span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">TELL_WAIT</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGUSR1) error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR2, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGUSR2) error"</span><span style="color: #6c3163;">)</span>;

  sigemptyset<span style="color: #6c3163;">(</span>&amp;zeromask<span style="color: #6c3163;">)</span>;
  sigemptyset<span style="color: #6c3163;">(</span>&amp;newmask<span style="color: #6c3163;">)</span>;
  sigaddset<span style="color: #6c3163;">(</span>&amp;newmask, SIGUSR1<span style="color: #6c3163;">)</span>;
  sigaddset<span style="color: #6c3163;">(</span>&amp;newmask, SIGUSR2<span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">block SIGUSR1 and SIGUSR2, and save current signal mask</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">TELL_PARENT</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> kill<span style="color: #6c3163;">(</span>pid, SIGUSR2<span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">WAIT_PARENT</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>sigflag == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> sigsuspend<span style="color: #6c3163;">(</span>&amp;zeromask<span style="color: #6c3163;">)</span>;

  sigflag = <span style="color: #4e3163;">0</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">TELL_CHILD</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> kill<span style="color: #6c3163;">(</span>pid, SIGUSR1<span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">WAIT_CHILD</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>sigflag == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> sigsuspend<span style="color: #6c3163;">(</span>&amp;zeromask<span style="color: #6c3163;">)</span>;
  sigflag = <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<ol class="org-ol">
<li>Block SIGINT and SIGALRM.</li>

<li>Test the two global variables to see whether either signal has occurred and, if so, handle the condition.</li>

<li>Call read (or any other system function) and unblock the two signals, as an atomic operation.</li>
</ol>

<p>
The sigsuspend function helps us only if step 3 is a pause operation.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org2ce66d5" class="outline-3">
<h3 id="org2ce66d5">10.17 <code>abort</code> Function</h3>
<div class="outline-text-3" id="text-org2ce66d5">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">abort</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 77: </span>Figure 10.25 Implementation of POSIX.1 <code>abort</code></label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.25.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Implementation of POSIX.1 abort</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">POSIX-style abort() function</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">abort</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span>         <span style="color: #715ab1;">mask</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sigaction</span> <span style="color: #715ab1;">action</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">caller can't ignore SIGABRT, if so reset to defautl</span>
  sigaction<span style="color: #6c3163;">(</span>SIGABRT, <span style="color: #4e3163;">NULL</span>, &amp;action<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>action.sa_handler == SIG_IGN<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    action.sa_handler = SIG_DFL;
    sigaction<span style="color: #2d9574;">(</span>SIGABRT, &amp;action, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>action.sa_handler == SIG_DFL<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    fflush<span style="color: #2d9574;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">flush all open stdio streams</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">caller can't block SIGABRT; make sure it's unblocked</span>
  sigfillset<span style="color: #6c3163;">(</span>&amp;mask<span style="color: #6c3163;">)</span>;
  sigdelset<span style="color: #6c3163;">(</span>&amp;mask, SIGABRT<span style="color: #6c3163;">)</span>;
  sigprocmask<span style="color: #6c3163;">(</span>SIG_SETMASK, &amp;mask, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  kill<span style="color: #6c3163;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGABRT<span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">if we're here, process caught SIGABRT and returned</span>
  fflush<span style="color: #6c3163;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  action.sa_handler = SIG_DFL;
  sigaction<span style="color: #6c3163;">(</span>SIG_DFL, &amp;action, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  sigprocmask<span style="color: #6c3163;">(</span>SIG_SETMASK, &amp;mask, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  kill<span style="color: #6c3163;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGABRT<span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb641332" class="outline-3">
<h3 id="orgb641332">10.18 <code>system</code> Function</h3>
<div class="outline-text-3" id="text-orgb641332">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 78: </span>Figure 10.26 Using <code>system</code> to invoke the <code>ed</code> editor</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.26.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Using system to invoke the ed editor</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_int</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"caught SIGINT\n"</span><span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_chld</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"caught SIGCHLD\n"</span><span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGCHLD, sig_chld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"signal(SIGCHLD) error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>system<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/ed"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #6c3163;">)</span>;

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>


<div class="figure">
<p><img src="Chapter10/fig10.27.png" alt="fig10.27.png" />
</p>
<p><span class="figure-number">Figure 4: </span>Figure 10.27 Foreground and background process groups for Figure 10.26</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 79: </span>Figure 10.28 Correct POSIX.1 implementation of <code>system</code> function</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.28.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Correct POSIX.1 implementation of system function</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  implementation of the system function with the required signal handling</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">with appropriate signal handling</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">system</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">cmdstring</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span>            <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>              <span style="color: #715ab1;">status</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sigaction</span> <span style="color: #715ab1;">ignore</span>, <span style="color: #715ab1;">saveintr</span>, <span style="color: #715ab1;">savequit</span>;
  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span>         <span style="color: #715ab1;">chldmask</span>, <span style="color: #715ab1;">savemask</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>cmdstring == <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">always a command processor with UNIX</span>
  <span style="color: #6c3163;">}</span>

  ignore.sa_handler = SIG_IGN;
  sigemptyset<span style="color: #6c3163;">(</span>&amp;ignore.sa_mask<span style="color: #6c3163;">)</span>;
  ignore.sa_flags = <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;ignore, &amp;saveintr<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;ignore, &amp;savequit<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;

  sigemptyset<span style="color: #6c3163;">(</span>&amp;chldmask<span style="color: #6c3163;">)</span>;
  sigaddset<span style="color: #6c3163;">(</span>&amp;chldmask, SIGCHLD<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;chldmask, &amp;savemask<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    status = -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">restore previous signal actions &amp; reset signal mask</span>
    sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;saveintr, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span>;
    sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;savequit, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span>;
    sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;savemask, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span>;

    execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"sh"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
    _exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">127</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">exec error</span>
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        status = -<span style="color: #4e3163;">1</span>;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">error other than EINTR from waitpid()</span>
        <span style="color: #3a81c3; font-weight: bold;">break</span>;
      <span style="color: #67b11d;">}</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">restore previous signal actions &amp; reset signal mask</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;saveintr, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;savequit, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;savemask, <span style="color: #4e3163;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>status<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org29630d4" class="outline-3">
<h3 id="org29630d4">10.19 <code>sleep</code>, <code>nanaosleep</code>, and <code>clock_nanosleep</code> Functions</h3>
<div class="outline-text-3" id="text-org29630d4">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sleep</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">seconds</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 or number of unslept seconds</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 80: </span>Figure 10.29 Reliable implementation of <code>sleep</code></label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     10.29.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Implementation of the POSIX.1 sleep function</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  modification of figure 10.17, hands signals reliably</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  avoiding the race condition in the earlier implementation</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_alrm</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">nothing to do, just return wakes up sigsuspend()</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sleep</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">seconds</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sigaction</span> <span style="color: #715ab1;">newact</span>, <span style="color: #715ab1;">oldact</span>;
  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span>         <span style="color: #715ab1;">newmask</span>, <span style="color: #715ab1;">oldmask</span>, <span style="color: #715ab1;">suspmask</span>;
  <span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">int</span>     <span style="color: #715ab1;">unslept</span>;

  newact.sa_handler = sig_alrm;
  sigemptyset<span style="color: #6c3163;">(</span>&amp;newact.sa_mask<span style="color: #6c3163;">)</span>;
  newact.sa_flags = <span style="color: #4e3163;">0</span>;
  sigaction<span style="color: #6c3163;">(</span>SIGALRM, &amp;newact, &amp;oldact<span style="color: #6c3163;">)</span>;

  sigemptyset<span style="color: #6c3163;">(</span>&amp;newmask<span style="color: #6c3163;">)</span>;
  sigaddset<span style="color: #6c3163;">(</span>&amp;newmask, SIGALRM<span style="color: #6c3163;">)</span>;
  sigprocmask<span style="color: #6c3163;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #6c3163;">)</span>;

  alarm<span style="color: #6c3163;">(</span>seconds<span style="color: #6c3163;">)</span>;
  suspmask = oldmask;

  sigdelset<span style="color: #6c3163;">(</span>&amp;suspmask, SIGALRM<span style="color: #6c3163;">)</span>;

  sigsuspend<span style="color: #6c3163;">(</span>&amp;suspmask<span style="color: #6c3163;">)</span>;

  unslept = alarm<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;

  sigaction<span style="color: #6c3163;">(</span>SIGALRM, &amp;oldact, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;

  sigprocmask<span style="color: #6c3163;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>unslept<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">clock_nanosleep</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">clockid_t</span> <span style="color: #715ab1;">clock_id</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">flags</span>,
                    <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">timespec</span>* <span style="color: #715ab1;">reqtp</span>, <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">timespec</span>* <span style="color: #715ab1;">remtp</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if slept for requested time or error number on failue</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org022e56e" class="outline-3">
<h3 id="org022e56e">10.20 <code>sigqueue</code> Function</h3>
<div class="outline-text-3" id="text-org022e56e">
<ul class="org-ul">
<li>Specify the SA_SIGINFO ﬂag when we install a signal handler using the sigaction function</li>
<li>Provide a signal handler in the sa_sigaction member of the sigaction structure instead of using the usual sa_handler ﬁeld.</li>
<li><p>
Use the sigqueue function to send signals.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sigqueue</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">union</span> <span style="color: #ba2f59; font-weight: bold;">sigval</span> <span style="color: #715ab1;">value</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Figure 10.30 Behavior of queued signals on various platforms</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Behavior</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD8.0</th>
<th scope="col" class="org-left">Linux3.2.0</th>
<th scope="col" class="org-left">Mac OSX</th>
<th scope="col" class="org-left">Solaris</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">supports sigqueue</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">queues other signals besides SIGRTMIN to SIGRTMAX</td>
<td class="org-left">optional</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">queues signals even if the caller don't use the SA_SIGINFO flags</td>
<td class="org-left">optional</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>

<div id="outline-container-orge349563" class="outline-3">
<h3 id="orge349563">10.21 Job-Control Signals</h3>
<div class="outline-text-3" id="text-orge349563">
<p>
job-control signals:
   SIGCHLD   Child process has stopped or terminated
   SIGCONT   Continue process, if stopped.
   SIGSTOP   Stop signal(can't caught or ignored)
   SIGTSTP   Interactive stop signal.
   SIGTTIN   Read from controlling terminately by background process group number
   SIGTTOU   Write to controlling terminal by a background process group member
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 81: </span>Figure 10.31 How to handle SIGTSTP</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.31.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    How to handle SIGTSTP</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">BUFFSIZE</span> <span style="color: #4e3163;">1024</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">signal handler to SIGTSTP</span>
<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">sig_tstp</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> <span style="color: #715ab1;">mask</span>;

  sigemptyset<span style="color: #6c3163;">(</span>&amp;mask<span style="color: #6c3163;">)</span>;
  sigaddset<span style="color: #6c3163;">(</span>&amp;mask, SIGTSTP<span style="color: #6c3163;">)</span>;
  sigprocmask<span style="color: #6c3163;">(</span>SIG_UNBLOCK, &amp;mask, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;

  signal<span style="color: #6c3163;">(</span>SIGTSTP, SIG_DFL<span style="color: #6c3163;">)</span>;
  kill<span style="color: #6c3163;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGTSTP<span style="color: #6c3163;">)</span>;

  signal<span style="color: #6c3163;">(</span>SIGTSTP, sig_tstp<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #715ab1;">n</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>BUFFSIZE<span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signal<span style="color: #2d9574;">(</span>SIGTSTP, SIG_IGN<span style="color: #2d9574;">)</span> == SIG_DFL<span style="color: #6c3163;">)</span> signal<span style="color: #6c3163;">(</span>SIGTSTP, sig_tstp<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, buf, BUFFSIZE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>write<span style="color: #2d9574;">(</span>STDOUT_FILENO, buf, n<span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>n &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> err_sys<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org00b12f3" class="outline-3">
<h3 id="org00b12f3">10.22 Signal Names and Numbers</h3>
<div class="outline-text-3" id="text-org00b12f3">
<p>
map between signal numbers and names.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #3a81c3; font-weight: bold;">extern</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">sys_siglist</span><span style="color: #3a81c3;">[]</span>;
</pre>
</div>

<p>
in a portable manner
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">psignal</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">msg</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>

<p>
print signal information
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">psiginfo</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">siginfo_t</span>* <span style="color: #715ab1;">info</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">msg</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>

<p>
string description of the signal and don't necessarily wnat to write it to standard error
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #6c3163; font-weight: bold;">strsignal</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: a pointer to a string describing the signal</span>
</pre>
</div>

<p>
<b>Solaris provides</b>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sig2str</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">str2sig</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> *<span style="color: #715ab1;">signop</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org08abb99" class="outline-3">
<h3 id="org08abb99">10.23 Summary</h3>
<div class="outline-text-3" id="text-org08abb99">
<ul class="org-ul">
<li>Example
<ul class="org-ul">
<li><p>
10.1
</p>
<blockquote>
<p>
terminates the first time
<code>pause</code> until a signal is received from either the kill(2) function or an interval timer
</p>
</blockquote></li>
<li><p>
10.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     ex10.2.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    example code for 10.2</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sig2str</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signo &lt;= <span style="color: #4e3163;">0</span> || signo &gt;= NSIG<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>
  snprintf<span style="color: #6c3163;">(</span>str, SIG2STR_MAX, <span style="color: #2d9574;">"%s"</span>, sys_siglist<span style="color: #2d9574;">[</span>signo<span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li>10.3
<a href="Chapter10/ex10.3.png"><img src="file:///Users/zhoush/Documents/Notes/books/system/APUE/Chapter10/ex10.3.png" alt="ex10.3.png" /></a></li>
<li>10.4
race condition between first call <code>alarm</code> and <code>setjmp</code></li>
<li>10.5
<a href="http://www.kohala.com/start/libes.timers.txt">www.kohala.com/start/libes.timers.txt</a></li>
<li><p>
10.6
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     exx10.6.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-29</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   zhoushang <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    test figure 10.24</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">FILE</span> *<span style="color: #715ab1;">fp</span> = fopen<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"a.txt"</span>, <span style="color: #2d9574;">"w+"</span><span style="color: #6c3163;">)</span>;

  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">num</span> = <span style="color: #4e3163;">0</span>;

  fwrite<span style="color: #6c3163;">(</span>&amp;num, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>num<span style="color: #2d9574;">)</span>, <span style="color: #4e3163;">1</span>, fp<span style="color: #6c3163;">)</span>;

  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span> = fork<span style="color: #6c3163;">()</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fread(&amp;num, sizeof(num), 1, fp);</span>
    ++num;
    fwrite<span style="color: #2d9574;">(</span>&amp;num, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>num<span style="color: #67b11d;">)</span>, <span style="color: #4e3163;">1</span>, fp<span style="color: #2d9574;">)</span>;
    fprintf<span style="color: #2d9574;">(</span>stdout, <span style="color: #2d9574;">"child process: %d\n"</span>, num<span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fread(&amp;num, sizeof(num), 1, fp);</span>
  ++num;
  fwrite<span style="color: #6c3163;">(</span>&amp;num, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>num<span style="color: #2d9574;">)</span>, <span style="color: #4e3163;">1</span>, fp<span style="color: #6c3163;">)</span>;
  fprintf<span style="color: #6c3163;">(</span>stdout, <span style="color: #2d9574;">"parent process: %d\n"</span>, num<span style="color: #6c3163;">)</span>;

  fclose<span style="color: #6c3163;">(</span>fp<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li><p>
10.7
</p>
<blockquote>
<p>
the termination status of the process would not show that it was terminated by the SIGABRT signal.
</p>
</blockquote></li>
<li><p>
10.8
</p>
<blockquote>
<p>
If the signal was sent by a process owned by some other user, the process has to be set-user-ID to either root or to the owner of the receiving process, or the kill attempt won’t work. Therefore, the real user ID provides more information to the receiver of the signal.
</p>
</blockquote></li>
<li><p>
10.9
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig10.14.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-27</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Print the signal mask for the process</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   shows a function that prints the names of the signals in the signal mask of</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * the calling process.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pr_mask</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">sigset_t</span> <span style="color: #715ab1;">sigset</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>      <span style="color: #715ab1;">errno_save</span>;

  errno_save = errno;  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">we can be canceld by signal handlers</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>sigprocmask<span style="color: #2d9574;">(</span><span style="color: #4e3163;">0</span>, <span style="color: #4e3163;">NULL</span>, &amp;sigset<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"sigprocmask error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s"</span>, str<span style="color: #2d9574;">)</span>;

    <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span> = <span style="color: #4e3163;">1</span>; signo &lt; NSIG; ++signo<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>sigismember<span style="color: #b1951d;">(</span>&amp;sigset, signo<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"%s "</span>, strdup<span style="color: #3a81c3;">(</span>sys_signame<span style="color: #6c3163;">[</span>signo<span style="color: #6c3163;">]</span><span style="color: #3a81c3;">)</span><span style="color: #b1951d;">)</span>;
      <span style="color: #67b11d;">}</span>
    <span style="color: #2d9574;">}</span>

    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  errno = errno_save;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span> pr_mask<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"starting main"</span><span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li><p>
10.10
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     ex10.10.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-11-03</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   zhoushang <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">spawn.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">extern</span> <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">log_to_stderr</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">cron</span><span style="color: #3a81c3;">()</span> <span style="color: #3a81c3;">{</span>
  log_to_stderr = <span style="color: #4e3163;">0</span>;
  log_open<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"ex10.10"</span>, <span style="color: #4e3163;">0</span>, <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">i</span> = <span style="color: #4e3163;">0</span>;; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>i % <span style="color: #4e3163;">5</span> == <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #ba2f59; font-weight: bold;">time_t</span>    <span style="color: #715ab1;">t</span>  = time<span style="color: #67b11d;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #67b11d;">)</span>;
      <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">tm</span> <span style="color: #715ab1;">st</span> = <span style="color: #67b11d;">{}</span>;

      localtime_r<span style="color: #67b11d;">(</span>&amp;t, &amp;st<span style="color: #67b11d;">)</span>;
      log_msg<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"time_of day: %02d:%02d:%02d"</span>, st.tm_hour, st.tm_min, st.tm_sec<span style="color: #67b11d;">)</span>;
      log_msg<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"tm_sec: %d"</span>, st.tm_sec<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    sleep<span style="color: #2d9574;">(</span><span style="color: #4e3163;">60</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> **<span style="color: #715ab1;">env</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span> = <span style="color: #4e3163;">0</span>;
  daemonize<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span>;
  cron<span style="color: #6c3163;">()</span>;
  exit<span style="color: #6c3163;">(</span>EXIT_SUCCESS<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
<li><p>
10.11
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">BUFFSIZ</span> <span style="color: #4e3163;">10</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #715ab1;">n</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>  <span style="color: #715ab1;">ret</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>BUFFSIZ<span style="color: #6c3163;">]</span>;

  signal<span style="color: #6c3163;">(</span>SIGXFSZ, signal_intr<span style="color: #6c3163;">)</span>;

  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">in</span>  = open<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>, O_RDONLY<span style="color: #6c3163;">)</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">out</span> = open<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">]</span>, O_CREAT | O_RDWR, <span style="color: #4e3163;">0644</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">rlimit</span> <span style="color: #715ab1;">r</span> = <span style="color: #6c3163;">{</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">}</span>;
  r.rlim_max      = <span style="color: #4e3163;">12</span>;
  setrlimit<span style="color: #6c3163;">(</span>RLIMIT_FSIZE, &amp;r<span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>in, buf, BUFFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ret = write<span style="color: #b1951d;">(</span>out, buf, n<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != n<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">err_sys("write error: %d", ret);</span>
      printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%d write\n"</span>, ret<span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  close<span style="color: #6c3163;">(</span>in<span style="color: #6c3163;">)</span>;
  close<span style="color: #6c3163;">(</span>out<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>n &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<p>
SIGXFSZ never caught
</p></li>
<li><p>
10.12
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     ex10.2.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    example code for 10.2</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">sig2str</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">signo</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">str</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>signo &lt;= <span style="color: #4e3163;">0</span> || signo &gt;= NSIG<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>
  snprintf<span style="color: #6c3163;">(</span>str, SIG2STR_MAX, <span style="color: #2d9574;">"%s"</span>, sys_siglist<span style="color: #2d9574;">[</span>signo<span style="color: #2d9574;">]</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<p>
finished, alarm appears until fwrite finshied, it seems the kernel is blocking SIGALRM
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org63085c3" class="outline-2">
<h2 id="org63085c3">Chapter 11. Threads</h2>
<div class="outline-text-2" id="text-org63085c3">
</div>
<div id="outline-container-org2beece4" class="outline-3">
<h3 id="org2beece4">11.1 Introduction</h3>
</div>
<div id="outline-container-org5677c79" class="outline-3">
<h3 id="org5677c79">11.2 Thread Concepts</h3>
<div class="outline-text-3" id="text-org5677c79">
<p>
benefits
</p>
<ul class="org-ul">
<li>asynchronous</li>
<li>same memory address space and file descriptors</li>
<li>problem partition</li>
<li>seperate portions of the program</li>
</ul>
</div>
</div>
<div id="outline-container-orgeaf402c" class="outline-3">
<h3 id="orgeaf402c">11.3 Thread Identification</h3>
<div class="outline-text-3" id="text-orgeaf402c">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_equal</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid1</span>, <span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid2</span><span style="color: #3a81c3;">)</span>;

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: nonzero if equal, 0 otherwise</span>
</pre>
</div>

<p>
obtain its own thread ID :
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #6c3163; font-weight: bold;">pthread_self</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: the thread ID of the calling thread</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org397db34" class="outline-3">
<h3 id="org397db34">11.4 Thread Creation</h3>
<div class="outline-text-3" id="text-org397db34">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_create</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">tidp</span>,
                   <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">pthread_attr_t</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">attr</span>,
                   <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163;">(</span>*<span style="color: #6c3163; font-weight: bold;">start_rtn</span><span style="color: #6c3163;">)(</span><span style="color: #ba2f59; font-weight: bold;">void</span>*<span style="color: #6c3163;">)</span>,
                   <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #3a81c3; font-weight: bold;">restrict</span> <span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 82: </span>Figure 11.2 Printing thread IDs</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">ntid</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">printids</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">s</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span>     <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid</span>;

  pid = getpid<span style="color: #6c3163;">()</span>;
  tid = pthread_self<span style="color: #6c3163;">()</span>;

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s pid %lu tid %lu (0x%lx)\n"</span>, s, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pid,
         <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tid, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tid<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">thr_fn</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printids<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"new thread: "</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">err</span>;

  pthread_create<span style="color: #6c3163;">(</span>&amp;ntid, <span style="color: #4e3163;">NULL</span>, thr_fn, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't creat thread"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printids<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"main thread: "</span><span style="color: #6c3163;">)</span>;
  sleep<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4631690" class="outline-3">
<h3 id="org4631690">11.5 Thread Termination</h3>
<div class="outline-text-3" id="text-org4631690">
<ol class="org-ol">
<li>thread return from start routine.</li>
<li>can be canceled by another thread in the same process</li>
<li>can call <code>pthread_exit</code></li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pthread_exit</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">rval_ptr</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_join</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">thread</span>, <span style="color: #ba2f59; font-weight: bold;">void</span> **<span style="color: #715ab1;">rval_ptr</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
<blockquote>
<p>
The calling thread will block until the speciﬁed thread calls pthread_exit, returns from its start routine, or is canceled.
</p>
</blockquote>

<blockquote>
<p>
<b>The Linux Programming Language:</b>
If the main thread calls pthread_exit() instead of calling exit() or performing a return, then the other threads continue to execute.
</p>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 83: </span>Figure 11.3 Fetching the thread exit status</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">thr_fn1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 1 returning\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">thr_fn2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 2 returning\n"</span><span style="color: #6c3163;">)</span>;
  pthread_exit<span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">err</span>;
  <span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid1</span>, <span style="color: #715ab1;">tid2</span>;
  <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">tret</span>;

  err = pthread_create<span style="color: #6c3163;">(</span>&amp;tid1, <span style="color: #4e3163;">NULL</span>, thr_fn1, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread1"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  err = pthread_create<span style="color: #6c3163;">(</span>&amp;tid2, <span style="color: #4e3163;">NULL</span>, thr_fn2, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread2"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  err = pthread_join<span style="color: #6c3163;">(</span>tid1, &amp;tret<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join thread1"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 1 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #6c3163;">)</span>;
  err = pthread_join<span style="color: #6c3163;">(</span>tid2, &amp;tret<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join thread2"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 2 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>

<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 84: </span>Figure 11.4 Incorrect use of <code>pthread_exit</code> argument</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig11.4.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-11-05</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   zhoushang <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    Figure 11.4</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *  shows the problem with using an automatic variable (allocated on the stack)</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * as the argument to pthread_exit.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">foo</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">a</span>, <span style="color: #715ab1;">b</span>, <span style="color: #715ab1;">c</span>, <span style="color: #715ab1;">d</span>;
<span style="color: #3a81c3;">}</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">printfoo</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">s</span>, <span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">foo</span> *<span style="color: #715ab1;">fp</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s"</span>, s<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">" structure at 0x%lx\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>fp<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">" foo.a = %d\n"</span>, fp-&gt;a<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">" foo.b = %d\n"</span>, fp-&gt;b<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">" foo.c = %d\n"</span>, fp-&gt;c<span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">" foo.d = %d\n"</span>, fp-&gt;d<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">thr_fn1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">foo</span> <span style="color: #715ab1;">foo</span> = <span style="color: #6c3163;">{</span><span style="color: #4e3163;">1</span>, <span style="color: #4e3163;">2</span>, <span style="color: #4e3163;">3</span>, <span style="color: #4e3163;">4</span><span style="color: #6c3163;">}</span>;
  printfoo<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 1:\n"</span>, &amp;foo<span style="color: #6c3163;">)</span>;
  pthread_exit<span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>&amp;foo<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">thr_fn2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 2: ID is %lu\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">unsigned</span> <span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pthread_self<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span>;
  pthread_exit<span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>         <span style="color: #715ab1;">err</span>;
  <span style="color: #ba2f59; font-weight: bold;">pthread_t</span>   <span style="color: #715ab1;">tid1</span>, <span style="color: #715ab1;">tid2</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">foo</span> *<span style="color: #715ab1;">fp</span>;

  err = pthread_create<span style="color: #6c3163;">(</span>&amp;tid1, <span style="color: #4e3163;">NULL</span>, thr_fn1, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 1"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  err = pthread_join<span style="color: #6c3163;">(</span>tid1, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>&amp;fp<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 1"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  sleep<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;

  err = pthread_create<span style="color: #6c3163;">(</span>&amp;tid2, <span style="color: #4e3163;">NULL</span>, thr_fn2, <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  sleep<span style="color: #6c3163;">(</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
  printfoo<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"parent:\n"</span>, fp<span style="color: #6c3163;">)</span>;

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_cancel</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
in default circumstances, <code>pthread_exit</code> with <b>PTHREAD_CANCELD</b> <br />
doesn't wait for the thread to terminate; it merely makes the request. <br />
similar to <code>atexit</code> used by a process <br />
known as <i>thread cleanup handlers</i>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pthread_cleanup_push</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163;">(</span>*<span style="color: #6c3163; font-weight: bold;">rtn</span><span style="color: #6c3163;">)(</span><span style="color: #ba2f59; font-weight: bold;">void</span>*<span style="color: #6c3163;">)</span>, <span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span>;
<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">pthread_cleanup_pop</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">execute</span><span style="color: #3a81c3;">)</span>;
</pre>
</div>
<blockquote>
<p>
• Makes a call to pthread_exit
• Responds to a cancellation request
• Makes a call to pthread_cleanup_pop with a nonzero execute argument
</p>

<p>
If the execute argument is set to zero, the cleanup function is not called
</p>
</blockquote>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 85: </span>Figure 11.5 Thread cleanup handler</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #ecf3ec;">/**</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @file     fig11.5.c</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @date     2019-11-05</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @author   zhoushang <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> *   @brief    use thread cleanup handlers</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>

<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> <span style="color: #6c3163; font-weight: bold;">cleanup</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span> printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"cleanup: %s\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #2d9574;">)</span>arg<span style="color: #6c3163;">)</span>; <span style="color: #3a81c3;">}</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #b1951d;">NOTE</span><span style="color: #2aa1ae; background-color: #ecf3ec;">: return will be cuz segment fault here</span>
<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">thr_fn1</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 1 start\n"</span><span style="color: #6c3163;">)</span>;
  pthread_cleanup_push<span style="color: #6c3163;">(</span>cleanup, <span style="color: #2d9574;">"thread 1 first handler"</span><span style="color: #6c3163;">)</span>;
  pthread_cleanup_push<span style="color: #6c3163;">(</span>cleanup, <span style="color: #2d9574;">"thread 1 second handler"</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 1 push complete\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>arg<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return ((void *)1);</span>
    pthread_exit<span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #67b11d;">)</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  pthread_cleanup_pop<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
  pthread_cleanup_pop<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
  <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return ((void *)1);</span>
  pthread_exit<span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">thr_fn2</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 2 start\n"</span><span style="color: #6c3163;">)</span>;
  pthread_cleanup_push<span style="color: #6c3163;">(</span>cleanup, <span style="color: #2d9574;">"thread 2 first handler"</span><span style="color: #6c3163;">)</span>;
  pthread_cleanup_push<span style="color: #6c3163;">(</span>cleanup, <span style="color: #2d9574;">"thread 2 second handler"</span><span style="color: #6c3163;">)</span>;
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 2 push complete\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>arg<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    pthread_exit<span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #67b11d;">)</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  pthread_cleanup_pop<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
  pthread_cleanup_pop<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
  pthread_exit<span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>       <span style="color: #715ab1;">err</span>;
  <span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid1</span>, <span style="color: #715ab1;">tid2</span>;
  <span style="color: #ba2f59; font-weight: bold;">void</span> *    <span style="color: #715ab1;">tret</span>;

  err = pthread_create<span style="color: #6c3163;">(</span>&amp;tid1, <span style="color: #4e3163;">NULL</span>, thr_fn1, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 1"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  err = pthread_create<span style="color: #6c3163;">(</span>&amp;tid2, <span style="color: #4e3163;">NULL</span>, thr_fn2, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 2"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  err = pthread_join<span style="color: #6c3163;">(</span>tid1, &amp;tret<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 1"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 1 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #6c3163;">)</span>;
  err = pthread_join<span style="color: #6c3163;">(</span>tid2, &amp;tret<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>err != <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 2"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"thread 2 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #6c3163;">)</span>;
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<blockquote>
<p>
if the thread terminates by returning from its start routine, its cleanup handlers are not called, although this behavior varies among implementations
</p>
</blockquote></li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> Figure 11.6 Comparison of process and thread primitives</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Process primitives</th>
<th scope="col" class="org-left">Thread Primitive</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">fork</td>
<td class="org-left">pthread_create</td>
<td class="org-left">create a new flow of control</td>
</tr>

<tr>
<td class="org-left">exit</td>
<td class="org-left">pthread_exit</td>
<td class="org-left">exit from an existing flow of control</td>
</tr>

<tr>
<td class="org-left">waitpid</td>
<td class="org-left">pthread_join</td>
<td class="org-left">get exit status from flow of control</td>
</tr>

<tr>
<td class="org-left">atexit</td>
<td class="org-left">pthread_cleanup_push</td>
<td class="org-left">register function to be called at exit from flow of control</td>
</tr>

<tr>
<td class="org-left">getpid</td>
<td class="org-left">pthread_self</td>
<td class="org-left">get ID for flow of control</td>
</tr>

<tr>
<td class="org-left">abort</td>
<td class="org-left">pthread_cancel</td>
<td class="org-left">request abnormal termination of flow of control</td>
</tr>
</tbody>
</table>


<p>
detach a thread by calling <code>pthread_detach</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">pthread_detach</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">pthread_t</span> <span style="color: #715ab1;">tid</span><span style="color: #3a81c3;">)</span>;
<span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: 0 if OK, error number on failure</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgcac9643" class="outline-3">
<h3 id="orgcac9643">11.6 Thread Synchronization</h3>
<div class="outline-text-3" id="text-orgcac9643">
<p>
Increment operation:
</p>
<blockquote>
<ol class="org-ol">
<li>Read the memory location into a register.</li>
<li>Increment the value in the register.</li>
<li>Write the new value back to the memory location.</li>
</ol>


<p>
<b>If our data always appears to be sequentially consistent, then we need no additional synchronization.</b>
</p>
</blockquote>
</div>
</div>
</div>


<div id="outline-container-org989d3c5" class="outline-2">
<h2 id="org989d3c5">Chapter 12. Thread Control</h2>
</div>
<div id="outline-container-orgba07661" class="outline-2">
<h2 id="orgba07661">Chapter 13. Daemon Processes</h2>
</div>
<div id="outline-container-org110e165" class="outline-2">
<h2 id="org110e165">Chapter 14. Advanced I/O</h2>
<div class="outline-text-2" id="text-org110e165">
</div>
<div id="outline-container-orgbccc922" class="outline-3">
<h3 id="orgbccc922">14.1 Introduction</h3>
</div>
<div id="outline-container-orgd01eb66" class="outline-3">
<h3 id="orgd01eb66">14.2 Nonblocking I/O</h3>
<div class="outline-text-3" id="text-orgd01eb66">
<p>
slow system calls can block forever. include:
</p>
<ul class="org-ul">
<li>reads if data isn't present with certain file types</li>
<li>writes if data isn't present with certain file types</li>
<li>open conditions</li>
<li>mandatory record locking</li>
<li><code>ioctl</code> options</li>
<li>IPC</li>
</ul>


<p>
two way to specify nonblocking I/O:
</p>
<ol class="org-ol">
<li><code>open</code> to get the descriptor, specify <code>O_NONBLOCK</code> flag</li>
<li>call <code>fcntl</code> to trun on the <code>O_NONBLOCK</code> if already open.</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 86: </span>Figure 14.1 Large nonblocking write</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">buf</span><span style="color: #3a81c3;">[</span><span style="color: #4e3163;">50000</span><span style="color: #3a81c3;">]</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">ntowrite</span>, <span style="color: #715ab1;">nwrite</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">ptr</span>;

  ntowrite = read<span style="color: #6c3163;">(</span>STDIN_FILENO, buf, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  fprintf<span style="color: #6c3163;">(</span>stderr, <span style="color: #2d9574;">"read %d bytes\n"</span>, ntowrite<span style="color: #6c3163;">)</span>;

  set_fl<span style="color: #6c3163;">(</span>STDOUT_FILENO, O_NONBLOCK<span style="color: #6c3163;">)</span>;

  ptr = buf;

  <span style="color: #3a81c3; font-weight: bold;">while</span> <span style="color: #6c3163;">(</span>ntowrite &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno  = <span style="color: #4e3163;">0</span>;
    nwrite = write<span style="color: #2d9574;">(</span>STDOUT_FILENO, ptr, ntowrite<span style="color: #2d9574;">)</span>;
    fprintf<span style="color: #2d9574;">(</span>stderr, <span style="color: #2d9574;">"nwrite = %d, errno = %d\n"</span>, nwrite, errno<span style="color: #2d9574;">)</span>;

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>nwrite &gt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      ptr += nwrite;
      ntowrite -= nwrite;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  clr_fl<span style="color: #6c3163;">(</span>STDOUT_FILENO, O_NONBLOCK<span style="color: #6c3163;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">clear nonblocking */</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org33d3214" class="outline-3">
<h3 id="org33d3214">14.3 Recording Locking</h3>
<div class="outline-text-3" id="text-org33d3214">
<p>
Record locking is the term normally used to describe the ability of a process to prevent other processes from modifying a region of a file while the first process is reading or modifying that portion of the file
</p>
</div>
<div id="outline-container-org31fa03f" class="outline-4">
<h4 id="org31fa03f">1. History</h4>
</div>
<div id="outline-container-orgb61a614" class="outline-4">
<h4 id="orgb61a614">2. <code>fcntl</code> Record Locking</h4>
<div class="outline-text-4" id="text-orgb61a614">
<div class="org-src-container">
<pre class="src src-sh">man <span style="color: #4e3163;">2</span> fcntl
</pre>
</div>

<ul class="org-ul">
<li><p>
Example - Deadlock <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 87: </span>Figure 14.7 Example of deadlock detection</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #3a81c3; font-weight: bold;">static</span> <span style="color: #ba2f59; font-weight: bold;">void</span>
<span style="color: #6c3163; font-weight: bold;">lockabyte</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span>, <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #ba2f59; font-weight: bold;">off_t</span> <span style="color: #715ab1;">offset</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>writew_lock<span style="color: #2d9574;">(</span>fd, offset, SEEK_SET, <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: writew_lock error"</span>, name<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"%s: got the lock, byte %lld\n"</span>, name, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>offset<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>   <span style="color: #715ab1;">fd</span>;
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span> <span style="color: #715ab1;">pid</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   * Create a file and write two bytes to it.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">   */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"templock"</span>, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>write<span style="color: #2d9574;">(</span>fd, <span style="color: #2d9574;">"ab"</span>, <span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  TELL_WAIT<span style="color: #6c3163;">()</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child"</span>, fd, <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
    TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
    WAIT_PARENT<span style="color: #2d9574;">()</span>;
    lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child"</span>, fd, <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent"</span>, fd, <span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
    TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
    WAIT_CHILD<span style="color: #2d9574;">()</span>;
    lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent"</span>, fd, <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>

<li>Advisory versus Mandatory Locking
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 88: </span>Figure 14.12 Determine whether mandatory locking is supported</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>         <span style="color: #715ab1;">fd</span>;
  <span style="color: #ba2f59; font-weight: bold;">pid_t</span>       <span style="color: #715ab1;">pid</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>        <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">5</span><span style="color: #6c3163;">]</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span> <span style="color: #715ab1;">statbuf</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc != <span style="color: #4e3163;">2</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s filename"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #4e3163;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #4e3163;">1</span><span style="color: #b1951d;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>write<span style="color: #2d9574;">(</span>fd, <span style="color: #2d9574;">"abcdef"</span>, <span style="color: #4e3163;">6</span><span style="color: #2d9574;">)</span> != <span style="color: #4e3163;">6</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>fstat<span style="color: #2d9574;">(</span>fd, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>fchmod<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span>statbuf.st_mode &amp; ~S_IXGRP<span style="color: #67b11d;">)</span> | S_ISGID<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fchmod error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  TELL_WAIT<span style="color: #6c3163;">()</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>pid &gt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write_lock<span style="color: #67b11d;">(</span>fd, <span style="color: #4e3163;">0</span>, SEEK_SET, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write_lock error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span> <span style="color: #3a81c3; font-weight: bold;">else</span> <span style="color: #6c3163;">{</span>
    WAIT_PARENT<span style="color: #2d9574;">()</span>;

    set_fl<span style="color: #2d9574;">(</span>fd, O_NONBLOCK<span style="color: #2d9574;">)</span>;

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>read_lock<span style="color: #67b11d;">(</span>fd, <span style="color: #4e3163;">0</span>, SEEK_SET, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span> != -<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: read_lock succeeded"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read_lock of already-locked region returns %d\n"</span>, errno<span style="color: #2d9574;">)</span>;

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lseek<span style="color: #67b11d;">(</span>fd, <span style="color: #4e3163;">0</span>, SEEK_SET<span style="color: #67b11d;">)</span> == -<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"lseek error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>read<span style="color: #67b11d;">(</span>fd, buf, <span style="color: #4e3163;">2</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span>
      err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read failed (mandatory locking works)"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">else</span>
      printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read OK(no mandatory locking), buf = %2.2s\n"</span>, buf<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org03859e4" class="outline-3">
<h3 id="org03859e4">14.4 I/O Multiplexing</h3>
<div class="outline-text-3" id="text-org03859e4">
</div>
<div id="outline-container-org0e2b69b" class="outline-4">
<h4 id="org0e2b69b">14.4.1 <code>select</code> and <code>pselect</code> Functions</h4>
</div>
<div id="outline-container-orgd3e1d00" class="outline-4">
<h4 id="orgd3e1d00">14.4.2 <code>poll</code> Function</h4>
</div>
</div>
<div id="outline-container-orga981457" class="outline-3">
<h3 id="orga981457">14.5 Asynchronous I/O</h3>
<div class="outline-text-3" id="text-orga981457">
</div>
<div id="outline-container-org0ad161d" class="outline-4">
<h4 id="org0ad161d">14.5.1 System V Asynchronous I/O</h4>
</div>
<div id="outline-container-org161cd2c" class="outline-4">
<h4 id="org161cd2c">14.5.2 BSD Asynchronous I/O</h4>
</div>
<div id="outline-container-org2110e06" class="outline-4">
<h4 id="org2110e06">14.5.3 POSIX Asynchronous I/O</h4>
</div>
</div>
<div id="outline-container-org6b82ad4" class="outline-3">
<h3 id="org6b82ad4">14.6 <code>readv</code> and <code>writev</code> Functions</h3>
</div>
<div id="outline-container-org3dd0a34" class="outline-3">
<h3 id="org3dd0a34">14.7 <code>readn</code> and <code>writen</code> Functions</h3>
</div>
<div id="outline-container-orgc99b603" class="outline-3">
<h3 id="orgc99b603">14.8 Memory-Mapped I/O</h3>
<div class="outline-text-3" id="text-orgc99b603">
<ul class="org-ul">
<li>Example
<a href="file:///Users/zhoush/Documents/Private/Notes/books/c/APUE/Chapter14/mcopy2.c">Figure 14.27 Copy a file using memory-mapped I/O</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf457601" class="outline-3">
<h3 id="orgf457601">14.9 Summary</h3>
</div>
</div>
<div id="outline-container-org00237c1" class="outline-2">
<h2 id="org00237c1">Chapter 15. Interprocess Communication</h2>
<div class="outline-text-2" id="text-org00237c1">
</div>
<div id="outline-container-org1223d19" class="outline-3">
<h3 id="org1223d19">15.1 Introduction</h3>
</div>
<div id="outline-container-org37693e5" class="outline-3">
<h3 id="org37693e5">15.2 Pipes</h3>
</div>
<div id="outline-container-org521fb4e" class="outline-3">
<h3 id="org521fb4e">15.3 <code>popen</code> and <code>pclose</code> Functions</h3>
</div>
<div id="outline-container-orgf86c387" class="outline-3">
<h3 id="orgf86c387">15.4 Coprocesses</h3>
</div>
<div id="outline-container-orga9f5767" class="outline-3">
<h3 id="orga9f5767">15.5 FIFOs</h3>
</div>
<div id="outline-container-org118149f" class="outline-3">
<h3 id="org118149f">15.6 XSI IPC</h3>
</div>
<div id="outline-container-org083a2e5" class="outline-3">
<h3 id="org083a2e5">15.6.1 Identifiers and Keys</h3>
</div>
<div id="outline-container-org4ec6315" class="outline-3">
<h3 id="org4ec6315">15.6.2 Permission Structure</h3>
</div>
<div id="outline-container-org3dec06d" class="outline-3">
<h3 id="org3dec06d">15.6.3 Configuration Limits</h3>
</div>
<div id="outline-container-org760ee7c" class="outline-3">
<h3 id="org760ee7c">15.6.4 Advantages and Disadvantages</h3>
</div>
<div id="outline-container-orgc6e03dd" class="outline-3">
<h3 id="orgc6e03dd">15.7 Message Queues</h3>
</div>
<div id="outline-container-org196ed1f" class="outline-3">
<h3 id="org196ed1f">15.8 Semaphores</h3>
</div>
<div id="outline-container-orgf48d20e" class="outline-3">
<h3 id="orgf48d20e">15.9 Shared Memory</h3>
</div>
<div id="outline-container-orgf5c6e84" class="outline-3">
<h3 id="orgf5c6e84">15.10 POSIX Semaphores</h3>
</div>
<div id="outline-container-orgcf02025" class="outline-3">
<h3 id="orgcf02025">15.11 Client-Server Properties</h3>
</div>
<div id="outline-container-orgcfff336" class="outline-3">
<h3 id="orgcfff336">15.12 Summary</h3>
</div>
</div>
<div id="outline-container-org8dba0ee" class="outline-2">
<h2 id="org8dba0ee">Chapter 16. Network IPC: Sockets</h2>
<div class="outline-text-2" id="text-org8dba0ee">
</div>
<div id="outline-container-orga495a0d" class="outline-3">
<h3 id="orga495a0d">16.1 Introduction</h3>
</div>
<div id="outline-container-org01b8de9" class="outline-3">
<h3 id="org01b8de9">16.2 Socket Descriptors</h3>
</div>
<div id="outline-container-org79814fc" class="outline-3">
<h3 id="org79814fc">16.3 Addressing</h3>
<div class="outline-text-3" id="text-org79814fc">
</div>
<div id="outline-container-org6637645" class="outline-4">
<h4 id="org6637645">16.3.1 Byte Ordering</h4>
</div>
<div id="outline-container-org7ea9c3e" class="outline-4">
<h4 id="org7ea9c3e">16.3.2 Address Formats</h4>
</div>
<div id="outline-container-org5127ac7" class="outline-4">
<h4 id="org5127ac7">16.3.3 Address Lookup</h4>
</div>
<div id="outline-container-orgbe8dcd6" class="outline-4">
<h4 id="orgbe8dcd6">16.3.4 Associating Addresses with Sockets</h4>
</div>
</div>
<div id="outline-container-orgeea3e3a" class="outline-3">
<h3 id="orgeea3e3a">16.4 Connection Establishment</h3>
</div>
<div id="outline-container-org40bc859" class="outline-3">
<h3 id="org40bc859">16.5 Data Transfer</h3>
</div>
<div id="outline-container-org1b0a2d1" class="outline-3">
<h3 id="org1b0a2d1">16.6 Socket Options</h3>
</div>
<div id="outline-container-org4150ad5" class="outline-3">
<h3 id="org4150ad5">16.7 Out-of-Band Data</h3>
</div>
<div id="outline-container-org4dfac22" class="outline-3">
<h3 id="org4dfac22">16.8 Nonblocking and Asynchronous I/O</h3>
</div>
<div id="outline-container-orgc029c4a" class="outline-3">
<h3 id="orgc029c4a">16.9 Summary</h3>
</div>
</div>
<div id="outline-container-org68cf1ac" class="outline-2">
<h2 id="org68cf1ac">Chapter 17. Advanced IPC</h2>
<div class="outline-text-2" id="text-org68cf1ac">
</div>
<div id="outline-container-org6927740" class="outline-3">
<h3 id="org6927740">17.1 Introduction</h3>
</div>
<div id="outline-container-org279455d" class="outline-3">
<h3 id="org279455d">17.2 UNIX Domain Sockets</h3>
<div class="outline-text-3" id="text-org279455d">
<ul class="org-ul">
<li><p>
Example &#x2013; Polling XSI Message Queues with the Help of UNIX Domain Sockets
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">poll.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/msg.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">NQ</span> <span style="color: #4e3163;">3</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MAXMSZ</span> <span style="color: #4e3163;">512</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">KEY</span> <span style="color: #4e3163;">0x123</span>

<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">threadinfo</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">qid</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>;
<span style="color: #3a81c3;">}</span>;

<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">mymesg</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">mtype</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">mtext</span><span style="color: #6c3163;">[</span>MAXMSZ<span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>;

<span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #6c3163; font-weight: bold;">helper</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span> *<span style="color: #715ab1;">arg</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>                <span style="color: #715ab1;">n</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">mymesg</span>      <span style="color: #715ab1;">m</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">threadinfo</span> *<span style="color: #715ab1;">tip</span> = arg;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    memset<span style="color: #2d9574;">(</span>&amp;m, <span style="color: #4e3163;">0</span>, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>m<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>n = msgrcv<span style="color: #b1951d;">(</span>tip-&gt;qid, &amp;m, MAXMSZ, <span style="color: #4e3163;">0</span>, MSG_NOERROR<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgrcv error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>tip-&gt;fd, m.mtext, n<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
<span style="color: #3a81c3;">}</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">()</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>               <span style="color: #715ab1;">i</span>, <span style="color: #715ab1;">n</span>, <span style="color: #715ab1;">err</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>               <span style="color: #715ab1;">fd</span><span style="color: #6c3163;">[</span><span style="color: #4e3163;">2</span><span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>               <span style="color: #715ab1;">qid</span><span style="color: #6c3163;">[</span>NQ<span style="color: #6c3163;">]</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">pollfd</span>     <span style="color: #715ab1;">pfd</span><span style="color: #6c3163;">[</span>NQ<span style="color: #6c3163;">]</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">threadinfo</span> <span style="color: #715ab1;">ti</span><span style="color: #6c3163;">[</span>NQ<span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">pthread_t</span>         <span style="color: #715ab1;">tid</span><span style="color: #6c3163;">[</span>NQ<span style="color: #6c3163;">]</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span>              <span style="color: #715ab1;">buf</span><span style="color: #6c3163;">[</span>MAXMSZ<span style="color: #6c3163;">]</span>;

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; NQ; ++i<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>qid<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span> = msgget<span style="color: #b1951d;">(</span><span style="color: #3a81c3;">(</span>KEY + i<span style="color: #3a81c3;">)</span>, IPC_CREAT | <span style="color: #4e3163;">0666</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgget error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"queue ID %d is %d\n"</span>, i, qid<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>socketpair<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_DGRAM, <span style="color: #4e3163;">0</span>, fd<span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"socketpair error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd     = fd<span style="color: #2d9574;">[</span><span style="color: #4e3163;">0</span><span style="color: #2d9574;">]</span>;
    pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.events = POLLIN;
    ti<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.qid     = qid<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>;
    ti<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd      = fd<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>;

    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>err = pthread_create<span style="color: #b1951d;">(</span>&amp;tid<span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span>, <span style="color: #4e3163;">NULL</span>, helper, &amp;ti<span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"pthread_create error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #6c3163;">(</span>;;<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>poll<span style="color: #67b11d;">(</span>pfd, NQ, -<span style="color: #4e3163;">1</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"poll error"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>

    <span style="color: #3a81c3; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #4e3163;">0</span>; i &lt; NQ; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pfd<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>.revents &amp; POLLIN<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #3a81c3;">(</span>n = read<span style="color: #6c3163;">(</span>pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd, buf, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span><span style="color: #3a81c3;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">{</span>
          err_sys<span style="color: #3a81c3;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #3a81c3;">)</span>;
        <span style="color: #b1951d;">}</span>
        buf<span style="color: #b1951d;">[</span>n<span style="color: #b1951d;">]</span> = <span style="color: #4e3163;">0</span>;
        printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"queue id %d, message %s\n"</span>, qid<span style="color: #3a81c3;">[</span>i<span style="color: #3a81c3;">]</span>, buf<span style="color: #b1951d;">)</span>;
      <span style="color: #67b11d;">}</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #6c3163;">}</span>
  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/msg.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">MAXMSZ</span> <span style="color: #4e3163;">512</span>

<span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">mymesg</span> <span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">long</span> <span style="color: #715ab1;">mtype</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> <span style="color: #715ab1;">mtext</span><span style="color: #6c3163;">[</span>MAXMSZ<span style="color: #6c3163;">]</span>;
<span style="color: #3a81c3;">}</span>;

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">argc</span>, <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">argv</span><span style="color: #6c3163;">[]</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">key_t</span>         <span style="color: #715ab1;">key</span>;
  <span style="color: #ba2f59; font-weight: bold;">long</span>          <span style="color: #715ab1;">qid</span>;
  <span style="color: #ba2f59; font-weight: bold;">size_t</span>        <span style="color: #715ab1;">nbytes</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">mymesg</span> <span style="color: #715ab1;">m</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>argc != <span style="color: #4e3163;">3</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    fprintf<span style="color: #2d9574;">(</span>stderr, <span style="color: #2d9574;">"usage: sendmsg KEY message\n"</span><span style="color: #2d9574;">)</span>;
    exit<span style="color: #2d9574;">(</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  key = strtol<span style="color: #6c3163;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #4e3163;">NULL</span>, <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>qid = msgget<span style="color: #67b11d;">(</span>key, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open queue key %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #4e3163;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  memset<span style="color: #6c3163;">(</span>&amp;m, <span style="color: #4e3163;">0</span>, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>m<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  strncpy<span style="color: #6c3163;">(</span>m.mtext, argv<span style="color: #2d9574;">[</span><span style="color: #4e3163;">2</span><span style="color: #2d9574;">]</span>, MAXMSZ - <span style="color: #4e3163;">1</span><span style="color: #6c3163;">)</span>;
  nbytes  = strlen<span style="color: #6c3163;">(</span>m.mtext<span style="color: #6c3163;">)</span>;
  m.mtype = <span style="color: #4e3163;">1</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>msgsnd<span style="color: #2d9574;">(</span>qid, &amp;m, nbytes, <span style="color: #4e3163;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't send message"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  exit<span style="color: #6c3163;">(</span><span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
<div id="outline-container-orgecb93ff" class="outline-4">
<h4 id="orgecb93ff">17.2.1 Naming UNIX Domain Sockets</h4>
<div class="outline-text-4" id="text-orgecb93ff">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 89: </span>Figure 17.5 Binding an address to a UNIX domain socket</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">apue.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">main</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">void</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">fd</span>, <span style="color: #715ab1;">size</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_un</span>
      <span style="color: #715ab1;">un</span>;

  un.sun_family = AF_UNIX;
  strcpy<span style="color: #6c3163;">(</span>un.sun_path, <span style="color: #2d9574;">"foo.socket"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span><span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"socket failed"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  size = offsetof<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #6c3163;">)</span> + strlen<span style="color: #6c3163;">(</span>un.sun_path<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span><span style="color: #6c3163;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, size<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bind failed"</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  printf<span style="color: #6c3163;">(</span><span style="color: #2d9574;">"UNIX domain socket bound\n"</span><span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #4e3163;">0</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9872d72" class="outline-3">
<h3 id="org9872d72">17.3 Unique Connections</h3>
<div class="outline-text-3" id="text-org9872d72">
<p>
develop three functions can be used to create unique connections between unrelated processes running on same machine:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">serv_listen</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>;            <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: file descriptor to listen on if OK, negative value on error</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">serv_accept</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">listenfd</span>, <span style="color: #ba2f59; font-weight: bold;">uid_t</span> *<span style="color: #715ab1;">uidptr</span><span style="color: #3a81c3;">)</span>; <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: new file descriptor if OK, negative value on Error</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">cli_conn</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>;               <span style="color: #2aa1ae; background-color: #ecf3ec;">// </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns: file descriptor if OK, negative value on error</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">QLEN</span> <span style="color: #4e3163;">10</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * Create a server endpoint of a connection.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * Returns fd if all OK, &lt;0 on error.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">serv_listen</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>                <span style="color: #715ab1;">fd</span>, <span style="color: #715ab1;">len</span>, <span style="color: #715ab1;">err</span>, <span style="color: #715ab1;">rval</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_un</span> <span style="color: #715ab1;">un</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>strlen<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span> &gt;= <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = ENAMETOOLONG;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create a UNIX domain stream socket */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">in case it already exists */</span>
  unlink<span style="color: #6c3163;">(</span>name<span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fill in socket address structure */</span>
  memset<span style="color: #6c3163;">(</span>&amp;un, <span style="color: #4e3163;">0</span>, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  un.sun_family = AF_UNIX;
  strcpy<span style="color: #6c3163;">(</span>un.sun_path, name<span style="color: #6c3163;">)</span>;
  len = offsetof<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #6c3163;">)</span> + strlen<span style="color: #6c3163;">(</span>name<span style="color: #6c3163;">)</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">bind the name to the descriptor */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, len<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    rval = -<span style="color: #4e3163;">3</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>listen<span style="color: #2d9574;">(</span>fd, QLEN<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">tell kernel we're a server */</span>
    rval = -<span style="color: #4e3163;">4</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fd<span style="color: #6c3163;">)</span>;

 <span style="color: #4e3163;">errout</span>:
  err = errno;
  close<span style="color: #6c3163;">(</span>fd<span style="color: #6c3163;">)</span>;
  errno = err;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>rval<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-center">
<p>
Figure 17.8 The <code>serv_listen</code> function
</p>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">STALE</span> <span style="color: #4e3163;">30</span> <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">client's name can't be older than this (sec) */</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/**********************************************************</span><span style="color: #2aa1ae; background-color: #ecf3ec;">/</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Wait for a client connection to arrive, and accept it. */</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">We also obtain the client's user ID from the pathname  */</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">that it must bind before calling us.                   */</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">Returns new fd if all OK, &lt;0 on error                  */</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;">/**********************************************************</span><span style="color: #2aa1ae; background-color: #ecf3ec;">/</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">serv_accept</span><span style="color: #3a81c3;">(</span><span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #715ab1;">listenfd</span>, <span style="color: #ba2f59; font-weight: bold;">uid_t</span> *<span style="color: #715ab1;">uidptr</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>                <span style="color: #715ab1;">clifd</span>, <span style="color: #715ab1;">err</span>, <span style="color: #715ab1;">rval</span>;
  <span style="color: #ba2f59; font-weight: bold;">socklen_t</span>          <span style="color: #715ab1;">len</span>;
  <span style="color: #ba2f59; font-weight: bold;">time_t</span>             <span style="color: #715ab1;">staletime</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_un</span> <span style="color: #715ab1;">un</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">stat</span>        <span style="color: #715ab1;">statbuf</span>;
  <span style="color: #ba2f59; font-weight: bold;">char</span> *             <span style="color: #715ab1;">name</span>;

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">allocate enough space for longest name plus terminating null */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>name = malloc<span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span>un.sun_path<span style="color: #b1951d;">)</span> + <span style="color: #4e3163;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  len = <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #6c3163;">(</span>un<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>clifd = accept<span style="color: #67b11d;">(</span>listenfd, <span style="color: #b1951d;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #b1951d;">)</span>&amp;un, &amp;len<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    free<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span>;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #4e3163;">2</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">obtain the client't uid from its calling address */</span>
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">len of pathname */</span>
  len -= offsetof<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #6c3163;">)</span>;
  memcpy<span style="color: #6c3163;">(</span>name, un.sun_path, len<span style="color: #6c3163;">)</span>;
  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">null terminate */</span>
  name<span style="color: #6c3163;">[</span>len<span style="color: #6c3163;">]</span> = <span style="color: #4e3163;">0</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>stat<span style="color: #2d9574;">(</span>name, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    rval = -<span style="color: #4e3163;">3</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>

<span style="color: #6c3163;">#ifdef</span> S_ISSOCK
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>S_ISSOCK<span style="color: #2d9574;">(</span>statbuf.st_mode<span style="color: #2d9574;">)</span> == <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">not a socket */</span>
    rval = -<span style="color: #4e3163;">4</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>
<span style="color: #6c3163;">#endif</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>statbuf.st_mode &amp; <span style="color: #67b11d;">(</span>S_IRWXG | S_IRWXO<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> ||
      <span style="color: #2d9574;">(</span>statbuf.st_mode &amp; S_IRWXU<span style="color: #2d9574;">)</span> != S_IRWXU<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">is not rwx------ */</span>
    rval = -<span style="color: #4e3163;">5</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>

  staletime = time<span style="color: #6c3163;">(</span><span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> - STALE;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>statbuf.st_atime &lt; staletime ||
      statbuf.st_ctime &lt; staletime ||
      statbuf.st_mtime &lt; staletime<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">i-node is too old */</span>;
    rval = -<span style="color: #4e3163;">6</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>uidptr != <span style="color: #4e3163;">NULL</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">return uid of caller */</span>
    *uidptr = statbuf.st_uid;
  <span style="color: #6c3163;">}</span>
  unlink<span style="color: #6c3163;">(</span>name<span style="color: #6c3163;">)</span>;
  free<span style="color: #6c3163;">(</span>name<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>clifd<span style="color: #6c3163;">)</span>;

 <span style="color: #4e3163;">errout</span>:
  err = errno;
  close<span style="color: #6c3163;">(</span>clifd<span style="color: #6c3163;">)</span>;
  free<span style="color: #6c3163;">(</span>name<span style="color: #6c3163;">)</span>;
  errno = err;
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>rval<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
<div class="org-center">
<p>
Figure 17.9 The <code>serv_accept</code> function
</p>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 90: </span>Figure 17.10 The <code>cli_conn</code> function</label><pre class="src src-c"><span style="color: #6c3163;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #3a81c3;">&gt;</span>
<span style="color: #6c3163;">#include</span> <span style="color: #3a81c3;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #3a81c3;">&gt;</span>

<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">CLI_PATH</span> <span style="color: #2d9574;">"/var/tmp"</span>
<span style="color: #6c3163;">#define</span> <span style="color: #715ab1;">CLI_PERM</span> S_IRWXU <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">rwx for user only */</span>

<span style="color: #2aa1ae; background-color: #ecf3ec;">/*</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * Create a client endpoint and connect to a server.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> * Returns fd if all OK, &lt;0 on error.</span>
<span style="color: #2aa1ae; background-color: #ecf3ec;"> */</span>
<span style="color: #ba2f59; font-weight: bold;">int</span> <span style="color: #6c3163; font-weight: bold;">cli_conn</span><span style="color: #3a81c3;">(</span><span style="color: #3a81c3; font-weight: bold;">const</span> <span style="color: #ba2f59; font-weight: bold;">char</span> *<span style="color: #715ab1;">name</span><span style="color: #3a81c3;">)</span>
<span style="color: #3a81c3;">{</span>
  <span style="color: #ba2f59; font-weight: bold;">int</span>                <span style="color: #715ab1;">fd</span>, <span style="color: #715ab1;">len</span>, <span style="color: #715ab1;">err</span>, <span style="color: #715ab1;">rval</span>;
  <span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_un</span> <span style="color: #715ab1;">un</span>, <span style="color: #715ab1;">sun</span>;
  <span style="color: #ba2f59; font-weight: bold;">int</span>                <span style="color: #715ab1;">do_unlink</span> = <span style="color: #4e3163;">0</span>;

  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>strlen<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span> &gt;= <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    errno = ENAMETOOLONG;
    <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #4e3163;">1</span><span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">create a UNIX domain stream socket */</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #4e3163;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    <span style="color: #3a81c3; font-weight: bold;">return</span> -<span style="color: #4e3163;">1</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fill socket address structure with our address */</span>
  memset<span style="color: #6c3163;">(</span>&amp;un, <span style="color: #4e3163;">0</span>, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  un.sun_family = AF_UNIX;
  sprintf<span style="color: #6c3163;">(</span>un.sun_path, <span style="color: #2d9574;">"%s%05ld"</span>, CLI_PATH, <span style="color: #2d9574;">(</span><span style="color: #ba2f59; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span><span style="color: #6c3163;">)</span>;
  len = offsetof<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">typeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span>, sun_path<span style="color: #6c3163;">)</span>;

  unlink<span style="color: #6c3163;">(</span>un.sun_path<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, len<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    rval = -<span style="color: #4e3163;">2</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>chmod<span style="color: #2d9574;">(</span>un.sun_path, CLI_PERM<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    rval      = -<span style="color: #4e3163;">3</span>;
    do_unlink = <span style="color: #4e3163;">1</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>

  <span style="color: #2aa1ae; background-color: #ecf3ec;">/* </span><span style="color: #2aa1ae; background-color: #ecf3ec;">fill socket address structure with server's address */</span>
  memset<span style="color: #6c3163;">(</span>&amp;un, <span style="color: #4e3163;">0</span>, <span style="color: #3a81c3; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span><span style="color: #6c3163;">)</span>;
  sun.sun_family = AF_UNIX;
  strcpy<span style="color: #6c3163;">(</span>sun.sun_path, name<span style="color: #6c3163;">)</span>;
  len = offsetof<span style="color: #6c3163;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #6c3163;">)</span> + strlen<span style="color: #6c3163;">(</span>name<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>connect<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #3a81c3; font-weight: bold;">struct</span> <span style="color: #ba2f59; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;sun, len<span style="color: #2d9574;">)</span> &lt; <span style="color: #4e3163;">0</span><span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    rval      = -<span style="color: #4e3163;">4</span>;
    do_unlink = <span style="color: #4e3163;">1</span>;
    <span style="color: #3a81c3; font-weight: bold;">goto</span> <span style="color: #4e3163;">errout</span>;
  <span style="color: #6c3163;">}</span>
  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>fd<span style="color: #6c3163;">)</span>;

<span style="color: #4e3163;">errout</span>:
  err = errno;
  close<span style="color: #6c3163;">(</span>fd<span style="color: #6c3163;">)</span>;
  <span style="color: #3a81c3; font-weight: bold;">if</span> <span style="color: #6c3163;">(</span>do_unlink<span style="color: #6c3163;">)</span> <span style="color: #6c3163;">{</span>
    unlink<span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span>;
  <span style="color: #6c3163;">}</span>
  errno = err;

  <span style="color: #3a81c3; font-weight: bold;">return</span> <span style="color: #6c3163;">(</span>rval<span style="color: #6c3163;">)</span>;
<span style="color: #3a81c3;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org720ecfb" class="outline-3">
<h3 id="org720ecfb">17.4 Passing File Descriptors</h3>
</div>
<div id="outline-container-orga886b95" class="outline-3">
<h3 id="orga886b95">17.5 An Open Server, Version 1</h3>
</div>
<div id="outline-container-orged19e0b" class="outline-3">
<h3 id="orged19e0b">17.6 An Open Server, Version 2</h3>
</div>
<div id="outline-container-org6f29ddd" class="outline-3">
<h3 id="org6f29ddd">17.7 Summary</h3>
</div>
</div>
<div id="outline-container-org681bc74" class="outline-2">
<h2 id="org681bc74">Chapter 18. Terminal I/O</h2>
</div>
<div id="outline-container-orgc54714b" class="outline-2">
<h2 id="orgc54714b">Chapter 19. Pseudo Terminals</h2>
</div>
<div id="outline-container-org91b1ad0" class="outline-2">
<h2 id="org91b1ad0">Chapter 20. A Database Library</h2>
</div>
<div id="outline-container-orgc681a41" class="outline-2">
<h2 id="orgc681a41">Chapter 21. Communication with a Network Printer</h2>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<code>signalstack</code>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: zhoush</p>
<p class="date">Created: 2019-11-06 Wed 00:33</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>

<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-12-07 Sat 00:54 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="whiothes" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://39.105.199.190/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://39.105.199.190/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://39.105.199.190/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="http://39.105.199.190/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc34660f">Advanced Programming in the Unix Environment <code>[57%]</code></a>
<ul>
<li><a href="#org6a8899a"><span class="done DONE">DONE</span> Chapter 1. UNIX System Overview <code>[12/12]</code></a>
<ul>
<li><a href="#org25ad958"><span class="done DONE">DONE</span> 1.1 Introduction</a></li>
<li><a href="#orgd781354"><span class="done DONE">DONE</span> 1.2 UNIX Architecture</a></li>
<li><a href="#org9923f68"><span class="done DONE">DONE</span> 1.3 Logging in</a></li>
<li><a href="#orgdfc984e"><span class="done DONE">DONE</span> 1.4 Files and Directories</a></li>
<li><a href="#orgb682057"><span class="done DONE">DONE</span> 1.5 Input and Output - File Descriptors</a></li>
<li><a href="#org36269c4"><span class="done DONE">DONE</span> 1.6 Programs and Processes</a></li>
<li><a href="#org307e43e"><span class="done DONE">DONE</span> 1.7 Error Handling</a></li>
<li><a href="#orge2c12ed"><span class="done DONE">DONE</span> 1.8 User identification</a></li>
<li><a href="#org3fc549d"><span class="done DONE">DONE</span> 1.9 Signals</a></li>
<li><a href="#org42a519c"><span class="done DONE">DONE</span> 1.10 Time Values</a></li>
<li><a href="#org6bd2f86"><span class="done DONE">DONE</span> 1.11 System calls and Library Functions</a></li>
<li><a href="#org6a81b29"><span class="done DONE">DONE</span> 1.12 Summary</a></li>
</ul>
</li>
<li><a href="#org19281f7"><span class="done DONE">DONE</span> Chapter 2. UNIX Standardization and Implementations <code>[10/10]</code></a>
<ul>
<li><a href="#orgc20b26c"><span class="done DONE">DONE</span> 2.1 Introduction</a></li>
<li><a href="#orgc21a281"><span class="done DONE">DONE</span> 2.2 UNIX Standardization</a></li>
<li><a href="#orgded0371"><span class="done DONE">DONE</span> 2.3 UNIX System Implementations</a></li>
<li><a href="#org5d600b9"><span class="done DONE">DONE</span> 2.4 Relationship of Standards and Implementations</a></li>
<li><a href="#orgec824d3"><span class="done DONE">DONE</span> 2.5 Limits</a></li>
<li><a href="#org4cd3d43"><span class="done DONE">DONE</span> 2.6 Options</a></li>
<li><a href="#org1aabbac"><span class="done DONE">DONE</span> 2.7 Features Test Macros</a></li>
<li><a href="#org36fb426"><span class="done DONE">DONE</span> 2.8 Primitive System Data Types</a></li>
<li><a href="#orgef940dc"><span class="done DONE">DONE</span> 2.9 Differences Between Standards</a></li>
<li><a href="#org4d9f9d6"><span class="done DONE">DONE</span> 2.10 Summary</a></li>
</ul>
</li>
<li><a href="#orgfd18792"><span class="done DONE">DONE</span> Chapter 3. File I/O <code>[17/17]</code></a>
<ul>
<li><a href="#org272f3bd"><span class="done DONE">DONE</span> 3.1 Introduction</a></li>
<li><a href="#org5f513f4"><span class="done DONE">DONE</span> 3.2 File Descriptors</a></li>
<li><a href="#org190824e"><span class="done DONE">DONE</span> 3.3 <code>open</code> and <code>openat</code> Functions</a></li>
<li><a href="#org09fc23f"><span class="done DONE">DONE</span> 3.4 <code>creat</code> Function</a></li>
<li><a href="#orgf6792ec"><span class="done DONE">DONE</span> 3.5 <code>close</code> Function</a></li>
<li><a href="#orgeda89f0"><span class="done DONE">DONE</span> 3.6 <code>lseek</code> Function</a></li>
<li><a href="#org3a82437"><span class="done DONE">DONE</span> 3.7 <code>read</code> Function</a></li>
<li><a href="#org80e808b"><span class="done DONE">DONE</span> 3.8 <code>write</code> Function</a></li>
<li><a href="#org39b2fc3"><span class="done DONE">DONE</span> 3.9 I/O Efficiency</a></li>
<li><a href="#org23a6e84"><span class="done DONE">DONE</span> 3.10 File Sharing</a></li>
<li><a href="#org0379de7"><span class="done DONE">DONE</span> 3.11 Atomic Operations</a></li>
<li><a href="#orgad24b3c"><span class="done DONE">DONE</span> 3.12 <code>dup</code> and <code>dup2</code> Functions</a></li>
<li><a href="#orgaa75bf9"><span class="done DONE">DONE</span> 3.13 <code>sync</code>, <code>fsync</code> and <code>fdatasync</code> Functions</a></li>
<li><a href="#org4ada53d"><span class="done DONE">DONE</span> 3.14 <code>fcntl</code> Function</a></li>
<li><a href="#orgad05a75"><span class="done DONE">DONE</span> 3.15 <code>ioctl</code> Function</a></li>
<li><a href="#orgca50c80"><span class="done DONE">DONE</span> 3.16 <code>/dev/fd</code></a></li>
<li><a href="#org63ae911"><span class="done DONE">DONE</span> 3.17 Summary</a></li>
</ul>
</li>
<li><a href="#org7225b83"><span class="done DONE">DONE</span> Chapter 4. System Data Files and Information <code>[26/26]</code></a>
<ul>
<li><a href="#org7770e5b"><span class="done DONE">DONE</span> 4.1 Introduction</a></li>
<li><a href="#orgbed2874"><span class="done DONE">DONE</span> 4.2 <code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</a></li>
<li><a href="#orga1f2a58"><span class="done DONE">DONE</span> 4.3 File Types</a></li>
<li><a href="#org6ff6009"><span class="done DONE">DONE</span> 4.4 Set-User-ID and Set-Group-ID</a></li>
<li><a href="#org3a8e695"><span class="done DONE">DONE</span> 4.5 File Access Permissions</a></li>
<li><a href="#org23027b3"><span class="done DONE">DONE</span> 4.6 Ownership of New Files and Directories</a></li>
<li><a href="#orgfe90bd1"><span class="done DONE">DONE</span> <code>access</code> and <code>faccessat</code> Functions</a></li>
<li><a href="#orgf5dc56d"><span class="done DONE">DONE</span> <code>umask</code> Function</a></li>
<li><a href="#org98b4eb5"><span class="done DONE">DONE</span> <code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</a></li>
<li><a href="#orgf78e4da"><span class="done DONE">DONE</span> Sticky Bit</a></li>
<li><a href="#orgf908789"><span class="done DONE">DONE</span> <code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</a></li>
<li><a href="#org5faf2c6"><span class="done DONE">DONE</span> File Size</a></li>
<li><a href="#orgf5127e4"><span class="done DONE">DONE</span> File Truncation</a></li>
<li><a href="#org102dd8b"><span class="done DONE">DONE</span> File Systems</a></li>
<li><a href="#orgab3bf28"><span class="done DONE">DONE</span> <code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</a></li>
<li><a href="#orgf151e8c"><span class="done DONE">DONE</span> <code>rename</code> and <code>renameat</code> Functions</a></li>
<li><a href="#org6446b8b"><span class="done DONE">DONE</span> Symbolic Links</a></li>
<li><a href="#org3360221"><span class="done DONE">DONE</span> Creating and Reading Symbolic Links</a></li>
<li><a href="#org7a0ea4e"><span class="done DONE">DONE</span> File Times</a></li>
<li><a href="#org90b7073"><span class="done DONE">DONE</span> <code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</a></li>
<li><a href="#orga8b4e72"><span class="done DONE">DONE</span> <code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</a></li>
<li><a href="#orga1c3470"><span class="done DONE">DONE</span> Reading Directories</a></li>
<li><a href="#org36da4ff"><span class="done DONE">DONE</span> <code>chidr</code>, <code>fchdir</code> and <code>getcwd</code> Functions</a></li>
<li><a href="#orgaaecad7"><span class="done DONE">DONE</span> Device Special Files</a></li>
<li><a href="#orgdbaf593"><span class="done DONE">DONE</span> Summary of File Access Permission Bits</a></li>
<li><a href="#orga8be04c"><span class="done DONE">DONE</span> Summary</a></li>
</ul>
</li>
<li><a href="#orgc90da49"><span class="done DONE">DONE</span> Chapter 5. Standard I/O Library <code>[16/16]</code></a>
<ul>
<li><a href="#org6e65f1f"><span class="done DONE">DONE</span> 5.1 Introduction</a></li>
<li><a href="#org8ba92d2"><span class="done DONE">DONE</span> 5.2 Streams and FILE Objects</a></li>
<li><a href="#orgb7e9d87"><span class="done DONE">DONE</span> 5.3 Standard Input, Standard Output and Standard Error</a></li>
<li><a href="#orgccb378b"><span class="done DONE">DONE</span> 5.4 Buffering</a></li>
<li><a href="#org54a7bdf"><span class="done DONE">DONE</span> 5.5 Opening a Stream</a></li>
<li><a href="#orge5d8891"><span class="done DONE">DONE</span> 5.6 Reading and Writing a Stream</a></li>
<li><a href="#org3dccaef"><span class="done DONE">DONE</span> 5.9 Line-at-a-Time I/O</a></li>
<li><a href="#org040ffa9"><span class="done DONE">DONE</span> 5.10 Standard I/O Efficiency</a></li>
<li><a href="#org3f60888"><span class="done DONE">DONE</span> 5.11 Binary I/O</a></li>
<li><a href="#orgd7a0e2a"><span class="done DONE">DONE</span> 5.12 Positioning a Stream</a></li>
<li><a href="#orgb6c6cda"><span class="done DONE">DONE</span> 5.13 Formated I/O</a></li>
<li><a href="#org21e646c"><span class="done DONE">DONE</span> 5.14 Implementation Details</a></li>
<li><a href="#org712151f"><span class="done DONE">DONE</span> 5.15 Temporary Files</a></li>
<li><a href="#org156ff07"><span class="done DONE">DONE</span> 5.16 Memory Streams</a></li>
<li><a href="#org6f98f7c"><span class="done DONE">DONE</span> 5.17 Alternatives to Standard I/O</a></li>
<li><a href="#orgd4f8749"><span class="done DONE">DONE</span> 5.18 Summary</a></li>
</ul>
</li>
<li><a href="#org6824f3d"><span class="done DONE">DONE</span> Chapter 6. System Data Files and Information <code>[11/11]</code></a>
<ul>
<li><a href="#orgb8432b3"><span class="done DONE">DONE</span> 6.1 introduction</a></li>
<li><a href="#orgd953df5"><span class="done DONE">DONE</span> 6.2 Password File</a></li>
<li><a href="#orgdba6abd"><span class="done DONE">DONE</span> 6.3 Shadow Passwords</a></li>
<li><a href="#org2eeac26"><span class="done DONE">DONE</span> 6.4 Group File</a></li>
<li><a href="#org2368957"><span class="done DONE">DONE</span> 6.5 Supplementary Group Ids</a></li>
<li><a href="#org6a01649"><span class="done DONE">DONE</span> 6.6 Implementation Differences</a></li>
<li><a href="#org4778996"><span class="done DONE">DONE</span> 6.7 Other Data Files</a></li>
<li><a href="#orgbf33631"><span class="done DONE">DONE</span> 6.8 Login Accounting</a></li>
<li><a href="#org2c85f2f"><span class="done DONE">DONE</span> 6.9 System Identification</a></li>
<li><a href="#orgcf92238"><span class="done DONE">DONE</span> 6.10 Time and Date Routines</a></li>
<li><a href="#org06c71b4"><span class="done DONE">DONE</span> 6.11 Summary</a></li>
</ul>
</li>
<li><a href="#org00e321d"><span class="done DONE">DONE</span> Chapter 7. Process Environment <code>[11/11]</code></a>
<ul>
<li><a href="#org40c7c0c"><span class="done DONE">DONE</span> 7.1 Introduction</a></li>
<li><a href="#org3506e95"><span class="done DONE">DONE</span> 7.2 main Function</a></li>
<li><a href="#org99b0b80"><span class="done DONE">DONE</span> 7.3 Process Termination</a></li>
<li><a href="#orge943de0"><span class="done DONE">DONE</span> 7.5 Environment List</a></li>
<li><a href="#orgeb46dba"><span class="done DONE">DONE</span> 7.6 Memory Layout of a C Program</a></li>
<li><a href="#org1d65d5b"><span class="done DONE">DONE</span> 7.7 Shared Libraries</a></li>
<li><a href="#org262d039"><span class="done DONE">DONE</span> 7.8 Memory Allocation</a></li>
<li><a href="#org282c190"><span class="done DONE">DONE</span> 7.9 Environment Variable</a></li>
<li><a href="#org1a55068"><span class="done DONE">DONE</span> 7.10 <code>setjmp</code> and <code>longjmp</code> Functions</a></li>
<li><a href="#org9e8b04f"><span class="done DONE">DONE</span> <code>getrlimit</code> and <code>setrlimit</code> Functions</a></li>
<li><a href="#org577daf8"><span class="done DONE">DONE</span> Summary</a></li>
</ul>
</li>
<li><a href="#orgf4b03cc"><span class="done DONE">DONE</span> Chapter 8. Process Control <code>[18/18]</code></a>
<ul>
<li><a href="#org872c034"><span class="done DONE">DONE</span> 8.1 Introduction</a></li>
<li><a href="#org3ea31bb"><span class="done DONE">DONE</span> 8.2 Process Identifiers</a></li>
<li><a href="#orge1edbab"><span class="done DONE">DONE</span> 8.3 <code>fork</code> Function</a></li>
<li><a href="#orgfff5212"><span class="done DONE">DONE</span> 8.4 <code>vfork</code> Function</a></li>
<li><a href="#org2ec116d"><span class="done DONE">DONE</span> 8.5 <code>exit</code> Function</a></li>
<li><a href="#org3181d4b"><span class="done DONE">DONE</span> 8.6 <code>wait</code> and <code>waitpid</code> Functions</a></li>
<li><a href="#org4d8a822"><span class="done DONE">DONE</span> 8.7 <code>waitid</code> Function</a></li>
<li><a href="#org5973c19"><span class="done DONE">DONE</span> 8.8 <code>wait3</code> and <code>wait4</code> Functions</a></li>
<li><a href="#org8cb5858"><span class="done DONE">DONE</span> 8.9 Race Conditions</a></li>
<li><a href="#orge504cf4"><span class="done DONE">DONE</span> 8.10 <code>exec</code> Functions</a></li>
<li><a href="#orgcbb3426"><span class="done DONE">DONE</span> 8.11 Changing User IDs and Group IDs</a></li>
<li><a href="#org5b17a1a"><span class="done DONE">DONE</span> 8.12 Interpreter Files</a></li>
<li><a href="#org48d66a7"><span class="done DONE">DONE</span> 8.13 <code>system</code> Function</a></li>
<li><a href="#org64fda0b"><span class="done DONE">DONE</span> 8.14 Process Accounting</a></li>
<li><a href="#org7e6a4cf"><span class="done DONE">DONE</span> 8.15 User Identification</a></li>
<li><a href="#orgdace29d"><span class="done DONE">DONE</span> 8.16 Process Scheduling</a></li>
<li><a href="#org8f8bc81"><span class="done DONE">DONE</span> 8.17 Process Times</a></li>
<li><a href="#org85391e9"><span class="done DONE">DONE</span> 8.18 Summary</a></li>
</ul>
</li>
<li><a href="#org80cda60"><span class="todo TODO">TODO</span> Chapter 9. Process Relationships <code>[8/12]</code></a>
<ul>
<li><a href="#orgbc6c544"><span class="done DONE">DONE</span> 9.1 Introduction</a></li>
<li><a href="#orgafcba00"><span class="done DONE">DONE</span> 9.2 Terminal Logins</a></li>
<li><a href="#orgb21459e"><span class="done DONE">DONE</span> 9.3 Network Logins</a></li>
<li><a href="#orgf03e2b5"><span class="done DONE">DONE</span> 9.4 Process Groups</a></li>
<li><a href="#org2d1098f"><span class="done DONE">DONE</span> 9.5 Sessions</a></li>
<li><a href="#org38e4190"><span class="done DONE">DONE</span> 9.6 Controlling Terminal</a></li>
<li><a href="#org14dc902"><span class="done DONE">DONE</span> 9.7 <code>tcgetpgrp</code>, <code>tcsetpgrp</code>, and <code>tcgetsid</code> Functions</a></li>
<li><a href="#org42c82af"><span class="done DONE">DONE</span> 9.8 Job Control</a></li>
<li><a href="#org529dcdc"><span class="todo TODO">TODO</span> 9.9 Shell Execution Programs</a></li>
<li><a href="#org636c8e4"><span class="todo TODO">TODO</span> 9.10 Orphaned Process Groups</a></li>
<li><a href="#orge9574f9"><span class="todo TODO">TODO</span> 9.11 FreeBSD Implementation</a></li>
<li><a href="#org768b464"><span class="todo TODO">TODO</span> 9.12 Summary</a></li>
</ul>
</li>
<li><a href="#org39f97cf"><span class="done DONE">DONE</span> Chapter 10. Signals <code>[23/23]</code></a>
<ul>
<li><a href="#org0ecc5b3"><span class="done DONE">DONE</span> 10.1 Introduction</a></li>
<li><a href="#orgcfc7dc3"><span class="done DONE">DONE</span> 10.2 Signal Concepts</a></li>
<li><a href="#org8ebfc4a"><span class="done DONE">DONE</span> 10.3 <code>signal</code> Function</a></li>
<li><a href="#org74ee4ba"><span class="done DONE">DONE</span> 10.4 Unreliable Signals</a></li>
<li><a href="#org4a723a3"><span class="done DONE">DONE</span> 10.5 Interrupted System Calls</a></li>
<li><a href="#orgedf77d8"><span class="done DONE">DONE</span> 10.6 Reentrant Functions</a></li>
<li><a href="#org72887f7"><span class="done DONE">DONE</span> 10.7 <code>SIGCLD</code> Semantics</a></li>
<li><a href="#orgb76e5e0"><span class="done DONE">DONE</span> 10.8 Reliable-Signal Terminology and Semantics</a></li>
<li><a href="#orgb8b37c2"><span class="done DONE">DONE</span> 10.9 <code>kill</code> and <code>raise</code> Functions</a></li>
<li><a href="#org9b763fa"><span class="done DONE">DONE</span> 10.10 <code>alarm</code> and <code>pause</code> Functions</a></li>
<li><a href="#org8c0acb1"><span class="done DONE">DONE</span> 10.11 Signal Sets</a></li>
<li><a href="#org6db2879"><span class="done DONE">DONE</span> 10.12 <code>sigprocmask</code> Function</a></li>
<li><a href="#org17cee4c"><span class="done DONE">DONE</span> 10.13 <code>sigpending</code> Function</a></li>
<li><a href="#org9b86ebb"><span class="done DONE">DONE</span> 10.14 <code>sigaction</code> Function</a></li>
<li><a href="#org8791d50"><span class="done DONE">DONE</span> 10.15 <code>sigsetjmp</code> and <code>siglongjmp</code> Functions</a></li>
<li><a href="#org04b4e26"><span class="done DONE">DONE</span> 10.16 <code>sigsuspend</code> Function</a></li>
<li><a href="#orga824d93"><span class="done DONE">DONE</span> 10.17 <code>abort</code> Function</a></li>
<li><a href="#org8eabc0c"><span class="done DONE">DONE</span> 10.18 <code>system</code> Function</a></li>
<li><a href="#org63a32ec"><span class="done DONE">DONE</span> 10.19 <code>sleep</code>, <code>nanaosleep</code>, and <code>clock_nanosleep</code> Functions</a></li>
<li><a href="#org985ca96"><span class="done DONE">DONE</span> 10.20 <code>sigqueue</code> Function</a></li>
<li><a href="#org8599eea"><span class="done DONE">DONE</span> 10.21 Job-Control Signals</a></li>
<li><a href="#org0e361d0"><span class="done DONE">DONE</span> 10.22 Signal Names and Numbers</a></li>
<li><a href="#orgbe09aea"><span class="done DONE">DONE</span> 10.23 Summary</a></li>
</ul>
</li>
<li><a href="#orgaa1df86"><span class="done DONE">DONE</span> Chapter 11. Threads <code>[7/7]</code></a>
<ul>
<li><a href="#org229ea1f"><span class="done DONE">DONE</span> 11.1 Introduction</a></li>
<li><a href="#org8b78ddd"><span class="done DONE">DONE</span> 11.2 Thread Concepts</a></li>
<li><a href="#orgd964f16"><span class="done DONE">DONE</span> 11.3 Thread Identification</a></li>
<li><a href="#org80c82bf"><span class="done DONE">DONE</span> 11.4 Thread Creation</a></li>
<li><a href="#org26bb898"><span class="done DONE">DONE</span> 11.5 Thread Termination</a></li>
<li><a href="#org4034b47"><span class="done DONE">DONE</span> 11.6 Thread Synchronization <code>[8/8]</code></a></li>
<li><a href="#orgc6a4bda"><span class="done DONE">DONE</span> 11.7 Summary</a></li>
</ul>
</li>
<li><a href="#org7d7e4d7"><span class="done DONE">DONE</span> Chapter 12. Thread Control <code>[11/11]</code></a>
<ul>
<li><a href="#org0404cd6"><span class="done DONE">DONE</span> 12.1 Introduction</a></li>
<li><a href="#org0fa29d9"><span class="done DONE">DONE</span> 12.2 Thread Limits</a></li>
<li><a href="#org2b37714"><span class="done DONE">DONE</span> 12.3 Thread Attributes</a></li>
<li><a href="#org6b19957"><span class="done DONE">DONE</span> 12.4 Synchronization Attributes <code>[4/4]</code></a></li>
<li><a href="#orgb66a01d"><span class="done DONE">DONE</span> 12.5 Reentrancy</a></li>
<li><a href="#org12fb964"><span class="done DONE">DONE</span> 12.6 Thread-Specific Data</a></li>
<li><a href="#org065ed2a"><span class="done DONE">DONE</span> 12.7 Cancel Options</a></li>
<li><a href="#orgba8f574"><span class="done DONE">DONE</span> 12.8 Threads and Signals</a></li>
<li><a href="#org03a7263"><span class="done DONE">DONE</span> 12.9 Threads and fork</a></li>
<li><a href="#org5a11998"><span class="done DONE">DONE</span> 12.10 Threads and I/O</a></li>
<li><a href="#orgca197a5"><span class="done DONE">DONE</span> 12.11 Summary</a></li>
</ul>
</li>
<li><a href="#orga5aef9f"><span class="done DONE">DONE</span> Chapter 13. Daemon Processes <code>[8/8]</code></a>
<ul>
<li><a href="#orgc645d93"><span class="done DONE">DONE</span> 13.1 Introduction</a></li>
<li><a href="#orgff2ec7f"><span class="done DONE">DONE</span> 13.2 Daemon Characteristics</a></li>
<li><a href="#org58d84c3"><span class="done DONE">DONE</span> 13.3 Coding Rules</a></li>
<li><a href="#orgb62e93f"><span class="done DONE">DONE</span> 13.4 Error Logging</a></li>
<li><a href="#org6b1d987"><span class="done DONE">DONE</span> 13.5 Single-Instance Daemons</a></li>
<li><a href="#org3b813d5"><span class="done DONE">DONE</span> 13.6 Daemon Conventions</a></li>
<li><a href="#orgd441687"><span class="done DONE">DONE</span> 13.7 Client-Server Model</a></li>
<li><a href="#org01f6fb3"><span class="done DONE">DONE</span> 13.8 Summary</a></li>
</ul>
</li>
<li><a href="#org75e585d"><span class="todo TODO">TODO</span> Chapter 14. Advanced I/O <code>[4/9]</code></a>
<ul>
<li><a href="#org441fab0"><span class="done DONE">DONE</span> 14.1 Introduction</a></li>
<li><a href="#org6e80b83"><span class="done DONE">DONE</span> 14.2 Nonblocking I/O</a></li>
<li><a href="#orga33c554"><span class="done DONE">DONE</span> 14.3 Record Locking</a></li>
<li><a href="#orgee17e44"><span class="todo TODO">TODO</span> 14.4 I/O Multiplexing</a></li>
<li><a href="#org3d1a16b"><span class="todo TODO">TODO</span> 14.5 Asynchronous I/O</a></li>
<li><a href="#org4eaea14"><span class="todo TODO">TODO</span> 14.6 <code>readv</code> and <code>writev</code> Functions</a></li>
<li><a href="#orgca96691"><span class="todo TODO">TODO</span> 14.7 <code>readn</code> and <code>writen</code> Functions</a></li>
<li><a href="#org04940aa"><span class="done DONE">DONE</span> 14.8 Memory-Mapped I/O</a></li>
<li><a href="#orgc744c94"><span class="todo TODO">TODO</span> 14.9 Summary</a></li>
</ul>
</li>
<li><a href="#orgc854a6f"><span class="todo TODO">TODO</span> Chapter 15. Interprocess Communication <code>[0/16]</code></a>
<ul>
<li><a href="#orge62d799"><span class="todo TODO">TODO</span> 15.1 Introduction</a></li>
<li><a href="#org57b8a96"><span class="todo TODO">TODO</span> 15.2 Pipes</a></li>
<li><a href="#orgaa640c3"><span class="todo TODO">TODO</span> 15.3 <code>popen</code> and <code>pclose</code> Functions</a></li>
<li><a href="#org049f0ce"><span class="todo TODO">TODO</span> 15.4 Coprocesses</a></li>
<li><a href="#org3a706cb"><span class="todo TODO">TODO</span> 15.5 FIFOs</a></li>
<li><a href="#orgf666a07"><span class="todo TODO">TODO</span> 15.6 XSI IPC</a></li>
<li><a href="#org281380d"><span class="todo TODO">TODO</span> 15.6.1 Identifiers and Keys</a></li>
<li><a href="#orge56e6b7"><span class="todo TODO">TODO</span> 15.6.2 Permission Structure</a></li>
<li><a href="#org436c06f"><span class="todo TODO">TODO</span> 15.6.3 Configuration Limits</a></li>
<li><a href="#org8487baf"><span class="todo TODO">TODO</span> 15.6.4 Advantages and Disadvantages</a></li>
<li><a href="#orge6e89fc"><span class="todo TODO">TODO</span> 15.7 Message Queues</a></li>
<li><a href="#org2fa6866"><span class="todo TODO">TODO</span> 15.8 Semaphores</a></li>
<li><a href="#orgd3d2603"><span class="todo TODO">TODO</span> 15.9 Shared Memory</a></li>
<li><a href="#orga53c092"><span class="todo TODO">TODO</span> 15.10 POSIX Semaphores</a></li>
<li><a href="#orgf4c52f6"><span class="todo TODO">TODO</span> 15.11 Client-Server Properties</a></li>
<li><a href="#org3cac4b9"><span class="todo TODO">TODO</span> 15.12 Summary</a></li>
</ul>
</li>
<li><a href="#orge1cdc48"><span class="todo TODO">TODO</span> Chapter 16. Network IPC: Sockets <code>[0/9]</code></a>
<ul>
<li><a href="#org251ee8f"><span class="todo TODO">TODO</span> 16.1 Introduction</a></li>
<li><a href="#orgbeeacb3"><span class="todo TODO">TODO</span> 16.2 Socket Descriptors</a></li>
<li><a href="#orga7fbb48"><span class="todo TODO">TODO</span> 16.3 Addressing</a></li>
<li><a href="#org38cba7e"><span class="todo TODO">TODO</span> 16.4 Connection Establishment</a></li>
<li><a href="#org8774dca"><span class="todo TODO">TODO</span> 16.5 Data Transfer</a></li>
<li><a href="#org68f067e"><span class="todo TODO">TODO</span> 16.6 Socket Options</a></li>
<li><a href="#orgdc8a51b"><span class="todo TODO">TODO</span> 16.7 Out-of-Band Data</a></li>
<li><a href="#orgcf4ec2d"><span class="todo TODO">TODO</span> 16.8 Nonblocking and Asynchronous I/O</a></li>
<li><a href="#orgc3507b3"><span class="todo TODO">TODO</span> 16.9 Summary</a></li>
</ul>
</li>
<li><a href="#org2d1d8c0"><span class="todo TODO">TODO</span> Chapter 17. Advanced IPC <code>[2/7]</code></a>
<ul>
<li><a href="#org5ba75db"><span class="todo TODO">TODO</span> 17.1 Introduction</a></li>
<li><a href="#orgeda13d4"><span class="done DONE">DONE</span> 17.2 UNIX Domain Sockets</a></li>
<li><a href="#org1f2a28c"><span class="done DONE">DONE</span> 17.3 Unique Connections</a></li>
<li><a href="#orgb44f2d6"><span class="todo TODO">TODO</span> 17.4 Passing File Descriptors</a></li>
<li><a href="#orgf346128"><span class="todo TODO">TODO</span> 17.5 An Open Server, Version 1</a></li>
<li><a href="#org9091eef"><span class="todo TODO">TODO</span> 17.6 An Open Server, Version 2</a></li>
<li><a href="#org708715b"><span class="todo TODO">TODO</span> 17.7 Summary</a></li>
</ul>
</li>
<li><a href="#org50413d0"><span class="todo TODO">TODO</span> Chapter 18. Terminal I/O <code>[0/0]</code></a></li>
<li><a href="#orgcb75f93"><span class="todo TODO">TODO</span> Chapter 19. Pseudo Terminals <code>[0/0]</code></a></li>
<li><a href="#org4ec6999"><span class="todo TODO">TODO</span> Chapter 20. A Database Library <code>[0/0]</code></a></li>
<li><a href="#org577139c"><span class="todo TODO">TODO</span> Chapter 21. Communication with a Network Printer <code>[0/0]</code></a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgc34660f" class="outline-2">
<h2 id="orgc34660f">Advanced Programming in the Unix Environment <code>[57%]</code></h2>
<div class="outline-text-2" id="text-orgc34660f">
</div>
<div id="outline-container-org6a8899a" class="outline-3">
<h3 id="org6a8899a"><span class="done DONE">DONE</span> Chapter 1. UNIX System Overview <code>[12/12]</code></h3>
<div class="outline-text-3" id="text-org6a8899a">
</div>
<div id="outline-container-org25ad958" class="outline-4">
<h4 id="org25ad958"><span class="done DONE">DONE</span> 1.1 Introduction</h4>
</div>
<div id="outline-container-orgd781354" class="outline-4">
<h4 id="orgd781354"><span class="done DONE">DONE</span> 1.2 UNIX Architecture</h4>
</div>
<div id="outline-container-org9923f68" class="outline-4">
<h4 id="org9923f68"><span class="done DONE">DONE</span> 1.3 Logging in</h4>
<div class="outline-text-4" id="text-org9923f68">
<ul class="org-ul">
<li>Login Name</li>
</ul>
</div>
</div>
<div id="outline-container-orgdfc984e" class="outline-4">
<h4 id="orgdfc984e"><span class="done DONE">DONE</span> 1.4 Files and Directories</h4>
<div class="outline-text-4" id="text-orgdfc984e">
<ul class="org-ul">
<li>File System</li>
<li>Pathname
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Figure 1.3 List all the files in a directory</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">dirent.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">DIR</span>           *<span style="color: #7590db;">dp</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dirent</span> *<span style="color: #7590db;">dirp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ls directory_name"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dp = opendir<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %ls"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dirp = readdir<span style="color: #67b11d;">(</span>dp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>strcoll<span style="color: #67b11d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">"."</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span> &amp;&amp;
            strcoll<span style="color: #67b11d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">".."</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s\n"</span>, dirp-&gt;d_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    closedir<span style="color: #bc6ec5;">(</span>dp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgb682057" class="outline-4">
<h4 id="orgb682057"><span class="done DONE">DONE</span> 1.5 Input and Output - File Descriptors</h4>
<div class="outline-text-4" id="text-orgb682057">
<ul class="org-ul">
<li>Standard Input, Standard Output, and Standard Error</li>
<li>Unbuffered I/O
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Figure 1.4 Copy standard input to standard output</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFFSIZE</span> <span style="color: #a45bad;">4096</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFFSIZE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, buf, BUFFSIZE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>STDOUT_FILENO, buf, n<span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>

<li>Standard I/O
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>Figure 1.5 Copy standard input to standard output, using standard I/O</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>c = getc<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != EOF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>putc<span style="color: #67b11d;">(</span>c, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"input error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org36269c4" class="outline-4">
<h4 id="org36269c4"><span class="done DONE">DONE</span> 1.6 Programs and Processes</h4>
<div class="outline-text-4" id="text-org36269c4">
<ul class="org-ul">
<li>Program</li>
<li>Proceses and Process ID
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Figure 1.6 Print the process ID</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"hello world from process ID %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
<li>Process Control
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Figure 1.7 Read commands from standard input and execute them</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">from apue.h */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">print prompt (printf require %% to print %) */</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span> == <span style="color: #2d9574;">'\n'</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span> = <span style="color: #a45bad;">0</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">replace newline with null */</span>
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            execlp<span style="color: #67b11d;">(</span>buf, buf, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"coulnd't excute: %s"</span>, buf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = waitpid<span style="color: #b1951d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org307e43e" class="outline-4">
<h4 id="org307e43e"><span class="done DONE">DONE</span> 1.7 Error Handling</h4>
<div class="outline-text-4" id="text-org307e43e">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>Figure 1.8 Demonstrate strerror and perror</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    fprintf<span style="color: #bc6ec5;">(</span>stderr, <span style="color: #2d9574;">"EACCESS: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>EACCES<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    errno = ENOENT;
    perror<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orge2c12ed" class="outline-4">
<h4 id="orge2c12ed"><span class="done DONE">DONE</span> 1.8 User identification</h4>
<div class="outline-text-4" id="text-orge2c12ed">
<ul class="org-ul">
<li>User ID</li>
<li>Group ID
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>Figure 1.9 Print user ID and group ID</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     uidgid.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-12-01</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    print uid and gid</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"uid = %d, gid = %d\n"</span>, getuid<span style="color: #2d9574;">()</span>, getgid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
<li>Supplementary Group IDs</li>
</ul>
</div>
</div>
<div id="outline-container-org3fc549d" class="outline-4">
<h4 id="org3fc549d"><span class="done DONE">DONE</span> 1.9 Signals</h4>
<div class="outline-text-4" id="text-org3fc549d">
<p>
Process choices:
</p>
<ol class="org-ol">
<li>Ignore</li>
<li>default action</li>
<li>provide call function (catch signal)</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>Figure 1.10 Read commands from standard input and execute them</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">our signal-catching function */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">from apue.h */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal error"</span><span style="color: #bc6ec5;">)</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%% "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">print prompt (printf requires %% to print %) */</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>strlen<span style="color: #b1951d;">(</span>buf<span style="color: #b1951d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span> == <span style="color: #2d9574;">'\n'</span><span style="color: #2d9574;">)</span>
            buf<span style="color: #2d9574;">[</span>strlen<span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span> = <span style="color: #a45bad;">0</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">replace newline with null */</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            execlp<span style="color: #67b11d;">(</span>buf, buf, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"couldn't execute: %s"</span>, buf<span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span><span style="color: #a45bad;">127</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"interrupt\n%% "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org42a519c" class="outline-4">
<h4 id="org42a519c"><span class="done DONE">DONE</span> 1.10 Time Values</h4>
<div class="outline-text-4" id="text-org42a519c">
<ol class="org-ol">
<li>Calendar time.</li>
<li>Process time.
<ul class="org-ul">
<li>Clock time</li>
<li>User CPU time</li>
<li>System CPU time</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-org6bd2f86" class="outline-4">
<h4 id="org6bd2f86"><span class="done DONE">DONE</span> 1.11 System calls and Library Functions</h4>
<div class="outline-text-4" id="text-org6bd2f86">
<ul class="org-ul">
<li>Concepts:
<ul class="org-ul">
<li>System calls: <br />
<ul class="org-ul">
<li>Can be learned with <code>man 2</code> (Section 2 of <i>Unix Programmer's Mannual</i>)</li>
</ul></li>
<li>Library Functions:
<ul class="org-ul">
<li>Can be learned with <code>man 3</code> for <b>general-purpose</b> (Section 3 of <i>Unix Programmer's Mannual</i>)</li>
<li>These functions aren’t entry points into the kernel, although they may invoke one or more of the kernel’s system calls</li>
</ul></li>
</ul></li>
<li>Distinction:
<ul class="org-ul">
<li>the system calls usually cannot be replaced</li>
<li>UNIX System provides to determine the current time and date</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6a81b29" class="outline-4">
<h4 id="org6a81b29"><span class="done DONE">DONE</span> 1.12 Summary</h4>
<div class="outline-text-4" id="text-org6a81b29">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>1.1</li>
<li>1.2  53268 50922 was occupied</li>
<li>1.3  strerror: int, value transfer, cannnot be changed, global errno cannnot be forecast
perror: pointer, can be changed the value point to, const set constant</li>
<li>1.4  2038, \( \frac{2^{31}}{(60*60*24*365)+1970} \)
change time_t to u_64_t
recompile the program</li>
<li>1.5  \( \frac{2^{31}}{(60*60*24*100)}=248.551348 \) days</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org19281f7" class="outline-3">
<h3 id="org19281f7"><span class="done DONE">DONE</span> Chapter 2. UNIX Standardization and Implementations <code>[10/10]</code></h3>
<div class="outline-text-3" id="text-org19281f7">
</div>
<div id="outline-container-orgc20b26c" class="outline-4">
<h4 id="orgc20b26c"><span class="done DONE">DONE</span> 2.1 Introduction</h4>
</div>
<div id="outline-container-orgc21a281" class="outline-4">
<h4 id="orgc21a281"><span class="done DONE">DONE</span> 2.2 UNIX Standardization</h4>
<div class="outline-text-4" id="text-orgc21a281">
</div>
<ul class="org-ul">
<li><a id="org882c95b"></a><span class="done DONE">DONE</span> ISO C<br /></li>
<li><a id="org8a6602c"></a><span class="done DONE">DONE</span> IEEE POSIX<br /></li>
<li><a id="org4ef80f5"></a><span class="done DONE">DONE</span> The Single UNIX Specification<br />
<div class="outline-text-5" id="text-org4ef80f5">
<ul class="org-ul">
<li>Encryption: denoted by <code>_XOPEN_CRYPE</code></li>
<li>Real-time: denoted by <code>_XOPEN_REALTIME</code></li>
<li>Advanced real-time</li>
<li>Real-time threads: denoted by <code>_XOPEN_REALTIME_THREADS</code></li>
<li>Advanced real-time threads</li>
</ul>
</div>
</li>
<li><a id="org5001956"></a><span class="done DONE">DONE</span> FIPS<br /></li>
</ul>
</div>
<div id="outline-container-orgded0371" class="outline-4">
<h4 id="orgded0371"><span class="done DONE">DONE</span> 2.3 UNIX System Implementations</h4>
<div class="outline-text-4" id="text-orgded0371">
</div>
<ul class="org-ul">
<li><a id="org069184b"></a><span class="done DONE">DONE</span> SVR4<br /></li>
<li><a id="org1c062a2"></a><span class="done DONE">DONE</span> 2.3.1 4.4BSD<br /></li>
<li><a id="org98b6b75"></a><span class="done DONE">DONE</span> 2.3.2 FreeBSD<br /></li>
<li><a id="orge6b8189"></a><span class="done DONE">DONE</span> Linux<br /></li>
<li><a id="orga479811"></a><span class="done DONE">DONE</span> Mac OS X<br /></li>
<li><a id="org9b0adfb"></a><span class="done DONE">DONE</span> SOlaris<br /></li>
<li><a id="org827f495"></a><span class="done DONE">DONE</span> Others<br />
<div class="outline-text-5" id="text-org827f495">
<ul class="org-ul">
<li>AIX, IBMUNIX</li>
<li>HP-UX, HP</li>
<li>IRIX, Silicon Graphics</li>
<li>Unix Ware, SVR4 distribution</li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org5d600b9" class="outline-4">
<h4 id="org5d600b9"><span class="done DONE">DONE</span> 2.4 Relationship of Standards and Implementations</h4>
</div>
<div id="outline-container-orgec824d3" class="outline-4">
<h4 id="orgec824d3"><span class="done DONE">DONE</span> 2.5 Limits</h4>
<div class="outline-text-4" id="text-orgec824d3">
<ol class="org-ol">
<li>Comipile-time limits</li>
<li>Runtime limits</li>
</ol>
</div>
<ul class="org-ul">
<li><a id="orgee3bb79"></a><span class="done DONE">DONE</span> ISO C Limits<br /></li>
<li><a id="org243bff6"></a><span class="done DONE">DONE</span> POSIX Limits<br />
<div class="outline-text-5" id="text-org243bff6">
<ol class="org-ol">
<li>Numerical limits: <code>LONG_BIT</code>, <code>SSIZE_MAX</code>, and <code>WORD_BIT</code></li>
<li>Minimum value：</li>
<li>Maximum value: <code>_POSIX_CLOCKRES_MIN</code></li>
<li>Runtime increasable values: <code>CHARCLASS_NAME_MAX</code>, <code>COLL_WEIGHTS_MAX</code>, <code>LINE_MAX</code>, <code>NGROUPS_MAX</code>, and <code>RE_DUP_MAX</code></li>
<li>Runtime invariant values;</li>
<li>Other invariant values: <code>NL_ARGMAX</code>, <code>NL_MSGMAX</code>, <code>NL_SETMAX</code>, and <code>NL_TEXTMAX</code>;</li>
<li>Pathname variables values: <code>FIFLESIZEBITS</code>, <code>LINK_MAX</code>, <code>MAX_CANON</code>, <code>MAX_INPUT</code>, <code>NAME_MAX</code>, <code>PATH_MAX</code>, <code>PIPE_BUF</code>, and <code>SYMLINK_MAX</code></li>
</ol>
</div>
</li>
<li><a id="org1553f86"></a><span class="done DONE">DONE</span> XSI Limits<br />
<div class="outline-text-5" id="text-org1553f86">
<ol class="org-ol">
<li>Minimum values:</li>
<li>Runtime invariant values, possibly indeterminate: <b>IOV_MAX</b> and <b>PAGE_SIZE</b></li>
</ol>
</div>
</li>
<li><a id="orgdf00569"></a><span class="done DONE">DONE</span> <code>sysconf</code>, <code>pathconf</code>, and <code>fpathconf</code> Functions<br />
<div class="outline-text-5" id="text-orgdf00569">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>Figure 2.13 Build C program to print all supported configuration limits</label><pre class="src src-c">#<span style="color: #a45bad;">!</span>/usr/bin/awk -f

BEGIN   <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"#include \"apue.h\"\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"#include &lt;errno.h&gt;\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"#include &lt;limits.h&gt;\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"static void pr_sysconf(char *, int);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"static void pr_pathconf(char *, char *, int);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"int\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"main(int argc, char *argv[])\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tif (argc != 2)\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\terr_quit(\"usage: a.out &lt;dirname&gt;\");\n\n"</span><span style="color: #bc6ec5;">)</span>
    FS=<span style="color: #2d9574;">"\t+"</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>getline &lt;<span style="color: #2d9574;">"sysconf.sym"</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"%s defined to be %%ld\\n\", (long)%s+0);\n"</span>, $1, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tpr_sysconf(\"%s =\", %s);\n"</span>, $1, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
    <span style="color: #bc6ec5;">}</span>
    close<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sysconf.sym"</span><span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>getline &lt;<span style="color: #2d9574;">"pathconf.sym"</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"%s defined to be %%ld\\n\", (long)%s+0);\n"</span>, $1, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $1<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#ifdef %s\n"</span>, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tpr_pathconf(\"%s =\", argv[1], %s);\n"</span>, $1, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#else\n"</span><span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\tprintf(\"no symbol for %s\\n\");\n"</span>, $2<span style="color: #2d9574;">)</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"#endif\n"</span><span style="color: #2d9574;">)</span>
    <span style="color: #bc6ec5;">}</span>
    close<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pathconf.sym"</span><span style="color: #bc6ec5;">)</span>
    exit
<span style="color: #4f97d7;">}</span>
END <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\texit(0);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"}\n\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"static void\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pr_sysconf(char *mesg, int name)\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tlong  val;\n\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tfputs(mesg, stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\terrno = 0;\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tif ((val = sysconf(name)) &lt; 0) {\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\tif (errno != 0) {\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\tif (errno == EINVAL)\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\t\tfputs(\" (not supported)\\n\", stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\telse\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\t\terr_sys(\"sysconf error\");\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t} else {\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\tfputs(\" (no limit)\\n\", stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t}\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t} else {\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\tprintf(\" %%ld\\n\", val);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t}\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"}\n\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"static void\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pr_pathconf(char *mesg, char *path, int name)\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"{\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tlong val;\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tfputs(mesg, stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\terrno = 0;\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\tif ((val = pathconf(path, name)) &lt; 0) {\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\tif (errno != 0) {\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\tif (errno == EINVAL)\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\t\tfputs(\" (not supported)\\n\", stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\telse\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\t\terr_sys(\"pathconf error, path = %%s\", path);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t} else {\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t\tfputs(\" (no limit)\\n\", stdout);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\t}\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t} else {\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t\tprintf(\" %%ld\\n\", val);\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\t}\n"</span><span style="color: #bc6ec5;">)</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"}\n"</span><span style="color: #bc6ec5;">)</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</li>
<li><a id="orgb548546"></a><span class="done DONE">DONE</span> Indeterminate Runtime Limits<br />
<div class="outline-text-5" id="text-orgb548546">
<ol class="org-ol">
<li></li>
</ol>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>pathalloc</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#ifdef</span>  PATH_MAX
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">pathmax</span> = PATH_MAX;
<span style="color: #bc6ec5;">#else</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">pathmax</span> = <span style="color: #a45bad;">0</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">posix_version</span> = <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">xsi_version</span> = <span style="color: #a45bad;">0</span>;

<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">If PATH_MAX is indeterminate, no guarantee this is adequate */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">PATH_MAX_GUESS</span>  <span style="color: #a45bad;">1024</span>

<span style="color: #ce537a; font-weight: bold;">char</span> *
<span style="color: #bc6ec5; font-weight: bold;">path_alloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">size_t</span> *<span style="color: #7590db;">sizep</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">also return allocated size, if nonnull */</span>
<span style="color: #4f97d7;">{</span>
  <span style="color: #ce537a; font-weight: bold;">char</span>  *<span style="color: #7590db;">ptr</span>;
  <span style="color: #ce537a; font-weight: bold;">size_t</span>  <span style="color: #7590db;">size</span>;

  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>posix_version == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
    posix_version = sysconf<span style="color: #bc6ec5;">(</span>_SC_VERSION<span style="color: #bc6ec5;">)</span>;

  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>xsi_version == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
    xsi_version = sysconf<span style="color: #bc6ec5;">(</span>_SC_XOPEN_VERSION<span style="color: #bc6ec5;">)</span>;

  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pathmax == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>   <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">first time through */</span>
    errno = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pathmax = pathconf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"/"</span>, _PC_PATH_MAX<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>
        pathmax = PATH_MAX_GUESS; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">it's indeterminate */</span>
      <span style="color: #4f97d7; font-weight: bold;">else</span>
        err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"pathconf error for _PC_PATH_MAX"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
      pathmax++;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">add one since it's relative to root */</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #bc6ec5;">}</span>

  <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">   * Before POSIX.1-2001, we aren't guaranteed that PATH_MAX includes</span>
<span style="color: #2aa1ae; background-color: #292e34;">   * the terminating null byte.  Same goes for XPG3.</span>
<span style="color: #2aa1ae; background-color: #292e34;">   */</span>
  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>posix_version &lt; <span style="color: #a45bad;">200112L</span><span style="color: #2d9574;">)</span> &amp;&amp; <span style="color: #2d9574;">(</span>xsi_version &lt; <span style="color: #a45bad;">4</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
    size = pathmax + <span style="color: #a45bad;">1</span>;
  <span style="color: #4f97d7; font-weight: bold;">else</span>
    size = pathmax;

  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ptr = malloc<span style="color: #67b11d;">(</span>size<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
    err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"malloc error for pathname"</span><span style="color: #bc6ec5;">)</span>;

  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sizep != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
    *sizep = size;
  <span style="color: #4f97d7; font-weight: bold;">return</span><span style="color: #bc6ec5;">(</span>ptr<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<ol class="org-ol">
<li></li>
</ol>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>openmax</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#ifdef</span>  OPEN_MAX
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">openmax</span> = OPEN_MAX;
<span style="color: #bc6ec5;">#else</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">openmax</span> = <span style="color: #a45bad;">0</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * If OPEN_MAX is indeterminate, this might be inadequate.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">OPEN_MAX_GUESS</span>  <span style="color: #a45bad;">256</span>

<span style="color: #ce537a; font-weight: bold;">long</span>
<span style="color: #bc6ec5; font-weight: bold;">open_max</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>openmax == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>   <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">first time through */</span>
    errno = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>openmax = sysconf<span style="color: #b1951d;">(</span>_SC_OPEN_MAX<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>
        openmax = OPEN_MAX_GUESS; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">it's indeterminate */</span>
      <span style="color: #4f97d7; font-weight: bold;">else</span>
        err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"sysconf error for _SC_OPEN_MAX"</span><span style="color: #67b11d;">)</span>;
    <span style="color: #2d9574;">}</span>
  <span style="color: #bc6ec5;">}</span>
  <span style="color: #4f97d7; font-weight: bold;">return</span><span style="color: #bc6ec5;">(</span>openmax<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-org4cd3d43" class="outline-4">
<h4 id="org4cd3d43"><span class="done DONE">DONE</span> 2.6 Options</h4>
<div class="outline-text-4" id="text-org4cd3d43">
<ol class="org-ol">
<li>Compile-time options are defined in <code>&lt;unistd.h&gt;</code></li>
<li>Runtime options are not associated with a file or a directory are idnetified with the <code>sysconf</code> function</li>
<li>Runtime options that are associated with a file or a directory are discovered by calling either the <code>pathconf</code> or the <code>fpathconf</code> function</li>
</ol>
</div>
</div>
<div id="outline-container-org1aabbac" class="outline-4">
<h4 id="org1aabbac"><span class="done DONE">DONE</span> 2.7 Features Test Macros</h4>
<div class="outline-text-4" id="text-org1aabbac">
<p>
<code>cc -D_POSIX_C_SOURCE=200809L code.c</code>
</p>
</div>
</div>
<div id="outline-container-org36fb426" class="outline-4">
<h4 id="org36fb426"><span class="done DONE">DONE</span> 2.8 Primitive System Data Types</h4>
<div class="outline-text-4" id="text-org36fb426">
<p>
The header <code>&lt;sys/types.h&gt;</code> defines some implementation-dependent data types, called the <i>primitive system data types</i>.
</p>
</div>
</div>
<div id="outline-container-orgef940dc" class="outline-4">
<h4 id="orgef940dc"><span class="done DONE">DONE</span> 2.9 Differences Between Standards</h4>
</div>
<div id="outline-container-org4d9f9d6" class="outline-4">
<h4 id="org4d9f9d6"><span class="done DONE">DONE</span> 2.10 Summary</h4>
<div class="outline-text-4" id="text-org4d9f9d6">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>2.1  #ifndef &#x2026; #define &#x2026; #endif</li>
<li>2.2  <code>u_long, ushort, uint, u_quad_t, quad_t, qaddr_t, daddr_t, fixpt_t</code></li>
<li><p>
2.3
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>OPEN_MAX exercise</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">OPEN_MAX_GUESS</span> <span style="color: #a45bad;">256</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">open_max</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span>          <span style="color: #7590db;">openmax</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span> <span style="color: #7590db;">rl</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>openmax = sysconf<span style="color: #67b11d;">(</span>_SC_OPEN_MAX<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> || openmax == LONG_MAX<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>getrlimit<span style="color: #67b11d;">(</span>RLIMIT_NOFILE, &amp;rl<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"can&#8242;t get file limit"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>rl.rlim_max == RLIM_INFINITY<span style="color: #2d9574;">)</span>
            openmax = OPEN_MAX_GUESS;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            openmax = rl.rlim_max;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>openmax<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%ld\n"</span>, open_max<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgfd18792" class="outline-3">
<h3 id="orgfd18792"><span class="done DONE">DONE</span> Chapter 3. File I/O <code>[17/17]</code></h3>
<div class="outline-text-3" id="text-orgfd18792">
</div>
<div id="outline-container-org272f3bd" class="outline-4">
<h4 id="org272f3bd"><span class="done DONE">DONE</span> 3.1 Introduction</h4>
</div>
<div id="outline-container-org5f513f4" class="outline-4">
<h4 id="org5f513f4"><span class="done DONE">DONE</span> 3.2 File Descriptors</h4>
<div class="outline-text-4" id="text-org5f513f4">
<p>
To the kernel, all open file are referred to by file descriptors.
</p>
<ul class="org-ul">
<li>0: stdin</li>
<li>1: stdout</li>
<li>2: stderr</li>
</ul>
</div>
</div>
<div id="outline-container-org190824e" class="outline-4">
<h4 id="org190824e"><span class="done DONE">DONE</span> 3.3 <code>open</code> and <code>openat</code> Functions</h4>
<div class="outline-text-4" id="text-org190824e">
<p>
<code>man 2 open</code>
</p>
</div>
</div>
<div id="outline-container-org09fc23f" class="outline-4">
<h4 id="org09fc23f"><span class="done DONE">DONE</span> 3.4 <code>creat</code> Function</h4>
<div class="outline-text-4" id="text-org09fc23f">
<p>
<code>man 2 creat</code>
</p>
</div>
</div>
<div id="outline-container-orgf6792ec" class="outline-4">
<h4 id="orgf6792ec"><span class="done DONE">DONE</span> 3.5 <code>close</code> Function</h4>
<div class="outline-text-4" id="text-orgf6792ec">
<p>
<code>man 2 close</code>
</p>
</div>
</div>
<div id="outline-container-orgeda89f0" class="outline-4">
<h4 id="orgeda89f0"><span class="done DONE">DONE</span> 3.6 <code>lseek</code> Function</h4>
<div class="outline-text-4" id="text-orgeda89f0">
<p>
<code>man 2 lseek</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>Figure 3.1 Test whether standard input is capable of seeking</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lseek<span style="color: #2d9574;">(</span>STDIN_FILENO, <span style="color: #a45bad;">0</span>, SEEK_CUR<span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"seek OK\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>Figure 3.2 Create a file with a hole in it</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf1</span><span style="color: #4f97d7;">[]</span> = <span style="color: #2d9574;">"abcdefghij"</span>;
<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf2</span><span style="color: #4f97d7;">[]</span> = <span style="color: #2d9574;">"ABCDEFGHIJ"</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"file.hole"</span>, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>fd, buf1, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buf1 write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lseek<span style="color: #2d9574;">(</span>fd, <span style="color: #a45bad;">16384</span>, SEEK_SET<span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"lssek error: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>fd, buf2, <span style="color: #a45bad;">10</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buf2 write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3a82437" class="outline-4">
<h4 id="org3a82437"><span class="done DONE">DONE</span> 3.7 <code>read</code> Function</h4>
<div class="outline-text-4" id="text-org3a82437">
<p>
<code>man 2 read</code>
</p>
</div>
</div>
<div id="outline-container-org80e808b" class="outline-4">
<h4 id="org80e808b"><span class="done DONE">DONE</span> 3.8 <code>write</code> Function</h4>
<div class="outline-text-4" id="text-org80e808b">
<p>
<code>man 2 write</code>
</p>
</div>
</div>
<div id="outline-container-org39b2fc3" class="outline-4">
<h4 id="org39b2fc3"><span class="done DONE">DONE</span> 3.9 I/O Efficiency</h4>
<div class="outline-text-4" id="text-org39b2fc3">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>Figure 3.5 Copy standard input to standard output</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">in</span>  = open<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, O_RDONLY<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">out</span> = open<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span>, O_CREAT | O_RDWR, <span style="color: #a45bad;">0644</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>in, buf, BUFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>out, buf, n<span style="color: #67b11d;">)</span> != n<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span>in<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>out<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org23a6e84" class="outline-4">
<h4 id="org23a6e84"><span class="done DONE">DONE</span> 3.10 File Sharing</h4>
<div class="outline-text-4" id="text-org23a6e84">
<ol class="org-ol">
<li>Every process has an entry in the process table.</li>
<li>The kernel maintains a file table for all open files.</li>
<li>Each open file(or device) has a v-node structure that contains information about the type of file <br />
and pointers to functions that operate on the file;</li>
</ol>
</div>
</div>
<div id="outline-container-org0379de7" class="outline-4">
<h4 id="org0379de7"><span class="done DONE">DONE</span> 3.11 Atomic Operations</h4>
<div class="outline-text-4" id="text-org0379de7">
<ul class="org-ul">
<li>Appending to a File</li>
<li><code>pread</code> and <code>pwrite</code> Functions
Calling pread is equivalent to calling lseek followed by a call to read, with the following exceptions.
<ul class="org-ul">
<li>There is no way to interrupt the two operations that occur when we call pread.</li>
<li>The current file offset is not updated.</li>
</ul></li>

<li>Creating a File
<i>atomic operation</i> refers to an operation that might be composed of multiple steps</li>
</ul>
</div>
</div>
<div id="outline-container-orgad24b3c" class="outline-4">
<h4 id="orgad24b3c"><span class="done DONE">DONE</span> 3.12 <code>dup</code> and <code>dup2</code> Functions</h4>
<div class="outline-text-4" id="text-orgad24b3c">
<p>
<code>man 2 dup</code>
</p>
<ul class="org-ul">
<li><code>dup(fd)</code> ~ =fcntl(fd, F_DUPFD, 0)~</li>
<li><code>dup2(fd, fd2)= = =close(fd2); fcntl(fd, F_DUPFD, fd2);</code> <br /></li>
</ul>
<p>
Differences:
</p>
<ul class="org-ul">
<li>dup2 is an atomic operation, whereas the alternate form involves two function calls.</li>
<li>errno differences</li>
</ul>
</div>
</div>
<div id="outline-container-orgaa75bf9" class="outline-4">
<h4 id="orgaa75bf9"><span class="done DONE">DONE</span> 3.13 <code>sync</code>, <code>fsync</code> and <code>fdatasync</code> Functions</h4>
<div class="outline-text-4" id="text-orgaa75bf9">
<p>
<code>man 2 sync</code>
</p>
</div>
</div>
<div id="outline-container-org4ada53d" class="outline-4">
<h4 id="org4ada53d"><span class="done DONE">DONE</span> 3.14 <code>fcntl</code> Function</h4>
<div class="outline-text-4" id="text-org4ada53d">
<p>
<code>man 2 fcntl</code>
The <code>fcntl</code> function is used for five different purposes.
</p>
<ol class="org-ol">
<li>Duplicate an existing descriptor (<i>cmd</i> = <code>F_DUPFD</code> or <code>F_DUPFD_CLOEXEC</code>)</li>
<li>Get/set file descriptor flags (<i>cmd</i> = <code>F_GETFD</code> or <code>F_SETFD</code>)</li>
<li>Get/set file status flags (<i>cmd</i> = <code>F_GETFL</code> or <code>F_SETFL</code>)</li>
<li>Get/set asynchronous I/O ownership (<i>cmd</i> = <code>F_GETOWN</code> or <code>F_SETOWN</code>)</li>
<li>Get/set record locks (<i>cmd</i> = <code>F_GETLK</code>, <code>F_SETLK</code>, or <code>F_SETLKW</code>)</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>Figure 3.11 Print file flags for specified descriptor</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;descriptor#"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>val = fcntl<span style="color: #67b11d;">(</span>atoi<span style="color: #b1951d;">(</span>argv<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span><span style="color: #b1951d;">)</span>, F_GETFL, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl error for  %d: %s"</span>, atoi<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>val &amp; O_ACCMODE<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> O_RDONLY:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read only"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> O_WRONLY:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write only"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> O_RDWR:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read write"</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown access mode"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>val &amp; O_APPEND<span style="color: #bc6ec5;">)</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", append"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>val &amp; O_NONBLOCK<span style="color: #bc6ec5;">)</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", nonblocking"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>val &amp; O_SYNC<span style="color: #bc6ec5;">)</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", synchronous writes"</span><span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">!</span><span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>_POSIX_C_SOURCE<span style="color: #bc6ec5;">)</span> &amp;&amp; <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>O_FSYNC<span style="color: #bc6ec5;">)</span> &amp;&amp; <span style="color: #bc6ec5;">(</span>O_FSYNC != O_SYNC<span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>val &amp; O_FSYNC<span style="color: #bc6ec5;">)</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", synchronous writes"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
    putchar<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'\n'</span><span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>Figure 3.12 Turn on one or more of the file status flags for a descriptor</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">set_fl</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">flags are file status flags to turn on */</span>

<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>val = fcntl<span style="color: #67b11d;">(</span>fd, F_GETFL, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl F_GETFL: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    val |= flags; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">turn on flags */</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fcntl<span style="color: #2d9574;">(</span>fd, F_SETFL, val<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fcntl F_SETFL: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgad05a75" class="outline-4">
<h4 id="orgad05a75"><span class="done DONE">DONE</span> 3.15 <code>ioctl</code> Function</h4>
<div class="outline-text-4" id="text-orgad05a75">
<p>
<code>man 2 ioctl</code>
</p>
</div>
</div>
<div id="outline-container-orgca50c80" class="outline-4">
<h4 id="orgca50c80"><span class="done DONE">DONE</span> 3.16 <code>/dev/fd</code></h4>
</div>
<div id="outline-container-org63ae911" class="outline-4">
<h4 id="org63ae911"><span class="done DONE">DONE</span> 3.17 Summary</h4>
<div class="outline-text-4" id="text-org63ae911">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>3.1  All disk I/O need to via buffer block. <br />
<code>read/write</code> always be buffered via kernel automatically, unbuffered only means user process;</li>
<li><p>
3.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">my_dup2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd2</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd2 &gt; open_max<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * use lseek to verify whether fd is valid</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lseek<span style="color: #2d9574;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_CUR<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> &amp;&amp; errno == EBADF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"file descriptor: %d is not valid, %m\n"</span>, fd<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">return if fd2 is fd */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd == fd2<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> fd2;
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span>fd2<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; open_max<span style="color: #2d9574;">()</span>; i++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        i = dup<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>i == fd2<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">for (; i &gt; fd; i--) { */</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/*   </span><span style="color: #2aa1ae; background-color: #292e34;">close(i); */</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">} */</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fd2<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc &lt; <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;string&gt;"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%ld\n"</span>, open_max<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    my_dup2<span style="color: #bc6ec5;">(</span>STDERR_FILENO, <span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">1</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        write<span style="color: #2d9574;">(</span><span style="color: #a45bad;">5</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, strlen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        write<span style="color: #2d9574;">(</span><span style="color: #a45bad;">5</span>, <span style="color: #2d9574;">"\n"</span>, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li>3.3  F_SETFD: affect fd1 <b>file descriptor</b> <br />
F_SETFL: affect fd1 and fd2 <b>file table</b></li>
<li>3.4  without <code>if (fd &gt; 2)</code>, there are 4 descriptors pointer to file, otherwise , there will be 3</li>
<li>3.5  <code>./a.out &gt; outfile 2&gt;&amp;1</code>: stdout <code>&gt; outfile, stderr =&gt; stdout =&gt; outfile
        =./a.out 2&gt;&amp;1 &gt; outfile</code>: stderr =&gt; stdout, stdout =&gt; outfile <br /></li>
<li><p>
3.6
</p>
<div class="org-src-container">
<pre class="src src-c,">#include &lt;fcntl.h&gt;

#include "apue.h"

int main(int argc, char *argv[argc]) {
    int  fd           = 0;
    int  ret          = 0;
    char buf[MAXLINE] = {0};

    fd = open("./a.txt", O_CREAT | O_RDWR | O_APPEND);
    if (fd &lt; 0) {
        err_sys("open: %s", strerror(errno));
    }

    ret = write(fd, "hello world", 11);
    if (ret &lt; 0) {
        err_sys("write: %s", strerror(errno));
    }

    ret = lseek(fd, 0, SEEK_SET);
    while ((ret = read(fd, buf, MAXLINE))) {
        ;
    }
    if (ret == -1) {
        err_sys("read: %s", strerror(errno));
    }
    printf("read: %s\n", buf);

    ret = lseek(fd, -18, SEEK_CUR);
    ret = write(fd, "hello world", 11);
    if (ret &lt; 0) {
        err_sys("write: %s", strerror(errno));
    }

    ret = lseek(fd, 0, SEEK_SET);
    while ((ret = read(fd, buf, MAXLINE)) &gt; 0) {
        ;
    }
    if (ret == -1) {
        err_sys("read: %s", strerror(errno));
    }
    printf("read: %s\n", buf);

    ret = lseek(fd, 10, SEEK_SET);
    while ((ret = read(fd, buf, MAXLINE)) &gt; 0) {
        ;
    }
    if (ret == -1) {
        err_sys("read: %s", strerror(errno));
    }
    printf("read: %s\n", buf);

    return 0;
}
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org7225b83" class="outline-3">
<h3 id="org7225b83"><span class="done DONE">DONE</span> Chapter 4. System Data Files and Information <code>[26/26]</code></h3>
<div class="outline-text-3" id="text-org7225b83">
</div>
<div id="outline-container-org7770e5b" class="outline-4">
<h4 id="org7770e5b"><span class="done DONE">DONE</span> 4.1 Introduction</h4>
</div>
<div id="outline-container-orgbed2874" class="outline-4">
<h4 id="orgbed2874"><span class="done DONE">DONE</span> 4.2 <code>stat</code>, <code>fstat</code>, <code>fstatat</code>, and <code>lstat</code> Functions</h4>
<div class="outline-text-4" id="text-orgbed2874">
<p>
<code>man 2 stat</code>
</p>
</div>
</div>
<div id="outline-container-orga1f2a58" class="outline-4">
<h4 id="orga1f2a58"><span class="done DONE">DONE</span> 4.3 File Types</h4>
<div class="outline-text-4" id="text-orga1f2a58">
<ol class="org-ol">
<li>Regular file.
There is no distinction to the UNIX kernel whether this data is text or binary.</li>
<li>Directory file.</li>
<li>Block special file.</li>
<li>Character special file.
providing unbuffered I/O access.</li>
<li>FIFO.</li>
<li>Socket</li>
<li>Symbolic link.</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>Figure 4.3 Print type of file for each command-line argument</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">buf</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *      <span style="color: #7590db;">ptr</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lstat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISREG<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"regular"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISLNK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"symbolic link"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISSOCK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"socket"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"block special"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"directory"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"character special"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISFIFO<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"named pipe(fifo)"</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            ptr = <span style="color: #2d9574;">"** unknown mode **"</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, ptr<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org6ff6009" class="outline-4">
<h4 id="org6ff6009"><span class="done DONE">DONE</span> 4.4 Set-User-ID and Set-Group-ID</h4>
<div class="outline-text-4" id="text-org6ff6009">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">IDs</th>
<th scope="col" class="org-left">using for</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">real user ID</td>
<td class="org-left">who we really are</td>
</tr>

<tr>
<td class="org-left">real group ID</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">effective user ID</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">effective group ID</td>
<td class="org-left">used for file access permission checks</td>
</tr>

<tr>
<td class="org-left">supplementary group IDs</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">save set-user-ID</td>
<td class="org-left">saved by exec functions</td>
</tr>

<tr>
<td class="org-left">save set-group-ID</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org3a8e695" class="outline-4">
<h4 id="org3a8e695"><span class="done DONE">DONE</span> 4.5 File Access Permissions</h4>
<div class="outline-text-4" id="text-org3a8e695">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">st_mode mask</th>
<th scope="col" class="org-left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">S_IRUSR</td>
<td class="org-left">user-read</td>
</tr>

<tr>
<td class="org-left">S_IWUSR</td>
<td class="org-left">user-write</td>
</tr>

<tr>
<td class="org-left">S_IXUSR</td>
<td class="org-left">user-execute</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IRGRP</td>
<td class="org-left">group-read</td>
</tr>

<tr>
<td class="org-left">S_IWGRP</td>
<td class="org-left">group-write</td>
</tr>

<tr>
<td class="org-left">S_IXGRP</td>
<td class="org-left">group-execute</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">S_IROTH</td>
<td class="org-left">other-read</td>
</tr>

<tr>
<td class="org-left">S_IWOTH</td>
<td class="org-left">other-write</td>
</tr>

<tr>
<td class="org-left">S_IXOTH</td>
<td class="org-left">other-execute</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org23027b3" class="outline-4">
<h4 id="org23027b3"><span class="done DONE">DONE</span> 4.6 Ownership of New Files and Directories</h4>
</div>
<div id="outline-container-orgfe90bd1" class="outline-4">
<h4 id="orgfe90bd1"><span class="done DONE">DONE</span> <code>access</code> and <code>faccessat</code> Functions</h4>
<div class="outline-text-4" id="text-orgfe90bd1">
<p>
<code>man 2 access</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>Figure 4.8 Example of access function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: a.out &lt;pathname&gt;"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>access<span style="color: #2d9574;">(</span>argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span>, R_OK<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"access error for %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read access OK\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error for %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open for reading OK\n"</span><span style="color: #2d9574;">)</span>;
        close<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgf5dc56d" class="outline-4">
<h4 id="orgf5dc56d"><span class="done DONE">DONE</span> <code>umask</code> Function</h4>
<div class="outline-text-4" id="text-orgf5dc56d">
<p>
<code>man 2 umask</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span>Figure 4.9 Example of umask function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">RWRWRW</span> <span style="color: #4f97d7;">(</span>S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    umask<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>creat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, RWRWRW<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat \"foo\": %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    umask<span style="color: #bc6ec5;">(</span>S_IRGRP | S_IWGRP | S_IROTH | S_IWOTH<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>creat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bar"</span>, RWRWRW<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat \"bar\": %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org98b4eb5" class="outline-4">
<h4 id="org98b4eb5"><span class="done DONE">DONE</span> <code>chmod</code>, <code>fchmod</code>, and <code>fchmodat</code> Functions</h4>
<div class="outline-text-4" id="text-org98b4eb5">
<p>
<code>man 2 chmod</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>Figure 4.12 Example of chmod function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">statbuf</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">turn on set-group-ID and turn off group-execute */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat error for foo"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chmod<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"foo"</span>, <span style="color: #67b11d;">(</span>statbuf.st_mode &amp; ~S_IXGRP<span style="color: #67b11d;">)</span> | S_ISGID<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chmod error for foo"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">set absolute mode to "rw-r--r--" */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chmod<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bar"</span>, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chmod error for bar"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgf78e4da" class="outline-4">
<h4 id="orgf78e4da"><span class="done DONE">DONE</span> Sticky Bit</h4>
<div class="outline-text-4" id="text-orgf78e4da">
<p>
If it was set for an executable program file, then the first time the program was executed, <br />
a copy of the program’s text was saved in the swap area when the process terminated
</p>
</div>
</div>
<div id="outline-container-orgf908789" class="outline-4">
<h4 id="orgf908789"><span class="done DONE">DONE</span> <code>chown</code>, <code>fchown</code>, <code>fchownat</code>, and <code>lchown</code> Functions</h4>
<div class="outline-text-4" id="text-orgf908789">
<p>
<code>man 2 chown</code>
</p>
</div>
</div>
<div id="outline-container-org5faf2c6" class="outline-4">
<h4 id="org5faf2c6"><span class="done DONE">DONE</span> File Size</h4>
<div class="outline-text-4" id="text-org5faf2c6">
<p>
<code>struct stat.st_size</code>
</p>
</div>
</div>
<div id="outline-container-orgf5127e4" class="outline-4">
<h4 id="orgf5127e4"><span class="done DONE">DONE</span> File Truncation</h4>
<div class="outline-text-4" id="text-orgf5127e4">
<p>
<code>man 2 truncate</code>
</p>
</div>
</div>
<div id="outline-container-org102dd8b" class="outline-4">
<h4 id="org102dd8b"><span class="done DONE">DONE</span> File Systems</h4>
<div class="outline-text-4" id="text-org102dd8b">
<ul class="org-ul">
<li>Only when the link count goes to 0 can the file be deleted. <br />
<code>struct stat.st_nlink</code></li>
<li>The other type of link is called a symbolic link. With a symbolic link, the actual contents of the file—the data blocks—store the name of the file that the symbolic link points to.</li>
<li>The i-node contains all the information about the file. <br />
Most of the information in the stat structure is obtained from the i-node, exclude <b>filename</b> and <b>i-node</b> number.</li>
<li>a directory entry can’t refer to an i-node in a different file system.</li>
<li>When renaming a file without changing file systems, the actual contents of the file need not be moved—all that needs to be done is to add a new directory entry that points to the existing i-node and then unlink the old directory entry.</li>
</ul>
</div>
</div>
<div id="outline-container-orgab3bf28" class="outline-4">
<h4 id="orgab3bf28"><span class="done DONE">DONE</span> <code>link</code>, <code>linkat</code>, <code>unlink</code>, <code>unlinkat</code>, and <code>remove</code> Functions</h4>
<div class="outline-text-4" id="text-orgab3bf28">
<p>
<code>man 2 link</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>Figure 4.16 Open a file and then unlink it</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>open<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"tempfile"</span>, O_RDWR<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>unlink<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"tempfile"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unlink: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"file unlinked\n"</span><span style="color: #bc6ec5;">)</span>;
    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">15</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"done\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgf151e8c" class="outline-4">
<h4 id="orgf151e8c"><span class="done DONE">DONE</span> <code>rename</code> and <code>renameat</code> Functions</h4>
<div class="outline-text-4" id="text-orgf151e8c">
<p>
<code>man 2 rename</code>
</p>
<ol class="org-ol">
<li>If oldname specifies a file that is not a directory, then we are renaming a file or a symbolic link.</li>
<li>If oldname specifies a directory, then we are renaming a directory.</li>
<li>If either oldname or newname refers to a symbolic link, then the link itself is processed, not the file to which it resolves.</li>
<li>We can’t rename dot or dot-dot.</li>
<li>As a special case, if oldname and newname refer to the same file, the function returns successfully without changing anything.</li>
</ol>
</div>
</div>
<div id="outline-container-org6446b8b" class="outline-4">
<h4 id="org6446b8b"><span class="done DONE">DONE</span> Symbolic Links</h4>
<div class="outline-text-4" id="text-org6446b8b">
<ul class="org-ul">
<li>Hard links normally require that the link and the file reside in the same file system.</li>
<li>Only the superuser can create a hard link to a directory (when supported by the underlying file system).</li>
</ul>
</div>
</div>
<div id="outline-container-org3360221" class="outline-4">
<h4 id="org3360221"><span class="done DONE">DONE</span> Creating and Reading Symbolic Links</h4>
<div class="outline-text-4" id="text-org3360221">
<p>
<code>man 2 symlink</code>
<code>man 2 readlink</code>
</p>
</div>
</div>
<div id="outline-container-org7a0ea4e" class="outline-4">
<h4 id="org7a0ea4e"><span class="done DONE">DONE</span> File Times</h4>
</div>
<div id="outline-container-org90b7073" class="outline-4">
<h4 id="org90b7073"><span class="done DONE">DONE</span> <code>futimens</code>, <code>utimensat</code>, and <code>utimes</code> Functions</h4>
<div class="outline-text-4" id="text-org90b7073">
<p>
POSIX.1
<code>man 2 futimens</code>
XSI
<code>man 2 utimes</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>Figure 4.21 Example of futimens function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">i</span>, <span style="color: #7590db;">fd</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>     <span style="color: #7590db;">statbuf</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">times</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;statbuf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">fetch current times */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fd = open<span style="color: #b1951d;">(</span>argv<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, O_RDWR | O_TRUNC<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">truncate */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>

        times<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span> = statbuf.st_atimespec;
        times<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span> = statbuf.st_mtimespec;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>futimens<span style="color: #67b11d;">(</span>fd, times<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">reset times */</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s: %s"</span>, argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        close<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orga8b4e72" class="outline-4">
<h4 id="orga8b4e72"><span class="done DONE">DONE</span> <code>mkdir</code>, <code>mkdirat</code>, and <code>rmdir</code> Functions</h4>
<div class="outline-text-4" id="text-orga8b4e72">
<p>
Creat:
<code>man 2 mkdir</code>
Remove:
<code>man 2 rmdir</code>
</p>
</div>
</div>
<div id="outline-container-orga1c3470" class="outline-4">
<h4 id="orga1c3470"><span class="done DONE">DONE</span> Reading Directories</h4>
<div class="outline-text-4" id="text-orga1c3470">
<p>
<code>man 3 opendir</code>
</p>
<ul class="org-ul">
<li>Example <br />
<a href="file:///Users/zhoush/Private/Notes/books/c/APUE/Chapter04/ftw.c">Figure 4.22 Recursively descend a directory hierarchy, counting file types</a></li>
</ul>
</div>
</div>
<div id="outline-container-org36da4ff" class="outline-4">
<h4 id="org36da4ff"><span class="done DONE">DONE</span> <code>chidr</code>, <code>fchdir</code> and <code>getcwd</code> Functions</h4>
<div class="outline-text-4" id="text-org36da4ff">
<p>
<code>man 2 chdir</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>Figure 4.23 Example of chdir function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chdir<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/tmp"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chdir: "</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"chdir to /tmp SUCCESS\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<p>
<code>man 3 getcwd</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span>Figure 4.24 Example of getcwd function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> * <span style="color: #7590db;">ptr</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chdir<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/usr/local"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"chdir: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    ptr = path_alloc<span style="color: #bc6ec5;">(</span>&amp;size<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getcwd<span style="color: #2d9574;">(</span>ptr, size<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getcwd: %s\n"</span>, ptr<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"cwd = %s\n"</span>, ptr<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgaaecad7" class="outline-4">
<h4 id="orgaaecad7"><span class="done DONE">DONE</span> Device Special Files</h4>
<div class="outline-text-4" id="text-orgaaecad7">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span>Figure 4.25 Print st_dev and st_rdev values</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#ifdef</span> SOLARIS
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/mkdev.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#endif</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">SOLARIS</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">buf</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; argc; i++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"stat error"</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"dev = %d/%d"</span>, MAJOR<span style="color: #67b11d;">(</span>buf.st_dev<span style="color: #67b11d;">)</span>, MINOR<span style="color: #67b11d;">(</span>buf.st_dev<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span> || S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" (%s) rdev = %d/%d"</span>,
                   <span style="color: #b1951d;">(</span>S_ISCHR<span style="color: #4f97d7;">(</span>buf.st_mode<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> ? <span style="color: #2d9574;">"character"</span> : <span style="color: #2d9574;">"block"</span>,
                   major<span style="color: #b1951d;">(</span>buf.st_mode<span style="color: #b1951d;">)</span>, minor<span style="color: #b1951d;">(</span>buf.st_rdev<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgdbaf593" class="outline-4">
<h4 id="orgdbaf593"><span class="done DONE">DONE</span> Summary of File Access Permission Bits</h4>
<div class="outline-text-4" id="text-orgdbaf593">
<p>
S_IRWXU = S_IRUSR | S_IWUSR | S_IXUSR
S_IRWXG = S_IRGRP | S_IWGRP | S_IXGRP
S_IRWXO = S_IROTH | S_IWOTH | S_IXOTH
</p>
</div>
</div>
<div id="outline-container-orga8be04c" class="outline-4">
<h4 id="orga8be04c"><span class="done DONE">DONE</span> Summary</h4>
<div class="outline-text-4" id="text-orga8be04c">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
4.1
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">buf</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *      <span style="color: #7590db;">ptr</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; argc; i++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: "</span>, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>stat<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>, &amp;buf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_ret<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"lstat error"</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">continue</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISREG<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"regular"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"directory"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISCHR<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"character special"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISBLK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"block special"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISFIFO<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"fifo"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISLNK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"symbolic link"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISSOCK<span style="color: #67b11d;">(</span>buf.st_mode<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>
            ptr = <span style="color: #2d9574;">"socket"</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            ptr = <span style="color: #2d9574;">"** unknown mode **"</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, ptr<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
before modification: symbolic link
after  modification: regular
</p></li>
<li>4.2  default permissions: <code>----------</code></li>
<li>4.3  <code>cat</code> get : Permission denied</li>
<li>4.4  nothing changed.</li>
<li>4.5  directory always shoud be entries for . and ..
the size of symbolic link should be the size of the file contained in.</li>
<li><p>
4.6
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">in</span>, <span style="color: #7590db;">out</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>        <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">stbuf</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;

    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">l_size</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"src.txt"</span>, &amp;stbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    l_size = stbuf.st_size;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>in = open<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"src.txt"</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span> ||
        <span style="color: #2d9574;">(</span>out = open<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"dst.txt"</span>, O_CREAT | O_RDWR, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">l_sum</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">l_cur</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>l_cur = read<span style="color: #67b11d;">(</span>in, buf, BUFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        l_sum += l_cur;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>out, buf, l_cur<span style="color: #67b11d;">)</span> != l_cur<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write: %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span>in<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>out<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li>4.7  default access permissions are different</li>
<li>4.8  <code>du</code> check the file/directory/path space instead of disk , and may need path permissions.</li>
<li>4.9  it's not the last link to the file.</li>
<li>4.10  recursive depth number</li>
<li><p>
4.11
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">dirent.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">function type that is called for each filename */</span>
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #ce537a; font-weight: bold;">Myfunc</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">fpath</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> *<span style="color: #7590db;">sb</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">typeflag</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">Myfunc</span> <span style="color: #7590db;">myfunc</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">myftw</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">dirpath</span>, <span style="color: #ce537a; font-weight: bold;">Myfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">dopath</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">dirname</span>, <span style="color: #ce537a; font-weight: bold;">Myfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">nreg</span>, <span style="color: #7590db;">ndir</span>, <span style="color: #7590db;">nblk</span>, <span style="color: #7590db;">nchr</span>, <span style="color: #7590db;">nfifo</span>, <span style="color: #7590db;">nslink</span>, <span style="color: #7590db;">nsock</span>, <span style="color: #7590db;">ntot</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;starting-pathname&gt;"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    ret = myftw<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, myfunc<span style="color: #bc6ec5;">)</span>;

    ntot = nreg + ndir + nblk + nchr + nfifo + nslink + nsock;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ntot == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ntot = <span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"regular files  = %7ld, %5.2f %%\n"</span>, nreg, nreg * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"directories    = %7ld, %5.2f %%\n"</span>, ndir, ndir * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"block special  = %7ld, %5.2f %%\n"</span>, nblk, nblk * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"char special   = %7ld, %5.2f %%\n"</span>, nchr, nchr * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"FIFOs          = %7ld, %5.2f %%\n"</span>, nfifo, nfifo * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"symbolic links = %7ld, %5.2f %%\n"</span>, nslink, nslink * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sockets        = %7ld, %5.2f %%\n"</span>, nsock, nsock * <span style="color: #a45bad;">100.0</span> / ntot<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Descend through the hierarchy, starting at "pathname".</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * The caller's func() is called for every file.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FTW_F</span>   <span style="color: #a45bad;">1</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">file other than directory */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FTW_D</span>   <span style="color: #a45bad;">2</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">directory */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FTW_DNR</span> <span style="color: #a45bad;">3</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">dirctory that cant'be read */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FTW_NS</span>  <span style="color: #a45bad;">4</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">file that we can't stat */</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">pathlen</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">myftw</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">Myfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">fullpath</span> = path_alloc<span style="color: #bc6ec5;">(</span>&amp;pathlen<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">malloc PATH_MAX+1 bytes */</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pathlen &lt;= strlen<span style="color: #2d9574;">(</span>pathname<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pathlen = strlen<span style="color: #2d9574;">(</span>pathname<span style="color: #2d9574;">)</span> * <span style="color: #a45bad;">2</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>fullpath = realloc<span style="color: #b1951d;">(</span>fullpath, pathlen<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"realloc %s"</span>, strerror<span style="color: #b1951d;">(</span>errno<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>dopath<span style="color: #2d9574;">(</span>pathname, func<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Descend through the hierarchy, starting at "fullpath".</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * If "fullpath" is anything other than a directory, we lstat() it,</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * call func(), and return. For a directory, we call ourself</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * recursively for each name in the directory.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">we return whatever func() returns  */</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">dopath</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">Myfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>    <span style="color: #7590db;">statbuf</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">dirent</span> *<span style="color: #7590db;">dirp</span>;
    <span style="color: #ce537a; font-weight: bold;">DIR</span> *          <span style="color: #7590db;">dp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">ret</span>, <span style="color: #7590db;">n</span>;

    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">l</span>   = <span style="color: #a45bad;">0</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> * <span style="color: #7590db;">cwd</span> = path_alloc<span style="color: #bc6ec5;">(</span>&amp;l<span style="color: #bc6ec5;">)</span>;

    chdir<span style="color: #bc6ec5;">(</span>pathname<span style="color: #bc6ec5;">)</span>;
    getcwd<span style="color: #bc6ec5;">(</span>cwd, l<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#ifdef</span> DEBUG
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, cwd<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dp = opendir<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"."</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">can't read directory */</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>func<span style="color: #67b11d;">(</span>pathname, &amp;statbuf, FTW_DNR<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dirp = readdir<span style="color: #67b11d;">(</span>dp<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strcmp<span style="color: #b1951d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">"."</span><span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> ||
            <span style="color: #67b11d;">(</span>strcmp<span style="color: #b1951d;">(</span>dirp-&gt;d_name, <span style="color: #2d9574;">".."</span><span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">continue</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">ignore dot and dot-dot */</span>
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lstat<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">stat error */</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_NS<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>S_ISDIR<span style="color: #67b11d;">(</span>statbuf.st_mode<span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">not a directory */</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_F<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            func<span style="color: #67b11d;">(</span>dirp-&gt;d_name, &amp;statbuf, FTW_D<span style="color: #67b11d;">)</span>;
            <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">chdir(dirp-&gt;d_name); */</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>ret = dopath<span style="color: #4f97d7;">(</span>dirp-&gt;d_name, func<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
            <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">chdir(".."); */</span>
            getcwd<span style="color: #67b11d;">(</span>cwd, l<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>closedir<span style="color: #2d9574;">(</span>dp<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: %s"</span>, cwd, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>ret<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">myfunc</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> *<span style="color: #7590db;">statptr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>type<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> FTW_F:
            <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>statptr-&gt;st_mode &amp; S_IFMT<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFREG:
                    nreg++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFBLK:
                    nblk++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFCHR:
                    nchr++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFIFO:
                    nfifo++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFLNK:
                    nslink++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFSOCK:
                    nsock++;
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
                <span style="color: #4f97d7; font-weight: bold;">case</span> S_IFDIR:
                    err_dump<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"for S_IFDIR for %s"</span>, pathname<span style="color: #67b11d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">default</span>:
                    <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #2d9574;">}</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> FTW_D:
            ndir++;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> FTW_DNR:
            err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: %s"</span>, pathname, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">case</span> FTW_NS:
            err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat error for %s"</span>, pathname<span style="color: #2d9574;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            err_dump<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unknown type %d for pathname %s"</span>, type, pathname<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li>4.12  FTP</li>
<li>4.13  <code>stat</code> first, set timespec array to current time that you expect not change, and the other to the value you want.</li>
<li>4.14  access time is the last read time <br />
modify time is last received</li>
<li>4.15  The change time isn't stored because, even if it was stored, you wouldn't be able to set it to the original time. You cannot cheat the change time, it is always based on when the inode data was actually changed.
<br />
Depending on the utility (tar or cpio), you can tell it to keep the original access and/or modify times. For example, tar by default maintains the original modify time but you can use the -m switch to set it to extraction time. The access time is always set to extraction time.</li>
<li><p>
4.16
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">dirname</span> = <span style="color: #2d9574;">"testdir"</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span>      <span style="color: #7590db;">pathmax</span> = pathconf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"."</span>, _PC_PATH_MAX<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pathmax: %ld\n"</span>, pathmax<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">char</span>   <span style="color: #7590db;">path</span><span style="color: #bc6ec5;">[</span>pathmax<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">curlen</span>;

    strcpy<span style="color: #bc6ec5;">(</span>path, dirname<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        curlen = strlen<span style="color: #2d9574;">(</span>getcwd<span style="color: #67b11d;">(</span>path, pathmax<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> + strlen<span style="color: #2d9574;">(</span>dirname<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>curlen &lt;= pathmax<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>mkdir<span style="color: #b1951d;">(</span>dirname, <span style="color: #a45bad;">0777</span><span style="color: #b1951d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"mkdir: %s\n"</span>, strerror<span style="color: #4f97d7;">(</span>errno<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
            <span style="color: #67b11d;">}</span>
            sprintf<span style="color: #67b11d;">(</span>path, <span style="color: #2d9574;">"/%s"</span>, dirname<span style="color: #67b11d;">)</span>;
            chdir<span style="color: #67b11d;">(</span>dirname<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"curlen = %ld\n"</span>, curlen<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
4.17
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">path</span> = <span style="color: #2d9574;">"/dev/fd/1"</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">ret</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ret = unlink<span style="color: #67b11d;">(</span>path<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unlink: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span>path, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
<code>unlink: Operation not permitted</code>
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc90da49" class="outline-3">
<h3 id="orgc90da49"><span class="done DONE">DONE</span> Chapter 5. Standard I/O Library <code>[16/16]</code></h3>
<div class="outline-text-3" id="text-orgc90da49">
</div>
<div id="outline-container-org6e65f1f" class="outline-4">
<h4 id="org6e65f1f"><span class="done DONE">DONE</span> 5.1 Introduction</h4>
<div class="outline-text-4" id="text-org6e65f1f">
<p>
This library is specified by the ISO C standard because it has been implemented on many operating systems other than the UNIX System.
</p>
</div>
</div>
<div id="outline-container-org8ba92d2" class="outline-4">
<h4 id="org8ba92d2"><span class="done DONE">DONE</span> 5.2 Streams and FILE Objects</h4>
<div class="outline-text-4" id="text-org8ba92d2">
<p>
<code>man 3 fwide</code>
</p>
</div>
</div>
<div id="outline-container-orgb7e9d87" class="outline-4">
<h4 id="orgb7e9d87"><span class="done DONE">DONE</span> 5.3 Standard Input, Standard Output and Standard Error</h4>
<div class="outline-text-4" id="text-orgb7e9d87">
<p>
<code>STDIN_FILENO</code>, <code>STDOUT_FILENO</code>, <code>STDERR_FILENO</code>
</p>
</div>
</div>
<div id="outline-container-orgccb378b" class="outline-4">
<h4 id="orgccb378b"><span class="done DONE">DONE</span> 5.4 Buffering</h4>
<div class="outline-text-4" id="text-orgccb378b">
<p>
Three types of buffering are provided:
</p>
<ol class="org-ol">
<li>Fully buffered. <br />
In this case, actual I/O takes place when the standard I/O buffer is filled.</li>
<li>Line buffered. <br />
In this case, the standard I/O library performs I/O when a newline character is encountered on input or output.</li>
<li>Unbuffered. <br /></li>
</ol>

<p>
ISO C requires the following buffering characteristics:
</p>
<ul class="org-ul">
<li>Standard input and standard output are fully buffered, if and only if they do not refer to an interactive device.</li>
<li>Standard error is never fully buffered.</li>
</ul>

<p>
Most implementations default to the following types of buffering:
</p>
<ul class="org-ul">
<li>Standard error is always unbuffered.</li>
<li>All other streams are line buffered if they refer to a terminal device; otherwise, they are fully buffered.</li>
</ul>


<p>
<code>man 3 setbuf</code>
<code>man 3 fflush</code>
</p>
</div>
</div>
<div id="outline-container-org54a7bdf" class="outline-4">
<h4 id="org54a7bdf"><span class="done DONE">DONE</span> 5.5 Opening a Stream</h4>
<div class="outline-text-4" id="text-org54a7bdf">
<p>
<code>man 3 fopen</code>
<code>man 3 fclose</code>
</p>
</div>
</div>
<div id="outline-container-orge5d8891" class="outline-4">
<h4 id="orge5d8891"><span class="done DONE">DONE</span> 5.6 Reading and Writing a Stream</h4>
<div class="outline-text-4" id="text-orge5d8891">
<p>
Three types of unformatted I/O:
</p>
<ol class="org-ol">
<li>Character-at-a-time I/O.</li>
<li>Line-at-a-time I/O.</li>
<li>Direct I/O.</li>
</ol>
<p>
5.7 <b>**</b> DONE Input Functions
<code>man 3 getc</code>
</p>
<ol class="org-ol">
<li>The argument to getc should not be an expression with side effects, because it could be evaluated more than once.</li>
<li>Since fgetc is guaranteed to be a function, we can take its address. This allows us to pass the address of fgetc as an argument to another function.</li>
<li>Calls to fgetc probably take longer than calls to getc, as it usually takes more time to call a function.</li>
</ol>


<p>
In most implementations, two flags are maintained for each stream in the FILE object:
<code>man 3 ferror</code>
</p>
<ul class="org-ul">
<li>An error flag</li>
<li>An end-of file flagp</li>
</ul>


<p>
After reading from a stream, we can push back characters by calling <code>ungetc</code>.
5.8 <b>**</b> DONE Output Functions
<code>man 3 putc</code>
</p>
</div>
</div>
<div id="outline-container-org3dccaef" class="outline-4">
<h4 id="org3dccaef"><span class="done DONE">DONE</span> 5.9 Line-at-a-Time I/O</h4>
<div class="outline-text-4" id="text-org3dccaef">
<p>
<code>man fgets</code>
</p>
</div>
</div>
<div id="outline-container-org040ffa9" class="outline-4">
<h4 id="org040ffa9"><span class="done DONE">DONE</span> 5.10 Standard I/O Efficiency</h4>
<div class="outline-text-4" id="text-org040ffa9">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span>Figure 5.4 Copy standard input to output using getc and putc</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>c = getc<span style="color: #67b11d;">(</span>stdin<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != EOF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>putc<span style="color: #67b11d;">(</span>c, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span>
            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output error: %s"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span>Figure 5.5 Copy standard input to output using fgets and fputs</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fputs<span style="color: #2d9574;">(</span>buf, stdout<span style="color: #2d9574;">)</span> == EOF<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3f60888" class="outline-4">
<h4 id="org3f60888"><span class="done DONE">DONE</span> 5.11 Binary I/O</h4>
<div class="outline-text-4" id="text-org3f60888">
<p>
<code>man fread</code>
</p>
</div>
</div>
<div id="outline-container-orgd7a0e2a" class="outline-4">
<h4 id="orgd7a0e2a"><span class="done DONE">DONE</span> 5.12 Positioning a Stream</h4>
<div class="outline-text-4" id="text-orgd7a0e2a">
<p>
Three way to position a standard I/O stream:
</p>
<ol class="org-ol">
<li><code>ftell</code> and <code>fseek</code></li>
<li><code>ftello</code> and <code>fseeko</code></li>
<li><code>fgetpos</code> and <code>fsetpos</code></li>
</ol>


<p>
When porting applications to non-UNIX systems, use fgetpos and fsetpos.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span>
<span style="color: #bc6ec5; font-weight: bold;">fgetpos</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">stream</span>, <span style="color: #ce537a; font-weight: bold;">fpos_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">pos</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span>
<span style="color: #bc6ec5; font-weight: bold;">fseek</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">offset</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span>
<span style="color: #bc6ec5; font-weight: bold;">fseeko</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">offset</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span>
<span style="color: #bc6ec5; font-weight: bold;">fsetpos</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">fpos_t</span> *<span style="color: #7590db;">pos</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">long</span>
<span style="color: #bc6ec5; font-weight: bold;">ftell</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">off_t</span>
<span style="color: #bc6ec5; font-weight: bold;">ftello</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span>
<span style="color: #bc6ec5; font-weight: bold;">rewind</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">stream</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb6c6cda" class="outline-4">
<h4 id="orgb6c6cda"><span class="done DONE">DONE</span> 5.13 Formated I/O</h4>
<div class="outline-text-4" id="text-orgb6c6cda">
<p>
<code>man 3 printf</code>
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> Figure 5.7 The flags component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Flag</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">'</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">(apostrophe) format integer with thousands grouping characters</a></td>
</tr>

<tr>
<td class="org-left">-</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">left justify</a></td>
</tr>

<tr>
<td class="org-left">+</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">always display sign of a signed conversion</a></td>
</tr>

<tr>
<td class="org-left">(space)</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">prefix by a space if no sign is generated</a></td>
</tr>

<tr>
<td class="org-left">\#</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">convert using alternative form(include 0x prefix for hexadecimal format, for example)</a></td>
</tr>

<tr>
<td class="org-left">0</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">prefix with leading zeros instead of padding with spaces</a></td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> Figure 5.8 The lenth modifier component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Length modifer</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">hh</td>
<td class="org-left">signed or unsigned char</td>
</tr>

<tr>
<td class="org-left">h</td>
<td class="org-left">sigend or unsigned short</td>
</tr>

<tr>
<td class="org-left">l</td>
<td class="org-left">signed or unsigned long or wide character</td>
</tr>

<tr>
<td class="org-left">ll</td>
<td class="org-left">signed or unsigned long long</td>
</tr>

<tr>
<td class="org-left">j</td>
<td class="org-left">inmax_t or uintmax_t</td>
</tr>

<tr>
<td class="org-left">z</td>
<td class="org-left">size_t</td>
</tr>

<tr>
<td class="org-left">t</td>
<td class="org-left">ptrdiff_t</td>
</tr>

<tr>
<td class="org-left">L</td>
<td class="org-left">long double</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> Figure 5.9 The conversion type component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Conversion type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">d,i</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">signed decimal</a></td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned octal</a></td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned decimal</a></td>
</tr>

<tr>
<td class="org-left">x,X</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">unsigned hexadecimal</a></td>
</tr>

<tr>
<td class="org-left">f,F</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number</a></td>
</tr>

<tr>
<td class="org-left">e,E</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number in exponential format</a></td>
</tr>

<tr>
<td class="org-left">g,G</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">interpreted as f, F, e, or E, depending on value converted</a></td>
</tr>

<tr>
<td class="org-left">a,A</td>
<td class="org-left"><a href="Chapter05/formatted.c#MissingReference">double floating-point number in hexadecimal exponential format</a></td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">character (with 1 length modifier, wide character)</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">string(with 1 length modifier, wide character string)</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">pointer to a void</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">pointer to a signed integer into which is written the number of characters written so far</td>
</tr>

<tr>
<td class="org-left">%</td>
<td class="org-left">a % character</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">wide chracter(XSI option, equivalent to lc)</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">wide chracter string(XSI option, equivalent to ls)</td>
</tr>
</tbody>
</table>


<p>
<b>Formatted Input</b>
<code>man 3 scanf</code>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> Figure 5.9 The conversion type component of a conversion specification</caption>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Conversion type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">d</td>
<td class="org-left">signed decimal, base 10</td>
</tr>

<tr>
<td class="org-left">i</td>
<td class="org-left">signed decimal, base determined by format of input</td>
</tr>

<tr>
<td class="org-left">o</td>
<td class="org-left">unsigned octal(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">u</td>
<td class="org-left">unsigned decimal, base 10(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">x,X</td>
<td class="org-left">unsigned hexadecimal(input optionally signed)</td>
</tr>

<tr>
<td class="org-left">a,A,e,E,f,F,g,G</td>
<td class="org-left">floating-point number</td>
</tr>

<tr>
<td class="org-left">c</td>
<td class="org-left">character (with 1 length modifier, wide character)</td>
</tr>

<tr>
<td class="org-left">s</td>
<td class="org-left">string(with 1 length modifier, wide character string)</td>
</tr>

<tr>
<td class="org-left">[</td>
<td class="org-left">mathches a sequence of listed characters, ending with ]</td>
</tr>

<tr>
<td class="org-left">[^</td>
<td class="org-left">mathches all characters except the ones listed, ending with ]</td>
</tr>

<tr>
<td class="org-left">p</td>
<td class="org-left">pointer to a void</td>
</tr>

<tr>
<td class="org-left">n</td>
<td class="org-left">pointer to a signed integer into which is written the number of characters written so far</td>
</tr>

<tr>
<td class="org-left">%</td>
<td class="org-left">a % character</td>
</tr>

<tr>
<td class="org-left">C</td>
<td class="org-left">wide chracter(XSI option, equivalent to lc)</td>
</tr>

<tr>
<td class="org-left">S</td>
<td class="org-left">wide chracter string(XSI option, equivalent to ls)</td>
</tr>
</tbody>
</table>

<p>
<b>*</b>
</p>
</div>
</div>
<div id="outline-container-org21e646c" class="outline-4">
<h4 id="org21e646c"><span class="done DONE">DONE</span> 5.14 Implementation Details</h4>
<div class="outline-text-4" id="text-org21e646c">
<p>
<code>man 3 fileno</code>
</p>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 29: </span>Figure 5.11 Print buffering for various standard I/O streams</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_stdio</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    fputs<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"enter any character\n"</span>, stdout<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getchar<span style="color: #2d9574;">()</span> == EOF<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getchar: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    fputs<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"one line to standard error\n"</span>, stderr<span style="color: #bc6ec5;">)</span>;

    pr_stdio<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stdin"</span>, stdin<span style="color: #bc6ec5;">)</span>;
    pr_stdio<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stdout"</span>, stdout<span style="color: #bc6ec5;">)</span>;
    pr_stdio<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stderr"</span>, stderr<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"/etc/passwd"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fopen: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getc<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span> == EOF<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"getc: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_stdio</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stream = %s, "</span>, name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>is_unbuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"unbuffered"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>is_linebuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"line buffered"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">if neither or above */</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fully buffered"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", buffer size = %d\n"</span>, buffer_size<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * The following is nonportable</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>_IO_UNBUFFERED<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;flags &amp; _IO_UNBUFFERED<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;flags &amp; _IO_LINE_BUF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__SNBF<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flags &amp; __SNBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flags &amp; __SLBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_bf._size<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>_IONBF<span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5;">#ifdef</span> _LP64
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">_flag</span> __pad<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">4</span><span style="color: #4f97d7;">]</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">_ptr</span>  __pad<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1</span><span style="color: #4f97d7;">]</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">_base</span> __pad<span style="color: #4f97d7;">[</span><span style="color: #a45bad;">2</span><span style="color: #4f97d7;">]</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flag &amp; _IONBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flag &amp; _IOLBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">#ifdef</span> _LP64
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_base - fp-&gt;_ptr<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>BUFSIZ<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">just a guess */</span>
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #bc6ec5;">#else</span>

<span style="color: #bc6ec5;">#error</span> <span style="color: #2d9574;">unknown stdio implementation;</span>

<span style="color: #bc6ec5;">#endif</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org712151f" class="outline-4">
<h4 id="org712151f"><span class="done DONE">DONE</span> 5.15 Temporary Files</h4>
<div class="outline-text-4" id="text-org712151f">
<p>
<code>man 3 tmpnam</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 30: </span>Figure 5.12 Demonstrate tmpnam and tmpfile functions</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">name</span><span style="color: #bc6ec5;">[</span>L_tmpnam<span style="color: #bc6ec5;">]</span>, <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, tmpnam<span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">first temp name */</span>

    tmpnam<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">second temp name */</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, name<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = tmpfile<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">create temp file */</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"tmpfile: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    fputs<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"one line of output\n"</span>, fp<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">write to temp file */</span>
    rewind<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>line, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>line<span style="color: #67b11d;">)</span>, fp<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fgets: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    fputs<span style="color: #bc6ec5;">(</span>line, stdout<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<p>
<code>man 3 mkdtemp</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 31: </span>Figure 5.13 Demonstrate mkstemp function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">make_temp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">template</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">good_template</span><span style="color: #bc6ec5;">[]</span> = <span style="color: #2d9574;">"/tmp/dirXXXX"</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">right way */</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">bad_template</span>    = <span style="color: #2d9574;">"/tmp/dir/</span><span style="color: #dc752f;">XXXX</span><span style="color: #2d9574;">"</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">bad way */</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"trying to create first temp file ...\n"</span><span style="color: #bc6ec5;">)</span>;
    make_temp<span style="color: #bc6ec5;">(</span>good_template<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"trying to create second temp file ...\n"</span><span style="color: #bc6ec5;">)</span>;
    make_temp<span style="color: #bc6ec5;">(</span>bad_template<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">make_temp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">template</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">fd</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">sbuf</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = mkstemp<span style="color: #67b11d;">(</span>template<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"create temp: %s\n"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"temp name = %s\n"</span>, template<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #2d9574;">(</span>template, &amp;sbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"stat: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"file exists\n"</span><span style="color: #2d9574;">)</span>;
        unlink<span style="color: #2d9574;">(</span>template<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org156ff07" class="outline-4">
<h4 id="org156ff07"><span class="done DONE">DONE</span> 5.16 Memory Streams</h4>
<div class="outline-text-4" id="text-org156ff07">
<p>
<code>man 3 fmemopen</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 32: </span>Figure 5.15 Investigate memory stream write behavior</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BSZ</span> <span style="color: #a45bad;">48</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BSZ<span style="color: #bc6ec5;">]</span>;

    memset<span style="color: #bc6ec5;">(</span>buf, <span style="color: #2d9574;">'a'</span>, BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'\0'</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'X'</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fmemopen<span style="color: #67b11d;">(</span>buf, BSZ, <span style="color: #2d9574;">"w+"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fmemopen failed"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"initial buffer contents: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    fprintf<span style="color: #bc6ec5;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before flush: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    fflush<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after fflush: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    memset<span style="color: #bc6ec5;">(</span>buf, <span style="color: #2d9574;">'b'</span>, BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'\0'</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'X'</span>;
    fprintf<span style="color: #bc6ec5;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #bc6ec5;">)</span>;
    fseek<span style="color: #bc6ec5;">(</span>fp, <span style="color: #a45bad;">0</span>, SEEK_SET<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after fseek: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    memset<span style="color: #bc6ec5;">(</span>buf, <span style="color: #2d9574;">'c'</span>, BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'\0'</span>;
    buf<span style="color: #bc6ec5;">[</span>BSZ - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">]</span> = <span style="color: #2d9574;">'X'</span>;
    fprintf<span style="color: #bc6ec5;">(</span>fp, <span style="color: #2d9574;">"hello, world"</span><span style="color: #bc6ec5;">)</span>;
    fclose<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after fclose: %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"len of string in buf = %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<p>
<b>linux</b> result:
</p>
<blockquote>
<p>
initial buffer contents: <br />
before flush: <br />
after fflush: hello, world <br />
len of string in buf = 12 <br />
after fseek: bbbbbbbbbbbbhello, world <br />
len of string in buf = 24 <br />
after fclose: hello, worldcccccccccccccccccccccccccccccccccc <br />
len of string in buf = 46
</p>
</blockquote>

<p>
The other two functions:
<code>man open_memstream</code>
</p>
</div>
</div>
<div id="outline-container-org6f98f7c" class="outline-4">
<h4 id="org6f98f7c"><span class="done DONE">DONE</span> 5.17 Alternatives to Standard I/O</h4>
<div class="outline-text-4" id="text-org6f98f7c">
<p>
The standard I/O library is not perfect. some in the basic design, but most in the various implementations.
</p>
</div>
</div>
<div id="outline-container-orgd4f8749" class="outline-4">
<h4 id="orgd4f8749"><span class="done DONE">DONE</span> 5.18 Summary</h4>
<div class="outline-text-4" id="text-orgd4f8749">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
3.1
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">setbuf_</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">stream</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stream == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IONBF, BUFSIZ<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>isatty<span style="color: #2d9574;">(</span>fileno<span style="color: #67b11d;">(</span>stream<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IOLBF, BUFSIZ<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        setvbuf<span style="color: #2d9574;">(</span>stream, buf, _IOFBF, BUFSIZ<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_unbuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flags &amp; __SNBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">is_linebuffered</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_flags &amp; __SLBF<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">buffer_size</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp-&gt;_bf._size<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_stdio</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"stream = %s, "</span>, name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>is_unbuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"unbuffered"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>is_linebuffered<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"line buffered"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">if neither or above */</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fully buffered"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">", buffer size = %d\n"</span>, buffer_size<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc &lt; <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: ./a.out &lt;path&gt;"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    fp = fopen<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #2d9574;">"r+"</span><span style="color: #bc6ec5;">)</span>;
    pr_stdio<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, fp<span style="color: #bc6ec5;">)</span>;
    setbuf_<span style="color: #bc6ec5;">(</span>fp, buf<span style="color: #bc6ec5;">)</span>;
    pr_stdio<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, fp<span style="color: #bc6ec5;">)</span>;
    fclose<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
3.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#ifdef</span> MAXLINE
<span style="color: #bc6ec5;">#undef</span> MAXLINE
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXLINE</span> <span style="color: #a45bad;">4</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"MAXLINE: %d\n"</span>, MAXLINE<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>buf, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fputs<span style="color: #67b11d;">(</span>buf, stdout<span style="color: #67b11d;">)</span> == EOF<span style="color: #2d9574;">)</span> err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output error"</span><span style="color: #2d9574;">)</span>;
        ++i;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">nums</span> = printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"loop_time: %d\n"</span>, i<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"nums: %d\n"</span>, nums<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ferror<span style="color: #2d9574;">(</span>stdin<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"input error: %s"</span>, strerror<span style="color: #2d9574;">(</span>errno<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
execute <code>fgets</code> and <code>fputs</code> more than 1 times;
</p></li>
<li>3.3  print nothing</li>
<li>3.4  This is a common error. The return value from getc and getchar is an int, not a char. EOF is often defined to be −1, so if the system uses signed characters, the code normally works</li>
<li>3.5  call <code>fflush</code> first</li>
<li>3.6  stdin and stdout are both line buffered. fgets will fflush automatically</li>
<li><p>
3.7
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> * <span style="color: #7590db;">buf</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">in-memory buffer */</span>
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">rsize</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">real size of buffer */</span>
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">vsize</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">virtual size of buffer */</span>
    <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">curpos</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">current position in buffer */</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #7590db;">flags</span>;  <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">see below */</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">flags */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_READ</span>    <span style="color: #a45bad;">0x01</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">open for reading */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_WRITE</span>   <span style="color: #a45bad;">0x02</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">open for writing */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_APPEND</span>  <span style="color: #a45bad;">0x04</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">append to stream */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_TRUNCAT</span> <span style="color: #a45bad;">0x08</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">truncate the stream on open */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MS_MYBUF</span>   <span style="color: #a45bad;">0x10</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">free buffer on close */</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> MIN
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">MIN</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>a<span style="color: #bc6ec5;">)</span> &lt; <span style="color: #bc6ec5;">(</span>b<span style="color: #bc6ec5;">)</span> ? <span style="color: #bc6ec5;">(</span>a<span style="color: #bc6ec5;">)</span> : <span style="color: #bc6ec5;">(</span>b<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">mstream_read</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">mstream_write</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">fpos_t</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_seek</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">fpos_t</span>, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>    <span style="color: #bc6ec5; font-weight: bold;">mstream_close</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #bc6ec5; font-weight: bold;">type_to_flags</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__restrict</span> type<span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #bc6ec5; font-weight: bold;">find_end</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #bc6ec5; font-weight: bold;">fmemopen</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">__restrict</span> buf, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__restrict</span> type<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *            <span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>size == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ms = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = ENOMEM;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ms-&gt;flags = type_to_flags<span style="color: #67b11d;">(</span>type<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        free<span style="color: #2d9574;">(</span>ms<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>buf == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ms-&gt;flags &amp; <span style="color: #b1951d;">(</span>MS_READ | MS_WRITE<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #67b11d;">(</span>MS_READ | MS_WRITE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            errno = EINVAL;
            free<span style="color: #67b11d;">(</span>ms<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ms-&gt;buf = malloc<span style="color: #b1951d;">(</span>size<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            errno = ENOMEM;
            free<span style="color: #67b11d;">(</span>ms<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
        <span style="color: #2d9574;">}</span>
        ms-&gt;rsize = size;
        ms-&gt;flags |= MS_MYBUF;
        ms-&gt;curpos = <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;buf   = buf;
        ms-&gt;rsize = size;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ms-&gt;curpos = find_end<span style="color: #67b11d;">(</span>ms-&gt;buf, ms-&gt;rsize<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            ms-&gt;curpos = <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;vsize = ms-&gt;curpos;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;flags &amp; MS_TRUNCAT<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;vsize = <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;vsize = size;
    <span style="color: #bc6ec5;">}</span>

    fp = funopen<span style="color: #bc6ec5;">(</span>ms, mstream_read, mstream_write, mstream_seek, mstream_close<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fp == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_MYBUF<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            free<span style="color: #67b11d;">(</span>ms-&gt;buf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> fp;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">type_to_flags</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__restrict</span> type<span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">flags</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>cp = type; *cp != <span style="color: #a45bad;">0</span>; cp++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>*cp<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'r'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                flags |= MS_READ;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'w'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                flags |= MS_WRITE | MS_TRUNCAT;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'a'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags != <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                flags |= MS_APPEND;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'+'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                flags |= MS_READ | MS_WRITE;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #2d9574;">'b'</span>:
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>flags == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">default</span>:
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> flags;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #bc6ec5; font-weight: bold;">find_end</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">off</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>off &lt; len<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>buf<span style="color: #67b11d;">[</span>off<span style="color: #67b11d;">]</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">break</span>;
        off++;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> off;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_read</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">cookie</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">nr</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span> = cookie;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_READ<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EBADF;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;curpos &gt;= ms-&gt;vsize<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span>

    nr = MIN<span style="color: #bc6ec5;">(</span>len, ms-&gt;vsize - ms-&gt;curpos<span style="color: #bc6ec5;">)</span>;
    memcpy<span style="color: #bc6ec5;">(</span>buf, ms-&gt;buf + ms-&gt;curpos, nr<span style="color: #bc6ec5;">)</span>;
    ms-&gt;curpos += nr;
    <span style="color: #4f97d7; font-weight: bold;">return</span> nr;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_write</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">cookie</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">len</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">nw</span>, <span style="color: #7590db;">off</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span> = cookie;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; <span style="color: #67b11d;">(</span>MS_APPEND | MS_WRITE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EBADF;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;flags &amp; MS_APPEND<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        off = ms-&gt;vsize;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        off = ms-&gt;curpos;
    <span style="color: #bc6ec5;">}</span>

    nw = MIN<span style="color: #bc6ec5;">(</span>len, ms-&gt;rsize - off<span style="color: #bc6ec5;">)</span>;
    memcpy<span style="color: #bc6ec5;">(</span>ms-&gt;buf + off, buf, nw<span style="color: #bc6ec5;">)</span>;
    ms-&gt;curpos = off + nw;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;curpos &gt; ms-&gt;vsize<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        ms-&gt;vsize = ms-&gt;curpos;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>ms-&gt;flags &amp; <span style="color: #4f97d7;">(</span>MS_READ | MS_WRITE<span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span> == <span style="color: #b1951d;">(</span>MS_READ | MS_WRITE<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &amp;&amp;
            ms-&gt;vsize &lt; ms-&gt;rsize<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;vsize<span style="color: #67b11d;">)</span> = <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; <span style="color: #67b11d;">(</span>MS_WRITE | MS_APPEND<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &amp;&amp; <span style="color: #a45bad;">!</span><span style="color: #2d9574;">(</span>ms-&gt;flags &amp; MS_READ<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>ms-&gt;curpos &lt; ms-&gt;rsize<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;curpos<span style="color: #67b11d;">)</span> = <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            *<span style="color: #67b11d;">(</span>ms-&gt;buf + ms-&gt;rsize - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> = <span style="color: #a45bad;">0</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> nw;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">fpos_t</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_seek</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">cookie</span>, <span style="color: #ce537a; font-weight: bold;">fpos_t</span> <span style="color: #7590db;">pos</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">whence</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">off</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span> = cookie;

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>whence<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> SEEK_SET:
            off = pos;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;

        <span style="color: #4f97d7; font-weight: bold;">case</span> SEEK_END:
            off = ms-&gt;vsize + pos;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;

        <span style="color: #4f97d7; font-weight: bold;">case</span> SEEK_CUR:
            off = ms-&gt;curpos + pos;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>off &lt; <span style="color: #a45bad;">0</span> || off &gt; ms-&gt;vsize<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    ms-&gt;curpos = off;
    <span style="color: #4f97d7; font-weight: bold;">return</span> off;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">mstream_close</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">cookie</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">memstream</span> *<span style="color: #7590db;">ms</span> = cookie;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ms-&gt;flags &amp; MS_MYBUF<span style="color: #bc6ec5;">)</span> free<span style="color: #bc6ec5;">(</span>ms-&gt;buf<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>ms<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org6824f3d" class="outline-3">
<h3 id="org6824f3d"><span class="done DONE">DONE</span> Chapter 6. System Data Files and Information <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org6824f3d">
</div>
<div id="outline-container-orgb8432b3" class="outline-4">
<h4 id="orgb8432b3"><span class="done DONE">DONE</span> 6.1 introduction</h4>
</div>
<div id="outline-container-orgd953df5" class="outline-4">
<h4 id="orgd953df5"><span class="done DONE">DONE</span> 6.2 Password File</h4>
<div class="outline-text-4" id="text-orgd953df5">
<p>
<code>man getpwuid</code>
</p>
</div>
</div>
<div id="outline-container-orgdba6abd" class="outline-4">
<h4 id="orgdba6abd"><span class="done DONE">DONE</span> 6.3 Shadow Passwords</h4>
<div class="outline-text-4" id="text-orgdba6abd">
<p>
<b>On Linux 3.2.0 and Solaris 10,</b>
<code>man getspnam</code>
<b>On FreeBSD 8.0 and Mac OS X 10.6.8, there is no shadow password structure</b>
</p>
</div>
</div>
<div id="outline-container-org2eeac26" class="outline-4">
<h4 id="org2eeac26"><span class="done DONE">DONE</span> 6.4 Group File</h4>
<div class="outline-text-4" id="text-org2eeac26">
<p>
<code>man getgrgid</code>
</p>
</div>
</div>
<div id="outline-container-org2368957" class="outline-4">
<h4 id="org2368957"><span class="done DONE">DONE</span> 6.5 Supplementary Group Ids</h4>
<div class="outline-text-4" id="text-org2368957">
<p>
<code>man getgroups</code> <br />
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 33: </span>Example for get groups' info</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">grp.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">uuid/uuid.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">grpmax</span> = sysconf<span style="color: #bc6ec5;">(</span>_SC_NGROUPS_MAX<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">gid_t</span>         <span style="color: #7590db;">grouplist</span><span style="color: #bc6ec5;">[</span>grpmax<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">group</span> *<span style="color: #7590db;">grp</span> = <span style="color: #a45bad;">NULL</span>;

    getgroups<span style="color: #bc6ec5;">(</span>grpmax, grouplist<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>; i &lt; grpmax; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        grp = getgrgid<span style="color: #2d9574;">(</span>grouplist<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%d\t%s\n"</span>, grouplist<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span>, grp-&gt;gr_name<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org6a01649" class="outline-4">
<h4 id="org6a01649"><span class="done DONE">DONE</span> 6.6 Implementation Differences</h4>
</div>
<div id="outline-container-org4778996" class="outline-4">
<h4 id="org4778996"><span class="done DONE">DONE</span> 6.7 Other Data Files</h4>
<div class="outline-text-4" id="text-org4778996">
<p>
at least three functions:
</p>
<ol class="org-ol">
<li>A get function that reads the next record, opening the file if necessary.</li>
<li>A set function that opens the file, if not already open, and rewinds the file.</li>
<li>An end entry that closes the data file.</li>
</ol>
</div>
</div>
<div id="outline-container-orgbf33631" class="outline-4">
<h4 id="orgbf33631"><span class="done DONE">DONE</span> 6.8 Login Accounting</h4>
<div class="outline-text-4" id="text-orgbf33631">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">utmp</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">ut_line</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">8</span><span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">tty line: "ttyh0", "ttyd0", "ttyp0", ... */</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">ut_name</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">8</span><span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">login name */</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">ut_time</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">seconds since Epoch */</span>
<span style="color: #4f97d7;">}</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org2c85f2f" class="outline-4">
<h4 id="org2c85f2f"><span class="done DONE">DONE</span> 6.9 System Identification</h4>
<div class="outline-text-4" id="text-org2c85f2f">
<p>
<code>man 3 uname</code>
<code>man 3 gethostname</code>
</p>
</div>
</div>
<div id="outline-container-orgcf92238" class="outline-4">
<h4 id="orgcf92238"><span class="done DONE">DONE</span> 6.10 Time and Date Routines</h4>
<div class="outline-text-4" id="text-orgcf92238">
<p>
<code>man 3 time</code>
<code>man 3 clock_gettime</code>
<code>man 3 gmtime</code>
<code>man 3 strftime</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 34: </span>Figure 6.11 Using the strftime function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">time_t</span>     <span style="color: #7590db;">t</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tm</span> *<span style="color: #7590db;">tmp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>       <span style="color: #7590db;">buf1</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">16</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>       <span style="color: #7590db;">buf2</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">64</span><span style="color: #bc6ec5;">]</span>;

    time<span style="color: #bc6ec5;">(</span>&amp;t<span style="color: #bc6ec5;">)</span>;
    tmp = localtime<span style="color: #bc6ec5;">(</span>&amp;t<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>strftime<span style="color: #2d9574;">(</span>buf1, <span style="color: #a45bad;">16</span>, <span style="color: #2d9574;">"time and date: %r, %a %b %d, %Y"</span>, tmp<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buffer length 16 is too small\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, buf1<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>strftime<span style="color: #2d9574;">(</span>buf2, <span style="color: #a45bad;">64</span>, <span style="color: #2d9574;">"time and date: %r, %a %b %d, %Y"</span>, tmp<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"buffer length 64 is too small\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, buf2<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<p>
<code>man 3 strptim</code>
</p>
</div>
</div>
<div id="outline-container-org06c71b4" class="outline-4">
<h4 id="org06c71b4"><span class="done DONE">DONE</span> 6.11 Summary</h4>
<div class="outline-text-4" id="text-org06c71b4">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li>6.1  On Mac OS, I can't get it <br />
On Linux, use <code>getsnam</code> group functions</li>
<li><p>
6.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">shadow.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">spwd</span> *<span style="color: #7590db;">ptr</span>;

    ptr = getspent<span style="color: #bc6ec5;">()</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"password: %s\n"</span>, ptr-&gt;sp_pwdp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
6.3
</p>
<div class="org-src-container">
<pre class="src src-c,">#include &lt;stdio.h&gt;
#include &lt;sys/utsname.h&gt;

int main() {
    struct utsname name;
    uname(&amp;name);
    printf("%s %s %s %s %s \n", name.sysname, name.nodename, name.release,
           name.version, name.machine);
}
</pre>
</div></li>
<li>6.4 32-bit time: <code>1970 + (2^{31}/60/60/24/365)</code> <br />
after pass : <code>1970 - (2^{31}/60/60/24/365)</code></li>
<li><p>
6.5
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>   <span style="color: #7590db;">tbuf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">64</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">time_t</span> <span style="color: #7590db;">t</span>;

    time<span style="color: #bc6ec5;">(</span>&amp;t<span style="color: #bc6ec5;">)</span>;

    strftime<span style="color: #bc6ec5;">(</span>tbuf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>tbuf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%a %b %d %T %Z %Y"</span>, localtime<span style="color: #2d9574;">(</span>&amp;t<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, tbuf<span style="color: #bc6ec5;">)</span>;

    setenv<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TZ"</span>, <span style="color: #2d9574;">"dkladjlkjklasdj"</span>, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    strftime<span style="color: #bc6ec5;">(</span>tbuf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>tbuf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%a %b %d %T %Z %Y"</span>, localtime<span style="color: #2d9574;">(</span>&amp;t<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, tbuf<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org00e321d" class="outline-3">
<h3 id="org00e321d"><span class="done DONE">DONE</span> Chapter 7. Process Environment <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org00e321d">
</div>
<div id="outline-container-org40c7c0c" class="outline-4">
<h4 id="org40c7c0c"><span class="done DONE">DONE</span> 7.1 Introduction</h4>
</div>
<div id="outline-container-org3506e95" class="outline-4">
<h4 id="org3506e95"><span class="done DONE">DONE</span> 7.2 main Function</h4>
<div class="outline-text-4" id="text-org3506e95">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-org99b0b80" class="outline-4">
<h4 id="org99b0b80"><span class="done DONE">DONE</span> 7.3 Process Termination</h4>
<div class="outline-text-4" id="text-org99b0b80">
<p>
There are eight ways for a process to terminate.
Normal termination occurs in five ways:
</p>
<ol class="org-ol">
<li>Return from main</li>
<li>Calling <code>exit</code></li>
<li>Calling <code>_exit</code> or <code>_Exit</code></li>
<li>Return of the last thread from its start routine (Section 11.5)</li>
<li>Calling pthread_exit (Section 11.5) from the last thread</li>
</ol>


<p>
Abnormal termination occurs in three ways
</p>
<ol class="org-ol">
<li>Calling abort</li>
<li>Receipt of a signal</li>
<li>Response of the last thread to a cancellation request</li>
</ol>
</div>
<ul class="org-ul">
<li><a id="orgf48b9d4"></a><span class="done DONE">DONE</span> Exit Functions<br />
<div class="outline-text-5" id="text-orgf48b9d4">
<p>
<code>man 3 exit</code>
<code>man 2 _exit</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">1. call the functions registered with atexit(3) function, in the reverse order of their registration</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">2. Flush all open output streams</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">3. close all open streams</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">4. unlink all files created with the tmpfile functions</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">_Exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">terminates without calling functions registered with atexit(3),</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">may or my not perform the other actions listed</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">_exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">The _exit() function terminates a process, with the following consequences:</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   All of the descriptors that were open in the calling process are closed.  This may entail delays; for example, waiting for output to drain.  A process in this state may not be</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">killed, as it is already dying.</span>
<span style="color: #2aa1ae; background-color: #292e34;">//</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   If the parent process of the calling process has an outstanding wait call or catches the SIGCHLD signal, it is notified of the calling process's termination; the status is set as</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">defined by wait(2).</span>
<span style="color: #2aa1ae; background-color: #292e34;">//</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   The parent process-ID of all of the calling process's existing child processes are set to 1; the initialization process (see the DEFINITIONS section of intro(2)) inherits each of</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">these processes.</span>
<span style="color: #2aa1ae; background-color: #292e34;">//</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   If the termination of the process causes any process group to become orphaned (usually because the parents of all members of the group have now exited; see ``orphaned process</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">group'' in intro(2)), and if any member of the orphaned group is stopped, the SIGHUP signal and the SIGCONT signal are sent to all members of the newly-orphaned process group.</span>
<span style="color: #2aa1ae; background-color: #292e34;">//</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">o   If the process is a controlling process (see intro(2)), the SIGHUP signal is sent to the foreground process group of the controlling terminal.  All current access to the control-</span>
<span style="color: #2aa1ae; background-color: #292e34;">//     </span><span style="color: #2aa1ae; background-color: #292e34;">ling terminal is revoked.</span>
</pre>
</div>
<p>
<code>_exit</code> does not perform any flushing of standard I/O buffers.
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<pre class="src src-c">
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 35: </span>Figure 7.1 Classic C program</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"hello world\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="orgb739026"></a><span class="done DONE">DONE</span> <code>atexit</code> Function<br />
<div class="outline-text-5" id="text-orgb739026">
<p>
<code>man 3 atexit</code>
The <code>exit</code> function calls these functions in reverse order of their registration.
</p>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 36: </span>Figure 7.3 Example of exit handlers</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_exit1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_exit2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit2<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit2: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit1<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit1: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>atexit<span style="color: #2d9574;">(</span>my_exit1<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't register my_exit1: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"main is done\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_exit1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"first exit handler \n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_exit2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"second exit handler\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="orgf25c5dc"></a><span class="done DONE">DONE</span> Commond-Line Arguments<br />
<div class="outline-text-5" id="text-orgf25c5dc">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 37: </span>Figure 7.4 Echo all command-line arguments to standard output</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">echo all command-line args */</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"argv[%d]: %s\n"</span>, i, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-orge943de0" class="outline-4">
<h4 id="orge943de0"><span class="done DONE">DONE</span> 7.5 Environment List</h4>
<div class="outline-text-4" id="text-orge943de0">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeb46dba" class="outline-4">
<h4 id="orgeb46dba"><span class="done DONE">DONE</span> 7.6 Memory Layout of a C Program</h4>
<div class="outline-text-4" id="text-orgeb46dba">

<div class="figure">
<p><img src="Chapter07/fig7.6.png" alt="fig7.6.png" />
</p>
</div>



<p>
Historically, a C program has been composed of the following pieces:
</p>
<ul class="org-ul">
<li>Text segment: consisting of the machine instructions that the CPU executes.</li>
<li><p>
Initilized data segment, usually called simply the data segment, <br />
containing variables that are specifically initialized in the program.<br />
For example:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">maxcount</span>=<span style="color: #a45bad;">99</span>;
</pre>
</div></li>
<li><p>
Uninitilized data segment, often called the “bss” segment, <br />
named after an ancient assembler operator that stood for “block started by symbol.”
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">sum</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">1024</span><span style="color: #4f97d7;">]</span>;
</pre>
</div></li>
<li>Stack, where automatic variables are stored, <br />
along with information that is saved each time a function is called.</li>
<li><p>
Heap, where dynamic memory allocation usually takes place.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5; font-weight: bold;">malloc</span><span style="color: #4f97d7;">()</span>;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org1d65d5b" class="outline-4">
<h4 id="org1d65d5b"><span class="done DONE">DONE</span> 7.7 Shared Libraries</h4>
<div class="outline-text-4" id="text-org1d65d5b">
<p>
without shared libraries
</p>
<div class="org-src-container">
<pre class="src src-bash">gcc -static hello.c
size a.out
text     data     bss     dec     hex filename
<span style="color: #a45bad;">723103</span>     <span style="color: #a45bad;">7284</span>    <span style="color: #a45bad;">6392</span>  <span style="color: #a45bad;">736779</span>   b3e0b a.out
</pre>
</div>
<p>
use shared libraries, the text and data size are greatly decreased
</p>
<div class="org-src-container">
<pre class="src src-bash">gcc hello.c
size a.out
text     data     bss     dec     hex filename
<span style="color: #a45bad;">1173</span>      <span style="color: #a45bad;">552</span>       <span style="color: #a45bad;">8</span>    <span style="color: #a45bad;">1733</span>     <span style="color: #a45bad;">6c5</span> a.out
</pre>
</div>
</div>
</div>
<div id="outline-container-org262d039" class="outline-4">
<h4 id="org262d039"><span class="done DONE">DONE</span> 7.8 Memory Allocation</h4>
<div class="outline-text-4" id="text-org262d039">
<p>
<code>man 3 malloc</code>
</p>
<ol class="org-ol">
<li><code>malloc</code>, allocates specified number of bytes of memory without initialized</li>
<li><code>calloc</code>, allocates specified number of bytes of memroy with initializing to 0</li>
<li><code>realloc</code>, increase or decrease the size of previous allocated area, the increased area was not initialized</li>
</ol>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">malloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">calloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">nobj</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">size</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">realloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">ptr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">newsize</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">free</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>


<ul class="org-ul">
<li>Alternative Memory Allocators
<ul class="org-ul">
<li><code>jemalloc</code> <br />
designed to scale well when used with multithreaded applications running on multiprocessor systems.</li>
<li><code>TCMalloc</code> <br />
for high performance, scalability, and memory efficiency.</li>
<li><code>alloca</code> Function <br />
alloc memmory from stack, instaead of heap, so we don't have to free the space;</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org282c190" class="outline-4">
<h4 id="org282c190"><span class="done DONE">DONE</span> 7.9 Environment Variable</h4>
<div class="outline-text-4" id="text-org282c190">
<p>
<code>man 3 getenv</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">getenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putenv</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">value</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">rewrite</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">unsetenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
<b>malloc</b>
</p>
</div>
</div>

<div id="outline-container-org1a55068" class="outline-4">
<h4 id="org1a55068"><span class="done DONE">DONE</span> 7.10 <code>setjmp</code> and <code>longjmp</code> Functions</h4>
<div class="outline-text-4" id="text-org1a55068">
<ul class="org-ul">
<li><b>useful for dealing errors and interrupts</b></li>

<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 38: </span>Figure 7.9 Typical program skeleton for command-processing</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">TOK_ADD</span> <span style="color: #a45bad;">5</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">do_line</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>*<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">cmd_add</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #bc6ec5; font-weight: bold;">get_token</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fgets<span style="color: #2d9574;">(</span>line, MAXLINE, stdin<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        do_line<span style="color: #2d9574;">(</span>line<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">tok_ptr</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">global pointer for get_token() */</span>
<span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">tok</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">do_line</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">process one line of input */</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cmd</span>;

    tok_ptr = ptr;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>cmd = get_token<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>cmd<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">one case for each command */</span>
            <span style="color: #4f97d7; font-weight: bold;">case</span> TOK_ADD:
                cmd_add<span style="color: #67b11d;">()</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">cmd_add</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">token</span>;

    token = get_token<span style="color: #bc6ec5;">()</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">reset of processing for this command */</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">get_token</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">fetch next token from line pointed to by tok_ptr */</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> tok++;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>


<p>
<code>man 3 setjmp</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 39: </span>Figure 7.13 Effect of longjmp on various type of variables</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">jmp_buf</span> <span style="color: #7590db;">jmpbuffer</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>     <span style="color: #7590db;">globval</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>          <span style="color: #7590db;">autoval</span>;
    <span style="color: #4f97d7; font-weight: bold;">register</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">regival</span>;
    <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">volaval</span>;
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">statval</span>;

    globval = <span style="color: #a45bad;">1</span>;
    autoval = <span style="color: #a45bad;">2</span>;
    regival = <span style="color: #a45bad;">3</span>;
    volaval = <span style="color: #a45bad;">4</span>;
    statval = <span style="color: #a45bad;">5</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setjmp<span style="color: #2d9574;">(</span>jmpbuffer<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"after longjmp:\n"</span><span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span>
            <span style="color: #2d9574;">"globval = %d, autoval = %d, regival = %d,"</span>
            <span style="color: #2d9574;">" volaval = %d, statval = %d\n"</span>,
            globval, autoval, regival, volaval, statval<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * Change variables after setjmp, but before longjmp.</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    globval = <span style="color: #a45bad;">95</span>;
    autoval = <span style="color: #a45bad;">96</span>;
    regival = <span style="color: #a45bad;">97</span>;
    volaval = <span style="color: #a45bad;">98</span>;
    statval = <span style="color: #a45bad;">99</span>;

    f1<span style="color: #bc6ec5;">(</span>autoval, regival, volaval, statval<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">never returns */</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">j</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">k</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">l</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in                     f1():\n"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span>
        <span style="color: #2d9574;">"globval = %d, autoval = %d, regival = %d,"</span>
        <span style="color: #2d9574;">" volaval = %d, statval = %d\n"</span>,
        globval, i, j, k, l<span style="color: #bc6ec5;">)</span>;
    f2<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> longjmp<span style="color: #bc6ec5;">(</span>jmpbuffer, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><b>Automatic, Register and Volatile Variables</b> <br />
Most implementations do not try to roll back these automatic variables and register variables, but the standards say only that their values are indeterminate</li>
</ul>


<p>
<b>Potential Problem with Automatic Variables</b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 40: </span>Figure 7.14 Incorrect usage of an automatic variable</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     incorrect_usage.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-09-19</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Incorrect usage of an automatic variable</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #bc6ec5; font-weight: bold;">open_data</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span>* <span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>  <span style="color: #7590db;">databuf</span><span style="color: #bc6ec5;">[</span>BUFSIZ<span style="color: #bc6ec5;">]</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">setvbuf makes this the stdio buffer */</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"datafile"</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setvbuf<span style="color: #2d9574;">(</span>fp, databuf, _IOLBF, BUFSIZ<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> fp;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
The problem is that when open_data returns, the space it used on the stack will be used by the stack frame for the next function that is called. But the standard I/O library will still be using that portion of memory for its stream buffer. Chaos is sure to result. To correct this problem, the array databuf needs to be allocated from global memory, either statically (static or extern) or dynamically (one of the alloc functions)
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org9e8b04f" class="outline-4">
<h4 id="org9e8b04f"><span class="done DONE">DONE</span> <code>getrlimit</code> and <code>setrlimit</code> Functions</h4>
<div class="outline-text-4" id="text-org9e8b04f">
<p>
<code>man 3 getrlimit</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 41: </span>Figure 7.16 print the current resource limits</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">doit</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> pr_limits<span style="color: #4f97d7;">(</span>#name, name<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_limits</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *, <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_AS
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_AS<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    doit<span style="color: #bc6ec5;">(</span>RLIMIT_CORE<span style="color: #bc6ec5;">)</span>;
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_CPU<span style="color: #bc6ec5;">)</span>;
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_DATA<span style="color: #bc6ec5;">)</span>;
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_FSIZE<span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_MEMLOCK
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_MEMLOCK<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMITS_MSGQUEUE
    doit<span style="color: #bc6ec5;">(</span>RLIMITS_MSGQUEUE<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    doit<span style="color: #bc6ec5;">(</span>RLIMIT_NOFILE<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span> <span style="color: #7590db;">r</span>;
    memset<span style="color: #bc6ec5;">(</span>&amp;r, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>r<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    getrlimit<span style="color: #bc6ec5;">(</span>RLIMIT_NOFILE, &amp;r<span style="color: #bc6ec5;">)</span>;
    r.rlim_cur = <span style="color: #a45bad;">4096</span>;
    setrlimit<span style="color: #bc6ec5;">(</span>RLIMIT_NOFILE, &amp;r<span style="color: #bc6ec5;">)</span>;

    doit<span style="color: #bc6ec5;">(</span>RLIMIT_NOFILE<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_NPTS
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_NPTS<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_RSS
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_RSS<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_SBSIZE
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_SBSIZE<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_SIGPENDING
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_SIGPENDING<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    doit<span style="color: #bc6ec5;">(</span>RLIMIT_STACK<span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_SWAP
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_SWAP<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#ifdef</span> RLIMIT_VMEM
    doit<span style="color: #bc6ec5;">(</span>RLIMIT_VMEM<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_limits</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">resource</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span>      <span style="color: #7590db;">limit</span>;
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">lim</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getrlimit<span style="color: #2d9574;">(</span>resource, &amp;limit<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"getrlimit error for %s"</span>, name<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%-14s "</span>, name<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>limit.rlim_cur == RLIM_INFINITY<span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"(infinite) "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        lim = limit.rlim_cur;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%10lld "</span>, lim<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>limit.rlim_max == RLIM_INFINITY<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"(infinite)"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        lim = limit.rlim_max;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%10lld"</span>, lim<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    putchar<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'\n'</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org577daf8" class="outline-4">
<h4 id="org577daf8"><span class="done DONE">DONE</span> Summary</h4>
<div class="outline-text-4" id="text-org577daf8">
<ul class="org-ul">
<li>Exercises
<ol class="org-ol">
<li>the length of "hello, world"</li>
<li><code>man 3 exit</code></li>
<li>Nope</li>
<li><b>for NULL usage</b></li>
<li><code>typedef void Exitfunc(void);</code> <br />
<code>int atexit(Exitfunc *func);</code></li>
<li>Yep, not sure</li>
<li>the heap and stack aren't allocated before applying</li>
<li>a.out include symbol info</li>
<li>standard I/O library was copied</li>
<li>Nope. num in heap</li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf4b03cc" class="outline-3">
<h3 id="orgf4b03cc"><span class="done DONE">DONE</span> Chapter 8. Process Control <code>[18/18]</code></h3>
<div class="outline-text-3" id="text-orgf4b03cc">
</div>
<div id="outline-container-org872c034" class="outline-4">
<h4 id="org872c034"><span class="done DONE">DONE</span> 8.1 Introduction</h4>
</div>
<div id="outline-container-org3ea31bb" class="outline-4">
<h4 id="org3ea31bb"><span class="done DONE">DONE</span> 8.2 Process Identifiers</h4>
<div class="outline-text-4" id="text-org3ea31bb">
<p>
Process ID 0 is usually the scheduler process and is often know as <i>swapper</i>.
Process ID 1 is usually the <b>init</b> process.
responsible for bring up a UNIX system after the kernel has been bootstrapped
Process ID 2 is pagedaemon.
responsible for supporting paging of virtual memory system.
</p>

<p>
<code>man 2 getpid</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span> pid_t getpid<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getppid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: parent process ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">uid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getuid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: real user ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">uid_t</span> <span style="color: #bc6ec5; font-weight: bold;">geteuid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: effective user ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">gid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getgid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: real group ID of calling process</span>

<span style="color: #ce537a; font-weight: bold;">gid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getegid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: effective group ID of calling process</span>
</pre>
</div>

<blockquote>
<p>
Note that none of these functions has an error return.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orge1edbab" class="outline-4">
<h4 id="orge1edbab"><span class="done DONE">DONE</span> 8.3 <code>fork</code> Function</h4>
<div class="outline-text-4" id="text-orge1edbab">
<p>
<code>man 3 fork</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">fork</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 in child, process ID of child in parent, &#8722;1 on error</span>
</pre>
</div>


<blockquote>
<p>
called once but return twice.
</p>

<p>
return value in child is 0, whereas the return value in the parent is the process ID of the new child
</p>

<p>
the child gets a copy of the parent’s data space, heap, and stack, parents and child do not share memmory
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 42: </span>Figure 8.1 Example of fork function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">globvar</span> = <span style="color: #a45bad;">6</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">external variable in initialized data */</span>
<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">[]</span>   = <span style="color: #2d9574;">"a write to stdout\n"</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">var</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    var = <span style="color: #a45bad;">88</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>STDOUT_FILENO, buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>buf<span style="color: #67b11d;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> != <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span> - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before fork\n"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        globvar++; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child */</span>
        var++;     <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">modify variables */</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
<p>
<b>changes to variables in a child process do not affect the value of the variables in the parent process.</b>
</p>
<ul class="org-ul">
<li>File Sharing
handling the descriptors after a fork.
<ol class="org-ol">
<li>The parent waits for the child to complete.</li>
<li>Both the parent and the child go their own ways. after fork, close needless descriptors(<b>socket</b>)</li>
</ol></li>
</ul>


<ul class="org-ul">
<li>inherits:
<ul class="org-ul">
<li>Real user ID, real group ID, effective user ID, and effective group ID</li>
<li>Supplementary group IDs</li>
<li>Process group ID</li>
<li>Session ID</li>
<li>Controlling terminal</li>
<li>The set-user-ID and set-group-ID flags</li>
<li>Current working directory</li>
<li>Root directory</li>
<li>File mode creation mask</li>
<li>Signal mask and dispositions</li>
<li>The close-on-exec flag for any open file descriptors</li>
<li>Environment</li>
<li>Attached shared memory segments</li>
<li>Memory mappings</li>
<li>Resource limits</li>
</ul></li>

<li>differences
<ul class="org-ul">
<li>return value</li>
<li>process id</li>
<li>parent id</li>
<li>child's tms_utime, tms_stime, tms_cutime, tms_cstime set to 0</li>
<li>parent's file locks are not inherited</li>
<li>pending alarms are cleared for the child</li>
<li>pending signals set is set to empty for child</li>
</ul></li>

<li><p>
There are two uses for fork:
</p>
<blockquote>
<ol class="org-ol">
<li>When a process wants to duplicate itself so that the parent and the child can each execute different sections of code at the same time.</li>
<li>When a process wants to execute a different program.</li>
</ol>
</blockquote></li>
</ul>
</div>
</div>
<div id="outline-container-orgfff5212" class="outline-4">
<h4 id="orgfff5212"><span class="done DONE">DONE</span> 8.4 <code>vfork</code> Function</h4>
<div class="outline-text-4" id="text-orgfff5212">
<blockquote>
<p>
just like fork, without copying the address space of the parent into the child, as the child won’t reference that address space
</p>

<p>
the child runs in the address space of the parent until it calls either exec or exit.
</p>

<p>
<b>vfork guarantees that the child runs first, until the child calls exec or exit.</b>
</p>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 43: </span>Figure 8.3 Example of vfork function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">globvar</span> = <span style="color: #a45bad;">6</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">external variable in initialized data */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">var</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">automatic variable on the stack */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    var = <span style="color: #a45bad;">88</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">we don't flush stdio */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child */</span>
        globvar++;         <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">modify parent's variables */</span>
        var++;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child terminaltes */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent continues here */</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org2ec116d" class="outline-4">
<h4 id="org2ec116d"><span class="done DONE">DONE</span> 8.5 <code>exit</code> Function</h4>
<div class="outline-text-4" id="text-org2ec116d">
<blockquote>
<p>
As we described in Section 7.3, a process can terminate normally in five ways:
</p>
<ol class="org-ol">
<li>Executing a return from the main function.</li>
<li>Calling the exit function.</li>
<li>Calling the _exit or _Exit function. <b>terminate without running exit handlers or signal handlers.</b></li>
<li>Executing a return from the start routine of the last thread in the process.</li>
<li>Calling the pthread_exit function from the last thread in the process.</li>
</ol>
</blockquote>

<blockquote>
<p>
The three forms of abnormal termination are as follows:
</p>
<ol class="org-ol">
<li>Calling abort. generates <b>SIGABRT</b> signal</li>
<li>When the process receives certain signals.</li>
<li>The last thread responds to a cancellation request.</li>
</ol>
</blockquote>

<blockquote>
<ul class="org-ul">
<li>In UNIX System terminology, a process that has terminated, but whose parent has not yet waited for it, is called a zombie.</li>

<li>The ps(1) command prints the state of a zombie process as Z.</li>
</ul>
</blockquote>
</div>
</div>
<div id="outline-container-org3181d4b" class="outline-4">
<h4 id="org3181d4b"><span class="done DONE">DONE</span> 8.6 <code>wait</code> and <code>waitpid</code> Functions</h4>
<div class="outline-text-4" id="text-org3181d4b">
<blockquote>
<p>
we need to be aware that a process that calls wait or waitpid can
</p>
<ul class="org-ul">
<li>Block, if all of its children are still running</li>
<li>Return immediately with the termination status of a child, if a child has terminated and is waiting for its termination for its termination status to be fetched</li>
<li>Return immediately with an error, if it doesn't have any child processes</li>
</ul>
</blockquote>


<p>
<code>man 2 wait</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">statloc</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">waitpid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">statloc</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">options</span><span style="color: #4f97d7;">)</span>;

Both <span style="color: #4f97d7; font-weight: bold;">return</span>: process ID <span style="color: #4f97d7; font-weight: bold;">if</span> OK, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">see</span> <span style="color: #7590db;">later</span><span style="color: #4f97d7;">)</span>, or -<span style="color: #a45bad;">1</span> on error
</pre>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 44: </span>Figure 8.5 Print a description of the exit status</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>WIFEXITED<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"normal termination, exit status = %d\n"</span>, WEXITSTATUS<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>WIFSIGNALED<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"abnormal termination, signal number = %d%s\n"</span>, WTERMSIG<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span>,
<span style="color: #bc6ec5;">#ifdef</span> WCOREDUMP
               WCOREDUMP<span style="color: #2d9574;">(</span>status<span style="color: #2d9574;">)</span> ? <span style="color: #2d9574;">" (core file generated)"</span> : <span style="color: #2d9574;">""</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
               <span style="color: #2d9574;">""</span><span style="color: #e0211d; text-decoration: overline;">)</span>;
<span style="color: #bc6ec5;">#endif</span>
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>WIFSTOPPED<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
        printf<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"child stopped, signal number = %d\n"</span>, WSTOPSIG<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #e0211d; text-decoration: overline;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 45: </span>Figure 8.6 Demonstrate various exit status</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child */</span>
        exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">7</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #bc6ec5;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">wait for child */</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        abort<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        status /= <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>wait<span style="color: #2d9574;">(</span>&amp;status<span style="color: #2d9574;">)</span> != pid<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<p>
The waitpid function provides three features that aren’t provided by the wait function.
</p>
<ol class="org-ol">
<li>The waitpid function lets us wait for one particular process, whereas the wait function returns the status of any terminated child.</li>
<li>The waitpid function provides a nonblocking version of wait.</li>
<li>The waitpid function provides support for job control with the WUNTRACED and WCONTINUED options.</li>
</ol>
</blockquote>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 46: </span>Figure 8.8 Avoid zombie processes by calling fork twice</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">first child */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>pid = fork<span style="color: #b1951d;">()</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>
            exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent from second fork == first child */</span>

        <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">         * We're the second child; our parent becomes init as soon as</span>
<span style="color: #2aa1ae; background-color: #292e34;">         * our real parent calls exit() in the statement above.</span>
<span style="color: #2aa1ae; background-color: #292e34;">         * Here's where we'd continue executing, knowing that when we're done,</span>
<span style="color: #2aa1ae; background-color: #292e34;">         * init will reap our status.</span>
<span style="color: #2aa1ae; background-color: #292e34;">         */</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"second child, parent pid = %ld\n"</span>, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #67b11d;">)</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> != pid<span style="color: #bc6ec5;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">wait for first child */</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * We're the parent (the original process); we continue executing,</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * knowing that we're not the parent of the second child</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4d8a822" class="outline-4">
<h4 id="org4d8a822"><span class="done DONE">DONE</span> 8.7 <code>waitid</code> Function</h4>
<div class="outline-text-4" id="text-org4d8a822">
<p>
<code>man 2 waitid</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span> <span style="color: #ce537a; font-weight: bold;">int</span> waitid<span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">idtype_t</span> <span style="color: #7590db;">idtype</span>, <span style="color: #ce537a; font-weight: bold;">id_t</span> <span style="color: #7590db;">id</span>, <span style="color: #ce537a; font-weight: bold;">siginfo_t</span> *<span style="color: #7590db;">infop</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">options</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, &#8722;1 on error</span>
</pre>
</div>
<p>
(OS X can't get the info, but the function is valid)
</p>
</div>
</div>
<div id="outline-container-org5973c19" class="outline-4">
<h4 id="org5973c19"><span class="done DONE">DONE</span> 8.8 <code>wait3</code> and <code>wait4</code> Functions</h4>
<div class="outline-text-4" id="text-org5973c19">
<p>
<code>man 2 wait3</code>
</p>
</div>
</div>
<div id="outline-container-org8cb5858" class="outline-4">
<h4 id="org8cb5858"><span class="done DONE">DONE</span> 8.9 Race Conditions</h4>
<div class="outline-text-4" id="text-org8cb5858">
<p>
<b>Avoid race by signal</b>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 47: </span>Figure 8.12 Program with a race condition</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">charatatime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork_ error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">charatatime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ptr</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">c</span>;

    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">set unbuffered */</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>ptr = str; <span style="color: #2d9574;">(</span>c = *ptr++<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span>;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">usleep(100);</span>
        putc<span style="color: #2d9574;">(</span>c, stdout<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">putchar(c);</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 48: </span>Figure 8.13 Modification of Figure 8.12 to avoid race condition</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">charatatime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        WAIT_PARENT<span style="color: #2d9574;">()</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent goes first */</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
        TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
        TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
        WAIT_CHILD<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#else</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #2d9574;">)</span>;
        TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        WAIT_CHILD<span style="color: #2d9574;">()</span>;
        charatatime<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#endif</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">charatatime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ptr</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">c</span>;

    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">set unbuffered */</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>ptr = str; <span style="color: #2d9574;">(</span>c = *ptr++<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span>;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        usleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">100</span><span style="color: #2d9574;">)</span>;
        putc<span style="color: #2d9574;">(</span>c, stdout<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orge504cf4" class="outline-4">
<h4 id="orge504cf4"><span class="done DONE">DONE</span> 8.10 <code>exec</code> Functions</h4>
<div class="outline-text-4" id="text-orge504cf4">
<p>
<code>man 3 exec</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execl</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">arg0</span>, ... <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">(char *)0 */</span> <span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execle</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">arg0</span>, ...
           <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">(char *)0, char *const envp[] */</span> <span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execve</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">pathname</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">envp</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execlp</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">filename</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">arg0</span>, ... <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">(char *)0 */</span> <span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">execvp</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">filename</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">fexecve</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #7590db;">envp</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
Returns: All seven return: −1 on error, no return on success
</p>


<blockquote>
<p>
The first difference in these functions is that the first four take a pathname argument, the next two take a filename argument, and the last one takes a file descriptor argument. When a filename argument is specified,
</p>
<ul class="org-ul">
<li>If filename contains a slash, it is taken as a pathname.</li>
<li>Otherwise, the executable file is searched for in the directories specified by the <b>PATH</b> environment variable.</li>
</ul>
</blockquote>


<p>
<code>execlp</code> and <code>execvp</code> assume <b>link</b> as a <b>shell script</b>, and try to invoke <code>/bin/sh</code> with <b>filename</b>
</p>


<blockquote>
<p>
The letter <b>p</b> means that the function takes a filename argument and uses the PATH environment variable to find the executable file
The letter <b>l</b> means that the function takes a list of arguments and is mutually exclusive
The letter <b>v</b>, means that it takes an argv[] vector.
Finally, the letter <b>e</b> means that the function takes an envp[] array instead of using the current environment.
</p>
</blockquote>



<div class="figure">
<p><img src="Chapter08/Figure8.14.png" alt="Figure8.14.png" />
</p>
<p><span class="figure-number">Figure 2: </span>Figure 8.14 Differences among the seven exec functions</p>
</div>


<div class="figure">
<p><img src="Chapter08/Figure8.15.png" alt="Figure8.15.png" />
</p>
<p><span class="figure-number">Figure 3: </span>Figure 8.15 Relationship of the seven exec functions</p>
</div>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 49: </span>Figure 8.16 Example of exec functions</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">env_init</span><span style="color: #4f97d7;">[]</span> = <span style="color: #4f97d7;">{</span><span style="color: #2d9574;">"USER=unknown"</span>, <span style="color: #2d9574;">"PATH=/tmp"</span>, <span style="color: #a45bad;">NULL</span><span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">specify pathname, specify environment */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execle<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"echo"</span>, <span style="color: #2d9574;">"echoall"</span>, <span style="color: #2d9574;">"myarg1"</span>, <span style="color: #2d9574;">"MY ARG2"</span>, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span>,
                   env_init<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"execle error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">specify filename, inherit environment */</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execlp<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"echo"</span>, <span style="color: #2d9574;">"echoall"</span>, <span style="color: #2d9574;">"only 1 arg"</span>, <span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #b1951d;">)</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>
            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"execlp error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 50: </span>Figure 8.17 Echo all command-line arguments and all environment strings</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">i</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> **       <span style="color: #7590db;">ptr</span>;
    <span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">"echo all command-line args" */</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"argv[%d]: %s\n"</span>, i, argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>ptr = environ; *ptr != <span style="color: #a45bad;">0</span>; ++ptr<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s\n"</span>, *ptr<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgcbb3426" class="outline-4">
<h4 id="orgcbb3426"><span class="done DONE">DONE</span> 8.11 Changing User IDs and Group IDs</h4>
<div class="outline-text-4" id="text-orgcbb3426">
<p>
<code>man 2 setuid</code>
</p>
<blockquote>
<ol class="org-ol">
<li>If the process has superuser privileges, the setuid function sets the real user ID, effective user ID, and saved set-user-ID to uid.</li>

<li>If the process does not have superuser privileges, but uid equals either the real user ID or the saved set-user-ID, setuid sets only the effective user ID to uid. The real user ID and the saved set-user-ID are not changed.</li>

<li>If neither of these two conditions is true, errno is set to EPERM and −1 is returned.</li>
</ol>
</blockquote>
<p>
<img src="Chapter08/Figure8.18.png" alt="Figure8.18.png" />
<code>man 2 setreuid</code>
<code>man 2 setregid</code>
</p>
</div>
</div>
<div id="outline-container-org5b17a1a" class="outline-4">
<h4 id="org5b17a1a"><span class="done DONE">DONE</span> 8.12 Interpreter Files</h4>
<div class="outline-text-4" id="text-org5b17a1a">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 51: </span>Figure 8.20 A program that execs an interpreter file</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>execlp<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"systype.sh"</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"execl error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>waitpid<span style="color: #2d9574;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 52: </span>Figure 8.21 An awk program as an interpreter file</label><pre class="src src-c">#<span style="color: #a45bad;">!</span>/usr/bin/awk -f
<span style="color: #bc6ec5;"># Note</span>: On Solaris, use <span style="color: #ce537a; font-weight: bold;">nawk</span> <span style="color: #7590db;">instead</span>

BEGIN <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; ARGC; i ++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    printf <span style="color: #2d9574;">"ARGV[%d] = %s\n"</span>, i, ARGV<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>
  <span style="color: #bc6ec5;">}</span>
  exit
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org48d66a7" class="outline-4">
<h4 id="org48d66a7"><span class="done DONE">DONE</span> 8.13 <code>system</code> Function</h4>
<div class="outline-text-4" id="text-org48d66a7">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">system</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
*if <i>cmdstring</i> is a <code>NULL</code>, <code>system</code> returns nonzero only if a command processor is available.
</p>
<blockquote>
<ol class="org-ol">
<li>If either the fork fails or waitpid returns an error other than EINTR, system returns −1 with errno set to indicate the error.</li>

<li>If the exec fails, implying that the shell can’t be executed, the return value is as if the shell had executed exit(127).</li>

<li>Otherwise, all three functions—fork, exec, and waitpid—succeed, and the return value from system is the termination status of the shell, in the format specified for waitpid.</li>
</ol>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 53: </span>Figure 8.22 The system function, without signal handling</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">version without signal handling</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">system</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cmdstring == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">1</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">always a command processor with UNIX */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        status = -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"shell1"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">27</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #a45bad;">1</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> status;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">calling system function</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"date"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;

    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"nosuchcommand"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"who; exit 44"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 54: </span>Figure 8.23 Calling the system function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">version without signal handling</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">system</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cmdstring == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">1</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">always a command processor with UNIX */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        status = -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"shell1"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">27</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #a45bad;">1</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> status;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">calling system function</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"date"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;

    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"nosuchcommand"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"who; exit 44"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<p>
The advantage in using system, instead of using fork and exec directly, is that system does all the required error handling and (in our next version of this function in Section 10.18) all the required signal handling.
</p>
</blockquote>



<p>
<b>Set-User-ID Programs</b>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 55: </span>Figure 8.24 Execute the command-line argument using system</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">status</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc &lt; <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"command-line argument required"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
#+include; "Chapter08/pruids.c" src c
</p>
</div>
</div>
<div id="outline-container-org64fda0b" class="outline-4">
<h4 id="org64fda0b"><span class="done DONE">DONE</span> 8.14 Process Accounting</h4>
<div class="outline-text-4" id="text-org64fda0b">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 56: </span>Figure 8.28 Program to generate accounting data</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">4</span><span style="color: #2d9574;">)</span>;
        abort<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/dd"</span>, <span style="color: #2d9574;">"dd"</span>, <span style="color: #2d9574;">"if=/etc/passwd"</span>, <span style="color: #2d9574;">"of=/dev/null"</span>, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">7</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">8</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">6</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGKILL<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">6</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 57: </span>Figure 8.29 Print select fields from system's accounting file</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">ctype.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/acct.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/types.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>BSD<span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">different structure in FreeBSD */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">acct</span>    acctv2
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">ac_flag</span> ac_trailer.ac_flag
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FMT</span>     <span style="color: #2d9574;">"%-*.*s e = %.0f, chars = %.0f, %c %c %c %c\n"</span>
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>HAS_AC_STAT<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FMT</span> <span style="color: #2d9574;">"%-*.*s e = %6ld, chars = %7ld, stat = %3u: %c %c %c %c\n"</span>
<span style="color: #bc6ec5;">#else</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">FMT</span> <span style="color: #2d9574;">"%-*.*s e = %6ld, chars = %7ld, %c %c %c %c\n"</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>LINUX<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">acct</span> acct_v3 <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">different structure in Linux */</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">!</span><span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>ACORE<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">ACORE</span> <span style="color: #a45bad;">0</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">!</span><span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>AXSIG<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">AXSIG</span> <span style="color: #a45bad;">0</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #a45bad;">!</span><span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>BSD<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #bc6ec5; font-weight: bold;">compt2ulong</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">comp_t</span> <span style="color: #7590db;">comptime</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">convert comp_t to unsigned long */</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">val</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>           <span style="color: #7590db;">exp</span>;

    val = comptime &amp; <span style="color: #a45bad;">0x1fff</span>;    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">13-bit fraction  */</span>
    exp = <span style="color: #bc6ec5;">(</span>comptime &gt;&gt; <span style="color: #a45bad;">13</span><span style="color: #bc6ec5;">)</span> &amp; <span style="color: #a45bad;">7</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">3-bit exponent(0-7)  */</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>exp-- &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> val *= <span style="color: #a45bad;">8</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> val;
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[</span>argc<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">acct</span> <span style="color: #7590db;">acdata</span>;
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *      <span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"usage pracct filename"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = fopen<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">"r"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"can't open %s"</span>, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fread<span style="color: #2d9574;">(</span>&amp;acdata, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>acdata<span style="color: #67b11d;">)</span>, <span style="color: #a45bad;">1</span>, fp<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span>FMT, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #67b11d;">)</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>acdata.ac_comm<span style="color: #67b11d;">)</span>, acdata.ac_comm,
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #67b11d;">(</span>BSD<span style="color: #67b11d;">)</span>
               acdata.ac_etime, acdata.ac_io,
<span style="color: #bc6ec5;">#else</span>
               compt2ulong<span style="color: #67b11d;">(</span>acdata.ac_etime<span style="color: #67b11d;">)</span>, compt2ulong<span style="color: #67b11d;">(</span>acdata.ac_io<span style="color: #67b11d;">)</span>,
<span style="color: #bc6ec5;">#endif</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #67b11d;">(</span>HAS_AC_STAT<span style="color: #67b11d;">)</span>
               <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">char</span><span style="color: #67b11d;">)</span>acdata.ac_stat,
<span style="color: #bc6ec5;">#endif</span>
               acdata.ac_flag &amp; ACORE ? <span style="color: #2d9574;">'D'</span> : <span style="color: #2d9574;">' '</span>,
               acdata.ac_flag &amp; AXSIG ? <span style="color: #2d9574;">'X'</span> : <span style="color: #2d9574;">' '</span>,
               acdata.ac_flag &amp; AFORK ? <span style="color: #2d9574;">'F'</span> : <span style="color: #2d9574;">' '</span>,
               acdata.ac_flag &amp; ASU ? <span style="color: #2d9574;">'S'</span> : <span style="color: #2d9574;">' '</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org7e6a4cf" class="outline-4">
<h4 id="org7e6a4cf"><span class="done DONE">DONE</span> 8.15 User Identification</h4>
<div class="outline-text-4" id="text-org7e6a4cf">
<p>
<code>man 2 getlogin</code>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 58: </span>getlogin</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s\n"</span>, getlogin<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdace29d" class="outline-4">
<h4 id="orgdace29d"><span class="done DONE">DONE</span> 8.16 Process Scheduling</h4>
<div class="outline-text-4" id="text-orgdace29d">
<p>
Lower nice values have higher scheduling priority.
</p>

<p>
<code>man 3 nice</code>
<code>man 3 getpriority</code>
</p>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 59: </span>Figure 8.30 Evaluate the effect of changing the nice value</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__APPLE__<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/syslimits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>SOLARIS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>BSD<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/param.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">count</span>;
<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span>     <span style="color: #7590db;">end</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">checktime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;tv, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>tv.tv_sec &gt;= end.tv_sec &amp;&amp; tv.tv_usec &gt;= end.tv_usec<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s count = %lld\n"</span>, str, count<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">s</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">nzero</span>, <span style="color: #7590db;">ret</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">adj</span> = <span style="color: #a45bad;">0</span>;

    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>NZERO<span style="color: #bc6ec5;">)</span>
    nzero = NZERO;
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>_SC_NZERO<span style="color: #bc6ec5;">)</span>
    nzero = sysconf<span style="color: #bc6ec5;">(</span>_SC_NZERO<span style="color: #bc6ec5;">)</span>;
<span style="color: #bc6ec5;">#else</span>
<span style="color: #bc6ec5;">#error</span> <span style="color: #2d9574;">NZERO undefined</span>
<span style="color: #bc6ec5;">#endif</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"NZERO = %d\n"</span>, nzero<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc == <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> adj = strtol<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span>;
    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;end, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    end.tv_sec += <span style="color: #a45bad;">10</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">run for 10 seconds */</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child */</span>
        s = <span style="color: #2d9574;">"child"</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"current nice value in child is %d adjusting by %d\n"</span>,
               nice<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> + nzero, adj<span style="color: #2d9574;">)</span>;
        errno = <span style="color: #a45bad;">0</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ret = nice<span style="color: #b1951d;">(</span>adj<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == -<span style="color: #a45bad;">1</span> &amp;&amp; errno != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child set scheduling priority"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"now child nice value is %d\n"</span>, ret + nzero<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent */</span>
        s = <span style="color: #2d9574;">"parent"</span>;
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"current nice value in parent is %d\n"</span>, nice<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> + nzero<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>++count == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_quit<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%s counter wrap"</span>, s<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        checktime<span style="color: #2d9574;">(</span>s<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org8f8bc81" class="outline-4">
<h4 id="org8f8bc81"><span class="done DONE">DONE</span> 8.17 Process Times</h4>
<div class="outline-text-4" id="text-org8f8bc81">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/times.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">clock_t</span> <span style="color: #bc6ec5; font-weight: bold;">times</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *<span style="color: #7590db;">buf</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: elapsed wall clock time in clock ticks if OK, -1 on error</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 60: </span>Figure 8.31 Time and execute all command-line arguments</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/times.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_times</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">clock_t</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">do_cmd</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>;
    setbuf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">1</span>; i &lt; argc; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        do_cmd<span style="color: #2d9574;">(</span>argv<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">do_cmd</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> <span style="color: #7590db;">tmsstart</span>, <span style="color: #7590db;">tmsend</span>;
    <span style="color: #ce537a; font-weight: bold;">clock_t</span>    <span style="color: #7590db;">start</span>, <span style="color: #7590db;">end</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>        <span style="color: #7590db;">status</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\ncommand: %s\n"</span>, cmd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>start = times<span style="color: #67b11d;">(</span>&amp;tmsstart<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"times error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>status = system<span style="color: #67b11d;">(</span>cmd<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>end = times<span style="color: #67b11d;">(</span>&amp;tmsend<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"times error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    pr_times<span style="color: #bc6ec5;">(</span>end - start, &amp;tmsstart, &amp;tmsend<span style="color: #bc6ec5;">)</span>;
    pr_exit<span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_times</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">clock_t</span> <span style="color: #7590db;">real</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *<span style="color: #7590db;">tmsstart</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tms</span> *<span style="color: #7590db;">tmsend</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">clktck</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>clktck == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>clktck = sysconf<span style="color: #b1951d;">(</span>_SC_CLK_TCK<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"sysconf error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  real:         %7.2f\n"</span>, real / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  user:         %7.2f\n"</span>,
           <span style="color: #2d9574;">(</span>tmsend-&gt;tms_utime - tmsstart-&gt;tms_utime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  sys:          %7.2f\n"</span>,
           <span style="color: #2d9574;">(</span>tmsend-&gt;tms_stime - tmsstart-&gt;tms_stime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  child user:   %7.2f\n"</span>,
           <span style="color: #2d9574;">(</span>tmsend-&gt;tms_cutime - tmsstart-&gt;tms_cutime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"  child sys:    %7.2f\n"</span>,
           <span style="color: #2d9574;">(</span>tmsend-&gt;tms_cstime - tmsstart-&gt;tms_cstime<span style="color: #2d9574;">)</span> / <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">double</span><span style="color: #2d9574;">)</span>clktck<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org85391e9" class="outline-4">
<h4 id="org85391e9"><span class="done DONE">DONE</span> 8.18 Summary</h4>
<div class="outline-text-4" id="text-org85391e9">
<p>
functions to master: <code>fork</code>, <code>exec</code> family, <code>_exit</code>, <code>wait</code> and <code>waitpid</code>.
</p>

<p>
<code>fork</code> function gave us an opportunity to look at race conditions.
</p>

<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 61: </span>8.1</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">globvar</span> = <span style="color: #a45bad;">6</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">external variable in initialized data */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">var</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">automatic variable on the stack */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    var = <span style="color: #a45bad;">88</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">we don't flush stdio */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child */</span>
        globvar++;         <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">modify parent's variables */</span>
        var++;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child terminaltes */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent continues here */</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 62: </span>8.2</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>, <span style="color: #bc6ec5; font-weight: bold;">f2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    f1<span style="color: #bc6ec5;">()</span>;

    f2<span style="color: #bc6ec5;">()</span>;

    _exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child and parent both return */</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">f2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">100</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">i</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">automatic variables */</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span>; i++<span style="color: #bc6ec5;">)</span> buf<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> = <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 63: </span>8.3</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">globvar</span> = <span style="color: #a45bad;">6</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">external variable in initialized data */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">var</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">automatic variable on the stack */</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    var = <span style="color: #a45bad;">88</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"before vfork\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">we don't flush stdio */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = vfork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"vfork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child */</span>
        globvar++;         <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">modify parent's variables */</span>
        var++;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">child terminaltes */</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent continues here */</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %ld, glob = %d, var = %d\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span>, globvar, var<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li>8.4</li>
</ul></li>
</ul>
<p>
In Figure 8.13, we have the parent write its output first. When the parent is done, the child writes its output, but we let the parent terminate. Whether the parent terminates or whether the child finishes its output first depends on the kernel’s scheduling of the two processes (another race condition). When the parent terminates, the shell starts up the next program, and this next program can interfere with the output from the previous child.
We can prevent this from happening by not letting the parent terminate until the child has also finished its output. Replace the code following the fork with the following:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">(</span>pid ~~ <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    WAIT_PARENT<span style="color: #bc6ec5;">()</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">parent goes first */</span>
    charatatime<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"output from child\n"</span><span style="color: #bc6ec5;">)</span>;
    TELL_PARENT<span style="color: #bc6ec5;">(</span>getppid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">tell parent we&#8217;re done */</span>
<span style="color: #4f97d7;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7;">{</span>
    charatatime<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"output from parent\n"</span><span style="color: #bc6ec5;">)</span>;
    TELL_CHILD<span style="color: #bc6ec5;">(</span>pid<span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">tell child we&#8217;re done */</span>
    WAIT_CHILD<span style="color: #bc6ec5;">()</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">wait for child to finish */</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
We won’t see this happen if we let the child go first, since the shell doesn’t start the next program until the parent terminates.
</p>
<ul class="org-ul">
<li>8.5 The same value</li>
<li><div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 64: </span>8.6</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">)</span>;

    system<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ps -o pid,ppid,state,tty,command"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org80cda60" class="outline-3">
<h3 id="org80cda60"><span class="todo TODO">TODO</span> Chapter 9. Process Relationships <code>[8/12]</code></h3>
<div class="outline-text-3" id="text-org80cda60">
</div>
<div id="outline-container-orgbc6c544" class="outline-4">
<h4 id="orgbc6c544"><span class="done DONE">DONE</span> 9.1 Introduction</h4>
</div>
<div id="outline-container-orgafcba00" class="outline-4">
<h4 id="orgafcba00"><span class="done DONE">DONE</span> 9.2 Terminal Logins</h4>
<div class="outline-text-4" id="text-orgafcba00">
<ul class="org-ul">
<li><p>
BSD Terminal Logins
</p>

<div class="figure">
<p><a href="Chapter09/fig9.1.png"><img src="Chapter09/fig9.1.png" alt="fig9.1.png" /></a>
</p>
<p><span class="figure-number">Figure 4: </span>Figure 9.1 Processes invoked by init to allow terminal logins</p>
</div>
<blockquote>
<p>
a real user ID of 0 and an effective user ID of 0
</p>
</blockquote>

<p>
<code>login</code> program similar to
</p>
<div class="org-src-container">
<pre class="src src-c">execle<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"/bin/login"</span>, <span style="color: #2d9574;">"login"</span>, <span style="color: #2d9574;">"-p"</span>, username, <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5;">)</span><span style="color: #a45bad;">0</span>, envp<span style="color: #4f97d7;">)</span>;
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgb21459e" class="outline-4">
<h4 id="orgb21459e"><span class="done DONE">DONE</span> 9.3 Network Logins</h4>
<div class="outline-text-4" id="text-orgb21459e">
<blockquote>
<p>
The main (physical) difference between logging in to a system through a serial terminal and logging ni to a system through a network is that the connection between the terminal and the computer isn't point-to-point.
</p>

<p>
To allow the same software to process logins over both terminal logins and network logins, a software driver called a pseudo terminal is used to emulate the behavior of a serial terminal and map terminal operations to network operations, and vice versa.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgf03e2b5" class="outline-4">
<h4 id="orgf03e2b5"><span class="done DONE">DONE</span> 9.4 Process Groups</h4>
<div class="outline-text-4" id="text-orgf03e2b5">
<div class="org-src-container">
<pre class="src src-c" id="orgdf7225d"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getpgrp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process group ID of calling process</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-c" id="org523bcd3"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getpgid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process group ID if OK, -1 on error</span>
</pre>
</div>

<p>
<code>getpgid(0) == getpgrp()</code>
</p>

<div class="org-src-container">
<pre class="src src-c" id="org304783e"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setpgid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">ipd_t</span> <span style="color: #7590db;">pid</span>, <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pgid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
<p>
if <i>pid == pgid</i>, the pid becomes a process group leader
if <i>pid == 0</i>, the process ID of the caller is used.
if <i>pgid == 0</i>, the process ID specified by pid is used as process group ID
</p>
</div>
</div>

<div id="outline-container-org2d1098f" class="outline-4">
<h4 id="org2d1098f"><span class="done DONE">DONE</span> 9.5 Sessions</h4>
<div class="outline-text-4" id="text-org2d1098f">
<blockquote>
<p>
A session is a collection of one or more process groups.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c" id="org1382d8a"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">setsid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process group ID if OK, -1 on error</span>
</pre>
</div>
<ol class="org-ol">
<li>The process becomes the <i>session leader</i> of this new session. (A session leader is the process that creates a session)</li>
<li>The process becomes the process group leader of a new process group.</li>
<li>The process has no controlling terminal.</li>
</ol>


<div class="org-src-container">
<pre class="src src-c" id="orge6b17c0"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">getsid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: session leader's process group ID if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org38e4190" class="outline-4">
<h4 id="org38e4190"><span class="done DONE">DONE</span> 9.6 Controlling Terminal</h4>
<div class="outline-text-4" id="text-org38e4190">
<p>
Sessions and progress groups have a few other characteristics
</p>
<ul class="org-ul">
<li>A session can have a single <i>controlling terminal</i>.</li>
<li>The session leader that establishes the connection to the controlling terminal</li>
<li>The process groups within a session can be divided into a single <i>foreground process group</i> and one or more <i>background proces groups</i></li>
<li>If a session has a controlling terminal, it has a single foreground process group and all other process groups in the session are background process groups</li>
<li>Whenever we press the terminal's interrupt key(often DELETE or Control-C), the interrupt signal is sent to all processes in the foreground process group.</li>
<li>Whenever we press the terminal's quit key(Often Control-backslash), the quit signal is sent to all processes in the foreground process group.</li>
<li>If a modem(or network) disconnect is detected by the terminal interface, the hang-up signal is sent to the controlling process (the session leader).</li>
</ul>
</div>
</div>

<div id="outline-container-org14dc902" class="outline-4">
<h4 id="org14dc902"><span class="done DONE">DONE</span> 9.7 <code>tcgetpgrp</code>, <code>tcsetpgrp</code>, and <code>tcgetsid</code> Functions</h4>
<div class="outline-text-4" id="text-org14dc902">
<div class="org-src-container">
<pre class="src src-c" id="org63fb52e"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">tcgetpgrp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: process group ID of foreground process group if OK, -1 on error</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">tcsetpgrp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pgrpid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on eror</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c" id="org385bfc4"><span style="color: #bc6ec5;">      #include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">termios.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #bc6ec5; font-weight: bold;">tcgetsid</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: session leader's process group ID if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org42c82af" class="outline-4">
<h4 id="org42c82af"><span class="done DONE">DONE</span> 9.8 Job Control</h4>
<div class="outline-text-4" id="text-org42c82af">
<p>
Requirements:
</p>
<ol class="org-ol">
<li>A shell that supports job control</li>
<li>The terminal driver in the kernel must support job control</li>
<li>The kernel must support certain job-control signals</li>
</ol>


<div class="org-src-container">
<pre class="src src-sh">cat &gt; temp.foo &amp; <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">&amp; let start in background</span>
<span style="color: #4f97d7;">fg</span> % <span style="color: #a45bad;">1</span> <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">% bring job number into the foreground</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-sh">stty tostop <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">disable ability of background to output to controlling terminal</span>
</pre>
</div>


<p>
generate signals to the foreground process group:
</p>
<ol class="org-ol">
<li>The interrupt character (typically DELETE or Control-C) generates SIGINT.</li>
<li>The quit character (typically Control-backslash) generates SIGQUIT.</li>
<li>The suspend character (typically Control-Z) generates SIGTSTP.</li>
</ol>
</div>
</div>
<div id="outline-container-org529dcdc" class="outline-4">
<h4 id="org529dcdc"><span class="todo TODO">TODO</span> 9.9 Shell Execution Programs</h4>
</div>
<div id="outline-container-org636c8e4" class="outline-4">
<h4 id="org636c8e4"><span class="todo TODO">TODO</span> 9.10 Orphaned Process Groups</h4>
</div>
<div id="outline-container-orge9574f9" class="outline-4">
<h4 id="orge9574f9"><span class="todo TODO">TODO</span> 9.11 FreeBSD Implementation</h4>
</div>
<div id="outline-container-org768b464" class="outline-4">
<h4 id="org768b464"><span class="todo TODO">TODO</span> 9.12 Summary</h4>
</div>
</div>
<div id="outline-container-org39f97cf" class="outline-3">
<h3 id="org39f97cf"><span class="done DONE">DONE</span> Chapter 10. Signals <code>[23/23]</code></h3>
<div class="outline-text-3" id="text-org39f97cf">
</div>
<div id="outline-container-org0ecc5b3" class="outline-4">
<h4 id="org0ecc5b3"><span class="done DONE">DONE</span> 10.1 Introduction</h4>
<div class="outline-text-4" id="text-org0ecc5b3">
<blockquote>
<p>
Signals provide a way of handling asynchronous events
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgcfc7dc3" class="outline-4">
<h4 id="orgcfc7dc3"><span class="done DONE">DONE</span> 10.2 Signal Concepts</h4>
<div class="outline-text-4" id="text-orgcfc7dc3">
<p>
<code>&lt;signal.h&gt;</code>
conditions can generate a signal
</p>
<ul class="org-ul">
<li>terminal generated when users press certain terminal keys.</li>
<li>hardware exceptions</li>
<li>function <code>kill</code> (man 2 kill)</li>
<li>command <code>kill</code> (man 1 kill)</li>
<li>software conditions : <code>SIGURG</code> <code>SIGPIPE</code> <code>SIGALARM</code></li>
</ul>


<p>
deal with signals via one of things below:
</p>
<ul class="org-ul">
<li>ignore</li>
<li>catch</li>
<li>use defaut action apply</li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Figure 10.1 UNIX System signals</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Default Action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SIGABRT</td>
<td class="org-left">abnormal termination(abort)</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGALARM</td>
<td class="org-left">timer expired(alarm)</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGBUS</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGCHLD</td>
<td class="org-left">change in the status of child</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGCONT</td>
<td class="org-left">continue stopped process</td>
<td class="org-left">continue/ignore</td>
</tr>

<tr>
<td class="org-left">SIGEMT</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGFPE</td>
<td class="org-left">arithmetic exception</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGFREEZE</td>
<td class="org-left">checkpoint freeze</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGHUP</td>
<td class="org-left">hangup</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGILL</td>
<td class="org-left">illegal instruction</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGINFO</td>
<td class="org-left">status request from keyboard</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGINT</td>
<td class="org-left">terminal interrupt character</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGIO</td>
<td class="org-left">asynchronous I/O</td>
<td class="org-left">terminate/ignore</td>
</tr>

<tr>
<td class="org-left">SIGIOT</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGKILL</td>
<td class="org-left">termination : <b>can't be caught or ignored</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPIPE</td>
<td class="org-left">write to pipe with no readers</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPOLL</td>
<td class="org-left">pollable event(poll): <b>might be removed</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPROF</td>
<td class="org-left">profiling time alarm(setitimer):  <b>might be removed</b></td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGPWR</td>
<td class="org-left">power fail/restart</td>
<td class="org-left">terminate/ignore</td>
</tr>

<tr>
<td class="org-left">SIGQUIT</td>
<td class="org-left">terminal quit character</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGSEGV</td>
<td class="org-left">invalid memory reference</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGSTKFLT</td>
<td class="org-left">coprocessor stack fault</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGSTOP</td>
<td class="org-left">stop: <b>can't be caught or ignored</b></td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGSYS</td>
<td class="org-left">invalid system call</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGTERM</td>
<td class="org-left">termination</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGTHAW</td>
<td class="org-left">checkpoint thaw</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGTHR</td>
<td class="org-left">threads library internal use</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGTRAP</td>
<td class="org-left">hardware fault</td>
<td class="org-left">terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGTSTP</td>
<td class="org-left">terminal stop character</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGTTIN</td>
<td class="org-left">background read from control tty</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGTTOU</td>
<td class="org-left">background write to control tty</td>
<td class="org-left">stop process</td>
</tr>

<tr>
<td class="org-left">SIGURG</td>
<td class="org-left">urgent condition(sockets)</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGUSR1</td>
<td class="org-left">user-defined signal</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGUSR2</td>
<td class="org-left">user-defined signal</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGVTALRM</td>
<td class="org-left">virtual time alarm(setitimer)</td>
<td class="org-left">terminate</td>
</tr>

<tr>
<td class="org-left">SIGWAITING</td>
<td class="org-left">threads library internal use</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGWINCH</td>
<td class="org-left">terminal window size change</td>
<td class="org-left">ignore</td>
</tr>

<tr>
<td class="org-left">SIGXCPU</td>
<td class="org-left">CPU limit exceeded (setrlimit)</td>
<td class="org-left">terminate or terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGXFSZ</td>
<td class="org-left">file size limit exceeded(setrlimit0)</td>
<td class="org-left">terminate or terminate+core</td>
</tr>

<tr>
<td class="org-left">SIGXRES</td>
<td class="org-left">resource control exceeded</td>
<td class="org-left">ignore</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
The core file will not be generated if
</p>
<ol class="org-ol">
<li>the process was set-user-ID and the current user is not the owner of the program file</li>
<li>the process was set-group-ID and the current user is not the group owner of the file</li>
<li>the user does not have permission to write in the current working directory</li>
<li>the file already exists and the user does not have permission to write it</li>
<li>the file is too big (recall the RLIMIT_CORE)</li>
</ol>

<p>
The permission of the core file are usually <code>rw</code>, although Mac OSX sets only <code>r</code>
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org8ebfc4a" class="outline-4">
<h4 id="org8ebfc4a"><span class="done DONE">DONE</span> 10.3 <code>signal</code> Function</h4>
<div class="outline-text-4" id="text-org8ebfc4a">
<div class="org-src-container">
<pre class="src src-sh">man signal
</pre>
</div>

<ul class="org-ul">
<li>Example: <br /></li>
</ul>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 65: </span>Figure 10.2 Simple program to catch SIGUSR1 and SIGUSR2</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_usr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">one handler for both signals */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"can't catch SIGUSR1"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR2, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"can't catch SIGUSR2"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> pause<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_usr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGUSR1<span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"received SIGUSR1\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGUSR2<span style="color: #bc6ec5;">)</span>
        printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"received SIGUSR2\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        err_dump<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"received signal %d\n"</span>, signo<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
FreeBSD 8.0 and Mac OS X 10.6.8 don’t exhibit this problem, because BSD - based systems generally don’t support historical System V semantics for SIGCLD. Linux 3.2.0 also doesn’t exhibit this problem, because it doesn’t call the SIGCHLD signal handler when a process arranges to catch SIGCHLD and child processes are ready to be waited for, even though SIGCLD and SIGCHLD are defined to be the same value.
</p>
</blockquote>

<ul class="org-ul">
<li>Program Start-Up
we are not able to determine the current disposition of a signal without changing the disposition</li>
</ul>
</div>
</div>
<div id="outline-container-org74ee4ba" class="outline-4">
<h4 id="org74ee4ba"><span class="done DONE">DONE</span> 10.4 Unreliable Signals</h4>
<div class="outline-text-4" id="text-org74ee4ba">
<p>
In ealier versions of the UNIX system :
</p>
<ul class="org-ul">
<li>signals could get lost</li>
<li>the process was unable to turn a signal off when it didn’t want the signal to occur</li>
</ul>
</div>
</div>
<div id="outline-container-org4a723a3" class="outline-4">
<h4 id="org4a723a3"><span class="done DONE">DONE</span> 10.5 Interrupted System Calls</h4>
<div class="outline-text-4" id="text-org4a723a3">
<ul class="org-ul">
<li>automatically restarted functions: <code>ioctl</code>, <code>read</code>, <code>readv</code>, <code>write</code>, <code>writev</code>, <code>wait</code>, <code>waitpid</code> <br />
POSIX.1 requires an implementation to restart system calls only when the SA_RESTART flag is in effect for the interrupting signal.</li>
</ul>
</div>
</div>
<div id="outline-container-orgedf77d8" class="outline-4">
<h4 id="orgedf77d8"><span class="done DONE">DONE</span> 10.6 Reentrant Functions</h4>
<div class="outline-text-4" id="text-orgedf77d8">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 66: </span>Figure 10.5 Call a nonreentrant function from a signal handler</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pwd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_alarm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">passwd</span> *<span style="color: #7590db;">rootptr</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in signal hander\n"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>rootptr = getpwnam<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"hello"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getpwnam(root) error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">passwd</span> *<span style="color: #7590db;">ptr</span>;
    signal<span style="color: #bc6ec5;">(</span>SIGALRM, my_alarm<span style="color: #bc6ec5;">)</span>;
    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">usleep(500);                  // it seems alarm cannot interrupt sleep</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">function</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ptr = getpwnam<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"zhoush"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"getpwnam error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>strcmp<span style="color: #67b11d;">(</span>ptr-&gt;pw_name, <span style="color: #2d9574;">"zhoush"</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"return value corrupted!, pw_name = %s\n"</span>, ptr-&gt;pw_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org72887f7" class="outline-4">
<h4 id="org72887f7"><span class="done DONE">DONE</span> 10.7 <code>SIGCLD</code> Semantics</h4>
<div class="outline-text-4" id="text-org72887f7">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 67: </span>Figure 10.6 System V SIGCLD handler that doesn't work</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_cld</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>__linux__<span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGCLD, sig_cld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    pause<span style="color: #bc6ec5;">()</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_cld</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">interrupts pause()</span>

    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">status</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIGCLD received\n"</span><span style="color: #bc6ec5;">)</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #bc6ec5;">(</span>__linux__<span style="color: #bc6ec5;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGCLD, sig_cld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal erro"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = wait<span style="color: #67b11d;">(</span>&amp;status<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        perror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"wait error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"pid = %d\n"</span>, pid<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb76e5e0" class="outline-4">
<h4 id="orgb76e5e0"><span class="done DONE">DONE</span> 10.8 Reliable-Signal Terminology and Semantics</h4>
<div class="outline-text-4" id="text-orgb76e5e0">
<blockquote>
<p>
If the system delivers the signal more than once, we say that the signals are queued. <br />
<b>Most UNIX systems do <i>not</i> queue signals unless they support the real-time extensions to POSIX.1.</b> <br />
POSIX.1 <b>does not specify the order</b> in which the signals are delivered to the process more than once.
</p>
</blockquote>

<ul class="org-ul">
<li><i>signal mask</i>: a set of signals currently blocked from delivery to the process (<b>on</b> is blocked)</li>
<li><i><code>sigprocmask</code></i>: examine and change its current signal mask</li>
</ul>
</div>
</div>
<div id="outline-container-orgb8b37c2" class="outline-4">
<h4 id="orgb8b37c2"><span class="done DONE">DONE</span> 10.9 <code>kill</code> and <code>raise</code> Functions</h4>
<div class="outline-text-4" id="text-orgb8b37c2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">kill</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">raise</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>

<p>
<code>raise(signo);</code> is equivalent to <code>kill(getpid(), signo);</code>
</p>
</div>
</div>

<div id="outline-container-org9b763fa" class="outline-4">
<h4 id="org9b763fa"><span class="done DONE">DONE</span> 10.10 <code>alarm</code> and <code>pause</code> Functions</h4>
<div class="outline-text-4" id="text-org9b763fa">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">alarm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 or number of seconds until previously set alarm</span>
</pre>
</div>

<blockquote>
<p>

</p>

<p>
There is only one of these alarm clocks per process. If, when we call alarm, a previously registered alarm clock for the process has not yet expired, the number of seconds left for that alarm clock is returned as the value of this function.
</p>

<p>
If a previously registered alarm clock for the process has not yet expired and if the seconds value is 0, the previous alarm clock is canceled.
</p>

<p>
If we call alarm first and are sent SIGALRM before we can install the signal handler, our process will terminate
</p>
</blockquote>


<p>
suspends the calling process until a signal is caught
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pause</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: -1 with errno set to EINTR</span>
</pre>
</div>


<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 68: </span>Figure 10.7 Simple, incomplete implementation of sleep</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">nothing to do , just return to wake up the pause;</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    alarm<span style="color: #bc6ec5;">(</span>seconds<span style="color: #bc6ec5;">)</span>;     <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">start timer</span>
    pause<span style="color: #bc6ec5;">()</span>;            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">caught signal wake up</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>alarm<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">turn off timer, return unslept time</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 69: </span>Figure 10.8 Another (imperfect) implementation of sleep</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">jmp_buf</span> <span style="color: #7590db;">env_alrm</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> longjmp<span style="color: #bc6ec5;">(</span>env_alrm, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setjmp<span style="color: #2d9574;">(</span>env_alrm<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        alarm<span style="color: #2d9574;">(</span>seconds<span style="color: #2d9574;">)</span>;
        pause<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 70: </span>Figure 10.9 Calling sleep2 from a program that catches other signals</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>  <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">unslept</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    unslept = sleep2<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sleep2 returned: %u\n"</span>, unslept<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>          <span style="color: #7590db;">i</span>, <span style="color: #7590db;">j</span>;
    <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">k</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\nsig_int starting\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; <span style="color: #a45bad;">3000000</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>j = <span style="color: #a45bad;">0</span>; j &lt; <span style="color: #a45bad;">40000</span>; ++j<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            k += i * j;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sig_int finished"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 71: </span>Figure 10.10 Calling <code>read</code> with a timeout</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.10.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-26</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    calling read() with timeout</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  @bug race condition between first call to alarm() and read()</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  @bug if system are automatically restarted, the read is not interrupted</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    write<span style="color: #bc6ec5;">(</span>STDOUT_FILENO, line, n<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{}</span>
</pre>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 72: </span>Figure 10.11 Calling <code>read</code> with a timeout, using longjmp</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.11.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-26</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    calling read with a timeout, using longjmp</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>    <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">jmp_buf</span> <span style="color: #7590db;">env_alrm</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">line</span><span style="color: #bc6ec5;">[</span>MAXLINE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>setjmp<span style="color: #2d9574;">(</span>env_alrm<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read timeout"</span><span style="color: #bc6ec5;">)</span>;

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">10</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, line, MAXLINE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #bc6ec5;">)</span>;

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    write<span style="color: #bc6ec5;">(</span>STDOUT_FILENO, line, n<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> longjmp<span style="color: #bc6ec5;">(</span>env_alrm, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org8c0acb1" class="outline-4">
<h4 id="org8c0acb1"><span class="done DONE">DONE</span> 10.11 Signal Sets</h4>
<div class="outline-text-4" id="text-org8c0acb1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigemptyset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigfillset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigaddset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigdelset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">All four returns: 0 if OK, -1 on error</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigismember</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 1 if true, 0 if false, -1 on error</span>
</pre>
</div>

<p>
Implementation:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">sigemptyset</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span>  <span style="color: #4f97d7;">(</span>*<span style="color: #bc6ec5;">(</span>ptr<span style="color: #bc6ec5;">)</span> = <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">sigfillset</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">ptr</span><span style="color: #4f97d7;">)</span>   <span style="color: #4f97d7;">(</span>*<span style="color: #bc6ec5;">(</span>ptr<span style="color: #bc6ec5;">)</span> = ~<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span><span style="color: #bc6ec5;">)</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
<p>
<code>sigfillset</code> returns value after the comma (value: 0)
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.12.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-26</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    implementations</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  An implementation of sigaddset(), sigdelset(), sigismember()</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * &lt;signal.h&gt; usually defines NSIG to include signal number 0.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">SIGBAD</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">signao</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>signo<span style="color: #bc6ec5;">)</span> &lt;= <span style="color: #a45bad;">0</span> || <span style="color: #bc6ec5;">(</span>signo<span style="color: #bc6ec5;">)</span> &gt;= NSIG<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">my_sigaddset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    *set |= <span style="color: #a45bad;">1</span> &lt;&lt; <span style="color: #bc6ec5;">(</span>signo - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">turn bit on</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">my_sigdelset</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    *set &amp;= ~<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span> &lt;&lt; <span style="color: #2d9574;">(</span>signo - <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">turn bit off</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">my_sigismember</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>SIGBAD<span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = EINVAL;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>*set &amp; <span style="color: #67b11d;">(</span><span style="color: #a45bad;">1</span> &lt;&lt; <span style="color: #b1951d;">(</span>signo - <span style="color: #a45bad;">1</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6db2879" class="outline-4">
<h4 id="org6db2879"><span class="done DONE">DONE</span> 10.12 <code>sigprocmask</code> Function</h4>
<div class="outline-text-4" id="text-org6db2879">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigprocmask</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">how</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">oset</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Figure 10.13 Ways to change the current signal mask using sigprocmask</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">how</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>SIG_BLOCK</code></td>
<td class="org-left"><i>set</i> contains the additional signals that we want to block.</td>
</tr>

<tr>
<td class="org-left"><code>SIG_UNBLOCK</code></td>
<td class="org-left"><i>set</i> contains the signals that we want to unblock</td>
</tr>

<tr>
<td class="org-left"><code>SIG_SETMASK</code></td>
<td class="org-left">new signal mask replaced by the signal set pointed to by <i>set</i></td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 73: </span>Figure 10.14 Print the signal mask for the process</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.14.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-27</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Print the signal mask for the process</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   shows a function that prints the names of the signals in the signal mask of</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * the calling process.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_mask</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">sigset</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>      <span style="color: #7590db;">errno_save</span>;

    errno_save = errno;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">we can be canceld by signal handlers</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, &amp;sigset<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"sigprocmask error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s"</span>, str<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGINT<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGINT"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGQUIT<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGQUIT"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGUSR1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGUSR1"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>sigismember<span style="color: #67b11d;">(</span>&amp;sigset, SIGALRM<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">" SIGGALRM"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    errno = errno_save;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org17cee4c" class="outline-4">
<h4 id="org17cee4c"><span class="done DONE">DONE</span> 10.13 <code>sigpending</code> Function</h4>
<div class="outline-text-4" id="text-org17cee4c">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigpending</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">set</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 74: </span>Example of signal sets and sigprocmask</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pwd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">my_alarm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">passwd</span> *<span style="color: #7590db;">rootptr</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in signal hander\n"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>rootptr = getpwnam<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"hello"</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"getpwnam(root) error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">passwd</span> *<span style="color: #7590db;">ptr</span>;
    signal<span style="color: #bc6ec5;">(</span>SIGALRM, my_alarm<span style="color: #bc6ec5;">)</span>;
    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">usleep(500);                  // it seems alarm cannot interrupt sleep</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">function</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ptr = getpwnam<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"zhoush"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"getpwnam error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>strcmp<span style="color: #67b11d;">(</span>ptr-&gt;pw_name, <span style="color: #2d9574;">"zhoush"</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"return value corrupted!, pw_name = %s\n"</span>, ptr-&gt;pw_name<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org9b86ebb" class="outline-4">
<h4 id="org9b86ebb"><span class="done DONE">DONE</span> 10.14 <code>sigaction</code> Function</h4>
<div class="outline-text-4" id="text-org9b86ebb">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigaction</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">act</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span>* <span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">oact</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*sa_handler<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #bc6ec5;">)</span>;       <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">addr of signal handler or SIG_IGN or SIG_DFL</span>

    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">sa_mask</span>;               <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">addtional signals to block</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sa_flags</span>;                   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">signal options, Figure 10.16</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">alternate handler</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*sa_action<span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">int</span>, <span style="color: #ce537a; font-weight: bold;">siginfo_t</span> *, <span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Figure 10.16 Option flags (sa_flags) for the handling of each signal</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Option</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD</th>
<th scope="col" class="org-left">Linux</th>
<th scope="col" class="org-left">Mac OSX</th>
<th scope="col" class="org-left">Solaris</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">SA_INTERRUPT</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">system call interrupted by this signal are not automatically restarted</td>
</tr>

<tr>
<td class="org-left">SA_NOCLDSTOP</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">SIGCHLD do not generate signal when a child process stops(job control).</td>
</tr>

<tr>
<td class="org-left">SA_NOCLDWAIT</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">SIGCHLD prevents the system call from creating process zombie processes</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">when children of the calling process terminate.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">if the subsequently calls wait, the calling process blocks until all</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">its child processes have terminated and then returns -1 when errno set to ECHILD</td>
</tr>

<tr>
<td class="org-left">SA_NODEFER</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">signal is not automatically blocked by the system while the signao-catching function executes</td>
</tr>

<tr>
<td class="org-left">SA_ONSTACK</td>
<td class="org-left">XSI</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">if an alternative stack has been declared with <code>signalstack</code><sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></td>
</tr>

<tr>
<td class="org-left">SA_RESETHAND</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">the disposition for this signal is reset to SIG_DFL, and the SA_SIGINFO flag is cleared</td>
</tr>

<tr>
<td class="org-left">SA_RESTART</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">system calls interrupted by this signal are automatically restarted</td>
</tr>

<tr>
<td class="org-left">SA_SIGINFO</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">provides additional information to a signal hander</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">normal signal handler</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">handler</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if SA_SIGINFO flag is set</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">handler</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">siginfo_t</span> *<span style="color: #7590db;">info</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">context</span><span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">siginfo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">si_signo</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">signal number</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">si_errno</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if nonzero, errno value from errno.h</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">si_code</span>;           <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">additional info (depends on signal)</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">si_pid</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sending process ID</span>
    <span style="color: #ce537a; font-weight: bold;">uid_t</span> <span style="color: #7590db;">si_uid</span>;          <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">sending process real user ID</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">si_addr</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">address that caused the fault</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">si_status</span>;         <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">exit value or signal number</span>
    <span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">sigval</span> <span style="color: #7590db;">si_value</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">application-specific value</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">possibly other fields also</span>
<span style="color: #4f97d7;">}</span>;
<span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">sigval</span> <span style="color: #4f97d7;">{</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">sival_int</span>; <span style="color: #ce537a; font-weight: bold;">void</span>* <span style="color: #7590db;">sival_ptr</span>; <span style="color: #4f97d7;">}</span>;

</pre>
</div>


<p>
<code>man sigaction</code> (linux)for details
</p>

<ul class="org-ul">
<li><p>
Example - <code>signal</code> function
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 75: </span>Figure 10.18 An implementation of signal using sigaction</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.18.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-27</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    An implementation of signal using sigaction</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Reliable version of signal(), using POSIX sigaction().</span>

<span style="color: #ce537a; font-weight: bold;">Sigfunc</span> *<span style="color: #bc6ec5; font-weight: bold;">signal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">Sigfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">act</span>, <span style="color: #7590db;">oact</span>;

    act.sa_handler = func;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;act.sa_mask<span style="color: #bc6ec5;">)</span>;
    act.sa_flags = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGALRM<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #2d9574;">(</span>SA_INTERRUPT<span style="color: #2d9574;">)</span>
        act.sa_flags |= SA_INTERRUPT;
<span style="color: #bc6ec5;">#endif</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        act.sa_flags |= SA_RESTART;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>signo, &amp;act, &amp;oact<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> SIG_ERR;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> oact.sa_handler;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example - <code>signal_intr</code> function
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 76: </span>Figure 10.19 The signal_intr function</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.19.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-27</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    The signal_intr function</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   tries to prevent any interrupted system calls from being restarted.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">Sigfunc</span> *<span style="color: #bc6ec5; font-weight: bold;">signal_intr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">Sigfunc</span> *<span style="color: #7590db;">func</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">act</span>, <span style="color: #7590db;">oact</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>             <span style="color: #7590db;">signame</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">32</span><span style="color: #bc6ec5;">]</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;

    psignal<span style="color: #bc6ec5;">(</span>signo, signame<span style="color: #bc6ec5;">)</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s is caught\n"</span>, signame<span style="color: #bc6ec5;">)</span>;

    act.sa_handler = func;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;act.sa_mask<span style="color: #bc6ec5;">)</span>;
    act.sa_flags = <span style="color: #a45bad;">0</span>;
<span style="color: #bc6ec5;">#ifdef</span> SA_INTERRUPT
    act.sa_flags |= SA_INTERRUPT;
<span style="color: #bc6ec5;">#endif</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>signo, &amp;act, &amp;oact<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> SIG_ERR;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>oact.sa_handler<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org8791d50" class="outline-4">
<h4 id="org8791d50"><span class="done DONE">DONE</span> 10.15 <code>sigsetjmp</code> and <code>siglongjmp</code> Functions</h4>
<div class="outline-text-4" id="text-org8791d50">
<p>
These two functions should always be used when branching from a signal handler.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigsetjmp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigjmp_buf</span> <span style="color: #7590db;">env</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">savemask</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if called directly, nonzero if returning from a call to siglongjmp</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">siglongjmp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">sigjmp_buf</span> <span style="color: #7590db;">env</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>


<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 77: </span>Figure 10.20 Example of signal masks, sigsetjmp, and siglongjmp</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.20.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Figure 10.20 Example of signal masks, sigsetjmp, and siglongjmp</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">setjmp.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>                  <span style="color: #bc6ec5; font-weight: bold;">sig_usr1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>                  <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">sigjmp_buf</span>            <span style="color: #7590db;">jmpbuf</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">sig_atomic_t</span> <span style="color: #7590db;">canjump</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr1<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGUSR1) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGALRM, sig_alrm<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGALRM) error"</span><span style="color: #bc6ec5;">)</span>;

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"starting main: "</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Figure 10.14</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigsetjmp<span style="color: #2d9574;">(</span>jmpbuf, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pr_mask<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"ending main: "</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    canjump = <span style="color: #a45bad;">1</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> pause<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_usr1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">time_t</span> <span style="color: #7590db;">starttime</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>canjump == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span>;
    <span style="color: #bc6ec5;">}</span>

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"starting sig_usr1: "</span><span style="color: #bc6ec5;">)</span>;

    alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span>;
    starttime = time<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>time<span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &gt; starttime + <span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">break</span>;

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"finishing sig_usr1: "</span><span style="color: #bc6ec5;">)</span>;

    canjump = <span style="color: #a45bad;">0</span>;
    siglongjmp<span style="color: #bc6ec5;">(</span>jmpbuf, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">jump back to main, don't return</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in sig_alrm: "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div>

<blockquote>
<p>
If we change the program in Figure 10.20 so that the calls to sigsetjmp and siglongjmp are replaced with calls to setjmp and longjmp on Linux (or _setjmp and _longjmp on FreeBSD), the final line of output becomes
</p>

<p>
ending main: SIGUSR1
</p>

<p>
This means that the main function is executing with the SIGUSR1 signal blocked, after the call to setjmp.
</p>
</blockquote></li>
</ul>
</div>
</div>

<div id="outline-container-org04b4e26" class="outline-4">
<h4 id="org04b4e26"><span class="done DONE">DONE</span> 10.16 <code>sigsuspend</code> Function</h4>
<div class="outline-text-4" id="text-org04b4e26">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigsuspend</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #7590db;">sigmask</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: &#8722;1 with errno set to EINTR</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 78: </span>Figure 10.22 Protecting a critical region from a signal</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.22.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Protecting a critical region from a signal</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   the correct way to protect a critical region of code from a speci&#64257;c signal.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">newmask</span>, <span style="color: #7590db;">oldmask</span>, <span style="color: #7590db;">waitmask</span>;

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"program start: "</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;waitmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;waitmask, SIGUSR1<span style="color: #bc6ec5;">)</span>;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGINT<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">block SIGINT and save current signal mask</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">critical region of code</span>
    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"in critical region: "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">pause, allowing all signals except SIGUSR1</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigsuspend<span style="color: #2d9574;">(</span>&amp;waitmask<span style="color: #2d9574;">)</span> != -<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sigsuspend error"</span><span style="color: #bc6ec5;">)</span>;

    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"after return from sigsuspend"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">reset signal mask which unblock SIGINT</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">and continue processing...</span>
    pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"program exit: "</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\nin sig_int: "</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 79: </span>Figure 10.23 Using sigsuspend to wait for a global variable to be set</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.23.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    wait for a signal handler to set a global variable</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  catch both the interrupt signal and the quit signal,</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  but want to wake up the main routine only when the quit signal is caught.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">sig_atomic_t</span> <span style="color: #7590db;">quitflag</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">one signal handler for SIGINT and SIGQUIT</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGINT<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\ninterrupt\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo == SIGQUIT<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        quitflag = <span style="color: #a45bad;">1</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">set flag for main loop</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">newmask</span>, <span style="color: #7590db;">oldmask</span>, <span style="color: #7590db;">zeromask</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGQUIT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGQUIT) error"</span><span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGQUIT<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">block SIGQUIT and save current signal mask.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>quitflag == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> sigsuspend<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;

    quitflag = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 80: </span>Figure 10.24 Routines to allow a parent and child to synchronize</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.24.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Routines to allow a parent and child to synchronize</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  show how signals can be used to synchronize a parent and child.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #4f97d7; font-weight: bold;">volatile</span> <span style="color: #ce537a; font-weight: bold;">sig_atomic_t</span> <span style="color: #7590db;">sigflag</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">set nonzero by sig handler</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span>              <span style="color: #7590db;">newmask</span>, <span style="color: #7590db;">oldmask</span>, <span style="color: #7590db;">zeromask</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">one signal handler for SIGUSR1 and SIGUSR2</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_usr</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> sigflag = <span style="color: #a45bad;">1</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_WAIT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR1, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGUSR1) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGUSR2, sig_usr<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGUSR2) error"</span><span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGUSR1<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGUSR2<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">block SIGUSR1 and SIGUSR2, and save current signal mask</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_PARENT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> kill<span style="color: #bc6ec5;">(</span>pid, SIGUSR2<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">WAIT_PARENT</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>sigflag == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> sigsuspend<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;

    sigflag = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">TELL_CHILD</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> kill<span style="color: #bc6ec5;">(</span>pid, SIGUSR1<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">WAIT_CHILD</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>sigflag == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> sigsuspend<span style="color: #bc6ec5;">(</span>&amp;zeromask<span style="color: #bc6ec5;">)</span>;
    sigflag = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<blockquote>
<ol class="org-ol">
<li>Block SIGINT and SIGALRM.</li>

<li>Test the two global variables to see whether either signal has occurred and, if so, handle the condition.</li>

<li>Call read (or any other system function) and unblock the two signals, as an atomic operation.</li>
</ol>

<p>
The sigsuspend function helps us only if step 3 is a pause operation.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orga824d93" class="outline-4">
<h4 id="orga824d93"><span class="done DONE">DONE</span> 10.17 <code>abort</code> Function</h4>
<div class="outline-text-4" id="text-orga824d93">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">abort</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 81: </span>Figure 10.25 Implementation of POSIX.1 <code>abort</code></label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.25.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Implementation of POSIX.1 abort</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">POSIX-style abort() function</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">abort</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>         <span style="color: #7590db;">mask</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">action</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">caller can't ignore SIGABRT, if so reset to defautl</span>
    sigaction<span style="color: #bc6ec5;">(</span>SIGABRT, <span style="color: #a45bad;">NULL</span>, &amp;action<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>action.sa_handler == SIG_IGN<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        action.sa_handler = SIG_DFL;
        sigaction<span style="color: #2d9574;">(</span>SIGABRT, &amp;action, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>action.sa_handler == SIG_DFL<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fflush<span style="color: #2d9574;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">flush all open stdio streams</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">caller can't block SIGABRT; make sure it's unblocked</span>
    sigfillset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    sigdelset<span style="color: #bc6ec5;">(</span>&amp;mask, SIGABRT<span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_SETMASK, &amp;mask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGABRT<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">if we're here, process caught SIGABRT and returned</span>
    fflush<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    action.sa_handler = SIG_DFL;
    sigaction<span style="color: #bc6ec5;">(</span>SIG_DFL, &amp;action, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_SETMASK, &amp;mask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGABRT<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8eabc0c" class="outline-4">
<h4 id="org8eabc0c"><span class="done DONE">DONE</span> 10.18 <code>system</code> Function</h4>
<div class="outline-text-4" id="text-org8eabc0c">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 82: </span>Figure 10.26 Using <code>system</code> to invoke the <code>ed</code> editor</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.26.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Using system to invoke the ed editor</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_int</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"caught SIGINT\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_chld</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"caught SIGCHLD\n"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGINT, sig_int<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGINT) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGCHLD, sig_chld<span style="color: #2d9574;">)</span> == SIG_ERR<span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"signal(SIGCHLD) error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>system<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/ed"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system() error"</span><span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>


<div class="figure">
<p><img src="Chapter10/fig10.27.png" alt="fig10.27.png" />
</p>
<p><span class="figure-number">Figure 5: </span>Figure 10.27 Foreground and background process groups for Figure 10.26</p>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 83: </span>Figure 10.28 Correct POSIX.1 implementation of <code>system</code> function</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.28.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Correct POSIX.1 implementation of system function</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  implementation of the system function with the required signal handling</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">with appropriate signal handling</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">system</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmdstring</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>            <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">status</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">ignore</span>, <span style="color: #7590db;">saveintr</span>, <span style="color: #7590db;">savequit</span>;
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>         <span style="color: #7590db;">chldmask</span>, <span style="color: #7590db;">savemask</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cmdstring == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">always a command processor with UNIX</span>
    <span style="color: #bc6ec5;">}</span>

    ignore.sa_handler = SIG_IGN;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;ignore.sa_mask<span style="color: #bc6ec5;">)</span>;
    ignore.sa_flags = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;ignore, &amp;saveintr<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;ignore, &amp;savequit<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;chldmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;chldmask, SIGCHLD<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_BLOCK, &amp;chldmask, &amp;savemask<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        status = -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">restore previous signal actions &amp; reset signal mask</span>
        sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;saveintr, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
        sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;savequit, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
        sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;savemask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;

        execl<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/bin/sh"</span>, <span style="color: #2d9574;">"sh"</span>, <span style="color: #2d9574;">"-c"</span>, cmdstring, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        _exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">127</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">exec error</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, &amp;status, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>errno != EINTR<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                status = -<span style="color: #a45bad;">1</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">error other than EINTR from waitpid()</span>
                <span style="color: #4f97d7; font-weight: bold;">break</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">restore previous signal actions &amp; reset signal mask</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGINT, &amp;saveintr, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGQUIT, &amp;savequit, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;savemask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>status<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org63a32ec" class="outline-4">
<h4 id="org63a32ec"><span class="done DONE">DONE</span> 10.19 <code>sleep</code>, <code>nanaosleep</code>, and <code>clock_nanosleep</code> Functions</h4>
<div class="outline-text-4" id="text-org63a32ec">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 or number of unslept seconds</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 84: </span>Figure 10.29 Reliable implementation of <code>sleep</code></label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     10.29.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Implementation of the POSIX.1 sleep function</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  modification of figure 10.17, hands signals reliably</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  avoiding the race condition in the earlier implementation</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_alrm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">nothing to do, just return wakes up sigsuspend()</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">newact</span>, <span style="color: #7590db;">oldact</span>;
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>         <span style="color: #7590db;">newmask</span>, <span style="color: #7590db;">oldmask</span>, <span style="color: #7590db;">suspmask</span>;
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span>     <span style="color: #7590db;">unslept</span>;

    newact.sa_handler = sig_alrm;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newact.sa_mask<span style="color: #bc6ec5;">)</span>;
    newact.sa_flags = <span style="color: #a45bad;">0</span>;
    sigaction<span style="color: #bc6ec5;">(</span>SIGALRM, &amp;newact, &amp;oldact<span style="color: #bc6ec5;">)</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;newmask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;newmask, SIGALRM<span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_BLOCK, &amp;newmask, &amp;oldmask<span style="color: #bc6ec5;">)</span>;

    alarm<span style="color: #bc6ec5;">(</span>seconds<span style="color: #bc6ec5;">)</span>;
    suspmask = oldmask;

    sigdelset<span style="color: #bc6ec5;">(</span>&amp;suspmask, SIGALRM<span style="color: #bc6ec5;">)</span>;

    sigsuspend<span style="color: #bc6ec5;">(</span>&amp;suspmask<span style="color: #bc6ec5;">)</span>;

    unslept = alarm<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    sigaction<span style="color: #bc6ec5;">(</span>SIGALRM, &amp;oldact, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>unslept<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">clock_nanosleep</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">clockid_t</span> <span style="color: #7590db;">clock_id</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span>,
                    <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span>* <span style="color: #7590db;">reqtp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span>* <span style="color: #7590db;">remtp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if slept for requested time or error number on failue</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org985ca96" class="outline-4">
<h4 id="org985ca96"><span class="done DONE">DONE</span> 10.20 <code>sigqueue</code> Function</h4>
<div class="outline-text-4" id="text-org985ca96">
<ul class="org-ul">
<li>Specify the SA_SIGINFO flag when we install a signal handler using the sigaction function</li>
<li>Provide a signal handler in the sa_sigaction member of the sigaction structure instead of using the usual sa_handler field.</li>
<li><p>
Use the sigqueue function to send signals.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigqueue</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">union</span> <span style="color: #ce537a; font-weight: bold;">sigval</span> <span style="color: #7590db;">value</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, -1 on error</span>
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Figure 10.30 Behavior of queued signals on various platforms</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Behavior</th>
<th scope="col" class="org-left">SUS</th>
<th scope="col" class="org-left">FreeBSD8.0</th>
<th scope="col" class="org-left">Linux3.2.0</th>
<th scope="col" class="org-left">Mac OSX</th>
<th scope="col" class="org-left">Solaris</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">supports sigqueue</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">queues other signals besides SIGRTMIN to SIGRTMAX</td>
<td class="org-left">optional</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">*</td>
</tr>

<tr>
<td class="org-left">queues signals even if the caller don't use the SA_SIGINFO flags</td>
<td class="org-left">optional</td>
<td class="org-left">*</td>
<td class="org-left">*</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table></li>
</ul>
</div>
</div>

<div id="outline-container-org8599eea" class="outline-4">
<h4 id="org8599eea"><span class="done DONE">DONE</span> 10.21 Job-Control Signals</h4>
<div class="outline-text-4" id="text-org8599eea">
<p>
job-control signals:
SIGCHLD   Child process has stopped or terminated
SIGCONT   Continue process, if stopped.
SIGSTOP   Stop signal(can't caught or ignored)
SIGTSTP   Interactive stop signal.
SIGTTIN   Read from controlling terminately by background process group number
SIGTTOU   Write to controlling terminal by a background process group member
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 85: </span>Figure 10.31 How to handle SIGTSTP</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.31.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    How to handle SIGTSTP</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFFSIZE</span> <span style="color: #a45bad;">1024</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">signal handler to SIGTSTP</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sig_tstp</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">mask</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;mask, SIGTSTP<span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_UNBLOCK, &amp;mask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    signal<span style="color: #bc6ec5;">(</span>SIGTSTP, SIG_DFL<span style="color: #bc6ec5;">)</span>;
    kill<span style="color: #bc6ec5;">(</span>getpid<span style="color: #2d9574;">()</span>, SIGTSTP<span style="color: #bc6ec5;">)</span>;

    signal<span style="color: #bc6ec5;">(</span>SIGTSTP, sig_tstp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFFSIZE<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signal<span style="color: #2d9574;">(</span>SIGTSTP, SIG_IGN<span style="color: #2d9574;">)</span> == SIG_DFL<span style="color: #bc6ec5;">)</span> signal<span style="color: #bc6ec5;">(</span>SIGTSTP, sig_tstp<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>STDIN_FILENO, buf, BUFFSIZE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>STDOUT_FILENO, buf, n<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> err_sys<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org0e361d0" class="outline-4">
<h4 id="org0e361d0"><span class="done DONE">DONE</span> 10.22 Signal Names and Numbers</h4>
<div class="outline-text-4" id="text-org0e361d0">
<p>
map between signal numbers and names.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">sys_siglist</span><span style="color: #4f97d7;">[]</span>;
</pre>
</div>

<p>
in a portable manner
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">psignal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">msg</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
print signal information
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">psiginfo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">siginfo_t</span>* <span style="color: #7590db;">info</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">msg</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
string description of the signal and don't necessarily wnat to write it to standard error
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">strsignal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: a pointer to a string describing the signal</span>
</pre>
</div>

<p>
<b>Solaris provides</b>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sig2str</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">str2sig</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">signop</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, -1 on error</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe09aea" class="outline-4">
<h4 id="orgbe09aea"><span class="done DONE">DONE</span> 10.23 Summary</h4>
<div class="outline-text-4" id="text-orgbe09aea">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
10.1
</p>
<blockquote>
<p>
terminates the first time
<code>pause</code> until a signal is received from either the kill(2) function or an interval timer
</p>
</blockquote></li>
<li><p>
10.2
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     ex10.2.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    example code for 10.2</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sig2str</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo &lt;= <span style="color: #a45bad;">0</span> || signo &gt;= NSIG<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    snprintf<span style="color: #bc6ec5;">(</span>str, SIG2STR_MAX, <span style="color: #2d9574;">"%s"</span>, sys_siglist<span style="color: #2d9574;">[</span>signo<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li>10.3
<a href="Chapter10/ex10.3.png"><img src="file:///Users/zhoush/Documents/Notes/books/system/APUE/Chapter10/ex10.3.png" alt="ex10.3.png" /></a></li>
<li>10.4
race condition between first call <code>alarm</code> and <code>setjmp</code></li>
<li>10.5
<a href="http://www.kohala.com/start/libes.timers.txt">www.kohala.com/start/libes.timers.txt</a></li>
<li><p>
10.6
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     exx10.6.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-29</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    test figure 10.24</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span> = fopen<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"a.txt"</span>, <span style="color: #2d9574;">"w+"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">num</span> = <span style="color: #a45bad;">0</span>;

    fwrite<span style="color: #bc6ec5;">(</span>&amp;num, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>num<span style="color: #2d9574;">)</span>, <span style="color: #a45bad;">1</span>, fp<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span> = fork<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">fread(&amp;num, sizeof(num), 1, fp);</span>
        ++num;
        fwrite<span style="color: #2d9574;">(</span>&amp;num, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>num<span style="color: #67b11d;">)</span>, <span style="color: #a45bad;">1</span>, fp<span style="color: #2d9574;">)</span>;
        fprintf<span style="color: #2d9574;">(</span>stdout, <span style="color: #2d9574;">"child process: %d\n"</span>, num<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_SUCCESS<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">fread(&amp;num, sizeof(num), 1, fp);</span>
    ++num;
    fwrite<span style="color: #bc6ec5;">(</span>&amp;num, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>num<span style="color: #2d9574;">)</span>, <span style="color: #a45bad;">1</span>, fp<span style="color: #bc6ec5;">)</span>;
    fprintf<span style="color: #bc6ec5;">(</span>stdout, <span style="color: #2d9574;">"parent process: %d\n"</span>, num<span style="color: #bc6ec5;">)</span>;

    fclose<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
10.7
</p>
<blockquote>
<p>
the termination status of the process would not show that it was terminated by the SIGABRT signal.
</p>
</blockquote></li>
<li><p>
10.8
</p>
<blockquote>
<p>
If the signal was sent by a process owned by some other user, the process has to be set-user-ID to either root or to the owner of the receiving process, or the kill attempt won’t work. Therefore, the real user ID provides more information to the receiver of the signal.
</p>
</blockquote></li>
<li><p>
10.9
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig10.14.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-27</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Print the signal mask for the process</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   shows a function that prints the names of the signals in the signal mask of</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * the calling process.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> NSIG
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NSIG</span> <span style="color: #a45bad;">32</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pr_mask</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">sigset</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>      <span style="color: #7590db;">errno_save</span>;

    errno_save = errno;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">we can be canceld by signal handlers</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, &amp;sigset<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"sigprocmask error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s"</span>, str<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span> = <span style="color: #a45bad;">1</span>; signo &lt; NSIG; ++signo<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>sigismember<span style="color: #b1951d;">(</span>&amp;sigset, signo<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"%s "</span>, strdup<span style="color: #4f97d7;">(</span>strsignal<span style="color: #bc6ec5;">(</span>signo<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span><span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>

        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    errno = errno_save;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span> pr_mask<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"starting main"</span><span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
10.10
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     ex10.10.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-03</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">spawn.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">log_to_stderr</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">cron</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    log_to_stderr = <span style="color: #a45bad;">0</span>;
    log_open<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"ex10.10"</span>, <span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = <span style="color: #a45bad;">0</span>;; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>i % <span style="color: #a45bad;">5</span> == <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #ce537a; font-weight: bold;">time_t</span>    <span style="color: #7590db;">t</span>  = time<span style="color: #67b11d;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tm</span> <span style="color: #7590db;">st</span> = <span style="color: #67b11d;">{}</span>;

            localtime_r<span style="color: #67b11d;">(</span>&amp;t, &amp;st<span style="color: #67b11d;">)</span>;
            log_msg<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"time_of day: %02d:%02d:%02d"</span>, st.tm_hour, st.tm_min,
                    st.tm_sec<span style="color: #67b11d;">)</span>;
            log_msg<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"tm_sec: %d"</span>, st.tm_sec<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        sleep<span style="color: #2d9574;">(</span><span style="color: #a45bad;">60</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span>, <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">env</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span> = <span style="color: #a45bad;">0</span>;
    daemonize<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;
    cron<span style="color: #bc6ec5;">()</span>;
    exit<span style="color: #bc6ec5;">(</span>EXIT_SUCCESS<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
10.11
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">BUFFSIZ</span> <span style="color: #a45bad;">10</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">ret</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>BUFFSIZ<span style="color: #bc6ec5;">]</span>;

    signal<span style="color: #bc6ec5;">(</span>SIGXFSZ, signal_intr<span style="color: #bc6ec5;">)</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">in</span>  = open<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, O_RDONLY<span style="color: #bc6ec5;">)</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">out</span> = open<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span>, O_CREAT | O_RDWR, <span style="color: #a45bad;">0644</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span> <span style="color: #7590db;">r</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;
    r.rlim_max      = <span style="color: #a45bad;">12</span>;
    setrlimit<span style="color: #bc6ec5;">(</span>RLIMIT_FSIZE, &amp;r<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>n = read<span style="color: #67b11d;">(</span>in, buf, BUFFSIZ<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>ret = write<span style="color: #b1951d;">(</span>out, buf, n<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != n<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">err_sys("write error: %d", ret);</span>
            printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"%d write\n"</span>, ret<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    close<span style="color: #bc6ec5;">(</span>in<span style="color: #bc6ec5;">)</span>;
    close<span style="color: #bc6ec5;">(</span>out<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
SIGXFSZ never caught
</p></li>
<li><p>
10.12
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     ex10.2.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    example code for 10.2</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sig2str</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">str</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>signo &lt;= <span style="color: #a45bad;">0</span> || signo &gt;= NSIG<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>
    snprintf<span style="color: #bc6ec5;">(</span>str, SIG2STR_MAX, <span style="color: #2d9574;">"%s"</span>, sys_siglist<span style="color: #2d9574;">[</span>signo<span style="color: #2d9574;">]</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
finished, alarm appears until fwrite finshied, it seems the kernel is blocking SIGALRM
</p></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgaa1df86" class="outline-3">
<h3 id="orgaa1df86"><span class="done DONE">DONE</span> Chapter 11. Threads <code>[7/7]</code></h3>
<div class="outline-text-3" id="text-orgaa1df86">
</div>
<div id="outline-container-org229ea1f" class="outline-4">
<h4 id="org229ea1f"><span class="done DONE">DONE</span> 11.1 Introduction</h4>
<div class="outline-text-4" id="text-org229ea1f">
</div>
</div>
<div id="outline-container-org8b78ddd" class="outline-4">
<h4 id="org8b78ddd"><span class="done DONE">DONE</span> 11.2 Thread Concepts</h4>
<div class="outline-text-4" id="text-org8b78ddd">
<p>
benefits
</p>
<ul class="org-ul">
<li>asynchronous</li>
<li>same memory address space and file descriptors</li>
<li>problem partition</li>
<li>seperate portions of the program</li>
</ul>
</div>
</div>
<div id="outline-container-orgd964f16" class="outline-4">
<h4 id="orgd964f16"><span class="done DONE">DONE</span> 11.3 Thread Identification</h4>
<div class="outline-text-4" id="text-orgd964f16">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_equal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid1</span>, <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid2</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: nonzero if equal, 0 otherwise</span>
</pre>
</div>

<p>
obtain its own thread ID :
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_self</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: the thread ID of the calling thread</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org80c82bf" class="outline-4">
<h4 id="org80c82bf"><span class="done DONE">DONE</span> 11.4 Thread Creation</h4>
<div class="outline-text-4" id="text-org80c82bf">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_create</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tidp</span>,
                   <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                   <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">start_rtn</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #bc6ec5;">)</span>,
                   <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 86: </span>Figure 11.2 Printing thread IDs</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">ntid</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">printids</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">s</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>     <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span>;

    pid = getpid<span style="color: #bc6ec5;">()</span>;
    tid = pthread_self<span style="color: #bc6ec5;">()</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s pid %lu tid %lu (0x%lx)\n"</span>, s, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pid,
           <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tid, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tid<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printids<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"new thread: "</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    pthread_create<span style="color: #bc6ec5;">(</span>&amp;ntid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't creat thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printids<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"main thread: "</span><span style="color: #bc6ec5;">)</span>;
    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org26bb898" class="outline-4">
<h4 id="org26bb898"><span class="done DONE">DONE</span> 11.5 Thread Termination</h4>
<div class="outline-text-4" id="text-org26bb898">
<ol class="org-ol">
<li>thread return from start routine.</li>
<li>can be canceled by another thread in the same process</li>
<li>can call <code>pthread_exit</code></li>
</ol>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_exit</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">rval_ptr</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_join</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">thread</span>, <span style="color: #ce537a; font-weight: bold;">void</span> **<span style="color: #7590db;">rval_ptr</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<blockquote>
<p>
The calling thread will block until the specified thread calls pthread_exit, returns from its start routine, or is canceled.
</p>
</blockquote>

<blockquote>
<p>
<b>The Linux Programming Language:</b>
If the main thread calls pthread_exit() instead of calling exit() or performing a return, then the other threads continue to execute.
</p>
</blockquote>
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 87: </span>Figure 11.3 Fetching the thread exit status</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 returning\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 returning\n"</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid1</span>, <span style="color: #7590db;">tid2</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *    <span style="color: #7590db;">tret</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid1, <span style="color: #a45bad;">NULL</span>, thr_fn1, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid2, <span style="color: #a45bad;">NULL</span>, thr_fn2, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread2"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_join<span style="color: #bc6ec5;">(</span>tid1, &amp;tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join thread1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #bc6ec5;">)</span>;
    err = pthread_join<span style="color: #bc6ec5;">(</span>tid2, &amp;tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join thread2"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 88: </span>Figure 11.4 Incorrect use of <code>pthread_exit</code> argument</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.4.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-05</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Figure 11.4</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  shows the problem with using an automatic variable (allocated on the stack)</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * as the argument to pthread_exit.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span>, <span style="color: #7590db;">c</span>, <span style="color: #7590db;">d</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">printfoo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">s</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s"</span>, s<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" structure at 0x%lx\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.a = %d\n"</span>, fp-&gt;a<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.b = %d\n"</span>, fp-&gt;b<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.c = %d\n"</span>, fp-&gt;c<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.d = %d\n"</span>, fp-&gt;d<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #7590db;">foo</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">2</span>, <span style="color: #a45bad;">3</span>, <span style="color: #a45bad;">4</span><span style="color: #bc6ec5;">}</span>;
    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1:\n"</span>, &amp;foo<span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>&amp;foo<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2: ID is %lu\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pthread_self<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>   <span style="color: #7590db;">tid1</span>, <span style="color: #7590db;">tid2</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid1, <span style="color: #a45bad;">NULL</span>, thr_fn1, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_join<span style="color: #bc6ec5;">(</span>tid1, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>&amp;fp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid2, <span style="color: #a45bad;">NULL</span>, thr_fn2, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent:\n"</span>, fp<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
the contents of the structure (allocated on the stack of thread tid1) have changed by the time the main thread can access the structure
</p>
</blockquote></li>
</ul>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cancel</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
in default circumstances, <code>pthread_exit</code> with <b>PTHREAD_CANCELD</b> <br />
doesn't wait for the thread to terminate; it merely makes the request. <br />
similar to <code>atexit</code> used by a process <br />
known as <i>thread cleanup handlers</i>
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cleanup_push</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">rtn</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cleanup_pop</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">execute</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<blockquote>
<p>
• Makes a call to pthread_exit
</p>

<p>
• Responds to a cancellation request
</p>

<p>
• Makes a call to pthread_cleanup_pop with a nonzero execute argument
</p>

<p>
If the execute argument is set to zero, the cleanup function is not called
</p>
</blockquote>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 89: </span>Figure 11.5 Thread cleanup handler</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.5.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-05</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    use thread cleanup handlers</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">cleanup</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"cleanup: %s\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #2d9574;">)</span>arg<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #875f00;">NOTE</span><span style="color: #2aa1ae; background-color: #292e34;">: return will be cuz segment fault here</span>
<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 start\n"</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_push<span style="color: #bc6ec5;">(</span>cleanup, <span style="color: #2d9574;">"thread 1 first handler"</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_push<span style="color: #bc6ec5;">(</span>cleanup, <span style="color: #2d9574;">"thread 1 second handler"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 push complete\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>arg<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return ((void *)1);</span>
        pthread_exit<span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_cleanup_pop<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_pop<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">return ((void *)1);</span>
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 start\n"</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_push<span style="color: #bc6ec5;">(</span>cleanup, <span style="color: #2d9574;">"thread 2 first handler"</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_push<span style="color: #bc6ec5;">(</span>cleanup, <span style="color: #2d9574;">"thread 2 second handler"</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 push complete\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>arg<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_exit<span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_cleanup_pop<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    pthread_cleanup_pop<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid1</span>, <span style="color: #7590db;">tid2</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *    <span style="color: #7590db;">tret</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid1, <span style="color: #a45bad;">NULL</span>, thr_fn1, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid2, <span style="color: #a45bad;">NULL</span>, thr_fn2, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 2"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_join<span style="color: #bc6ec5;">(</span>tid1, &amp;tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #bc6ec5;">)</span>;
    err = pthread_join<span style="color: #bc6ec5;">(</span>tid2, &amp;tret<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 2"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2 exit code %ld\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>tret<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
if the thread terminates by returning from its start routine, its cleanup handlers are not called, although this behavior varies among implementations
</p>
</blockquote></li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> Figure 11.6 Comparison of process and thread primitives</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Process primitives</th>
<th scope="col" class="org-left">Thread Primitive</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">fork</td>
<td class="org-left">pthread_create</td>
<td class="org-left">create a new flow of control</td>
</tr>

<tr>
<td class="org-left">exit</td>
<td class="org-left">pthread_exit</td>
<td class="org-left">exit from an existing flow of control</td>
</tr>

<tr>
<td class="org-left">waitpid</td>
<td class="org-left">pthread_join</td>
<td class="org-left">get exit status from flow of control</td>
</tr>

<tr>
<td class="org-left">atexit</td>
<td class="org-left">pthread_cleanup_push</td>
<td class="org-left">register function to be called at exit from flow of control</td>
</tr>

<tr>
<td class="org-left">getpid</td>
<td class="org-left">pthread_self</td>
<td class="org-left">get ID for flow of control</td>
</tr>

<tr>
<td class="org-left">abort</td>
<td class="org-left">pthread_cancel</td>
<td class="org-left">request abnormal termination of flow of control</td>
</tr>
</tbody>
</table>


<p>
detach a thread by calling <code>pthread_detach</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_detach</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org4034b47" class="outline-4">
<h4 id="org4034b47"><span class="done DONE">DONE</span> 11.6 Thread Synchronization <code>[8/8]</code></h4>
<div class="outline-text-4" id="text-org4034b47">
<p>
Increment operation:
</p>
<blockquote>
<ol class="org-ol">
<li>Read the memory location into a register.</li>
<li>Increment the value in the register.</li>
<li>Write the new value back to the memory location.</li>
</ol>


<p>
<b>If our data always appears to be sequentially consistent, then we need no additional synchronization.</b>
</p>
</blockquote>


<div class="figure">
<p><a href="Chapter11/fig11.9.png"><img src="Chapter11/fig11.9.png" alt="fig11.9.png" /></a>
</p>
<p><span class="figure-number">Figure 6: </span>Figure 11.9 Two unsynchronized threads incrementing the same variable</p>
</div>
</div>
<ul class="org-ul">
<li><a id="org781d705"></a><span class="done DONE">DONE</span> 11.6.1 Mutexes<br />
<div class="outline-text-5" id="text-org781d705">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">mutex</span>,
                       <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_lock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_trylock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_unlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">All return: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 90: </span>Figure 11.10 Using a mutex to protect a data structure</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.10.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-06</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    use mutex to protect a data structure</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_count</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">f_lock</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_id</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">... more stuff here  ...</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #bc6ec5; font-weight: bold;">foo_alloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">fp</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fp-&gt;f_count = <span style="color: #a45bad;">1</span>;
        fp-&gt;f_id    = id;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_hold</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
    fp-&gt;f_count++;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_rele</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>--fp-&gt;f_count == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        free<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org27f47bb"></a><span class="done DONE">DONE</span> 11.6.2 Deadlock Avoidance<br />
<div class="outline-text-5" id="text-org27f47bb">
<p>
lock the same mutex twice will cause deadlock
</p>

<p>
Deadlocks can be avoided by carefully controlling the order in which mutexes are locked
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 91: </span>Figure 11.11 Using two mutexes</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.11.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-06</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    the use of two mutexes</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NHASH</span>    <span style="color: #a45bad;">29</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">HASH</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>id<span style="color: #bc6ec5;">)</span> % NHASH<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">fh</span><span style="color: #4f97d7;">[</span>NHASH<span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">hashlock</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_count</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">f_lock</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_id</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>*     <span style="color: #7590db;">f_next</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protected by hashlock</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #bc6ec5; font-weight: bold;">foo_alloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">idx</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        fp-&gt;f_count = <span style="color: #a45bad;">1</span>;
        fp-&gt;f_id    = id;

        idx = HASH<span style="color: #2d9574;">(</span>id<span style="color: #2d9574;">)</span>;
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        fp-&gt;f_next = fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>;
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">continue initialization</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_hold</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
    fp-&gt;f_count++;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #bc6ec5; font-weight: bold;">foo_find</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">fp</span>;

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>fp = fh<span style="color: #2d9574;">[</span>HASH<span style="color: #67b11d;">(</span>id<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>; fp != <span style="color: #a45bad;">NULL</span>; fp = fp-&gt;f_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fp-&gt;f_id == id<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            foo_hold<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">release a reference to the object</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_rele</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span>* <span style="color: #7590db;">tfp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">idx</span>;

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;fp-&gt;f_lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fp-&gt;f_count == <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fp-&gt;f_count != <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fp-&gt;f_count--;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock<span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;hashlock<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span>;
        <span style="color: #2d9574;">}</span>

        idx = HASH<span style="color: #2d9574;">(</span>fp-&gt;f_id<span style="color: #2d9574;">)</span>;
        tfp = fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>tfp == fp<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fh<span style="color: #67b11d;">[</span>idx<span style="color: #67b11d;">]</span> = fp-&gt;f_next;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>tfp-&gt;f_next != fp<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tfp = tfp-&gt;f_next;
            <span style="color: #67b11d;">}</span>
            tfp-&gt;f_next = fp-&gt;f_next;
        <span style="color: #2d9574;">}</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        free<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        fp-&gt;f_count--;
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 92: </span>Figure 11.12 Simplified locking</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.12.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-08</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Simplified locking</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NHASH</span>    <span style="color: #a45bad;">29</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">HASH</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>id<span style="color: #bc6ec5;">)</span> % NHASH<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *    <span style="color: #7590db;">fh</span><span style="color: #4f97d7;">[</span>NHASH<span style="color: #4f97d7;">]</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">hashlock</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_count</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protected by hashlock</span>
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">f_lock</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">f_id</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *    <span style="color: #7590db;">f_next</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protected by hashlock</span>
                             <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">... more stuff here ...</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #bc6ec5; font-weight: bold;">foo_alloc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">idx</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fp = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fp-&gt;f_count = <span style="color: #a45bad;">1</span>;
        fp-&gt;f_id    = id;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;fp-&gt;f_lock, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            free<span style="color: #67b11d;">(</span>fp<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        idx = HASH<span style="color: #2d9574;">(</span>id<span style="color: #2d9574;">)</span>;
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        fp-&gt;f_next = fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>;
        fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>    = fp;
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">continue initialization</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_hold</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    fp-&gt;f_count++;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #bc6ec5; font-weight: bold;">foo_find</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>fp = fh<span style="color: #2d9574;">[</span>HASH<span style="color: #67b11d;">(</span>id<span style="color: #67b11d;">)</span><span style="color: #2d9574;">]</span>; fp != <span style="color: #a45bad;">NULL</span>; fp = fp-&gt;f_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>fp-&gt;f_id == id<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fp-&gt;f_count++;
            <span style="color: #4f97d7; font-weight: bold;">break</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">foo_rele</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">tfp</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">idx</span>;

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>--fp-&gt;f_count == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        idx = HASH<span style="color: #2d9574;">(</span>fp-&gt;f_id<span style="color: #2d9574;">)</span>;
        tfp = fh<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>tfp == fp<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fh<span style="color: #67b11d;">[</span>idx<span style="color: #67b11d;">]</span> = fp-&gt;f_next;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #67b11d;">(</span>tfp-&gt;f_next != fp<span style="color: #67b11d;">)</span> tfp = tfp-&gt;f_next;
            tfp-&gt;f_next = fp-&gt;f_next;
        <span style="color: #2d9574;">}</span>
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;hashlock<span style="color: #2d9574;">)</span>;
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;fp-&gt;f_lock<span style="color: #2d9574;">)</span>;
        free<span style="color: #2d9574;">(</span>fp<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;hashlock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org0431852"></a><span class="done DONE">DONE</span> 11.6.3 <code>pthread_mutex_timedlock</code> function<br />
<div class="outline-text-5" id="text-org0431852">
<p>
<b>Mac OSX 10.15.1 doesn't support <code>pthread_mutex_timedlock</code> yet</b>
</p>

<p>
<code>pthread_mutex_timedlock</code> is equivalent to <code>pthread_mutex_lock</code>, but returns <b>ETIMEDOUT</b> without locking mutex after timeout
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_timedlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">mutex</span>,
                            <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 93: </span>Figure 11.13 Using <code>pthread_mutex_timedlock</code></label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.13.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-08</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    use pthread_mutex_timedlock() to avoid blocking indefinitely</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">tout</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">tm</span>*      <span style="color: #7590db;">tmp</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>            <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">64</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">lock</span> = PTHREAD_MUTEX_INITIALIZER;

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;lock<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"mutex is locked"</span><span style="color: #bc6ec5;">)</span>;
    clock_gettime<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, &amp;tout<span style="color: #bc6ec5;">)</span>;
    tmp = localtime<span style="color: #bc6ec5;">(</span>&amp;tout.tv_sec<span style="color: #bc6ec5;">)</span>;
    strftime<span style="color: #bc6ec5;">(</span>buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%r"</span>, tmp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"current time is %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;

    tout.tv_sec += <span style="color: #a45bad;">10</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">10 seconds from now</span>

    err = pthread_mutex_timedlock<span style="color: #bc6ec5;">(</span>&amp;lock, &amp;tout<span style="color: #bc6ec5;">)</span>;
    clock_gettime<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, &amp;tout<span style="color: #bc6ec5;">)</span>;
    tmp = localtime<span style="color: #bc6ec5;">(</span>&amp;tout.tv_sec<span style="color: #bc6ec5;">)</span>;
    strftime<span style="color: #bc6ec5;">(</span>buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span>, <span style="color: #2d9574;">"%r"</span>, tmp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"the time is now %s\n"</span>, buf<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"mutex locked again!\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't lock mutex again: %s\n"</span>, strerror<span style="color: #67b11d;">(</span>err<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org16182a6"></a><span class="done DONE">DONE</span> 11.6.4 Reader-Writer Locks<br />
<div class="outline-text-5" id="text-org16182a6">
<ul class="org-ul">
<li>mutex  : can only one thread lock it at a time, lock/unlock.</li>
<li>rw-lock: read lock, write lock, unlock.</li>
<li>rw-lock: only one thread can hold a rw-lock in write mode, but multiple threads can hold a rw-lock in read mode at the same time.
<ul class="org-ul">
<li>w-lock: all threads attempting to lock it block until it is unlocked (<b>exclusive mode</b>)</li>
<li>r-lock: all threads attempting to do r-lock are given access, but w-lock block (<b>shared mode</b>)</li>
</ul></li>
</ul>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">rwlock</span>,
                        <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
The Single UNIX specification defines <b>PTHREAD_RWLOCK_INITIALIZE</b> constant in the XSI option to initialize a statically allocated rw lock.
</p>

<p>
rw-lock control:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_rdlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_wrlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_unlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">All return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
rw-lock try control:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_tryrdlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_trywrlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #7590db;">rwlock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>


<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 94: </span>Figure 11.14 Using reader-writer locks</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.14.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-09</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    illustrates the use of reader&#8211;writer locks</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">j_next</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">j_prev</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>   <span style="color: #7590db;">j_id</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">tells which thread handles this job</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *     <span style="color: #7590db;">q_head</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *     <span style="color: #7590db;">q_tail</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> <span style="color: #7590db;">q_lock</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">queue_init</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">q</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    q-&gt;q_head = <span style="color: #a45bad;">NULL</span>;
    q-&gt;q_tail = <span style="color: #a45bad;">NULL</span>;
    err       = pthread_rwlock_init<span style="color: #bc6ec5;">(</span>&amp;q-&gt;q_lock, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>err<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">continue initialization</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_insert</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_rwlock_wrlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
    jp-&gt;j_next = qp-&gt;q_head;
    jp-&gt;j_prev = <span style="color: #a45bad;">NULL</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>qp-&gt;q_head != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        qp-&gt;q_head-&gt;j_prev = jp;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        qp-&gt;q_tail = jp;

    qp-&gt;q_head = jp;
    pthread_rwlock_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_append</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_rwlock_wrlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
    jp-&gt;j_next = <span style="color: #a45bad;">NULL</span>;
    jp-&gt;j_prev = qp-&gt;q_tail;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>qp-&gt;q_tail != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        qp-&gt;q_tail-&gt;j_next = jp;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        qp-&gt;q_head = jp;

    qp-&gt;q_tail = jp;

    pthread_rwlock_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_remove</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_rwlock_wrlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>jp == qp-&gt;q_head<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        qp-&gt;q_head = jp-&gt;j_next;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>qp-&gt;q_tail == jp<span style="color: #2d9574;">)</span>
            qp-&gt;q_tail = <span style="color: #a45bad;">NULL</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>jp == qp-&gt;q_tail<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        qp-&gt;q_tail         = jp-&gt;j_prev;
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
        jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #bc6ec5;">}</span>
    pthread_rwlock_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #bc6ec5; font-weight: bold;">job_find</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pthread_rwlock_rdlock<span style="color: #2d9574;">(</span>&amp;qp-&gt;q_lock<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>jp = qp-&gt;q_head; jp; jp = jp-&gt;j_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_equal<span style="color: #67b11d;">(</span>id, jp-&gt;j_id<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_rwlock_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>jp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="orgcbbcf1e"></a><span class="done DONE">DONE</span> 11.6.5 Reader-Writer Locking with Timeouts<br />
<div class="outline-text-5" id="text-orgcbbcf1e">
<p>
rw-lock with timeout to avoid blocking indefinitely
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_timedrdlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">rwlock</span>,
                               <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlock_timedwrlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlock_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">rwlock</span>,
                               <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<b>the timeout specifies an absolute time, not a relative one.</b>
</p>
</div>
</li>
<li><a id="org8fbdd9b"></a><span class="done DONE">DONE</span> 11.6.6 Condition Variables<br />
<div class="outline-text-5" id="text-org8fbdd9b">
<blockquote>
<p>
The condition itself is protected by a mutex. A thread must first lock the mutex to change the condition state. Other threads will not notice the change until they acquire the mutex, because the mutex must be locked to be able to evaluate the condition.
</p>

<p>
assign the constant PTHREAD_COND_INITIALIZER to a statically allocated condition variable
</p>
</blockquote>

<p>
<code>pthread_cond_init/destroy</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">cond</span>,
                      <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #7590db;">cond</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both returns: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
<code>pthread_cond wait/timedwait</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">cond</span>,
                      <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_timedwait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">cond</span>,
                           <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">mutex</span>,
                           <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">tsptr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
wait as an absolute time instead of a relative time.
</p>

<p>
To obtain the absolute time for the timeout value,
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">maketimeout</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">tsp</span>, <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">minutes</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">now</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">get the current time</span>
    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;now, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    tsp-&gt;tv_sec = now.tv_sec;
    tsp-&gt;tv_nsec = now.tv_usec * <span style="color: #a45bad;">1000</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">usec to nsec</span>
    tsp-&gt;tv_sec += minutes * <span style="color: #a45bad;">60</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>


<p>
notify threads that a condition has been satisfied.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_signal</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #7590db;">cond</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_cond_broadcast</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span> *<span style="color: #7590db;">cond</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 95: </span>Figure 11.15 Using a condition variable</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.15.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-10</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    an example of how to use a condition variable and a mutex</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * together to synchronize threads.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> *<span style="color: #7590db;">m_next</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">more stuff here</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> *<span style="color: #7590db;">workd</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span>  <span style="color: #7590db;">qready</span> = PTHREAD_COND_INITIALIZER;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">qlock</span>  = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">process_msg</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> *<span style="color: #7590db;">mp</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;qlock<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #2d9574;">(</span>workd == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            pthread_cond_wait<span style="color: #67b11d;">(</span>&amp;qready, &amp;qlock<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        mp    = workd;
        workd = mp-&gt;m_next;
        pthread_mutex_unlock<span style="color: #2d9574;">(</span>&amp;qlock<span style="color: #2d9574;">)</span>;
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">now process the messg mp</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">enqueue_msg</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">msg</span> *<span style="color: #7590db;">mp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;qlock<span style="color: #bc6ec5;">)</span>;
    mp-&gt;m_next = workd;
    workd      = mp;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qlock<span style="color: #bc6ec5;">)</span>;
    pthread_cond_signal<span style="color: #bc6ec5;">(</span>&amp;qready<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org371e546"></a><span class="done DONE">DONE</span> 11.6.7 Spin Locks<br />
<div class="outline-text-5" id="text-org371e546">
<blockquote>
<p>
A spin lock is like a mutex, except that <b>instead of blocking</b> a process by sleeping, the process is blocked by busy-waiting (spinning) until the lock can be acquired
</p>

<p>
use for short periods of times
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<ul class="org-ul">
<li><b>PTHREAD_PROCESS_SHARED</b>: the spin lock can be acquired by threads that have access to the lock's underlying memory</li>
<li><b>PTHREAD_PROCESS_PRIVATE</b>: the spin lock can be accessed by only from threads within the process that initialized it.</li>
</ul>


<p>
<code>pthread_spin_trylock</code> doesn't spin,
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_lock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_trylock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_spin_unlock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_spinlock_t</span> *<span style="color: #7590db;">lock</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">All return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
If either pthread_spin_lock or pthread_spin_trylock returns 0, then the spin lock is locked
</p>
</div>
</li>

<li><a id="orgb1c614f"></a><span class="done DONE">DONE</span> 11.6.8 Barriers<br />
<div class="outline-text-5" id="text-orgb1c614f">
<p>
<b>Mac OSX doesn't implemented yet, but we can implemente it by pthread_cond and pthread_mutex</b>
coordinate multiple threads working in parallel.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">barrier</span>,
                         <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                         <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">count</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">barrier</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<b>count</b> refers to the number of threads that must call <code>pthread_barrier_wait()</code> (includes the calling in process)
</p>

<p>
<code>pthread_barrier_wait</code> indicates a thread is done with its work and is ready to wait for all the other threads to catch up .
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">barrier</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 or PTHREAD_BARRIER_SERIAL_THREAD if OK, error number on failure</span>
</pre>
</div>
<p>
calling <code>pthread_barrier_wait</code> is put to sleep if barrier count is not yet satisfied.
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 96: </span>Figure 11.16 Using a barrier</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.16.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-10</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    show how a barrier can be used to synchronize threads cooperating</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * on a single task</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NTHR</span>   <span style="color: #a45bad;">8</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NUMNUM</span> <span style="color: #a45bad;">800000L</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">TNUM</span>   <span style="color: #4f97d7;">(</span>NUMNUM / NTHR<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">nums</span><span style="color: #4f97d7;">[</span>NUMNUM<span style="color: #4f97d7;">]</span>;
<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">snums</span><span style="color: #4f97d7;">[</span>NUMNUM<span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> <span style="color: #7590db;">b</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>SOLARIS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">heapsort</span> gsort
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__linux__<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">heapsort</span> qsort
<span style="color: #bc6ec5;">#else</span>
<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">heapsort</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">size_t</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span>,
                    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5;">)(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">complong</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg1</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg2</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">l1</span> = *<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>arg1;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">l2</span> = *<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>arg2;

    <span style="color: #4f97d7; font-weight: bold;">return</span> l1 == l2 ? <span style="color: #a45bad;">0</span> : l1 &gt; l2 ? <span style="color: #a45bad;">1</span> : -<span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span> = <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #bc6ec5;">)</span>arg;

    heapsort<span style="color: #bc6ec5;">(</span>&amp;nums<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>, TNUM, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>, complong<span style="color: #bc6ec5;">)</span>;
    pthread_barrier_wait<span style="color: #bc6ec5;">(</span>&amp;b<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">merge</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span><span style="color: #bc6ec5;">[</span>NTHR<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span>, <span style="color: #7590db;">minidx</span>, <span style="color: #7590db;">sidx</span>, <span style="color: #7590db;">num</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; i++<span style="color: #bc6ec5;">)</span> idx<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> = i * TNUM;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>sidx = <span style="color: #a45bad;">0</span>; sidx &lt; NUMNUM; sidx++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        num = LONG_MAX;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>idx<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> &lt; <span style="color: #4f97d7;">(</span>i + <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span> * TNUM<span style="color: #b1951d;">)</span> &amp;&amp; <span style="color: #b1951d;">(</span>nums<span style="color: #4f97d7;">[</span>idx<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">]</span> &lt; num<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                num    = nums<span style="color: #b1951d;">[</span>idx<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span><span style="color: #b1951d;">]</span>;
                minidx = i;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        snums<span style="color: #2d9574;">[</span>sidx<span style="color: #2d9574;">]</span> = nums<span style="color: #2d9574;">[</span>idx<span style="color: #67b11d;">[</span>minidx<span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span>;
        idx<span style="color: #2d9574;">[</span>minidx<span style="color: #2d9574;">]</span>++;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span>  <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">start</span>, <span style="color: #7590db;">end</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span>      <span style="color: #7590db;">startusec</span>, <span style="color: #7590db;">endusec</span>;
    <span style="color: #ce537a; font-weight: bold;">double</span>         <span style="color: #7590db;">elapsed</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>      <span style="color: #7590db;">tid</span>;

    srandom<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NUMNUM; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        nums<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> = random<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;start, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    pthread_barrier_init<span style="color: #bc6ec5;">(</span>&amp;b, <span style="color: #a45bad;">NULL</span>, NTHR + <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err = pthread_create<span style="color: #2d9574;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span>i * TNUM<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    pthread_barrier_wait<span style="color: #bc6ec5;">(</span>&amp;b<span style="color: #bc6ec5;">)</span>;
    merge<span style="color: #bc6ec5;">()</span>;
    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;end, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    startusec = start.tv_sec * <span style="color: #a45bad;">1000000</span> + start.tv_usec;
    endusec   = end.tv_sec * <span style="color: #a45bad;">100000</span> + end.tv_usec;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sort took %.4f seconds"</span>, elapsed<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NUMNUM; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%ld\n"</span>, snums<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgc6a4bda" class="outline-4">
<h4 id="orgc6a4bda"><span class="done DONE">DONE</span> 11.7 Summary</h4>
<div class="outline-text-4" id="text-orgc6a4bda">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
11.1
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.4.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-05</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Exerciese 11.1</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">a</span>, <span style="color: #7590db;">b</span>, <span style="color: #7590db;">c</span>, <span style="color: #7590db;">d</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">printfoo</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">s</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s"</span>, s<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" structure at 0x%lx\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.a = %d\n"</span>, fp-&gt;a<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.b = %d\n"</span>, fp-&gt;b<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.c = %d\n"</span>, fp-&gt;c<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">" foo.d = %d\n"</span>, fp-&gt;d<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn1</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span> = <span style="color: #a45bad;">NULL</span>;

    fp = calloc<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;

    fp-&gt;a = <span style="color: #a45bad;">1</span>;
    fp-&gt;b = <span style="color: #a45bad;">2</span>;
    fp-&gt;c = <span style="color: #a45bad;">3</span>;
    fp-&gt;d = <span style="color: #a45bad;">4</span>;

    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 1:\n"</span>, fp<span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>fp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn2</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span> = arg;
    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2: "</span>, fp<span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread 2: ID is %lu\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pthread_self<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>   <span style="color: #7590db;">tid1</span>, <span style="color: #7590db;">tid2</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">foo</span> *<span style="color: #7590db;">fp</span>;

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid1, <span style="color: #a45bad;">NULL</span>, thr_fn1, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_join<span style="color: #bc6ec5;">(</span>tid1, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span>&amp;fp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't join with thread 1"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid2, <span style="color: #a45bad;">NULL</span>, thr_fn2, fp<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printfoo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent:\n"</span>, fp<span style="color: #bc6ec5;">)</span>;

    free<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
11.2
</p>
<blockquote>
<p>
write-mode lock on the whole list while the ID is changing.
</p>

<p>
the thread ID between <code>job_find</code> and <code>job_remove</code> maybe changed
</p>

<p>
to solve this problem, add another mutex in struct job
</p>
</blockquote></li>
<li><p>
11.3
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.14.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-09</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    illustrates the use of reader&#8211;writer locks</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @todo     something need to be considered</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">j_next</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">j_prev</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>   <span style="color: #7590db;">j_id</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">tells which thread handles this job</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*j_func<span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>       <span style="color: #7590db;">q_id</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *    <span style="color: #7590db;">q_head</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *    <span style="color: #7590db;">q_tail</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span>  <span style="color: #7590db;">q_cond</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">q_mutex</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread %lu start\n"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>pthread_self<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    pthread_exit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">queue_init</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">q</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    q-&gt;q_id   = pthread_self<span style="color: #bc6ec5;">()</span>;
    q-&gt;q_head = <span style="color: #a45bad;">NULL</span>;
    q-&gt;q_tail = <span style="color: #a45bad;">NULL</span>;
    err       = pthread_mutex_init<span style="color: #bc6ec5;">(</span>&amp;q-&gt;q_mutex, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>err<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_cond_init<span style="color: #bc6ec5;">(</span>&amp;q-&gt;q_cond, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;q-&gt;q_mutex<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">continue initialization</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> err;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_insert</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;

    jp-&gt;j_next = qp-&gt;q_head;
    jp-&gt;j_prev = <span style="color: #a45bad;">NULL</span>;
    jp-&gt;j_func = thr_fn;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>qp-&gt;q_head != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        qp-&gt;q_head-&gt;j_prev = jp;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        qp-&gt;q_tail = jp;

    qp-&gt;q_head = jp;

    pthread_cond_signal<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_cond<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_append</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;

    jp-&gt;j_next = <span style="color: #a45bad;">NULL</span>;
    jp-&gt;j_prev = qp-&gt;q_tail;
    jp-&gt;j_func = thr_fn;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>qp-&gt;q_tail != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        qp-&gt;q_tail-&gt;j_next = jp;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        qp-&gt;q_head = jp;

    qp-&gt;q_tail = jp;

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">job_remove</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>jp == qp-&gt;q_head<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        qp-&gt;q_head = jp-&gt;j_next;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>qp-&gt;q_tail == jp<span style="color: #2d9574;">)</span>
            qp-&gt;q_tail = <span style="color: #a45bad;">NULL</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>jp == qp-&gt;q_tail<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        qp-&gt;q_tail         = jp-&gt;j_prev;
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        jp-&gt;j_prev-&gt;j_next = jp-&gt;j_next;
        jp-&gt;j_next-&gt;j_prev = jp-&gt;j_prev;
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #bc6ec5; font-weight: bold;">job_find</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">queue</span> *<span style="color: #7590db;">qp</span>, <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">id</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">job</span> *<span style="color: #7590db;">jp</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pthread_mutex_lock<span style="color: #2d9574;">(</span>&amp;qp-&gt;q_mutex<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">NULL</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>jp = qp-&gt;q_head; jp; jp = jp-&gt;j_next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>pthread_equal<span style="color: #67b11d;">(</span>id, jp-&gt;j_id<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #4f97d7; font-weight: bold;">break</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;qp-&gt;q_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>jp<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<ol class="org-ol">
<li>rwlock change to condition lock, and need additional mutex lock</li>
<li>data structure for each thread OR</li>
<li>if lock the whole list, the other jobs have to wait, it is the waste of time</li>
</ol></li>
<li><p>
11.4
</p>
<blockquote>
<p>
It depends on the circumstances. In general, both can be correct, but each alternative has drawbacks. In the first sequence, the waiting threads will be scheduled to run after we call pthread_cond_broadcast. If the program is running on a multiprocessor, some threads will run and immediately block because we are still holding the mutex (recall that pthread_cond_wait returns with the mutex held). In the second sequence, a running thread can acquire the mutex between steps 3 and 4, invalidate the condition, and release the mutex. Then, when we call pthread_cond_broadcast, the condition will no longer be true, and the threads will run needlessly. This is why the awakened threads must recheck the condition and not assume that it is true merely because pthread_cond_wait returned.
</p>
</blockquote></li>
<li><p>
11.5
pthread_cond &amp;&amp; counter
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig11.16.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-10</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    show how a barrier can be used to synchronize threads cooperating</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * on a single task</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NTHR</span>   <span style="color: #a45bad;">8</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NUMNUM</span> <span style="color: #a45bad;">800000L</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">TNUM</span>   <span style="color: #4f97d7;">(</span>NUMNUM / NTHR<span style="color: #4f97d7;">)</span>

<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">nums</span><span style="color: #4f97d7;">[</span>NUMNUM<span style="color: #4f97d7;">]</span>;
<span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">snums</span><span style="color: #4f97d7;">[</span>NUMNUM<span style="color: #4f97d7;">]</span>;

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>SOLARIS<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">heapsort</span> gsort
<span style="color: #bc6ec5;">#elif</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__linux__<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">heapsort</span> qsort
<span style="color: #bc6ec5;">#else</span>
<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">heapsort</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #ce537a; font-weight: bold;">size_t</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span>,
                    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5;">)(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__APPLE__<span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">typedef</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">counter</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span>  <span style="color: #7590db;">cond</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">mutex</span>;
<span style="color: #4f97d7;">}</span> <span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">b</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">count</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span>;

    ret = pthread_mutex_init<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">err</span>;
    <span style="color: #bc6ec5;">}</span>
    ret = pthread_cond_init<span style="color: #bc6ec5;">(</span>&amp;b-&gt;cond, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_mutex_destroy<span style="color: #2d9574;">(</span>&amp;b-&gt;mutex<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">err</span>;
    <span style="color: #bc6ec5;">}</span>
    b-&gt;counter = count;

    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #a45bad;">err</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">b</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span> = <span style="color: #a45bad;">0</span>;

    ret = pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">err</span>;
    <span style="color: #bc6ec5;">}</span>

    ret = pthread_mutex_destroy<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex<span style="color: #bc6ec5;">)</span>;
    ret = pthread_cond_destroy<span style="color: #bc6ec5;">(</span>&amp;b-&gt;cond<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #a45bad;">err</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrier_wait</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> *<span style="color: #7590db;">b</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">cancel</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">ret</span> = pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ret != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">err</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>--b-&gt;counter == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_cond_broadcast<span style="color: #2d9574;">(</span>&amp;b-&gt;cond<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        pthread_setcancelstate<span style="color: #2d9574;">(</span>PTHREAD_CANCEL_DISABLE, &amp;cancel<span style="color: #2d9574;">)</span>;

        pthread_cond_wait<span style="color: #2d9574;">(</span>&amp;b-&gt;cond, &amp;b-&gt;mutex<span style="color: #2d9574;">)</span>;
        pthread_setcancelstate<span style="color: #2d9574;">(</span>cancel, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;b-&gt;mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;

<span style="color: #a45bad;">err</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> ret;
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">pthread_barrier_t</span> <span style="color: #7590db;">b</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">complong</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg1</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg2</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">l1</span> = *<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>arg1;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">l2</span> = *<span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> *<span style="color: #bc6ec5;">)</span>arg2;

    <span style="color: #4f97d7; font-weight: bold;">return</span> l1 == l2 ? <span style="color: #a45bad;">0</span> : l1 &gt; l2 ? <span style="color: #a45bad;">1</span> : -<span style="color: #a45bad;">1</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span> = <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #bc6ec5;">)</span>arg;

    heapsort<span style="color: #bc6ec5;">(</span>&amp;nums<span style="color: #2d9574;">[</span>idx<span style="color: #2d9574;">]</span>, TNUM, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>, complong<span style="color: #bc6ec5;">)</span>;
    pthread_barrier_wait<span style="color: #bc6ec5;">(</span>&amp;b<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #2d9574;">)</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">merge</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">idx</span><span style="color: #bc6ec5;">[</span>NTHR<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">i</span>, <span style="color: #7590db;">minidx</span>, <span style="color: #7590db;">sidx</span>, <span style="color: #7590db;">num</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; i++<span style="color: #bc6ec5;">)</span> idx<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span> = i * TNUM;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>sidx = <span style="color: #a45bad;">0</span>; sidx &lt; NUMNUM; sidx++<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        num = LONG_MAX;
        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span><span style="color: #b1951d;">(</span>idx<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span> &lt; <span style="color: #4f97d7;">(</span>i + <span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span> * TNUM<span style="color: #b1951d;">)</span> &amp;&amp; <span style="color: #b1951d;">(</span>nums<span style="color: #4f97d7;">[</span>idx<span style="color: #bc6ec5;">[</span>i<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">]</span> &lt; num<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                num    = nums<span style="color: #b1951d;">[</span>idx<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span><span style="color: #b1951d;">]</span>;
                minidx = i;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
        snums<span style="color: #2d9574;">[</span>sidx<span style="color: #2d9574;">]</span> = nums<span style="color: #2d9574;">[</span>idx<span style="color: #67b11d;">[</span>minidx<span style="color: #67b11d;">]</span><span style="color: #2d9574;">]</span>;
        idx<span style="color: #2d9574;">[</span>minidx<span style="color: #2d9574;">]</span>++;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span>  <span style="color: #7590db;">i</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">start</span>, <span style="color: #7590db;">end</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span>      <span style="color: #7590db;">startusec</span>, <span style="color: #7590db;">endusec</span>;
    <span style="color: #ce537a; font-weight: bold;">double</span>         <span style="color: #7590db;">elapsed</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>      <span style="color: #7590db;">tid</span>;

    srandom<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NUMNUM; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        nums<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> = random<span style="color: #2d9574;">()</span>;
    <span style="color: #bc6ec5;">}</span>

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;start, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    pthread_barrier_init<span style="color: #bc6ec5;">(</span>&amp;b, <span style="color: #a45bad;">NULL</span>, NTHR + <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NTHR; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">func</span> = thr_fn;
        err        = pthread_create<span style="color: #2d9574;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span>i * TNUM<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    pthread_barrier_wait<span style="color: #bc6ec5;">(</span>&amp;b<span style="color: #bc6ec5;">)</span>;
    merge<span style="color: #bc6ec5;">()</span>;
    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;end, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;

    startusec = start.tv_sec * <span style="color: #a45bad;">1000000</span> + start.tv_usec;
    endusec   = end.tv_sec * <span style="color: #a45bad;">100000</span> + end.tv_usec;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"sort took %.4f seconds"</span>, elapsed<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NUMNUM; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%ld\n"</span>, snums<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org7d7e4d7" class="outline-3">
<h3 id="org7d7e4d7"><span class="done DONE">DONE</span> Chapter 12. Thread Control <code>[11/11]</code></h3>
<div class="outline-text-3" id="text-org7d7e4d7">
</div>
<div id="outline-container-org0404cd6" class="outline-4">
<h4 id="org0404cd6"><span class="done DONE">DONE</span> 12.1 Introduction</h4>
<div class="outline-text-4" id="text-org0404cd6">
</div>
</div>
<div id="outline-container-org0fa29d9" class="outline-4">
<h4 id="org0fa29d9"><span class="done DONE">DONE</span> 12.2 Thread Limits</h4>
<div class="outline-text-4" id="text-org0fa29d9">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 10:</span> Figure 12.1 Thread limits and <i>name</i> arguments to <code>sysconf</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name of limit</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left"><i>name</i> argument</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_DESTRUCTOR_ITERATIONS</td>
<td class="org-left">maximum number of times an implemetation will</td>
<td class="org-left">_SC_THREAD_DESTRUCTOR_ITERATIONS</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">try to destroy the thread-specific data</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">when a thread exits (Section 12.6)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_KEYS_MAX</td>
<td class="org-left">maximum number of keys that can be created</td>
<td class="org-left">_SC_THREAD_KEYS_MAX</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">by a process (Section 12.6)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_STACK_MIN</td>
<td class="org-left">minimum number of bytes that can be used</td>
<td class="org-left">_SC_THREAD_STACK_MIN</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">for a thread's stack (Section by 12.3)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">PTHREAD_STACK_MAX</td>
<td class="org-left">maximum number of threads that can be created</td>
<td class="org-left">_SC_THREAD_STACK_MAX</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">in a process (Section 12.3)</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-org2b37714" class="outline-4">
<h4 id="org2b37714"><span class="done DONE">DONE</span> 12.3 Thread Attributes</h4>
<div class="outline-text-4" id="text-org2b37714">
<blockquote>
<ol class="org-ol">
<li>Each object is associated with its own type of attribute object (threads with thread attributes, mutexes with mutex attributes, and so on).</li>

<li>An initialization function exists to set the attributes to their default values.</li>

<li>Another function exists to destroy the attributes object.</li>

<li>Each attribute has a function to get the value of the attribute from the attribute object.</li>

<li>Each attribute has a function to set the value of the attribute.</li>
</ol>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
attributes:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 11:</span> Figure 12.3 POSIX.1 thread attributes</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><i>detachstate</i></td>
<td class="org-left">detached threada attribute</td>
</tr>

<tr>
<td class="org-left"><i>guardsize</i></td>
<td class="org-left">guard buffer size in bytes at end of thread stack</td>
</tr>

<tr>
<td class="org-left"><i>stackaddr</i></td>
<td class="org-left">lowest address of thread stack</td>
</tr>

<tr>
<td class="org-left"><i>stacksize</i></td>
<td class="org-left">minimum size in bytes of thread stack</td>
</tr>
</tbody>
</table>

<p>
detachstate:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_getdetachstate</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">ptrhead_attr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">detachstate</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_setdetachstate</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">detachstate</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
<code>PTHREAD_CREATE_DETACHED</code> or <code>PTHREAD_CREATE_JOINABLE</code>
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 97: </span>Figure 12.4 Creating a thread in the detached state</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig12.4.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-15</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    create a thread in the detached state</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">makethread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">fn</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>      <span style="color: #7590db;">tid</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> <span style="color: #7590db;">attr</span>;

    err = pthread_attr_init<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>err<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    err = pthread_attr_setdetachstate<span style="color: #bc6ec5;">(</span>&amp;attr, PTHREAD_CREATE_DETACHED<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err = pthread_create<span style="color: #2d9574;">(</span>&amp;tid, &amp;attr, fn, arg<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_attr_destroy<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> err;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>

<p>
stack:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_getstack</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                          <span style="color: #ce537a; font-weight: bold;">void</span> **<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">stackattr</span>,
                          <span style="color: #ce537a; font-weight: bold;">size_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">stacksize</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_setstack</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span>,
                          <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">stackaddr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">stacksize</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
guardsize:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_getguardsize</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                              <span style="color: #ce537a; font-weight: bold;">size_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">guardsize</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_attr_setguardsize</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_attr_t</span> *<span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">guardsize</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
Threads have other attributes not represented by the pthread_attr_t structure: the cancelability state and the cancelability type.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org6b19957" class="outline-4">
<h4 id="org6b19957"><span class="done DONE">DONE</span> 12.4 Synchronization Attributes <code>[4/4]</code></h4>
<div class="outline-text-4" id="text-org6b19957">
</div>
<ul class="org-ul">
<li><a id="org8e8f659"></a><span class="done DONE">DONE</span> 12.4.1 Mutex Attributes<br />
<div class="outline-text-5" id="text-org8e8f659">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_getpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                 <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_setpshared</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #7590db;">attr</span>,
                                 <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
default: <code>PTHREAD_PROCESS_PRIVATE</code>
</p>
<blockquote>
<p>
multiple threads can access the same synchronization object
</p>
</blockquote>
<p>
other: <code>PTHREAD_PROCESS_SHARED</code>
</p>
<blockquote>
<p>
a mutex allocated from a memory extent shared between multiple processes may be used for synchronization by those processes.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_getrobust</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">robust</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_setrobust</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">robust</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
default: <code>PTHREAD_MUTEX_STALLED</code>
</p>
<blockquote>
<p>
use of the mutex can result in undefined behavior, and applications waiting for it to be unlocked are effectively "stalled".
</p>
</blockquote>
<p>
other:   <code>PTHREAD_MUTEX_ROBUST</code>
</p>
<blockquote>
<p>
This value will cause a thread blocked in a call to pthread_mutex_lock to acquire the lock when another process holding the lock terminates without first unlocking it, but the return value from pthread_mutex_lock is EOWNERDEAD instead of 0.
</p>
</blockquote>

<p>
<b>Using robust mutexes has to check for three return values instead of two</b>:
</p>
<ul class="org-ul">
<li>success with no recovery</li>
<li>success but recovery needj</li>
<li>failure</li>
</ul>


<p>
for application can't be recovered to indicate that the state associated with the mutex is consistent before unlocking the mutex.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutex_consistent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> *<span style="color: #7590db;">mutex</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 12:</span> mutex types</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">type</th>
<th scope="col" class="org-left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_MUTEX_NORMAL</td>
<td class="org-left">doesn't do any special error checking or deadlock detection</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_ERRORCHECK</td>
<td class="org-left">provides error checking</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_RECURSIVE</td>
<td class="org-left">allow the same thread to lock multiple times without first unlocking</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_DEFAULT</td>
<td class="org-left">prividing default characteristics and behavior.</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 13:</span> Figure 12.5 Mutex type behavior</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Mutex type</th>
<th scope="col" class="org-left">Relock without unlock?</th>
<th scope="col" class="org-left">Unlock when not owned?</th>
<th scope="col" class="org-left">Unlock when unlocked?</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">PTHREAD_MUTEX_NORMAL</td>
<td class="org-left">deadlock</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_ERRORCHECK</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_RECURSIVE</td>
<td class="org-left">allowed</td>
<td class="org-left">returns error</td>
<td class="org-left">returns error</td>
</tr>

<tr>
<td class="org-left">PTHREAD_MUTEX_DEFAULT</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
<td class="org-left">undefined</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_gettype</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                              <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_mutexattr_settype</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
If a recursive mutex is locked multiple times and used in a call to pthread_cond_wait, the condition can never be satisfied, because the unlock done by pthread_cond_wait doesn’t release the mutex.
</p>

<p>
should be used only when no other solution is possible.
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 98: </span>Figure 12.8 Using a recursive mutex</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig.8.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-15</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Using a recursive mutex</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">makethread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*to_fn<span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>;    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">function</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> *          <span style="color: #7590db;">to_arg</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">argument</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">to_wait</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">time to wait</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SECTONSEC</span> <span style="color: #a45bad;">1000000000</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">seconds to nanoseconds</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">clock_nanosleep</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">ID</span>, <span style="color: #7590db;">FL</span>, <span style="color: #7590db;">REQ</span>, <span style="color: #7590db;">REM</span><span style="color: #4f97d7;">)</span> nanosleep<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>REQ<span style="color: #bc6ec5;">)</span>, <span style="color: #bc6ec5;">(</span>REM<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> CLOCK_REALTIME
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">CLOCK_REALTIME</span> <span style="color: #a45bad;">0</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">USECTONSEC</span>     <span style="color: #a45bad;">1000</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">microseconds to nanoseconds</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">clock_gettime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">tsp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;tv, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    tsp-&gt;tv_sec  = tv.tv_sec;
    tsp-&gt;tv_nsec = tv.tv_usec * USECTONSEC
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">timeout_helper</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #7590db;">tip</span>;

    tip = <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #bc6ec5;">)</span>arg;
    clock_nanosleep<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, <span style="color: #a45bad;">0</span>, &amp;tip-&gt;to_wait, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #bc6ec5;">(</span>*tip-&gt;to_fn<span style="color: #bc6ec5;">)(</span>tip-&gt;to_arg<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>arg<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">timeout</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">when</span>, <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">func</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">now</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #7590db;">tip</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span>;

    clock_gettime<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, &amp;now<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>when-&gt;tv_sec &gt; now.tv_sec<span style="color: #2d9574;">)</span> ||
        <span style="color: #2d9574;">(</span>when-&gt;tv_sec == now.tv_sec &amp;&amp; when-&gt;tv_nsec &gt; now.tv_nsec<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        tip = malloc<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>tip != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            tip-&gt;to_fn          = func;
            tip-&gt;to_arg         = arg;
            tip-&gt;to_wait.tv_sec = when-&gt;tv_sec - now.tv_sec;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>when-&gt;tv_nsec &gt;= now.tv_nsec<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_nsec = when-&gt;tv_nsec - now.tv_nsec;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_sec--;
                tip-&gt;to_wait.tv_nsec = SECTONSEC - now.tv_nsec + when-&gt;tv_nsec;
            <span style="color: #67b11d;">}</span>

            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">err = makethread(timeout_helper, (void *)tip);</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>err == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">return</span>;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                free<span style="color: #b1951d;">(</span>tip<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #bc6ec5;">(</span>*func<span style="color: #bc6ec5;">)(</span>arg<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #7590db;">attr</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span>     <span style="color: #7590db;">mutex</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">retry</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">condition</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">arg</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">when</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutexattr_init<span style="color: #67b11d;">(</span>&amp;attr<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"pthread_mutexattr_init failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutexattr_settype<span style="color: #67b11d;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> !=
        <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't set recursive type"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;mutex, &amp;attr<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create recursive mutex"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>condition == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        clock_gettime<span style="color: #2d9574;">(</span>CLOCK_REALTIME, &amp;when<span style="color: #2d9574;">)</span>;
        when.tv_sec += <span style="color: #a45bad;">10</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">10 seconds after now</span>
        timeout<span style="color: #2d9574;">(</span>&amp;when, retry, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span><span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #b1951d;">)</span>arg<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
<li><a id="org55cd315"></a><span class="done DONE">DONE</span> 12.4.2 Reader-Writer Lock Attributes<br />
<div class="outline-text-5" id="text-org55cd315">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlockattr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlockattr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlockattr_getpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                  <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">restirct</span> pshared<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_rwlockattr_setpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_rwlockattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>
<li><a id="orgeead6ef"></a><span class="done DONE">DONE</span> 12.4.3 Condition Variable Attributes<br />
<div class="outline-text-5" id="text-orgeead6ef">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_getpshared</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> <span style="color: #4f97d7; font-weight: bold;">const</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_setpshared</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #7590db;">attr</span>,
                                <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>; ;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_getclock</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                              <span style="color: #ce537a; font-weight: bold;">clockid_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">clock_id</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_condattr_setclock</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_condattr_t</span> *<span style="color: #7590db;">attr</span>,
                              <span style="color: #ce537a; font-weight: bold;">clockid_t</span> <span style="color: #7590db;">clock_id</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>
<li><a id="orge6ee751"></a><span class="done DONE">DONE</span> 12.4.4 Barrier Attributes<br />
<div class="outline-text-5" id="text-orge6ee751">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrierattr_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrierattr_destroy</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #7590db;">attr</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrierattr_getpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">attr</span>,
                                   <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_barrierattr_setpshared</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">pthread_barrierattr_t</span> *<span style="color: #7590db;">attr</span>,
                                   <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">pshared</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: 0 if OK, error number on failure</span>
</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="outline-container-orgb66a01d" class="outline-4">
<h4 id="orgb66a01d"><span class="done DONE">DONE</span> 12.5 Reentrancy</h4>
<div class="outline-text-4" id="text-orgb66a01d">
<blockquote>
<p>
If a function can be safely called by multiple threads at the same time, we say that the function is thread-safe.
</p>

<p>
<i>thread-safe</i> version of functions with an _r appended at the end of its name
</p>
</blockquote>

<p>
lock associated with a given FILE object
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sstdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">ftrylockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, nonzero if lock can't be acquired</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">flockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">funlockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
I/O routines might be implemented to be thread-safe, but locking applications is still useful
</p>


<p>
lock associated with character-based standard I/O
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getchar_unlcoked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getc_unlcoked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: the next character if OK, EOF on the end of file or error</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putchar_unlocked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putc_unlcoked</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">c</span>, <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Both return: c if OK, EOF on error</span>
</pre>
</div>
<blockquote>
<p>
<b>These four functions should not be called unless they are surrounded by calls to flockfile (or ftrylockfile) and funlockfile</b>
</p>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 99: </span>Figure 12.11 A nonreentrant version of getenv</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig12.11.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-17</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    a possible implementation of getenv</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXSTRINGSZ</span> <span style="color: #a45bad;">4096</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">envbuf</span><span style="color: #4f97d7;">[</span>MAXSTRINGSZ<span style="color: #4f97d7;">]</span>;

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">getenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>;

    len = strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; environ<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">NULL</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #b1951d;">(</span>name, environ<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, len<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len<span style="color: #b1951d;">]</span> == <span style="color: #2d9574;">'='</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            strncpy<span style="color: #67b11d;">(</span>envbuf, &amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, MAXSTRINGSZ - <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 100: </span>Figure 12.12 a reentrant (thread-safe) version of getenv</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig12.12.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-17</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    a reentrant version of getenv</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">env_mutex</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #7590db;">attr</span>;

    pthread_mutexattr_init<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
    pthread_mutexattr_settype<span style="color: #bc6ec5;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_init<span style="color: #bc6ec5;">(</span>&amp;env_mutex, &amp;attr<span style="color: #bc6ec5;">)</span>;
    pthread_mutexattr_destroy<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">getenv_r</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">buflen</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>, <span style="color: #7590db;">olen</span>;

    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
    len = strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; environ<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">NULL</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #b1951d;">(</span>name, environ<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, len<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len<span style="color: #b1951d;">]</span> == <span style="color: #2d9574;">'='</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            olen = strlen<span style="color: #67b11d;">(</span>&amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>olen &gt;= buflen<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                pthread_mutex_unlock<span style="color: #b1951d;">(</span>&amp;env_mutex<span style="color: #b1951d;">)</span>;
                pthread_mutex_destroy<span style="color: #b1951d;">(</span>&amp;env_mutex<span style="color: #b1951d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #b1951d;">(</span>ENOSPC<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
            strcpy<span style="color: #67b11d;">(</span>buf, &amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            pthread_mutex_destroy<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_destroy<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>ENOENT<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org12fb964" class="outline-4">
<h4 id="org12fb964"><span class="done DONE">DONE</span> 12.6 Thread-Specific Data</h4>
<div class="outline-text-4" id="text-org12fb964">
<blockquote>
<p>
Thread-specific data, also known as thread-private data, is a mechanism for storing and finding data associated with a particular thread
</p>

<p>
The reasons to prevent sharing process data and attributes
</p>
<ul class="org-ul">
<li>First, sometimes we need to maintain data on a per-thread basis.</li>
<li>The second reason for thread-private data is to provide a mechanism for adapting process-based interfaces to a multithreaded environment.</li>
</ul>
</blockquote>

<p>
crate a <i>key</i> to gain acess to with the thread-specific data
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_key_create</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_key_t</span> *<span style="color: #7590db;">keyp</span>, <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">destructor</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
break the association of a key with the thread-specific data
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_key_delete</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_key_t</span> <span style="color: #7590db;">key</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<blockquote>
<p>
<b>calling pthread_key_delete will not invoke the destructor function. To free a key:</b>
ensure a key we allocated doesn't change because of a race during initialization. Code like the following can result in two threads both calling <code>pthread_key_create</code>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">destructor</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_key_t</span> <span style="color: #7590db;">key</span>;
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">init_done</span> = <span style="color: #a45bad;">0</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">threadfunc</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span>init_done<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        init_done = <span style="color: #a45bad;">1</span>;
        err = pthread_key_create<span style="color: #2d9574;">(</span>&amp;key, destructor<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
The proper way to create a key without a race is as follows:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">destructor</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_key_t</span> <span style="color: #7590db;">key</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    err = pthread_key_create<span style="color: #bc6ec5;">(</span>&amp;key, destructor<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">threadfunc</span> <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</blockquote>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 101: </span>Figure 12.13 A thread-safe, compatible version of getenv</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig12.13.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-17</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    a hypothetical implementation of getenv</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXSTRINGSZ</span> <span style="color: #a45bad;">4096</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_key_t</span>  <span style="color: #7590db;">key</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span>       <span style="color: #7590db;">env_mutex</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> pthread_key_create<span style="color: #bc6ec5;">(</span>&amp;key, free<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">getenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">envbuf</span>;

    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    envbuf = <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5;">)</span>pthread_getspecific<span style="color: #bc6ec5;">(</span>key<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>envbuf == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        envbuf = malloc<span style="color: #2d9574;">(</span>MAXSTRINGSZ<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>envbuf == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">nil</span>;
        <span style="color: #2d9574;">}</span>
        pthread_setspecific<span style="color: #2d9574;">(</span>key, envbuf<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    len = strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; environ<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">NULL</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #b1951d;">(</span>name, environ<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, len<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span> == <span style="color: #2d9574;">'='</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            snprintf<span style="color: #67b11d;">(</span>envbuf, MAXSTRINGSZ - <span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">"%s"</span>, &amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

<span style="color: #a45bad;">nil</span>:
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org065ed2a" class="outline-4">
<h4 id="org065ed2a"><span class="done DONE">DONE</span> 12.7 Cancel Options</h4>
<div class="outline-text-4" id="text-org065ed2a">
<blockquote>
<p>
The <i>cancelability state</i> attribute can be either PTHREAD_CANCEL_ENABLE or PTHREAD_CANCEL_DISABLE.
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_setcancelstate</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">state</span>, <span style="color: #ce537a; font-weight: bold;">int</span>* <span style="color: #7590db;">oldstate</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<blockquote>
<p>
a call to pthread_cancel doesn’t wait for a thread to terminate. In the default case, a thread will continue to execute after a cancellation request is made until the thread reaches a cancellation point.
</p>


<p>
When the state is set to PTHREAD_CANCEL_DISABLE, a call to pthread_cancel will not kill the thread. Instead, the cancellation request remains pending for the thread. When the state is enabled again, the thread will act on any pending cancellation requests at the next cancellation point.
</p>
</blockquote>

<p>
add you own cancellation points
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_testcancel</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
Cancel the pending and enbaled cancellation request, no effect when cancellation is disabled.
</p>

<p>
change the cancellation type
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_setcanceltype</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">type</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #7590db;">oldtype</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
type: PTHREAD_CANCEL_DEFERRED, PTHREAD_CANCEL_ASYNCHRONOUS
</p>
</div>
</div>
<div id="outline-container-orgba8f574" class="outline-4">
<h4 id="orgba8f574"><span class="done DONE">DONE</span> 12.8 Threads and Signals</h4>
<div class="outline-text-4" id="text-orgba8f574">
<p>
function like <code>sigprocmask</code>, but works with threads and returns error number instead:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_sigmask</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">how</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">set</span>,
                    <span style="color: #ce537a; font-weight: bold;">sigset_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">oset</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>
<p>
how values:
</p>
<ul class="org-ul">
<li>SIG_BLOCK</li>
<li>SIG_SETMASK</li>
<li><p>
SIG_UNBLOCK
</p>

<p>
wait one or more signals:
</p></li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sigwait</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">siget_t</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">set</span>, <span style="color: #ce537a; font-weight: bold;">int</span> *<span style="color: #4f97d7; font-weight: bold;">restrict</span> <span style="color: #7590db;">signop</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<p>
function like <code>kill</code>:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">signal.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_kill</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">thread</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 102: </span>Figure 12.16 Synchronous signal handling</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig12.16.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-27</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes81 <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    threads protect flag via mutex</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span>      <span style="color: #7590db;">quitflag</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">set nonzero by thread</span>
<span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">mask</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">lock</span>    = PTHREAD_MUTEX_INITIALIZER;
<span style="color: #ce537a; font-weight: bold;">pthread_cond_t</span>  <span style="color: #7590db;">waitloc</span> = PTHREAD_COND_INITIALIZER;

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>, <span style="color: #7590db;">signo</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err = sigwait<span style="color: #2d9574;">(</span>&amp;mask, &amp;signo<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"sigwait failed"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">case</span> SIGINT:
                printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"\ninterrupt\n"</span><span style="color: #67b11d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> SIGQUIT:
                pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock<span style="color: #67b11d;">)</span>;
                quitflag = <span style="color: #a45bad;">1</span>;
                pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock<span style="color: #67b11d;">)</span>;
                pthread_cond_signal<span style="color: #67b11d;">(</span>&amp;waitloc<span style="color: #67b11d;">)</span>;
                <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;

            <span style="color: #4f97d7; font-weight: bold;">default</span>:
                printf<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"unexpected signal %s\n"</span>, strsignal<span style="color: #b1951d;">(</span>signo<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>;
                exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>  <span style="color: #7590db;">oldmask</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span>;

    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;mask, SIGINT<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;mask, SIGQUIT<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_sigmask<span style="color: #67b11d;">(</span>SIG_BLOCK, &amp;mask, &amp;oldmask<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;lock<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>quitflag == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        pthread_cond_wait<span style="color: #2d9574;">(</span>&amp;waitloc, &amp;lock<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;lock<span style="color: #bc6ec5;">)</span>;

    quitflag = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigprocmask<span style="color: #2d9574;">(</span>SIG_SETMASK, &amp;oldmask, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"SIG_SETMASK error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org03a7263" class="outline-4">
<h4 id="org03a7263"><span class="done DONE">DONE</span> 12.9 Threads and fork</h4>
<div class="outline-text-4" id="text-org03a7263">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">pthread_atfork</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">prepare</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">parent</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #bc6ec5;">)</span>,
                   <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">child</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: 0 if OK, error number on failure</span>
</pre>
</div>

<ul class="org-ul">
<li><b>prepare</b> called before <code>fork</code> creates the child process</li>
<li><b>parent</b> called in parent after <code>fork</code> has created the child but before returned</li>
<li><b>child</b> called in child before returning</li>
</ul>


<p>
<b>the child will get a copy of all locks that the parent defined, but in new memory</b>
</p>
<ol class="org-ol">
<li>The parent acquired all its locks.</li>
<li>The child acquired all its locks.</li>
<li>The parent released its locks.</li>
<li>The child relased its locks.</li>
</ol>


<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 103: </span>Figure 12.17 pthread_atfork example</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig12.17.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-27</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes81 <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    pthread_atfork example</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">lock1</span> = PTHREAD_MUTEX_INITIALIZER;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">lock2</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">prepare</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"preparing locks ...\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't lock lock1 in the prepare handler"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_lock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't lock lock2 in the prepare handler"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">parent</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent unlocking locks...\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't unlock lock1 in parent handler"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't unlock lock2 in parent handler"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">child</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>;

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"child unlocking locks...\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock1<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't unlock lock1 in child handler"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;lock2<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_cont<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't unlock lock2 in child handler"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"thread started...\n"</span><span style="color: #bc6ec5;">)</span>;
    pause<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>     <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span> <span style="color: #7590db;">tid</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_atfork<span style="color: #67b11d;">(</span>prepare, parent, child<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_exit<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't install fork handlers"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_create<span style="color: #67b11d;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_exit<span style="color: #bc6ec5;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #bc6ec5;">)</span>;

    sleep<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span>;
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"parent about to fork...\n"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #bc6ec5;">(</span>fork<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">case</span> -<span style="color: #a45bad;">1</span>:
            err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork failed"</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">case</span> <span style="color: #a45bad;">0</span>:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child returned from fork\n"</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">default</span>:
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent returned from fork\n"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>


<p>
<b>drawbacks</b>:
</p>
<blockquote>
<ul class="org-ul">
<li>no good way to reinitialize the state for more complex synchronization like conditioon and barriers.</li>
<li>some implementations of error-checking mutexes will generate errors when the child fork handler tries to unlock a mutex that was locked by the parent</li>
<li>recursive mutexes can't be cleand up in the child fork handler, because there is no way to determine the number of times one has been locked</li>
<li>if child process are allowed to call only async-singal safe functions, then the child fork handler shouldn't even be able to clean up synchronization objects, because none of the functions are used to manipulate them are async-signal safe.</li>
<li>if an application calls fork in a signal handler(which is legal, because fork is async-signal safe), then the fork handlers registered by <code>pthread_atfork</code> can only async-signal safe functions, or else the results are undefined.</li>
</ul>
</blockquote>
</div>
</div>

<div id="outline-container-org5a11998" class="outline-4">
<h4 id="org5a11998"><span class="done DONE">DONE</span> 12.10 Threads and I/O</h4>
<div class="outline-text-4" id="text-org5a11998">
<p>
use <code>pread/pwrite</code> in Chapter 3 to solve I/O at different record
</p>
</div>
</div>
<div id="outline-container-orgca197a5" class="outline-4">
<h4 id="orgca197a5"><span class="done DONE">DONE</span> 12.11 Summary</h4>
<div class="outline-text-4" id="text-orgca197a5">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
12.1 there are duplicated prints in the file
</p>
<blockquote>
<p>
This is not a multithreading problem, as one might first guess. The standard I/O routines are indeed thread-safe. When we call fork, each process gets a copy of the standard I/O data structures. When we run the program with standard output attached to a terminal, the output is line buffered, so every time we print a line, the standard I/O library writes it to our terminal. However, if we redirect the standard output to a file, then the standard output is fully buffered. The output is written when the buffer fills or the process closes the stream. When we fork in this example, the buffer contains several printed lines not yet written, so when the parent and the child finally flush their copies of the buffer, the initial duplicate contents are written to the file.
</p>
</blockquote></li>
<li><p>
12.2 reentrant version of <code>putenv</code>
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     ex12.2.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    a thread-safe reentrant version of putenv</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span> <span style="color: #7590db;">env_mutex</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #7590db;">attr</span>;

    pthread_mutexattr_init<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
    pthread_mutexattr_settype<span style="color: #bc6ec5;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_init<span style="color: #bc6ec5;">(</span>&amp;env_mutex, &amp;attr<span style="color: #bc6ec5;">)</span>;
    pthread_mutexattr_destroy<span style="color: #bc6ec5;">(</span>&amp;attr<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">putenv_r</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">val</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">buf</span> = <span style="color: #a45bad;">NULL</span>;

    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;

    setenv<span style="color: #bc6ec5;">(</span>name, val, <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_destroy<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li><p>
12.3 a signal-blocked version of getenv
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig12.13.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-17</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    a signal-blocked version of getenv</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">limits.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXSTRINGSZ</span> <span style="color: #a45bad;">4096</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_key_t</span>  <span style="color: #7590db;">key</span>;
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">pthread_once_t</span> <span style="color: #7590db;">init_done</span> = PTHREAD_ONCE_INIT;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span>       <span style="color: #7590db;">env_mutex</span> = PTHREAD_MUTEX_INITIALIZER;

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> **<span style="color: #7590db;">environ</span>;

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">thread_init</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span> pthread_key_create<span style="color: #bc6ec5;">(</span>&amp;key, free<span style="color: #bc6ec5;">)</span>; <span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5; font-weight: bold;">getenv</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>       <span style="color: #7590db;">i</span>, <span style="color: #7590db;">len</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>     *<span style="color: #7590db;">envbuf</span>;
    <span style="color: #ce537a; font-weight: bold;">sigset_t</span>  <span style="color: #7590db;">mask</span>, <span style="color: #7590db;">omask</span>;

    sigfillset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_BLOCK, &amp;mask, &amp;omask<span style="color: #bc6ec5;">)</span>;

    pthread_once<span style="color: #bc6ec5;">(</span>&amp;init_done, thread_init<span style="color: #bc6ec5;">)</span>;
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    envbuf = <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #bc6ec5;">)</span>pthread_getspecific<span style="color: #bc6ec5;">(</span>key<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>envbuf == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        envbuf = malloc<span style="color: #2d9574;">(</span>MAXSTRINGSZ<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>envbuf == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">nil</span>;
        <span style="color: #2d9574;">}</span>
        pthread_setspecific<span style="color: #2d9574;">(</span>key, envbuf<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    len = strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; environ<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span> != <span style="color: #a45bad;">NULL</span>; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>strncmp<span style="color: #b1951d;">(</span>name, environ<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, len<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &amp;&amp; <span style="color: #67b11d;">(</span>environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span> == <span style="color: #2d9574;">'='</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            snprintf<span style="color: #67b11d;">(</span>envbuf, MAXSTRINGSZ - <span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">"%s"</span>, &amp;environ<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">][</span>len + <span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span>;
            pthread_mutex_unlock<span style="color: #67b11d;">(</span>&amp;env_mutex<span style="color: #67b11d;">)</span>;

            sigprocmask<span style="color: #67b11d;">(</span>SIG_SETMASK, &amp;omask, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span>envbuf<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

<span style="color: #a45bad;">nil</span>:
    sigprocmask<span style="color: #bc6ec5;">(</span>SIG_SETMASK, &amp;omask, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;env_mutex<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<blockquote>
<p>
The problem is that we don’t know whether any of the functions we call might unmask a signal that we’ve blocked, thereby making it possible for the function to be reentered through another signal handler.
</p>
</blockquote></li>
<li><p>
12.4 just copied the answer
</p>
<blockquote>
<p>
On FreeBSD 8.0, the program drops core. With gdb, we are able to see that the program initialization calls pthread functions, which call getenv to find the value of the LIBPTHREAD_SPINLOOPS and LIBPTHREAD_YIELDLOOPS environment variables. However, our thread-safe version of getenv calls back into the pthread library while it is in an intermediate, inconsistent state. In addition, the thread initialization functions call malloc, which, in turn, call getenv to find the value of the MALLOC_OPTIONS environment variable.
</p>

<p>
To get around this problem, we could make the reasonable assumption that program start-up is single threaded, and use a flag to indicate whether the thread initialization had been completed by our version of getenv. While this flag is false, our version of getenv can operate as the non-reentrant version does (and avoid all calls to pthread functions and malloc). Then we could provide a separate initialization function to call pthread_once, instead of calling it from inside getenv. This requires that the program call our initialization function before calling getenv. This solves our problem, because this can’t be done until the program start-up initialization completes. After the program calls our initialization function, our version of getenv operates in a thread-safe manner.
</p>
</blockquote></li>
<li>12.5 run a program within a program</li>
<li><p>
12.6 implemented sleep by using select
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     10.29.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-10-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    implementation of sleep using select</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">sleep</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">seconds</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>            <span style="color: #7590db;">n</span>;
    <span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">slept</span>;
    <span style="color: #ce537a; font-weight: bold;">time_t</span>         <span style="color: #7590db;">start</span>, <span style="color: #7590db;">end</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;

    tv.tv_sec  = seconds;
    tv.tv_usec = <span style="color: #a45bad;">0</span>;

    time<span style="color: #bc6ec5;">(</span>&amp;start<span style="color: #bc6ec5;">)</span>;
    n = select<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, &amp;tv<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>n == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
    <span style="color: #bc6ec5;">}</span>
    time<span style="color: #bc6ec5;">(</span>&amp;end<span style="color: #bc6ec5;">)</span>;
    slept = end - start;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>slept &gt;= seconds<span style="color: #bc6ec5;">)</span> <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> seconds - slept;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
<li>12.7 unsafe to do that, because we hardly acquire and release the mutex protected condition variable</li>
<li><p>
12.8 use select instead?
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig.8.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-15</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    Using a recursive mutex</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/time.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">makethread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #4f97d7;">)</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*to_fn<span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">function</span>
    <span style="color: #ce537a; font-weight: bold;">void</span> *         <span style="color: #7590db;">to_arg</span>;   <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">argument</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">to_wait</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">time to wait</span>
<span style="color: #4f97d7;">}</span>;

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">SECTOUSEC</span> <span style="color: #a45bad;">1000000</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">seconds to nanoseconds</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">clock_nanosleep</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">ID</span>, <span style="color: #7590db;">FL</span>, <span style="color: #7590db;">REQ</span>, <span style="color: #7590db;">REM</span><span style="color: #4f97d7;">)</span> nanosleep<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">(</span>REQ<span style="color: #bc6ec5;">)</span>, <span style="color: #bc6ec5;">(</span>REM<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #bc6ec5;">#if</span><span style="color: #bc6ec5;">n</span><span style="color: #bc6ec5;">def</span> CLOCK_REALTIME
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">CLOCK_REALTIME</span> <span style="color: #a45bad;">0</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">USECTONSEC</span>     <span style="color: #a45bad;">1000</span>  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">microseconds to nanoseconds</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">clock_gettime</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">id</span>, <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">tsp</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timeval</span> <span style="color: #7590db;">tv</span>;

    gettimeofday<span style="color: #bc6ec5;">(</span>&amp;tv, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    tsp-&gt;tv_sec  = tv.tv_sec;
    tsp-&gt;tv_nsec = tv.tv_usec * USECTONSEC
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#endif</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">timeout_helper</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #7590db;">tip</span>;

    tip = <span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #bc6ec5;">)</span>arg;
    clock_nanosleep<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, <span style="color: #a45bad;">0</span>, &amp;tip-&gt;to_wait, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #bc6ec5;">(</span>*tip-&gt;to_fn<span style="color: #bc6ec5;">)(</span>tip-&gt;to_arg<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>arg<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">timeout</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> *<span style="color: #7590db;">when</span>, <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5;">(</span>*<span style="color: #bc6ec5; font-weight: bold;">func</span><span style="color: #bc6ec5;">)(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5;">)</span>, <span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">now</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span> *<span style="color: #7590db;">tip</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span>;

    clock_gettime<span style="color: #bc6ec5;">(</span>CLOCK_REALTIME, &amp;now<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>when-&gt;tv_sec &gt; now.tv_sec<span style="color: #2d9574;">)</span> ||
        <span style="color: #2d9574;">(</span>when-&gt;tv_sec == now.tv_sec &amp;&amp; when-&gt;tv_nsec &gt; now.tv_nsec<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        tip = malloc<span style="color: #2d9574;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">to_info</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>tip != <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            tip-&gt;to_fn          = func;
            tip-&gt;to_arg         = arg;
            tip-&gt;to_wait.tv_sec = when-&gt;tv_sec - now.tv_sec;
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>when-&gt;tv_nsec &gt;= now.tv_nsec<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_usec = when-&gt;tv_nsec / <span style="color: #a45bad;">1000</span> - now.tv_nsec;
            <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #67b11d;">{</span>
                tip-&gt;to_wait.tv_sec--;
                tip-&gt;to_wait.tv_usec =
                    SECTOUSEC - now.tv_usec + when-&gt;tv_nsec / <span style="color: #a45bad;">1000</span>;
            <span style="color: #67b11d;">}</span>

            select<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">NULL</span>, &amp;tip-&gt;to_wait<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #bc6ec5;">(</span>*func<span style="color: #bc6ec5;">)(</span>arg<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">pthread_mutexattr_t</span> <span style="color: #7590db;">attr</span>;
<span style="color: #ce537a; font-weight: bold;">pthread_mutex_t</span>     <span style="color: #7590db;">mutex</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">retry</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    pthread_mutex_lock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;

    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>             <span style="color: #7590db;">err</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">condition</span> = <span style="color: #a45bad;">0</span>, <span style="color: #7590db;">arg</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">timespec</span> <span style="color: #7590db;">when</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutexattr_init<span style="color: #67b11d;">(</span>&amp;attr<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"pthread_mutexattr_init failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutexattr_settype<span style="color: #67b11d;">(</span>&amp;attr, PTHREAD_MUTEX_RECURSIVE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> !=
        <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't set recursive type"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_mutex_init<span style="color: #67b11d;">(</span>&amp;mutex, &amp;attr<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create recursive mutex"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>condition == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        clock_gettime<span style="color: #2d9574;">(</span>CLOCK_REALTIME, &amp;when<span style="color: #2d9574;">)</span>;
        when.tv_sec += <span style="color: #a45bad;">10</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">10 seconds after now</span>
        timeout<span style="color: #2d9574;">(</span>&amp;when, retry, <span style="color: #67b11d;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #67b11d;">)(</span><span style="color: #b1951d;">(</span><span style="color: #ce537a; font-weight: bold;">unsigned</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #b1951d;">)</span>arg<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    pthread_mutex_unlock<span style="color: #bc6ec5;">(</span>&amp;mutex<span style="color: #bc6ec5;">)</span>;

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga5aef9f" class="outline-3">
<h3 id="orga5aef9f"><span class="done DONE">DONE</span> Chapter 13. Daemon Processes <code>[8/8]</code></h3>
<div class="outline-text-3" id="text-orga5aef9f">
</div>
<div id="outline-container-orgc645d93" class="outline-4">
<h4 id="orgc645d93"><span class="done DONE">DONE</span> 13.1 Introduction</h4>
<div class="outline-text-4" id="text-orgc645d93">
<p>
A process live for a long time in the background.
</p>
</div>
</div>
<div id="outline-container-orgff2ec7f" class="outline-4">
<h4 id="orgff2ec7f"><span class="done DONE">DONE</span> 13.2 Daemon Characteristics</h4>
<div class="outline-text-4" id="text-orgff2ec7f">
<div class="org-src-container">
<pre class="src src-sh">ps -axj
</pre>
</div>

<blockquote>
<ul class="org-ul">
<li>The kswapd daemon is also known as pageout daemon. It supports the virtual memory subsystem by writing dirty pages to disk slowly over time, so the pages can be reclamed.</li>
<li>The flush daemon fluhes dirty pages to disk when available memory reaches a configured minimul thrshold.</li>
<li>The sync_supers daemon periodically fluhes the system metadata to disk.</li>
<li>The jbd daemon helps implement the journal in the ext4 file system.</li>
</ul>
</blockquote>

<blockquote>
<p>
Process 1 is uaually init (launchd on Mac OS X). It is a system daemon responsible for, among other things, starting system services specific to various run levels.
</p>

<p>
The rpcbind provides the service of mapping RPC(Remote Procedure Call) program numbers to network port. The rsyslogd daemon is available to any program to log system messages for administrator.
</p>

<p>
inetd daemon listens on the system's network interfaces for incoming requests for various network servers. The nfsd, nfsiod, lockd, rpciod, rpc.idmapd, rpc.statd, and rpc.mountd daemons provide support for the Network File System(NFS). The fist four are <b>kernel</b> daemons, while the last three are <b>user-level</b> daemons
</p>

<p>
The cron daemon executes commands at regularly scheduled dates and times.
</p>

<p>
most of daemons run with superuser(root) privileges.
</p>

<p>
the parent of the user-level daemons is the init process.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org58d84c3" class="outline-4">
<h4 id="org58d84c3"><span class="done DONE">DONE</span> 13.3 Coding Rules</h4>
<div class="outline-text-4" id="text-org58d84c3">
<p>
basic rules to coding a daemon prevent unwanted interactions from happening.
</p>
<ol class="org-ol">
<li>Call unmask to set the file mode createion mask to a known value, usually 0.</li>
<li>Call fork and have the parent exit.</li>
<li>Call setsid to create a new session.
<ol class="org-ol">
<li>becomes the leader of a new session</li>
<li>becomes the leader of a new process group</li>
<li>is disassociated from its controlling terminal</li>
</ol></li>
<li>Change the current working directory to the root directory.</li>
<li>Unneeded file descriptors should be closed</li>
<li>Some daemons open file descriptors 0, 1 and 2 to /dev/null so that any library routines that try to read from standard input or write to standard output or standard error will have no effect.</li>
</ol>


<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 104: </span>Figure 13.1 initialize a daemon process</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig13.1.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-28</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    a function that can be called from a program</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *             that wants to initialize itsef as a daemon</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/resource.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">daemonize</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">cmd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">i</span>, <span style="color: #7590db;">fd0</span>, <span style="color: #7590db;">fd1</span>, <span style="color: #7590db;">fd2</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>            <span style="color: #7590db;">pid</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">rlimit</span>    <span style="color: #7590db;">rl</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">sa</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>cmd == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        cmd = __progname;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">clear file creation mask.</span>
    umask<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">get maximum number of file descriptors</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>getrlimit<span style="color: #2d9574;">(</span>RLIMIT_NOFILE, &amp;rl<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: can't get file limit"</span>, cmd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">become a session leader to lose controlling TTY.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: can't fork"</span>, cmd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span>
    <span style="color: #bc6ec5;">}</span>

    setsid<span style="color: #bc6ec5;">()</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">ensure future opens won't allocate controlling TTYs.</span>
    sa.sa_handler = SIG_IGN;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask<span style="color: #bc6ec5;">)</span>;
    sa.sa_flags = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGHUP, &amp;sa, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>
        err_quit<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s: can't ignore SIGHUP"</span>, cmd<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: can't fork"</span>, cmd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">parent</span>
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">change the current working directory to the root so</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">we won't prevent file systems from being unmounted.</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chdir<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"/"</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: can't change directory to /"</span>, cmd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    chroot<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"/"</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">close all open file descriptors</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>rl.rlim_max == RLIM_INFINITY<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        rl.rlim_max = <span style="color: #a45bad;">1024</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; rl.rlim_max; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        close<span style="color: #2d9574;">(</span>i<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">attach file descriptors 0, 1 and 2 to /dev/null</span>
    fd0 = open<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"/dev/null"</span>, O_RDWR<span style="color: #bc6ec5;">)</span>;
    fd1 = dup<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    fd2 = dup<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">initialize the log file</span>
    openlog<span style="color: #bc6ec5;">(</span>cmd, LOG_CONS, LOG_DAEMON<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd0 != <span style="color: #a45bad;">0</span> || fd1 != <span style="color: #a45bad;">1</span> || fd2 != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"unexpected file descriptors %d %d %d"</span>, fd0, fd1, fd2<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgb62e93f" class="outline-4">
<h4 id="orgb62e93f"><span class="done DONE">DONE</span> 13.4 Error Logging</h4>
<div class="outline-text-4" id="text-orgb62e93f">
<p>
three ways to generate log messages:
</p>
<ul class="org-ul">
<li>Kernel routines can call the log function.</li>
<li>Most user processes (daemons) call the syslog(3) function to generate log messages.</li>
<li>A user process on this host, or on some other host that is connected to this host by a TCP/IP network can send log messages to UDP port 514.</li>
</ul>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">openlog</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ident</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">option</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">facility</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">syslog</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">priority</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">fmt</span>, ...<span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">closelog</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">setlogmask</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">maskpri</span><span style="color: #4f97d7;">)</span>;
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: previous log priority mask value</span>
</pre>
</div>
<p>
calling openlog is optional. the first time syslog called automatically calls openlog.
</p>

<p>
calling closelog is also optional.
</p>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 14:</span> Figure 13.3 The <i>option</i> argument for <code>openlog</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left"><i>option</i></th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_CONS</td>
<td class="org-left">ifthe log message can't be sent to syslog via the UNIX domain datagram,</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">the message is writen to the console instead</td>
</tr>

<tr>
<td class="org-left">LOG_NDELAY</td>
<td class="org-left">Open the UNIX domain datagram socket to the syslogd daemon immediately;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">don't wait until the frst message is logged.</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">Normally, the socket is not opened until the first message is logged.</td>
</tr>

<tr>
<td class="org-left">LOG_NOWAIT</td>
<td class="org-left">Do not wait for child processes that might have been created in the process</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">of logging message. The prevents conflicts with applications that catch <b>SIGCHLD</b>,</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">since the application might have retrieved the child's status by the time that syslog calls <code>wait</code></td>
</tr>

<tr>
<td class="org-left">LOG_ODELAY</td>
<td class="org-left">Delay the opening ofthe connection to the syslogd daemon until the first message is logged.</td>
</tr>

<tr>
<td class="org-left">LOG_PERROR</td>
<td class="org-left">write the log message to standard error in addition to sending it to syslogd</td>
</tr>

<tr>
<td class="org-left">LOG_PID</td>
<td class="org-left">Log the process ID with each message. This is intended fr daemons that fork a child process</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">to handle different requests (as compared to daemons, such as syslogd, that never call fork)</td>
</tr>
</tbody>
</table>

<p>
<b><i>format</i> and any other arguments are passed to vsprintf function for formatting. %m in <i>format</i> are first replaced with the error message string(strerror)</b>
</p>

<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<pre class="src src-c">openlog<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"lpd"</span>, LOG_PID, LOG_LPR<span style="color: #4f97d7;">)</span>;
<span style="color: #bc6ec5; font-weight: bold;">syslog</span><span style="color: #4f97d7;">(</span>LOG_ERR, <span style="color: #2d9574;">"open error for %s: %m"</span>, filename<span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
if we had not called <code>openlog</code>, the second call could have been
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5; font-weight: bold;">syslog</span><span style="color: #4f97d7;">(</span>LOG_ERR | LOG_LPR, <span style="color: #2d9574;">"open error for %s: %m"</span>, filename<span style="color: #4f97d7;">)</span>;
</pre>
</div></li>
</ul>


<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 15:</span> Figure 13.4 The <i>facility</i> argument for <code>openlog</code></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">facility</th>
<th scope="col" class="org-left">XSI</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_AUDIT</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the audit fcility</td>
</tr>

<tr>
<td class="org-left">LOG_AUTH</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">authorization programs: login, su, getty, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_AUTHPRIV</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">same as LOG_AUTH, but logged to fle with restricted permissions</td>
</tr>

<tr>
<td class="org-left">LOG_CONSOLE</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">messages written to /dev/console</td>
</tr>

<tr>
<td class="org-left">LOG_CRON</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">cron and at</td>
</tr>

<tr>
<td class="org-left">LOG_DAEMON</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">system daemons: inetd, routed, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_FTP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the FTP daemon (ftpd)</td>
</tr>

<tr>
<td class="org-left">LOG_KERN</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">messages generated by the kernel</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL0</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL1</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL2</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL3</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL4</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL5</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL6</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LOCAL7</td>
<td class="org-left">*</td>
<td class="org-left">reserved for local use</td>
</tr>

<tr>
<td class="org-left">LOG_LPR</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">line printer system: lpd, lpc, &#x2026;</td>
</tr>

<tr>
<td class="org-left">LOG_MAIL</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the mail system</td>
</tr>

<tr>
<td class="org-left">LOG_NEWS</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the network time protocol system</td>
</tr>

<tr>
<td class="org-left">LOG_SECURITY</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the security subsystem</td>
</tr>

<tr>
<td class="org-left">LOG_SYSLOG</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the syslogd daemon itself</td>
</tr>

<tr>
<td class="org-left">LOG_USER</td>
<td class="org-left">*</td>
<td class="org-left">message from other user processes(deafult)</td>
</tr>

<tr>
<td class="org-left">LOG_UUCP</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">the UUCP system</td>
</tr>
</tbody>
</table>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 16:</span> Figure 13.5 The <code>syslog</code> <i>levels</i> (ordered)</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">level</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">LOG_EMERG</td>
<td class="org-left">emergency (system is unusuable) (highest priority)</td>
</tr>

<tr>
<td class="org-left">LOG_ALERT</td>
<td class="org-left">condition that must be fxed immediately</td>
</tr>

<tr>
<td class="org-left">LOG_CRIT</td>
<td class="org-left">critical condition (e.g., hard device error)</td>
</tr>

<tr>
<td class="org-left">LOG_ERR</td>
<td class="org-left">error condition</td>
</tr>

<tr>
<td class="org-left">LOG_WARNING</td>
<td class="org-left">warning condition</td>
</tr>

<tr>
<td class="org-left">LOG_NOTICE</td>
<td class="org-left">normal, but significant condition</td>
</tr>

<tr>
<td class="org-left">LOG_INFO</td>
<td class="org-left">infrmational message</td>
</tr>

<tr>
<td class="org-left">LOG_DEBUG</td>
<td class="org-left">debug message(lowest priority)</td>
</tr>
</tbody>
</table>


<p>
syslog that handles variable argument lists
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdarg.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">vsyslog</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">priority</span>, <span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">format</span>, <span style="color: #ce537a; font-weight: bold;">va_list</span> <span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org6b1d987" class="outline-4">
<h4 id="org6b1d987"><span class="done DONE">DONE</span> 13.5 Single-Instance Daemons</h4>
<div class="outline-text-4" id="text-org6b1d987">
<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 105: </span>Figure 13.6 Ensure that only one copy of a daemon is running</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig13.6.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-29</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    figure 13.6</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  illustrates the use of file and record locking</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *  to ensure that only one coyp of a daemon is running</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdio.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">stdlib.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">string.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/stat.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">unistd.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">LOCKFILE</span> <span style="color: #2d9574;">"/var/run/daemon.pid"</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">LOCKMODE</span> <span style="color: #4f97d7;">(</span>S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH<span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">lockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">already_running</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>  <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">16</span><span style="color: #bc6ec5;">]</span>;

    fd = open<span style="color: #bc6ec5;">(</span>LOCKFILE, O_RDWR | O_CREAT, LOCKFILE<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fd &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"can't open %s: %m"</span>, LOCKFILE<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>lockfile<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>errno == EACCES || errno == EAGAIN<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            close<span style="color: #67b11d;">(</span>fd<span style="color: #67b11d;">)</span>;
            <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #67b11d;">(</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"can't lock %s: %m"</span>, LOCKFILE<span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    ftruncate<span style="color: #bc6ec5;">(</span>fd, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    sprintf<span style="color: #bc6ec5;">(</span>buf, <span style="color: #2d9574;">"%ld"</span>, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    write<span style="color: #bc6ec5;">(</span>fd, <span style="color: #2d9574;">"%ld"</span>, strlen<span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span> + <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org3b813d5" class="outline-4">
<h4 id="org3b813d5"><span class="done DONE">DONE</span> 13.6 Daemon Conventions</h4>
<div class="outline-text-4" id="text-org3b813d5">
<ul class="org-ul">
<li>daemon's lock file is usually stored in /var/run. (might need superuser permissions to create a file here.)</li>
<li>daemon's configuration options usually stored in /etc</li>
<li>daemons can be started from the command line , but they are usually started from one of the system initialization scripts</li>
<li>daemon read configuration file when it starts, but usually won't look at it again.</li>
</ul>


<ul class="org-ul">
<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 106: </span>Figure 13.7 Daemon reredaing configuration files</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig13.7.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-11-30</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    one way a daemon can reread its configuration file.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">sigset_t</span> <span style="color: #7590db;">mask</span>;

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">already_running</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">reread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">...</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">thr_fn</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">err</span>, <span style="color: #7590db;">signo</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err = sigwait<span style="color: #2d9574;">(</span>&amp;mask, &amp;signo<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            syslog<span style="color: #67b11d;">(</span>LOG_ERR, <span style="color: #2d9574;">"sigwait failed: %m"</span><span style="color: #67b11d;">)</span>;
            exit<span style="color: #67b11d;">(</span>EXIT_FAILURE<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">switch</span> <span style="color: #2d9574;">(</span>signo<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">case</span> SIGHUP:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2d9574;">"Re-reading configuration file"</span><span style="color: #67b11d;">)</span>;
                reread<span style="color: #67b11d;">()</span>;
                <span style="color: #4f97d7; font-weight: bold;">break</span>;

            <span style="color: #4f97d7; font-weight: bold;">case</span> SIGTERM:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2d9574;">"got SIGTERM; exiting"</span><span style="color: #67b11d;">)</span>;
                exit<span style="color: #67b11d;">(</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span>;

            <span style="color: #4f97d7; font-weight: bold;">default</span>:
                syslog<span style="color: #67b11d;">(</span>LOG_INFO, <span style="color: #2d9574;">"unexpected signal: %d\n"</span>, signo<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>              <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>        <span style="color: #7590db;">tid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>            *<span style="color: #7590db;">cmd</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span> <span style="color: #7590db;">sa</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>cmd = strchr<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">'/'</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        cmd = argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        cmd++;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">become a dameon</span>
    daemonize<span style="color: #bc6ec5;">(</span>cmd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">make sure only one copy of the daemon is running</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>already_running<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"daemon already running"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">restore SIGHUP default and block all signals.</span>
    sa.sa_handler = SIG_DFL;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask<span style="color: #bc6ec5;">)</span>;
    sa.sa_flags = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>sigaction<span style="color: #2d9574;">(</span>SIGHUP, &amp;sa, <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"%m: can't restore SIGHUP default."</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    sigfillset<span style="color: #bc6ec5;">(</span>&amp;mask<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>err = pthread_sigmask<span style="color: #67b11d;">(</span>SIG_BLOCK, &amp;mask, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"SIG_BLOCK error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">create a thread to handle SIGHUP and SIGTERM</span>
    err = pthread_create<span style="color: #bc6ec5;">(</span>&amp;tid, <span style="color: #a45bad;">NULL</span>, thr_fn, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>err != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_exit<span style="color: #2d9574;">(</span>err, <span style="color: #2d9574;">"can't create thread"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li><p>
Example:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 107: </span>Figure 13.8 Alternative implementation of daemon rereading configuration files</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig13.8.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-12-01</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    single-threaded daemon can catch SIGHUP and reread its configuration file.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">syslog.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>


<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">lockfile</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span><span style="color: #4f97d7;">)</span>;
<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">already_running</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">reread</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">...</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sigterm</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    syslog<span style="color: #bc6ec5;">(</span>LOG_INFO, <span style="color: #2d9574;">"got SIGTERM; exiting"</span><span style="color: #bc6ec5;">)</span>;
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">sighup</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">signo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    syslog<span style="color: #bc6ec5;">(</span>LOG_INFO, <span style="color: #2d9574;">"Re-reading configuration file"</span><span style="color: #bc6ec5;">)</span>;
    reread<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">char</span>             *<span style="color: #7590db;">cmd</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sigaction</span>  <span style="color: #7590db;">sa</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>cmd = strchr<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">0</span><span style="color: #b1951d;">]</span>, <span style="color: #2d9574;">'/'</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>
        cmd = argv<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">else</span>
        cmd++;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">become a daemon</span>
    daemonize<span style="color: #bc6ec5;">(</span>cmd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>already_running<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"daemon already running"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sa.sa_handler = sigterm;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask, SIGHUP<span style="color: #bc6ec5;">)</span>;
    sa.sa_flags = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>sigaction<span style="color: #67b11d;">(</span>SIGTERM, &amp;sa, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"can't catch SIGTERM: %m"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    sa.sa_handler = sighup;
    sigemptyset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask<span style="color: #bc6ec5;">)</span>;
    sigaddset<span style="color: #bc6ec5;">(</span>&amp;sa.sa_mask, SIGTERM<span style="color: #bc6ec5;">)</span>;
    sa.sa_flags = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>sigaction<span style="color: #67b11d;">(</span>SIGHUP, &amp;sa, <span style="color: #a45bad;">NULL</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        syslog<span style="color: #2d9574;">(</span>LOG_ERR, <span style="color: #2d9574;">"can't catch SIGHUP: %m"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span>EXIT_FAILURE<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgd441687" class="outline-4">
<h4 id="orgd441687"><span class="done DONE">DONE</span> 13.7 Client-Server Model</h4>
<div class="outline-text-4" id="text-orgd441687">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 108: </span>Figure 13.9 Set close-on-exec flag</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     fig13.9.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-12-01</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    solve multiple file descriptors may left open</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">set_cloexec</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">val</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>val = fcntl<span style="color: #67b11d;">(</span>fd, FD_GETFD, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    val |= FD_CLOEXEC;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fcntl<span style="color: #2d9574;">(</span>fd, FD_SETFD, val<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org01f6fb3" class="outline-4">
<h4 id="org01f6fb3"><span class="done DONE">DONE</span> 13.8 Summary</h4>
<div class="outline-text-4" id="text-org01f6fb3">
<ul class="org-ul">
<li>Exercises
<ul class="org-ul">
<li><p>
13.1 actually I didn't find there is anything wrong here, but the answer is:
</p>
<blockquote>
<p>
If it calls chroot, the process will not be able to open /dev/log. The solution is for the daemon to call openlog with an option of LOG_NDELAY, before calling chroot. This opens the special device file (the UNIX domain datagram socket), yielding a descriptor that is still valid, even after a call to chroot. This scenario is encountered in daemons, such as ftpd (the File Transfer Protocol daemon), that specifically call chroot for security reasons but still need to call syslog to log error conditions.
</p>
</blockquote></li>
<li>13.2 syslog did not to create a session</li>
<li>&#x2026;</li>
<li><p>
13.4 code below
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 109: </span>call daemon and get login name</label><pre class="src src-c"><span style="color: #2aa1ae; background-color: #292e34;">/**</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @file     ex13.3.c</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @date     2019-12-01</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @author   whiothes <a href="mailto:whiothes81%40gmail.com">&lt;whiothes81@gmail.com&gt;</a></span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @version  1.0</span>
<span style="color: #2aa1ae; background-color: #292e34;"> *   @brief    call daemonize then call getlogin</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">extern</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">__progname</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">FILE</span> *<span style="color: #7590db;">fp</span>   = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">tdir</span> = <span style="color: #a45bad;">NULL</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">out</span><span style="color: #bc6ec5;">[</span>FILENAME_MAX<span style="color: #bc6ec5;">]</span> = <span style="color: #bc6ec5;">{</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">}</span>;

    daemonize<span style="color: #bc6ec5;">(</span>__progname<span style="color: #bc6ec5;">)</span>;
    name = getlogin<span style="color: #bc6ec5;">()</span>;

    tdir = getenv<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"TMPDIR"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>tdir<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        snprintf<span style="color: #2d9574;">(</span>out, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>out<span style="color: #67b11d;">)</span>, <span style="color: #2d9574;">"%s/getlog.txt"</span>, tdir<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        snprintf<span style="color: #2d9574;">(</span>out, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>out<span style="color: #67b11d;">)</span>, <span style="color: #2d9574;">"/var/tmp/getlog.txt"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    fp = fopen<span style="color: #bc6ec5;">(</span>out, <span style="color: #2d9574;">"w+"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fp != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>name == <span style="color: #a45bad;">NULL</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            fprintf<span style="color: #67b11d;">(</span>fp, <span style="color: #2d9574;">"null"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            fprintf<span style="color: #67b11d;">(</span>fp, <span style="color: #2d9574;">"login name: %s\n"</span>, name<span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    fclose<span style="color: #bc6ec5;">(</span>fp<span style="color: #bc6ec5;">)</span>;
    fp = <span style="color: #a45bad;">NULL</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org75e585d" class="outline-3">
<h3 id="org75e585d"><span class="todo TODO">TODO</span> Chapter 14. Advanced I/O <code>[4/9]</code></h3>
<div class="outline-text-3" id="text-org75e585d">
</div>
<div id="outline-container-org441fab0" class="outline-4">
<h4 id="org441fab0"><span class="done DONE">DONE</span> 14.1 Introduction</h4>
</div>
<div id="outline-container-org6e80b83" class="outline-4">
<h4 id="org6e80b83"><span class="done DONE">DONE</span> 14.2 Nonblocking I/O</h4>
<div class="outline-text-4" id="text-org6e80b83">
<p>
slow system calls can block forever. include:
</p>
<ul class="org-ul">
<li>reads if data isn't present with certain file types</li>
<li>writes if data isn't present with certain file types</li>
<li>open conditions</li>
<li>mandatory record locking</li>
<li><code>ioctl</code> options</li>
<li>IPC</li>
</ul>


<p>
two way to specify nonblocking I/O:
</p>
<ol class="org-ol">
<li><code>open</code> to get the descriptor, specify <code>O_NONBLOCK</code> flag</li>
<li>call <code>fcntl</code> to trun on the <code>O_NONBLOCK</code> if already open.</li>
</ol>


<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 110: </span>Figure 14.1 Large nonblocking write</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">buf</span><span style="color: #4f97d7;">[</span><span style="color: #a45bad;">50000</span><span style="color: #4f97d7;">]</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">ntowrite</span>, <span style="color: #7590db;">nwrite</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">ptr</span>;

    ntowrite = read<span style="color: #bc6ec5;">(</span>STDIN_FILENO, buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    fprintf<span style="color: #bc6ec5;">(</span>stderr, <span style="color: #2d9574;">"read %d bytes\n"</span>, ntowrite<span style="color: #bc6ec5;">)</span>;

    set_fl<span style="color: #bc6ec5;">(</span>STDOUT_FILENO, O_NONBLOCK<span style="color: #bc6ec5;">)</span>;

    ptr = buf;

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>ntowrite &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno  = <span style="color: #a45bad;">0</span>;
        nwrite = write<span style="color: #2d9574;">(</span>STDOUT_FILENO, ptr, ntowrite<span style="color: #2d9574;">)</span>;
        fprintf<span style="color: #2d9574;">(</span>stderr, <span style="color: #2d9574;">"nwrite = %d, errno = %d\n"</span>, nwrite, errno<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>nwrite &gt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            ptr += nwrite;
            ntowrite -= nwrite;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    clr_fl<span style="color: #bc6ec5;">(</span>STDOUT_FILENO, O_NONBLOCK<span style="color: #bc6ec5;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">clear nonblocking */</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orga33c554" class="outline-4">
<h4 id="orga33c554"><span class="done DONE">DONE</span> 14.3 Record Locking</h4>
<div class="outline-text-4" id="text-orga33c554">
<p>
Record locking is the term normally used to describe the ability of a process to prevent other processes from modifying a region of a file while the first process is reading or modifying that portion of the file
</p>
<ul class="org-ul">
<li>1. History</li>
<li><p>
2. <code>fcntl</code> Record Locking
</p>
<div class="org-src-container">
<pre class="src src-sh">man <span style="color: #a45bad;">2</span> fcntl
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
Example - Deadlock <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 111: </span>Figure 14.7 Example of deadlock detection</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">lockabyte</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>, <span style="color: #ce537a; font-weight: bold;">off_t</span> <span style="color: #7590db;">offset</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>writew_lock<span style="color: #2d9574;">(</span>fd, offset, SEEK_SET, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"%s: writew_lock error"</span>, name<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"%s: got the lock, byte %lld\n"</span>, name, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>offset<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>   <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span> <span style="color: #7590db;">pid</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;">     * Create a file and write two bytes to it.</span>
<span style="color: #2aa1ae; background-color: #292e34;">     */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = creat<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"templock"</span>, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"creat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>fd, <span style="color: #2d9574;">"ab"</span>, <span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child"</span>, fd, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
        TELL_PARENT<span style="color: #2d9574;">(</span>getppid<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
        WAIT_PARENT<span style="color: #2d9574;">()</span>;
        lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"child"</span>, fd, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent"</span>, fd, <span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
        TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
        WAIT_CHILD<span style="color: #2d9574;">()</span>;
        lockabyte<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"parent"</span>, fd, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>

<li>Advisory versus Mandatory Locking
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 112: </span>Figure 14.12 Determine whether mandatory locking is supported</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/wait.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">fd</span>;
    <span style="color: #ce537a; font-weight: bold;">pid_t</span>       <span style="color: #7590db;">pid</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>        <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">5</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">statbuf</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s filename"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"open error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>write<span style="color: #2d9574;">(</span>fd, <span style="color: #2d9574;">"abcdef"</span>, <span style="color: #a45bad;">6</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">6</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fstat<span style="color: #2d9574;">(</span>fd, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fchmod<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span>statbuf.st_mode &amp; ~S_IXGRP<span style="color: #67b11d;">)</span> | S_ISGID<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fchmod error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    TELL_WAIT<span style="color: #bc6ec5;">()</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>pid = fork<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fork error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>pid &gt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write_lock<span style="color: #67b11d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write_lock error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        TELL_CHILD<span style="color: #2d9574;">(</span>pid<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>waitpid<span style="color: #67b11d;">(</span>pid, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"waitpid error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #bc6ec5;">{</span>
        WAIT_PARENT<span style="color: #2d9574;">()</span>;

        set_fl<span style="color: #2d9574;">(</span>fd, O_NONBLOCK<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>read_lock<span style="color: #67b11d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span> != -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"child: read_lock succeeded"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read_lock of already-locked region returns %d\n"</span>, errno<span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>lseek<span style="color: #67b11d;">(</span>fd, <span style="color: #a45bad;">0</span>, SEEK_SET<span style="color: #67b11d;">)</span> == -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"lseek error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>read<span style="color: #67b11d;">(</span>fd, buf, <span style="color: #a45bad;">2</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span>
            err_ret<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read failed (mandatory locking works)"</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">else</span>
            printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"read OK(no mandatory locking), buf = %2.2s\n"</span>, buf<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgee17e44" class="outline-4">
<h4 id="orgee17e44"><span class="todo TODO">TODO</span> 14.4 I/O Multiplexing</h4>
<div class="outline-text-4" id="text-orgee17e44">
</div>
<ul class="org-ul">
<li><a id="orgd3fb0eb"></a><span class="todo TODO">TODO</span> 14.4.1 <code>select</code> and <code>pselect</code> Functions<br /></li>
<li><a id="org17347f3"></a><span class="todo TODO">TODO</span> 14.4.2 <code>poll</code> Function<br /></li>
</ul>
</div>
<div id="outline-container-org3d1a16b" class="outline-4">
<h4 id="org3d1a16b"><span class="todo TODO">TODO</span> 14.5 Asynchronous I/O</h4>
<div class="outline-text-4" id="text-org3d1a16b">
</div>
<ul class="org-ul">
<li><a id="orga9a65da"></a><span class="todo TODO">TODO</span> 14.5.1 System V Asynchronous I/O<br /></li>
<li><a id="orgfb49a3e"></a><span class="todo TODO">TODO</span> 14.5.2 BSD Asynchronous I/O<br /></li>
<li><a id="org2db6deb"></a><span class="todo TODO">TODO</span> 14.5.3 POSIX Asynchronous I/O<br /></li>
</ul>
</div>
<div id="outline-container-org4eaea14" class="outline-4">
<h4 id="org4eaea14"><span class="todo TODO">TODO</span> 14.6 <code>readv</code> and <code>writev</code> Functions</h4>
</div>
<div id="outline-container-orgca96691" class="outline-4">
<h4 id="orgca96691"><span class="todo TODO">TODO</span> 14.7 <code>readn</code> and <code>writen</code> Functions</h4>
</div>
<div id="outline-container-org04940aa" class="outline-4">
<h4 id="org04940aa"><span class="done DONE">DONE</span> 14.8 Memory-Mapped I/O</h4>
<div class="outline-text-4" id="text-org04940aa">
<ul class="org-ul">
<li><p>
Example
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 113: </span>Figure 14.27 Copy a file using memory-mapped I/O</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">fcntl.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/mman.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">COPYINCR</span> <span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1024</span> * <span style="color: #a45bad;">1024</span> * <span style="color: #a45bad;">1024</span><span style="color: #4f97d7;">)</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">1GB */</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>         <span style="color: #7590db;">fdin</span>, <span style="color: #7590db;">fdout</span>;
    <span style="color: #ce537a; font-weight: bold;">void</span> *      <span style="color: #7590db;">src</span>, *<span style="color: #7590db;">dst</span>;
    <span style="color: #ce537a; font-weight: bold;">ssize_t</span>     <span style="color: #7590db;">copysz</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">sbuf</span>;
    <span style="color: #ce537a; font-weight: bold;">off_t</span>       <span style="color: #7590db;">fsz</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_quit<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"usage: %s &lt;fromfile&gt; &lt;tofile&gt;"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">0</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fdin = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span>, O_RDONLY<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open %s for reading"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fdout = open<span style="color: #67b11d;">(</span>argv<span style="color: #b1951d;">[</span><span style="color: #a45bad;">2</span><span style="color: #b1951d;">]</span>, O_RDWR | O_CREAT | O_TRUNC, FILE_MODE<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't creat %s for writing"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">2</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>fstat<span style="color: #2d9574;">(</span>fdin, &amp;sbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"fstat error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>ftruncate<span style="color: #2d9574;">(</span>fdout, sbuf.st_size<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"ftruncate error"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">while</span> <span style="color: #bc6ec5;">(</span>fsz &lt; sbuf.st_size<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>sbuf.st_size - fsz<span style="color: #67b11d;">)</span> &gt; COPYINCR<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            copysz = COPYINCR;
        <span style="color: #2d9574;">}</span> <span style="color: #4f97d7; font-weight: bold;">else</span> <span style="color: #2d9574;">{</span>
            copysz = sbuf.st_size - fsz;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>src = mmap<span style="color: #b1951d;">(</span><span style="color: #a45bad;">0</span>, copysz, PROT_READ, MAP_SHARED, fdin, fsz<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> ==
            MAP_FAILED<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"mmap error for input"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>dst = mmap<span style="color: #b1951d;">(</span><span style="color: #a45bad;">0</span>, copysz, PROT_READ | PROT_WRITE, MAP_SHARED, fdout,
                        fsz<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> == MAP_FAILED<span style="color: #2d9574;">)</span>
            err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"mmap error for output"</span><span style="color: #2d9574;">)</span>;

        memcpy<span style="color: #2d9574;">(</span>dst, src, copysz<span style="color: #2d9574;">)</span>;
        munmap<span style="color: #2d9574;">(</span>src, copysz<span style="color: #2d9574;">)</span>;
        munmap<span style="color: #2d9574;">(</span>dst, copysz<span style="color: #2d9574;">)</span>;

        fsz += copysz;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgc744c94" class="outline-4">
<h4 id="orgc744c94"><span class="todo TODO">TODO</span> 14.9 Summary</h4>
</div>
</div>
<div id="outline-container-orgc854a6f" class="outline-3">
<h3 id="orgc854a6f"><span class="todo TODO">TODO</span> Chapter 15. Interprocess Communication <code>[0/16]</code></h3>
<div class="outline-text-3" id="text-orgc854a6f">
</div>
<div id="outline-container-orge62d799" class="outline-4">
<h4 id="orge62d799"><span class="todo TODO">TODO</span> 15.1 Introduction</h4>
</div>
<div id="outline-container-org57b8a96" class="outline-4">
<h4 id="org57b8a96"><span class="todo TODO">TODO</span> 15.2 Pipes</h4>
</div>
<div id="outline-container-orgaa640c3" class="outline-4">
<h4 id="orgaa640c3"><span class="todo TODO">TODO</span> 15.3 <code>popen</code> and <code>pclose</code> Functions</h4>
</div>
<div id="outline-container-org049f0ce" class="outline-4">
<h4 id="org049f0ce"><span class="todo TODO">TODO</span> 15.4 Coprocesses</h4>
</div>
<div id="outline-container-org3a706cb" class="outline-4">
<h4 id="org3a706cb"><span class="todo TODO">TODO</span> 15.5 FIFOs</h4>
</div>
<div id="outline-container-orgf666a07" class="outline-4">
<h4 id="orgf666a07"><span class="todo TODO">TODO</span> 15.6 XSI IPC</h4>
</div>
<div id="outline-container-org281380d" class="outline-4">
<h4 id="org281380d"><span class="todo TODO">TODO</span> 15.6.1 Identifiers and Keys</h4>
</div>
<div id="outline-container-orge56e6b7" class="outline-4">
<h4 id="orge56e6b7"><span class="todo TODO">TODO</span> 15.6.2 Permission Structure</h4>
</div>
<div id="outline-container-org436c06f" class="outline-4">
<h4 id="org436c06f"><span class="todo TODO">TODO</span> 15.6.3 Configuration Limits</h4>
</div>
<div id="outline-container-org8487baf" class="outline-4">
<h4 id="org8487baf"><span class="todo TODO">TODO</span> 15.6.4 Advantages and Disadvantages</h4>
</div>
<div id="outline-container-orge6e89fc" class="outline-4">
<h4 id="orge6e89fc"><span class="todo TODO">TODO</span> 15.7 Message Queues</h4>
</div>
<div id="outline-container-org2fa6866" class="outline-4">
<h4 id="org2fa6866"><span class="todo TODO">TODO</span> 15.8 Semaphores</h4>
</div>
<div id="outline-container-orgd3d2603" class="outline-4">
<h4 id="orgd3d2603"><span class="todo TODO">TODO</span> 15.9 Shared Memory</h4>
</div>
<div id="outline-container-orga53c092" class="outline-4">
<h4 id="orga53c092"><span class="todo TODO">TODO</span> 15.10 POSIX Semaphores</h4>
</div>
<div id="outline-container-orgf4c52f6" class="outline-4">
<h4 id="orgf4c52f6"><span class="todo TODO">TODO</span> 15.11 Client-Server Properties</h4>
</div>
<div id="outline-container-org3cac4b9" class="outline-4">
<h4 id="org3cac4b9"><span class="todo TODO">TODO</span> 15.12 Summary</h4>
</div>
</div>
<div id="outline-container-orge1cdc48" class="outline-3">
<h3 id="orge1cdc48"><span class="todo TODO">TODO</span> Chapter 16. Network IPC: Sockets <code>[0/9]</code></h3>
<div class="outline-text-3" id="text-orge1cdc48">
</div>
<div id="outline-container-org251ee8f" class="outline-4">
<h4 id="org251ee8f"><span class="todo TODO">TODO</span> 16.1 Introduction</h4>
</div>
<div id="outline-container-orgbeeacb3" class="outline-4">
<h4 id="orgbeeacb3"><span class="todo TODO">TODO</span> 16.2 Socket Descriptors</h4>
</div>
<div id="outline-container-orga7fbb48" class="outline-4">
<h4 id="orga7fbb48"><span class="todo TODO">TODO</span> 16.3 Addressing</h4>
<div class="outline-text-4" id="text-orga7fbb48">
</div>
<ul class="org-ul">
<li><a id="org5b73b53"></a><span class="todo TODO">TODO</span> 16.3.1 Byte Ordering<br /></li>
<li><a id="org5dd5c9a"></a><span class="todo TODO">TODO</span> 16.3.2 Address Formats<br /></li>
<li><a id="org544b021"></a><span class="todo TODO">TODO</span> 16.3.3 Address Lookup<br /></li>
<li><a id="org1ebe47d"></a><span class="todo TODO">TODO</span> 16.3.4 Associating Addresses with Sockets<br /></li>
</ul>
</div>
<div id="outline-container-org38cba7e" class="outline-4">
<h4 id="org38cba7e"><span class="todo TODO">TODO</span> 16.4 Connection Establishment</h4>
</div>
<div id="outline-container-org8774dca" class="outline-4">
<h4 id="org8774dca"><span class="todo TODO">TODO</span> 16.5 Data Transfer</h4>
</div>
<div id="outline-container-org68f067e" class="outline-4">
<h4 id="org68f067e"><span class="todo TODO">TODO</span> 16.6 Socket Options</h4>
</div>
<div id="outline-container-orgdc8a51b" class="outline-4">
<h4 id="orgdc8a51b"><span class="todo TODO">TODO</span> 16.7 Out-of-Band Data</h4>
</div>
<div id="outline-container-orgcf4ec2d" class="outline-4">
<h4 id="orgcf4ec2d"><span class="todo TODO">TODO</span> 16.8 Nonblocking and Asynchronous I/O</h4>
</div>
<div id="outline-container-orgc3507b3" class="outline-4">
<h4 id="orgc3507b3"><span class="todo TODO">TODO</span> 16.9 Summary</h4>
</div>
</div>
<div id="outline-container-org2d1d8c0" class="outline-3">
<h3 id="org2d1d8c0"><span class="todo TODO">TODO</span> Chapter 17. Advanced IPC <code>[2/7]</code></h3>
<div class="outline-text-3" id="text-org2d1d8c0">
</div>
<div id="outline-container-org5ba75db" class="outline-4">
<h4 id="org5ba75db"><span class="todo TODO">TODO</span> 17.1 Introduction</h4>
</div>
<div id="outline-container-orgeda13d4" class="outline-4">
<h4 id="orgeda13d4"><span class="done DONE">DONE</span> 17.2 UNIX Domain Sockets</h4>
<div class="outline-text-4" id="text-orgeda13d4">
<ul class="org-ul">
<li><p>
Example &#x2013; Polling XSI Message Queues with the Help of UNIX Domain Sockets
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 114: </span>Figure 17.3 Poll for XSI Messsages using UNIX domain sockets</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">poll.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">pthread.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/msg.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">NQ</span>     <span style="color: #a45bad;">3</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXMSZ</span> <span style="color: #a45bad;">512</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">KEY</span>    <span style="color: #a45bad;">0x123</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">threadinfo</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">qid</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">mymesg</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">mtype</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">mtext</span><span style="color: #bc6ec5;">[</span>MAXMSZ<span style="color: #bc6ec5;">]</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #bc6ec5; font-weight: bold;">helper</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span> *<span style="color: #7590db;">arg</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">n</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">mymesg</span>      <span style="color: #7590db;">m</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">threadinfo</span> *<span style="color: #7590db;">tip</span> = arg;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        memset<span style="color: #2d9574;">(</span>&amp;m, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #67b11d;">(</span>m<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>n = msgrcv<span style="color: #b1951d;">(</span>tip-&gt;qid, &amp;m, MAXMSZ, <span style="color: #a45bad;">0</span>, MSG_NOERROR<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgrcv error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>write<span style="color: #67b11d;">(</span>tip-&gt;fd, m.mtext, n<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"write error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">i</span>, <span style="color: #7590db;">n</span>, <span style="color: #7590db;">err</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">fd</span><span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">2</span><span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>               <span style="color: #7590db;">qid</span><span style="color: #bc6ec5;">[</span>NQ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">pollfd</span>     <span style="color: #7590db;">pfd</span><span style="color: #bc6ec5;">[</span>NQ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">threadinfo</span> <span style="color: #7590db;">ti</span><span style="color: #bc6ec5;">[</span>NQ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">pthread_t</span>         <span style="color: #7590db;">tid</span><span style="color: #bc6ec5;">[</span>NQ<span style="color: #bc6ec5;">]</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span>              <span style="color: #7590db;">buf</span><span style="color: #bc6ec5;">[</span>MAXMSZ<span style="color: #bc6ec5;">]</span>;

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NQ; ++i<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>qid<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span> = msgget<span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>KEY + i<span style="color: #4f97d7;">)</span>, IPC_CREAT | <span style="color: #a45bad;">0666</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"msgget error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        printf<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"queue ID %d is %d\n"</span>, i, qid<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>socketpair<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_DGRAM, <span style="color: #a45bad;">0</span>, fd<span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"socketpair error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd     = fd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">0</span><span style="color: #2d9574;">]</span>;
        pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.events = POLLIN;
        ti<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.qid     = qid<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>;
        ti<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd      = fd<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>;

        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>err = pthread_create<span style="color: #b1951d;">(</span>&amp;tid<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, <span style="color: #a45bad;">NULL</span>, helper, &amp;ti<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_exit<span style="color: #67b11d;">(</span>err, <span style="color: #2d9574;">"pthread_create error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #bc6ec5;">(</span>;;<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #2d9574;">(</span>poll<span style="color: #67b11d;">(</span>pfd, NQ, -<span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            err_sys<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"poll error"</span><span style="color: #67b11d;">)</span>;
        <span style="color: #2d9574;">}</span>

        <span style="color: #4f97d7; font-weight: bold;">for</span> <span style="color: #2d9574;">(</span>i = <span style="color: #a45bad;">0</span>; i &lt; NQ; ++i<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
            <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #67b11d;">(</span>pfd<span style="color: #b1951d;">[</span>i<span style="color: #b1951d;">]</span>.revents &amp; POLLIN<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
                <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #b1951d;">(</span><span style="color: #4f97d7;">(</span>n = read<span style="color: #bc6ec5;">(</span>pfd<span style="color: #2d9574;">[</span>i<span style="color: #2d9574;">]</span>.fd, buf, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>buf<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #b1951d;">)</span> <span style="color: #b1951d;">{</span>
                    err_sys<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"read error"</span><span style="color: #4f97d7;">)</span>;
                <span style="color: #b1951d;">}</span>
                buf<span style="color: #b1951d;">[</span>n<span style="color: #b1951d;">]</span> = <span style="color: #a45bad;">0</span>;
                printf<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"queue id %d, message %s\n"</span>, qid<span style="color: #4f97d7;">[</span>i<span style="color: #4f97d7;">]</span>, buf<span style="color: #b1951d;">)</span>;
            <span style="color: #67b11d;">}</span>
        <span style="color: #2d9574;">}</span>
    <span style="color: #bc6ec5;">}</span>
    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 115: </span>Figure 17.4 Post a message to XSI message queue</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/msg.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">MAXMSZ</span> <span style="color: #a45bad;">512</span>

<span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">mymesg</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">long</span> <span style="color: #7590db;">mtype</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> <span style="color: #7590db;">mtext</span><span style="color: #bc6ec5;">[</span>MAXMSZ<span style="color: #bc6ec5;">]</span>;
<span style="color: #4f97d7;">}</span>;

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">argc</span>, <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">argv</span><span style="color: #bc6ec5;">[]</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">key_t</span>         <span style="color: #7590db;">key</span>;
    <span style="color: #ce537a; font-weight: bold;">long</span>          <span style="color: #7590db;">qid</span>;
    <span style="color: #ce537a; font-weight: bold;">size_t</span>        <span style="color: #7590db;">nbytes</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">mymesg</span> <span style="color: #7590db;">m</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>argc != <span style="color: #a45bad;">3</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        fprintf<span style="color: #2d9574;">(</span>stderr, <span style="color: #2d9574;">"usage: sendmsg KEY message\n"</span><span style="color: #2d9574;">)</span>;
        exit<span style="color: #2d9574;">(</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    key = strtol<span style="color: #bc6ec5;">(</span>argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">1</span><span style="color: #2d9574;">]</span>, <span style="color: #a45bad;">NULL</span>, <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>qid = msgget<span style="color: #67b11d;">(</span>key, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't open queue key %s"</span>, argv<span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    memset<span style="color: #bc6ec5;">(</span>&amp;m, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>m<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    strncpy<span style="color: #bc6ec5;">(</span>m.mtext, argv<span style="color: #2d9574;">[</span><span style="color: #a45bad;">2</span><span style="color: #2d9574;">]</span>, MAXMSZ - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;
    nbytes  = strlen<span style="color: #bc6ec5;">(</span>m.mtext<span style="color: #bc6ec5;">)</span>;
    m.mtype = <span style="color: #a45bad;">1</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>msgsnd<span style="color: #2d9574;">(</span>qid, &amp;m, nbytes, <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"can't send message"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    exit<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
<ul class="org-ul">
<li><a id="orgcccb17d"></a><span class="done DONE">DONE</span> 17.2.1 Naming UNIX Domain Sockets<br />
<div class="outline-text-5" id="text-orgcccb17d">
<ul class="org-ul">
<li><p>
Example <br />
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 116: </span>Figure 17.5 Binding an address to a UNIX domain socket</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">apue.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">main</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">void</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">size</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #7590db;">un</span>;

    un.sun_family = AF_UNIX;
    strcpy<span style="color: #bc6ec5;">(</span>un.sun_path, <span style="color: #2d9574;">"foo.socket"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"socket failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    size = offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #bc6ec5;">)</span> + strlen<span style="color: #bc6ec5;">(</span>un.sun_path<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, size<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        err_sys<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"bind failed"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    printf<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"UNIX domain socket bound\n"</span><span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #a45bad;">0</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div></li>
</ul>
</div>
</li>
</ul>
</div>
<div id="outline-container-org1f2a28c" class="outline-4">
<h4 id="org1f2a28c"><span class="done DONE">DONE</span> 17.3 Unique Connections</h4>
<div class="outline-text-4" id="text-org1f2a28c">
<p>
develop three functions can be used to create unique connections between unrelated processes running on same machine:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serv_listen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;            <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: file descriptor to listen on if OK, negative value on error</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serv_accept</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">listenfd</span>, <span style="color: #ce537a; font-weight: bold;">uid_t</span> *<span style="color: #7590db;">uidptr</span><span style="color: #4f97d7;">)</span>; <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: new file descriptor if OK, negative value on Error</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">cli_conn</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>;               <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Returns: file descriptor if OK, negative value on error</span>
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">QLEN</span> <span style="color: #a45bad;">10</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Create a server endpoint of a connection.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Returns fd if all OK, &lt;0 on error.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serv_listen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">len</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">rval</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #7590db;">un</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>strlen<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span> &gt;= <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = ENAMETOOLONG;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">create a UNIX domain stream socket */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">in case it already exists */</span>
    unlink<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">fill in socket address structure */</span>
    memset<span style="color: #bc6ec5;">(</span>&amp;un, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    un.sun_family = AF_UNIX;
    strcpy<span style="color: #bc6ec5;">(</span>un.sun_path, name<span style="color: #bc6ec5;">)</span>;
    len = offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #bc6ec5;">)</span> + strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">bind the name to the descriptor */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, len<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        rval = -<span style="color: #a45bad;">3</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>listen<span style="color: #2d9574;">(</span>fd, QLEN<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">tell kernel we're a server */</span>
        rval = -<span style="color: #a45bad;">4</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;

 <span style="color: #a45bad;">errout</span>:
    err = errno;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;
    errno = err;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>rval<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-center">
<p>
Figure 17.8 The <code>serv_listen</code> function
</p>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">time.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">STALE</span> <span style="color: #a45bad;">30</span> <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">client's name can't be older than this (sec) */</span>

<span style="color: #2aa1ae; background-color: #292e34;">/**********************************************************</span><span style="color: #2aa1ae; background-color: #292e34;">/</span>
<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Wait for a client connection to arrive, and accept it. */</span>
<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">We also obtain the client's user ID from the pathname  */</span>
<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">that it must bind before calling us.                   */</span>
<span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">Returns new fd if all OK, &lt;0 on error                  */</span>
<span style="color: #2aa1ae; background-color: #292e34;">/**********************************************************</span><span style="color: #2aa1ae; background-color: #292e34;">/</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">serv_accept</span><span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">listenfd</span>, <span style="color: #ce537a; font-weight: bold;">uid_t</span> *<span style="color: #7590db;">uidptr</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">clifd</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">rval</span>;
    <span style="color: #ce537a; font-weight: bold;">socklen_t</span>          <span style="color: #7590db;">len</span>;
    <span style="color: #ce537a; font-weight: bold;">time_t</span>             <span style="color: #7590db;">staletime</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #7590db;">un</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span>        <span style="color: #7590db;">statbuf</span>;
    <span style="color: #ce537a; font-weight: bold;">char</span> *             <span style="color: #7590db;">name</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">allocate enough space for longest name plus terminating null */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>name = malloc<span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #b1951d;">(</span>un.sun_path<span style="color: #b1951d;">)</span> + <span style="color: #a45bad;">1</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    len = <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #bc6ec5;">(</span>un<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>clifd = accept<span style="color: #67b11d;">(</span>listenfd, <span style="color: #b1951d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #b1951d;">)</span>&amp;un, &amp;len<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        free<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span>;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">2</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">obtain the client't uid from its calling address */</span>
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">len of pathname */</span>
    len -= offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #bc6ec5;">)</span>;
    memcpy<span style="color: #bc6ec5;">(</span>name, un.sun_path, len<span style="color: #bc6ec5;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">null terminate */</span>
    name<span style="color: #bc6ec5;">[</span>len<span style="color: #bc6ec5;">]</span> = <span style="color: #a45bad;">0</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>stat<span style="color: #2d9574;">(</span>name, &amp;statbuf<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        rval = -<span style="color: #a45bad;">3</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

<span style="color: #bc6ec5;">#ifdef</span> S_ISSOCK
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>S_ISSOCK<span style="color: #2d9574;">(</span>statbuf.st_mode<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">not a socket */</span>
        rval = -<span style="color: #a45bad;">4</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #bc6ec5;">#endif</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>statbuf.st_mode &amp; <span style="color: #67b11d;">(</span>S_IRWXG | S_IRWXO<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> ||
        <span style="color: #2d9574;">(</span>statbuf.st_mode &amp; S_IRWXU<span style="color: #2d9574;">)</span> != S_IRWXU<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">is not rwx------ */</span>
        rval = -<span style="color: #a45bad;">5</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    staletime = time<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> - STALE;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>statbuf.st_atime &lt; staletime ||
        statbuf.st_ctime &lt; staletime ||
        statbuf.st_mtime &lt; staletime<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">i-node is too old */</span>;
        rval = -<span style="color: #a45bad;">6</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>uidptr != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">return uid of caller */</span>
        *uidptr = statbuf.st_uid;
    <span style="color: #bc6ec5;">}</span>
    unlink<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>clifd<span style="color: #bc6ec5;">)</span>;

 <span style="color: #a45bad;">errout</span>:
    err = errno;
    close<span style="color: #bc6ec5;">(</span>clifd<span style="color: #bc6ec5;">)</span>;
    free<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    errno = err;
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>rval<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<div class="org-center">
<p>
Figure 17.9 The <code>serv_accept</code> function
</p>
</div>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 117: </span>Figure 17.10 The <code>cli_conn</code> function</label><pre class="src src-c"><span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">errno.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/socket.h</span><span style="color: #4f97d7;">&gt;</span>
<span style="color: #bc6ec5;">#include</span> <span style="color: #4f97d7;">&lt;</span><span style="color: #2d9574;">sys/un.h</span><span style="color: #4f97d7;">&gt;</span>

<span style="color: #bc6ec5;">#include</span> <span style="color: #2d9574;">"apue.h"</span>

<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">CLI_PATH</span> <span style="color: #2d9574;">"/var/tmp"</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #7590db;">CLI_PERM</span> S_IRWXU <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">rwx for user only */</span>

<span style="color: #2aa1ae; background-color: #292e34;">/*</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Create a client endpoint and connect to a server.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> * Returns fd if all OK, &lt;0 on error.</span>
<span style="color: #2aa1ae; background-color: #292e34;"> */</span>
<span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #bc6ec5; font-weight: bold;">cli_conn</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span> *<span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">fd</span>, <span style="color: #7590db;">len</span>, <span style="color: #7590db;">err</span>, <span style="color: #7590db;">rval</span>;
    <span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span> <span style="color: #7590db;">un</span>, <span style="color: #7590db;">sun</span>;
    <span style="color: #ce537a; font-weight: bold;">int</span>                <span style="color: #7590db;">do_unlink</span> = <span style="color: #a45bad;">0</span>;

    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>strlen<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span> &gt;= <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        errno = ENAMETOOLONG;
        <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #2d9574;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">create a UNIX domain stream socket */</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>fd = socket<span style="color: #67b11d;">(</span>AF_UNIX, SOCK_STREAM, <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> -<span style="color: #a45bad;">1</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">fill socket address structure with our address */</span>
    memset<span style="color: #bc6ec5;">(</span>&amp;un, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    un.sun_family = AF_UNIX;
    sprintf<span style="color: #bc6ec5;">(</span>un.sun_path, <span style="color: #2d9574;">"%s%05ld"</span>, CLI_PATH, <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">long</span><span style="color: #2d9574;">)</span>getpid<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">)</span>;
    len = offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">typeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span>, sun_path<span style="color: #bc6ec5;">)</span>;

    unlink<span style="color: #bc6ec5;">(</span>un.sun_path<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>bind<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;un, len<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        rval = -<span style="color: #a45bad;">2</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>chmod<span style="color: #2d9574;">(</span>un.sun_path, CLI_PERM<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        rval      = -<span style="color: #a45bad;">3</span>;
        do_unlink = <span style="color: #a45bad;">1</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">/* </span><span style="color: #2aa1ae; background-color: #292e34;">fill socket address structure with server's address */</span>
    memset<span style="color: #bc6ec5;">(</span>&amp;un, <span style="color: #a45bad;">0</span>, <span style="color: #4f97d7; font-weight: bold;">sizeof</span><span style="color: #2d9574;">(</span>un<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>;
    sun.sun_family = AF_UNIX;
    strcpy<span style="color: #bc6ec5;">(</span>sun.sun_path, name<span style="color: #bc6ec5;">)</span>;
    len = offsetof<span style="color: #bc6ec5;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr_un</span>, sun_path<span style="color: #bc6ec5;">)</span> + strlen<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>connect<span style="color: #2d9574;">(</span>fd, <span style="color: #67b11d;">(</span><span style="color: #4f97d7; font-weight: bold;">struct</span> <span style="color: #ce537a; font-weight: bold;">sockaddr</span> *<span style="color: #67b11d;">)</span>&amp;sun, len<span style="color: #2d9574;">)</span> &lt; <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        rval      = -<span style="color: #a45bad;">4</span>;
        do_unlink = <span style="color: #a45bad;">1</span>;
        <span style="color: #4f97d7; font-weight: bold;">goto</span> <span style="color: #a45bad;">errout</span>;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;

<span style="color: #a45bad;">errout</span>:
    err = errno;
    close<span style="color: #bc6ec5;">(</span>fd<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #bc6ec5;">(</span>do_unlink<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        unlink<span style="color: #2d9574;">(</span>un.sun_path<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
    errno = err;

    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #bc6ec5;">(</span>rval<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb44f2d6" class="outline-4">
<h4 id="orgb44f2d6"><span class="todo TODO">TODO</span> 17.4 Passing File Descriptors</h4>
</div>
<div id="outline-container-orgf346128" class="outline-4">
<h4 id="orgf346128"><span class="todo TODO">TODO</span> 17.5 An Open Server, Version 1</h4>
</div>
<div id="outline-container-org9091eef" class="outline-4">
<h4 id="org9091eef"><span class="todo TODO">TODO</span> 17.6 An Open Server, Version 2</h4>
</div>
<div id="outline-container-org708715b" class="outline-4">
<h4 id="org708715b"><span class="todo TODO">TODO</span> 17.7 Summary</h4>
</div>
</div>
<div id="outline-container-org50413d0" class="outline-3">
<h3 id="org50413d0"><span class="todo TODO">TODO</span> Chapter 18. Terminal I/O <code>[0/0]</code></h3>
</div>
<div id="outline-container-orgcb75f93" class="outline-3">
<h3 id="orgcb75f93"><span class="todo TODO">TODO</span> Chapter 19. Pseudo Terminals <code>[0/0]</code></h3>
</div>
<div id="outline-container-org4ec6999" class="outline-3">
<h3 id="org4ec6999"><span class="todo TODO">TODO</span> Chapter 20. A Database Library <code>[0/0]</code></h3>
</div>
<div id="outline-container-org577139c" class="outline-3">
<h3 id="org577139c"><span class="todo TODO">TODO</span> Chapter 21. Communication with a Network Printer <code>[0/0]</code></h3>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<code>signalstack</code>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: whiothes</p>
<p class="date">Created: 2019-12-07 Sat 00:54</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
